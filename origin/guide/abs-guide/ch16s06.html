<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>6. Communications Commands</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Advanced Bash-Scripting Guide"><link rel="up" href="ch16.html" title="Chapter 16. External Filters, Programs and Commands"><link rel="prev" href="ch16s05.html" title="5. File and Archiving Commands"><link rel="next" href="ch16s07.html" title="7. Terminal Control Commands"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Communications Commands</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch16s05.html">Prev</a> </td><th width="60%" align="center">Chapter 16. External Filters, Programs and Commands</th><td width="20%" align="right"> <a accesskey="n" href="ch16s07.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="communications"></a>6. Communications Commands</h2></div></div></div><p>Certain of the following commands find use in
	  network data transfer and analysis, as well as in
	  <a class="link" href="apos02.html#cspammers">chasing spammers</a>.</p><div class="variablelist"><a name="communinfo"></a><p class="title"><b><a name="communinfo1"></a>Information and Statistics</b></p><dl class="variablelist"><dt><span class="term"><a name="hostref"></a><span class="command"><strong>host</strong></span></span></dt><dd><a class="indexterm" name="idm13147"></a><a class="indexterm" name="idm13149"></a><p>Searches for information about an Internet host by name or
	      IP address, using DNS.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>host surfacemail.com</code></strong>
<code class="computeroutput">surfacemail.com. has address 202.92.42.236</code>
	      </pre><p>
	    </p></dd><dt><span class="term"><a name="ipcalcref"></a><span class="command"><strong>ipcalc</strong></span></span></dt><dd><a class="indexterm" name="idm13163"></a><a class="indexterm" name="idm13165"></a><p>Displays IP information for a host.
	      With the <code class="option">-h</code> option,
	      <span class="command"><strong>ipcalc</strong></span> does a reverse DNS lookup, finding
	      the name of the host (server) from the IP address.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>ipcalc -h 202.92.42.236</code></strong>
<code class="computeroutput">HOSTNAME=surfacemail.com</code>
	      </pre><p>
	    </p></dd><dt><span class="term"><a name="nslookupref"></a><span class="command"><strong>nslookup</strong></span></span></dt><dd><a class="indexterm" name="idm13181"></a><a class="indexterm" name="idm13183"></a><p>Do an Internet <span class="quote">&#8220;<span class="quote">name server lookup</span>&#8221;</span>
	      on a host by IP address. This is essentially equivalent
	      to <span class="command"><strong>ipcalc -h</strong></span> or <span class="command"><strong>dig -x
	      </strong></span>. The command may be run either interactively
	      or noninteractively, i.e., from within a script.</p><p>The <span class="command"><strong>nslookup</strong></span> command has allegedly
	      been <span class="quote">&#8220;<span class="quote">deprecated,</span>&#8221;</span> but it is still useful.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>nslookup -sil 66.97.104.180</code></strong>
<code class="computeroutput">nslookup kuhleersparnis.ch
 Server:         135.116.137.2
 Address:        135.116.137.2#53

 Non-authoritative answer:
 Name:   kuhleersparnis.ch</code>
	      </pre><p>
	  </p></dd><dt><span class="term"><a name="digref"></a><span class="command"><strong>dig</strong></span></span></dt><dd><a class="indexterm" name="idm13203"></a><a class="indexterm" name="idm13205"></a><p><span class="command"><strong>D</strong></span>omain <span class="command"><strong>I</strong></span>nformation
	      <span class="command"><strong>G</strong></span>roper. Similar to
	      <span class="command"><strong>nslookup</strong></span>, <em class="firstterm">dig</em> does
	      an Internet <em class="firstterm">name server lookup</em> on a host.
	      May be run from the command-line or from within a script.</p><p>Some interesting options to <em class="firstterm">dig</em> are
	      <code class="option">+time=N</code> for setting a query timeout to
	      <em class="parameter"><code>N</code></em> seconds, <code class="option">+nofail</code> for
	      continuing to query servers until a reply is received, and
	      <code class="option">-x</code> for doing a reverse address lookup.</p><p>Compare the output of <span class="command"><strong>dig -x</strong></span> with
	      <span class="command"><strong>ipcalc -h</strong></span> and
	      <span class="command"><strong>nslookup</strong></span>.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>dig -x 81.9.6.2</code></strong>
<code class="computeroutput">;; Got answer:
 ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 11649
 ;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

 ;; QUESTION SECTION:
 ;2.6.9.81.in-addr.arpa.         IN      PTR

 ;; AUTHORITY SECTION:
 6.9.81.in-addr.arpa.    3600    IN      SOA     ns.eltel.net. noc.eltel.net.
 2002031705 900 600 86400 3600

 ;; Query time: 537 msec
 ;; SERVER: 135.116.137.2#53(135.116.137.2)
 ;; WHEN: Wed Jun 26 08:35:24 2002
 ;; MSG SIZE  rcvd: 91</code>
	      </pre><p>
	  </p><p><a name="spamlookup_0"></a></p><div class="example"><a name="spamlookup"></a><p class="title"><b>Example 16.40. Finding out where to report a spammer</b></p><div class="example-contents"><pre class="programlisting">#!/bin/bash
# spam-lookup.sh: Look up abuse contact to report a spammer.
# Thanks, Michael Zick.

# Check for command-line arg.
ARGCOUNT=1
E_WRONGARGS=85
if [ $# -ne "$ARGCOUNT" ]
then
  echo "Usage: `basename $0` domain-name"
  exit $E_WRONGARGS
fi


dig +short $1.contacts.abuse.net -c in -t txt
# Also try:
#     dig +nssearch $1
#     Tries to find "authoritative name servers" and display SOA records.

# The following also works:
#     whois -h whois.abuse.net $1
#           ^^ ^^^^^^^^^^^^^^^  Specify host.  
#     Can even lookup multiple spammers with this, i.e."
#     whois -h whois.abuse.net $spamdomain1 $spamdomain2 . . .


#  Exercise:
#  --------
#  Expand the functionality of this script
#+ so that it automatically e-mails a notification
#+ to the responsible ISP's contact address(es).
#  Hint: use the "mail" command.

exit $?

# spam-lookup.sh chinatietong.com
#                A known spam domain.

# "crnet_mgr@chinatietong.com"
# "crnet_tec@chinatietong.com"
# "postmaster@chinatietong.com"


#  For a more elaborate version of this script,
#+ see the SpamViz home page, http://www.spamviz.net/index.html.
</pre></div></div><br class="example-break"><p><a name="isspammer_0"></a></p><div class="example"><a name="isspammer"></a><p class="title"><b>Example 16.41. Analyzing a spam domain</b></p><div class="example-contents"><pre class="programlisting">#! /bin/bash
# is-spammer.sh: Identifying spam domains

# $Id$
# Above line is RCS ID info.
#
#  This is a simplified version of the "is_spammer.bash
#+ script in the Contributed Scripts appendix.

# is-spammer &lt;domain.name&gt;

# Uses an external program: 'dig'
# Tested with version: 9.2.4rc5

# Uses functions.
# Uses IFS to parse strings by assignment into arrays.
# And even does something useful: checks e-mail blacklists.

# Use the domain.name(s) from the text body:
# http://www.good_stuff.spammer.biz/just_ignore_everything_else
#                       ^^^^^^^^^^^
# Or the domain.name(s) from any e-mail address:
# Really_Good_Offer@spammer.biz
#
# as the only argument to this script.
#(PS: have your Inet connection running)
#
# So, to invoke this script in the above two instances:
#       is-spammer.sh spammer.biz


# Whitespace == :Space:Tab:Line Feed:Carriage Return:
WSP_IFS=$'\x20'$'\x09'$'\x0A'$'\x0D'

# No Whitespace == Line Feed:Carriage Return
No_WSP=$'\x0A'$'\x0D'

# Field separator for dotted decimal ip addresses
ADR_IFS=${No_WSP}'.'

# Get the dns text resource record.
# get_txt &lt;error_code&gt; &lt;list_query&gt;
get_txt() {

    # Parse $1 by assignment at the dots.
    local -a dns
    IFS=$ADR_IFS
    dns=( $1 )
    IFS=$WSP_IFS
    if [ "${dns[0]}" == '127' ]
    then
        # See if there is a reason.
        echo $(dig +short $2 -t txt)
    fi
}

# Get the dns address resource record.
# chk_adr &lt;rev_dns&gt; &lt;list_server&gt;
chk_adr() {
    local reply
    local server
    local reason

    server=${1}${2}
    reply=$( dig +short ${server} )

    # If reply might be an error code . . .
    if [ ${#reply} -gt 6 ]
    then
        reason=$(get_txt ${reply} ${server} )
        reason=${reason:-${reply}}
    fi
    echo ${reason:-' not blacklisted.'}
}

# Need to get the IP address from the name.
echo 'Get address of: '$1
ip_adr=$(dig +short $1)
dns_reply=${ip_adr:-' no answer '}
echo ' Found address: '${dns_reply}

# A valid reply is at least 4 digits plus 3 dots.
if [ ${#ip_adr} -gt 6 ]
then
    echo
    declare query

    # Parse by assignment at the dots.
    declare -a dns
    IFS=$ADR_IFS
    dns=( ${ip_adr} )
    IFS=$WSP_IFS

    # Reorder octets into dns query order.
    rev_dns="${dns[3]}"'.'"${dns[2]}"'.'"${dns[1]}"'.'"${dns[0]}"'.'

# See: http://www.spamhaus.org (Conservative, well maintained)
    echo -n 'spamhaus.org says: '
    echo $(chk_adr ${rev_dns} 'sbl-xbl.spamhaus.org')

# See: http://ordb.org (Open mail relays)
    echo -n '   ordb.org  says: '
    echo $(chk_adr ${rev_dns} 'relays.ordb.org')

# See: http://www.spamcop.net/ (You can report spammers here)
    echo -n ' spamcop.net says: '
    echo $(chk_adr ${rev_dns} 'bl.spamcop.net')

# # # other blacklist operations # # #

# See: http://cbl.abuseat.org.
    echo -n ' abuseat.org says: '
    echo $(chk_adr ${rev_dns} 'cbl.abuseat.org')

# See: http://dsbl.org/usage (Various mail relays)
    echo
    echo 'Distributed Server Listings'
    echo -n '       list.dsbl.org says: '
    echo $(chk_adr ${rev_dns} 'list.dsbl.org')

    echo -n '   multihop.dsbl.org says: '
    echo $(chk_adr ${rev_dns} 'multihop.dsbl.org')

    echo -n 'unconfirmed.dsbl.org says: '
    echo $(chk_adr ${rev_dns} 'unconfirmed.dsbl.org')

else
    echo
    echo 'Could not use that address.'
fi

exit 0

# Exercises:
# --------

# 1) Check arguments to script,
#    and exit with appropriate error message if necessary.

# 2) Check if on-line at invocation of script,
#    and exit with appropriate error message if necessary.

# 3) Substitute generic variables for "hard-coded" BHL domains.

# 4) Set a time-out for the script using the "+time=" option
     to the 'dig' command.
</pre></div></div><br class="example-break"><p>For a much more elaborate version of the above script, see 
	    <a class="xref" href="apa.html#isspammer2" title="Example A.28. Spammer Identification">Example A.28, &#8220;Spammer Identification&#8221;</a>.</p></dd><dt><span class="term"><a name="tracerouteref"></a><span class="command"><strong>traceroute</strong></span></span></dt><dd><a class="indexterm" name="idm13247"></a><a class="indexterm" name="idm13249"></a><p>Trace the route taken by packets sent to a remote host. This
	      command works within a LAN, WAN, or over the
	      Internet. The remote host may be specified by an IP
	      address. The output of this command may be filtered
	      by <a class="link" href="ch16s04.html#grepref">grep</a> or <a class="link" href="apc.html#sedref">sed</a> in a pipe.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>traceroute 81.9.6.2</code></strong>
<code class="computeroutput">traceroute to 81.9.6.2 (81.9.6.2), 30 hops max, 38 byte packets
 1  tc43.xjbnnbrb.com (136.30.178.8)  191.303 ms  179.400 ms  179.767 ms
 2  or0.xjbnnbrb.com (136.30.178.1)  179.536 ms  179.534 ms  169.685 ms
 3  192.168.11.101 (192.168.11.101)  189.471 ms  189.556 ms *
 ...</code>
	      </pre><p>
	  </p></dd><dt><span class="term"><a name="pingref"></a><span class="command"><strong>ping</strong></span></span></dt><dd><a class="indexterm" name="idm13265"></a><a class="indexterm" name="idm13267"></a><p>Broadcast an <em class="replaceable"><code>ICMP
	      ECHO_REQUEST</code></em> packet to another machine,
              either on a local or remote network. This is a
              diagnostic tool for testing network connections,
              and it should be used with caution.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>ping localhost</code></strong>
<code class="computeroutput">PING localhost.localdomain (127.0.0.1) from 127.0.0.1 : 56(84) bytes of data.
 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=0 ttl=255 time=709 usec
 64 bytes from localhost.localdomain (127.0.0.1): icmp_seq=1 ttl=255 time=286 usec

 --- localhost.localdomain ping statistics ---
 2 packets transmitted, 2 packets received, 0% packet loss
 round-trip min/avg/max/mdev = 0.286/0.497/0.709/0.212 ms</code>
	      </pre><p>
	    </p><p>A successful <em class="firstterm">ping</em> returns
	      an <a class="link" href="ch06.html#exitstatusref">exit status</a> of
	      <span class="errorcode">0</span>. This can be tested for in a
	      script.</p><p><a name="ping0"></a></p><pre class="programlisting">  HNAME=news-15.net  # Notorious spammer.
# HNAME=$HOST     # Debug: test for localhost.
  count=2  # Send only two pings.

if [[ `ping -c $count "$HNAME"` ]]
then
  echo ""$HNAME" still up and broadcasting spam your way."
else
  echo ""$HNAME" seems to be down. Pity."
fi</pre></dd><dt><span class="term"><a name="whoisref"></a><span class="command"><strong>whois</strong></span></span></dt><dd><a class="indexterm" name="idm13290"></a><a class="indexterm" name="idm13292"></a><p>Perform a DNS (Domain Name System) lookup.
	      The <code class="option">-h</code> option permits specifying which
	      particular <em class="firstterm">whois</em> server to query. See
	      <a class="xref" href="ch04s04.html#ex18" title="Example 4.6. wh, whois domain name lookup">Example 4.6, &#8220;<em class="firstterm">wh</em>, <em class="firstterm">
                whois</em> domain name lookup&#8221;</a> and <a class="xref" href="ch16s06.html#spamlookup" title="Example 16.40. Finding out where to report a spammer">Example 16.40, &#8220;Finding out where to report a spammer&#8221;</a>.</p></dd><dt><span class="term"><a name="fingerref"></a><span class="command"><strong>finger</strong></span></span></dt><dd><a class="indexterm" name="idm13305"></a><a class="indexterm" name="idm13307"></a><p>Retrieve information about users on a
	      network. Optionally, this command can display
	      a user's <code class="filename">~/.plan</code>,
	      <code class="filename">~/.project</code>, and
	      <code class="filename">~/.forward</code> files, if present.</p><p>
	      </p><pre class="screen">
<code class="prompt">bash$ </code><strong class="userinput"><code>finger</code></strong>
<code class="computeroutput">Login  Name           Tty      Idle  Login Time   Office     Office Phone
 bozo   Bozo Bozeman   tty1        8  Jun 25 16:59                (:0)
 bozo   Bozo Bozeman   ttyp0          Jun 25 16:59                (:0.0)
 bozo   Bozo Bozeman   ttyp1          Jun 25 17:07                (:0.0)</code>



<code class="prompt">bash$ </code><strong class="userinput"><code>finger bozo</code></strong>
<code class="computeroutput">Login: bozo                             Name: Bozo Bozeman
 Directory: /home/bozo                   Shell: /bin/bash
 Office: 2355 Clown St., 543-1234
 On since Fri Aug 31 20:13 (MST) on tty1    1 hour 38 minutes idle
 On since Fri Aug 31 20:13 (MST) on pts/0   12 seconds idle
 On since Fri Aug 31 20:13 (MST) on pts/1
 On since Fri Aug 31 20:31 (MST) on pts/2   1 hour 16 minutes idle
 Mail last read Tue Jul  3 10:08 2007 (MST) 
 No Plan.</code>
	      </pre><p>
	    </p><p>Out of security considerations, many networks disable
	      <span class="command"><strong>finger</strong></span> and its associated daemon.
	          <a href="#ftn.idm13324" class="footnote" name="idm13324"><sup class="footnote">[81]</sup></a>
	      </p></dd><dt><span class="term"><a name="chfnref"></a><span class="command"><strong>chfn</strong></span></span></dt><dd><a class="indexterm" name="idm13336"></a><a class="indexterm" name="idm13338"></a><p>Change information disclosed by the
	      <span class="command"><strong>finger</strong></span> command.</p></dd><dt><span class="term"><a name="vrfyref"></a><span class="command"><strong>vrfy</strong></span></span></dt><dd><a class="indexterm" name="idm13348"></a><a class="indexterm" name="idm13350"></a><p>Verify an Internet e-mail address.</p><p>This command seems to be missing from newer Linux
	      distros.</p></dd></dl></div><div class="variablelist"><a name="commremote"></a><p class="title"><b><a name="commremote1"></a>Remote Host Access</b></p><dl class="variablelist"><dt><span class="term"><a name="rxref"></a><span class="command"><strong>sx</strong></span>, </span><span class="term"><span class="command"><strong>rx</strong></span></span></dt><dd><a class="indexterm" name="idm13365"></a><a class="indexterm" name="idm13367"></a><a class="indexterm" name="idm13370"></a><a class="indexterm" name="idm13372"></a><p>The <span class="command"><strong>sx</strong></span> and <span class="command"><strong>rx</strong></span>
	      command set serves to transfer files to and from a remote
	      host using the <em class="firstterm">xmodem</em> protocol. These
	      are generally part of a communications package, such as
	      <span class="command"><strong>minicom</strong></span>.</p></dd><dt><span class="term"><a name="rzref"></a><span class="command"><strong>sz</strong></span>, </span><span class="term"><span class="command"><strong>rz</strong></span></span></dt><dd><a class="indexterm" name="idm13387"></a><a class="indexterm" name="idm13389"></a><a class="indexterm" name="idm13392"></a><a class="indexterm" name="idm13394"></a><p>The <span class="command"><strong>sz</strong></span> and <span class="command"><strong>rz</strong></span>
	      command set serves to transfer files to and from a remote
	      host using the <em class="firstterm">zmodem</em> protocol.
	      <em class="firstterm">Zmodem</em> has certain advantages over
	      <em class="firstterm">xmodem</em>, such as faster transmission
	      rate and resumption of interrupted file transfers.
	      Like <span class="command"><strong>sx</strong></span> and <span class="command"><strong>rx</strong></span>,
	      these are generally part of a communications package.</p></dd><dt><span class="term"><a name="ftpref"></a><span class="command"><strong>ftp</strong></span></span></dt><dd><a class="indexterm" name="idm13410"></a><a class="indexterm" name="idm13412"></a><p>Utility and protocol for uploading / downloading
	      files to or from a remote host. An ftp session can be automated
	      in a script (see <a class="xref" href="ch19.html#ex72" title="Example 19.6. Upload a file pair to Sunsite incoming directory">Example 19.6, &#8220;Upload a file pair to <em class="firstterm">Sunsite</em> incoming
	  directory&#8221;</a> and <a class="xref" href="apa.html#encryptedpw" title="Example A.4. encryptedpw: Uploading to an ftp site, using a locally encrypted password">Example A.4, &#8220;<em class="firstterm">encryptedpw</em>: Uploading to an ftp site,
      using a locally encrypted password&#8221;</a>).</p></dd><dt><span class="term"><a name="uucpref"></a><span class="command"><strong>uucp</strong></span>, </span><span class="term"><a name="uuxref"></a><span class="command"><strong>uux</strong></span>, </span><span class="term"><a name="curef"></a><span class="command"><strong>cu</strong></span></span></dt><dd><a class="indexterm" name="idm13429"></a><a class="indexterm" name="idm13431"></a><a class="indexterm" name="idm13434"></a><a class="indexterm" name="idm13437"></a><a class="indexterm" name="idm13440"></a><p><span class="command"><strong>uucp</strong></span>: <em class="firstterm">UNIX to UNIX
	      copy</em>. This is a communications package for
	      transferring files between UNIX servers. A shell script
	      is an effective way to handle a <span class="command"><strong>uucp</strong></span>
	      command sequence.</p><p>Since the advent of the Internet and e-mail,
	      <span class="command"><strong>uucp</strong></span> seems to have faded into obscurity,
	      but it still exists and remains perfectly workable in
	      situations where an Internet connection is not available
	      or appropriate. The advantage of <span class="command"><strong>uucp</strong></span>
	      is that it is fault-tolerant, so even if there is a service
	      interruption the copy operation will resume where it left
	      off when the connection is restored.</p><p>---</p><p><span class="command"><strong>uux</strong></span>: <em class="firstterm">UNIX to UNIX
	      execute</em>. Execute a command on a remote system.
	      This command is part of the <span class="command"><strong>uucp</strong></span>
	      package.</p><p>---</p><p><span class="command"><strong>cu</strong></span>: <span class="command"><strong>C</strong></span>all
	      <span class="command"><strong>U</strong></span>p a remote system and connect as a
	      simple terminal. It is a sort of dumbed-down version of
	      <a class="link" href="ch16s06.html#telnetref">telnet</a>. This command is
	      part of the <span class="command"><strong>uucp</strong></span> package.</p></dd><dt><span class="term"><a name="telnetref"></a><span class="command"><strong>telnet</strong></span></span></dt><dd><a class="indexterm" name="idm13467"></a><a class="indexterm" name="idm13469"></a><p>Utility and protocol for connecting to a remote host.</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>The <em class="firstterm">telnet</em> protocol
	    contains security holes and should therefore probably be
	    avoided. Its use within a shell script is
	    <span class="emphasis"><em>not</em></span> recommended.</p></div></dd><dt><span class="term"><a name="wgetref"></a><span class="command"><strong>wget</strong></span></span></dt><dd><a class="indexterm" name="idm13482"></a><a class="indexterm" name="idm13484"></a><p>The <span class="command"><strong>wget</strong></span> utility
	      <em class="firstterm">noninteractively</em> retrieves or
	      downloads files from a Web or ftp site. It works well in a
	      script.</p><pre class="programlisting">wget -p http://www.xyz23.com/file01.html
#  The -p or --page-requisite option causes wget to fetch all files
#+ required to display the specified page.

wget -r ftp://ftp.xyz24.net/~bozo/project_files/ -O $SAVEFILE
#  The -r option recursively follows and retrieves all links
#+ on the specified site.

wget -c ftp://ftp.xyz25.net/bozofiles/filename.tar.bz2
#  The -c option lets wget resume an interrupted download.
#  This works with ftp servers and many HTTP sites.</pre><div class="example"><a name="quotefetch"></a><p class="title"><b>Example 16.42. Getting a stock quote</b></p><div class="example-contents"><pre class="programlisting">#!/bin/bash
# quote-fetch.sh: Download a stock quote.


E_NOPARAMS=86

if [ -z "$1" ]  # Must specify a stock (symbol) to fetch.
  then echo "Usage: `basename $0` stock-symbol"
  exit $E_NOPARAMS
fi

stock_symbol=$1

file_suffix=.html
# Fetches an HTML file, so name it appropriately.
URL='http://finance.yahoo.com/q?s='
# Yahoo finance board, with stock query suffix.

# -----------------------------------------------------------
wget -O ${stock_symbol}${file_suffix} "${URL}${stock_symbol}"
# -----------------------------------------------------------


# To look up stuff on http://search.yahoo.com:
# -----------------------------------------------------------
# URL="http://search.yahoo.com/search?fr=ush-news&amp;p=${query}"
# wget -O "$savefilename" "${URL}"
# -----------------------------------------------------------
# Saves a list of relevant URLs.

exit $?

# Exercises:
# ---------
#
# 1) Add a test to ensure the user running the script is on-line.
#    (Hint: parse the output of 'ps -ax' for "ppp" or "connect."
#
# 2) Modify this script to fetch the local weather report,
#+   taking the user's zip code as an argument.
</pre></div></div><br class="example-break"><p>See also <a class="xref" href="apa.html#wgetter2" title="Example A.30. Making wget easier to use">Example A.30, &#8220;Making <em class="firstterm">wget</em> easier to use&#8221;</a> and <a class="xref" href="apa.html#bashpodder" title="Example A.31. A podcasting script">Example A.31, &#8220;A <em class="firstterm">podcasting</em> script&#8221;</a>.</p></dd><dt><span class="term"><a name="lynxref"></a><span class="command"><strong>lynx</strong></span></span></dt><dd><a class="indexterm" name="idm13503"></a><a class="indexterm" name="idm13505"></a><p>The <span class="command"><strong>lynx</strong></span> Web and file browser
	      can be used inside a script (with the
	      <code class="option">-dump</code> option) to retrieve a file from a Web or 
	      ftp site noninteractively.</p><p>
	   </p><pre class="programlisting">lynx -dump http://www.xyz23.com/file01.html &gt;$SAVEFILE</pre><p>
            </p><p>With the <code class="option">-traversal</code> option,
	      <span class="command"><strong>lynx</strong></span> starts at the HTTP URL specified
	      as an argument, then <span class="quote">&#8220;<span class="quote">crawls</span>&#8221;</span> through all
	      links located on that particular server. Used together
	      with the <code class="option">-crawl</code> option, outputs page text
	      to a log file.</p></dd><dt><span class="term"><a name="rloginref"></a><span class="command"><strong>rlogin</strong></span></span></dt><dd><a class="indexterm" name="idm13523"></a><a class="indexterm" name="idm13525"></a><p><em class="replaceable"><code>Remote login</code></em>, initates a
	      session on a remote host. This command has security issues,
	      so use <a class="link" href="ch16s06.html#sshref">ssh</a> instead.</p></dd><dt><span class="term"><a name="rshref"></a><span class="command"><strong>rsh</strong></span></span></dt><dd><a class="indexterm" name="idm13536"></a><a class="indexterm" name="idm13538"></a><p><em class="replaceable"><code>Remote shell</code></em>, executes
	      command(s) on a remote host. This has security issues,
	      so use <span class="command"><strong>ssh</strong></span> instead.</p></dd><dt><span class="term"><a name="rcpref"></a><span class="command"><strong>rcp</strong></span></span></dt><dd><a class="indexterm" name="idm13549"></a><a class="indexterm" name="idm13551"></a><p><em class="replaceable"><code>Remote copy</code></em>, copies files
	      between two different networked machines.</p></dd><dt><span class="term"><a name="rsyncref"></a><span class="command"><strong>rsync</strong></span></span></dt><dd><a class="indexterm" name="idm13561"></a><a class="indexterm" name="idm13563"></a><p><em class="replaceable"><code>Remote synchronize</code></em>, updates
	    (synchronizes) files
	      between two different networked machines.</p><p>
	      </p><pre class="screen"><code class="prompt">bash$ </code><strong class="userinput"><code>rsync -a ~/sourcedir/*txt /node1/subdirectory/</code></strong>
	      </pre><p>
	    </p><div class="example"><a name="fc4upd"></a><p class="title"><b>Example 16.43. Updating FC4</b></p><div class="example-contents"><pre class="programlisting">#!/bin/bash
# fc4upd.sh

# Script author: Frank Wang.
# Slight stylistic modifications by ABS Guide author.
# Used in ABS Guide with permission.


#  Download Fedora Core 4 update from mirror site using rsync. 
#  Should also work for newer Fedora Cores -- 5, 6, . . .
#  Only download latest package if multiple versions exist,
#+ to save space.

URL=rsync://distro.ibiblio.org/fedora-linux-core/updates/
# URL=rsync://ftp.kddilabs.jp/fedora/core/updates/
# URL=rsync://rsync.planetmirror.com/fedora-linux-core/updates/

DEST=${1:-/var/www/html/fedora/updates/}
LOG=/tmp/repo-update-$(/bin/date +%Y-%m-%d).txt
PID_FILE=/var/run/${0##*/}.pid

E_RETURN=85        # Something unexpected happened.


# General rsync options
# -r: recursive download
# -t: reserve time
# -v: verbose

OPTS="-rtv --delete-excluded --delete-after --partial"

# rsync include pattern
# Leading slash causes absolute path name match.
INCLUDE=(
    "/4/i386/kde-i18n-Chinese*" 
#   ^                         ^
# Quoting is necessary to prevent globbing.
) 


# rsync exclude pattern
# Temporarily comment out unwanted pkgs using "#" . . .
EXCLUDE=(
    /1
    /2
    /3
    /testing
    /4/SRPMS
    /4/ppc
    /4/x86_64
    /4/i386/debug
   "/4/i386/kde-i18n-*"
   "/4/i386/openoffice.org-langpack-*"
   "/4/i386/*i586.rpm"
   "/4/i386/GFS-*"
   "/4/i386/cman-*"
   "/4/i386/dlm-*"
   "/4/i386/gnbd-*"
   "/4/i386/kernel-smp*"
#  "/4/i386/kernel-xen*" 
#  "/4/i386/xen-*" 
)


init () {
    # Let pipe command return possible rsync error, e.g., stalled network.
    set -o pipefail                  # Newly introduced in Bash, version 3.

    TMP=${TMPDIR:-/tmp}/${0##*/}.$$  # Store refined download list.
    trap "{
        rm -f $TMP 2&gt;/dev/null
    }" EXIT                          # Clear temporary file on exit.
}


check_pid () {
# Check if process exists.
    if [ -s "$PID_FILE" ]; then
        echo "PID file exists. Checking ..."
        PID=$(/bin/egrep -o "^[[:digit:]]+" $PID_FILE)
        if /bin/ps --pid $PID &amp;&gt;/dev/null; then
            echo "Process $PID found. ${0##*/} seems to be running!"
           /usr/bin/logger -t ${0##*/} \
                 "Process $PID found. ${0##*/} seems to be running!"
            exit $E_RETURN
        fi
        echo "Process $PID not found. Start new process . . ."
    fi
}


#  Set overall file update range starting from root or $URL,
#+ according to above patterns.
set_range () {
    include=
    exclude=
    for p in "${INCLUDE[@]}"; do
        include="$include --include \"$p\""
    done

    for p in "${EXCLUDE[@]}"; do
        exclude="$exclude --exclude \"$p\""
    done
}


# Retrieve and refine rsync update list.
get_list () {
    echo $$ &gt; $PID_FILE || {
        echo "Can't write to pid file $PID_FILE"
        exit $E_RETURN
    }

    echo -n "Retrieving and refining update list . . ."

    # Retrieve list -- 'eval' is needed to run rsync as a single command.
    # $3 and $4 is the date and time of file creation.
    # $5 is the full package name.
    previous=
    pre_file=
    pre_date=0
    eval /bin/nice /usr/bin/rsync \
        -r $include $exclude $URL | \
        egrep '^dr.x|^-r' | \
        awk '{print $3, $4, $5}' | \
        sort -k3 | \
        { while read line; do
            # Get seconds since epoch, to filter out obsolete pkgs.
            cur_date=$(date -d "$(echo $line | awk '{print $1, $2}')" +%s)
            #  echo $cur_date

            # Get file name.
            cur_file=$(echo $line | awk '{print $3}')
            #  echo $cur_file

            # Get rpm pkg name from file name, if possible.
            if [[ $cur_file == *rpm ]]; then
                pkg_name=$(echo $cur_file | sed -r -e \
                    's/(^([^_-]+[_-])+)[[:digit:]]+\..*[_-].*$/\1/')
            else
                pkg_name=
            fi
            # echo $pkg_name

            if [ -z "$pkg_name" ]; then   #  If not a rpm file,
                echo $cur_file &gt;&gt; $TMP    #+ then append to download list.
            elif [ "$pkg_name" != "$previous" ]; then   # A new pkg found.
                echo $pre_file &gt;&gt; $TMP                  # Output latest file.
                previous=$pkg_name                      # Save current.
                pre_date=$cur_date
                pre_file=$cur_file
            elif [ "$cur_date" -gt "$pre_date" ]; then
                                                #  If same pkg, but newer,
                pre_date=$cur_date              #+ then update latest pointer.
                pre_file=$cur_file
            fi
            done
            echo $pre_file &gt;&gt; $TMP              #  TMP contains ALL
                                                #+ of refined list now.
            # echo "subshell=$BASH_SUBSHELL"

    }       # Bracket required here to let final "echo $pre_file &gt;&gt; $TMP" 
            # Remained in the same subshell ( 1 ) with the entire loop.

    RET=$?  # Get return code of the pipe command.

    [ "$RET" -ne 0 ] &amp;&amp; {
        echo "List retrieving failed with code $RET"
        exit $E_RETURN
    }

    echo "done"; echo
}

# Real rsync download part.
get_file () {

    echo "Downloading..."
    /bin/nice /usr/bin/rsync \
        $OPTS \
        --filter "merge,+/ $TMP" \
        --exclude '*'  \
        $URL $DEST     \
        | /usr/bin/tee $LOG

    RET=$?

   #  --filter merge,+/ is crucial for the intention. 
   #  + modifier means include and / means absolute path.
   #  Then sorted list in $TMP will contain ascending dir name and 
   #+ prevent the following --exclude '*' from "shortcutting the circuit." 

    echo "Done"

    rm -f $PID_FILE 2&gt;/dev/null

    return $RET
}

# -------
# Main
init
check_pid
set_range
get_list
get_file
RET=$?
# -------

if [ "$RET" -eq 0 ]; then
    /usr/bin/logger -t ${0##*/} "Fedora update mirrored successfully."
else
    /usr/bin/logger -t ${0##*/} \
    "Fedora update mirrored with failure code: $RET"
fi

exit $RET
</pre></div></div><br class="example-break"><p>See also <a class="xref" href="apa.html#nightlybackup" title="Example A.32. Nightly backup to a firewire HD">Example A.32, &#8220;Nightly backup to a firewire HD&#8221;</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Using <a class="link" href="ch16s06.html#rcpref">rcp</a>, <a class="link" href="ch16s06.html#rsyncref">rsync</a>, and similar
	      utilities with security implications in a shell
	      script may not be advisable. Consider, instead, using
	      <span class="command"><strong>ssh</strong></span>, <a class="link" href="ch16s06.html#scpref">scp</a>,
	      or an <span class="command"><strong>expect</strong></span> script.</p></div></dd><dt><span class="term"><a name="sshref"></a><span class="command"><strong>ssh</strong></span></span></dt><dd><a class="indexterm" name="idm13589"></a><a class="indexterm" name="idm13591"></a><p><em class="replaceable"><code>Secure shell</code></em>, logs onto
	      a remote host and executes commands there. This
	      secure replacement for <span class="command"><strong>telnet</strong></span>,
	      <span class="command"><strong>rlogin</strong></span>, <span class="command"><strong>rcp</strong></span>, and
	      <span class="command"><strong>rsh</strong></span> uses identity authentication
	      and encryption. See its <a class="link" href="ch16s01.html#manref">manpage</a>
	      for details.</p><div class="example"><a name="remote"></a><p class="title"><b>Example 16.44. Using <em class="firstterm">ssh</em></b></p><div class="example-contents"><pre class="programlisting">#!/bin/bash
# remote.bash: Using ssh.

# This example by Michael Zick.
# Used with permission.


#   Presumptions:
#   ------------
#   fd-2 isn't being captured ( '2&gt;/dev/null' ).
#   ssh/sshd presumes stderr ('2') will display to user.
#
#   sshd is running on your machine.
#   For any 'standard' distribution, it probably is,
#+  and without any funky ssh-keygen having been done.

# Try ssh to your machine from the command-line:
#
# $ ssh $HOSTNAME
# Without extra set-up you'll be asked for your password.
#   enter password
#   when done,  $ exit
#
# Did that work? If so, you're ready for more fun.

# Try ssh to your machine as 'root':
#
#   $  ssh -l root $HOSTNAME
#   When asked for password, enter root's, not yours.
#          Last login: Tue Aug 10 20:25:49 2004 from localhost.localdomain
#   Enter 'exit' when done.

#  The above gives you an interactive shell.
#  It is possible for sshd to be set up in a 'single command' mode,
#+ but that is beyond the scope of this example.
#  The only thing to note is that the following will work in
#+ 'single command' mode.


# A basic, write stdout (local) command.

ls -l

# Now the same basic command on a remote machine.
# Pass a different 'USERNAME' 'HOSTNAME' if desired:
USER=${USERNAME:-$(whoami)}
HOST=${HOSTNAME:-$(hostname)}

#  Now excute the above command-line on the remote host,
#+ with all transmissions encrypted.

ssh -l ${USER} ${HOST} " ls -l "

#  The expected result is a listing of your username's home
#+ directory on the remote machine.
#  To see any difference, run this script from somewhere
#+ other than your home directory.

#  In other words, the Bash command is passed as a quoted line
#+ to the remote shell, which executes it on the remote machine.
#  In this case, sshd does  ' bash -c "ls -l" '   on your behalf.

#  For information on topics such as not having to enter a
#+ password/passphrase for every command-line, see
#+    man ssh
#+    man ssh-keygen
#+    man sshd_config.

exit 0
</pre></div></div><br class="example-break"><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>Within a loop, <span class="command"><strong>ssh</strong></span> may cause
		unexpected behavior. According to a <a class="ulink" href="http://groups-beta.google.com/group/comp.unix.shell/msg/dcb446b5fff7d230" target="_top">
		Usenet post</a> in the comp.unix shell archives,
		<span class="command"><strong>ssh</strong></span> inherits the loop's
		<code class="filename">stdin</code>. To remedy this, pass
		<span class="command"><strong>ssh</strong></span> either the <code class="option">-n</code>
		or <code class="option">-f</code> option.</p><p>Thanks, Jason Bechtel, for pointing this out.</p></div></dd><dt><span class="term"><a name="scpref"></a><span class="command"><strong>scp</strong></span></span></dt><dd><a class="indexterm" name="idm13620"></a><a class="indexterm" name="idm13622"></a><p><em class="replaceable"><code>Secure copy</code></em>, similar in
	      function to <span class="command"><strong>rcp</strong></span>, copies files between
	      two different networked machines, but does so using
	      authentication, and with a security level similar to
	      <span class="command"><strong>ssh</strong></span>.</p></dd></dl></div><div class="variablelist"><a name="commlocal"></a><p class="title"><b><a name="commlocal1"></a>Local Network</b></p><dl class="variablelist"><dt><span class="term"><a name="writeref"></a><span class="command"><strong>write</strong></span></span></dt><dd><a class="indexterm" name="idm13637"></a><a class="indexterm" name="idm13639"></a><p>This is a utility for terminal-to-terminal communication.
	      It allows sending lines from your terminal (console or
	      <em class="firstterm">xterm</em>) to that of another user. The
	      <a class="link" href="ch17.html#mesgref">mesg</a> command may, of course,
	      be used to disable write access to a terminal</p><p>Since <span class="command"><strong>write</strong></span> is interactive, it
	      would not normally find use in a script.</p></dd><dt><span class="term"><a name="netconfigref"></a><span class="command"><strong>netconfig</strong></span></span></dt><dd><a class="indexterm" name="idm13652"></a><a class="indexterm" name="idm13654"></a><p>A command-line utility for configuring a network adapter
	      (using <em class="firstterm">DHCP</em>). This command is native
	      to Red Hat centric Linux distros.</p></dd></dl></div><div class="variablelist"><a name="commmail"></a><p class="title"><b><a name="commmail1"></a>Mail</b></p><dl class="variablelist"><dt><span class="term"><span class="command"><strong>mail</strong></span></span></dt><dd><a class="indexterm" name="idm13666"></a><a class="indexterm" name="idm13668"></a><p>Send or read e-mail messages.</p><p>This stripped-down command-line mail client
	      works fine as a command embedded in a script.</p><div class="example"><a name="selfmailer"></a><p class="title"><b>Example 16.45. A script that mails itself</b></p><div class="example-contents"><pre class="programlisting">#!/bin/sh
# self-mailer.sh: Self-mailing script

adr=${1:-`whoami`}     # Default to current user, if not specified.
#  Typing 'self-mailer.sh wiseguy@superdupergenius.com'
#+ sends this script to that addressee.
#  Just 'self-mailer.sh' (no argument) sends the script
#+ to the person invoking it, for example, bozo@localhost.localdomain.
#
#  For more on the ${parameter:-default} construct,
#+ see the "Parameter Substitution" section
#+ of the "Variables Revisited" chapter.

# ============================================================================
  cat $0 | mail -s "Script \"`basename $0`\" has mailed itself to you." "$adr"
# ============================================================================

# --------------------------------------------
#  Greetings from the self-mailing script.
#  A mischievous person has run this script,
#+ which has caused it to mail itself to you.
#  Apparently, some people have nothing better
#+ to do with their time.
# --------------------------------------------

echo "At `date`, script \"`basename $0`\" mailed to "$adr"."

exit 0

#  Note that the "mailx" command (in "send" mode) may be substituted
#+ for "mail" ... but with somewhat different options.
</pre></div></div><br class="example-break"></dd><dt><span class="term"><a name="mailtoref"></a><span class="command"><strong>mailto</strong></span></span></dt><dd><a class="indexterm" name="idm13681"></a><a class="indexterm" name="idm13683"></a><p>Similar to the <span class="command"><strong>mail</strong></span> command,
	      <span class="command"><strong>mailto</strong></span> sends e-mail messages
	      from the command-line or in a script. However,
	      <span class="command"><strong>mailto</strong></span> also permits sending MIME
	      (multimedia) messages.</p></dd><dt><span class="term"><a name="mailstatsref"></a><span class="command"><strong>mailstats</strong></span></span></dt><dd><a class="indexterm" name="idm13695"></a><a class="indexterm" name="idm13697"></a><p>Show <em class="firstterm">mail statistics</em>. This command
	      may be invoked only by <em class="firstterm">root</em>.</p><p>
	      </p><pre class="screen"><code class="prompt">root# </code><strong class="userinput"><code>mailstats</code></strong>
<code class="computeroutput">Statistics from Tue Jan  1 20:32:08 2008
  M   msgsfr  bytes_from   msgsto    bytes_to  msgsrej msgsdis msgsqur  Mailer
  4     1682      24118K        0          0K        0       0       0  esmtp
  9      212        640K     1894      25131K        0       0       0  local
 =====================================================================
  T     1894      24758K     1894      25131K        0       0       0
  C      414                    0</code>
	      </pre><p>
	    </p></dd><dt><span class="term"><a name="vacationref"></a><span class="command"><strong>vacation</strong></span></span></dt><dd><a class="indexterm" name="idm13713"></a><a class="indexterm" name="idm13715"></a><p>This utility automatically replies to e-mails that
	      the intended recipient is on vacation and temporarily
	      unavailable. It runs on a network, in conjunction with
	      <span class="command"><strong>sendmail</strong></span>, and is not applicable to a
	      dial-up POPmail account.</p></dd></dl></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm13324" class="footnote"><p><a href="#idm13324" class="para"><sup class="para">[81] </sup></a><a name="daemonref"></a></p><p>A <em class="firstterm">daemon</em> is a background
		    process not attached to a terminal session. Daemons
		    perform designated services either at specified times
		    or explicitly triggered by certain events.</p><p>The word <span class="quote">&#8220;<span class="quote">daemon</span>&#8221;</span> means ghost in
		    Greek, and there is certainly something mysterious,
		    almost supernatural, about the way UNIX daemons
		    wander about behind the scenes, silently carrying
		    out their appointed tasks.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch16s05.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch16.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch16s07.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5. File and Archiving Commands </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7. Terminal Control Commands</td></tr></table></div></body></html>
