<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>2. Traps</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="Linux, Scripts, linux, Bash, guide, Guide, Exercises, exercises, bash, scripting, Scripting, awk, sed, variables, functions, loops, conditionals"><link rel="home" href="index.html" title="Bash Guide for Beginners"><link rel="up" href="ch12.html" title="Chapter 12. Catching signals"><link rel="prev" href="ch12s01.html" title="1. Signals"><link rel="next" href="ch12s03.html" title="3. Summary"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">2. Traps</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch12s01.html">Prev</a> </td><th width="60%" align="center">Chapter 12. Catching signals</th><td width="20%" align="right"> <a accesskey="n" href="ch12s03.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sect_12_02"></a>2. Traps</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sect_12_02_01"></a>2.1. General</h3></div></div></div><p>There might be situations when you don't want users of your scripts to exit untimely using keyboard abort sequences, for example because input has to be provided or cleanup has to be done.  The <span class="command"><strong>trap</strong></span> statement catches these sequences and can be programmed to execute a list of commands upon catching those signals.</p><p>The syntax for the <span class="command"><strong>trap</strong></span> statement is straightforward:</p><div class="cmdsynopsis"><p><code class="command">trap [COMMANDS] [SIGNALS]</code> </p></div><p>This instructs the <span class="command"><strong>trap</strong></span> command to catch the listed <span class="emphasis"><em>SIGNALS</em></span>, which may be signal names with or without the <span class="emphasis"><em>SIG</em></span> prefix, or signal numbers.  If a signal is <span class="emphasis"><em>0</em></span> or <span class="emphasis"><em>EXIT</em></span>, the <span class="command"><strong>COMMANDS</strong></span> are executed when the shell exits.  If one of the signals is <span class="emphasis"><em>DEBUG</em></span>, the list of <span class="command"><strong>COMMANDS</strong></span> is executed after every simple command.  A signal may also be specified as <span class="emphasis"><em>ERR</em></span>; in that case <span class="command"><strong>COMMANDS</strong></span> are executed each time a simple command exits with a non-zero status.  Note that these commands will not be executed when the non-zero exit status comes from part of an <span class="command"><strong>if</strong></span> statement, or from a <span class="command"><strong>while</strong></span> or <span class="command"><strong>until</strong></span> loop.  Neither will they be executed if a logical <span class="emphasis"><em>AND</em></span> (&amp;&amp;) or <span class="emphasis"><em>OR</em></span> (||) result in a non-zero exit code, or when a command's return status is inverted using the <span class="emphasis"><em>!</em></span> operator.</p><p>The return status of the <span class="command"><strong>trap</strong></span> command itself is zero unless an invalid signal specification is encountered.  The <span class="command"><strong>trap</strong></span> command takes a couple of options, which are documented in the Bash info pages.</p><p>Here is a very simple example, catching <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>C</strong></span> from the user, upon which a message is printed.  When you try to kill this program without specifying the <span class="emphasis"><em>KILL</em></span> signal, nothing will happen:</p><pre class="screen">
#!/bin/bash
# traptest.sh

trap "echo Booh!" SIGINT SIGTERM
echo "pid is $$"

while :			# This is the same as "while true".
do
        sleep 60	# This script is not really doing anything.
done
</pre></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sect_12_02_02"></a>2.2. How Bash interprets traps</h3></div></div></div><p>When Bash receives a signal for which a trap has been set while waiting for a command to complete, the trap will not be executed until the command completes.  When Bash is waiting for an asynchronous command via the <span class="command"><strong>wait</strong></span> built-in, the reception of a signal for which a trap has been set will cause the <span class="command"><strong>wait</strong></span> built-in to return immediately with an exit status greater than 128, immediately after which the trap is executed.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="sect_12_02_03"></a>2.3. More examples</h3></div></div></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sect_12_02_03_01"></a>2.3.1. Detecting when a variable is used</h4></div></div></div><p>When debugging longer scripts, you might want to give a variable the <span class="emphasis"><em>trace</em></span> attribute and trap <span class="emphasis"><em>DEBUG</em></span> messages for that variable.  Normally you would just declare a variable using an assignment like <span class="command"><strong><code class="varname">VARIABLE</code>=value</strong></span>.  Replacing the declaration of the variable with the following lines might provide valuable information about what your script is doing:</p><pre class="screen">
declare -t VARIABLE=value

trap "echo VARIABLE is being used here." DEBUG

# rest of the script
</pre></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="sect_12_02_03_02"></a>2.3.2. Removing rubbish upon exit</h4></div></div></div><p>The <span class="command"><strong>whatis</strong></span> command relies on a database which is regularly built using the <code class="filename">makewhatis.cron</code> script with cron:</p><pre class="screen">
#!/bin/bash

LOCKFILE=/var/lock/makewhatis.lock

# Previous makewhatis should execute successfully:

[ -f $LOCKFILE ] &amp;&amp; exit 0

# Upon exit, remove lockfile.

trap "{ rm -f $LOCKFILE ; exit 255; }" EXIT

touch $LOCKFILE
makewhatis -u -w
exit 0
</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch12s01.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch12.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch12s03.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">1. Signals </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 3. Summary</td></tr></table></div></body></html>
