<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>9. Required network setup for IPSec</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="RedHat, redhat, maddy, linus, linux, Linux, Securing, Optimising, security, secure, openna, gerhard"><link rel="home" href="index.html" title="Securing and Optimizing Linux"><link rel="up" href="fSWAn.html" title="Chapter 25. Linux FreeS/WAN VPN"><link rel="prev" href="chap25sec205.html" title="8. Configure RSA private keys secrets"><link rel="next" href="chap25sec207.html" title="10. Testing the installation"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">9. Required network setup for IPSec</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="chap25sec205.html">Prev</a> </td><th width="60%" align="center">Chapter 25. Linux FreeS/WAN VPN</th><td width="20%" align="right"> <a accesskey="n" href="chap25sec207.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm15198"></a>9. Required network setup for IPSec</h2></div></div></div><p>
There are some considerations you must ensure are correct before running FreeS/WAN software. These considerations are important if you don't want to receive error messages during start up of your <acronym class="acronym">VPN</acronym>. The following 
are required:
</p><p>
You will need to enable <acronym class="acronym">TCP</acronym>/<acronym class="acronym">IP</acronym> forwarding on the both gateway servers. In Red Hat Linux, this is accomplished by changing or adding the following line, depending on the Red Hat version you use:

</p><div class="mediaobject"><img src="images/Version6.1.gif" alt="Version 6.1 only"></div><p>
Edit the <code class="filename">network</code> file, <span class="command"><strong>vi</strong></span> <code class="filename">/etc/sysconfig/network</code>, and change the following line:
</p><pre class="programlisting">
FORWARD_IPV4="false"
</pre><p>
To read:
</p><pre class="programlisting">
FORWARD_IPV4="yes"
</pre><p>
</p><p>
You must restart your network for the change to take effect:
</p><pre class="screen">
[root@deep] /# /etc/rc.d/init.d/network restart
</pre><p>
</p><pre class="literallayout"><code class="computeroutput">
Bringing up interface lo		[  OK  ]
Bringing up interface eth0	        [  OK  ]
Bringing up interface eth1	        [  OK  ]
</code></pre><p>
</p><div class="mediaobject"><img src="images/Version6.2.gif" alt="Version 6.2 only"></div><p>
To enable IPv4 forwarding on your RH 6.2 system, use the following command:

Edit the <code class="filename">/etc/sysctl.conf</code> file and add the following line:
</p><pre class="programlisting">
# Enable packet forwarding
net.ipv4.ip_forward = 1
</pre><p>
</p><p>
You must restart your network for the change to take effect. The command to restart the network is the following:
</p><pre class="screen">
[root@deep] /# /etc/rc.d/init.d/network <span class="command"><strong>restart</strong></span>
</pre><p>
</p><pre class="literallayout"><code class="computeroutput">
Setting network parameters		[  OK  ]
Bringing up interface lo		[  OK  ]
Bringing up interface eth0	        [  OK  ]
Bringing up interface eth1	        [  OK  ]
</code></pre><p>
</p><p>
Recall that automatically keyed connections use keys automatically generated by the Pluto key negotiation daemon. The pluto daemon will start up, try to connect to the Pluto daemon at the other end of the tunnel, and establish a 
connection. For this reason, an IPSEC gateway should have packet filters rules <span class="emphasis"><em>in the firewall script file</em></span> permitting the following protocols to traverse the gateway when talking to other IPSEC gateway:
</p><div class="orderedlist"><ol class="orderedlist" type="i"><li class="listitem"><p>
UDP port 500 for IKE implemented by the Pluto daemon
</p></li><li class="listitem"><p>
Protocol 50 for ESP encryption and/or authentication
</p></li><li class="listitem"><p>
Protocol 51 for AH packet-level authentication
</p></li></ol></div><p>
</p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
Edit the <code class="filename">firewall</code> script file, <span class="command"><strong>vi</strong></span> <code class="filename">/etc/rc.d/init.d/firewall</code> on both gateway machines, and add/check the following lines to allow IPSEC packets 
to traverse the remote network gateway to your network gateway and vice versa:
</p><pre class="programlisting">
    # FreeS/WAN IPSec <acronym class="acronym">VPN</acronym>
    # -------------------

    # If you are using the FreeSWAN IPSec <acronym class="acronym">VPN</acronym>, you will need to fill in the
    # addresses of the gateways in the IPSECSG and the virtual interfaces for
    # FreeS/Wan IPSEC in the FREESWANVI parameters. Look at the beginning of
    # this firewall script rules file to set the parameters.

    # IPSECSG is a Space separated list of remote gateways. FREESWANVI is a
    # Space separated list of virtual interfaces for FreeS/Wan IPSEC
    # implementation. Only include those that are actually used.

    # Allow IPSEC protocol from remote gateways on external interface
    # IPSEC uses three main types of packet:
    # IKE uses the UDP protocol and port 500,
    # ESP use the protocol number 50, and
    # AH use the protocol number 51

    ipchains -A input  -i $EXTERNAL_INTERFACE -p udp \
             -s $IPSECSG -j ACCEPT

    ipchains -A output  -i $EXTERNAL_INTERFACE -p udp \
             -d $IPSECSG -j ACCEPT

    ipchains -A input  -i $EXTERNAL_INTERFACE -p 50 \
             -s $IPSECSG -j ACCEPT

    ipchains -A output  -i $EXTERNAL_INTERFACE -p 50 \
             -d $IPSECSG -j ACCEPT

    ipchains -A input  -i $EXTERNAL_INTERFACE -p 51 \
             -s $IPSECSG -j ACCEPT

    ipchains -A output  -i $EXTERNAL_INTERFACE -p 51 \
             -d $IPSECSG -j ACCEPT

    # Allow all traffic to FreeS/WAN Virtual Interface
    ipchains -A input  -i $FREESWANVI \
             -s $ANYWHERE \
             -d $ANYWHERE -j ACCEPT

    ipchains -A output  -i $FREESWANVI \
             -s $ANYWHERE \
             -d $ANYWHERE -j ACCEPT

    # Forward anything from the FreeS/WAN virtual interface IPSEC tunnel
    ipchains -A forward  -i $FREESWANVI \
             -s $ANYWHERE \
             -d $ANYWHERE -j ACCEPT
</pre><p>
where
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">EXTERNAL_INTERFACE="eth0"</span></dt><dd><p>
 You external interface to the Internet.
 </p></dd><dt><span class="term">ANYWHERE="any/0"</span></dt><dd><p>
Mean everywhere 0.0.0.0/0.
</p></dd><dt><span class="term">IPSECSG=<code class="literal">208.164.186.2</code></span></dt><dd><p>
Space separated list of remote <acronym class="acronym">VPN</acronym> gateways.
</p></dd><dt><span class="term">FREESWANVI=<code class="literal">ipsec0</code></span></dt><dd><p>
Space separated list of virtual interfaces for FreeS/Wan.
</p></dd></dl></div><p>
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">
<span class="inlinemediaobject"><img src="./images/Important.gif" alt="Important"></span>
</h3><p>
See <a class="link" href="soft-netfirew.html" title="Chapter 10. Networking -Firewall">Networking Firewall</a>, for more information. Dont forget to add/check these firewall rules in the other gateway as well.
</p></div><p>
</p></li><li class="step"><p>

The <code class="literal">rp_filter</code> subsystem related to <acronym class="acronym">IP</acronym> spoofing protection must be turned off on both gateways for IPSEC to work properly. This is accomplished by checking if the value 0 (off) is set in 
the <code class="filename">/proc/sys/net/ipv4/conf/ipsec0/rp_filter</code> and <code class="filename">/proc/sys/net/ipv4/conf/eth0/rp_filter</code> files respectively:
</p><ol type="a" class="substeps"><li class="step"><p>
    To check if the value 0 (off) is set in the <code class="filename">rp_filter</code> files, use the commands:
</p><pre class="screen">
[root@deep] /# <span class="command"><strong>cat</strong></span> /proc/sys/net/ipv4/conf/ipsec0/rp_filter
</pre><p>
</p><pre class="literallayout"><code class="computeroutput">
0
</code></pre><p>
</p><pre class="screen">
[root@deep] /# <span class="command"><strong>cat</strong></span> /proc/sys/net/ipv4/conf/eth0/rp_filter
</pre><p>
</p><pre class="literallayout"><code class="computeroutput">
0
</code></pre><p>
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">
<span class="inlinemediaobject"><img src="./images/Important.gif" alt="Important"></span>
</h3><p>
The subdirectory <code class="filename">ipsec0</code> in our example will be created only after the reboot of your system. So you may check the value of the <code class="filename">rp_filter</code> file in the <code class="filename">ipsec0</code> 
directory after your system has been restarted.
</p></div><p>
</p></li><li class="step"><p>
To set the value 0 (off) in the both <code class="filename">rp_filter</code> files manually, use the command:
</p><pre class="screen">
[root@deep] /# <span class="command"><strong>echo</strong></span> 0 &gt; /proc/sys/net/ipv4/conf/ipsec0/rp_filter
[root@deep] /# <span class="command"><strong>echo</strong></span> 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter
</pre><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">
<span class="inlinemediaobject"><img src="./images/Tip.gif" alt="Tip"></span>
</h3><p>
Also you can put lines like the following in your firewall script files <code class="filename">/etc/rc.d/init.d/firewall</code> on the both gateways to automatically set these values to 0 (off) and avoid making them manually:
</p><pre class="programlisting">
    # Disable <acronym class="acronym">IP</acronym> spoofing protection to allow IPSEC to work properly
    <span class="command"><strong>echo</strong></span> 0 &gt; /proc/sys/net/ipv4/conf/ipsec0/rp_filter
    <span class="command"><strong>echo</strong></span> 0 &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter
    </pre><p>
    </p></div><p>
    </p></li></ol></li><li class="step"><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><span class="inlinemediaobject"><img src="./images/Note.gif" alt="Note"></span></h3><p>
In the example of the firewall script file above, we assume that <code class="literal">eth0</code> is the interface you use for your connection. Of course if you use <code class="literal">eth1</code> you must change <code class="literal">eth0</code> to <code class="literal">eth1</code>, and so on.
</p></div><p>
If you forget this step you will receive error messages on your terminal such as the following during the start up of FreeSWAN IPSEC:
</p><pre class="literallayout"><code class="computeroutput">
ipsec_setup: WARNING: ipsec0 has route filtering turned on, KLIPS may not work
ipsec_setup:  (/proc/sys/net/ipv4/conf/ipsec0/rp_filter = `1', should be 0)
ipsec_setup: WARNING: eth0 has route filtering turned on, KLIPS may not work
ipsec_setup:  (/proc/sys/net/ipv4/conf/eth0/rp_filter = `1', should be 0)
</code></pre><p>
</p></li><li class="step"><p>
It's important to note that any masquerading rules for internal networks that use IPSEC must come after the rules allowing IPSEC related traffic (The step 2 and 3 above), or the machine will try to masquerade the packets, instead of 
them being passed over to IPSEC.

Edit the <code class="filename">firewall</code> script file, <span class="command"><strong>vi</strong></span> <code class="filename">/etc/rc.d/init.d/firewall</code> on both gateway machines and add/check the following lines to allow masqueraded packets to traverse the 
remote network gateway to your network gateway and vice versa:
</p><pre class="programlisting">
# Masquerade internal traffic.

    # All internal traffic is masqueraded externally.

    ipchains -A forward -i $EXTERNAL_INTERFACE -s $LOCALNET_1 -j MASQ
</pre><p>
Where
</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">EXTERNAL_INTERFACE="eth0"</span></dt><dd><p>
You external interface to the Internet.
</p></dd><dt><span class="term">LOCALNET_1=" 192.168.1.0/24"</span></dt><dd><p>
whatever private range you use.
</p></dd></dl></div><p>
</p></li></ol></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><span class="inlinemediaobject"><img src="./images/Note.gif" alt="Note"></span></h3><p>
See <a class="link" href="Masq-forward.html" title="Chapter 12. Networking Firewall -Masquerading and Forwarding">Networking Firewall with Masquerading and Forwarding</a> support for more information.
</p></div><p>
Now, you can reboot your system, and the machines on Gateway A should be able to talk to the machines on Gateway B with no problems.
</p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="chap25sec205.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="fSWAn.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="chap25sec207.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">8. Configure <acronym class="acronym">RSA</acronym> private keys secrets </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 10. Testing the installation</td></tr></table></div></body></html>
