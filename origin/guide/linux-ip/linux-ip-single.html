<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Guide to IP Layer Network Administration with Linux</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="description" content="This guide provides an overview of many of the tools available for IP network administration of the linux operating system, kernels in the 2.2 and 2.4 series. It covers Ethernet, ARP, IP routing, NAT, and other topics central to the management of IP networks."><meta name="keywords" content="linux, ip, iproute2, ifconfig, firewall, ARP, NAT, route, routing, route selection, routing selection, network administration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="idm1"></a>Guide to IP Layer Network Administration with Linux</h1></div><div><h2 class="subtitle">Version 0.4.5</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Martin</span> <span class="othername">A.</span> <span class="surname">Brown</span></h3><div class="affiliation"><span class="orgname">
        <a class="ulink" href="http://www.securepipe.com/" target="_top">SecurePipe, Inc.</a>
        <br></span> <span class="orgdiv">Network Administration<br></span><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:mabrown@securepipe.com">mabrown@securepipe.com</a>&gt;</code></p></div></div></div></div><div><p class="copyright">Copyright © 2002, 2003 Martin A. Brown</p></div><div><p class="pubdate">2007-Mar-14</p></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision 0.4.4</td><td align="left">2003-04-26</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">added index, began packet filtering chapter</td></tr><tr><td align="left">Revision 0.4.3</td><td align="left">2003-04-14</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">ongoing editing, ARP/NAT fixes, routing content</td></tr><tr><td align="left">Revision 0.4.2</td><td align="left">2003-03-16</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">ongoing editing; unreleased version</td></tr><tr><td align="left">Revision 0.4.1</td><td align="left">2003-02-19</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">major routing revision; better use of callouts</td></tr><tr><td align="left">Revision 0.4.0</td><td align="left">2003-02-11</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">major NAT revs; add inline scripts; outline FIB</td></tr><tr><td align="left">Revision 0.3.9</td><td align="left">2003-02-05</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">fleshed out bonding; added bridging chapter</td></tr><tr><td align="left">Revision 0.3.8</td><td align="left">2003-02-03</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">move to linux-ip.net; use TLDP XSL stylesheets</td></tr><tr><td align="left">Revision 0.3.7</td><td align="left">2003-02-02</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">major editing on ARP; minor editing on routing</td></tr><tr><td align="left">Revision 0.3.6</td><td align="left">2003-01-30</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">switch to XSLT processing; minor revs; CVS</td></tr><tr><td align="left">Revision 0.3.5</td><td align="left">2003-01-08</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">ARP flux complete; ARP filtering touched</td></tr><tr><td align="left">Revision 0.3.4</td><td align="left">2003-01-06</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">ARP complete; bridging added; ip neigh complete</td></tr><tr><td align="left">Revision 0.3.3</td><td align="left">2003-01-05</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">split into 3 parts; ARP chapter begun</td></tr><tr><td align="left">Revision 0.3.2</td><td align="left">2002-12-29</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">links updated; minor editing</td></tr><tr><td align="left">Revision 0.3.1</td><td align="left">2002-11-26</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">edited: intro, snat, nat; split advanced in two</td></tr><tr><td align="left">Revision 0.3.0</td><td align="left">2002-11-14</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">chapters finally have good HTML names</td></tr><tr><td align="left">Revision 0.2.9</td><td align="left">2002-11-11</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">routing chapter heavily edited</td></tr><tr><td align="left">Revision 0.2.8</td><td align="left">2002-11-07</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">basic chapter heavily edited</td></tr><tr><td align="left">Revision 0.2.7</td><td align="left">2002-11-04</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">routing chapter finished; links rearranged</td></tr><tr><td align="left">Revision 0.2.6</td><td align="left">2002-10-29</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">routing chapter continued</td></tr><tr><td align="left">Revision 0.2.5</td><td align="left">2002-10-28</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">routing chapter partly complete</td></tr><tr><td align="left">Revision 0.2.4</td><td align="left">2002-10-08</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">advanced routing additions and overview</td></tr><tr><td align="left">Revision 0.2.3</td><td align="left">2002-09-30</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">minor editing; worked on tools/netstat; advanced
                   routing</td></tr><tr><td align="left">Revision 0.2.2</td><td align="left">2002-09-24</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">formalized revisioning; finished basic networking;
                   started netstat</td></tr><tr><td align="left">Revision 0.2.1</td><td align="left">2002-09-21</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">added network map to incomplete rough draft</td></tr><tr><td align="left">Revision 0.2</td><td align="left">2002-09-20</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">incomplete rough draft released on LARTC list</td></tr><tr><td align="left">Revision 0.1</td><td align="left">2002-08-04</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">rough draft begun</td></tr></table></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
        This guide provides an overview of many of the tools available
        for IP network administration of the linux operating system,
        kernels in the 2.2 and 2.4 series.  It covers Ethernet, ARP,
        IP routing, NAT, and other topics central to the management of IP
        networks.
      </p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#intro">Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#intro-assumptions">1. Target Audience, Assumptions, and Recommendations</a></span></dt><dt><span class="section"><a href="#intro-conventions">2. Conventions</a></span></dt><dt><span class="section"><a href="#intro-bugs">3. Bugs and Roadmap</a></span></dt><dt><span class="section"><a href="#intro-note">4. Technical Note and Summary of Approach</a></span></dt><dt><span class="section"><a href="#intro-closing">5. Acknowledgements and Request for Remarks</a></span></dt></dl></dd><dt><span class="part"><a href="#part-concepts">I. Concepts</a></span></dt><dd><dl><dt><span class="chapter"><a href="#ch-basic">1. Basic IP Connectivity</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-control-files">1. IP Networking Control Files</a></span></dt><dt><span class="section"><a href="#basic-reading">2. Reading Routes and IP Information</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-local-network">2.1. Sending Packets to the Local Network</a></span></dt><dt><span class="section"><a href="#basic-default-gateway">2.2. Sending Packets to Unknown Networks Through the Default
        Gateway</a></span></dt><dt><span class="section"><a href="#basic-static">2.3. Static Routes to Networks</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-changing">3. Changing IP Addresses and Routes</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-changing-ip">3.1. Changing the IP on a machine</a></span></dt><dt><span class="section"><a href="#basic-changing-default">3.2. Setting the Default Route</a></span></dt><dt><span class="section"><a href="#basic-changing-static">3.3. Adding and removing a static route</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-conclusion">4. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-ether">2. Ethernet</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-arp">1. Address Resolution Protocol (ARP)</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-arp-overview">1.1. Overview of Address Resolution Protocol</a></span></dt><dt><span class="section"><a href="#ether-arp-cache">1.2. The ARP cache</a></span></dt><dt><span class="section"><a href="#ether-arp-suppression">1.3. ARP Suppression</a></span></dt><dt><span class="section"><a href="#ether-arp-flux">1.4. The ARP Flux Problem</a></span></dt></dl></dd><dt><span class="section"><a href="#ether-arp-proxy">2. Proxy ARP</a></span></dt><dt><span class="section"><a href="#ether-arp-filtering">3. ARP filtering</a></span></dt><dt><span class="section"><a href="#ether-vlan">4. Connecting to an Ethernet 802.1q VLAN</a></span></dt><dt><span class="section"><a href="#ether-bonding">5. Link Aggregation and High Availability with Bonding</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-bonding-aggregation">5.1. Link Aggregation</a></span></dt><dt><span class="section"><a href="#ether-bonding-ha">5.2. High Availability</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ch-bridging">3. Bridging</a></span></dt><dd><dl><dt><span class="section"><a href="#bridging-intro">1. Concepts of Bridging</a></span></dt><dt><span class="section"><a href="#bridging-stp">2. Bridging and Spanning Tree Protocol</a></span></dt><dt><span class="section"><a href="#bridging-packet-filter">3. Bridging and Packet Filtering</a></span></dt><dt><span class="section"><a href="#bridging-tc">4. Traffic Control with a Bridge</a></span></dt><dt><span class="section"><a href="#bridging-ebtables">5. <span class="command"><strong>ebtables</strong></span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-routing">4. IP Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-intro">1. Introduction to Linux Routing</a></span></dt><dt><span class="section"><a href="#routing-local">2. Routing to Locally Connected Networks</a></span></dt><dt><span class="section"><a href="#routing-default">3. Sending Packets Through a Gateway</a></span></dt><dt><span class="section"><a href="#routing-forwarding">4. Operating as a Router</a></span></dt><dt><span class="section"><a href="#routing-selection">5. Route Selection</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-selection-common">5.1. The Common Case</a></span></dt><dt><span class="section"><a href="#routing-selection-adv">5.2. The Whole Story</a></span></dt><dt><span class="section"><a href="#routing-selection-summary">5.3. Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-saddr-selection">6. Source Address Selection</a></span></dt><dt><span class="section"><a href="#routing-cache">7. Routing Cache</a></span></dt><dt><span class="section"><a href="#routing-tables">8. Routing Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-table-entries">8.1. Routing Table Entries (Routes)</a></span></dt><dt><span class="section"><a href="#routing-table-local">8.2. The Local Routing Table</a></span></dt><dt><span class="section"><a href="#routing-table-main">8.3. The Main Routing Table</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-rpdb">9. Routing Policy Database (RPDB)</a></span></dt><dt><span class="section"><a href="#routing-icmp">10. ICMP and Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-icmp-mtu">10.1. MTU, MSS, and ICMP</a></span></dt><dt><span class="section"><a href="#routing-icmp-redirect">10.2. ICMP Redirects and Routing</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ch-nat">5. Network Address Translation (NAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#nat-overview">1. Rationale for and Introduction to NAT</a></span></dt><dt><span class="section"><a href="#nat-break">2. Application Layer Protocols with Embedded Network Information</a></span></dt><dt><span class="section"><a href="#nat-stateless">3. Stateless NAT with <span class="command"><strong>iproute2</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#nat-stateless-simple">3.1. Stateless NAT Packet Capture and Introduction</a></span></dt><dt><span class="section"><a href="#nat-stateless-howto">3.2. Stateless NAT Practicum</a></span></dt><dt><span class="section"><a href="#nat-stateless-rpdb">3.3. Conditional Stateless NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-stateless-pf-interaction">4. Stateless NAT and Packet Filtering</a></span></dt><dt><span class="section"><a href="#nat-dnat">5. Destination NAT with netfilter (DNAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#nat-dnat-pat">5.1. Port Address Translation with DNAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-pat-userspace">6. Port Address Translation (PAT) from Userspace</a></span></dt><dt><span class="section"><a href="#nat-pat-userspace-transparent">7. Transparent PAT from Userspace</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-snat">6. Masquerading and Source Network Address Translation</a></span></dt><dd><dl><dt><span class="section"><a href="#snat-intro">1. Concepts of Source NAT</a></span></dt><dd><dl><dt><span class="section"><a href="#snat-masq-diff">1.1. Differences Between SNAT and Masquerading</a></span></dt><dt><span class="section"><a href="#snat-double">1.2. Double SNAT/Masquerading</a></span></dt></dl></dd><dt><span class="section"><a href="#snat-inbound">2. Issues with SNAT/Masquerading and Inbound Traffic</a></span></dt><dt><span class="section"><a href="#snat-break">3. Where Masquerading and SNAT Break</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-packetfilter">7. Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-intro">1. Rationale for and Introduction to Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-history">1.1. History of Linux Packet Filter Support</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-shortcomings">2. Limits and Weaknesses of Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-limits">2.1. Limits of the Usefulness of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness">2.2. Weaknesses of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness-stateless">2.3. Complex Network Layer Stateless Packet Filters</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-icmp">3. General Packet Filter Requirements</a></span></dt><dt><span class="section"><a href="#pf-netfilter">4. The Netfilter Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-netfilter-iptables">4.1. Packet Filtering with <span class="command"><strong>iptables</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-ipchains">5. Packet Filtering with <span class="command"><strong>ipchains</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#pf-ipchains-mangling">5.1. Packet Mangling with <span class="command"><strong>ipchains</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-host">6. Protecting a Host</a></span></dt><dt><span class="section"><a href="#pf-network">7. Protecting a Network</a></span></dt><dt><span class="section"><a href="#pf-further">8. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-state">8. Statefulness and Statelessness</a></span></dt><dd><dl><dt><span class="section"><a href="#state-intro">1. </a></span></dt><dt><span class="section"><a href="#state-routing">2. Statelessness of IP Routing</a></span></dt><dt><span class="section"><a href="#state-conntrack">3. Netfilter Connection Tracking</a></span></dt><dd><dl><dt><span class="section"><a href="#state-conntrack-filter">3.1. </a></span></dt><dt><span class="section"><a href="#state-conntrack-nat">3.2. </a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#part-cookbook">II. Cookbook</a></span></dt><dd><dl><dt><span class="chapter"><a href="#ch-advanced">9. Advanced IP Management</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-arp-problem">1. Multiple IPs and the ARP Problem</a></span></dt><dt><span class="section"><a href="#adv-media-share">2. Multiple IP Networks on one Ethernet Segment</a></span></dt><dt><span class="section"><a href="#adv-proxy-arp">3. Breaking a network in two with proxy ARP</a></span></dt><dt><span class="section"><a href="#adv-multi-ips">4. Multiple IPs on an Interface</a></span></dt><dt><span class="section"><a href="#adv-multi-ethernet">5. Multiple connections to the same Ethernet</a></span></dt><dt><span class="section"><a href="#adv-multi-homed">6. Multihomed Hosts</a></span></dt><dt><span class="section"><a href="#adv-nonlocal-bind">7. Binding to Non-local Addresses</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-advanced-routing">10. Advanced IP Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-routing">1. Introduction to Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-overview">2. Overview of Routing and Packet Filter Interactions</a></span></dt><dt><span class="section"><a href="#adv-rpdb">3. Using the Routing Policy Database and Multiple Routing
      Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-routing-tos">3.1. Using Type of Service Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-fwmark">3.2. Using fwmark for Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-nat">3.3. Policy Routing and NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#adv-multi-internet">4. Multiple Connections to the Internet</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-multi-internet-outbound">4.1. Outbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-inbound">4.2. Inbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-bidirectional">4.3. Using Multiple Connections to the Internet for Inbound and
        Outbound Connections</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ax-scripts">11. Scripts for Managing IP</a></span></dt><dd><dl><dt><span class="section"><a href="#scripts-proxy-arp">1. Proxy ARP Scripts</a></span></dt><dt><span class="section"><a href="#scripts-nat">2. NAT Scripts</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-trouble">12. Troubleshooting</a></span></dt><dd><dl><dt><span class="section"><a href="#trouble-intro">1. Introduction to Troubleshooting</a></span></dt><dt><span class="section"><a href="#trouble-ethernet">2. Troubleshooting at the Ethernet Layer</a></span></dt><dt><span class="section"><a href="#trouble-ip">3. Troubleshooting at the IP Layer</a></span></dt><dt><span class="section"><a href="#trouble-routing">4. Handling and Diagnosing Routing Problems</a></span></dt><dt><span class="section"><a href="#trouble-tcp">5. Identifying Problems with TCP Sessions</a></span></dt><dt><span class="section"><a href="#trouble-dns">6. DNS Troubleshooting</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#part-reference">III. Appendices and Reference</a></span></dt><dd><dl><dt><span class="appendix"><a href="#ax-example-network">A. An Example Network and Description</a></span></dt><dd><dl><dt><span class="section"><a href="#example-network-netmap">1. Example Network Map and General Notes</a></span></dt><dt><span class="section"><a href="#example-network-addressing">2. Example Network Addressing Charts</a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-ethernet">B. Ethernet Layer Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-arp">1. <span class="command"><strong>arp</strong></span></a></span></dt><dt><span class="section"><a href="#tools-arping">2. <span class="command"><strong>arping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link">3. <span class="command"><strong>ip link</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-link-show">3.1. Displaying link layer characteristics with <span class="command"><strong>ip link
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set">3.2. Changing link layer characteristics with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-down">3.3. Deactivating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-up">3.4. Activating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-mtu">3.5. Using <span class="command"><strong>ip link set</strong></span> to change the MTU</a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-name">3.6. Changing the device name with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-address">3.7. Changing hardware or Ethernet broadcast address with
          <span class="command"><strong>ip link set</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-neighbor">4. <span class="command"><strong>ip neighbor</strong></span></a></span></dt><dt><span class="section"><a href="#tools-mii-tool">5. <span class="command"><strong>mii-tool</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-ip-management">C. IP Address Management</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ifconfig">1. <span class="command"><strong>ifconfig</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ifconfig-display">1.1. Displaying interface information with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-down">1.2. Bringing down an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-up">1.3. Bringing up an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-output">1.4. Reading <span class="command"><strong>ifconfig</strong></span> output</a></span></dt><dt><span class="section"><a href="#tools-ifconfig-mtu">1.5. Changing MTU with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-flags">1.6. Changing device flags with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-conclusion">1.7. General remarks about <span class="command"><strong>ifconfig</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-address">2. <span class="command"><strong>ip address</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-address-show">2.1. Displaying interface information with
            <span class="command"><strong>ip address show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-add">2.2. Using <span class="command"><strong>ip address add</strong></span> to configure
          IP address information</a></span></dt><dt><span class="section"><a href="#tools-ip-address-del">2.3. Using <span class="command"><strong>ip address del</strong></span> to remove IP addresses
          from an interface</a></span></dt><dt><span class="section"><a href="#tools-ip-address-flush">2.4. Removing all IP address information from an interface
          with <span class="command"><strong>ip address flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-conclusion">2.5. Conclusion</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#tools-ip-routing">D. IP Route Management</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-route">1. <span class="command"><strong>route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-route-show">1.1. Displaying the routing table with <span class="command"><strong>route</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-output">1.2. Reading <span class="command"><strong>route</strong></span>'s output</a></span></dt><dt><span class="section"><a href="#tools-route-show-cache">1.3. Using <span class="command"><strong>route</strong></span> to display the routing cache</a></span></dt><dt><span class="section"><a href="#tools-route-add">1.4. Creating a static route with <span class="command"><strong>route add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-add-default">1.5. Creating a default route with <span class="command"><strong>route add default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-del">1.6. Removing routes with <span class="command"><strong>route del</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-route">2. <span class="command"><strong>ip route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-route-show">2.1. Displaying a routing table with <span class="command"><strong>ip route
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-show-cache">2.2. Displaying the routing cache with <span class="command"><strong>ip route
          show cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add">2.3. Using <span class="command"><strong>ip route add</strong></span> to populate a routing
          table</a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-default">2.4. Adding a default route with <span class="command"><strong>ip route add
          default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-nat">2.5. Setting up NAT with <span class="command"><strong>ip route add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-del">2.6. Removing routes with <span class="command"><strong>ip route del</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-change">2.7. Altering existing routes with <span class="command"><strong>ip route
          change</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-get">2.8. Programmatically fetching route information with <span class="command"><strong>ip
          route get</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush">2.9. Clearing routing tables with <span class="command"><strong>ip route
          flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush-cache">2.10. <span class="command"><strong>ip route flush cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-summary">2.11. Summary of the use of <span class="command"><strong>ip route</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-rule">3. <span class="command"><strong>ip rule</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-rule-intro">3.1. <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-show">3.2. Displaying the RPDB with <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add">3.3. Adding a rule to the RPDB with <span class="command"><strong>ip rule
          add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add-nat">3.4. <span class="command"><strong>ip rule add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-del">3.5. <span class="command"><strong>ip rule del</strong></span></a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#tools-tunnels">E. Tunnels and VPNs</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-cipe">1. Lightweight encrypted tunnel with <span class="command"><strong>CIPE</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipip">2. GRE tunnels with <span class="command"><strong>ip tunnel</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ssh">3. All manner of tunnels with <span class="command"><strong>ssh</strong></span></a></span></dt><dt><span class="section"><a href="#tools-freeswan">4. IPSec implementation via <span class="command"><strong>FreeS/WAN</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipsec">5. IPSec implementation in the kernel</a></span></dt><dt><span class="section"><a href="#tools-pptp">6. <span class="command"><strong>PPTP</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-sockets">F. Sockets; Servers and Clients</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-telnet">1. <span class="command"><strong>telnet</strong></span></a></span></dt><dt><span class="section"><a href="#tools-nc">2. <span class="command"><strong>nc</strong></span></a></span></dt><dt><span class="section"><a href="#tools-socat">3. <span class="command"><strong>socat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpclient">4. <span class="command"><strong>tcpclient</strong></span></a></span></dt><dt><span class="section"><a href="#tools-xinetd">5. <span class="command"><strong>xinetd</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpserver">6. <span class="command"><strong>tcpserver</strong></span></a></span></dt><dt><span class="section"><a href="#tools-redir">7. <span class="command"><strong>redir</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-diagnostics">G. Diagnostic Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ping">1. <span class="command"><strong>ping</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ping-simple">1.1. Using <span class="command"><strong>ping</strong></span> to test reachability</a></span></dt><dt><span class="section"><a href="#tools-ping-stress">1.2. Using <span class="command"><strong>ping</strong></span> to stress a network</a></span></dt><dt><span class="section"><a href="#tools-ping-record-route">1.3. Recording a network route with <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-ttl">1.4. Setting the TTL on a <span class="command"><strong>ping</strong></span> packet</a></span></dt><dt><span class="section"><a href="#tools-ping-tos">1.5. Setting ToS for a diagnostic <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-specify-source">1.6. Specifying a source address for <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-summary">1.7. Summary on the use of <span class="command"><strong>ping</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-traceroute">2. <span class="command"><strong>traceroute</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-traceroute-basic">2.1. Using <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-icmp">2.2. Telling <span class="command"><strong>traceroute</strong></span> to use ICMP echo request
          instead of UDP</a></span></dt><dt><span class="section"><a href="#tools-traceroute-tos">2.3. Setting ToS with <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-summary">2.4. Summary on the use of <span class="command"><strong>traceroute</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-mtr">3. <span class="command"><strong>mtr</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat">4. <span class="command"><strong>netstat</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-netstat-socket">4.1. Displaying socket status with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-route">4.2. Displaying the main routing table with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-interface">4.3. Displaying network interface statistics with
          <span class="command"><strong>netstat</strong></span> command</a></span></dt><dt><span class="section"><a href="#tools-netstat-statistics">4.4. Displaying network stack statistics with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-masquerade">4.5. Displaying the masquerading table with
          <span class="command"><strong>netstat</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpdump">5. <span class="command"><strong>tcpdump</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-tcpdump-arp">5.1. Using <span class="command"><strong>tcpdump</strong></span> to view ARP messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-unreach">5.2. Using <span class="command"><strong>tcpdump</strong></span> to see ICMP unreachable
          messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-tcp">5.3. Using <span class="command"><strong>tcpdump</strong></span> to watch TCP sessions</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-file">5.4. Reading and writing <span class="command"><strong>tcpdump</strong></span> data</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-frag">5.5. Understanding fragmentation as reported by
          <span class="command"><strong>tcpdump</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpdump-other">5.6. Other options to the <span class="command"><strong>tcpdump</strong></span> command</a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpflow">6. <span class="command"><strong>tcpflow</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpreplay">7. <span class="command"><strong>tcpreplay</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-misc">H. Miscellany</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ipcalc">1. <span class="command"><strong>ipcalc</strong></span> and other IP addressing calculators</a></span></dt><dt><span class="section"><a href="#tools-iproute2-remarks">2. Some general remarks about <span class="command"><strong>iproute2</strong></span> tools</a></span></dt><dt><span class="section"><a href="#tools-sysctl-intro">3. Brief introduction to <span class="command"><strong>sysctl</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#ax-links">I. Links to other Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#links-doc">1. Links to Documentation</a></span></dt><dd><dl><dt><span class="section"><a href="#links-general-linux">1.1. Linux Networking Introduction and Overview Material</a></span></dt><dt><span class="section"><a href="#links-linux-security">1.2. Linux Security and Network Security</a></span></dt><dt><span class="section"><a href="#links-general-ip">1.3. General IP Networking Resources</a></span></dt><dt><span class="section"><a href="#links-masq">1.4. Masquerading topics</a></span></dt><dt><span class="section"><a href="#links-nat">1.5. Network Address Translation</a></span></dt><dt><span class="section"><a href="#links-iproute2">1.6. iproute2 documentation</a></span></dt><dt><span class="section"><a href="#links-netfilter">1.7. Netfilter Resources</a></span></dt><dt><span class="section"><a href="#links-ipchains">1.8. <span class="command"><strong>ipchains</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-ipfwadm">1.9. <span class="command"><strong>ipfwadm</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-systems">1.10. General Systems References</a></span></dt><dt><span class="section"><a href="#links-bridging">1.11. Bridging</a></span></dt><dt><span class="section"><a href="#links-tc">1.12. Traffic Control</a></span></dt><dt><span class="section"><a href="#links-multicast">1.13. IPv4 Multicast</a></span></dt><dt><span class="section"><a href="#links-misc">1.14. Miscellaneous Linux IP Resources</a></span></dt></dl></dd><dt><span class="section"><a href="#links-software">2. Links to Software</a></span></dt><dd><dl><dt><span class="section"><a href="#idm6929">2.1. Basic Utilities</a></span></dt><dt><span class="section"><a href="#idm6953">2.2. Virtual Private Networking software</a></span></dt><dt><span class="section"><a href="#idm6964">2.3. Traffic Control queueing disciplines and command line tools</a></span></dt><dt><span class="section"><a href="#idm6987">2.4. Interfaces to lower layer tools</a></span></dt><dt><span class="section"><a href="#idm7000">2.5. Packet sniffing and diagnostic tools</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#gfdl">J. GNU Free Documentation License</a></span></dt><dd><dl><dt><span class="section"><a href="#gfdl-0">1. PREAMBLE</a></span></dt><dt><span class="section"><a href="#gfdl-1">2. APPLICABILITY AND DEFINITIONS</a></span></dt><dt><span class="section"><a href="#gfdl-2">3. VERBATIM COPYING</a></span></dt><dt><span class="section"><a href="#gfdl-3">4. COPYING IN QUANTITY</a></span></dt><dt><span class="section"><a href="#gfdl-4">5. MODIFICATIONS</a></span></dt><dt><span class="section"><a href="#gfdl-5">6. COMBINING DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-6">7. COLLECTIONS OF DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-7">8. AGGREGATION WITH INDEPENDENT WORKS</a></span></dt><dt><span class="section"><a href="#gfdl-8">9. TRANSLATION</a></span></dt><dt><span class="section"><a href="#gfdl-9">10. TERMINATION</a></span></dt><dt><span class="section"><a href="#gfdl-10">11. FUTURE REVISIONS OF THIS LICENSE</a></span></dt><dt><span class="section"><a href="#gfdl-addendum">12. ADDENDUM: How to use this License for
  your documents</a></span></dt></dl></dd></dl></dd><dt><span class="bibliography"><a href="#biblio">Reference Bibliography and Recommended Reading</a></span></dt><dt><span class="index"><a href="#bookindex">Index</a></span></dt></dl></div><div class="list-of-tables"><p><b>List of Tables</b></p><dl><dt>2.1. <a href="#tb-ether-arp-cache-states">Active ARP cache entry states</a></dt><dt>4.1. <a href="#tb-routing-selection-adv">Keys used for hash table lookups during route selection</a></dt><dt>5.1. <a href="#tb-nat-pf-ipchains">Filtering an <span class="command">iproute2</span> NAT packet with
      <span class="command">ipchains</span></a></dt><dt>A.1. <a href="#tb-example-network-networks">Example Network; Network Addressing</a></dt><dt>A.2. <a href="#tb-example-network-hosts">Example Network; Host Addressing</a></dt><dt>B.1. <a href="#tb-ip-link-set-flags"><span class="command">ip link</span> link layer device states</a></dt><dt>B.2. <a href="#tb-mii-tool-port-speed">Ethernet Port Speed Abbreviations</a></dt><dt>C.1. <a href="#tb-tools-ifconfig-flags">Interface Flags</a></dt><dt>C.2. <a href="#tb-tools-ip-addr-scope">IP Scope under <span class="command">ip address</span></a></dt><dt>G.1. <a href="#tb-tools-netstat-socket-states">Possible Session States in <span class="command">netstat</span>
            output</a></dt><dt>H.1. <a href="#tb-tools-iproute2-remarks"><span class="command">iproute2</span> Synonyms</a></dt></dl></div><div class="list-of-examples"><p><b>List of Examples</b></p><dl><dt>1.1. <a href="#ex-basic-ifconfig">Sample <span class="command">ifconfig</span> output</a></dt><dt>1.2. <a href="#ex-basic-ping">Testing reachability of a locally connected host with
          <span class="command">ping</span></a></dt><dt>1.3. <a href="#ex-basic-ping-non-local">Testing reachability of non-local hosts</a></dt><dt>1.4. <a href="#ex-basic-static">Sample routing table with a static route</a></dt><dt>1.5. <a href="#ex-basic-before-change"><span class="command">ifconfig</span> and <span class="command">route</span>
          output before the change</a></dt><dt>1.6. <a href="#ex-basic-ifconfig-down">Bringing down a network interface with
          <span class="command">ifconfig</span></a></dt><dt>1.7. <a href="#ex-basic-ifconfig-up">Bringing up an Ethernet interface with <span class="command">ifconfig</span></a></dt><dt>1.8. <a href="#ex-basic-set-default">Adding a default route with <span class="command">route</span></a></dt><dt>1.9. <a href="#ex-basic-add-static">Adding a static route with <span class="command">route</span></a></dt><dt>1.10. <a href="#ex-basic-del-static">Removing a static network route and adding a static host
          route</a></dt><dt>2.1. <a href="#ex-ether-arp-overview">ARP conversation captured with tcpdump
          
        </a></dt><dt>2.2. <a href="#ex-ether-arp-gratuitous">Gratuitous ARP reply frames</a></dt><dt>2.3. <a href="#ex-ether-arp-unsolicited">Unsolicited ARP request frames</a></dt><dt>2.4. <a href="#ex-ether-arp-dad">Duplicate Address Detection with ARP</a></dt><dt>2.5. <a href="#ex-ether-arp-cache">ARP cache listings with <span class="command">arp</span> and
          <span class="command">ip neighbor</span></a></dt><dt>2.6. <a href="#ex-ether-arp-cache-timeout">ARP cache timeout</a></dt><dt>2.7. <a href="#ex-ether-arp-flux">ARP flux</a></dt><dt>2.8. <a href="#ex-ether-arp-flux-arpfilter">Correction of ARP flux with
            <code class="filename">conf/$DEV/arp_filter</code></a></dt><dt>2.9. <a href="#ex-ether-arp-flux-hidden">Correction of ARP flux with
            <code class="filename">net/$DEV/hidden</code></a></dt><dt>2.10. <a href="#ex-ether-arp-proxy">Proxy ARP Network Diagram</a></dt><dt>2.11. <a href="#ex-ether-vlan">Bringing up a VLAN interface</a></dt><dt>2.12. <a href="#ex-ether-bonding-aggregation">Link aggregation bonding</a></dt><dt>2.13. <a href="#ex-ether-bonding-ha">High availability bonding</a></dt><dt>4.1. <a href="#routing-intro-classes">Classes of IP addresses</a></dt><dt>4.2. <a href="#ex-routing-intro-ipcalc">Using ipcalc to display IP information</a></dt><dt>4.3. <a href="#ex-routing-local">Identifying the locally connected networks with
        <span class="command">route</span></a></dt><dt>4.4. <a href="#routing-selection-algorithm">Routing Selection Algorithm in Pseudo-code</a></dt><dt>4.5. <a href="#ex-routing-selection-adv-ip-rule">Listing the Routing Policy Database (RPDB)</a></dt><dt>4.6. <a href="#ex-routing-tables-rt-table">Typical content of
        <code class="filename">/etc/iproute2/rt_tables</code></a></dt><dt>4.7. <a href="#ex-list-route-unicast">unicast route types</a></dt><dt>4.8. <a href="#ex-list-route-broadcast">broadcast route types</a></dt><dt>4.9. <a href="#ex-list-route-local">local route types</a></dt><dt>4.10. <a href="#ex-list-route-nat">nat route types</a></dt><dt>4.11. <a href="#ex-list-route-unreachable">unreachable route types</a></dt><dt>4.12. <a href="#ex-list-route-prohibit">prohibit route types</a></dt><dt>4.13. <a href="#ex-list-route-blackhole">blackhole route types</a></dt><dt>4.14. <a href="#ex-list-route-throw">throw route types</a></dt><dt>4.15. <a href="#ex-routing-table-local-maint">Kernel maintenance of the <code class="constant">local</code> routing table</a></dt><dt>4.16. <a href="#ex-list-rule-unicast">unicast rule type</a></dt><dt>4.17. <a href="#ex-list-rule-nat">nat rule type</a></dt><dt>4.18. <a href="#ex-list-rule-unreachable">unreachable rule type</a></dt><dt>4.19. <a href="#ex-list-rule-prohibit">prohibit rule type</a></dt><dt>4.20. <a href="#ex-list-rule-blackhole">blackhole rule type</a></dt><dt>4.21. <a href="#ex-routing-icmp-redirect">ICMP Redirect on the Wire
          
        </a></dt><dt>5.1. <a href="#ex-nat-basic">
          Stateless NAT Packet Capture
          
        </a></dt><dt>5.2. <a href="#ex-nat-basic-commands">Basic commands to create a stateless NAT</a></dt><dt>5.3. <a href="#ex-nat-stateless-rpdb">Conditional Stateless NAT (not performing NAT for a
            specified destination network)</a></dt><dt>5.4. <a href="#ex-nat-pf-ipchains">Using an <span class="command">ipchains</span> packet filter with
        stateless NAT</a></dt><dt>5.5. <a href="#ex-nat-dnat-all">Using DNAT for all protocols (and ports) on one IP</a></dt><dt>5.6. <a href="#ex-nat-dnat-port">Using DNAT for a single port</a></dt><dt>5.7. <a href="#ex-nat-dnat-full">Simulating full NAT with SNAT and DNAT</a></dt><dt>7.1. <a href="#ex-pf-iptables-reject">Blocking a destination and using the <code class="option">REJECT</code>
        target, cf. Example D.17, &#8220;Adding a <code class="option">prohibit</code> route with <span class="command">route
            add</span>&#8221;</a></dt><dt>10.1. <a href="#ex-adv-multi-internet-outbound-ip-routing">Multiple Outbound Internet links, part I;
          <span class="command">ip route</span></a></dt><dt>10.2. <a href="#ex-adv-multi-internet-outbound-iptables">Multiple Outbound Internet links, part II;
          <span class="command">iptables</span></a></dt><dt>10.3. <a href="#ex-adv-multi-internet-outbound-ip-rule">Multiple Outbound Internet links, part III;
          <span class="command">ip rule</span></a></dt><dt>10.4. <a href="#ex-adv-multi-internet-inbound">Multiple Internet links, inbound traffic; using
          <span class="command">iproute2</span> only
          
        </a></dt><dt>11.1. <a href="#ex-sc-proxy-arp">Proxy ARP SysV initialization script</a></dt><dt>11.2. <a href="#ex-sc-proxy-arp-conf">Proxy ARP configuration file</a></dt><dt>11.3. <a href="#ex-sc-nat">Static NAT SysV initialization script</a></dt><dt>11.4. <a href="#ex-sc-static-nat">Static NAT configuration file</a></dt><dt>B.1. <a href="#tools-arp-listing">Displaying the arp table with <span class="command">arp</span></a></dt><dt>B.2. <a href="#tools-arp-add">Adding arp table entries with <span class="command">arp</span></a></dt><dt>B.3. <a href="#tools-arp-delete">Deleting arp table entries with <span class="command">arp</span></a></dt><dt>B.4. <a href="#ex-tools-arping-listing">Displaying reachability of an IP on the local Ethernet with <span class="command">arping</span></a></dt><dt>B.5. <a href="#ex-tools-arping-dad">Duplicate Address Detection with <span class="command">arping</span></a></dt><dt>B.6. <a href="#ex-tools-ip-link-show">Using <span class="command">ip link show</span></a></dt><dt>B.7. <a href="#ex-tools-ip-link-set">Using <span class="command">ip link set</span> to change device flags</a></dt><dt>B.8. <a href="#ex-tools-ip-link-set-down">Deactivating a link layer device with <span class="command">ip link
            set</span></a></dt><dt>B.9. <a href="#ex-tools-ip-link-set-up">Activating a link layer device with <span class="command">ip link
            set</span></a></dt><dt>B.10. <a href="#ex-tools-ip-link-set-mtu">Using <span class="command">ip link set</span> to change device flags</a></dt><dt>B.11. <a href="#ex-tools-ip-link-set-name">Changing the device name with <span class="command">ip link set</span></a></dt><dt>B.12. <a href="#ex-tools-ip-link-set-address">Changing broadcast and hardware addresses with <span class="command">ip link set</span></a></dt><dt>B.13. <a href="#ex-tools-ip-neighbor-show">Displaying the ARP cache with <span class="command">ip neighbor
          show</span></a></dt><dt>B.14. <a href="#ex-tools-ip-neighbor-show-interface">Displaying the ARP cache on an interface with <span class="command">ip
          neighbor show</span></a></dt><dt>B.15. <a href="#ex-tools-ip-neighbor-show-network">Displaying the ARP cache for a particular network with
          <span class="command">ip neighbor show</span></a></dt><dt>B.16. <a href="#ex-tools-ip-neighbor-add">Entering a permanent entry into the ARP cache with <span class="command">ip
          neighbor add</span></a></dt><dt>B.17. <a href="#ex-tools-ip-neighbor-add-proxy">Entering a proxy ARP entry with <span class="command">ip
          neighbor add proxy</span></a></dt><dt>B.18. <a href="#ex-tools-ip-neighbor-change">Altering an entry in the ARP cache with <span class="command">ip neighbor
          change</span></a></dt><dt>B.19. <a href="#ex-tools-ip-neighbor-del">Removing an entry from the ARP cache with <span class="command">ip
          neighbor del</span></a></dt><dt>B.20. <a href="#ex-tools-ip-neighbor-flush">Removing learned entries from the ARP cache with <span class="command">ip
          neighbor flush</span></a></dt><dt>B.21. <a href="#tools-mii-tool-list">Detecting link layer status with <span class="command">mii-tool</span></a></dt><dt>B.22. <a href="#tools-mii-tool-advertise">Specifying Ethernet port speeds with <span class="command">mii-tool --advertise</span></a></dt><dt>B.23. <a href="#tools-mii-tool-force">Forcing Ethernet port speed with <span class="command">mii-tool --force</span></a></dt><dt>C.1. <a href="#ex-tools-ifconfig-display">Viewing interface information with <span class="command">ifconfig</span></a></dt><dt>C.2. <a href="#ex-tools-ifconfig-down">Bringing down an interface with <span class="command">ifconfig</span></a></dt><dt>C.3. <a href="#ex-tools-ifconfig-up">Bringing up an interface with <span class="command">ifconfig</span></a></dt><dt>C.4. <a href="#ex-tools-ifconfig-mtu">Changing MTU with <span class="command">ifconfig</span></a></dt><dt>C.5. <a href="#ex-tools-ifconfig-flags">Setting interface flags with <span class="command">ifconfig</span></a></dt><dt>C.6. <a href="#ex-tools-ip-address-display">Displaying IP information with <span class="command">ip address</span></a></dt><dt>C.7. <a href="#ex-tools-ip-address-add">Adding IP addresses to an interface with <span class="command">ip address</span></a></dt><dt>C.8. <a href="#ex-tools-ip-address-del">Removing IP addresses from interfaces with <span class="command">ip address</span></a></dt><dt>C.9. <a href="#ex-tools-ip-address-flush">Removing all IPs on an interface with <span class="command">ip address flush</span></a></dt><dt>D.1. <a href="#ex-tools-route-show-simple">Viewing a simple routing table with <span class="command">route</span></a></dt><dt>D.2. <a href="#ex-tools-route-show-complex">Viewing a complex routing table with <span class="command">route</span></a></dt><dt>D.3. <a href="#ex-tools-route-show-cache">Viewing the routing cache with <span class="command">route</span></a></dt><dt>D.4. <a href="#ex-tools-route-add-net">Adding a static route to a network <span class="command">route add</span></a></dt><dt>D.5. <a href="#ex-tools-route-add-host">Adding a static route to a host with <span class="command">route add</span></a></dt><dt>D.6. <a href="#ex-tools-route-add-host-dev">Adding a static route to a host on the same media with <span class="command">route add</span></a></dt><dt>D.7. <a href="#ex-tools-route-add-default">Setting the default route with <span class="command">route</span></a></dt><dt>D.8. <a href="#ex-tools-route-add-default-alt">An alternate method of setting the default route with <span class="command">route</span></a></dt><dt>D.9. <a href="#ex-tools-route-del-host-dev">Removing a static host route with <span class="command">route del</span></a></dt><dt>D.10. <a href="#ex-tools-route-del-default">Removing the default route with <span class="command">route del</span></a></dt><dt>D.11. <a href="#ex-tools-ip-route-show-main">Viewing the main routing table with <span class="command">ip route
            show</span></a></dt><dt>D.12. <a href="#ex-tools-ip-route-show-local">Viewing the local routing table with <span class="command">ip route show
            table local</span></a></dt><dt>D.13. <a href="#ex-tools-ip-route-show-table">Viewing a routing table with <span class="command">ip route
            show table</span></a></dt><dt>D.14. <a href="#ex-tools-ip-route-show-cache">Displaying the routing cache with <span class="command">ip route
            show cache</span></a></dt><dt>D.15. <a href="#ex-tools-ip-route-show-cache-stats">Displaying statistics from the routing cache with
            <span class="command">ip -s route show cache</span></a></dt><dt>D.16. <a href="#ex-tools-ip-route-add-net">Adding a static route to a network with <span class="command">route
            add</span>, cf. Example D.4, &#8220;Adding a static route to a network <span class="command">route add</span>&#8221;</a></dt><dt>D.17. <a href="#ex-tools-ip-route-add-prohibit">Adding a <code class="option">prohibit</code> route with <span class="command">route
            add</span></a></dt><dt>D.18. <a href="#ex-tools-ip-route-add-from">Using <code class="option">from</code> in a routing command with
            <span class="command">route add</span></a></dt><dt>D.19. <a href="#ex-tools-ip-route-add-src">Using <code class="option">src</code> in a routing command with
            <span class="command">route add</span></a></dt><dt>D.20. <a href="#ex-tools-ip-route-add-default">Setting the default route with <span class="command">ip route add default</span></a></dt><dt>D.21. <a href="#ex-tools-ip-route-nat-simple">Creating a NAT route for a single IP with <span class="command">ip route add
            nat</span></a></dt><dt>D.22. <a href="#ex-tools-ip-route-nat-network">Creating a NAT route for an entire network with <span class="command">ip
            route add nat</span></a></dt><dt>D.23. <a href="#ex-tools-ip-route-del">Removing routes with <span class="command">ip route del</span>
          
          </a></dt><dt>D.24. <a href="#ex-tools-ip-route-change">Altering existing routes with <span class="command">ip route
            change</span></a></dt><dt>D.25. <a href="#ex-tools-ip-route-get">Testing routing tables with <span class="command">ip route
            get</span></a></dt><dt>D.26. <a href="#ex-tools-ip-route-flush">Removing a specific route and emptying a routing table with
            <span class="command">ip route flush</span></a></dt><dt>D.27. <a href="#ex-tools-ip-route-flush-cache">Emptying the routing cache with <span class="command">ip route flush
            cache</span></a></dt><dt>D.28. <a href="#ex-tools-ip-rule-show">Displaying the RPDB with <span class="command">ip rule
            show</span></a></dt><dt>D.29. <a href="#ex-tools-ip-rule-add-simple">Creating a simple entry in the RPDB with <span class="command">ip rule
            add</span>
            
          </a></dt><dt>D.30. <a href="#ex-tools-ip-rule-add-complex">Creating a complex entry in the RPDB with <span class="command">ip rule
            add</span></a></dt><dt>D.31. <a href="#ex-tools-ip-rule-add-nat-simple">Creating a NAT rule with <span class="command">ip rule add
            nat</span></a></dt><dt>D.32. <a href="#ex-tools-ip-rule-add-nat-network">Creating a NAT rule for an entire network with <span class="command">ip
            rule add nat</span></a></dt><dt>D.33. <a href="#ex-tools-ip-rule-del-nat-network">Removing a NAT rule for an entire network with <span class="command">ip
            rule del nat</span></a></dt><dt>F.1. <a href="#ex-tools-nc-basic">Simple use of <span class="command">nc</span></a></dt><dt>F.2. <a href="#ex-tools-nc-timeout">Specifying timeout with <span class="command">nc</span></a></dt><dt>F.3. <a href="#ex-tools-nc-source">Specifying source address with <span class="command">nc</span></a></dt><dt>F.4. <a href="#ex-tools-nc-server">Using <span class="command">nc</span> as a server</a></dt><dt>F.5. <a href="#ex-tools-nc-delay">Delaying a stream with <span class="command">nc</span></a></dt><dt>F.6. <a href="#ex-tools-nc-udp">Using <span class="command">nc</span> with UDP</a></dt><dt>F.7. <a href="#ex-tools-socat-basic">Simple use of <span class="command">socat</span></a></dt><dt>F.8. <a href="#ex-tools-socat-proxy">Using <span class="command">socat</span> with proxy connect</a></dt><dt>F.9. <a href="#ex-tools-socat-openssl">Using <span class="command">socat</span> perform SSL</a></dt><dt>F.10. <a href="#ex-tools-socat-file-descriptor">Connecting one end of <span class="command">socat</span> to a file
          descriptor</a></dt><dt>F.11. <a href="#ex-tools-socat-serial">Connecting <span class="command">socat</span> to a serial line</a></dt><dt>F.12. <a href="#ex-tools-socat-pty">Using a PTY with <span class="command">socat</span></a></dt><dt>F.13. <a href="#ex-tools-socat-exec">Executing a command with <span class="command">socat</span></a></dt><dt>F.14. <a href="#ex-tools-socat-socat">Connecting one <span class="command">socat</span> to another one</a></dt><dt>F.15. <a href="#ex-tools-tcpclient-basic">Simple use of <span class="command">tcpclient</span></a></dt><dt>F.16. <a href="#ex-tools-tcpclient-localport">Specifying the local port which <span class="command">tcpclient</span>
          should request</a></dt><dt>F.17. <a href="#ex-tools-tcpclient-localip">Specifying the local IP to which <span class="command">tcpclient</span>
          should bind</a></dt><dt>F.18. <a href="#ex-tools-xinetd-redir">IP redirection with <span class="command">xinetd</span></a></dt><dt>F.19. <a href="#ex-tools-xinetd-server">Publishing a service with <span class="command">xinetd</span></a></dt><dt>F.20. <a href="#ex-tools-tcpserver-basic">Simple use of <span class="command">tcpserver</span></a></dt><dt>F.21. <a href="#ex-tools-tcpserver-cdb">Specifying a CDB for <span class="command">tcpserver</span></a></dt><dt>F.22. <a href="#ex-tools-tcpserver-concurrency">Limiting the number of concurrently accept TCP sessions
          under <span class="command">tcpserver</span></a></dt><dt>F.23. <a href="#ex-tools-tcpserver-uid">Specifying a UID for <span class="command">tcpserver</span>'s
          spawned processes</a></dt><dt>F.24. <a href="#ex-tools-redir-basic">Redirecting a TCP port with <span class="command">redir</span></a></dt><dt>F.25. <a href="#ex-tools-redir-transproxy">Running <span class="command">redir</span> in transparent mode</a></dt><dt>F.26. <a href="#ex-tools-redir-inetd">Running <span class="command">redir</span> from another TCP server</a></dt><dt>F.27. <a href="#ex-tools-redir-bindaddr">Specifying a source address for <span class="command">redir</span>'s client
          side</a></dt><dt>G.1. <a href="#ex-tools-ping-simple">Using <span class="command">ping</span> to test reachability</a></dt><dt>G.2. <a href="#ex-tools-ping-simple-count">Using <span class="command">ping</span> to specify number of packets to
            send</a></dt><dt>G.3. <a href="#ex-tools-ping-simple-quiet">Using <span class="command">ping</span> to specify number of packets to
            send</a></dt><dt>G.4. <a href="#ex-tools-ping-stress">Using <span class="command">ping</span> to stress a network</a></dt><dt>G.5. <a href="#ex-tools-ping-stress-size">Using <span class="command">ping</span> to stress a network with large
            packets</a></dt><dt>G.6. <a href="#ex-tools-ping-record-route">Recording a network route with <span class="command">ping</span></a></dt><dt>G.7. <a href="#ex-tools-ping-ttl">Setting the TTL on a <span class="command">ping</span> packet</a></dt><dt>G.8. <a href="#ex-tools-ping-tos">Setting ToS for a diagnostic <span class="command">ping</span></a></dt><dt>G.9. <a href="#ex-tools-ping-specify-source">Specifying a source address for <span class="command">ping</span></a></dt><dt>G.10. <a href="#ex-tools-traceroute-basic">Simple usage of <span class="command">traceroute</span></a></dt><dt>G.11. <a href="#ex-tools-netstat-inet">Displaying IP socket status with
            <span class="command">netstat</span></a></dt><dt>G.12. <a href="#ex-tools-netstat-inet-details">Displaying IP socket status details with
            <span class="command">netstat</span></a></dt><dt>G.13. <a href="#ex-tools-netstat-route">Displaying the main routing table with
            <span class="command">netstat</span></a></dt><dt>G.14. <a href="#ex-tools-netstat-route-cache">Displaying the routing cache with
            <span class="command">netstat</span></a></dt><dt>G.15. <a href="#ex-tools-netstat-masquerade">Displaying the masquerading table with <span class="command">netstat</span></a></dt><dt>G.16. <a href="#ex-tools-tcpdump-arp-broadcast">Viewing an ARP broadcast request and reply with 
            <span class="command">tcpdump</span></a></dt><dt>G.17. <a href="#ex-tools-tcpdump-arp-gratuitous">Viewing a gratuitous ARP packet with 
            <span class="command">tcpdump</span></a></dt><dt>G.18. <a href="#ex-tools-tcpdump-arp-unicast">Viewing unicast ARP packets with 
            <span class="command">tcpdump</span></a></dt><dt>G.19. <a href="#ex-tools-tcpdump-unreach-port"><span class="command">tcpdump</span> reporting port unreachable</a></dt><dt>G.20. <a href="#ex-tools-tcpdump-unreach-host"><span class="command">tcpdump</span> reporting host unreachable</a></dt><dt>G.21. <a href="#ex-tools-tcpdump-unreach-net"><span class="command">tcpdump</span> reporting net unreachable</a></dt><dt>G.22. <a href="#ex-tools-tcpdump-tcp-windows">Monitoring TCP window sizes with
            <span class="command">tcpdump</span></a></dt><dt>G.23. <a href="#ex-tools-tcpdump-tcp-flags">Examining TCP flags with <span class="command">tcpdump</span></a></dt><dt>G.24. <a href="#ex-tools-tcpdump-tcp-ack">Examining TCP acknowledgement numbers with
            <span class="command">tcpdump</span></a></dt><dt>G.25. <a href="#ex-tools-tcpdump-file-write">Writing <span class="command">tcpdump</span> data to a file</a></dt><dt>G.26. <a href="#ex-tools-tcpdump-file-read">Reading <span class="command">tcpdump</span> data from a file</a></dt><dt>G.27. <a href="#ex-tools-tcpdump-file-line-buffer">Causing <span class="command">tcpdump</span> to use a line buffer</a></dt><dt>G.28. <a href="#ex-tools-tcpdump-frag">Understanding fragmentation as reported by
            <span class="command">tcpdump</span></a></dt><dt>G.29. <a href="#ex-tools-tcpdump-interface">Specifying interface with <span class="command">tcpdump</span></a></dt><dt>G.30. <a href="#ex-tools-tcpdump-timestamp">Timestamp related options to <span class="command">tcpdump</span></a></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="intro"></a>Introduction</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#intro-assumptions">1. Target Audience, Assumptions, and Recommendations</a></span></dt><dt><span class="section"><a href="#intro-conventions">2. Conventions</a></span></dt><dt><span class="section"><a href="#intro-bugs">3. Bugs and Roadmap</a></span></dt><dt><span class="section"><a href="#intro-note">4. Technical Note and Summary of Approach</a></span></dt><dt><span class="section"><a href="#intro-closing">5. Acknowledgements and Request for Remarks</a></span></dt></dl></div><p>
    This guide is as an overview of the IP networking capabilities of linux
    kernels 2.2 and 2.4.  The target audience is any beginning
    to advanced network administrator who wants practical examples
    and explanation of rumoured features of linux.
    As the Internet is lousy with documentation on the nooks and crannies of
    linux networking support, I have tried
    to provide links to existing documentation on IP networking with linux.
  </p><p>
    The documentation you'll find here covers kernels
    2.2 and 2.4, although a good number of the examples and concepts may also
    apply to older kernels.  In the event that I cover a feature that is
    only present or supported under a particular kernel, I'll identify which
    kernel supports that feature.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-assumptions"></a>1. Target Audience, Assumptions, and Recommendations</h2></div></div></div><p>
      I assume a few things about the reader.  First, the reader has a basic
      understanding (at least) of IP addressing and networking.
      If this is not the case, or the reader has some trouble following my
      networking examples, I have provided a section of
      <a class="link" href="#links-general-ip" title="1.3. General IP Networking Resources">links to IP layer tutorials and
      general introductory documentation</a> in the appendix.
      Second, I assume the reader is comfortable with command line tools
      and the Linux, Unix, or BSD environments.  Finally, I assume the
      reader has working
      network cards and a Linux OS.  For assistance with Ethernet cards, the
      there exists a good
      <a class="ulink" href="http://www.tldp.org/HOWTO/Ethernet-HOWTO.html" target="_top">Ethernet
      HOWTO</a>.
    </p><p>
      The examples I give are intended as tutorial examples only.  The user
      should understand and accept the ramifications of using these examples
      on his/her own machines.  I recommend that before running any example on a
      production machine, the user test in a controlled environment.
      I accept no responsibility for damage, misconfiguration or
      loss of any kind as a result of referring to this documentation.
      Proceed with caution at your own risk.
    </p><p>
      This guide has been written primarily as a companion reference to IP
      networking on Ethernets.  Although I do allude to other link layer types
      occasionally in this book, the focus has been IP as used in Ethernet.
      Ethernet is one of the most common networking devices supported under
      linux, and is practically ubiquitous.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-conventions"></a>2. Conventions</h2></div></div></div><p>
      This text was written in
      <a class="ulink" href="http://www.docbook.org/" target="_top">DocBook</a> with
      <a class="ulink" href="http://vim.sourceforge.net/" target="_top"><span class="command"><strong>vim</strong></span></a>.
      All formatting has been applied by
      <a class="ulink" href="http://xmlsoft.org/XSLT/" target="_top">xsltproc</a> based on
      <a class="ulink" href="http://docbook.sourceforge.net/projects/xsl/" target="_top">DocBook</a>
      and
      <a class="ulink" href="http://www.tldp.org/LDP/LDP-Author-Guide/usingldpxsl.html" target="_top">LDP XSL
      stylesheets</a>.
      Typeface formatting and display
      conventions are similar to most printed and electronically distributed
      technical documentation.  A brief summary of these conventions
      follows below.
    </p><p>
     The interactive shell prompt will look like
    </p><p>
     <code class="prompt">[root@hostname]# </code>
    </p><p>
     for the root user and
    </p><p>
     <code class="prompt">[user@hostname]$ </code>
    </p><p>
     for non-root users, although most of
     the operations we will be discussing will require root privileges.
    </p><p>
     Any commands to be entered by the user will always appear like
    </p><p>
     <strong class="userinput"><code>{ echo "Hi, I am exiting with a non-zero exit code."; exit 1 }</code></strong>
    </p><p>
      Output by any program will look something like this:
    </p><p>
      <code class="computeroutput">Hi, I am exiting with a non-zero exit code.</code>
    </p><p>
      Where possible, an additional convention I have used is the suppression
      of all hostname lookup.  DNS and other naming based schemes often
      confuse the novice and expert alike, particularly when the name resolver
      is slow or unreachable.  Since the focus of this guide is IP layer
      networking, DNS names will be used only where absolutely unambiguous.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-bugs"></a>3. Bugs and Roadmap</h2></div></div></div><p>
      Perhaps this should be called things that are wrong with this document,
      or things which should be improved.  See the
      <code class="filename">src/ROADMAP</code> for notes on what is likely to be
      forthcoming in subsequent releases.
    </p><p>
      The internal document linking, while good, but could be better.
      Especially lame is the lack of an index.  External links should
      be used more commonly where appropriate instead of sending users
      to the links page.
    </p><p>
      If you are looking for LARTC topics, you may find some LAR topics
      here, but you should try the <a class="ulink" href="http://lartc.org/" target="_top">LARTC
      page</a> itself if you have questions that are more TC than LAR.
      Consult <a class="xref" href="#ax-links" title="Appendix I. Links to other Resources">Appendix I, <i>Links to other Resources</i></a> for further references to available
      documentation.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-note"></a>4. Technical Note and Summary of Approach</h2></div></div></div><p>
      There are many tools available under linux which are also available under
      other unix-like operating systems, but there are additional tools and
      specific tools which are available only to users of linux.  This guide
      represents an effort to identify some of these tools.  The most concrete
      example of the difference between linux only tools and generally available
      unix-like tools is the difference between the traditional
      <span class="command"><strong>ifconfig</strong></span> and <span class="command"><strong>route</strong></span> commands,
      available under most variants of unix, and the <span class="command"><strong>iproute2</strong></span>
      command suite, written specificially for linux.
    </p><p>
      Because this guide concerns itself with the features, strengths, and
      peculiarities of IP networking with linux, the <span class="command"><strong>iproute2</strong></span>
      command suite assumes a prominent role.  The <span class="command"><strong>iproute2</strong></span>
      tools expose the strength, flexibility and potential of the linux
      networking stack.
    </p><p>
      Many of the tools introduced and concepts introduced are also detailed
      in other HOWTOs and guides available at
      <a class="ulink" href="http://www.tldp.org/" target="_top">The Linux Documentation
      Project</a> in addition to many other places on the Internet and in
      <a class="link" href="#biblio" title="Reference Bibliography and Recommended Reading">printed books</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-closing"></a>5. Acknowledgements and Request for Remarks</h2></div></div></div><p>
      As with many human endeavours, this work is made possible by the efforts
      of others.  For me, this effort represents
      almost four years of learning and network administration.  The knowledge
      collected here is in large measure a repackaging of disparate
      resources and my own experiences over time.  Without the greater
      linux community, I would not be able to provide this resource.
    </p><p>
      I would like to take this opportunity to make a plug for my employer,
      <a class="ulink" href="http://www.securepipe.com/" target="_top">SecurePipe, Inc.</a> which has
      provided me stable and challenging employment for these (almost) four
      years.  SecurePipe is a managed security services provider specializing
      in managed firewall, VPN, and IDS services to small and medium sized
      companies.  They offer me the opportunity to hone my networking skills
      and explore areas of linux networking unknown to me.  Thanks also to
      SecurePipe, Inc. for hosting this cost-free on their servers.
    </p><p>
      Over the course of the project, many people have contributed suggestions,
      modifications, corrections and additions.  I'll acknowledge them briefly
      here.  For full acknowledgements, see
      <code class="filename">src/ACKNOWLEDGEMENTS</code> in the DocBook source tree.
    </p><a name="intro-acknowledgements"></a><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Russ Herrold, <span class="emphasis"><em>2002-09-22</em></span>
        </p></li><li class="listitem"><p>
          Yann Hirou, <span class="emphasis"><em>2002-09-26</em></span>
        </p></li><li class="listitem"><p>
          Julian Anastasov, <span class="emphasis"><em>2002-10-29</em></span>
        </p></li><li class="listitem"><p>
          Bert Hubert, <span class="emphasis"><em>2002-11-14</em></span>
        </p></li><li class="listitem"><p>
          Tony Kapela, <span class="emphasis"><em>2002-11-30</em></span>
        </p></li><li class="listitem"><p>
          George Georgalis, <span class="emphasis"><em>2003-01-11</em></span>
        </p></li><li class="listitem"><p>
          Alex Russell, <span class="emphasis"><em>2003-02-02</em></span>
        </p></li><li class="listitem"><p>
          giovanni, <span class="emphasis"><em>2003-02-06</em></span>
        </p></li><li class="listitem"><p>
          Gilles Douillet, <span class="emphasis"><em>2003-02-28</em></span>
        </p></li></ul></div><p>
      Please feel free to point out any irregularities, factual errors,
      typographical errors, or logical gaps in this
      documentation.  If you have rants or raves about this documentation,
      please mail me directly at <code class="email">&lt;<a class="email" href="mailto:mabrown@securepipe.com">mabrown@securepipe.com</a>&gt;</code>.
    </p><p>
      Now, let's begin!  Let me welcome you to the
      pleasure and reliability of IP networking with linux.
    </p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="part-concepts"></a>Part I. Concepts</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="chapter"><a href="#ch-basic">1. Basic IP Connectivity</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-control-files">1. IP Networking Control Files</a></span></dt><dt><span class="section"><a href="#basic-reading">2. Reading Routes and IP Information</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-local-network">2.1. Sending Packets to the Local Network</a></span></dt><dt><span class="section"><a href="#basic-default-gateway">2.2. Sending Packets to Unknown Networks Through the Default
        Gateway</a></span></dt><dt><span class="section"><a href="#basic-static">2.3. Static Routes to Networks</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-changing">3. Changing IP Addresses and Routes</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-changing-ip">3.1. Changing the IP on a machine</a></span></dt><dt><span class="section"><a href="#basic-changing-default">3.2. Setting the Default Route</a></span></dt><dt><span class="section"><a href="#basic-changing-static">3.3. Adding and removing a static route</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-conclusion">4. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-ether">2. Ethernet</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-arp">1. Address Resolution Protocol (ARP)</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-arp-overview">1.1. Overview of Address Resolution Protocol</a></span></dt><dt><span class="section"><a href="#ether-arp-cache">1.2. The ARP cache</a></span></dt><dt><span class="section"><a href="#ether-arp-suppression">1.3. ARP Suppression</a></span></dt><dt><span class="section"><a href="#ether-arp-flux">1.4. The ARP Flux Problem</a></span></dt></dl></dd><dt><span class="section"><a href="#ether-arp-proxy">2. Proxy ARP</a></span></dt><dt><span class="section"><a href="#ether-arp-filtering">3. ARP filtering</a></span></dt><dt><span class="section"><a href="#ether-vlan">4. Connecting to an Ethernet 802.1q VLAN</a></span></dt><dt><span class="section"><a href="#ether-bonding">5. Link Aggregation and High Availability with Bonding</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-bonding-aggregation">5.1. Link Aggregation</a></span></dt><dt><span class="section"><a href="#ether-bonding-ha">5.2. High Availability</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ch-bridging">3. Bridging</a></span></dt><dd><dl><dt><span class="section"><a href="#bridging-intro">1. Concepts of Bridging</a></span></dt><dt><span class="section"><a href="#bridging-stp">2. Bridging and Spanning Tree Protocol</a></span></dt><dt><span class="section"><a href="#bridging-packet-filter">3. Bridging and Packet Filtering</a></span></dt><dt><span class="section"><a href="#bridging-tc">4. Traffic Control with a Bridge</a></span></dt><dt><span class="section"><a href="#bridging-ebtables">5. <span class="command"><strong>ebtables</strong></span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-routing">4. IP Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-intro">1. Introduction to Linux Routing</a></span></dt><dt><span class="section"><a href="#routing-local">2. Routing to Locally Connected Networks</a></span></dt><dt><span class="section"><a href="#routing-default">3. Sending Packets Through a Gateway</a></span></dt><dt><span class="section"><a href="#routing-forwarding">4. Operating as a Router</a></span></dt><dt><span class="section"><a href="#routing-selection">5. Route Selection</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-selection-common">5.1. The Common Case</a></span></dt><dt><span class="section"><a href="#routing-selection-adv">5.2. The Whole Story</a></span></dt><dt><span class="section"><a href="#routing-selection-summary">5.3. Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-saddr-selection">6. Source Address Selection</a></span></dt><dt><span class="section"><a href="#routing-cache">7. Routing Cache</a></span></dt><dt><span class="section"><a href="#routing-tables">8. Routing Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-table-entries">8.1. Routing Table Entries (Routes)</a></span></dt><dt><span class="section"><a href="#routing-table-local">8.2. The Local Routing Table</a></span></dt><dt><span class="section"><a href="#routing-table-main">8.3. The Main Routing Table</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-rpdb">9. Routing Policy Database (RPDB)</a></span></dt><dt><span class="section"><a href="#routing-icmp">10. ICMP and Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-icmp-mtu">10.1. MTU, MSS, and ICMP</a></span></dt><dt><span class="section"><a href="#routing-icmp-redirect">10.2. ICMP Redirects and Routing</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ch-nat">5. Network Address Translation (NAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#nat-overview">1. Rationale for and Introduction to NAT</a></span></dt><dt><span class="section"><a href="#nat-break">2. Application Layer Protocols with Embedded Network Information</a></span></dt><dt><span class="section"><a href="#nat-stateless">3. Stateless NAT with <span class="command"><strong>iproute2</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#nat-stateless-simple">3.1. Stateless NAT Packet Capture and Introduction</a></span></dt><dt><span class="section"><a href="#nat-stateless-howto">3.2. Stateless NAT Practicum</a></span></dt><dt><span class="section"><a href="#nat-stateless-rpdb">3.3. Conditional Stateless NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-stateless-pf-interaction">4. Stateless NAT and Packet Filtering</a></span></dt><dt><span class="section"><a href="#nat-dnat">5. Destination NAT with netfilter (DNAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#nat-dnat-pat">5.1. Port Address Translation with DNAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-pat-userspace">6. Port Address Translation (PAT) from Userspace</a></span></dt><dt><span class="section"><a href="#nat-pat-userspace-transparent">7. Transparent PAT from Userspace</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-snat">6. Masquerading and Source Network Address Translation</a></span></dt><dd><dl><dt><span class="section"><a href="#snat-intro">1. Concepts of Source NAT</a></span></dt><dd><dl><dt><span class="section"><a href="#snat-masq-diff">1.1. Differences Between SNAT and Masquerading</a></span></dt><dt><span class="section"><a href="#snat-double">1.2. Double SNAT/Masquerading</a></span></dt></dl></dd><dt><span class="section"><a href="#snat-inbound">2. Issues with SNAT/Masquerading and Inbound Traffic</a></span></dt><dt><span class="section"><a href="#snat-break">3. Where Masquerading and SNAT Break</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-packetfilter">7. Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-intro">1. Rationale for and Introduction to Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-history">1.1. History of Linux Packet Filter Support</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-shortcomings">2. Limits and Weaknesses of Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-limits">2.1. Limits of the Usefulness of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness">2.2. Weaknesses of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness-stateless">2.3. Complex Network Layer Stateless Packet Filters</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-icmp">3. General Packet Filter Requirements</a></span></dt><dt><span class="section"><a href="#pf-netfilter">4. The Netfilter Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-netfilter-iptables">4.1. Packet Filtering with <span class="command"><strong>iptables</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-ipchains">5. Packet Filtering with <span class="command"><strong>ipchains</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#pf-ipchains-mangling">5.1. Packet Mangling with <span class="command"><strong>ipchains</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-host">6. Protecting a Host</a></span></dt><dt><span class="section"><a href="#pf-network">7. Protecting a Network</a></span></dt><dt><span class="section"><a href="#pf-further">8. Further Resources</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-state">8. Statefulness and Statelessness</a></span></dt><dd><dl><dt><span class="section"><a href="#state-intro">1. </a></span></dt><dt><span class="section"><a href="#state-routing">2. Statelessness of IP Routing</a></span></dt><dt><span class="section"><a href="#state-conntrack">3. Netfilter Connection Tracking</a></span></dt><dd><dl><dt><span class="section"><a href="#state-conntrack-filter">3.1. </a></span></dt><dt><span class="section"><a href="#state-conntrack-nat">3.2. </a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-basic"></a>Chapter 1. Basic IP Connectivity</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#basic-control-files">1. IP Networking Control Files</a></span></dt><dt><span class="section"><a href="#basic-reading">2. Reading Routes and IP Information</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-local-network">2.1. Sending Packets to the Local Network</a></span></dt><dt><span class="section"><a href="#basic-default-gateway">2.2. Sending Packets to Unknown Networks Through the Default
        Gateway</a></span></dt><dt><span class="section"><a href="#basic-static">2.3. Static Routes to Networks</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-changing">3. Changing IP Addresses and Routes</a></span></dt><dd><dl><dt><span class="section"><a href="#basic-changing-ip">3.1. Changing the IP on a machine</a></span></dt><dt><span class="section"><a href="#basic-changing-default">3.2. Setting the Default Route</a></span></dt><dt><span class="section"><a href="#basic-changing-static">3.3. Adding and removing a static route</a></span></dt></dl></dd><dt><span class="section"><a href="#basic-conclusion">4. Conclusion</a></span></dt></dl></div><p>
    Internet Protocol (<acronym class="acronym">IP</acronym>) networking is now among the
    most common networking technologies in use today.  The IP stack
    under linux is mature, robust and reliable.  This chapter covers
    the basics of configuring a linux machine or multiple linux machines
    to join an IP network.
  </p><p>
    This chapter covers a quick overview of the
    <a class="link" href="#basic-control-files" title="1. IP Networking Control Files">locations of the
    networking control files</a> on different distributions of linux.
    The remainder of the chapter is devoted to outlining the basics of
    IP networking with linux.
  </p><p>
    These basics are written in a more tutorial style than the remainder of
    the first part of the book.  Reading and understanding
    <a class="link" href="#basic-reading" title="2. Reading Routes and IP Information">IP addressing and routing information</a>
    is a key skill to master when beginning with linux.  Naturally, the next
    step is to
    <a class="link" href="#basic-changing" title="3. Changing IP Addresses and Routes">alter the IP configuration</a> of a
    machine.  This chapter will introduce these two key skills in a tutorial
    style.  Subsequent chapters will engage specific subtopics of linux
    networking in a more thorough and less tutorial manner.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-control-files"></a>1. IP Networking Control Files</h2></div></div></div><p>
      Different linux distribution vendors put their networking configuration
      files in different places in the filesystem.  Here is a brief summary
      of the locations of the IP networking configuration information under
      a few common linux distributions along with links to further
      documentation.
    </p><div class="itemizedlist"><a name="basic-conf-files"></a><p class="title"><b>Location of networking configuration files</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          RedHat (and Mandrake)
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface definitions
              <a class="ulink" href="http://www.redhat.com/support/resources/howto/sysconfig.html" target="_top"><code class="filename">/etc/sysconfig/network-scripts/ifcfg-*</code></a>
            </p></li><li class="listitem"><p>
              Hostname and default gateway definition
              <a class="ulink" href="http://www.redhat.com/support/resources/howto/sysconfig.html" target="_top"><code class="filename">/etc/sysconfig/network</code></a>
            </p></li><li class="listitem"><p>
              Definition of static routes
              <a class="ulink" href="http://www.redhat.com/support/resources/howto/sysconfig.html" target="_top"><code class="filename">/etc/sysconfig/static-routes</code></a>
            </p></li></ul></div></li><li class="listitem"><p>
          SuSe (version &gt;= 8.0)
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface definitions
              <a class="ulink" href="http://sdb.suse.de/en/sdb/html/mmj_network80.html" target="_top"><code class="filename">/etc/sysconfig/network/ifcfg-*</code></a>
            </p></li><li class="listitem"><p>
              Static route definition
              <a class="ulink" href="http://sdb.suse.de/en/sdb/html/mmj_network80.html" target="_top"><code class="filename">/etc/sysconfig/network/routes</code></a>
            </p></li><li class="listitem"><p>
               Interface specific static route definition
              <a class="ulink" href="http://sdb.suse.de/en/sdb/html/mmj_network80.html" target="_top"><code class="filename">/etc/sysconfig/network/ifroute-*</code></a>
            </p></li></ul></div></li><li class="listitem"><p>
          SuSe (version &lt;= 8.0)
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface and route definitions
              <code class="filename">/etc/rc.config</code>
            </p></li></ul></div></li><li class="listitem"><p>
          Debian
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface and route definitions
              <a class="ulink" href="http://documents.made-it.com/Debian_Internet_Server/Debian_Internet_Server-5.html" target="_top"><code class="filename">/etc/network/interfaces</code></a>
            </p></li></ul></div></li><li class="listitem"><p>
          Gentoo
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface and route definitions
              <a class="ulink" href="http://www.gentoo.org/doc/en/rc-scripts.xml" target="_top"><code class="filename">/etc/conf.d/net</code></a>
            </p></li></ul></div></li><li class="listitem"><p>
          Slackware
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
              Interface and route definitions
              <a class="ulink" href="http://www.slackware.com/config/network.php" target="_top"><code class="filename">/etc/rc.d/rc.inet1</code></a>
            </p></li></ul></div></li></ul></div><p>
      The format of the networking configuration
      files differs significantly from distribution to distribution, yet 
      the tools used by these scripts are the same.  This documentation will
      focus on these tools and how they instruct the kernel
      to alter interface and route information.
      Consult the distribution's documentation for questions of file format
      and order of operation.
    </p><p>
      For the remainder of this document, many examples refer to
      machines in a hypothetical network.  Refer to the
      <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network description</a>
      for the network map and addressing scheme.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-reading"></a>2. Reading Routes and IP Information</h2></div></div></div><p>
      Assuming an already configured machine named <code class="systemitem">tristan</code>, let's
      <a class="link" href="#basic-reading" title="2. Reading Routes and IP Information">look at the IP addressing and routing
      table</a>.  Next we'll examine how the machine
      communicates with computers (hosts) on the <a class="link" href="#basic-local-network" title="2.1. Sending Packets to the Local Network">locally reachable network</a>.  We'll
      then <a class="link" href="#basic-default-gateway" title="2.2. Sending Packets to Unknown Networks Through the Default Gateway">send packets through our
      default gateway to other networks</a>.  After learning what a default
      route is, we'll <a class="link" href="#ex-basic-static" title="Example 1.4. Sample routing table with a static route">look at a static
      route</a>.
    </p><p>
      One of the first things to learn about a machine attached to an IP
      network is its IP address.  We'll begin by looking at
      a machine named <code class="systemitem">tristan</code> on the main desktop network (192.168.99.0/24).
    </p><p>
      The machine <code class="systemitem">tristan</code>
      is alive on IP 192.168.99.35 and
      has been properly configured by the system administrator.
      By examining the
      <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a>
      and <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a>
      output we can learn a good deal about the network to which 
      <code class="systemitem">tristan</code> is connected
      <a href="#ftn.idm352" class="footnote" name="idm352"><sup class="footnote">[1]</sup></a>.
    </p><div class="example"><a name="ex-basic-ifconfig"></a><p class="title"><b>Example 1.1. Sample <span class="command">ifconfig</span> output</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51  
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:27849718 errors:1 dropped:0 overruns:0 frame:0
          TX packets:29968044 errors:5 dropped:0 overruns:2 carrier:3
          collisions:0 txqueuelen:100 
          RX bytes:943447653 (899.7 Mb)  TX bytes:2599122310 (2478.7 Mb)
          Interrupt:9 Base address:0x1000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:7028982 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7028982 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1206918001 (1151.0 Mb)  TX bytes:1206918001 (1151.0 Mb)
</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
      </pre></div></div><br class="example-break"><p>
      For the moment, ignore the loopback interface (lo) and concentrate
      on the Ethernet interface.  Examine the output of the
      <span class="command"><strong>ifconfig</strong></span> command.  We can learn a great deal about
      the IP network to which we are connected simply by reading the
      <span class="command"><strong>ifconfig</strong></span> output.  For a thorough discussion of
      <span class="command"><strong>ifconfig</strong></span>, see
      <a class="xref" href="#tools-ifconfig" title="1. ifconfig">Section 1, &#8220;<span class="command"><strong>ifconfig</strong></span>&#8221;</a>.
    </p><p>
      The IP address active on <code class="systemitem">tristan</code> is 192.168.99.35.  This means that
      any IP packets created by <code class="systemitem">tristan</code> will have a
      source address of 192.168.99.35.  Similarly any packet received by
      <code class="systemitem">tristan</code> will have the destination address of 192.168.99.35.
      When creating an outbound packet <code class="systemitem">tristan</code> will set the destination
      address to the server's IP.  This gives the remote host and the
      networking devices in between these hosts enough information to
      carry packets between the two devices.
    </p><p>
      Because <code class="systemitem">tristan</code> will
      advertise that it accepts packets with a destination address of
      192.168.99.35, any frames (packets) appearing on the Ethernet
      bound for 192.168.99.35 will reach <code class="systemitem">tristan</code>.  The process of
      communicating the ownership of an IP address is called ARP.  Read
      <a class="xref" href="#ether-arp-overview" title="1.1. Overview of Address Resolution Protocol">Section 1.1, &#8220;Overview of Address Resolution Protocol&#8221;</a> for a complete discussion of
      this process.
    </p><p>
      This is fundamental to IP networking.  It is fundamental that a host
      be able to generate and receive packets on an IP address assigned to it.
      This IP address is a unique identifier for the machine on the network to
      which it is connected.
    </p><p>
      Common traffic to and from machines today is unicast IP traffic.
      Unicast traffic is essentially a conversation between two hosts.
      Though there may be routers between them, the two hosts are carrying
      on a private conversation.  Examples of common unicast traffic
      are protocols such as HTTP (web), SMTP (sending mail), POP3 (fetching
      mail), IRC (chat), SSH (secure shell), and LDAP (directory access).
      To participate in any of these kinds of traffic, 
      <code class="systemitem">tristan</code> will send and receive packets on 192.168.99.35.
    </p><p>
      In contrast to unicast traffic, there is another common IP networking
      technique called broadcasting.  Broadcast traffic is a way of addressing
      all hosts in a given network range with a single destination IP address.
      To continue the analogy of the unicast conversation, a broadcast is more
      like shouting in a room.
      Occasionally, network administrators will refer to broadcast techniques
      and broadcasting as "chatty network traffic".
    </p><p>
      Broadcast techniques are used at the Ethernet layer and the IP layer, so
      the cautious person talks about Ethernet broadcasts or IP broadcast.
      Refer to
      <a class="xref" href="#ether-arp-overview" title="1.1. Overview of Address Resolution Protocol">Section 1.1, &#8220;Overview of Address Resolution Protocol&#8221;</a>, for more information on a common
      use of broadcast Ethernet frames.
    </p><p>
      IP Broadcast techniques can be used to share information with all
      partners on a network or to discover characteristics of other members of
      a network.
      SMB (Server Message Block) as implemented by Microsoft products and the
      <a class="ulink" href="http://samba.org/" target="_top"><span class="command"><strong>samba</strong></span></a>
      package makes extensive use of broadcasting techniques for discovery and
      information sharing.  Dynamic Host Configuration Protocol
      (<a class="ulink" href="http://www.isc.org/products/DHCP/" target="_top"><acronym class="acronym">DHCP</acronym></a>) 
      also makes use of broadcasting techniques to manage IP addressing.
    </p><p>
      The IP broadcast address is, usually, correctly derived from the IP
      address and network mask although it can be easily be set explicitly
      to a different address.  Because the broadcast address
      is used for autodiscovery (e.g, <acronym class="acronym">SMB</acronym> under
      some protocols, an incorrect broadcast
      address can inhibit a machine's ability to participate in networked
      communication
      <a href="#ftn.idm397" class="footnote" name="idm397"><sup class="footnote">[2]</sup></a>.
    </p><p>
      The netmask on the interface should match the netmask in the routing
      table for the locally connected network.  Typically, the route and
      the IP interface definition are calculated from the same configuration
      data so they should match perfectly. 
    </p><p>
      If you are at all confused about how to address a network or how to read
      either the traditional notation or the CIDR notation for network
      addressing, see one of the CIDR/netmask references in
      <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-local-network"></a>2.1. Sending Packets to the Local Network</h3></div></div></div><p>
        We can see from the output above that the IP address 192.168.99.35
        falls inside the address space 192.168.99.0/24.  We also note that
        the machine <code class="systemitem">tristan</code>
        will route packets bound for 192.168.99.0/24 directly onto the
        Ethernet attached to eth0.  This line in the routing table
        identifies a network available on the Ethernet attached to eth0
        ("Iface") by its network address ("Destination") and size ("Genmask").
      </p><pre class="programlisting">
<code class="computeroutput">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0</code>
      </pre><p>
        Every host on the 192.168.99.0/24 network should share the network
        address and netmask specified above.  No two hosts should share the
        same IP address.
      </p><p>
        Currently, there are two hosts connected to the example desktop network.
        Both <code class="systemitem">tristan</code> and <code class="systemitem">masq-gw</code> are connected to 192.168.99.0/24.  Thus,
        192.168.99.254 (<code class="systemitem">masq-gw</code>) should be reachable from <code class="systemitem">tristan</code>.
        Success of this test provides evidence that <code class="systemitem">tristan</code> is
        configured properly.  N.B., Assume that the network
        administrator has properly configured <code class="systemitem">masq-gw</code>.  Since the
        <a class="link" href="#routing-default" title="3. Sending Packets Through a Gateway">default gateway</a> in any
        network is an important host, testing reachability of the default
        gateway also has a value in determining the proper operation of the
        local network.
      </p><p>
        The <span class="command"><strong>ping</strong></span> tool, designed to take advantage of
        Internet Control Message Protocol (<acronym class="acronym">ICMP</acronym>), can be
        used to test reachability of IP addresses.  For a command summary
        and examples of the use of <span class="command"><strong>ping</strong></span>, see
        <a class="xref" href="#tools-ping" title="1. ping">Section 1, &#8220;<span class="command"><strong>ping</strong></span>&#8221;</a>.
      </p><div class="example"><a name="ex-basic-ping"></a><p class="title"><b>Example 1.2. Testing reachability of a locally connected host with
          <span class="command">ping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ping -c 1 -n 192.168.99.254</code></strong>
<code class="computeroutput">PING 192.168.99.254 (192.168.99.254) from 192.168.99.35 : 56(84) bytes of data.

--- 192.168.99.254 ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss
PING 192.168.99.254 (192.168.99.254) from 192.168.99.35 : 56(84) bytes of data.
64 bytes from 192.168.99.254: icmp_seq=0 ttl=255 time=238 usec

--- 192.168.99.254 ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max/mdev = 0.238/0.238/0.238/0.000 ms</code>
        </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-default-gateway"></a>2.2. Sending Packets to Unknown Networks Through the Default
        Gateway</h3></div></div></div><p>
        In <a class="xref" href="#basic-local-network" title="2.1. Sending Packets to the Local Network">Section 2.1, &#8220;Sending Packets to the Local Network&#8221;</a>, we verified that hosts
        connected to the same local network can reach each other and, 
        importantly, the default gateway.  Now, let's see what happens to
        packets which have a destination address outside the locally connected
        network.
      </p><p>
        Assuming that the network administrator allows ping packets
        from the desktop network into the public network,
        <span class="command"><strong>ping</strong></span> can be invoked with the
        record route option to show the path the packet travels from
        <code class="systemitem">tristan</code> to <code class="systemitem">wan-gw</code> and back.
      </p><div class="example"><a name="ex-basic-ping-non-local"></a><p class="title"><b>Example 1.3. Testing reachability of non-local hosts</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ping -R -c 1 -n 205.254.211.254</code></strong>
<code class="computeroutput">PING 205.254.211.254 (205.254.211.254) from 192.168.99.35 : 56(84) bytes of data.

--- 205.254.211.254 ping statistics ---
1 packets transmitted, 0 packets received, 100% packet loss
PING 205.254.211.254 (205.254.211.254) from 192.168.99.35 : 56(84) bytes of data.
64 bytes from 205.254.211.254: icmp_seq=0 ttl=255 time=238 usec
RR:     192.168.99.35        <a class="co" name="ex-bpnl-tristan-out" href="#ex-bpnl-tristan-out-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
        205.254.211.179      <a class="co" name="ex-bpnl-masq-gw-out" href="#ex-bpnl-masq-gw-out-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
        205.254.211.254      <a class="co" name="ex-bpnl-wan-gw-in" href="#ex-bpnl-bpnl-wan-gw-in-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
        205.254.211.254
        192.168.99.254       <a class="co" name="ex-bpnl-masq-gw-in" href="#ex-bpnl-masq-gw-in-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
        192.168.99.35        <a class="co" name="ex-bpnl-tristan-in" href="#ex-bpnl-tristan-in-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>

--- 192.168.99.254 ping statistics ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max/mdev = 0.238/0.238/0.238/0.000 ms</code>
          </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-bpnl-tristan-out-text"></a><a href="#ex-bpnl-tristan-out"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
                  As the packet passes through the IP stack on <code class="systemitem">tristan</code>,
                  before hitting the Ethernet, <code class="systemitem">tristan</code> adds its IP to the
                  list of IPs in the option field in the header.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-bpnl-masq-gw-out-text"></a><a href="#ex-bpnl-masq-gw-out"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
                  This is <code class="systemitem">masq-gw</code>'s public IP address.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-bpnl-bpnl-wan-gw-in-text"></a><a href="#ex-bpnl-wan-gw-in"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
                  Our intended destination!  (Anybody know why there are
                  two entries in the record route output?)
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-bpnl-masq-gw-in-text"></a><a href="#ex-bpnl-masq-gw-in"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
                  This is <code class="systemitem">masq-gw</code>'s private IP address.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-bpnl-tristan-in-text"></a><a href="#ex-bpnl-tristan-in"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
                  And finally, <code class="systemitem">tristan</code> will add its IP to the option field
                  in the header of the IP packet just before the packet
                  reaches the calling <span class="command"><strong>ping</strong></span> program.
                </td></tr></table></div></div></div><br class="example-break"><p>
        By testing reachability of the local network 192.168.99.0/24 and
        an IP address outside our local network, we have verified the basic
        elements of IP connectivity.
      </p><p>
        To summarize this section, we have:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
             identified the IP address, network address and netmask in use
             on <code class="systemitem">tristan</code> using the tools <span class="command"><strong>ifconfig</strong></span> and
             <span class="command"><strong>route</strong></span>
           </p></li><li class="listitem"><p>
             verified that <code class="systemitem">tristan</code> can reach its default gateway
           </p></li><li class="listitem"><p>
              tested that packets bound for destinations outside our
              local network reach the intended destination and return
            </p></li></ul></div><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-static"></a>2.3. Static Routes to Networks</h3></div></div></div><p>
        Static routes instruct the kernel to route packets
        for a known destination host or network to a router or
        gateway different from the default gateway.
        In the example network, the desktop machine <code class="systemitem">tristan</code> would need
        a static route to reach hosts in the 192.168.98.0/24 network.
        Note that the branch office network is reachable over an ISDN line.
        The ISDN router's IP in <code class="systemitem">tristan</code>'s network is 192.168.99.1.  This
        means that there are two gateways in the example desktop network,
        one connected to a small branch office network, and the other
        connected to the Internet.
      </p><p>
        Without a static route to the branch office network, <code class="systemitem">tristan</code> would
        use <code class="systemitem">masq-gw</code> as the gateway, which is not the most efficient path for
        packets bound for <code class="systemitem">morgan</code>.  Let's examine why a static route would
        be better here.
      </p><p>
        If <code class="systemitem">tristan</code> generates a packet bound for <code class="systemitem">morgan</code> and
        sends the packet to the default gateway, <code class="systemitem">masq-gw</code> will forward the
        packet to <code class="systemitem">isdn-router</code> as well as generate an ICMP redirect message
        to <code class="systemitem">tristan</code>.  This ICMP redirect message tells <code class="systemitem">tristan</code> to send
        future packets with a destination address of 192.168.98.82 (<code class="systemitem">morgan</code>)
        directly to <code class="systemitem">isdn-router</code>.  For a fuller discussion of ICMP redirect,
        see
        <a class="xref" href="#routing-icmp-redirect" title="10.2. ICMP Redirects and Routing">Section 10.2, &#8220;ICMP Redirects and Routing&#8221;</a>.
      </p><p>
        The absence of a static route has caused two extra packets to be
        generated on the Ethernet for no benefit.  Not only that, but
        <code class="systemitem">tristan</code> will eventually expire the temporary route entry
        <a href="#ftn.idm500" class="footnote" name="idm500"><sup class="footnote">[3]</sup></a>
        for 192.168.98.82, which means that subsequent packets bound for
        <code class="systemitem">morgan</code> will repeat this process
        <a href="#ftn.idm504" class="footnote" name="idm504"><sup class="footnote">[4]</sup></a>.
      </p><p>
        To solve this problem, add a static route to <code class="systemitem">tristan</code>'s routing
        table.  Below is a modified routing table (see
        <a class="xref" href="#basic-changing" title="3. Changing IP Addresses and Routes">Section 3, &#8220;Changing IP Addresses and Routes&#8221;</a> to learn how to change the routing
        table).
      </p><div class="example"><a name="ex-basic-static"></a><p class="title"><b>Example 1.4. Sample routing table with a static route</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.98.0    192.168.99.1    255.255.255.0   UG    0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
        </pre></div></div><br class="example-break"><p>
        According to this routing table, any packets with a destination
        address in the 192.168.98.0/24 network will be routed to the
        gateway 192.168.99.1 instead of the default gateway.  This will
        prevent unnecessary ICMP redirect messages.
      </p><p>
        These are the basic tools for inspecting the IP
        address and the routes on a linux machine.  Understanding
        the output of these tools will help you understand how
        machines fit into simple networks, and will be a base on which
        you can build an understanding of more complex networks.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-changing"></a>3. Changing IP Addresses and Routes</h2></div></div></div><p>
        This section introduces
        <a class="link" href="#basic-changing-ip" title="3.1. Changing the IP on a machine">changing the IP address
        on an interface</a>,
        <a class="link" href="#basic-changing-default" title="3.2. Setting the Default Route">changing the default
        gateway</a>, and 
        <a class="link" href="#basic-changing-static" title="3.3. Adding and removing a static route">adding and removing a
        static route</a>.  With the knowledge of
        <span class="command"><strong>ifconfig</strong></span> and <span class="command"><strong>route</strong></span> output
        it's a small step to
        learn how to change IP configuration with these same tools.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-changing-ip"></a>3.1. Changing the IP on a machine</h3></div></div></div><p>
        For a practical example, let's say that the branch office server,
        <code class="systemitem">morgan</code>, needs to visit the main office for some hardware maintenance.
        Since the services on the machine are not in use, it's a convenient
        time to fetch some software updates, after configuring the machine to
        join the LAN.
      </p><p>
        Once the machine is booted and connected to the Ethernet, it's 
        ready for IP reconfiguration.  In order to join an 
        IP network, the following information is required.  Refer to the 
        <a class="link" href="#example-network-netmap" title="1. Example Network Map and General Notes">network map and
        appendix</a> to gather the required information below.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            An unused IP address (<span class="emphasis"><em>Use 192.168.99.14.</em></span>)
          </p></li><li class="listitem"><p>
            netmask (<span class="emphasis"><em>What's your guess?</em></span>)
          </p></li><li class="listitem"><p>
            IP address of the default gateway (<span class="emphasis"><em>What's your
            guess?</em></span>)
          </p></li><li class="listitem"><p>
            network address
            <a href="#ftn.idm543" class="footnote" name="idm543"><sup class="footnote">[5]</sup></a>
            (<span class="emphasis"><em>What's your guess?</em></span>)
          </p></li><li class="listitem"><p>
            The IP address of a name resolver. (<span class="emphasis"><em>Use the IP
            of the default gateway here</em></span>
            <a href="#ftn.idm551" class="footnote" name="idm551"><sup class="footnote">[6]</sup></a>.
            )
          </p></li></ul></div><div class="example"><a name="ex-basic-before-change"></a><p class="title"><b>Example 1.5. <span class="command">ifconfig</span> and <span class="command">route</span>
          output before the change</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ifconfig eth0</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:53  
          inet addr:192.168.98.82  Bcast:192.168.98.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
          Interrupt:9 Base address:0x5000 
</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.98.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.98.254  0.0.0.0         UG    0      0        0 eth0</code>
        </pre></div></div><br class="example-break"><p>
        The process of readdressing for the new network involves three steps.
        It is clear in
        <a class="xref" href="#ex-basic-before-change" title="Example 1.5. ifconfig and route output before the change">Example 1.5, &#8220;<span class="command">ifconfig</span> and <span class="command">route</span>
          output before the change&#8221;</a>, that <code class="systemitem">morgan</code> is configured
        for a different network than the main office desktop network.
        First, the 
        <a class="link" href="#ex-basic-ifconfig-down" title="Example 1.6. Bringing down a network interface with ifconfig">active interface must be
        brought down</a>, then a
        <a class="link" href="#ex-basic-ifconfig-up" title="Example 1.7. Bringing up an Ethernet interface with ifconfig">new address must be configured
        on the interface and brought up</a>, and finally
        <a class="link" href="#ex-basic-set-default" title="Example 1.8. Adding a default route with route">a new default route must be
        added</a>.  If the networking configuration is correct and the
        process is successful, the machine should be able to connect to local
        and non-local destinations.
      </p><div class="example"><a name="ex-basic-ifconfig-down"></a><p class="title"><b>Example 1.6. Bringing down a network interface with
          <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ifconfig eth0 down</code></strong>
        </pre></div></div><br class="example-break"><p>
        This is a fast way to stop networking on a single-homed machine such
        as a server or workstation.  On multi-homed hosts, other
        interfaces on the machine would
        be unaffected by this command.  This method of bringing down an
        interface has some serious side effects, which should be understood.
        Here is a summary of the side effects of bringing down an interface.
      </p><a name="list-basic-ifconfig-side-effects-down"></a><div class="itemizedlist"><p class="title"><b>Side effects of bringing down an interface with
          <span class="command"><strong>ifconfig</strong></span></b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            all IP addresses on the specified interface are deactivated
            and removed
          </p></li><li class="listitem"><p>
            any connections established to or from IPs on the specified
            interface are broken
            <a href="#ftn.idm586" class="footnote" name="idm586"><sup class="footnote">[7]</sup></a>
          </p></li><li class="listitem"><p>
            all routes to any destinations through the specified interface
            are removed from the routing tables
          </p></li><li class="listitem"><p>
            the link layer device is deactivated
          </p></li></ul></div><p>
        The next step, bringing up the interface, requires the new
        networking configuration information.  It's a good habit to check the
        interface after configuration to verify settings.
      </p><div class="example"><a name="ex-basic-ifconfig-up"></a><p class="title"><b>Example 1.7. Bringing up an Ethernet interface with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ifconfig eth0 192.168.99.14 netmask 255.255.255.0 up</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ifconfig eth0</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:53  
          inet addr:192.168.99.14  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)
          Interrupt:9 Base address:0x5000 
</code>
        </pre></div></div><br class="example-break"><p>
        The second call to <span class="command"><strong>ifconfig</strong></span> allows verification of
        the IP addressing information.  The currently configured IP address on
        eth0 is 192.168.99.14.  Bringing up an interface also has a small set
        of side effects.
      </p><a name="list-basic-ifconfig-side-effects-up"></a><div class="itemizedlist"><p class="title"><b>Side effects of bringing up an interface</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            the link layer device is activated
          </p></li><li class="listitem"><p>
            the requested IP address is assigned to the specified interface
          </p></li><li class="listitem"><p>
            all local, network, and broadcast routes implied by the
            IP configuration are added to the routing tables
          </p></li></ul></div><p>
        Use
        <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a> to
        verify the reachability of other locally connected hosts or skip
        directly to setting the default gateway.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-changing-default"></a>3.2. Setting the Default Route</h3></div></div></div><p>
        It should come as no surprise to a close reader
        (<a class="link" href="#list-basic-ifconfig-side-effects-down">hint</a>),
        that the default route was removed at the execution of
        <strong class="userinput"><code>ifconfig eth0 down</code></strong>.  The crucial final step is
        configuring the default route.
      </p><div class="example"><a name="ex-basic-set-default"></a><p class="title"><b>Example 1.8. Adding a default route with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add default gw 192.168.99.254</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
        </pre></div></div><br class="example-break"><p>
        The routing table on <code class="systemitem">morgan</code> should look exactly like the initial
        routing table on <code class="systemitem">tristan</code>.  Compare the routing tables in
        <a class="xref" href="#ex-basic-ifconfig" title="Example 1.1. Sample ifconfig output">Example 1.1, &#8220;Sample <span class="command">ifconfig</span> output&#8221;</a> and
        <a class="xref" href="#ex-basic-set-default" title="Example 1.8. Adding a default route with route">Example 1.8, &#8220;Adding a default route with <span class="command">route</span>&#8221;</a>.
      </p><p>
        These changes to the routing table on <code class="systemitem">morgan</code> will stay in effect
        until they are manually changed, the network is restarted, or the
        machine reboots.  With knowledge of the addressing scheme of a
        network, and the use of
        <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a> and
        <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a> it's
        simple to readdress a machine on just about any Ethernet you can
        attach to.  The benefits of familiarity with these commands extend to
        non-Ethernet IP networks as well, because these commands operate on the
        IP layer, independent of the link layer.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="basic-changing-static"></a>3.3. Adding and removing a static route</h3></div></div></div><p>
        Now that <code class="systemitem">morgan</code> has joined the LAN at the main office and can
        reach the Internet, a static route to the branch office would be
        convenient for accessing resources on that network.
      </p><p>
        A static route is any route entered into a routing table
        which specifies at least a destination address and a gateway or device.
        Static routes are special instructions regarding the
        path a packet should take to reach a destination and  are
        usually used to specify reachability of a destination through a router
        other than the default gateway.
      </p><p>
        As we saw above, in <a class="xref" href="#basic-static" title="2.3. Static Routes to Networks">Section 2.3, &#8220;Static Routes to Networks&#8221;</a>, a static route
        provides a specific route to a known destination.  There are several
        pieces of information we need to know in order to be able to add a
        static route.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            the address of the destination (<span class="emphasis"><em>192.168.98.0</em></span>)
          </p></li><li class="listitem"><p>
            the netmask of the destination (<span class="emphasis"><em>255.255.255.0</em></span>)
              </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                  EITHER the IP address of the router through which the
                  destination (<span class="emphasis"><em>192.168.99.1</em></span>) is reachable
                </p></li><li class="listitem"><p>
                  OR the name of the link layer device to which the
                  destination is directly connected
                </p></li></ul></div><p>
          </p></li></ul></div><div class="example"><a name="ex-basic-add-static"></a><p class="title"><b>Example 1.9. Adding a static route with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -net 192.168.98.0 netmask 255.255.255.0 gw 192.168.99.1</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.98.0    192.168.99.1    255.255.255.0   UG    0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
        </pre></div></div><br class="example-break"><p>
        <a class="xref" href="#ex-basic-add-static" title="Example 1.9. Adding a static route with route">Example 1.9, &#8220;Adding a static route with <span class="command">route</span>&#8221;</a> shows how to add a static
        route to the 192.168.98.0/24 network.
        In order to test the reachability of the remote network,
        ping any machine on the 192.168.98.0/24 network.  Routers are
        usually a good choice, since they rarely have packet
        filters and are usually alive.
      </p><p>
        Because a more specific route is always chosen over a less specific
        route, it is even possible to support host routes.  These are routes
        for destinations which are single IP addresses.  This can be
        accomplished with a manually added static route as below.
      </p><div class="example"><a name="ex-basic-del-static"></a><p class="title"><b>Example 1.10. Removing a static network route and adding a static host
          route</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route del -net 192.168.98.0 netmask 255.255.255.0 gw 192.168.99.1</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -net 192.168.98.42 netmask 255.255.255.255 gw 192.168.99.1</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -host 192.168.98.42 gw 192.168.99.1</code></strong>
<code class="computeroutput">SIOCADDRT: File exists</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.98.42   192.168.99.1    255.255.255.255 UGH   0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
        </pre></div></div><br class="example-break"><p>
        This should serve as an illustration that there is no difference to
        the kernel in selecting a route between a host route and a network
        route with a host netmask.  If this is a surprise or is at all
        confusing, review the use of netmasks in IP networking.
        Some collected links on general IP networking are available in
        <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="basic-conclusion"></a>4. Conclusion</h2></div></div></div><p>
      This chapter has introduced the simplest uses of
      <span class="command"><strong>ifconfig</strong></span> and <span class="command"><strong>route</strong></span> to view and
      alter the IP configuration of a host.  To reiterate the minimum
      requirements to create an IP network between two machines:
    </p><a name="basic-ip-requirements"></a><div class="itemizedlist"><p class="title"><b>Requirements for Two Hosts on the Same Ethernet to
        Communicate Using IP</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Each host must have a good connection to the Ethernet.  Verify a
          good connection to the Ethernet with <span class="command"><strong>mii-tool</strong></span>,
          documented in
         <a class="xref" href="#tools-mii-tool" title="5. mii-tool">Section 5, &#8220;<span class="command"><strong>mii-tool</strong></span>&#8221;</a>.
        </p></li><li class="listitem"><p>
          Each host must share IP network space.  Practically, this means
          that each host should have the same network address, netmask,
          and broadcast address
          <a href="#ftn.idm708" class="footnote" name="idm708"><sup class="footnote">[8]</sup></a>.
      </p></li><li class="listitem"><p>
          Each host must have a unique IP address.
        </p></li><li class="listitem"><p>
          Neither host must block the other's IP packets.  (Host based
          packet filtering may hinder connections!)
        </p></li></ul></div><p>
      This concludes the tour of basic host networking and IP layer
      configuration as well as some basic tools available to the
      linux user.  For further documentation on these tools, other tips,
      tricks, and more advanced content, keep reading!
    </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm352" class="footnote"><p><a href="#idm352" class="para"><sup class="para">[1] </sup></a>
          For BSD and UNIX users, the idiom <span class="command"><strong>netstat
          -rn</strong></span> may be more familiar than the common
          <span class="command"><strong>route -n</strong></span> on a linux machine.  Both of
          these commands provide the same
          basic information although the formatting is a bit different.  For a
          fuller discussion of these, see either <a class="xref" href="#tools-netstat" title="4. netstat">Section 4, &#8220;<span class="command"><strong>netstat</strong></span>&#8221;</a>
          or <a class="xref" href="#tools-route" title="1. route">Section 1, &#8220;<span class="command"><strong>route</strong></span>&#8221;</a>.  For access to all of the routing
          features of the linux kernel, use
          <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip route</strong></span></a>
          instead.
        </p></div><div id="ftn.idm397" class="footnote"><p><a href="#idm397" class="para"><sup class="para">[2] </sup></a>
          An incorrect broadcast address often highlights a mismatch of
          the configured IP address and netmask on an interface.  If in
          doubt, be sure to use an
          <a class="link" href="#tools-ipcalc" title="1. ipcalc and other IP addressing calculators">IP calculator</a> to set the correct
          netmask and broadcast addresses.
        </p></div><div id="ftn.idm500" class="footnote"><p><a href="#idm500" class="para"><sup class="para">[3] </sup></a>
            If the machine is a linux machine, then the temporary route entry
            is stored in the routing cache.  Consult
            <a class="xref" href="#routing-cache" title="7. Routing Cache">Section 7, &#8220;Routing Cache&#8221;</a> for more information on the
            routing cache.
          </p></div><div id="ftn.idm504" class="footnote"><p><a href="#idm504" class="para"><sup class="para">[4] </sup></a>
            It is quite reasonable to ignore ICMP redirect messages from
            unknown hosts on the Internet, but ICMP redirect messages on a 
            LAN indicate that a host has mismatched netmasks or missing
            static routes.
          </p></div><div id="ftn.idm543" class="footnote"><p><a href="#idm543" class="para"><sup class="para">[5] </sup></a>
                The network address can be calculated from the IP address and
                netmask.  Refer to
                <a class="xref" href="#tools-ipcalc" title="1. ipcalc and other IP addressing calculators">Section 1, &#8220;<span class="command"><strong>ipcalc</strong></span> and other IP addressing calculators&#8221;</a>.  Especially handy is the
                variable length subnet mask RFC,
                <a class="ulink" href="http://www.isi.edu/in-notes/rfc1878.txt" target="_top">RFC
                1878</a>.
              </p></div><div id="ftn.idm551" class="footnote"><p><a href="#idm551" class="para"><sup class="para">[6] </sup></a>
                Many networks are configured with
                the name resolution services on a publicly connected host.
                See <a class="xref" href="#trouble-dns" title="6. DNS Troubleshooting">Section 6, &#8220;DNS Troubleshooting&#8221;</a>.
              </p></div><div id="ftn.idm586" class="footnote"><p><a href="#idm586" class="para"><sup class="para">[7] </sup></a>
                It is possible for a linux box which meets the following three
                criteria to maintain connections and provide services without
                having the service IP configured on an interface.  It must be
                functioning as a router, be configured to support non-local
                binding and be in the route path of the client machine.  This
                is an uncommon need, frequently accomplished by the use of
                transparent proxying software.
              </p></div><div id="ftn.idm708" class="footnote"><p><a href="#idm708" class="para"><sup class="para">[8] </sup></a>
            Technically, the two hosts simply need to have routes to
            each other, but we are discussing the simplest case here,
            so we'll leave this for a discussion of
            <a class="link" href="#adv-media-share" title="2. Multiple IP Networks on one Ethernet Segment">shared media</a>.
          </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-ether"></a>Chapter 2. Ethernet</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#ether-arp">1. Address Resolution Protocol (ARP)</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-arp-overview">1.1. Overview of Address Resolution Protocol</a></span></dt><dt><span class="section"><a href="#ether-arp-cache">1.2. The ARP cache</a></span></dt><dt><span class="section"><a href="#ether-arp-suppression">1.3. ARP Suppression</a></span></dt><dt><span class="section"><a href="#ether-arp-flux">1.4. The ARP Flux Problem</a></span></dt></dl></dd><dt><span class="section"><a href="#ether-arp-proxy">2. Proxy ARP</a></span></dt><dt><span class="section"><a href="#ether-arp-filtering">3. ARP filtering</a></span></dt><dt><span class="section"><a href="#ether-vlan">4. Connecting to an Ethernet 802.1q VLAN</a></span></dt><dt><span class="section"><a href="#ether-bonding">5. Link Aggregation and High Availability with Bonding</a></span></dt><dd><dl><dt><span class="section"><a href="#ether-bonding-aggregation">5.1. Link Aggregation</a></span></dt><dt><span class="section"><a href="#ether-bonding-ha">5.2. High Availability</a></span></dt></dl></dd></dl></div><a class="indexterm" name="idm718"></a><p>
    The most common link layer network in use today is Ethernet.  Although
    there are several common speeds of Ethernet devices, they function
    identically with regard to higher layer protocols.  As this documentation
    focusses on higher layer protocols (IP), some fine distinctions about
    different types of Ethernet will be overlooked in favor of depicting the
    uniform manner in which IP networks overlay Ethernets.
  </p><p>
    Address Resolution Protocol provides the necessary mapping between link
    layer
    addresses and IP addresses for machines connected to Ethernets.  Linux
    offers control of ARP requests and replies via several
    not-well-known <code class="filename">/proc</code> interfaces;
    <code class="filename">net/ipv4/conf/$DEV/proxy_arp</code>,
    <code class="filename">net/ipv4/conf/$DEV/medium_id</code>, and
    <code class="filename">net/ipv4/conf/$DEV/hidden</code>.  For even
    finer control of ARP requests than is available in stock kernels,
    there are kernel and <span class="command"><strong>iproute2</strong></span> patches.
  </p><p>
    This chapter will introduce the
    <a class="link" href="#ether-arp-overview" title="1.1. Overview of Address Resolution Protocol">ARP conversation</a>, discuss the
    <a class="link" href="#ether-arp-cache" title="1.2. The ARP cache">ARP cache</a>,
    a volatile mapping of the reachable IPs and MAC addresses on a
    segment, examine
    <a class="link" href="#ether-arp-flux" title="1.4. The ARP Flux Problem">the ARP flux problem</a>,
    and explore several
    <a class="link" href="#ether-arp-filtering" title="3. ARP filtering">ARP filtering and suppression
    techniques</a>.  A section on
    <a class="link" href="#ether-vlan" title="4. Connecting to an Ethernet 802.1q VLAN">VLAN technology</a> and 
    <a class="link" href="#ether-bonding" title="5. Link Aggregation and High Availability with Bonding">channel bonding</a> will round out the
    chapter on Ethernet.
  </p><a class="indexterm" name="idm734"></a><a class="indexterm" name="idm737"></a><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ether-arp"></a>1. Address Resolution Protocol (ARP)</h2></div></div></div><p>
      Address Resolution Protocol (ARP) hovers in the shadows of most networks.
      Because of its simplicity, by comparison to higher layer protocols, ARP
      rarely intrudes upon the network administrator's routine.  All modern
      IP-capable operating systems provide support for ARP.  The uncommon
      alternative to ARP is static link-layer-to-IP mappings.
    </p><p>
      ARP defines the exchanges between network interfaces connected to an
      Ethernet media segment in order to map an IP address to a link layer
      address on demand.  Link layer addresses are hardware addresses (although
      <a class="link" href="#tools-ip-link-set-address" title="3.7. Changing hardware or Ethernet broadcast address with ip link set">they are not immutable</a>)
      on Ethernet cards and IP addresses are logical addresses
      assigned to machines attached to the Ethernet.  Subsequently in this
      chapter, link layer addresses may be known by many different names:
      Ethernet addresses, Media Access Control (MAC) addresses, and even 
      hardware addresses.
      Disputably, the correct term from the kernel's perspective is "link
      layer address" because this address can be changed (on many Ethernet
      cards) via command line tools.  Nevertheless, these terms are not
      realistically distinct and can be used interchangeably.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-arp-overview"></a>1.1. Overview of Address Resolution Protocol</h3></div></div></div><p>
        Address Resolution Protocol (ARP) exists solely to glue together the
        IP and Ethernet networking layers.  Since networking hardware
        such as switches, hubs, and bridges operate on Ethernet frames, they
        are unaware of the higher layer data carried by these frames
          <a href="#ftn.idm747" class="footnote" name="idm747"><sup class="footnote">[9]</sup></a>.
        Similarly, IP layer devices, operating on IP packets need to be able
        to transmit their IP data on Ethernets.  ARP defines the
        conversation by which IP capable hosts can exchange mappings of
        their Ethernet and IP addressing.
      </p><a class="indexterm" name="idm749"></a><a name="ether-arp-request"></a><p>
        ARP is used to locate the Ethernet address associated with a desired IP
        address.  When a machine has a packet bound for another IP on a locally
        connected Ethernet network, it will send a broadcast Ethernet frame
        containing an ARP request onto the Ethernet.  All machines with the same
        Ethernet broadcast address will receive this packet
        <a href="#ftn.idm753" class="footnote" name="idm753"><sup class="footnote">[10]</sup></a>.
        If a machine receives the ARP request and it hosts the IP requested,
        it will respond with the link layer address on which it will receive
        packets for that IP address.
        <span class="foreignphrase"><em class="foreignphrase">N.B.</em></span>, the 
        <a class="link" href="#ether-arp-flux-arpfilter" title="1.4.1. ARP flux prevention with arp_filter"><code class="constant">arp_filter</code>
        sysctl</a> will alter this behaviour
        somewhat.
      </p><a class="indexterm" name="idm759"></a><a name="ether-arp-reply"></a><p>
        Once the requestor receives the response packet, it associates
        the MAC address and the IP address.  This information is stored in the
        <a class="link" href="#ether-arp-cache" title="1.2. The ARP cache">arp cache</a>.  The arp cache
        can be manipulated with the
        <a class="link" href="#tools-ip-neighbor" title="4. ip neighbor"><span class="command"><strong>ip neighbor</strong></span></a>
        and
        <a class="link" href="#tools-arp" title="1. arp"><span class="command"><strong>arp</strong></span></a> commands.
        To learn how and when to manipulate the arp cache, see
        <a class="xref" href="#tools-arp" title="1. arp">Section 1, &#8220;<span class="command"><strong>arp</strong></span>&#8221;</a>.
      </p><p>
        In <a class="xref" href="#ex-basic-ping" title="Example 1.2. Testing reachability of a locally connected host with ping">Example 1.2, &#8220;Testing reachability of a locally connected host with
          <span class="command">ping</span>&#8221;</a>, we used <span class="command"><strong>ping</strong></span> to
        test reachability of <code class="systemitem">masq-gw</code>.  Using a packet sniffer to capture
        the sequence of packets on the Ethernet as a result of <code class="systemitem">tristan</code>'s
        attempt to ping, provides an example of ARP <span class="foreignphrase"><em class="foreignphrase">in flagrante
        delicto</em></span>.  Consult the
        <a class="link" href="#example-network-netmap" title="1. Example Network Map and General Notes">example network map</a> for a
        visual representation of the network layout in which this traffic
        occurs.
      </p><p>
        This is an archetypal conversation between two
        computers exchanging relevant hardware addressing in order that they 
        can pass IP packets, and is comprised of two Ethernet frames.
      </p><a class="indexterm" name="idm777"></a><div class="example"><a name="ex-ether-arp-overview"></a><p class="title"><b>Example 2.1. ARP conversation captured with tcpdump
          <a href="#ftn.idm783" class="footnote" name="idm783"><sup class="footnote">[11]</sup></a>
        </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -ennqti eth0 \( arp or icmp \)</code></strong>
<code class="computeroutput">tcpdump: listening on eth0
0:80:c8:f8:4a:51 ff:ff:ff:ff:ff:ff 42: arp who-has 192.168.99.254 tell 192.168.99.35             <a class="co" name="ex-eao-request" href="#ex-eao-request-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
0:80:c8:f8:5c:73 0:80:c8:f8:4a:51 60: arp reply 192.168.99.254 is-at 0:80:c8:f8:5c:73            <a class="co" name="ex-eao-reply" href="#ex-eao-reply-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
0:80:c8:f8:4a:51 0:80:c8:f8:5c:73 98: 192.168.99.35 &gt; 192.168.99.254: icmp: echo request (DF)    <a class="co" name="ex-eao-ip" href="#ex-eao-ip-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
0:80:c8:f8:5c:73 0:80:c8:f8:4a:51 98: 192.168.99.254 &gt; 192.168.99.35: icmp: echo reply           <a class="co" name="ex-eao-ip2" href="#ex-eao-ip-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a></code>
        </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-eao-request-text"></a><a href="#ex-eao-request"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><a class="indexterm" name="idm798"></a><p>
                This broadcast Ethernet frame, identifiable by the
                destination Ethernet address with all bits set
                (ff:ff:ff:ff:ff:ff) contains an ARP request from <code class="systemitem">tristan</code>
                for IP address 192.168.99.254.  The request includes the
                source link layer address and the IP address of
                the requestor, which provides enough information for the
                owner of the IP address to reply with its link layer address.
              </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eao-reply-text"></a><a href="#ex-eao-reply"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><a class="indexterm" name="idm803"></a><p>
                The ARP reply from <code class="systemitem">masq-gw</code> includes its link layer address
                and declaration of ownership of the requested IP address.
                Note that the ARP reply is a unicast response to a broadcast
                request.  The payload of the ARP reply contains the link layer
                address mapping.
              </p><p>
                The machine which initiated the ARP request (<code class="systemitem">tristan</code>)
                now has enough information to encapsulate an IP packet in
                an Ethernet frame and forward it to the link layer address
                of the recipient (00:80:c8:f8:5c:73).
              </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eao-ip-text"></a><a href="#ex-eao-ip"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> <a href="#ex-eao-ip2"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
                The final two packets in
                <a class="xref" href="#ex-ether-arp-overview" title="Example 2.1. ARP conversation captured with tcpdump">Example 2.1, &#8220;ARP conversation captured with tcpdump
          
        &#8221;</a> display the link
                layer header and the encapsulated ICMP packets
                exchanged between these two hosts.  Examining the ARP
                cache on each of these hosts would reveal entries on
                each host for the other host's link layer address.
              </td></tr></table></div></div></div><br class="example-break"><p>
        This example is the commonest example of ARP traffic on an Ethernet.
        In summary, an ARP request is transmitted in a broadcast Ethernet
        frame.  The ARP reply is a unicast response, containing the desired
        information, sent to the requestor's link layer address.
      </p><p>
        An even rarer usage of ARP is gratuitous ARP, where a machine
        announces its ownership of an IP address on a media segment.  The
        <a class="link" href="#tools-arping" title="2. arping"><span class="command"><strong>arping</strong></span></a> utility
        can generate these gratuitous ARP frames.  Linux kernels will
        respect gratuitous ARP frames
        <a href="#ftn.idm816" class="footnote" name="idm816"><sup class="footnote">[12]</sup></a>.
      </p><a class="indexterm" name="idm819"></a><a class="indexterm" name="idm823"></a><div class="example"><a name="ex-ether-arp-gratuitous"></a><p class="title"><b>Example 2.2. Gratuitous ARP reply frames</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>arping -q -c 3 -A -I eth0 192.168.99.35</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -c 3 -nni eth2 arp</code></strong>
<code class="computeroutput">tcpdump: listening on eth2
06:02:50.626330 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51) 
06:02:51.622727 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51) 
06:02:52.620954 arp reply 192.168.99.35 is-at 0:80:c8:f8:4a:51 (0:80:c8:f8:4a:51)</code>
        </pre></div></div><br class="example-break"><p>
        The frames generated in
        <a class="xref" href="#ex-ether-arp-gratuitous" title="Example 2.2. Gratuitous ARP reply frames">Example 2.2, &#8220;Gratuitous ARP reply frames&#8221;</a> are ARP replies to a
        question never asked.  This sort of ARP is common in failover
        solutions and also for nefarious sorts of purposes, such as
        <a class="ulink" href="http://ettercap.sourceforge.net/" target="_top"><span class="command"><strong>ettercap</strong></span></a>.
      </p><p>
        Unsolicited ARP request frames, on the other hand, are broadcast
        ARP requests initiated by a host owning an IP address.
      </p><a class="indexterm" name="idm840"></a><a class="indexterm" name="idm844"></a><div class="example"><a name="ex-ether-arp-unsolicited"></a><p class="title"><b>Example 2.3. Unsolicited ARP request frames</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>arping -q -c 3 -U -I eth0 192.168.99.35</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -c 3 -nni eth2 arp</code></strong>
<code class="computeroutput">tcpdump: listening on eth2
06:28:23.172068 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35
06:28:24.167290 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35
06:28:25.167250 arp who-has 192.168.99.35 (ff:ff:ff:ff:ff:ff) tell 192.168.99.35</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neigh show</code></strong>
        </pre></div></div><br class="example-break"><p>
        These two uses of <span class="command"><strong>arping</strong></span> can help diagnose Ethernet
        and ARP problems--particularly hosts replying for addresses which do
        not belong to them.
      </p><p>
        To avoid IP address collisions on dynamic networks (where hosts are
        turning on and off, connecting and disconnecting and otherwise
        changing IP addresses) duplicate address detection becomes important.
        Fortunately, <span class="command"><strong>arping</strong></span> provides this functionality as
        well.  A startup script could include the <span class="command"><strong>arping</strong></span>
        utility in duplicate address detection mode to select between
        IP addresses or methods of acquiring an IP address.
      </p><a class="indexterm" name="idm863"></a><a class="indexterm" name="idm866"></a><div class="example"><a name="ex-ether-arp-dad"></a><p class="title"><b>Example 2.4. Duplicate Address Detection with ARP</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>arping -D -I eth0 192.168.99.147; echo $?</code></strong>
<code class="computeroutput">ARPING 192.168.99.47 from 0.0.0.0 eth0
Unicast reply from 192.168.99.47 [00:80:C8:E8:1E:FC] for 192.168.99.47 [00:80:C8:E8:1E:FC] 0.702ms
Sent 1 probes (1 broadcast(s))
Received 1 response(s)
1</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>tcpdump -eqtnni eth2 arp</code></strong>
<code class="computeroutput">tcpdump: listening on eth2
0:80:c8:f8:4a:51 ff:ff:ff:ff:ff:ff 60: arp who-has 192.168.99.147 (ff:ff:ff:ff:ff:ff) tell 0.0.0.0
0:80:c8:e8:1e:fc 0:80:c8:f8:4a:51 42: arp reply 192.168.99.147 is-at 0:80:c8:e8:1e:fc (0:80:c8:e8:1e:fc)</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neigh show</code></strong>
        </pre></div></div><br class="example-break"><p>
        Address Resolution Protocol, which provides a method to connect
        physical network addresses with logical network addresses
        is a key element to the deployment of IP on Ethernet networks.  
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-arp-cache"></a>1.2. The ARP cache</h3></div></div></div><a class="indexterm" name="idm884"></a><a class="indexterm" name="idm886"></a><p>
        In simplest terms, an ARP cache is a stored mapping of IP addresses
        with link layer addresses.  An ARP cache obviates the need for an ARP
        request/reply conversation for each IP packet exchanged.  Naturally,
        this efficiency comes with a price.  Each host maintains its own ARP
        cache, which can become outdated when a host is replaced, or an IP
        address moves from one host to another.  The ARP cache is also known
        as the neighbor table.
      </p><p>
        To display the ARP cache, the venerable and cross-platform
        <span class="command"><strong>arp</strong></span> admirably dispatches its duty.  As with many of
        the <span class="command"><strong>iproute2</strong></span> tools, more information is available
        via <span class="command"><strong>ip neighbor</strong></span> than with <span class="command"><strong>arp</strong></span>.
        <a class="xref" href="#ex-ether-arp-cache" title="Example 2.5. ARP cache listings with arp and ip neighbor">Example 2.5, &#8220;ARP cache listings with <span class="command">arp</span> and
          <span class="command">ip neighbor</span>&#8221;</a> below illustrates the differences
        in the output between the output of these two different tools.
      </p><a class="indexterm" name="idm896"></a><div class="example"><a name="ex-ether-arp-cache"></a><p class="title"><b>Example 2.5. ARP cache listings with <span class="command">arp</span> and
          <span class="command">ip neighbor</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>arp -na</code></strong>
<code class="computeroutput">? (192.168.99.7) at 00:80:C8:E8:1E:FC [ether] on eth0
? (192.168.99.254) at 00:80:C8:F8:5C:73 [ether] on eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud reachable
192.168.99.254 dev eth0 lladdr 00:80:c8:f8:5c:73 nud reachable</code>
        </pre></div></div><br class="example-break"><p>
        A major difference between the information reported by <span class="command"><strong>ip
        neighbor</strong></span> and <span class="command"><strong>arp</strong></span> is the state of the
        proxy ARP table.  The only way to list permanently advertised entries
        in the neighbor table (proxy ARP entries) is with the
        <span class="command"><strong>arp</strong></span>.
      </p><a class="indexterm" name="idm914"></a><a class="indexterm" name="idm917"></a><a name="ether-arp-cache-expiry"></a><p>
        Entries in the ARP cache are periodically and automatically
        verified unless continually used.  Along with 
        <code class="filename">net/ipv4/neigh/$DEV/gc_stale_time</code>,
        there are a number of other parameters in
        <code class="filename">net/ipv4/neigh/$DEV</code> which control the
        expiration of entries in the ARP cache.
      </p><p>
        When a host is down or disconnected from the Ethernet, there is a
        period of time during which other hosts may have an ARP cache entry
        for the disconnected host.  Any other machine may display a neighbor
        table with the link layer address of the recently disconnected host.
        Because there is a recently known-good link layer address on which
        the IP was reachable, the entry will abide.  At
        <code class="filename">gc_stale_time</code> the state of the entry will change,
        reflecting the need to verify the reachability of the link layer
        address.  When the disconnected host fails to respond ARP requests,
        the neighbor table entry will be marked as
        <code class="constant">incomplete</code>
      </p><p>
        Here are a the possible states for entries in the neighbor table.
      </p><a class="indexterm" name="idm928"></a><div class="table"><a name="tb-ether-arp-cache-states"></a><p class="title"><b>Table 2.1. Active ARP cache entry states</b></p><div class="table-contents"><table class="table" summary="Active ARP cache entry states" border="1"><colgroup><col><col><col></colgroup><thead><tr><th align="center">ARP cache entry state</th><th align="center">meaning</th><th align="center">action if used</th></tr></thead><tbody><tr><td align="center">permanent</td><td align="center">never expires; never verified</td><td align="center">reset use counter</td></tr><tr><td align="center">noarp</td><td align="center">normal expiration; never verified</td><td align="center">reset use counter</td></tr><tr><td align="center">reachable</td><td align="center">normal expiration</td><td align="center">reset use counter</td></tr><tr><td align="center">stale</td><td align="center">still usable; needs verification</td><td align="center">reset use counter; change state to delay</td></tr><tr><td align="center">delay</td><td align="center">schedule ARP request; needs verification</td><td align="center">reset use counter</td></tr><tr><td align="center">probe</td><td align="center">sending ARP request</td><td align="center">reset use counter</td></tr><tr><td align="center">incomplete</td><td align="center">first ARP request sent</td><td align="center">send ARP request</td></tr><tr><td align="center">failed</td><td align="center">no response received</td><td align="center">send ARP request</td></tr></tbody></table></div></div><br class="table-break"><p>
        To resume, a host (192.168.99.7) in <code class="systemitem">tristan</code>'s ARP cache on the
        <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network</a> has just
        been disconnected.  There are a series of events which
        will occur as <code class="systemitem">tristan</code>'s ARP cache entry for 192.168.99.7 expires and
        gets scheduled for verification.  Imagine that the following commands
        are run to capture each of these states immediately before state
        change.
      </p><a class="indexterm" name="idm976"></a><div class="example"><a name="ex-ether-arp-cache-timeout"></a><p class="title"><b>Example 2.6. ARP cache timeout</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud reachable</code>     <a class="co" name="ex-eact-reachable" href="#ex-eact-reachable-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud stale</code>         <a class="co" name="ex-eact-stale" href="#ex-eact-stale-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud delay</code>         <a class="co" name="ex-eact-delay" href="#ex-eact-delay-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0 lladdr 00:80:c8:e8:1e:fc nud probe</code>         <a class="co" name="ex-eact-probe" href="#ex-eact-probe-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.7</code></strong>
<code class="computeroutput">192.168.99.7 dev eth0  nud incomplete</code>                            <a class="co" name="ex-eact-incomplete" href="#ex-eact-incomplete-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>
          </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-eact-reachable-text"></a><a href="#ex-eact-reachable"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
                  Before the entry has expired for 192.168.99.7, but after the
                  host has been disconnected from the network.  During this
                  time, <code class="systemitem">tristan</code> will continue to send out Ethernet frames with
                  the destination frame address set to the link layer address
                  according to this entry.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eact-stale-text"></a><a href="#ex-eact-stale"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
                  It has been <code class="constant">gc_stale_time</code> seconds since
                  the entry has been verified, so the state has changed to
                  stale.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eact-delay-text"></a><a href="#ex-eact-delay"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
                  This entry in the neighbor table has been requested.
                  Because the entry was in a stale state, the link layer
                  address was used, but now the kernel needs to verify
                  the accuracy of the address.  The kernel will soon send
                  an ARP request for the destination IP address.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eact-probe-text"></a><a href="#ex-eact-probe"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
                  The kernel is actively performing address resolution for the
                  entry.  It will send a total of
                  <code class="constant">ucast_solicit</code> frames to the last known
                  link layer address to attempt to verify reachability of the
                  address.  Failing this, it will send
                  <code class="constant">mcast_solicit</code> broadcast frames before
                  altering the ARP cache state and returning an error to any
                  higher layer services.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eact-incomplete-text"></a><a href="#ex-eact-incomplete"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
                  After all attempts to reach the destination address have
                  failed, the entry will appear in the neighbor table in this
                  state.
                </td></tr></table></div></div></div><br class="example-break"><p>
        The remaining neighbor table flags are visible when initial ARP
        requests are made.  If no ARP cache entry exists for a requested
        destination IP, the kernel will generate
        <code class="constant">mcast_solicit</code> ARP requests until receiving an
        answer.  
        During this discovery period, the ARP cache
        entry will be listed in an <span class="emphasis"><em>incomplete</em></span> state.  If
        the lookup does not succeed after the specified number of ARP
        requests, the ARP cache entry will be listed in a
        <span class="emphasis"><em>failed</em></span> state.  If the lookup does succeed, the
        kernel enters the response into the ARP cache and resets the
        confirmation and update timers.
      </p><p>
        After receipt of a corresponding ARP reply, the kernel enters the
        response into the ARP cache and resets the confirmation and update
        timers.
      </p><p>
        For machines not using a static mapping for link layer and IP
        addresses, ARP provides on demand mappings.  The remainder of this
        section will cover the methods available under linux to control the
        address resolution protocol.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-arp-suppression"></a>1.3. ARP Suppression</h3></div></div></div><a class="indexterm" name="idm1025"></a><p>
        Complete ARP suppression is not difficult at all.  ARP suppression can
        be accomplished under linux on a per-interface basis by setting the
        noarp flag on any Ethernet interface.
        Disabling ARP will require static neighbor table mappings
        for all hosts wishing to exchange packets across the Ethernet.
      </p><p>
        To suppress ARP on an interface simply use <span class="command"><strong>ip
        link set dev $DEV arp off</strong></span> as in
        <a class="xref" href="#ex-tools-ip-link-set" title="Example B.7. Using ip link set to change device flags">Example B.7, &#8220;Using <span class="command">ip link set</span> to change device flags&#8221;</a>
        or <span class="command"><strong>ifconfig $DEV -arp</strong></span> as in
        <a class="xref" href="#ex-tools-ifconfig-flags" title="Example C.5. Setting interface flags with ifconfig">Example C.5, &#8220;Setting interface flags with <span class="command">ifconfig</span>&#8221;</a>.  Complete ARP suppression
        will prevent the host from sending any ARP requests or responding with
        any ARP replies.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-arp-flux"></a>1.4. The ARP Flux Problem</h3></div></div></div><a class="indexterm" name="idm1035"></a><p>
        When a linux box is connected to a network segment with multiple
        network cards, a potential problem with the link layer address 
        to IP address mapping can occur.
        The machine may respond to ARP requests from both Ethernet interfaces.
        On the machine creating the ARP request, these multiple answers can
        cause confusion, or worse yet, non-deterministic population
        of the ARP cache.  Known as ARP flux
        <a href="#ftn.idm1038" class="footnote" name="idm1038"><sup class="footnote">[13]</sup></a>,
        this can lead to the possibly puzzling effect that an IP migrates
        non-deterministically through multiple link layer addresses.  It's
        important to understand that ARP flux typically only affects hosts
        which have multiple physical connections to the same medium or
        broadcast domain.
      </p><p>
        This is a simple illustration of the problem in a network where a
        server has two Ethernet adapters connected to the same media
        segment.  They need not have IP addresses in the same IP network for
        the ARP reply to be generated by each interface.  Note the first
        two replies received in response to the ARP broadcast request.
        These replies arrive from conflicting link layer addresses in
        response to this request.  Also notice the greater time required for
        the sending and receiving hosts to process the broadcast ARP request
        frames than the unicast frames which follow (probes two and three).
      </p><div class="example"><a name="ex-ether-arp-flux"></a><p class="title"><b>Example 2.7. ARP flux</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 3 10.10.20.67</code></strong>
<code class="computeroutput">ARPING 10.10.20.67 from 10.10.20.33 eth0
Unicast reply from 10.10.20.67 [00:80:C8:7E:71:D4]  11.298ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  12.077ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.542ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.547ms
Sent 3 probes (1 broadcast(s))
Received 4 response(s)</code>
        </pre></div></div><br class="example-break"><p>
        There are four solutions to this problem.  The common solution for
        kernel 2.4 harnesses the
        <a class="link" href="#ether-arp-flux-arpfilter" title="1.4.1. ARP flux prevention with arp_filter"><code class="constant">arp_filter</code>
        sysctl</a>, while the common solution for kernel 2.2 takes
        advantage of the
        <a class="link" href="#ether-arp-flux-hidden" title="1.4.2. ARP flux prevention with hidden"><code class="constant">hidden</code>
        sysctl</a>.  These two solutions alter the behaviour of ARP on a
        per interface basis and only if the functionality has been enabled.
      </p><p>
        Alternate solutions which provide much greater control of ARP
        (possibly documented
        <a class="link" href="#ether-arp-filtering" title="3. ARP filtering">here</a> at a later date)
        include Julian Anastasov's
        <a class="ulink" href="http://www.ssi.bg/~ja/#iparp" target="_top"><span class="command"><strong>ip
        arp</strong></span></a> tool and his
        <a class="ulink" href="http://www.ssi.bg/~ja/#noarp" target="_top">noarp
        route flag</a>.  While these tools were conceived in the course of
        the
        <a class="ulink" href="http://www.linuxvirtualserver.org/" target="_top">Linux Virtual
        Server</a> project, they have practical application outside this
        realm.
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ether-arp-flux-arpfilter"></a>1.4.1. ARP flux prevention with <code class="constant">arp_filter</code></h4></div></div></div><a class="indexterm" name="idm1061"></a><a class="indexterm" name="idm1064"></a><p>
          One method for preventing ARP flux involves the use of
          <code class="filename">net/ipv4/conf/$DEV/arp_filter</code>.  In
          short, the use of <code class="filename">arp_filter</code> causes the recipient
          (in the
          <a class="link" href="#ex-ether-arp-flux-arpfilter" title="Example 2.8. Correction of ARP flux with conf/$DEV/arp_filter">case below</a>,
          <code class="systemitem">real-server</code>) to perform a route lookup to
          determine the interface through which to send the
          reply, instead of the default behaviour
          (<a class="link" href="#ex-ether-arp-flux" title="Example 2.7. ARP flux">shown above</a>), replying
          from all Ethernet interfaces which receive the request.
        </p><p>
          The <code class="filename">arp_filter</code> solution can have unintended
          effects if the only route to the destination
          is through one of the network cards.  In
          <a class="xref" href="#ex-ether-arp-flux-arpfilter" title="Example 2.8. Correction of ARP flux with conf/$DEV/arp_filter">Example 2.8, &#8220;Correction of ARP flux with
            <code class="filename">conf/$DEV/arp_filter</code>&#8221;</a>, <code class="systemitem">real-client</code> will
          demonstrate this.  This instructive example should highlight
          the shortcomings of the <code class="constant">arp_filter</code> solution in
          very complex networks where finer-grained control is required.
        </p><p>
          In general, the <code class="filename">arp_filter</code> solution
          sufficiently solves the ARP flux problem.  First, hosts do not
          generate ARP requests for networks to which they do not have a
          direct route (see 
          <a class="xref" href="#routing-local" title="2. Routing to Locally Connected Networks">Section 2, &#8220;Routing to Locally Connected Networks&#8221;</a>) and second, when such a route
          exists, the host normally
          <a class="link" href="#routing-saddr-selection" title="6. Source Address Selection">chooses a source
          address</a> in the same network as the destination.  So, the
          <code class="filename">arp_filter</code> solution is a good general solution,
          but does not adequately address the occasional need for more control
          over ARP requests and replies.
        </p><div class="example"><a name="ex-ether-arp-flux-arpfilter"></a><p class="title"><b>Example 2.8. Correction of ARP flux with
            <code class="filename">conf/$DEV/arp_filter</code></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_filter</code></strong>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/arp_filter</code></strong>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/eth1/arp_filter</code></strong>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:e8:1e:fc brd ff:ff:ff:ff:ff:ff
    inet 10.10.20.67/24 scope global eth0</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip address show dev eth1</code></strong>
<code class="computeroutput">3: eth1: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:7e:71:d4 brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.1/24 brd 192.168.100.255 scope global eth1</code>    <a class="co" name="ex-eafa-server-setup" href="#ex-eafa-server-setup-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 3 10.10.20.67</code></strong>
<code class="computeroutput">ARPING 10.10.20.67 from 10.10.20.33 eth0
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  0.882ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.221ms
Unicast reply from 10.10.20.67 [00:80:C8:E8:1E:FC]  1.487ms        </code><a class="co" name="ex-eafa-expected" href="#ex-eafa-expected-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a><code class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 3 192.168.100.1</code></strong>
<code class="computeroutput">ARPING 192.168.100.1 from 10.10.20.33 eth0
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  0.877ms
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  1.517ms
Unicast reply from 192.168.100.1 [00:80:C8:E8:1E:FC]  1.661ms      </code><a class="co" name="ex-eafa-problemzone" href="#ex-eafa-problemzone-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a><code class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>ip neighbor del 192.168.100.1 dev eth0</code></strong>         <a class="co" name="ex-eafa-clearcache" href="#ex-eafa-clearcache-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>ip address add 192.168.100.2/24 brd + dev eth0</code></strong> <a class="co" name="ex-eafa-newip" href="#ex-eafa-newip-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 3 192.168.100.1</code></strong>
<code class="computeroutput">ARPING 192.168.100.1 from 192.168.100.2 eth0
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  0.804ms
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  1.381ms
Unicast reply from 192.168.100.1 [00:80:C8:7E:71:D4]  2.487ms      </code><a class="co" name="ex-eafa-workaround" href="#ex-eafa-workaround-text"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a><code class="computeroutput">
Sent 3 probes (1 broadcast(s))
Received 3 response(s)</code>
          </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-server-setup-text"></a><a href="#ex-eafa-server-setup"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
                  Set the sysctl variables to enable the
                  <code class="filename">arp_filter</code> functionality.  After this,
                  you might expect that ARP replies for 10.10.20.67 would only
                  advertise the link layer address on eth0 (00:80:c8:e8:1e:fc).
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-expected-text"></a><a href="#ex-eafa-expected"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
                  Here is the expected behaviour.  Only one reply comes in for
                  the IP 10.10.20.67 after the <code class="filename">arp_filter</code>
                  sysctl has been enabled.  The reply originates from the
                  interface on <code class="systemitem">real-server</code> which actually hosts the IP
                  address.  Note that the source address on the ARP queries is
                  10.10.20.33, and that the ARP query causes <code class="systemitem">real-server</code> to
                  perform a route lookup on 10.10.20.33 to choose an interface
                  from which to send the reply.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-problemzone-text"></a><a href="#ex-eafa-problemzone"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
                  Here, <code class="systemitem">real-client</code> requests the link layer address of the
                  host 192.168.100.1, but the source IP on the request packet
                  (chosen according to the
                  <a class="link" href="#routing-saddr-selection" title="6. Source Address Selection">rules for source
                  address selection</a>) is 10.10.20.33.  When
                  <code class="systemitem">real-server</code> looks up a route to this destination, it
                  chooses its eth0, and replies with the link layer address of
                  its eth0.  Conventional networking needs should not run
                  afoul of this oddity of the <code class="filename">arp_filter</code>
                  ARP flux prevention technique.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-clearcache-text"></a><a href="#ex-eafa-clearcache"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
                  Remove the entry in the neighbor table before testing again.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-newip-text"></a><a href="#ex-eafa-newip"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
                  By adding an IP address in the same network as the intended
                  destination (which would be
                  rather common where multiple IP networks share the same
                  medium or broadcast domain), the kernel can now select a
                  different source address for the ARP request packets.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-eafa-workaround-text"></a><a href="#ex-eafa-workaround"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
                  Note the source address of the ARP queries is now
                  192.168.100.2.  When <code class="systemitem">real-server</code> performs a route lookup
                  for the 192.168.100.0/24 destination, the chosen path is
                  through eth1.  The ARP reply packets now have the correct
                  link layer address.
                </td></tr></table></div></div></div><br class="example-break"><p>
          In general, the <code class="filename">arp_filter</code> solution should
          suffice, but this knowledge can be key in determining whether or not
          an alternate solution, such as an
          <a class="link" href="#ether-arp-filtering" title="3. ARP filtering">ARP filtering solution</a>
          are necessary.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="ether-arp-flux-hidden"></a>1.4.2. ARP flux prevention with <code class="constant">hidden</code></h4></div></div></div><a class="indexterm" name="idm1150"></a><a class="indexterm" name="idm1154"></a><p>
          The ARP flux problem can also be combatted with a
          <a class="ulink" href="http://www.ssi.bg/~ja/#hidden" target="_top">kernel
          patch</a> by Julian Anastasov, which was incorporated into the
          2.2.14+ kernel series, but never into the 2.4+ kernel series.
          Therefore, the functionality may not be available in all
          kernels.
        </p><p>
          The sysctl <code class="filename">net/ipv4/conf/$DEV/hidden</code> toggles
          the generation of ARP replies for requested IPs.  It marks an
          interface and all of its IP addresses invisible to other
          interfaces for the purpose of ARP
          requests.  When an ARP request arrives on any interface, the kernel
          tests to see if the IP address is locally hosted anywhere on the
          machine.  If the IP is found on any interface, the kernel will
          generate a reply.
        </p><p>
          Since this is not always desirable, the <code class="filename">hidden</code>
          sysctl can be employed.  This prevents the kernel from finding the
          IP address when testing to see what IP addresses are locally hosted.
          The kernel can always find IPs hosted on the interface on which the
          packet arrived, but it cannot find addresses which are
          <code class="filename">hidden</code>.
        </p><p>
          As shown in
          <a class="xref" href="#ex-ether-arp-flux-hidden" title="Example 2.9. Correction of ARP flux with net/$DEV/hidden">Example 2.9, &#8220;Correction of ARP flux with
            <code class="filename">net/$DEV/hidden</code>&#8221;</a>, not only can ARP flux be
          corrected, but sensitive information about the IP addresses
          available on a linux box can be safeguarded
          <a href="#ftn.idm1167" class="footnote" name="idm1167"><sup class="footnote">[14]</sup></a>.
          This makes the <code class="filename">hidden</code> sysctl useful for
          preventing unwanted IP disclosure via ARP on multi-homed hosts,
          in addition to preventing ARP flux on hosts connected to the
          same network medium.
        </p><div class="example"><a name="ex-ether-arp-flux-hidden"></a><p class="title"><b>Example 2.9. Correction of ARP flux with
            <code class="filename">net/$DEV/hidden</code></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 1 172.19.22.254</code></strong>
<code class="computeroutput">ARPING 172.19.22.254 from 172.19.22.2 eth0
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.704ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2E]  0.844ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2F]  0.918ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2C]  0.974ms
Sent 1 probes (1 broadcast(s))
Received 4 response(s)</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>for i in all eth2 eth3 eth4 eth5 ; do</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/conf/$i/hidden</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>done</code></strong>
<code class="prompt">[root@real-client]# </code><strong class="userinput"><code>arping -I eth0 -c 2 172.19.22.254</code></strong>
<code class="computeroutput">ARPING 172.19.22.254 from 172.19.22.2 eth0
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.710ms
Unicast reply from 172.19.22.254 [00:60:F5:08:8A:2D]  0.624ms
Sent 2 probes (1 broadcast(s))
Received 2 response(s)</code>
          </pre></div></div><br class="example-break"><p>
          These are two examples of methods to prevent ARP flux.  Other
          alternatives for correcting this problem are documented in
          <a class="xref" href="#ether-arp-filtering" title="3. ARP filtering">Section 3, &#8220;ARP filtering&#8221;</a>, where much more sophisticated
          tools are available for manipulation and control over the ARP
          functions of linux.
        </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ether-arp-proxy"></a>2. Proxy ARP</h2></div></div></div><a class="indexterm" name="idm1190"></a><p>
      Occasionally, an IP network must be split into separate segments.  Proxy
      ARP can be used for increased control over packets exchanged between two
      hosts or to limit exposure between two hosts in a single IP network.
      The technique of proxy ARP is commonly used to interpose a device with
      higher layer functionality between two other hosts.  From a practical
      standpoint, there is little difference between the functions of a
      <a class="link" href="#bridging-packet-filter" title="3. Bridging and Packet Filtering">packet-filtering bridge</a> and
      a firewall performing proxy ARP.  The manner by which the interposed
      device receives the packets, however, is tremendously different.
    </p><div class="example"><a name="ex-ether-arp-proxy"></a><p class="title"><b>Example 2.10. Proxy ARP Network Diagram</b></p><div class="example-contents"><div class="mediaobject"><a name="image-ether-arp-proxy"></a><img src="images/ether-arp-proxy.png"></div></div></div><br class="example-break"><p>
      The device performing proxy ARP (<code class="systemitem">masq-gw</code>) responds for all ARP queries
      on behalf of IPs reachable on interfaces other than the interface on
      which the query arrives.
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
      FIXME; manual proxy ARP (see also
      <a class="xref" href="#adv-proxy-arp" title="3. Breaking a network in two with proxy ARP">Section 3, &#8220;Breaking a network in two with proxy ARP&#8221;</a>), kernel proxy ARP, and the newly
      supported sysctl <code class="filename">net/ipv4/conf/$DEV/medium_id</code>.
    </p><a name="ether-arp-proxy-mediumid"></a><a class="indexterm" name="idm1212"></a><a class="indexterm" name="idm1216"></a><p>
      For a brief description of the use of medium_id, see
      <a class="ulink" href="http://www.ssi.bg/~ja/#medium_id" target="_top">Julian's
      remarks</a>.
    </p><a name="ether-arp-proxy-kernel"></a><a class="indexterm" name="idm1225"></a><a class="indexterm" name="idm1230"></a><p>
      FIXME; Kernel proxy ARP with the sysctl
      <code class="filename">net/ipv4/conf/$DEV/proxy_arp</code>.
    </p><p>
      Note....until this section is written, this
      <a class="ulink" href="http://mailman.ds9a.nl/pipermail/lartc/2003q2/008315.html" target="_top">post</a>
      by Don Cohen is rather instructive.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ether-arp-filtering"></a>3. ARP filtering</h2></div></div></div><a class="indexterm" name="idm1240"></a><a class="indexterm" name="idm1242"></a><p>
      This section should be part of the "ghetto" which will
      include documentation on <span class="command"><strong>ip arp</strong></span>.  There's nothing
      more to add here at the moment (low priority).
    </p><p>
      </p><pre class="programlisting">
<code class="prompt"># </code><strong class="userinput"><code>ip arp help</code></strong>
<code class="computeroutput">Usage: ip arp [ list | flush ] [ RULE ]
       ip arp [ append | prepend | add | del | change | replace | test ] RULE
RULE := [ table TABLE_NAME ] [ pref NUMBER ] [ from PREFIX ] [ to PREFIX ]
           [ iif STRING ] [ oif STRING ] [ llfrom PREFIX ] [ llto PREFIX ]
           [ broadcasts ] [ unicasts ] [ ACTION ] [ ALTER ]
TABLE_NAME := [ input | forward | output ]
ACTION := [ deny | allow ]
ALTER := [ src IP ] [ llsrc LLADDR ] [ lldst LLADDR ]</code>
      </pre><p>
    </p><p>
      The 
      <a class="ulink" href="http://www.ssi.bg/~ja/#iparp" target="_top"><span class="command"><strong>ip
      arp</strong></span></a> tool.
      Patches and code for the
      <a class="ulink" href="http://www.ssi.bg/~ja/#noarp" target="_top">noarp
      route flag</a>.
    </p><p>
      FIXME; add a few paragraphs on <span class="command"><strong>ip arp</strong></span> and the noarp
      flag.
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ether-vlan"></a>4. Connecting to an Ethernet 802.1q VLAN</h2></div></div></div><a class="indexterm" name="idm1261"></a><p>
      Virtual LANs are a way to take a single switch and subdivide it into
      logical media segments.  A single switch port in a VLAN-capable switch
      can carry packets from multiple virtual LANs and linux can understand
      the format of these Ethernet frames.  For more on this, see
      <a class="ulink" href="http://www.candelatech.com/~greear/vlan.html" target="_top">the linux
      802.1q VLAN implementation site</a>.
    </p><p>
      Kernels in the late 2.4 series have support for VLAN incorporated into
      the stock release.  The <span class="command"><strong>vconfig</strong></span> tool, however needs
      to be compiled against the kernel source in order to provide userland
      configurability of the kernel support for VLANs.
    </p><p>
      There are a few items of note which may prevent quick adoption of VLAN
      support under linux.  Ben McKeegan wrote a
      <a class="ulink" href="http://www.wanfear.com/pipermail/vlan/2002q4/002882.html" target="_top">good
      summary</a> of the MTU/MRU issues involved with VLANs and 10/100
      Ethernet.  Gigabit Ethernet drivers are not hamstrung with this problem.
      Consider using gigabit Ethernet cards from the outset to avoid these
      potential problems.
    </p><div class="example"><a name="ex-ether-vlan"></a><p class="title"><b>Example 2.11. Bringing up a VLAN interface</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-router]# </code><strong class="userinput"><code>vconfig add eth0 7</code></strong>
<code class="prompt">[root@real-router]# </code><strong class="userinput"><code>ip addr add dev eth0.7 192.168.30.254/24 brd +</code></strong>
<code class="prompt">[root@real-router]# </code><strong class="userinput"><code>ip link set dev eth0.7 up</code></strong>
       </pre></div></div><br class="example-break"><p>
      Each interface defined using the <span class="command"><strong>vconfig</strong></span> utility
      takes its name from the base device to which it has been bound, and
      appends the VLAN tag ID, as shown in
      <a class="xref" href="#ex-ether-vlan" title="Example 2.11. Bringing up a VLAN interface">Example 2.11, &#8220;Bringing up a VLAN interface&#8221;</a>.
    </p><p>
      This documentation is sparse.  Visit the 
      <a class="ulink" href="http://www.candelatech.com/~greear/vlan.html" target="_top">main
      site</a> and the
      <a class="ulink" href="http://www.wanfear.com/pipermail/vlan/" target="_top">VLAN mailing list
      archives</a>.
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ether-bonding"></a>5. Link Aggregation and High Availability with Bonding</h2></div></div></div><a class="indexterm" name="idm1287"></a><p>
      Networking vendors have long offered a functionality for aggregating
      bandwidth across multiple physical links to a switch.  
      This allows a machine (frequently a server) to treat multiple
      physical connections to switch units as a single logical link.
      The standard moniker for this technology is IEEE 802.3ad, although
      it is known by the common names of trunking, port trunking
      and link aggregation.  The conventional use of bonding under linux is
      an implementation of this
      <a class="link" href="#ether-bonding-aggregation" title="5.1. Link Aggregation">link aggregation</a>.
    </p><p>
      A separate use of the same driver allows the kernel to present a single
      logical interface for two physical links to two separate
      switches.  Only one link is used at any given time.  By using media
      independent interface signal failure to detect when a switch or link
      becomes unusable, the kernel can, transparently to userspace and
      application layer services, fail to the backup physical connection.
      Though not common, the failure of switches, network interfaces, and
      cables can cause outages.  As a component of high availability planning,
      <a class="link" href="#ether-bonding-ha" title="5.2. High Availability">these bonding techniques</a>
      can help reduce the number of single points of failure.
    </p><p>
      For more information on bonding, see the
      <code class="filename">Documentation/networking/bonding.txt</code> from the linux
      source code tree.
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-bonding-aggregation"></a>5.1. Link Aggregation</h3></div></div></div><a class="indexterm" name="idm1298"></a><a class="indexterm" name="idm1301"></a><p>
        Bonding for link aggregation must be supported by both endpoints.
        Two linux machines connected via crossover cables can take advantage
        of link aggregation.  A single machine connected with two physical
        cables to a switch which supports port trunking can use link
        aggregation to the switch.
        Any conventional switch
        will become ineffably confused by a hardware address appearing on
        multiple ports simultaneously.
      </p><div class="example"><a name="ex-ether-bonding-aggregation"></a><p class="title"><b>Example 2.12. Link aggregation bonding</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>modprobe  bonding</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip addr add 192.168.100.33/24 brd + dev bond0</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip link set dev bond0 up</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ifenslave  bond0 eth2 eth3</code></strong>
<code class="computeroutput">master has no hw address assigned; getting one from slave!
The interface eth2 is up, shutting it down it to enslave it.
The interface eth3 is up, shutting it down it to enslave it.</code>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ifenslave  bond0 eth2 eth3</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>cat /proc/net/bond0/info</code></strong>
<code class="computeroutput">Bonding Mode: load balancing (round-robin)
MII Status: up
MII Polling Interval (ms): 0
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: eth2
MII Status: up
Link Failure Count: 0

Slave Interface: eth3
MII Status: up
Link Failure Count: 0</code>
        </pre></div></div><br class="example-break"><p>
        FIXME;  Need an experiment here....maybe a tcpdump to show how the
        management frames appear on the wire.
      </p><p>
        This
        <a class="ulink" href="http://www.beowulf.org/software/bonding.html" target="_top">Beowulf
        software page</a> describes in a bit more detail the rationale and
        a practical application of linux channel bonding (for link
        aggregation).
      </p><p>
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ether-bonding-ha"></a>5.2. High Availability</h3></div></div></div><a class="indexterm" name="idm1328"></a><p>
        Bonding support under linux is part of a high availability solution.
        For an entry point into the complexity of high availability in
        conjunction with linux, see the
        <a class="ulink" href="http://linux-ha.org/" target="_top">linux-ha.org</a> site.  To guard
        against layer two (switch) and layer one (cable) failure, a machine
        can be configured with multiple physical connections to separate
        switch devices while presenting a single logical interface to
        userspace.
      </p><p>
        The name of the interface can be specified by the user.  It is
        commonly <code class="constant">bond0</code> or something similar.  As a
        logical interface, it can be used in routing tables and by
        <a class="link" href="#tools-tcpdump" title="5. tcpdump"><span class="command"><strong>tcpdump</strong></span></a>.
      </p><p>
        The bond interface, when created, has no link layer address.  In the
        example below, an address is manually added to the interface.  See
        <a class="xref" href="#ex-ether-bonding-aggregation" title="Example 2.12. Link aggregation bonding">Example 2.12, &#8220;Link aggregation bonding&#8221;</a> for an example of the
        bonding driver reporting setting the link layer address when the first
        device is enslaved to the bond (doesn't that sound cruel!).
      </p><div class="example"><a name="ex-ether-bonding-ha"></a><p class="title"><b>Example 2.13. High availability bonding</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>modprobe bonding mode=1 miimon=100 downdelay=200 updelay=200</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip link set dev bond0 addr 00:80:c8:e7:ab:5c</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip addr add 192.168.100.33/24 brd + dev bond0</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip link set dev bond0 up</code></strong>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ifenslave  bond0 eth2 eth3</code></strong>
<code class="computeroutput">The interface eth2 is up, shutting it down it to enslave it.
The interface eth3 is up, shutting it down it to enslave it.</code>
<code class="prompt">[root@real-server root]# </code><strong class="userinput"><code>ip link show eth2 ; ip link show eth3 ; ip link show bond0</code></strong>
<code class="computeroutput">4: eth2: &lt;BROADCAST,MULTICAST,SLAVE,UP&gt; mtu 1500 qdisc pfifo_fast master bond0 qlen 100
  link/ether 00:80:c8:e7:ab:5c brd ff:ff:ff:ff:ff:ff
5: eth3: &lt;BROADCAST,MULTICAST,NOARP,SLAVE,DEBUG,AUTOMEDIA,PORTSEL,NOTRAILERS,UP&gt; mtu 1500 qdisc pfifo_fast master bond0 qlen 100
  link/ether 00:80:c8:e7:ab:5c brd ff:ff:ff:ff:ff:ff
58: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP&gt; mtu 1500 qdisc noqueue
  link/ether 00:80:c8:e7:ab:5c brd ff:ff:ff:ff:ff:ff</code>
        </pre></div></div><br class="example-break"><p>
        Immediately noticeable, there is a new flag in the <span class="command"><strong>ip link
        show</strong></span> output.  The <code class="constant">MASTER</code> and
        <code class="constant">SLAVE</code> flags clearly report the nature of the
        relationship between the interfaces.  Also, the Ethernet interfaces
        indicate the master interface via the keywords <code class="constant">master
        bond0</code>.
      </p><p>
        Note also, that all three of the interfaces share the same link layer
        address, <code class="constant">00:80:c8:e7:ab:5c</code>.
      </p><p>
        FIXME; What doe DEBUG,AUTOMEDIA,PORTSEL,NOTRAILERS mean?
      </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm747" class="footnote"><p><a href="#idm747" class="para"><sup class="para">[9] </sup></a>
              Some networking equipment vendors have built devices which are
              sold as high performance switches and are capable of performing
              operations on higher layer contents of Ethernet frames.
              Typically, however, a switching device is not capable of
              operating on IP packets.
            </p></div><div id="ftn.idm753" class="footnote"><p><a href="#idm753" class="para"><sup class="para">[10] </sup></a>
            The kernel uses the Ethernet broadcast address configured on the
            link layer device.  This is rarely anything but ff:ff:ff:ff:ff:ff.
            In the extraordinary event that this is not the Ethernet broadcast
            address in your network, see
            <a class="xref" href="#tools-ip-link-set-address" title="3.7. Changing hardware or Ethernet broadcast address with ip link set">Section 3.7, &#8220;Changing hardware or Ethernet broadcast address with
          <span class="command"><strong>ip link set</strong></span>&#8221;</a>.
          </p></div><div id="ftn.idm783" class="footnote"><p><a href="#idm783" class="para"><sup class="para">[11] </sup></a>
              <span class="command"><strong>tcpdump</strong></span> is one of a number of utilities for
              watching packets visible to an interface.  For further
              introduction to <span class="command"><strong>tcpdump</strong></span>, see
              <a class="xref" href="#tools-tcpdump" title="5. tcpdump">Section 5, &#8220;<span class="command"><strong>tcpdump</strong></span>&#8221;</a>.
            </p></div><div id="ftn.idm816" class="footnote"><p><a href="#idm816" class="para"><sup class="para">[12] </sup></a>
            I have repeatedly tested using <span class="command"><strong>arping</strong></span> in
            gratuitous ARP mode, and have found that linux kernels appear to
            respect gratuitous ARP.  This is a surprise.  Does anybody have
            ideas about this?  Must research!
          </p></div><div id="ftn.idm1038" class="footnote"><p><a href="#idm1038" class="para"><sup class="para">[13] </sup></a>
            I have seen it called names other than ARP flux--anybody out there
            heard of this called anything besides ARP flux?
          </p></div><div id="ftn.idm1167" class="footnote"><p><a href="#idm1167" class="para"><sup class="para">[14] </sup></a>
              Consider a masquerading firewall which answers ARP requests on a
              public segment for IPs hosted on an internal interface.  This
              amounts to inadvertent exposure of internal addressing, and can be
              used by an attacker as part of a data-gathering or reconaissance
              operation on a network.
            </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-bridging"></a>Chapter 3. Bridging</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#bridging-intro">1. Concepts of Bridging</a></span></dt><dt><span class="section"><a href="#bridging-stp">2. Bridging and Spanning Tree Protocol</a></span></dt><dt><span class="section"><a href="#bridging-packet-filter">3. Bridging and Packet Filtering</a></span></dt><dt><span class="section"><a href="#bridging-tc">4. Traffic Control with a Bridge</a></span></dt><dt><span class="section"><a href="#bridging-ebtables">5. <span class="command"><strong>ebtables</strong></span></a></span></dt></dl></div><p>
    Bridging, once the realm of hardware devices, can also be performed by a
    linux machine.  Along with bridging comes the capability of filtering
    and transforming frames (or even higher layer protocols) via hooks
    at the Ethernet layer with the <span class="command"><strong>ebtables</strong></span> and
    <span class="command"><strong>iptables</strong></span> commands.
  </p><p>
    Linux can function as a bridge, the equivalent of an extremely
    power-thirsty switch.  For now, the best place to go is
    <a class="ulink" href="http://bridge.sourceforge.net/" target="_top">the main linux bridging
    site</a>.
  </p><p>
    Often
    <a class="link" href="#bridging-ebtables" title="5. ebtables"><span class="command"><strong>ebtables</strong></span></a> and
    bridging are used
    together.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridging-intro"></a>1. Concepts of Bridging</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridging-stp"></a>2. Bridging and Spanning Tree Protocol</h2></div></div></div><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridging-packet-filter"></a>3. Bridging and Packet Filtering</h2></div></div></div><p>
    </p><p>
      There is a
      <a class="ulink" href="http://www.tldp.org/HOWTO/Ethernet-Bridge-netfilter-HOWTO.html" target="_top">Bridge
      and Netfilter HOWTO</a> which illustrates the use of a bridge as
      a firewall.
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridging-tc"></a>4. Traffic Control with a Bridge</h2></div></div></div><p>
      Yes, Virginia, it can be done.
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridging-ebtables"></a>5. <span class="command"><strong>ebtables</strong></span></h2></div></div></div><p>
      In order to take advantage of <span class="command"><strong>ebtables</strong></span> the machine
      needs to be running as a bridge.  (Accurate, nicht wahr?)
    </p><p>
      If you believe in really scary stuff, you can run the bridging code with
      netfilter, so you can manipulate IP packets transparently on your
      bridge.  For more on this, see the documentation of
      <a class="ulink" href="http://bridge.sourceforge.net/docs.html" target="_top">bridging and
      firewalling</a>.  The firewall and bridge architecture is part of
      the development branch of the kernel 2.5 series.
    </p><p>
    </p><p>
    </p><p>
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-routing"></a>Chapter 4. IP Routing</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#routing-intro">1. Introduction to Linux Routing</a></span></dt><dt><span class="section"><a href="#routing-local">2. Routing to Locally Connected Networks</a></span></dt><dt><span class="section"><a href="#routing-default">3. Sending Packets Through a Gateway</a></span></dt><dt><span class="section"><a href="#routing-forwarding">4. Operating as a Router</a></span></dt><dt><span class="section"><a href="#routing-selection">5. Route Selection</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-selection-common">5.1. The Common Case</a></span></dt><dt><span class="section"><a href="#routing-selection-adv">5.2. The Whole Story</a></span></dt><dt><span class="section"><a href="#routing-selection-summary">5.3. Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-saddr-selection">6. Source Address Selection</a></span></dt><dt><span class="section"><a href="#routing-cache">7. Routing Cache</a></span></dt><dt><span class="section"><a href="#routing-tables">8. Routing Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-table-entries">8.1. Routing Table Entries (Routes)</a></span></dt><dt><span class="section"><a href="#routing-table-local">8.2. The Local Routing Table</a></span></dt><dt><span class="section"><a href="#routing-table-main">8.3. The Main Routing Table</a></span></dt></dl></dd><dt><span class="section"><a href="#routing-rpdb">9. Routing Policy Database (RPDB)</a></span></dt><dt><span class="section"><a href="#routing-icmp">10. ICMP and Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#routing-icmp-mtu">10.1. MTU, MSS, and ICMP</a></span></dt><dt><span class="section"><a href="#routing-icmp-redirect">10.2. ICMP Redirects and Routing</a></span></dt></dl></dd></dl></div><a class="indexterm" name="idm1404"></a><a class="indexterm" name="idm1407"></a><p>
    Routing is fundamental to the design of the Internet Protocol.  IP
    routing has been cleverly designed to minimize the complexity for leaf
    nodes and networks.  Linux can be used as a leaf node, such as a
    workstation, where setting the IP address, netmask and
    default gateway suffices for all routing needs.  Alternatively, the same
    routing subsystem can be used in the core of a network connecting
    multiple public and private networks.
  </p><p>
    This chapter will begin with the
    <a class="link" href="#routing-intro" title="1. Introduction to Linux Routing">basics of IP routing with linux</a>,
    <a class="link" href="#routing-local" title="2. Routing to Locally Connected Networks">routing to locally connected
    destinations</a>,
    <a class="link" href="#routing-default" title="3. Sending Packets Through a Gateway">routing to destinations through the
    default gateway</a>, and
    <a class="link" href="#routing-forwarding" title="4. Operating as a Router">using linux as a router</a>.
    Subsequent topics will include 
    <a class="link" href="#routing-selection" title="5. Route Selection">the kernel's route selection
    algorithm</a>, the
    <a class="link" href="#routing-cache" title="7. Routing Cache">routing cache</a>,
    <a class="link" href="#routing-tables" title="8. Routing Tables">routing tables</a>, the
    <a class="link" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">routing policy database</a>, and
    <a class="link" href="#routing-icmp" title="10. ICMP and Routing">issues with ICMP and routing</a>.
  </p><p>
    The precinct of this documentation is primarily static routing.  Though 
    dynamic routing is important to large networks, Internet service
    providers, and backbone providers, this documentation is targetted for
    smaller networks, particularly networks which use static routing.
    Nonetheless, the concepts governing the manipulation of a packet in the
    kernel, and how routing decisions are made by the kernel are applicable to
    dynamic routing environments.
  </p><p>
    The linux routing subsystem has been designed with large
    scale networks in mind, without forgetting the need for easy
    configurability for leaf nodes, such as workstations and servers.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-intro"></a>1. Introduction to Linux Routing</h2></div></div></div><p>
      The design of IP routing allows for very simple route
      definitions for small networks, while not hindering the flexibility of
      routing in complex environments.  A key concept in IP routing is
      the ability to define what addresses are locally reachable as opposed to
      not directly known destinations.  Every IP capable host knows about at
      least three classes of destination: itself, locally connected
      computers and everywhere else.
    </p><p>
      Most fully-featured IP-aware networked operating systems
      (all unix-like operating systems with IP stacks,
      modern Macintoshes, and modern Windows) include support for the loopback
      device and IP.  This is an IP and range configured on the host machine
      itself which allows the machine to talk to itself.  Linux systems can
      communicate over IP on any locally configured IP address, whether on the
      loopback device or not.  This is the first class of destinations:
      locally hosted addresses.
    </p><p>
      The second class of IP addresses are addresses in the locally
      connected network segment.  Each machine with a connection to an IP
      network can reach a subset of the entire IP address space on its
      directly connected network interface.
    </p><p>
      All other hosts or destination IPs fall into a third range.  Any IP
      which is not on the machine itself or locally reachable (i.e. connected
      to the same media segment) is only reachable through an IP routing
      device.  This routing device must have an IP address in a locally
      reachable IP address range.
    </p><p>
      All IP networking is a permutation of these three fundamental concepts
      of reachability.   This list summarizes the three possible
      classifications for reachability of destination IP addresses from any
      single source machine.
    </p><a name="list-routing-intro"></a><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
          The IP address is reachable on the machine itself.  Under linux
          this is considered
          <a class="link" href="#tb-tools-ip-addr-scope" title="Table C.2. IP Scope under ip address">scope host</a> and is used
          for IPs bound to any network device including loopback devices,
          and the network range for the loopback device.  Addresses of this
          nature are called local IPs or locally hosted IPs.
        </p></li><li class="listitem"><p>
          The IP address is reachable on the directly connected link layer
          medium.  Addresses of this type are called locally reachable or
          (preferred) directly reachable IPs.
        </p></li><li class="listitem"><p>
          The IP address is ultimately reachable through a router which
          is reachable on a directly connected link layer medium.  This class
          of IP addresses is only reachable through a gateway.
        </p></li></ol></div><p>
      As a practical description of the above, this partial diagram of the
      <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network</a> shows two
      machines connected to 192.168.99.0/24.  On <code class="systemitem">tristan</code> the IP addresses
      127.0.0.1 (loopback--not pictured) and 192.168.99.35 are considered
      locally hosted IP addresses.  The directly reachable IP addresses fall
      inside the 192.168.99.0/24 network.  Any other destination addresses are
      only reachable through a gateway, probably <code class="systemitem">masq-gw</code>.
    </p><div class="example"><a name="routing-intro-classes"></a><p class="title"><b>Example 4.1. Classes of IP addresses</b></p><div class="example-contents"><div class="mediaobject"><a name="image-routing-intro"></a><img src="images/routing-intro.png"></div></div></div><br class="example-break"><p>
      Before examining the routing system in more detail, there are some terms
      to identify and define.  These terms are general IP networking terms 
      and should be familiar to users who have used IP on other operating
      systems and networking equipment.
    </p><div class="variablelist"><a name="list-routing-intro-ipdefs"></a><dl class="variablelist"><dt><a name="list-routing-intro-ipdefs-octet"></a><span class="term">octet</span></dt><dd><a class="indexterm" name="idm1454"></a><a class="indexterm" name="idm1457"></a><p>
            A single number between decimal 0 and 255, hexadecimal 0x00 and
            0xff.  An octet is a single byte in size.
          </p><p>
            Examples: <span class="emphasis"><em>140</em></span>, <span class="emphasis"><em>254</em></span>,
            <span class="emphasis"><em>255</em></span>, <span class="emphasis"><em>1</em></span>,
            <span class="emphasis"><em>0</em></span>, <span class="emphasis"><em>7</em></span>.
          </p></dd><dt><a name="list-routing-intro-ipdefs-ipaddr"></a><span class="term">IP address, </span><span class="term">IP</span></dt><dd><a class="indexterm" name="idm1472"></a><a class="indexterm" name="idm1475"></a><p>
            A locally unique four
            <a class="link" href="#list-routing-intro-ipdefs-octet">octet</a>
            logical identifier which a machine
            can use to communicate using the Internet Protocol.  This
            address is determined by combining the
            <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
            address</a> and the administratively assigned host address.
            Simply put, the IP address is a unique number identifying
            a host on a network.
          </p><p>
            Examples: <span class="emphasis"><em>192.168.99.35</em></span>,
            <span class="emphasis"><em>140.71.38.7</em></span>,
            <span class="emphasis"><em>205.254.210.186</em></span>.
          </p></dd><dt><a name="list-routing-intro-ipdefs-hostaddr"></a><span class="term">host address portion</span></dt><dd><a class="indexterm" name="idm1488"></a><p>
            The rightmost bits (frequently
            <a class="link" href="#list-routing-intro-ipdefs-octet">octets</a>)
            in an
            <a class="link" href="#list-routing-intro-ipdefs-ipaddr">IP
            address</a> which are not a part of the
            <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
            address</a>.  The part of an IP address which identifies the
            computer on a network independent of the network.
          </p><p>
            Examples:  192.168.1.<span class="emphasis"><em>27</em></span>/24,
            10.<span class="emphasis"><em>10.17.24</em></span>/8,
            172.20.<span class="emphasis"><em>158.75</em></span>/16.
          </p></dd><dt><a name="list-routing-intro-ipdefs-netaddr"></a><span class="term">network address, </span><span class="term">network, </span><span class="term">network prefix, </span><span class="term">subnetwork address</span></dt><dd><a class="indexterm" name="idm1505"></a><a class="indexterm" name="idm1508"></a><p>
            A four
            <a class="link" href="#list-routing-intro-ipdefs-octet">octet</a>
            address and
            <a class="link" href="#list-routing-intro-ipdefs-netmask">network
            mask</a>
            identifying the usable range of
            <a class="link" href="#list-routing-intro-ipdefs-ipaddr">IP
            addresses</a>.  Conventional and CIDR notations combine
            the four bare octets with the netmask or prefix length to
            define this address.  Briefly, a network address is the first
            address in a range, and is reserved to identify the entire
            network.
            <a href="#ftn.idm1515" class="footnote" name="idm1515"><sup class="footnote">[15]</sup></a>
          </p><p>
            Examples:  <span class="emphasis"><em>192.168.187.0/24</em></span>,
            <span class="emphasis"><em>205.254.211.192/26</em></span>,
            <span class="emphasis"><em>4.20.17.128/255.255.255.248</em></span>,
            <span class="emphasis"><em>10.0.0.0/255.0.0.0</em></span>,
            <span class="emphasis"><em>12.35.17.112/28</em></span>.
          </p></dd><dt><a name="list-routing-intro-ipdefs-netmask"></a><span class="term">network mask, </span><span class="term">netmask, </span><span class="term">network bitmask</span></dt><dd><a class="indexterm" name="idm1534"></a><a class="indexterm" name="idm1537"></a><a class="indexterm" name="idm1540"></a><p>
            A four-octet set of bits which, when AND'd with a particular
            <a class="link" href="#list-routing-intro-ipdefs-ipaddr">IP
            address</a> produces the
            <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
            address</a>.  Combined with a network address or IP address,
            the netmask identifies the range of IP addresses which are
            directly reachable.
          </p><p>
            Examples:  <span class="emphasis"><em>255.255.255.0</em></span>,
            <span class="emphasis"><em>255.255.0.0</em></span>,
            <span class="emphasis"><em>255.255.192.0</em></span>,
            <span class="emphasis"><em>255.255.255.224</em></span>,
            <span class="emphasis"><em>255.0.0.0</em></span>.
          </p></dd><dt><a name="list-routing-intro-ipdefs-prefix"></a><span class="term">prefix length</span></dt><dd><a class="indexterm" name="idm1555"></a><a class="indexterm" name="idm1558"></a><p>
            An alternate representation of
            <a class="link" href="#list-routing-intro-ipdefs-netmask">network
            mask</a>, this is a single integer between 0 and 32,
            identifying the number of significant bits in an 
            <a class="link" href="#list-routing-intro-ipdefs-ipaddr">IP
            address</a> or
            <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
            address</a>.  This is the "slash-number" component of a
            CIDR address.
          </p><p>
            Examples:  4.20.17.0<span class="emphasis"><em>/24</em></span>,
            66.14.17.116<span class="emphasis"><em>/30</em></span>,
            10.158.42.72<span class="emphasis"><em>/29</em></span>,
            10.48.7.198<span class="emphasis"><em>/9</em></span>,
            192.168.154.64<span class="emphasis"><em>/26</em></span>.
          </p></dd><dt><a name="list-routing-intro-ipdefs-bcast"></a><span class="term">broadcast address</span></dt><dd><a class="indexterm" name="idm1574"></a><a class="indexterm" name="idm1577"></a><p>
            A four
            <a class="link" href="#list-routing-intro-ipdefs-octet">octet</a>
            address derived from an OR operation between the
            <a class="link" href="#list-routing-intro-ipdefs-hostaddr">host address
            portion</a> of a
            <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
            address</a> and the full broadcast special 255.255.255.255.
            The broadcast is the highest allowable address in a given network,
            and is reserved for broadcast traffic.
          </p><p>
            Examples:  <span class="emphasis"><em>192.168.205.255/24</em></span>,
            <span class="emphasis"><em>172.18.255.255/16</em></span>,
            <span class="emphasis"><em>12.7.149.63/26</em></span>.
          </p></dd></dl></div><p>
      These definitions are common to IP networking in general, and are
      understood by all in the IP networking community.  For less terse
      introductory material on matters of IP network addressing in general,
      see
      <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
    </p><p>
      As is apparent from the interdependencies amongst the above
      definitions, each term defines a separate part of the concept of
      the relationships between an IP address and its network.  A good
      <a class="link" href="#tools-ipcalc" title="1. ipcalc and other IP addressing calculators">IP calculator</a> can assist in
      mastering these IP fundamentals.
    </p><div class="example"><a name="ex-routing-intro-ipcalc"></a><p class="title"><b>Example 4.2. Using ipcalc to display IP information</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[user@workstation]$ </code><strong class="userinput"><code>ipcalc -n 12.7.149.0/26</code></strong>

Address:   12.7.149.0            00001100.00000111.10010101.00 000000
Netmask:   255.255.255.192 = 26  11111111.11111111.11111111.11 000000
Wildcard:  0.0.0.63              00000000.00000000.00000000.00 111111
=&gt;
Network:   12.7.149.0/26         00001100.00000111.10010101.00 000000 (Class A)
Broadcast: 12.7.149.63           00001100.00000111.10010101.00 111111
HostMin:   12.7.149.1            00001100.00000111.10010101.00 000001
HostMax:   12.7.149.62           00001100.00000111.10010101.00 111110
Hosts/Net: 62 
      </pre></div></div><br class="example-break"><p>
      A tool similar to the one shown in
      <a class="xref" href="#ex-routing-intro-ipcalc" title="Example 4.2. Using ipcalc to display IP information">Example 4.2, &#8220;Using ipcalc to display IP information&#8221;</a> can assist in visualizing the
      relationships among IP addressing concepts.
    </p><p>
      Subequently, this chapter will introduce some concrete examples of
      routing in a real network.  The
      <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network</a> illustrates
      this network and all of the addresses involved.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-local"></a>2. Routing to Locally Connected Networks</h2></div></div></div><a class="indexterm" name="idm1603"></a><p>
      Any IP network is defined by two sets of numbers: network address and
      netmask.  By convention, there are two ways to represent these two
      numbers.  Netmask notation is the convention and tradition in IP
      networking
      although the more succinct CIDR notation is gaining popularity.
    </p><p>
      In the
      <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network</a>, <code class="systemitem">isolde</code> has
      IP address 192.168.100.17.
      In CIDR notation, <code class="systemitem">isolde</code>'s address is 192.168.100.17/24, and in
      traditional netmask notation, 192.168.100.17/255.255.255.0.
      Any of the
      <a class="link" href="#tools-ipcalc" title="1. ipcalc and other IP addressing calculators">IP calculators</a>, confirms that the
      first usable IP address is 192.168.100.1 and the last usable IP address
      is 192.168.100.254.
      Importantly, the IP network address, 192.168.100.0/24, is reachable
      through the directly connected Ethernet interface (refer to
      <a class="link" href="#list-routing-intro">classification 2</a>).
      Therefore, <code class="systemitem">isolde</code> should be able to reach any IP address in
      this range directly on the locally connected Ethernet segment.
    </p><p>
      Below is the routing table for <code class="systemitem">isolde</code>, first shown with the
      conventional <span class="command"><strong>route -n</strong></span> output
      <a href="#ftn.idm1617" class="footnote" name="idm1617"><sup class="footnote">[16]</sup></a>
      and then with the
      <span class="command"><strong>ip route show</strong></span>
      <a href="#ftn.idm1622" class="footnote" name="idm1622"><sup class="footnote">[17]</sup></a>
      command.  Each of these tools conveys
      the same routing table and operates on the same kernel routing table.
      For more on the routing table displayed in
      <a class="xref" href="#ex-routing-local" title="Example 4.3. Identifying the locally connected networks with route">Example 4.3, &#8220;Identifying the locally connected networks with
        <span class="command">route</span>&#8221;</a>, consult
      <a class="xref" href="#routing-table-main" title="8.3. The Main Routing Table">Section 8.3, &#8220;The Main Routing Table&#8221;</a>.
    </p><div class="example"><a name="ex-routing-local"></a><p class="title"><b>Example 4.3. Identifying the locally connected networks with
        <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.100.254 0.0.0.0         UG    0      0        0 eth0</code>
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.100.0/24 dev eth0  scope link 
127.0.0.0/8 dev lo  scope link 
default via 192.168.100.254 dev eth0</code>
      </pre></div></div><br class="example-break"><p>
      In the above example, the locally reachable destination is
      192.168.100.0/255.255.255.0 which can also be written 192.168.100.0/24
      as in <span class="command"><strong>ip route show</strong></span>.  In classful networking
      terms, the network to which <code class="systemitem">isolde</code> is directly connected is called a
      class C sized network.
    </p><p>
      When a process on <code class="systemitem">isolde</code> needs to send a packet to another
      machine on the locally connected network, packets will be sent from
      192.168.100.17 (<code class="systemitem">isolde</code>'s IP).  The kernel will consult
      the routing table to determine the route and the source address to use
      when sending this packet.
      Assuming the destination is 192.168.100.32, the kernel will find that
      192.168.100.32 falls inside the IP address range 192.168.100.0/24 and
      will select this route for the outbound packet.  For further details on
      source address selection, see
      <a class="xref" href="#routing-saddr-selection" title="6. Source Address Selection">Section 6, &#8220;Source Address Selection&#8221;</a>.  The source address on the
      outbound packet conveys vital information to the host receiving the
      packet.  In order for the packet to be able to return, <code class="systemitem">isolde</code> has to
      use an IP address that is locally available, 192.168.100.32 has to have
      a route to <code class="systemitem">isolde</code> and neither host must block the packet.
    </p><p>
      The packet will be sent to the locally connected network segment
      directly, because <code class="systemitem">isolde</code> interprets from the routing table 
      that 192.168.100.32 is directly reachable through the physical network
      connection on eth0.
    </p><p>
      Occasionally, a machine will be directly connected to two different
      IP networks on the same device.
      The routing table will show that both networks are reachable through
      the same physical device.  For more on this topic, see
      <a class="xref" href="#adv-media-share" title="2. Multiple IP Networks on one Ethernet Segment">Section 2, &#8220;Multiple IP Networks on one Ethernet Segment&#8221;</a>.  Similarly, multi-homed hosts will
      have routes for all locally connected networks through the
      locally-connected network interface.  For more on this sort of
      configuration, see
      <a class="xref" href="#adv-multi-homed" title="6. Multihomed Hosts">Section 6, &#8220;Multihomed Hosts&#8221;</a>.
    </p><p>
      This covers the classification of IP destinations which are available on
      a locally connected network.  This highlights the importance of an
      accurate netmask and network address.  The next section will cover
      IP ranges which are neither locally hosted 
      nor fall in the range of the locally reachable networks. These
      destinations must be reached through a router.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-default"></a>3. Sending Packets Through a Gateway</h2></div></div></div><a class="indexterm" name="idm1656"></a><p>
      By comparison to the total number of publicly accessible hosts on the
      Internet there is an almost insignificant number of hosts inside any
      locally reachable network.  This means that the majority of potential
      destinations are only available via a router.
    </p><p>
      Any machine which will accept and forward packets between two networks
      is a router.  Every router is at least dual-homed; one interface
      connects to one network, and a second interface connects to another
      network.  This interface is frequently an independent NIC, although it
      might be a virtual interface, such as a VLAN interface.  Machines
      connected to either network learn by a routing protocol or are
      statically configured to pass traffic for the other network to the
      router.
    </p><p>
      For <code class="systemitem">tristan</code>, there are two different paths out of 192.168.99.0/24.
      One path has another leaf network, 192.168.98.0/24, and the other path
      has many networks, including the Internet.  The routing table on
      <code class="systemitem">tristan</code> should then contain two different routes out of the network.
      One destination 192.168.98.0/24 will be reachable through 192.168.99.1.
      So, if <code class="systemitem">tristan</code> has a packet with a destination IP address in the range
      of the branch office network, it will choose to send the packet directly
      to <code class="systemitem">isdn-router</code>.
    </p><p>
      The default route is another way to say the route for destination 0/0.
      This is the most general possible route.
      It is the catch-all route.  If no more specific
      route exists in a routing table, a default route will be used.
      Many servers and workstations are connected to leaf networks
      with only one router, hence
      <a class="xref" href="#ex-routing-local" title="Example 4.3. Identifying the locally connected networks with route">Example 4.3, &#8220;Identifying the locally connected networks with
        <span class="command">route</span>&#8221;</a>
      shows a very common sort of routing table.  There's a route for
      localhost, for the locally connected IP network, and a default
      route.
    </p><p>
      For Internet-connected hosts, the default route is customarily set to
      the IP of the locally reachable router which has a path to the Internet.
      Each router in turn has a default gateway pointing to another
      Internet-connected router until the packet is handed off to an Internet
      Service Provider's network.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-forwarding"></a>4. Operating as a Router</h2></div></div></div><a class="indexterm" name="idm1671"></a><a class="indexterm" name="idm1674"></a><a class="indexterm" name="idm1676"></a><a class="indexterm" name="idm1679"></a><p>
      Operating as a router allows a linux machine to accept packets on one
      interface and transmit them on another.  This is the nature of a router.
      The process of accepting and transmitting IP packets is known as
      forwarding.  IP forwarding is a requirement for many of the networking
      techniques identified here.  Stateless NAT and firewalling, transparent
      proxying and masquerading all require the support of IP forwarding in
      order to function correctly.
    </p><p>
      The sysctl <code class="filename">net/ipv4/ip_forward</code> toggles the IP
      forwarding functionality on a linux box.  Note that setting this sysctl
      alters other routing-related sysctl entries, so it is wise to set this
      first, and then alter other entries.
      Frequently, an administrator will forget this simple and crucial detail
      when configuring a new machine to operate as a router only to be
      frustrated at the simple error.
    </p><p>
      The sysctl <code class="filename">net/ipv4/conf/$DEV/forward</code> defaults to
      the value of <code class="filename">net/ipv4/ip_forward</code>, but can be
      independently modified.  In order to allow forwarding of packets between
      two interfaces while prohibiting such behaviour on a third interface,
      this sysctl can be employed.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-selection"></a>5. Route Selection</h2></div></div></div><a class="indexterm" name="idm1691"></a><p>
      Crucial to the proper ability of hosts to exchange IP packets is the
      correct selection of a route to the destination.  The rules for the
      selection of route path are traditionally made on a
      
      hop-by-hop basis
      <a href="#ftn.idm1694" class="footnote" name="idm1694"><sup class="footnote">[18]</sup></a>
      based solely upon the destination address of the packet.  Linux
      behaves as a conventional routing device in this way, but can also 
      provide a more flexible capability.  Routes can be chosen and
      prioritized based on other packet characteristics.
    </p><p>
      The route selection algorithm under linux has been generalized to
      enable the powerful latter scenario without complicating the
      overwhelmingly common case of the former scenario.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-selection-common"></a>5.1. The Common Case</h3></div></div></div><p>
        The above sections on routing to a
        <a class="link" href="#routing-local" title="2. Routing to Locally Connected Networks">local network</a> and
        <a class="link" href="#routing-default" title="3. Sending Packets Through a Gateway">the default gateway</a>
        expose the importance of destination address for route selection.
        In this simplified model, the kernel need only know the destination
        address of the packet, which it compares against the routing tables to
        determine the route by which to send the packet.
      </p><p>
        The kernel searches for a matching entry for the destination first in
        the routing cache and then the main routing table.
        In the case that the machine has recently transmitted a
        packet to the destination address, the
        <a class="link" href="#routing-cache" title="7. Routing Cache">routing cache</a> will contain an
        entry for the destination.  The kernel will select the same route, and
        transmit the packet accordingly.
      </p><p>
        If the linux machine has not recently transmitted a packet to this
        destination address, it will look up the destination in its routing
        table using a technique known longest prefix match
        <a href="#ftn.idm1705" class="footnote" name="idm1705"><sup class="footnote">[19]</sup></a>.
        In practical terms, the concept of longest prefix match means that the
        most specific route to the destination will be chosen.
      </p><a name="routing-selection-lpm"></a><a class="indexterm" name="idm1709"></a><a class="indexterm" name="idm1712"></a><p>
        The use of the
        longest prefix match allows routes for large networks to be
        overridden by more specific host or network routes, as required in
        <a class="xref" href="#ex-basic-del-static" title="Example 1.10. Removing a static network route and adding a static host route">Example 1.10, &#8220;Removing a static network route and adding a static host
          route&#8221;</a>, for example.  Conversely, it is
        this same property of longest prefix match which allows routes to
        individual destinations to be aggregated into larger network
        addresses.  Instead of entering individual routes for each host, large
        numbers of contiguous network addresses can be aggregated.  This is
        the realized promise of CIDR networking.  See
        <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a> for further details.
      </p><p>
        In the common case, route selection is based completely on the
        destination address.  Conventional (as opposed to policy-based) IP
        networking relies on only the destination address to select a route
        for a packet.
      </p><p>
        Because the majority of linux systems have no need of policy
        based routing
        features, they use the conventional routing technique of longest
        prefix match.  While this meets the needs of a large subset of
        linux networking needs, there are unrealized policy routing features
        in a machine operating in this fashion.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-selection-adv"></a>5.2. The Whole Story</h3></div></div></div><p>
        With the prevalence of low cost bandwidth, easily configured VPN
        tunnels, and increasing reliance on networks, the technique of
        selecting a route based solely on the destination IP address range no
        longer suffices for all situations.
        The discussion of the common case
        of route selection under linux neglects one
        of the most powerful features in the linux IP stack.
        Since kernel 2.2, linux has
        supported policy based routing through the use of
        <a class="link" href="#routing-tables" title="8. Routing Tables">multiple routing tables</a> and the
        <a class="link" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">routing policy database (RPDB)</a>.
        Together, they allow a network
        administrator to configure a machine select different routing
        tables and routes based on a number of criteria.
      </p><p>
        Selectors available for use in policy-based routing are
        attributes of a packet
        passing through the linux routing code.  The source address of a
        packet, the ToS flags, an fwmark (a mark carried through the kernel in
        the data structure representing the packet), and the interface name on
        which the packet was received are attributes which can be used as
        selectors.  By selecting a routing table based
        on packet attributes, an administrator can have
        granular control over the network path of any packet.
      </p><p>
        With this knowledge of the RPDB and multiple
        routing tables, let's revisit in detail the method by which the
        kernel selects the proper route for a packet.  Understanding
        the series of steps the kernel takes for route selection should
        demystify advanced routing.  In fact, advanced routing could more
        accurately be called policy-based networking.
      </p><p>
        When determining the route by which to send a packet, the kernel always
        <a class="link" href="#routing-cache" title="7. Routing Cache">consults the routing cache first</a>.
        The routing cache is a hash table used for quick access to recently
        used routes.  If the kernel finds an entry in the routing cache, the
        corresponding entry will be used.  If there is no entry in the
        routing cache, the kernel begins the process of route selection.  For
        details on the method of matching a route in the routing cache, see
        <a class="xref" href="#routing-cache" title="7. Routing Cache">Section 7, &#8220;Routing Cache&#8221;</a>.
      </p><p>
        The kernel begins iterating by priority through the routing policy
        database.  For each matching entry in the RPDB, the kernel will try to
        find a matching route to the destination IP
        address in the specified routing table using the aforementioned
        longest prefix match selection algorithm.  When a matching destination
        is found, the kernel will select the matching route, and forward the
        packet.  If no matching entry is found in the specified routing table,
        the kernel will pass to the next rule in the RPDB, until it finds a
        match or falls through the end of the RPDB and all consulted routing
        tables.
      </p><p>
        Here is a snippet of python-esque pseudocode to illustrate the
        kernel's route selection process again.  Each of the lookups below
        occurs in kernel hash tables which are accessible to the user through
        the use of various <span class="command"><strong>iproute2</strong></span> tools.
        <a class="indexterm" name="idm1733"></a>
        </p><div class="example"><a name="routing-selection-algorithm"></a><p class="title"><b>Example 4.4. Routing Selection Algorithm in Pseudo-code</b></p><div class="example-contents"><pre class="programlisting">
if packet.routeCacheLookupKey in routeCache :
    route = routeCache[ packet.routeCacheLookupKey ]
else
    for rule in rpdb :
        if packet.rpdbLookupKey in rule :
            routeTable = rule[ lookupTable ]
            if packet.routeLookupKey in routeTable :
                route = route_table[ packet.routeLookup_key ]
          </pre></div></div><p><br class="example-break">



        This pseudocode provides some explanation of the decisions
        required to find a route.  The final piece of information
        required to understand the decision making process is the lookup
        process for each of the three hash table lookups.  In
        <a class="xref" href="#tb-routing-selection-adv" title="Table 4.1. Keys used for hash table lookups during route selection">Table 4.1, &#8220;Keys used for hash table lookups during route selection&#8221;</a>, each key is listed in order
        of importance.  Optional keys are listed in italics and represent keys
        that will be matched if they are present.
      </p><a class="indexterm" name="idm1740"></a><div class="table"><a name="tb-routing-selection-adv"></a><p class="title"><b>Table 4.1. Keys used for hash table lookups during route selection</b></p><div class="table-contents"><table class="table" summary="Keys used for hash table lookups during route selection" border="1"><colgroup><col><col><col></colgroup><thead><tr><th align="center">route cache</th><th align="center">RPDB</th><th align="center">route table</th></tr></thead><tbody><tr><td align="center">destination</td><td align="center">source</td><td align="center">destination</td></tr><tr><td align="center">source</td><td align="center"><span class="emphasis"><em>destination</em></span></td><td align="center"><span class="emphasis"><em>ToS</em></span></td></tr><tr><td align="center"><span class="emphasis"><em>ToS</em></span></td><td align="center"><span class="emphasis"><em>ToS</em></span></td><td align="center"><span class="emphasis"><em><a class="link" href="#tb-tools-ip-addr-scope" title="Table C.2. IP Scope under ip address">scope</a></em></span></td></tr><tr><td align="center"><span class="emphasis"><em>fwmark</em></span></td><td align="center"><span class="emphasis"><em>fwmark</em></span></td><td align="center"><span class="emphasis"><em>oif</em></span></td></tr><tr><td align="center"><span class="emphasis"><em>iif</em></span></td><td align="center"><span class="emphasis"><em>iif</em></span></td><td align="center"> </td></tr></tbody></table></div></div><br class="table-break"><p>
        The route cache (also the forwarding information base) can be
        displayed using
        <a class="link" href="#tools-ip-route-show-cache" title="2.2. Displaying the routing cache with ip route show cache"><span class="command"><strong>ip route show
        cache</strong></span></a>.  The routing policy database (RPDB) can be
        manipulated with the
        <a class="link" href="#tools-ip-rule" title="3. ip rule"><span class="command"><strong>ip rule</strong></span></a>
        utility.  Individual route tables can be manipulated and displayed
        with the
        <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip route</strong></span></a>
        command line tool.
      </p><div class="example"><a name="ex-routing-selection-adv-ip-rule"></a><p class="title"><b>Example 4.5. Listing the Routing Policy Database (RPDB)</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local
32766:  from all lookup main
32767:  from all lookup 253</code>
        </pre></div></div><br class="example-break"><p>
        Observation of the output of <span class="command"><strong>ip rule show</strong></span> in
        <a class="xref" href="#ex-routing-selection-adv-ip-rule" title="Example 4.5. Listing the Routing Policy Database (RPDB)">Example 4.5, &#8220;Listing the Routing Policy Database (RPDB)&#8221;</a>
        on a box whose RPDB has not been changed should reveal a
        high priority rule, rule 0.  This rule, created at RPDB
        initialization, instructs the kernel to try to find a match for the
        destination in the
        <a class="link" href="#routing-table-local" title="8.2. The Local Routing Table">local routing table</a>.  If
        there is no match for the packet in the local routing table, then,
        per rule 32766, the kernel will perform a route lookup in the
        main routing table.  Normally, the main routing table will contain a
        default route if not a more specific route.
        Failing a route lookup in the main routing table the final rule
        (32767) instructs the kernel to perform a route lookup in table 253.
      </p><p>
        A common mistake when working with multiple routing tables involves
        forgetting about the statelessness of IP routing.  This manifests when
        the user configuring the policy routing machine accounts for outbound
        packets (via <code class="constant">fwmark</code>, or <span class="command"><strong>ip rule</strong></span>
        selectors), but forgets to account for the return packets.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-selection-summary"></a>5.3. Summary</h3></div></div></div><p>
        For more ideas on how to use policy routing, how to work with
        multiple routing tables, and how to troubleshoot, see
        <a class="xref" href="#adv-rpdb" title="3. Using the Routing Policy Database and Multiple Routing Tables">Section 3, &#8220;Using the Routing Policy Database and Multiple Routing
      Tables&#8221;</a>.
      </p><p>
        Yeah.  That's it.  So there.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-saddr-selection"></a>6. Source Address Selection</h2></div></div></div><a class="indexterm" name="idm1810"></a><p>
      The selection of the correct source address is key to correct
      communication between hosts with multiple IP addresses.  If a host
      chooses an address from a private network to communicate with a public
      Internet host, it is likely that the return half of the communication
      will never arrive.
    </p><p>
    </p><p>
      The initial source address for an outbound packet is chosen in according
      to the following series of rules.  The application can request a
      particular IP
      <a href="#ftn.idm1816" class="footnote" name="idm1816"><sup class="footnote">[20]</sup></a>,
      the kernel will use the <code class="constant">src</code> hint from the chosen
      route path
      <a href="#ftn.idm1824" class="footnote" name="idm1824"><sup class="footnote">[21]</sup></a>,
      or, lacking this hint, the kernel will choose the first address
      configured on the interface which falls in the same network as the
      destination address or the nexthop router.
    </p><p>
      The following list recapitulates the manner by which the kernel
      determines what the source address of an outbound packet.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          The application is already using the socket, in which case, the
          source address has been chosen.  Also, the application can
          specifically request a particular address (not necessarily a 
          locally hosted IP; see
          <a class="xref" href="#adv-nonlocal-bind" title="7. Binding to Non-local Addresses">Section 7, &#8220;Binding to Non-local Addresses&#8221;</a>) using the
          <code class="function">bind</code> call.
        </p></li><li class="listitem"><p>
          The kernel performs a
          <a class="link" href="#routing-selection" title="5. Route Selection">route lookup</a> and finds an
          outbound route for the destination.  If the route contains the 
          <code class="constant">src</code> parameter, the kernel selects this IP
          address for the outbound packet.
        </p></li><li class="listitem"><p>
        </p></li></ul></div><p>
    </p><p>
    </p><p>
      Also refer to this
      <a class="ulink" href="http://linux-ip.net/gl/ip-cref/node155.html" target="_top">excerpt</a>
      from the <span class="command"><strong>iproute2</strong></span> command reference.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-cache"></a>7. Routing Cache</h2></div></div></div><a class="indexterm" name="idm1847"></a><a class="indexterm" name="idm1849"></a><p>
      The routing cache is also known as the forwarding information base (FIB).
      This term may be familiar to users of other routing systems.
    </p><p>
      The routing cache stores recently used routing entries in a fast and
      convenient hash lookup table, and is consulted before the routing
      tables.  If the kernel finds a matching entry during route cache lookup,
      it will forward the packet immediately and stop traversing the routing
      tables.
    </p><p>
      Because the routing cache is maintained by the kernel separately from
      the routing tables, manipulating the routing tables may not have an
      immediate effect on the kernel's choice of path for a given packet.
      To avoid a non-deterministic lag between the time that a new route
      is entered into the kernel routing tables and the time that a new lookup
      in those route tables is performed, use
      <a class="link" href="#tools-ip-route-flush-cache" title="2.10. ip route flush cache"><span class="command"><strong>ip route flush
      cache</strong></span></a>.  Once the route cache has been emptied, new
      route lookups (if not by a packet, then manually with
      <a class="link" href="#tools-ip-route-get" title="2.8. Programmatically fetching route information with ip route get"><span class="command"><strong>ip route
      get</strong></span></a>) will result in a new lookup to the kernel routing
      tables.
    </p><p>
      The following is a listing of the hash lookup keys 
      in the routing cache and a description of each key.  Compare this list
      with the elements identified in
      <a class="xref" href="#tb-routing-selection-adv" title="Table 4.1. Keys used for hash table lookups during route selection">Table 4.1, &#8220;Keys used for hash table lookups during route selection&#8221;</a>.
    </p><div class="variablelist"><a name="list-routing-cache-lookup-keys"></a><dl class="variablelist"><dt><a name="list-routing-cache-lookup-keys-dst"></a><span class="term">dst, </span><span class="term">Destination Address</span></dt><dd><a class="indexterm" name="idm1866"></a><p>
            The destination IP address of the packet.  This is the destination
            address on the packet at the time of the route lookup. The address
            is a host address.  All 32 bits are significant during this lookup.
          </p></dd><dt><a name="list-routing-cache-lookup-keys-src"></a><span class="term">src, </span><span class="term">Source Address</span></dt><dd><a class="indexterm" name="idm1875"></a><p>
            The source IP address of the packet.  This is the source address
            on the packet at the time of the route lookup.  The address is a
            host address.  All 32 bits are significant during this lookup.
          </p></dd><dt><a name="list-routing-cache-lookup-keys-tos"></a><span class="term">tos, </span><span class="term">Type of Service</span></dt><dd><a class="indexterm" name="idm1884"></a><p>
            The ToS marking on the packet.  If there is no ToS marking on the
            packet (tos == 0), this lookup key is unused.  If there is a ToS
            marking, the kernel will search for a match with this ToS value.
            If no matching (dst, src, tos) is found, the kernel will continue
            the search for a route by traversing the RPDB.
          </p></dd><dt><a name="list-routing-cache-lookup-keys-fwmark"></a><span class="term">fwmark</span></dt><dd><a class="indexterm" name="idm1892"></a><p>
            The mark on a packet added administratively by the packet
            filtering engine (<span class="command"><strong>ipchains</strong></span> or
            <span class="command"><strong>iptables</strong></span>).
            This mark is not part of the physical IP packet, and only exists
            as part of the data structure held in memory on the routing device
            to represent the IP
            packet.  If there is no fwmark on the packet, this lookup key is
            unused.  When present, the kernel will search for a matching 
            (dst, src, tos?, fwmark) entry.  If no matching entry is found,
            the kernel will continue the search for a route by traversing the
            RPDB.
          </p></dd><dt><a name="list-routing-cache-lookup-keys-iif"></a><span class="term">iif, </span><span class="term">inbound interface</span></dt><dd><a class="indexterm" name="idm1903"></a><p>
            The name of the interface on which the packet arrived.
          </p></dd></dl></div><p>
    </p><p>
      The following attributes may be stored for each entry in the routing
      cache.
    </p><div class="variablelist"><a name="list-routing-cache-attrs"></a><dl class="variablelist"><dt><a name="list-routing-cache-attrs-cwnd"></a><span class="term">cwnd, </span><span class="term">FIXME Window</span></dt><dd><a class="indexterm" name="idm1915"></a><p>
            FIXME.  A) I don't know what it is.
                    B) I don't know how to describe it.
          </p></dd><dt><a name="list-routing-cache-attrs-advmss"></a><span class="term">advmss, </span><span class="term">Advertised Maximum Segment Size</span></dt><dd><a class="indexterm" name="idm1924"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-src"></a><span class="term">src, </span><span class="term">(Preferred Local) Source Address</span></dt><dd><a class="indexterm" name="idm1933"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-mtu"></a><span class="term">mtu, </span><span class="term">Maximum Transmission Unit</span></dt><dd><a class="indexterm" name="idm1942"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-rtt"></a><span class="term">rtt, </span><span class="term">Round Trip Time</span></dt><dd><a class="indexterm" name="idm1951"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-rttvar"></a><span class="term">rttvar, </span><span class="term">Round Trip Time Variation</span></dt><dd><a class="indexterm" name="idm1960"></a><p>
            FIXME.  Gotta find some references to this, too.
          </p></dd><dt><a name="list-routing-cache-attrs-age"></a><span class="term">age</span></dt><dd><a class="indexterm" name="idm1968"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-users"></a><span class="term">users</span></dt><dd><a class="indexterm" name="idm1976"></a><p>
          </p></dd><dt><a name="list-routing-cache-attrs-used"></a><span class="term">used</span></dt><dd><a class="indexterm" name="idm1984"></a><p>
          </p></dd></dl></div><p>
      Collectively the hash keys uniquely identify routes in the forwarding
      information base (routing cache) and each entry provides attributes of
      the route.
    </p><p>
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-tables"></a>8. Routing Tables</h2></div></div></div><a class="indexterm" name="idm1995"></a><p>
      Linux kernel 2.2 and 2.4 support multiple routing tables
      <a href="#ftn.idm1999" class="footnote" name="idm1999"><sup class="footnote">[22]</sup></a>.
      Beyond the two commonly used routing tables
      (<a class="link" href="#routing-table-local" title="8.2. The Local Routing Table">the local</a> and
      <a class="link" href="#routing-table-main" title="8.3. The Main Routing Table">main</a> routing tables), the
      kernel supports up to 252 additional routing tables.
    </p><p>
      The multiple routing table system provides a flexible infrastructure on
      top of which to implement policy routing.  By allowing multiple
      traditional routing tables (keyed primarily to destination address)
      to be combined with the
      <a class="link" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">routing policy database (RPDB)</a>
      (keyed primarily to source address), the
      kernel supports a well-known and well-understood interface while
      simultaneously expanding and extending its routing capabilities.
      Each routing table still operates in the traditional and expected
      fashion.  Linux simply allows you to choose from a
      number of routing tables, and to traverse routing tables in a
      user-definable sequence until a matching route is found.
    </p><a name="routing-tables-keys"></a><a class="indexterm" name="idm2007"></a><p>
      Any given routing table can contain an arbitrary number of entries,
      each of which is keyed on the following characteristics (cf.
      <a class="xref" href="#tb-routing-selection-adv" title="Table 4.1. Keys used for hash table lookups during route selection">Table 4.1, &#8220;Keys used for hash table lookups during route selection&#8221;</a>)
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            destination address; a network or host address (primary key)
          </p></li><li class="listitem"><p>
            tos; Type of Service
          </p></li><li class="listitem"><p>
            <a class="link" href="#tb-tools-ip-addr-scope" title="Table C.2. IP Scope under ip address">scope</a>
          </p></li><li class="listitem"><p>
            output interface
          </p></li></ul></div><p>
    </p><p>
      For practical purposes, this means that (even) a single routing table can
      contain multiple routes to the same destination if the ToS differs
      on each route or if the route applies to a different interface
      <a href="#ftn.idm2023" class="footnote" name="idm2023"><sup class="footnote">[23]</sup></a>.
    </p><p>
      Kernels supporting multiple routing tables refer to routing tables by
      unique integer slots between 0 and 255
      <a href="#ftn.idm2026" class="footnote" name="idm2026"><sup class="footnote">[24]</sup></a>.
      The two routing tables normally employed are
      <a class="link" href="#routing-table-local" title="8.2. The Local Routing Table">table 255, the
      <code class="constant">local</code> routing table</a>, and
      <a class="link" href="#routing-table-main" title="8.3. The Main Routing Table">table 254, the
      <code class="constant">main</code> routing table</a>.  For
      examples of using multiple routing tables, see
      <a class="xref" href="#ch-advanced" title="Chapter 9. Advanced IP Management">Chapter 9, <i>Advanced IP Management</i></a>, in particular,
      <a class="xref" href="#ex-adv-multi-internet-outbound-ip-routing" title="Example 10.1. Multiple Outbound Internet links, part I; ip route">Example 10.1, &#8220;Multiple Outbound Internet links, part I;
          <span class="command">ip route</span>&#8221;</a>,
      <a class="xref" href="#ex-adv-multi-internet-outbound-ip-rule" title="Example 10.3. Multiple Outbound Internet links, part III; ip rule">Example 10.3, &#8220;Multiple Outbound Internet links, part III;
          <span class="command">ip rule</span>&#8221;</a> and 
      <a class="xref" href="#ex-adv-multi-internet-inbound" title="Example 10.4. Multiple Internet links, inbound traffic; using iproute2 only">Example 10.4, &#8220;Multiple Internet links, inbound traffic; using
          <span class="command">iproute2</span> only
          
        &#8221;</a>.  Also be sure
      to read
      <a class="xref" href="#adv-rpdb" title="3. Using the Routing Policy Database and Multiple Routing Tables">Section 3, &#8220;Using the Routing Policy Database and Multiple Routing
      Tables&#8221;</a> and 
      <a class="xref" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">Section 9, &#8220;Routing Policy Database (RPDB)&#8221;</a>.
    </p><p>
      The <span class="command"><strong>ip route</strong></span> and <span class="command"><strong>ip rule</strong></span> commands
      have built in support for the special tables <code class="constant">main</code> and <code class="constant">local</code>.
      Any other routing tables can be referred to by number or an
      administratively maintained mapping file,
      <code class="filename">/etc/iproute2/rt_tables</code>.
    </p><p>
      The format of this file is extraordinarily simple.  Each line represents
      one mapping of an arbitrary string to an integer.  Comments are allowed.
    </p><div class="example"><a name="ex-routing-tables-rt-table"></a><p class="title"><b>Example 4.6. Typical content of
        <code class="filename">/etc/iproute2/rt_tables</code></b></p><div class="example-contents"><pre class="programlisting">
<code class="computeroutput">#
# reserved values
#
255     local      <a class="co" name="id-rtrt-local" href="#id-rtrt-local-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
254     main       <a class="co" name="id-rtrt-main" href="#id-rtrt-main-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
253     default    <a class="co" name="id-rtrt-default" href="#id-rtrt-default-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
0       unspec     <a class="co" name="id-rtrt-unspec" href="#id-rtrt-unspec-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
#
# local
#
1      inr.ruhep   <a class="co" name="id-rtrt-user" href="#id-rtrt-user-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a></code>
      </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="id-rtrt-local-text"></a><a href="#id-rtrt-local"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
              The <code class="constant">local</code> table is a special routing table maintained by the
              kernel.  Users can remove entries from the local routing table
              at their own risk.  Users cannot add entries to the local
              routing table.  The file
              <code class="filename">/etc/iproute2/rt_tables</code> need not exist, as
              the <span class="command"><strong>iproute2</strong></span> tools have a hard-coded entry for the <code class="constant">local</code>
              table.
            </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="id-rtrt-main-text"></a><a href="#id-rtrt-main"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
              The main routing table is the table operated upon by
              <span class="command"><strong>route</strong></span> and, when not otherwise specified, by
              <span class="command"><strong>ip route</strong></span>.  The file
              <code class="filename">/etc/iproute2/rt_tables</code> need not exist, as
              the <span class="command"><strong>iproute2</strong></span> tools have a hard-coded entry for the <code class="constant">main</code>
              table.
            </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="id-rtrt-default-text"></a><a href="#id-rtrt-default"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
              The <code class="constant">default</code> routing table is another
              special routing table, but WHY is it special!?!
            </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="id-rtrt-unspec-text"></a><a href="#id-rtrt-unspec"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
              Operating on the <code class="constant">unspec</code> routing table
              appears to operate on all routing tables simultaneously.  Is
              this true!?  What does that imply?
            </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="id-rtrt-user-text"></a><a href="#id-rtrt-user"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
              This is an example indicating that table 1 is known by the name
              inr.ruhep.  Any references to <strong class="userinput"><code>table
              inr.ruhep</code></strong> in an <span class="command"><strong>ip rule</strong></span>
              or <span class="command"><strong>ip route</strong></span> will substitue the
              value 1 for the word inr.ruhep.
            </td></tr></table></div></div></div><br class="example-break"><p>
      The routing table manipulated by the conventional
      <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a> command
      is the <code class="constant">main</code> routing table.  Additionally, the use of both
      <a class="link" href="#tools-ip-address" title="2. ip address"><span class="command"><strong>ip address</strong></span></a> and
      <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a>
      will cause the kernel to alter the local routing table (and usually the
      main routing table).  For further documentation on how to manipulate
      the other routing tables, see the command description of
      <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip route</strong></span></a>.
    </p><p>
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-table-entries"></a>8.1. Routing Table Entries (Routes)</h3></div></div></div><a class="indexterm" name="idm2095"></a><a class="indexterm" name="idm2098"></a><p>
        Each routing table can contain an arbitrary number of route entries.
        Aside from the
        <a class="link" href="#routing-table-local" title="8.2. The Local Routing Table">local routing table</a>, which
        is maintained by the kernel, and the
        <a class="link" href="#routing-table-main" title="8.3. The Main Routing Table">main routing table</a> which is
        partially maintained by the kernel, 
        all routing tables are controlled by the administrator or routing
        software.  All routes on a machine can be changed or removed
        <a href="#ftn.idm2104" class="footnote" name="idm2104"><sup class="footnote">[25]</sup></a>.
      </p><p>
        Each of the following route types is available for use with
        the <span class="command"><strong>ip route</strong></span> command.  Each route type causes a
        particular sort of behaviour, which is identified in the textual
        description.  Compare the route types described below with the
        <a class="link" href="#list-routing-rule-types">rule types</a> available
        for use in the RPDB.
      </p><div class="variablelist"><a name="list-routing-route-types"></a><dl class="variablelist"><dt><a name="list-routing-route-types-unicast"></a><span class="term">unicast</span></dt><dd><a class="indexterm" name="idm2113"></a><p>
              A unicast route is the most common route in routing tables.
              This is a typical route to a destination network address, which
              describes the path to the destination.  Even complex routes,
              such as nexthop routes are considered unicast routes.  If no
              route type is specified on the command line, the route is
              assumed to be a unicast route.
            </p><div class="example"><a name="ex-list-route-unicast"></a><p class="title"><b>Example 4.7. unicast route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add unicast 192.168.0.0/24 via 192.168.100.5</code></strong>
<strong class="userinput"><code>ip route add default via 193.7.255.1</code></strong>
<strong class="userinput"><code>ip route add unicast default via 206.59.29.193</code></strong>
<strong class="userinput"><code>ip route add 10.40.0.0/16 via 10.72.75.254</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-broadcast"></a><span class="term">broadcast</span></dt><dd><a class="indexterm" name="idm2128"></a><p>
              This route type is used for link layer devices (such as Ethernet
              cards) which support the notion of a broadcast address.  This
              route type is used only in the local routing table
              <a href="#ftn.idm2133" class="footnote" name="idm2133"><sup class="footnote">[26]</sup></a>
              and is typically handled by the kernel.
            </p><div class="example"><a name="ex-list-route-broadcast"></a><p class="title"><b>Example 4.8. broadcast route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add table local broadcast 10.10.20.255 dev eth0 proto kernel scope link src 10.10.20.67</code></strong>
<strong class="userinput"><code>ip route add table local broadcast 192.168.43.31 dev eth4 proto kernel scope link src 192.168.43.14</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-local"></a><span class="term">local</span></dt><dd><a class="indexterm" name="idm2143"></a><p>
              The kernel will add entries into the local routing table when
              IP addresses are added to an interface.  This means that the IPs
              are locally hosted IPs
              <a href="#ftn.idm2148" class="footnote" name="idm2148"><sup class="footnote">[27]</sup></a>.
            </p><div class="example"><a name="ex-list-route-local"></a><p class="title"><b>Example 4.9. local route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add table local local 10.10.20.64 dev eth0 proto kernel scope host src 10.10.20.67</code></strong>
<strong class="userinput"><code>ip route add table local local 192.168.43.12 dev eth4 proto kernel scope host src 192.168.43.14</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-nat"></a><span class="term">nat</span></dt><dd><a class="indexterm" name="idm2158"></a><p>
              This route entry is added by the kernel in the local routing
              table, when the user attempts to configure stateless NAT. See
              <a class="xref" href="#nat-stateless" title="3. Stateless NAT with iproute2">Section 3, &#8220;Stateless NAT with <span class="command"><strong>iproute2</strong></span>&#8221;</a> for a fuller discussion of
              network address translation in general.
              <a href="#ftn.idm2164" class="footnote" name="idm2164"><sup class="footnote">[28]</sup></a>.
            </p><div class="example"><a name="ex-list-route-nat"></a><p class="title"><b>Example 4.10. nat route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add nat 193.7.255.184 via 172.16.82.184</code></strong>
<strong class="userinput"><code>ip route add nat 10.40.0.0/16 via 172.40.0.0</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-unreachable"></a><span class="term">unreachable</span></dt><dd><a class="indexterm" name="idm2174"></a><p>
              When a request for a routing decision returns a destination
              with an unreachable route type, an ICMP unreachable is
              generated and returned to the source address.
            </p><div class="example"><a name="ex-list-route-unreachable"></a><p class="title"><b>Example 4.11. unreachable route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add unreachable 172.16.82.184</code></strong>
<strong class="userinput"><code>ip route add unreachable 192.168.14.0/26</code></strong>
<strong class="userinput"><code>ip route add unreachable 209.10.26.51</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-prohibit"></a><span class="term">prohibit</span></dt><dd><a class="indexterm" name="idm2188"></a><p>
              When a request for a routing decision returns a destination with
              a prohibit route type, the kernel generates an ICMP prohibited
              to return to the source address.
            </p><div class="example"><a name="ex-list-route-prohibit"></a><p class="title"><b>Example 4.12. prohibit route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add prohibit 10.21.82.157</code></strong>
<strong class="userinput"><code>ip route add prohibit 172.28.113.0/28</code></strong>
<strong class="userinput"><code>ip route add prohibit 209.10.26.51</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-blackhole"></a><span class="term">blackhole</span></dt><dd><a class="indexterm" name="idm2202"></a><p>
              A packet matching a route with the route type blackhole is
              discarded.  No ICMP is sent and no packet is forwarded.
            </p><div class="example"><a name="ex-list-route-blackhole"></a><p class="title"><b>Example 4.13. blackhole route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add blackhole default</code></strong>
<strong class="userinput"><code>ip route add blackhole 202.143.170.0/24</code></strong>
<strong class="userinput"><code>ip route add blackhole 64.65.64.0/18</code></strong>
              </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-route-types-throw"></a><span class="term">throw</span></dt><dd><a class="indexterm" name="idm2216"></a><p>
              The throw route type is a convenient route type which causes
              a route lookup in a routing table to fail, returning the
              <a class="link" href="#routing-selection-adv" title="5.2. The Whole Story">routing selection
              process</a> to the RPDB.  This is useful when there are
              additional routing tables.  Note that there is an implicit throw
              if no default route exists in a routing table, so the route
              created by the first command in the example is superfluous,
              although legal.
            </p><div class="example"><a name="ex-list-route-throw"></a><p class="title"><b>Example 4.14. throw route types</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip route add throw default</code></strong>
<strong class="userinput"><code>ip route add throw 10.79.0.0/16</code></strong>
<strong class="userinput"><code>ip route add throw 172.16.0.0/12</code></strong>
              </pre></div></div><br class="example-break"></dd></dl></div><p>
        The power of these route types when combined with the
        <a class="link" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">routing policy database</a> can hardly
        be understated.  All of these route types can be used without the
        RPDB, although the throw route doesn't make much sense outside of a
        multiple routing table installation.
      </p><p>
      </p><p>
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-table-local"></a>8.2. The Local Routing Table</h3></div></div></div><a class="indexterm" name="idm2235"></a><a class="indexterm" name="idm2238"></a><p>
        The local routing table is maintained by the kernel.  Normally, the
        local routing table should not be manipulated,
        but it is available for viewing.  In
        <a class="xref" href="#ex-tools-ip-route-show-local" title="Example D.12. Viewing the local routing table with ip route show table local">Example D.12, &#8220;Viewing the local routing table with <span class="command">ip route show
            table local</span>&#8221;</a>, you'll see two of the
        common uses of the local routing table.  The first common use is the
        specification of broadcast address, necessary only for link layers
        which support broadcast addressing.  The second common type of entry
        in a local routing table is a route to a locally hosted IP.
      </p><p>
        The route types found in the local routing table
        are <code class="constant">local</code>, <code class="constant">nat</code> and
        <code class="constant">broadcast</code>.  These route types are not relevant in
        other routing tables, and other route types cannot be used in the
        local routing table.
      </p><p>
        If the machine has several IP addresses on one Ethernet interface,
        there will be a route to each locally hosted IP in the local routing
        table.  This is a normal
        <a class="link" href="#list-basic-ifconfig-side-effects-up">side effect</a>
        of bringing up an IP address on an interface under linux.  
        Maintenance of the broadcast and local routes in the local routing
        table can only be done by the kernel.
      </p><div class="example"><a name="ex-routing-table-local-maint"></a><p class="title"><b>Example 4.15. Kernel maintenance of the <code class="constant">local</code> routing table</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip address show dev eth1</code></strong>
<code class="computeroutput">6: eth1: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
   link/ether 00:80:c8:e8:1e:fc brd ff:ff:ff:ff:ff:ff
   inet 10.10.20.89/24 brd 10.10.20.255 scope global eth1</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip route show dev eth1</code></strong>
<code class="computeroutput">10.10.20.0/24  proto kernel  scope link  src 10.10.20.89</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip route show dev eth1 table local</code></strong>
<code class="computeroutput">broadcast 10.10.20.0  proto kernel  scope link  src 10.10.20.89 
broadcast 10.10.20.255  proto kernel  scope link  src 10.10.20.89
local 10.10.20.89  proto kernel  scope host  src 10.10.20.89</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip address add 192.168.254.254/24 brd + dev eth1</code></strong>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip address show dev eth1</code></strong>
<code class="computeroutput">6: eth1: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
   link/ether 00:80:c8:e8:1e:fc brd ff:ff:ff:ff:ff:ff
   inet 10.10.20.89/24 brd 10.10.20.255 scope global eth1
   inet 192.168.254.254/24 brd 192.168.254.255 scope global eth1</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip route show dev eth1</code></strong>
<code class="computeroutput">10.10.20.0/24  proto kernel  scope link  src 10.10.20.89 
192.168.254.0/24  proto kernel  scope link  src 192.168.254.254</code>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>ip route show dev eth1 table local</code></strong>
<code class="computeroutput">broadcast 10.10.20.0  proto kernel  scope link  src 10.10.20.89 
broadcast 192.168.254.0  proto kernel  scope link  src 192.168.254.254          
broadcast 10.10.20.255  proto kernel  scope link  src 10.10.20.89               
local 192.168.254.254  proto kernel  scope host  src 192.168.254.254            
local 10.10.20.89  proto kernel  scope host  src 10.10.20.89                    
broadcast 192.168.254.255  proto kernel  scope link  src 192.168.254.254</code>
        </pre></div></div><br class="example-break"><p>
        Note in
        <a class="xref" href="#ex-routing-table-local-maint" title="Example 4.15. Kernel maintenance of the local routing table">Example 4.15, &#8220;Kernel maintenance of the <code class="constant">local</code> routing table&#8221;</a>, that the kernel adds
        not only the route for the locally connected network in the <code class="constant">main</code>
        routing table, but also the three required special addresses in the
        <code class="constant">local</code> routing table.  Any IP addresses which are locally hosted on
        the box will have <code class="constant">local</code> entries in the <code class="constant">local</code> table.  The
        <a class="link" href="#list-routing-intro-ipdefs-netaddr">network
        address</a> and
        <a class="link" href="#list-routing-intro-ipdefs-bcast">broadcast
        address</a> are both entered as <code class="constant">broadcast</code> type
        addresses on the interface to which they have been bound.
        Conceptually, there is significance to the distinction between a
        network and broadcast address, but practically, they are treated
        analogously, by other networking gear as well as the linux kernel.
      </p><p>
        There is one other type of route which commonly ends up in the <code class="constant">local</code>
        routing table.  When using <span class="command"><strong>iproute2</strong></span> NAT, there will
        be entries in the local routing table for each network address
        translation.  Refer to
        <a class="xref" href="#ex-tools-ip-route-nat-simple" title="Example D.21. Creating a NAT route for a single IP with ip route add nat">Example D.21, &#8220;Creating a NAT route for a single IP with <span class="command">ip route add
            nat</span>&#8221;</a> and
        <a class="xref" href="#ex-tools-ip-route-nat-network" title="Example D.22. Creating a NAT route for an entire network with ip route add nat">Example D.22, &#8220;Creating a NAT route for an entire network with <span class="command">ip
            route add nat</span>&#8221;</a> for example output.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-table-main"></a>8.3. The Main Routing Table</h3></div></div></div><a class="indexterm" name="idm2289"></a><a class="indexterm" name="idm2292"></a><p>
        The <code class="constant">main</code> routing table is the routing table most people think of when
        considering a linux routing table.  When no table is specified to an
        <span class="command"><strong>ip route</strong></span> command, the kernel assumes the <code class="constant">main</code>
        routing table.  The <span class="command"><strong>route</strong></span> command only manipulates
        the <code class="constant">main</code> routing table.
      </p><p>
        Similarly to the <code class="constant">local</code> table, the <code class="constant">main</code> table is populated
        automatically by the kernel when new interfaces are brought up
        with IP addresses.  Consult the <code class="constant">main</code> routing table before and after
        <strong class="userinput"><code>ip address add 192.168.254.254/24 brd + dev eth1</code></strong>
        in 
        <a class="xref" href="#ex-routing-table-local-maint" title="Example 4.15. Kernel maintenance of the local routing table">Example 4.15, &#8220;Kernel maintenance of the <code class="constant">local</code> routing table&#8221;</a> for a concrete example
        of this kernel behaviour.  Also, visit 
        <a class="link" href="#list-basic-ifconfig-side-effects-up">this summary of
        side effects</a> of interface definition and activation with
        <span class="command"><strong>ifconfig</strong></span> or <span class="command"><strong>ip address</strong></span>.
      </p><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-rpdb"></a>9. Routing Policy Database (RPDB)</h2></div></div></div><a class="indexterm" name="idm2313"></a><a class="indexterm" name="idm2316"></a><p>
      The routing policy database (RPDB) controls the order in which the
      kernel searches through the routing tables.  Each rule has a priority,
      and rules are examined sequentially from rule 0 through rule 32767.
    </p><p>
      When a new packet arrives for routing (assuming the routing cache
      is empty), the kernel begins at the highest priority rule in the
      RPDB--rule 0.  The kernel iterates over each rule in turn until the
      packet to be routed matches a rule.  When this happens the kernel
      follows the instructions in that rule.  Typically, this causes the
      kernel to perform a route lookup in a specified routing table.  If a
      matching route is found in the routing table, the kernel uses that
      route.  If no such route is found, the kernel returns to traverse the
      RPDB again, until every option has been exhausted.
    </p><p>
      The priority-based rule system provides a flexible way to define routes
      while taking advantage of the traditional routing table concept.
      For a complete picture of the entire route selection process including
      the RPDB, see
      <a class="link" href="#routing-selection-adv" title="5.2. The Whole Story">the section on routing
      selection</a>.
    </p><p>
      There are a number of different rule types available for use in the
      routing policy database.  These rule types have a striking similarity to
      the
      <a class="link" href="#list-routing-route-types">route types</a> available
      for route entries.
    </p><div class="variablelist"><a name="list-routing-rule-types"></a><dl class="variablelist"><dt><a name="list-routing-rule-types-unicast"></a><span class="term">unicast</span></dt><dd><a class="indexterm" name="idm2328"></a><p>
            A unicast rule entry is the most common rule type.  This rule type
            simple causes the kernel to refer to the specified routing table
            in the search for a route.  If no rule type is specified on the
            command line, the rule is assumed to be a unicast rule.
          </p><div class="example"><a name="ex-list-rule-unicast"></a><p class="title"><b>Example 4.16. unicast rule type</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip rule add unicast from 192.168.100.17 table 5</code></strong>
<strong class="userinput"><code>ip rule add unicast iif eth7 table 5</code></strong>
<strong class="userinput"><code>ip rule add unicast fwmark 4 table 4</code></strong>
            </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-rule-types-nat"></a><span class="term">nat</span></dt><dd><a class="indexterm" name="idm2342"></a><p>
            The nat rule type is required for correct operation of stateless
            NAT.  This rule is typically coupled with a corresponding nat
            route entry.  The RPDB nat entry causes the kernel to rewrite the
            source address of an outbound packet.  See
            <a class="xref" href="#nat-stateless" title="3. Stateless NAT with iproute2">Section 3, &#8220;Stateless NAT with <span class="command"><strong>iproute2</strong></span>&#8221;</a> for a fuller discussion of network
            address translation in general.
          </p><div class="example"><a name="ex-list-rule-nat"></a><p class="title"><b>Example 4.17. nat rule type</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip rule add nat 193.7.255.184 from 172.16.82.184</code></strong>
<strong class="userinput"><code>ip rule add nat 10.40.0.0 from 172.40.0.0/16</code></strong>
            </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-rule-types-unreachable"></a><span class="term">unreachable</span></dt><dd><a class="indexterm" name="idm2356"></a><p>
            Any route lookup matching a rule entry with an unreachable rule
            type will cause the kernel to generate an ICMP unreachable to
            the source address of the packet.
          </p><div class="example"><a name="ex-list-rule-unreachable"></a><p class="title"><b>Example 4.18. unreachable rule type</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip rule add unreachable iif eth2 tos 0xc0</code></strong>
<strong class="userinput"><code>ip rule add unreachable iif wan0 fwmark 5</code></strong>
<strong class="userinput"><code>ip rule add unreachable from 192.168.7.0/25</code></strong>
            </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-rule-types-prohibit"></a><span class="term">prohibit</span></dt><dd><a class="indexterm" name="idm2370"></a><p>
            Any route lookup matching a rule entry with a prohibit rule type
            will cause the kernel to generate an ICMP prohibited to the source
            address of the packet.
          </p><div class="example"><a name="ex-list-rule-prohibit"></a><p class="title"><b>Example 4.19. prohibit rule type</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip rule add prohibit from 209.10.26.51</code></strong>
<strong class="userinput"><code>ip rule add prohibit to 64.65.64.0/18</code></strong>
<strong class="userinput"><code>ip rule add prohibit fwmark 7</code></strong>
            </pre></div></div><br class="example-break"></dd><dt><a name="list-routing-rule-types-blackhole"></a><span class="term">blackhole</span></dt><dd><a class="indexterm" name="idm2384"></a><p>
            While traversing the RPDB, any route lookup which matches a rule
            with the blackhole rule type will cause the packet to be dropped.
            No ICMP will be sent and no packet will be forwarded.
          </p><div class="example"><a name="ex-list-rule-blackhole"></a><p class="title"><b>Example 4.20. blackhole rule type</b></p><div class="example-contents"><pre class="programlisting">
<strong class="userinput"><code>ip rule add blackhole from 209.10.26.51</code></strong>
<strong class="userinput"><code>ip rule add blackhole from 172.19.40.0/24</code></strong>
<strong class="userinput"><code>ip rule add blackhole to 10.182.17.64/28</code></strong>
            </pre></div></div><br class="example-break"></dd></dl></div><p>
      The routing policy database provides the core of functionality around
      which the policy routing and advanced routing features can be built.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="routing-icmp"></a>10. ICMP and Routing</h2></div></div></div><p>
      ICMP is a very important part of the communication between hosts on
      IP networks.  Used by routers and endpoints (clients and servers)
      ICMP communicates error conditions in networks and
      provides a means for endpoints to receive information
      about a network path or requested connection.
    </p><p>
      One of the commonest uses of ICMP by the administrator of a network is
      the use of
      <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a> to detect the
      state of a machine in the network.  There are other types of ICMP which
      are used for other inter-computer communication.  One other common type
      of ICMP is the ICMP returned by a router or host which is not accepting
      connections.  Essentially, the host returns the ICMP as a polite method
      of saying <span class="quote">&#8220;<span class="quote">Go away.</span>&#8221;</span>.
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-icmp-mtu"></a>10.1. MTU, MSS, and ICMP</h3></div></div></div><p>
        One important use of ICMP, which is completely transparent
        to most users (and indeed many admins), is the use of ICMP to discover
        the Path Maximum Transmission Unit (PMTU).  By discovering the Path MTU
        and transmitting packets with this the MTU, a host can
        minimize the delay of traffic due to fragmentation, and
        (theoretically) attain a more even rate of data transmission.  Because
        each destination may have a different MTU due to different network
        paths, the MTU is a per route attribute stored in the
        <a class="link" href="#routing-cache" title="7. Routing Cache">routing cache</a>.
      </p><p>
        Path MTU can be quite easily broken if any single hop along the way
        blocks all ICMP.  Be sure to allow ICMP unreachable/fragmentation
        needed packets into and out of your network.  This will prevent you
        from being one of the unclueful network admins who cause PMTU
        problems.
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="routing-icmp-redirect"></a>10.2. ICMP Redirects and Routing</h3></div></div></div><p>
        An ICMP redirect is a router's way of communicating
        that there is a better path out of this network or into another one
        than the one the host had chosen.  In
        <a class="link" href="#example-network-netmap" title="1. Example Network Map and General Notes">the example network</a>, 
        <code class="systemitem">tristan</code> has a route to the world through <code class="systemitem">masq-gw</code> and a route to
        192.168.98.0/24 through <code class="systemitem">isdn-router</code>.  If <code class="systemitem">tristan</code> sends a packet
        for 192.168.98.0/24 to <code class="systemitem">masq-gw</code>, the optimal outcome is for
        <code class="systemitem">masq-gw</code> to suggest with an ICMP redirect that <code class="systemitem">tristan</code> send such
        packets via <code class="systemitem">isdn-router</code> instead.
      </p><p>
        By this method, hosts can learn what networks are reachable
        through which routers on the local network segment.  ICMP redirect
        messages, however, are easy to forge, and were (at one time) used to
        subvert poorly configured machines.  While this is infrequently a
        problem on the Internet today,
        it's still good practice to ignore ICMP redirect
        messages from public networks.  Create static routes where
        necessary on private and public networks to
        prevent ICMP redirect messages from being generated on your network.
      </p><p>
        To examine an example of ICMP redirect in action, we simply
        need to send a packet directly from <code class="systemitem">tristan</code> to
        <code class="systemitem">morgan</code>.  We assume that <code class="systemitem">masq-gw</code> has a route to 192.168.98.0/24
        via 192.168.99.1 (<code class="systemitem">isdn-router</code>), that <code class="systemitem">tristan</code> has no
        such route.
      </p><div class="example"><a name="ex-routing-icmp-redirect"></a><p class="title"><b>Example 4.21. ICMP Redirect on the Wire
          <a href="#ftn.idm2431" class="footnote" name="idm2431"><sup class="footnote">[29]</sup></a>
        </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>echo test | nc 192.168.98.82 22</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>tcpdump -nneqti eth0</code></strong>
<code class="computeroutput">0:80:c8:f8:4a:51 0:80:c8:f8:5c:71 74: 192.168.99.35.54510 &gt; 192.168.98.82.22: tcp 0 (DF)
0:80:c8:f8:5c:71 0:80:c8:f8:4a:51 102: 192.168.99.254 &gt; 192.168.99.35: icmp: redirect 192.168.98.82 to host 192.168.99.1 [tos 0xc0] 
0:80:c8:f8:5c:71 0:c0:7b:45:6a:39 74: 192.168.99.35.54510 &gt; 192.168.98.82.22: tcp 0 (DF)</code>
        </pre></div></div><br class="example-break"><p>
        There's a great deal of information above, so let's examine the
        important parts.  We have the first three packets which passed by our
        NIC as a result of this attempt to establish a session.  First, we see
        a packet from <code class="systemitem">tristan</code> bound for <code class="systemitem">morgan</code> with <code class="systemitem">tristan</code>'s source MAC
        and <code class="systemitem">masq-gw</code>'s destination MAC.  Because <code class="systemitem">masq-gw</code> is <code class="systemitem">tristan</code>'s
        default gateway, <code class="systemitem">tristan</code> will send all packets there.
      </p><p>
        The next packet is the ICMP redirect, informing <code class="systemitem">tristan</code> of a 
        better route.  It includes several pieces of information.
        Implicitly, the source IP indicates what router is suggesting the
        alternate route, and the contents specify what the intended
        destination was, and what the better route is.  Note that <code class="systemitem">masq-gw</code>
        suggests using 192.168.99.1 (<code class="systemitem">isdn-router</code>) as the gateway for this
        destination.
      </p><p>
        The final packet is part of the intended session, but has the MAC
        address of <code class="systemitem">masq-gw</code>  on it.  <code class="systemitem">masq-gw</code> has (courteously) informed us
        that we should not use it as a route for the intended destination, but
        has also (courteously) forwarded the packet as we had requested.  In
        this small network, it is acceptable to allow ICMP redirect messages,
        although these should always be dropped at network borders, both
        inbound and outbound.
      </p><p>
        So, in summary, ICMP redirect messages are not intrinsically dangerous
        or problematic, but they shouldn't exist in well-maintained networks.
        If you happen to see them growing in the shadows of your network, some
        careful observation should show you what hosts are affected and which
        routing tables could use some attention.
      </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm1515" class="footnote"><p><a href="#idm1515" class="para"><sup class="para">[15] </sup></a>
                At least one reader (CAO) has pointed out to me that there is
                ambiguity in the meaning and common usage of the
                term <em class="wordasword">network
                address</em>.  While occasionally used to refer to a
                single IP address at the top of a range of addresses, the
                primary meaning requires the implicit
                <a class="link" href="#list-routing-intro-ipdefs-netmask">network
                mask</a>.
              </p><p>
                Historically, this term has always meant the IP address at the
                top of a range AND the netmask identifying the set of
                available addresses.  Without this latter piece of
                information, the <em class="wordasword">network address</em> is
                simply an 
                <a class="link" href="#list-routing-intro-ipdefs-ipaddr">IP
                address</a>.
              </p><p>
                Technically, the use of this term to mean a single IP
                at the top of the range is incorrect, although not uncommon.
              </p></div><div id="ftn.idm1617" class="footnote"><p><a href="#idm1617" class="para"><sup class="para">[16] </sup></a>
          The <span class="command"><strong>route -n</strong></span> output can also be produced with
          <span class="command"><strong>netstat -rn</strong></span> and is commonly used by
          admininstrators who rely on platform independent behaviour across
          heterogeneous Unix and Unix-like systems.  This traditional
          routing table output uses conventional netmask notation to
          denote network size.
        </p></div><div id="ftn.idm1622" class="footnote"><p><a href="#idm1622" class="para"><sup class="para">[17] </sup></a>
          Refer to the
          <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip route</strong></span></a>
          section for a fuller discussion of this linux specific tool.
          The routing table output from <span class="command"><strong>ip route</strong></span> uses
          exclusively CIDR notation.
        </p></div><div id="ftn.idm1694" class="footnote"><p><a href="#idm1694" class="para"><sup class="para">[18] </sup></a>
          This document could stand to allude to MPLS implementations under
          linux, for those who want to look at traffic engineering and packet
          tagging on backbones.  This is certainly not in the scope of this
          chapter, and should be in a separate chapter, which covers
          developing technologies.
        </p></div><div id="ftn.idm1705" class="footnote"><p><a href="#idm1705" class="para"><sup class="para">[19] </sup></a>
            Refer to
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc3222.txt" target="_top">RFC
            3222</a> for further details.
          </p></div><div id="ftn.idm1816" class="footnote"><p><a href="#idm1816" class="para"><sup class="para">[20] </sup></a>
          Many networking applications accept a command line option to prefer
          a particular source address.  The call to select a particular
          IP is known as <code class="function">bind()</code>, so the command
          line option frequently
          contains the word <em class="wordasword">bind</em>, e.g.,
          <code class="option">--bind-address</code>.
          Examples of command line tools allowing specification of the source
          address are <span class="command"><strong>nc -s $BINDADDR $DEST $PORT</strong></span> or
          <span class="command"><strong>socat -
          TCP4:$REMOTEHOST:$REMOTEPORT,bind=$BINDADDR</strong></span>.
        </p></div><div id="ftn.idm1824" class="footnote"><p><a href="#idm1824" class="para"><sup class="para">[21] </sup></a>
          In this case, the route has already been selected (see
          <a class="xref" href="#routing-selection" title="5. Route Selection">Section 5, &#8220;Route Selection&#8221;</a>) and the chosen route entry
          includes a hint for preferred source address on outbound packets
          specifically for this purpose.  For examples on configuring the
          routing tables to include this parameter, see
          <a class="xref" href="#ex-tools-ip-route-add-src" title="Example D.19. Using src in a routing command with route add">Example D.19, &#8220;Using <code class="option">src</code> in a routing command with
            <span class="command">route add</span>&#8221;</a>.
        </p></div><div id="ftn.idm1999" class="footnote"><p><a href="#idm1999" class="para"><sup class="para">[22] </sup></a>
          The kernel must be compiled with the option
          <code class="constant">CONFIG_IP_MULTIPLE_TABLES=y</code>.  This is common
          in vendor and stock kernels, both 2.2 and 2.4.
        </p></div><div id="ftn.idm2023" class="footnote"><p><a href="#idm2023" class="para"><sup class="para">[23] </sup></a>
          If somebody has used scope or oif as additional keys in a routing
          table, and has an example, I'd love to see it, for possible
          inclusion in this documentation.
        </p></div><div id="ftn.idm2026" class="footnote"><p><a href="#idm2026" class="para"><sup class="para">[24] </sup></a>
          Can anybody describe to me what is in table 0?  It looks almost like
          an aggregation of the routing entries in routing tables 254 and 255.
        </p></div><div id="ftn.idm2104" class="footnote"><p><a href="#idm2104" class="para"><sup class="para">[25] </sup></a>
            Once again, I recommend caution when altering the local routing
            table.  Removing local route types from the local routing table
            can break networking in strange and wonderful ways.
          </p></div><div id="ftn.idm2133" class="footnote"><p><a href="#idm2133" class="para"><sup class="para">[26] </sup></a>
                  OK, I'm not absolutely sure you can't use the broadcast
                  route in other routing tables, but I believe you can't.
                  Testing forthcoming...
                </p></div><div id="ftn.idm2148" class="footnote"><p><a href="#idm2148" class="para"><sup class="para">[27] </sup></a>
                  Ibid.  I'm not sure that local route types can be used
                  in any routing table other than the local routing table.
                  Testing forthcoming...
                </p></div><div id="ftn.idm2164" class="footnote"><p><a href="#idm2164" class="para"><sup class="para">[28] </sup></a>
                  Ibid.  nat route types might be ineffectual outside
                  the local routing table.  Testing forthcoming...
                </p></div><div id="ftn.idm2431" class="footnote"><p><a href="#idm2431" class="para"><sup class="para">[29] </sup></a>
              Consult <a class="xref" href="#tb-example-network-hosts" title="Table A.2. Example Network; Host Addressing">Table A.2, &#8220;Example Network; Host Addressing&#8221;</a> for details on
              the IP and MAC addresses of the hosts referred to in this
              example.
            </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-nat"></a>Chapter 5. Network Address Translation (NAT)</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#nat-overview">1. Rationale for and Introduction to NAT</a></span></dt><dt><span class="section"><a href="#nat-break">2. Application Layer Protocols with Embedded Network Information</a></span></dt><dt><span class="section"><a href="#nat-stateless">3. Stateless NAT with <span class="command"><strong>iproute2</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#nat-stateless-simple">3.1. Stateless NAT Packet Capture and Introduction</a></span></dt><dt><span class="section"><a href="#nat-stateless-howto">3.2. Stateless NAT Practicum</a></span></dt><dt><span class="section"><a href="#nat-stateless-rpdb">3.3. Conditional Stateless NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-stateless-pf-interaction">4. Stateless NAT and Packet Filtering</a></span></dt><dt><span class="section"><a href="#nat-dnat">5. Destination NAT with netfilter (DNAT)</a></span></dt><dd><dl><dt><span class="section"><a href="#nat-dnat-pat">5.1. Port Address Translation with DNAT</a></span></dt></dl></dd><dt><span class="section"><a href="#nat-pat-userspace">6. Port Address Translation (PAT) from Userspace</a></span></dt><dt><span class="section"><a href="#nat-pat-userspace-transparent">7. Transparent PAT from Userspace</a></span></dt></dl></div><p>
    Network Address Translation (NAT) is a deceptively simple concept.  NAT is
    the technique of rewriting addresses on a packet as it passes through a
    routing device.  There are far reaching ramifications
    on network design and protocol compatibility wherever NAT is used.
  </p><p>
    This chapter will introduce two types of NAT available under linux.  One,
    <a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">full NAT or stateless NAT</a>, is
    available under kernel 2.2 and kernel 2.4 via the 
    <span class="command"><strong>iproute2</strong></span> userspace interface.  Available only under
    kernel 2.4, 
    <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">destination NAT (DNAT)</a> is an important
    derivative of full NAT.  DNAT configuration from userspace is accomplished
    via the <span class="command"><strong>iptables</strong></span> utility.
    The experienced network administrator is probably puzzling about absent
    references to source NAT (SNAT) and masquerading.  These prominent and
    prevalent uses of NAT are covered in
    <a class="xref" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">Chapter 6, <i>Masquerading and Source Network Address Translation</i></a>, although many concepts involved in the special
    purpose SNAT and masquerading will be introduced in this chapter.
  </p><p>
    Network address translation is known by a number of names in the
    networking world:  full NAT, one-to-one NAT and inbound NAT.
    As used in this chapter and throughout this documentation,
    <em class="wordasword">NAT</em>, when unqualified, 
    will refer to full network address translation or one-to-one NAT.
    NAT techniques derived from full NAT, such as destination or source NAT,
    will be described as DNAT
    (<a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">destination NAT</a>) and SNAT
    (<a class="link" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">source NAT</a>).
  </p><p>
    Michael Hasenstein's seminal paper on network address translation
    is available courtesy of SuSe Linux AG
    <a class="ulink" href="http://www.suse.de/~mha/linux-ip-nat/diplom/nat.html" target="_top">here</a>.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-overview"></a>1. Rationale for and Introduction to NAT</h2></div></div></div><p>
      Network address translation (NAT) is a technique of transparently mapping
      an IP address or range to another IP address or range.  Any routing
      device situated between two endpoints can perform this transformation of
      the packet.  Network designers must however take one key element under
      consideration when laying out a network with NAT in mind.  The router(s)
      performing NAT must have an opportunity to rewrite the packet upon entry
      to the network and upon exit from the network
      <a href="#ftn.idm2474" class="footnote" name="idm2474"><sup class="footnote">[30]</sup></a>.
    </p><p>
      Because network address translation manipulates the addressing of a
      packet, the NAT transformation becomes a passive but
      critical part of the conversation between hosts exchanging packets.
      NAT is by necessity transparent to the application layer endpoints
      and operates on any type of IP packet.  There are some application and
      even network layer protocols which will break as a result of this
      rewriting.  Consult
      <a class="xref" href="#nat-break" title="2. Application Layer Protocols with Embedded Network Information">Section 2, &#8220;Application Layer Protocols with Embedded Network Information&#8221;</a> for a discussion of these cases.
    </p><p>
      Here are a few common reasons to consider NAT along with potential
      NAT solution candidates shown in parentheses.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Publicly accessible services need to be provided on registered
          Internet IPs which change or might change.  NAT allows the
          separation of internal IP addressing schemes from the public IP
          space, easing the burden of changing internal addressing
          or external IPs.
          <span class="emphasis"><em>
          (<a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">NAT</a>,
          <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">DNAT</a>,
          <a class="link" href="#nat-dnat-pat" title="5.1. Port Address Translation with DNAT">PAT with DNAT</a>
          <a class="link" href="#nat-pat-userspace" title="6. Port Address Translation (PAT) from Userspace">PAT from userspace</a>)
          </em></span>
        </p></li><li class="listitem"><p>
          An application requires inbound and outbound connections.
          In this case
          <a class="link" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">SNAT/masquerading</a> will not suffice.
          See also
          <a class="xref" href="#snat-break" title="3. Where Masquerading and SNAT Break">Section 3, &#8220;Where Masquerading and SNAT Break&#8221;</a>.
          <span class="emphasis"><em>
          (<a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">NAT</a>,
          <a class="link" href="#state-conntrack" title="3. Netfilter Connection Tracking">SNAT and application-aware
          connection tracking</a>)
          </em></span>
        </p></li><li class="listitem"><p>
          The network numbering scheme is changing.  Clever use of NAT
          allows reachability of services on both IP addresses or IP address
          ranges during the network numbering migration.
          <span class="emphasis"><em>
          (<a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">NAT</a>,
          <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">DNAT</a>)
          </em></span>
        </p></li><li class="listitem"><p>
          Two networks share the same IP addressing space and need to
          exchange packets.  Using network address translation to publish
          NAT network spaces with different numbering schemes would
          allow each network to retain the addressing scheme while accessing
          the other network.
          <span class="emphasis"><em>
          (<a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">NAT</a>,
          <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">DNAT</a>,
          <a class="link" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">SNAT</a>)
          </em></span>
        </p></li></ul></div><p>
      These are the commonest reasons to consider and implement NAT.  Other
      niche applications of NAT, notably as part of load balancing systems,
      exist although this chapter will concentrate on the use of NAT 
      to hide, isolate or renumber networks.  It will also cover
      inbound connections,
      leaving the discussion of many-to-one NAT, SNAT and masquerading for
      <a class="xref" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">Chapter 6, <i>Masquerading and Source Network Address Translation</i></a>.
    </p><p>
      One motivator for deploying NAT in a network is the benefit of
      virtualizing the network.  By isolating services provided in one network
      from changes in other networks, the effects of such changes can be
      minimized.  The disadvantage of
      virtualizing the network in this way is the increased reliance on the
      NAT device.
    </p><p>
      Providing inbound services via NAT can be accomplished in several
      different ways.  Two common techniques are to use
      <span class="command"><strong>iproute2</strong></span> NAT and netfilter DNAT.
      Less common (and possibly less desirable) one can use port redirection
      tools.  Depending on which tool is employed,
      different characteristics of a packet can trigger the address
      transformation.
    </p><p>
      The simplest form of NAT under linux is 
      <a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2"><span class="command"><strong>iproute2</strong></span> NAT</a>.
      This type of NAT requires two matching commands, one to cause the kernel
      to rewrite the inbound packets (<strong class="userinput"><code>ip route add nat $NATIP
      via $REAL</code></strong>)
      and one to rewrite the outbound packets (<strong class="userinput"><code>ip rule add from
      $REAL nat $NATIP</code></strong>).  The router configured in this fashion will
      retain no state for connections.  It will simply transform any packets
      passing through.  By contrast, netfilter is capable of retaining state
      on connections passing through the router and selecting packets more
      granularly than is possible with only <span class="command"><strong>iproute2</strong></span> tools.
    </p><p>
      Before the advent of the netfilter engine in the linux kernel, there
      were several tools available to administer NAT, DNAT and PAT.
      These tools were not included in many distributions and weren't
      adopted broadly in the community.  Although you may find references to
      <span class="command"><strong>ipmasqadm</strong></span>, <span class="command"><strong>ipnatadm</strong></span> and
      <span class="command"><strong>ipportfw</strong></span> across the Internet in older documentation,
      these tools have been superseded in functionality and widespread
      deployment by the netfilter engine and its userspace partner,
      <span class="command"><strong>iptables</strong></span>.
    </p><p>
      The netfilter engine provides a more flexible
      language for selection of packets to be transformed than that provided
      by the <span class="command"><strong>iproute2</strong></span> suite and kernel routing functionality.
      Additionally, any
      NAT services provided by the netfilter engine come with the labor-saving
      and resource-consuming connection tracking mechanism.
      <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">DNAT</a> translates the address on an
      inbound packet and creates an entry in the connection tracking state
      table.  For even modest machines, the connection tracking resource
      consumption should not be problematic.
    </p><p>
      Netfilter DNAT allows the user to select packets based on
      characteristics such as destination port.  This blurs the distinction
      between network address translation and port address translation.
      NAT always transforms the layer 3 contents of a packet.  Port
      redirection operates at layer 4.  From a practical perspective, there is
      little difference between a port redirection and a netfilter DNAT which
      has selected a single port.  The manner in which the packet and contents
      are retransmitted, however, is tremendously different.
    </p><p>
      One other less common technique for furnishing inbound services is
      the use of
      <a class="link" href="#nat-pat-userspace" title="6. Port Address Translation (PAT) from Userspace">port redirection</a>.  Although
      there are higher layer tools which can perform transparent application
      layer proxying (e.g.
      <a class="ulink" href="http://www.squid-cache.org/" target="_top">Squid</a>), these are
      outside the scope of this documentation.
    </p><p>
      There are a number of IP addresses involved in any NAT transformations
      or connection states.  The following list identifies these names and the
      convention used to describe each IP address.  Beware that the prevalance
      of NAT to publish services on the Internet via public IP addresses has
      lead to the server/client lingo common in discussions of NAT.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">server NAT IP, </span><span class="term">NAT IP</span></dt><dd><p>
            The IP address to which packets are addressed.  This is the
            address on the packet before the device performing NAT
            manipulates it.
            This is frequently also described as the public IP, although
            any given application of NAT knows no distinction between public
            and private address ranges.
          </p></dd><dt><span class="term">real IP, </span><span class="term">server IP, </span><span class="term">hidden IP, </span><span class="term">private IP, </span><span class="term">internal IP</span></dt><dd><p>
            The IP address after the NAT device has performed its
            transformation.  Frequently, this is described as the private IP,
            although any given application of NAT knows no distinction between
            public and private address ranges.
          </p></dd><dt><span class="term">client IP</span></dt><dd><p>
            The source address of the initial packet.  The client IP in a NAT
            transformation does not change; this IP is the source IP address
            on any inbound packets both before and after the translation.  It
            is also the destination address on the outbound packet.
          </p></dd></dl></div><p>
      The above terms will be used below and in general discussions of NAT.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-break"></a>2. Application Layer Protocols with Embedded Network Information</h2></div></div></div><p>
      Network address translation is beautifully invisible when it works,
      but has adverse effects on some protocols.
      Some network applications, e.g., FTP, SNMP, H323, LDAP, IRC, make use of
      embedded IP information in the application layer protocol or data
      stream.  Since the 2.0.x kernel
      series (which is not covered here), linux has supported modules which
      inspect and manipulate packet contents on particular types of packets
      when used with NAT or masquerading.
    </p><p>
      FTP is the classic example.  Within the FTP control channel
      (usually established to destination port tcp/21) the client and the
      server exchange IP address and port information.  If the network address
      translation device doesn't manipulate this data, the FTP server will not
      be able to contact the client to provide the data.
    </p><p>
      Passive mode FTP provides the possibility for a network layer which
      requires only outbound TCP connections.  This results in a more NAT
      friendly and firewall friendly protocol, because the connections are
      initiated from the client.
    </p><p>
      Not only are there network applications which break when NAT is involved
      but also network layer protocols.  IPSec is a standards-based
      network-layer security protocol commonly used in VPNs and IPv6 networks.
      There are many different ways to use IPSec, but, when used in AH
      (Authentication Header) mode, NAT will break IPSec functionality.
    </p><p>
      This underscores the importance of determining if NAT is the best
      solution for the problem.  There are kernel modules to help handle many
      (though not all) of the application layer protocol when using NAT, but
      some protocols, such as IPSec in AH mode simply cannot be used with NAT.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-stateless"></a>3. Stateless NAT with <span class="command"><strong>iproute2</strong></span></h2></div></div></div><p>
      Stateless NAT, occasionally maligned as dumb NAT
      <a href="#ftn.idm2560" class="footnote" name="idm2560"><sup class="footnote">[31]</sup></a>,
      is the simplest form of
      NAT.  It involves rewriting addresses passing through a
      routing device:
      inbound packets will undergo destination address rewriting and
      outbound packets will undergo source address rewriting.
      The <span class="command"><strong>iproute2</strong></span> suite of tools provides the two commands
      required to configure the kernel to perform stateless NAT.
      This section will cover only
      stateless NAT, which can only be accomplished under linux with the
      <span class="command"><strong>iproute2</strong></span> tools, although it can be
      <a class="link" href="#ex-nat-dnat-full" title="Example 5.7. Simulating full NAT with SNAT and DNAT">simulated with netfilter</a>.
    </p><a name="nat-stateless-arp"></a><p>
      Creating an <span class="command"><strong>iproute2</strong></span> NAT mapping has the side
      effect of causing the kernel to answer ARP requests for the NAT IP.
      For more detail on ARP filtering, suppression and conditional ARP, see
      <a class="xref" href="#ch-ether" title="Chapter 2. Ethernet">Chapter 2, <i>Ethernet</i></a>.  This can be considered, alternatively, a
      benefit or a misfeature of the kernel support for NAT.
      The <code class="constant">nat</code> entry in the local routing table causes
      the kernel to reply for ARP requests to the NAT IP.
      Conversely,
      <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">netfilter DNAT</a> makes no ARP entry or
      provision for neighbor advertisement.
    </p><p>
    </p><p>
      Whether or not it is using a packet filter, a linux machine can perform
      NAT using the <span class="command"><strong>iproute2</strong></span> suite of tools.  This chapter
      will document the use of <span class="command"><strong>iproute2</strong></span> tools for NAT with
      <a class="link" href="#nat-stateless-simple" title="3.1. Stateless NAT Packet Capture and Introduction">a simple example</a> and
      <a class="link" href="#nat-stateless-howto" title="3.2. Stateless NAT Practicum">an explanation of the required
      commands</a>, then an example of
      <a class="link" href="#nat-stateless-rpdb" title="3.3. Conditional Stateless NAT">using NAT with the RPDB</a> and
      <a class="link" href="#nat-stateless-pf-interaction" title="4. Stateless NAT and Packet Filtering">using NAT with a packet
      filter</a>.
    </p><p>
      NAT with iproute2 can be used in conjunction with the routing policy
      database (cf. <a class="link" href="#nat-stateless-rpdb" title="3.3. Conditional Stateless NAT">RPDB</a>) to support
      conditional NAT, e.g. only perform NAT if the source IP falls within
      a certain range.  See <a class="xref" href="#nat-stateless-rpdb" title="3.3. Conditional Stateless NAT">Section 3.3, &#8220;Conditional Stateless NAT&#8221;</a>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nat-stateless-simple"></a>3.1. Stateless NAT Packet Capture and Introduction</h3></div></div></div><p>
        Assume that example company in
        <a class="link" href="#ax-example-network" title="Appendix A. An Example Network and Description">example network</a> wants to
        provide SMTP service on a public IP (205.254.211.0/24) but plans to
        move to a different IP addressing space in the near future.  Network
        address translation can assist example company prepare for the move.
        The administrator will select an IP on the internal network
        (192.168.100.0/24) and configure the router to accept and translate 
        packets for the publicly reachable IP into the private IP.
      </p><div class="example"><a name="ex-nat-basic"></a><p class="title"><b>Example 5.1. 
          Stateless NAT Packet Capture
          <a href="#ftn.idm2590" class="footnote" name="idm2590"><sup class="footnote">[32]</sup></a>
        </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -qnn</code></strong>
<code class="computeroutput">19:30:17.824853 eth1 &lt; 64.70.12.210.35131 &gt; 205.254.211.17.25: tcp 0 (DF)  <a class="co" name="ex-nb-public-in" href="#ex-nb-public-in-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
19:30:17.824976 eth0 &gt; 64.70.12.210.35131 &gt; 192.168.100.17.25: tcp 0 (DF)  <a class="co" name="ex-nb-private-out" href="#ex-nb-private-out-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
19:30:17.825400 eth0 &lt; 192.168.100.17.25 &gt; 64.70.12.210.35131: tcp 0 (DF)  <a class="co" name="ex-nb-private-in" href="#ex-nb-private-in-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
19:30:17.825568 eth1 &gt; 205.254.211.17.25 &gt; 64.70.12.210.35131: tcp 0 (DF)  <a class="co" name="ex-nb-public-out" href="#ex-nb-public-out-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a></code>
        </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-nb-public-in-text"></a><a href="#ex-nb-public-in"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
                The first packet comes in on eth1, <code class="systemitem">masq-gw</code>'s
                outside interface.  The packet is addressed to the NAT IP,
                205.254.211.17 on tcp/25.  This is the IP/port pair on which
                which our service runs.  This is a snapshot
                of the packet before it has been handled by the NAT code.
              </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nb-private-out-text"></a><a href="#ex-nb-private-out"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
                The next line is the "same" packet leaving eth0, <code class="systemitem">masq-gw</code>'s
                inside interface, bound for the internal network.
                The NAT code has substituted the real IP of the server,
                192.168.100.17.  This rewriting is handled by the
                <code class="constant">nat</code> entry in the
                <code class="constant">local</code> routing table (<strong class="userinput"><code>ip
                route</code></strong>).  See also
                <a class="xref" href="#ex-nat-basic-commands" title="Example 5.2. Basic commands to create a stateless NAT">Example 5.2, &#8220;Basic commands to create a stateless NAT&#8221;</a>.
              </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nb-private-in-text"></a><a href="#ex-nb-private-in"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
                The SMTP server then sends a return packet which arrives on
                eth0.  This is the packet before the NAT code on <code class="systemitem">masq-gw</code>
                has rewritten the outbound packet.  This rewriting is handled
                by the RPDB entry (<strong class="userinput"><code>ip rule</code></strong>).  See also
                <a class="xref" href="#ex-nat-basic-commands" title="Example 5.2. Basic commands to create a stateless NAT">Example 5.2, &#8220;Basic commands to create a stateless NAT&#8221;</a>.
              </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nb-public-out-text"></a><a href="#ex-nb-public-out"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
                Finally, the return packet is transmitted on eth1 after having
                been rewritten.  The source IP address on the packet is now
                the public IP on which the service is published.
              </td></tr></table></div></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nat-stateless-howto"></a>3.2. Stateless NAT Practicum</h3></div></div></div><p>
          There are only a few commands which are required to enable stateless
          NAT on a linux routing device.  The commands below will configure
          the host <code class="systemitem">masq-gw</code> (see 
          <a class="xref" href="#example-network-netmap" title="1. Example Network Map and General Notes">Section 1, &#8220;Example Network Map and General Notes&#8221;</a> and
          <a class="xref" href="#example-network-addressing" title="2. Example Network Addressing Charts">Section 2, &#8220;Example Network Addressing Charts&#8221;</a>) as shown above in
          <a class="xref" href="#ex-nat-basic" title="Example 5.1.  Stateless NAT Packet Capture">Example 5.1, &#8220;
          Stateless NAT Packet Capture
          
        &#8221;</a>.
        </p><div class="example"><a name="ex-nat-basic-commands"></a><p class="title"><b>Example 5.2. Basic commands to create a stateless NAT</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add nat 205.254.211.17 via 192.168.100.17</code></strong>  <a class="co" name="ex-nbc-routenat" href="#ex-nbc-routenat-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add nat 205.254.211.17 from 192.168.100.17</code></strong>  <a class="co" name="ex-nbc-rulenat" href="#ex-nbc-rulenat-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush cache</code></strong>                                <a class="co" name="ex-nbc-flushcache" href="#ex-nbc-flushcache-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table all | grep ^nat</code></strong>                 <a class="co" name="ex-nbc-routeshow" href="#ex-nbc-routeruleshow-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
<code class="computeroutput">nat 205.254.211.17 via 192.168.100.17  table local  scope host</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>                                        <a class="co" name="ex-nbc-ruleshow" href="#ex-nbc-routeruleshow-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>
<code class="computeroutput">0:      from all lookup local 
32765:  from 192.168.100.17 lookup main map-to 205.254.211.17 
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-nbc-routenat-text"></a><a href="#ex-nbc-routenat"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
                  This command tells the kernel to perform network
                  address translation on any packet bound for
                  205.254.211.17.  The parameter via tells the NAT code
                  to rewrite the packet bound for 205.254.211.17 with the
                  new destination address 192.168.100.17.  Note, that this
                  only handles inbound packets; that is, packets whose
                  destination address contains 205.254.211.17.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nbc-rulenat-text"></a><a href="#ex-nbc-rulenat"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
                  This command enters the corresponding rule for the
                  outbound traffic into the RPDB (kernel 2.2 and up).
                  This rule will cause the kernel rewrite any packet from
                  192.168.100.17 with the specified source address
                  (205.254.211.17).  Any packet originating from
                  192.168.100.17 which passes through this router
                  will trigger this rule.  In short, this command rewrites the
                  source address of outbound packets so that they appear to
                  originate from the NAT IP.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nbc-flushcache-text"></a><a href="#ex-nbc-flushcache"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
                  The kernel maintains a routing cache to handle routing
                  decisions more quickly
                  (<a class="xref" href="#routing-cache" title="7. Routing Cache">Section 7, &#8220;Routing Cache&#8221;</a>).  After making changes
                  to the routing tables on a system, it is good practice to
                  empty the routing cache with <strong class="userinput"><code>ip route flush
                  cache</code></strong>.  Once the cache is empty, the
                  kernel is guaranteed to consult the routing tables again
                  instead of the routing cache.
                </td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-nbc-routeruleshow-text"></a><a href="#ex-nbc-routeshow"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> <a href="#ex-nbc-ruleshow"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
                  These two commands allow the user to inspect the
                  routing policy database and the <code class="constant">local</code>
                  routing table to determine if the NAT routes and rules were
                  added correctly.
                </td></tr></table></div></div></div><br class="example-break"><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nat-stateless-rpdb"></a>3.3. Conditional Stateless NAT</h3></div></div></div><p>
          NAT introduces a complexity to the network in which it is
          used because a service is reachable on a public and a private IP.
          Usually, this is a reasonable tradeoff or else stateless NAT would
          fail in the selection process.
          In the case that the linux routing device is connected to a public
          network and more than one private
          network, there is more work to do.
        </p><p>
          Though the service is available to the public network on
          a public (NAT) IP, internal users may need to connect to the private
          or internal IP.
        </p><p>
          This is accomplished by use of the routing policy database (RPDB),
          which allows conditional routing based on packet characteristics.
          For a more complete explanation of the RPDB, see 
          <a class="xref" href="#routing-rpdb" title="9. Routing Policy Database (RPDB)">Section 9, &#8220;Routing Policy Database (RPDB)&#8221;</a>.  The routing policy database can
          be manipulated with the <a class="link" href="#tools-ip-rule" title="3. ip rule"><span class="command"><strong>
          ip rule</strong></span></a> command.
          In order to successfully configure NAT, familiarity with the
          <span class="command"><strong> ip rule</strong></span> command is required.
        </p><div class="example"><a name="ex-nat-stateless-rpdb"></a><p class="title"><b>Example 5.3. Conditional Stateless NAT (not performing NAT for a
            specified destination network)</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add to 192.168.99.0/24 from 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush cache</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32764:  from 192.168.100.17 to 192.168.99.0/24 lookup main 
32765:  from 192.168.100.17 lookup main map-to 205.254.211.17 
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          Note that we now have an entry of higher priority in the RPDB
          for any packets returning from 192.168.100.17 bound for
          192.168.99.0/24.  The rule tells the kernel to find the route
          for 192.168.99.0/24 (from 192.168.100.17) in the main
          routing table.  This exception to the NAT mapping of our public
          IP to our internal server will allow the hosts in our second
          internal network to reach the host named <code class="systemitem">isolde</code> on
          its private IP address.
        </p><p>
          If <code class="systemitem">tristan</code> were to initiate a connection to <code class="systemitem">isolde</code> now, the
          packet would return from IP 192.168.100.17 instead of being
          rewritten from 205.254.211.17.
        </p><p>
          Now we have had success creating a NAT mapping with the iproute2
          tools and we have successfully made an exception for another
          internal network which is connected to our linux router.  Now,
          supposing we learn that we will be losing our IP space
          next week, we are prepared to change our NAT rules without
          readdressing our server network.
        </p><p>
          Naturally, you may not wish to create these rules manually every time
          you want to use NAT on every device.  A standard
          <a class="link" href="#ex-sc-nat" title="Example 11.3. Static NAT SysV initialization script">SysV initialization script</a> and
          <a class="link" href="#ex-sc-static-nat" title="Example 11.4. Static NAT configuration file">configuration file</a>
          can ease the burden of managing a number of NAT IPs on your system.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-stateless-pf-interaction"></a>4. Stateless NAT and Packet Filtering</h2></div></div></div><p>
      Because NAT rewrites the packet as it passes through the IP stack, 
      packet filtering can become complex.  With attentiveness to the
      addressing of the packet at each stage
      in its journey through the packet filtering code, you can ease the
      burden of writing a packet filter.
    </p><p>
      All of the below requirements can be deduced from an understanding of
      NAT and the path a packet takes through the kernel.  Consult also the
      <a class="ulink" href="http://www.tldp.org/HOWTO/IPCHAINS-HOWTO-4.html#ss4.1" target="_top"><span class="command"><strong>ipchains</strong></span>
      packet path</a> as illustrated in the
      <a class="ulink" href="http://www.tldp.org/HOWTO/IPCHAINS-HOWTO.html" target="_top"><span class="command"><strong>ipchains</strong></span>
      HOWTO</a> to understand the packet path when using
      <span class="command"><strong>ipchains</strong></span>.  Keep in mind when viewing the ASCII
      diagram that stateless NAT will always occur in the routing stage.  Also
      consult the
      <a class="ulink" href="http://docum.org/stef.coene/qos/kptd/" target="_top">kernel packet
      traveling diagram</a> for a good picture of a 2.4 kernel packet
      path.
    </p><p>
      <a class="xref" href="#tb-nat-pf-ipchains" title="Table 5.1. Filtering an iproute2 NAT packet with ipchains">Table 5.1, &#8220;Filtering an <span class="command">iproute2</span> NAT packet with
      <span class="command">ipchains</span>&#8221;</a> identifies the IP addresses
      on a packet traversing each of the input,
      forward and output chains in an <span class="command"><strong>ipchains</strong></span>
      installation.
    </p><div class="table"><a name="tb-nat-pf-ipchains"></a><p class="title"><b>Table 5.1. Filtering an <span class="command">iproute2</span> NAT packet with
      <span class="command">ipchains</span></b></p><div class="table-contents"><table class="table" summary="Filtering an iproute2 NAT packet with
      ipchains" border="1"><colgroup><col align="center" class="c1"><col align="center" class="c2"><col align="center" class="c3"></colgroup><thead><tr><th colspan="3" align="center">Inbound to the NAT IP</th></tr><tr><th align="center">Chain</th><th align="center">Source IP</th><th align="center">Destination IP</th></tr></thead><tbody><tr><td align="center">input</td><td align="center">64.70.12.210</td><td align="center">205.254.211.17</td></tr><tr><td colspan="3" align="center">Routing Stage</td></tr><tr><td align="center">forward</td><td align="center">64.70.12.210</td><td align="center">192.168.100.17</td></tr><tr><td align="center">output</td><td align="center">64.70.12.210</td><td align="center">192.168.100.17</td></tr></tbody></table><table class="table" summary="Filtering an iproute2 NAT packet with
      ipchains" border="1"><colgroup><col align="center" class="c1"><col align="center" class="c2"><col align="center" class="c3"></colgroup><thead><tr><th colspan="3" align="center">Outbound from the real IP</th></tr><tr><th align="center">Chain</th><th align="center">Source IP</th><th align="center">Destination IP</th></tr></thead><tbody><tr><td align="center">input</td><td align="center">192.168.100.17</td><td align="center">64.70.12.210</td></tr><tr><td colspan="3" align="center">Routing Stage</td></tr><tr><td align="center">forward</td><td align="center">205.254.211.17</td><td align="center">64.70.12.210</td></tr><tr><td align="center">output</td><td align="center">205.254.211.17</td><td align="center">64.70.12.210</td></tr></tbody></table></div></div><br class="table-break"><p>
      A firewall implementing a tight policy (deny all, selectively allow)
      will require a large number of individual rules to allow the NAT packets
      to traverse the firewall packet filter.
      Assuming the configuration detailed in
      <a class="xref" href="#ex-nat-basic" title="Example 5.1.  Stateless NAT Packet Capture">Example 5.1, &#8220;
          Stateless NAT Packet Capture
          
        &#8221;</a>, the following set of chains is
      required and will restrict access to only port 25
      <a href="#ftn.idm2762" class="footnote" name="idm2762"><sup class="footnote">[33]</sup></a>.
    </p><div class="example"><a name="ex-nat-pf-ipchains"></a><p class="title"><b>Example 5.4. Using an <span class="command">ipchains</span> packet filter with
        stateless NAT</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I input  -i eth1 -p tcp -l -y -s 0/0 1024:65535    -d 205.254.211.17 25 -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I input  -i eth1 -p tcp  ! -y -s 0/0 1024:65535    -d 205.254.211.17 25 -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I forward        -p tcp       -s 0/0 1024:65535    -d 192.168.100.17 25 -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I output -i eth0 -p tcp       -s 0/0 1024:65535    -d 192.168.100.17 25 -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I input  -i eth0 -p tcp  ! -y -s 192.168.100.17 25 -d 0/0 1024:65535    -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I forward        -p tcp       -s 205.254.211.17 25 -d 0/0 1024:65535    -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ipchains -I output -i eth1 -p tcp       -s 205.254.211.17 25 -d 0/0 1024:65535    -j ACCEPT</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>for icmptype in \</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>destination-unreachable source-quench time-exceeded parameter-problem; do</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I input  -i eth1 -p icmp -s 0/0 $icmptype            -d 205.254.211.17 -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I forward        -p icmp -s 0/0 $icmptype            -d 192.168.100.17 -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I output -i eth0 -p icmp -s 0/0 $icmptype            -d 192.168.100.17 -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I input  -i eth0 -p icmp -s 192.168.100.17 $icmptype -d 0/0            -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I forward        -p icmp -s 205.254.211.17 $icmptype -d 0/0            -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>ipchains -I output -i eth1 -p icmp -s 205.254.211.17 $icmptype -d 0/0            -j ACCEPT</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>done</code></strong>
      </pre></div></div><br class="example-break"><p>
      Please note that the formatting of the commands is simply for display
      purposes, and to allow for easier reading of a complex set of commands.
      The above set of rules is 31 individual chains.  This is most certainly
      a complex set of rules.  For further details on how to use
      <span class="command"><strong>ipchains</strong></span> please see the 
      <a class="ulink" href="http://www.tldp.org/HOWTO/IPCHAINS-HOWTO.html" target="_top"><span class="command"><strong>ipchains</strong></span>
      HOWTO</a>.  The salient detail you should notice from the above set
      of rules is the difference between the IPs used in the input and forward
      chains.  
      Since packets are rewritten by the stateless NAT code in the routing
      stage, the transformation of the packet will by complete before the
      forward chain is traversed.
    </p><p>
      The first two lines cover all inbound TCP packets, the first line as a
      special case of the second, indicating (<code class="option">-l</code>) that we
      want to log the packet.  After successfully traversing the input chain,
      the packet is routed, at which point the destination address of the
      packet has changed.  Now, we need to forward the packet from the public
      source address to the private (or real) internal IP address.  Finally,
      we need to allow the packet out on the internal interface.
    </p><p>
      The next set of rules handles all of the TCP return packets.  On the
      input rule, we are careful to match only non-SYN packets from our
      internal server bound for the world.  Once again, the packet is
      rewritten during the routing stage.  Now in the forward chain, the
      packet's source IP is the public IP of the service.  Finally, we need to
      let the packet out on our external interface.
    </p><p>
      The next series of lines are required ICMP rules to prevent network
      traffic from breaking terribly.  These types of ICMP, particularly
      destination unreachable (ICMP 3) and source quench (ICMP 4) help to
      ensure that TCP sessions run with optimized characteristics.
    </p><p>
      These rules are the minimum set of <span class="command"><strong>ipchains</strong></span> rules
      needed to support a NAT'd TCP service.  This concludes our discussion of
      publishing a service to the world with <span class="command"><strong>iproute2</strong></span> based
      NAT and protecting the service with <span class="command"><strong>ipchains</strong></span>.  As you
      can see, the complexity of supporting NAT with
      <span class="command"><strong>iproute2</strong></span> can be substantial, which is why we'll
      examine the benefits of inbound NAT (DNAT) with netfilter in the next
      section.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-dnat"></a>5. Destination NAT with netfilter (DNAT)</h2></div></div></div><p>
      Destination NAT with netfilter is commonly used to publish a service
      from an internal RFC 1918 network to a publicly accessible IP.
      To enable DNAT, at least one <span class="command"><strong>iptables</strong></span> command is
      required.  The 
      connection tracking mechanism of netfilter will ensure that subsequent
      packets exchanged in either direction (which can be identified
      as part of the existing DNAT connection) are also transformed.
    </p><p>
      In a devilishly subtle difference, netfilter DNAT does not cause the
      kernel to answer ARP requests for the NAT IP, where
      <span class="command"><strong>iproute2</strong></span> NAT automatically begins 
      <a class="link" href="#nat-stateless-arp">answering ARP requests</a>
      for the NAT IP.
    </p><div class="example"><a name="ex-nat-dnat-all"></a><p class="title"><b>Example 5.5. Using DNAT for all protocols (and ports) on one IP</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>iptables -t nat -A PREROUTING -d 10.10.20.99 -j DNAT --to-destination 10.10.14.2</code></strong>
      </pre></div></div><br class="example-break"><p>
      In this example, all packets arriving on the router with a destination
      of 10.10.20.99 will depart from the router with a destination of
      10.10.14.2.
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><div class="example"><a name="ex-nat-dnat-port"></a><p class="title"><b>Example 5.6. Using DNAT for a single port</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>iptables -t nat -A PREROUTING -p tcp -d 10.10.20.99 --dport 80 -j DNAT --to-destination 10.10.14.2</code></strong>
      </pre></div></div><br class="example-break"><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
      Full network address translation, as performed with
      <span class="command"><strong>iproute2</strong></span> can be simulated with both netfilter
      SNAT and DNAT, with the potential benefit (and attendent resource
      consumption) of connection tracking.
    </p><div class="example"><a name="ex-nat-dnat-full"></a><p class="title"><b>Example 5.7. Simulating full NAT with SNAT and DNAT</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>iptables -t nat -A PREROUTING -d 205.254.211.17 -j DNAT --to-destination 192.168.100.17</code></strong>
<code class="prompt">[root@real-server]# </code><strong class="userinput"><code>iptables -t nat -A POSTROUTING -s 192.168.100.17 -j SNAT --to-destination 205.254.211.17</code></strong>
      </pre></div></div><br class="example-break"><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nat-dnat-pat"></a>5.1. Port Address Translation with DNAT</h3></div></div></div><p>
      </p><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-pat-userspace"></a>6. Port Address Translation (PAT) from Userspace</h2></div></div></div><p>
      Port address translation (hereafter PAT) provides a similar
      functionality to NAT, but is a more specific tool.  PAT forwards
      requests for a particular IP and port pair to another IP port pair.
      This feature is commonly used on publicly connected hosts to make an
      internal service available to a larger network.
    </p><p>
      PAT will break in strange and wonderful ways if there is an alternate
      route between the two hosts connected by the port address translation.
    </p><p>
      PAT has one important benefit over NAT (with the
      <span class="command"><strong>iproute2</strong></span> tools).  Let's assume that you have only
      five public IP addresses for which you have paid dearly.  Additionally,
      let's assume that you want to run services on standard ports.  You had
      hoped to connect four SMTP servers, two SSH servers and five HTTP servers.
      If you had wanted to accomplish this with NAT, you'd need more IP space.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nat-pat-userspace-transparent"></a>7. Transparent PAT from Userspace</h2></div></div></div><p>
    </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm2474" class="footnote"><p><a href="#idm2474" class="para"><sup class="para">[30] </sup></a>
          If using
          <a class="link" href="#nat-stateless" title="3. Stateless NAT with iproute2">stateless NAT</a>, the inbound and
          outbound translations can occur on more than one device, provided
          that all of the devices are performing the same translation.
        </p></div><div id="ftn.idm2560" class="footnote"><p><a href="#idm2560" class="para"><sup class="para">[31] </sup></a>
          In the kernel code tree, stateless NAT, <span class="command"><strong>iproute2</strong></span> NAT can be
          located in the file <code class="filename">net/ipv4/ip_nat_dumb.c</code>.
          Even in the kernel, it has this reputation.
        </p></div><div id="ftn.idm2590" class="footnote"><p><a href="#idm2590" class="para"><sup class="para">[32] </sup></a>
              If you are having some difficulty understanding the
              output of <span class="command"><strong>tcpdump</strong></span>, please see the
              section on <a class="link" href="#tools-tcpdump" title="5. tcpdump">tcpdump</a>.
            </p></div><div id="ftn.idm2762" class="footnote"><p><a href="#idm2762" class="para"><sup class="para">[33] </sup></a>
          I assume here that the user has a restrictive default policy on the
          firewalling device.  I suggest a policy of DENY on each of the built
          in <span class="command"><strong>ipchains</strong></span> chains.
        </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-snat"></a>Chapter 6. Masquerading and Source Network Address Translation</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#snat-intro">1. Concepts of Source NAT</a></span></dt><dd><dl><dt><span class="section"><a href="#snat-masq-diff">1.1. Differences Between SNAT and Masquerading</a></span></dt><dt><span class="section"><a href="#snat-double">1.2. Double SNAT/Masquerading</a></span></dt></dl></dd><dt><span class="section"><a href="#snat-inbound">2. Issues with SNAT/Masquerading and Inbound Traffic</a></span></dt><dt><span class="section"><a href="#snat-break">3. Where Masquerading and SNAT Break</a></span></dt></dl></div><p>
    Masquerading for connections or traffic initiated from inside a network.
    Consider reading <a class="xref" href="#ch-nat" title="Chapter 5. Network Address Translation (NAT)">Chapter 5, <i>Network Address Translation (NAT)</i></a> for details on handling inbound
    traffic or connections.
  </p><p>
    Masquerading has been supported under the linux kernel since before
    kernel 2.0.  The technique of masquerading 
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="snat-intro"></a>1. Concepts of Source NAT</h2></div></div></div><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="snat-masq-diff"></a>1.1. Differences Between SNAT and Masquerading</h3></div></div></div><p>
        Though SNAT and masquerading perform the same fundamental function,
        mapping one address space into another one, the details differ
        slighly.  Most noticeably, masquerading chooses the source IP address
        for the outbound packet from the IP bound to the interface through
        which the packet will exit.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="snat-double"></a>1.2. Double SNAT/Masquerading</h3></div></div></div><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="snat-inbound"></a>2. Issues with SNAT/Masquerading and Inbound Traffic</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="snat-break"></a>3. Where Masquerading and SNAT Break</h2></div></div></div><p>
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-packetfilter"></a>Chapter 7. Packet Filtering</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#pf-intro">1. Rationale for and Introduction to Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-history">1.1. History of Linux Packet Filter Support</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-shortcomings">2. Limits and Weaknesses of Packet Filtering</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-limits">2.1. Limits of the Usefulness of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness">2.2. Weaknesses of Packet Filtering</a></span></dt><dt><span class="section"><a href="#pf-weakness-stateless">2.3. Complex Network Layer Stateless Packet Filters</a></span></dt></dl></dd><dt><span class="section"><a href="#pf-icmp">3. General Packet Filter Requirements</a></span></dt><dt><span class="section"><a href="#pf-netfilter">4. The Netfilter Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#pf-netfilter-iptables">4.1. Packet Filtering with <span class="command"><strong>iptables</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-ipchains">5. Packet Filtering with <span class="command"><strong>ipchains</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#pf-ipchains-mangling">5.1. Packet Mangling with <span class="command"><strong>ipchains</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#pf-host">6. Protecting a Host</a></span></dt><dt><span class="section"><a href="#pf-network">7. Protecting a Network</a></span></dt><dt><span class="section"><a href="#pf-further">8. Further Resources</a></span></dt></dl></div><p>
    It is not an uncommon story today to hear how people were first exposed to
    linux.  Many people found linux an excellent and reliable
    masquerading firewall in the mid-1990s and slowly became more
    and more accustomed to working with linux as a result of the low total
    cost of ownership.
  </p><p>
    The capabilities of packet filtering tools available under linux today
    dwarfs that of early linux (<span class="command"><strong>ipfwadm</strong></span>, anybody?) yet
    retains the reliability and expressive flexibility of the older tools.
  </p><p>
    For networks and machines directly connected to the Internet, packet
    filtering is no longer an option, but a need.  This chapter will introduce
    the packet filtering tools available under kernels 2.2 and 2.4.  Since
    there is much available documentation on packet filtering, host protection
    and masquerading with a packet filter, this chapter will refer liberally
    to external resources.
  </p><p>
    This chapter begins with an
    <a class="link" href="#pf-intro" title="1. Rationale for and Introduction to Packet Filtering">introduction to
    and the history of packet filtering with linux</a>.  After covering
    some of the
    <a class="link" href="#pf-weakness" title="2.2. Weaknesses of Packet Filtering">weaknesses of packet filtering</a>, it will
    cover
    <a class="link" href="#pf-netfilter" title="4. The Netfilter Architecture">the netfilter architecture</a>, and then
    delve into
    <a class="link" href="#pf-netfilter-iptables" title="4.1. Packet Filtering with iptables">using
    <span class="command"><strong>iptables</strong></span></a>.  An introduction to the use of
    <a class="link" href="#pf-ipchains" title="5. Packet Filtering with ipchains"><span class="command"><strong>ipchains</strong></span></a> will follow
    along with introductions to
    <a class="link" href="#pf-host" title="6. Protecting a Host">host</a> and
    <a class="link" href="#pf-network" title="7. Protecting a Network">network protection</a>.  The chapter will
    close with an overview of
    <a class="link" href="#pf-further" title="8. Further Resources">further resources</a>.
  </p><p>
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-intro"></a>1. Rationale for and Introduction to Packet Filtering</h2></div></div></div><p>
      Packet filtering refers to the technique of conditionally allowing
      or denying packets entering or exiting a network or host based on
      the characteristics of that packet.  There are two fundamental types of
      packet filters.  A static packet filter is a set of rules against which
      every packet is checked, and allowed or denied.
      A dynamic packet filter keeps track of the connections currently passing
      the firewall.  This is usually described as a stateful or dynamic packet
      filtering engine.  Netfilter provides the capability for linux (2.4+) to
      operate as a stateful packet filtering device.
    </p><p>
      For a brief digression, consider the term <em class="wordasword">stateful packet
      inspection</em>.  This term has been used in two distinctly
      different meanings.  At least one commercial security company
      differentiates between stateful packet filtering and stateful packet
      inspection
      <a href="#ftn.idm2911" class="footnote" name="idm2911"><sup class="footnote">[34]</sup></a>.
      Supposedly, a stateful packet inspection engine is able to examine the
      contents of a packet and make a limited guess as to the legitimacy of
      the application layer content.  While I would call this an application
      layer proxy, I do not use the product.  For the purposes of this
      documentation, the terms stateful packet inspection and stateful packet
      filtering are synonomous.
    </p><p>
      Packet filtering, the network layer portion of a firewall solution, is
      one part of a good security stance.  As the embodiment and manifestation
      of an organizational security policy for network layer traffic, the
      packet filter restricts traffic flows between networks and hosts.  There
      is tremendous value from a security perspective in enforcing these
      traffic flows, instead of allowing arbitrary traffic flow.
    </p><p>
      The use of packet filtering to enforce these traffic flows is not
      restricted to routers and firewalls alone.  Standalone servers and
      workstations can use these same tools to protect themselves.  There
      are a couple of common approaches to packet filtering.  Generally,
      network security professionals subscribe to the notion that the
      filtering policy should deny or drop all traffic and selectively allow
      desired traffic.  An alternate, more open, policy suggests allowing
      everything, selectively blocking undesirable traffic.
    </p><p>
      The languages used in most packet filtering tools for describing IP
      packets allow for a great deal of specifity when identifying traffic.
      This specifity enables an administrator a great deal of flexibility for
      protecting resources and limiting traffic flows.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-history"></a>1.1. History of Linux Packet Filter Support</h3></div></div></div><p>
        Packet filtering under linux has a long history, punctuated by major
        alterations in the packet filtering systems included in the kernel.  In
        the mid- and late-1990s, <span class="command"><strong>ipfwadm</strong></span> exposed the three
        packet filtering chains of kernel 2.0 to the user: in, forward, and out.
        Individual entries added to these chains would be traversed in order in
        each ruleset.  The first matching rule in each chain would be used, and
        every packet passing through a router would traverse these three
        chains.
      </p><p>
        With the advent of linux 2.2, users could create their own chains and
        chain structures.  The kernel architecture was different from that of
        the earlier kernel, but from the user's perspective, the manner in
        which the rules were written was only slightly different.  Rule
        chains, traversed rather like subroutines and manipulated with
        <span class="command"><strong>ipchains</strong></span>, could be arbitrarily complex and nested.
        The built-in packet filtering chains had names:  input, output and
        forward.  The first matching rule in any chain called from one of the
        built-in chains would be used.  Every packet passing through a router
        would traverse (at least) the three built-in rule chains.  There is
        backward compatible support for <span class="command"><strong>ipfwadm</strong></span> syntax via
        a wrapper shell script which converts the command to an
        <span class="command"><strong>ipchains</strong></span> syntax.
      </p><p>
        In kernel 2.4, the
        <a class="link" href="#pf-netfilter" title="4. The Netfilter Architecture">netfilter architecture</a>
        which provides functionality other than packet filtering, allows users
        to create the arbitrary chains and chain structures similar to those
        supported by linux 2.2.  The built in chains are INPUT, FORWARD, and
        OUTPUT.  A major difference in the use of chains was introduced in
        linux 2.4; packets passing through a router will traverse the FORWARD
        chain only.  User-defined <span class="command"><strong>iptables</strong></span> chains resemble
        branches rather than subroutines.  Under linux 2.4,
        <span class="command"><strong>ipchains</strong></span> compatibility is maintained with a kernel
        module.  For <span class="command"><strong>ipfwadm</strong></span> compatibility, the kernel
        module and the aforementioned wrapper shell script function
        adequately.
      </p><p>
        The packet filtering support under linux has grown increasingly
        complex and mature with successive kernels and development efforts on
        the user space tools.  The netfilter architecture of linux 2.4
        represented a tremendous step forward in the packet filtering
        capabilities of linux with support for stateful packet filtering.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-shortcomings"></a>2. Limits and Weaknesses of Packet Filtering</h2></div></div></div><p>
      Although the functionality offered by linux kernels for protecting
      network resources with packet filtering allows tremendously specific
      network layer access control and auditing capability, it alone cannot
      successfully and completely protect network resources.  There are
      weaknesses in and limits to the usefulness of packet filters.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-limits"></a>2.1. Limits of the Usefulness of Packet Filtering</h3></div></div></div><p>
        In cases where a packet filter restricts access to a resource based on
        the source IP address attempting to access that resource, the packet
        filter cannot verify whether the packets originate from the real
        device or from a host or router spoofing this source address.
        A transparent proxy illustrates this problem perfectly.  A transparent
        proxy frequently runs on a masquerading or NAT host which is connected
        to the Internet.  This machine intercepts outbound connections for a
        particular protocol (e.g, HTTP), and simulates the real server to the
        client.  The client may have a packet filter limiting outbound
        connections to a single IP and port pair, but the transparent proxy
        will still operate on the outbound connection.
      </p><p>
        This is an innocuous example, indeed.  A potentially more threatening
        example is an ssh server which accepts connections only from an IP
        range.  Any router between the two endpoints which can
        <a class="link" href="#adv-nonlocal-bind" title="7. Binding to Non-local Addresses">spoof IP packets</a> will be able
        to pass the packet filter, whether it is a stateful or a
        static packet filter.  This should underscore the importance of
        solid application layer security in addition to the need for
        judiciously employed packet filtering.
      </p><p>
        A packet filter makes no effort to validate the contents of a data
        stream, so data passed over a packet filter may be bogus, invalid or
        otherwise incorrect.  The packet filter only verifies that the network
        layer datagrams are correctly addressed and well-formed
        <a href="#ftn.idm2940" class="footnote" name="idm2940"><sup class="footnote">[35]</sup></a>.
        Many security devices, such as firewalls, include support for proxies,
        which are application aware.  These are security mechanisms which can
        validate data streams.  Proxies are often integrated with packet
        filters for a tight network layer and application layer firewall.
      </p><p>
        Tunnels are one of the most common ways to subvert a packet filter.
        They come in wide varieties: ssh tunnels which allow users to
        transport TCP sessions into or out of a network; GRE tunnels, which
        allow arbitrary packets to be encapsulated in an IP packet; UDP
        tunnels; VPN tunnels; TAP/TUN tunnels; and application layer transport
        tunnels, such as RPC over HTTP/HTTPS.  Some of these tunnels are very
        difficult to prevent with packet filtering, while others are trivial to
        block.
      </p><p>
        Perhaps it is apparent, why **FIXME** adversarial relationship between
        packet filters and content....limitation of packet filter....hence
        proxies...blah blah blah.
      </p><p>
        Use of ICMP, when to block ICMP; tunneling through lax packet filters
        with ICMP (trinoo, ICMPchat).
      </p><p>
        Another area of network security which is not addressed by packet
        filtering is encryption.  Encryption can be used at a number of
        different layers in a networked environment.  Compare IPSec, encrypted
        packets, with Secure Sockets Layer (SSL), which encrypts a single
        application layer session.  IPSec operates at layer 3, while SSL
        operates above layer 4.  Packet filtering does not directly address
        the issue of encryption in any way.  Both are tools used in an
        ongoing effort to maintain and secure a network.
      </p><p>
        There are a few good starting place for those needing
        guidelines on securing machines.  First, the
        <a class="ulink" href="http://tldp.org/HOWTO/Security-Quickstart-HOWTO/index.html" target="_top">Security
        Quickstart HOWTO</a> is a good place to begin.  There is also the
        <a class="ulink" href="http://tldp.org/HOWTO/Security-HOWTO/" target="_top">Security
        HOWTO</a>.  These and several other good general security
        resources are also available via
        <a class="ulink" href="http://www.linuxsecurity.com/docs/" target="_top">linuxsecurity.com's
        documentation area</a>.
      </p><p>
        Much of the previous discussion applies to packet filtering
        in general, and linux suffers from the same limitations of packet
        filtering.  It is folly to assume that a good packet filter makes a
        network immune from security issues.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-weakness"></a>2.2. Weaknesses of Packet Filtering</h3></div></div></div><p>
        The weaknesses of static (or stateless) packet filters and stateful
        packet filters are different in a few ways.  Stateless packet filters
        frequently block SYN scans of networks, but ....
      </p><p>
        Stateless packet filters. (cf. iptables connection tracking), cf. state
        vs. stateless discussion.
      </p><p>
      </p><p>
        confounded application layer protocols like FTP, H323
      </p><p>
        Because of the nature of connection tracking and state awareness,
        stateful packet filters are vulnerable to resource exhaustion and
        deliberate attempts to trip rate-limiting features.
      </p><p>
        DoS on connection tracking packet filters
        DoS on rate limiters ?
      </p><p>
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-weakness-stateless"></a>2.3. Complex Network Layer Stateless Packet Filters</h3></div></div></div><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-icmp"></a>3. General Packet Filter Requirements</h2></div></div></div><p>
      minimum ICMP required to meet the networking needs; xref PMTU discussion
    </p><p>
      source quench
    </p><p>
      parameter problem
    </p><p>
      inbound destination unreachable
    </p><p>
      outbound destination unreachable fragmentation needed
    </p><p>
      optional: echo request and echo reply
    </p><p>
      optional: outbound destination unreachable
    </p><p>
      optional: time exceeded
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-netfilter"></a>4. The Netfilter Architecture</h2></div></div></div><p>
      packet filtering engine in kernel 2.2 (skip history, adequately
      documented elsewhere)
    </p><p>
      packet filtering engine as part of netfilter in kernel 2.4, backwards
      compatible support for ipchains
    </p><p>
      differences between the packet traversal in ipchains and iptables.
      link to Stef Coene's KPTD (kernel 2.4).  Anybody know of a link to a
      KPTD for kernel 2.2?
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-netfilter-iptables"></a>4.1. Packet Filtering with <span class="command"><strong>iptables</strong></span></h3></div></div></div><p>
        selecting on interface
      </p><p>
        different chains, INPUT, OUTPUT, FORWARD
      </p><p>
        big picture; how chains are traversed
      </p><p>
        selecting on interface -i -o
      </p><p>
        targets; ACCEPT, DROP, REJECT....
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-ipchains"></a>5. Packet Filtering with <span class="command"><strong>ipchains</strong></span></h2></div></div></div><p>
      the three builtin chains, input, output, forward
    </p><p>
      policy per chain, see targets
    </p><p>
      jumping from chain to chain, -j $TARGET; wher TARGET=chain
    </p><p>
      the big picture; how chains are traversed
    </p><p>
      targets (other than chains) ACCEPT, DENY, REJECT....
    </p><p>
      selecting on interface
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pf-ipchains-mangling"></a>5.1. Packet Mangling with <span class="command"><strong>ipchains</strong></span></h3></div></div></div><p>
      </p><p>
      </p><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-host"></a>6. Protecting a Host</h2></div></div></div><p>
      Host protection in the past was typically performed with application
      layer checks on the originating IP or hostname.  This was (and still is)
      frequently accomplished with libwrap, which verifies whether or not to
      allow a connection based on the contents of the system wide
      configuration files <code class="filename">/etc/hosts.allow</code> and
      <code class="filename">/etc/hosts.deny</code>.
    </p><p>
      Host protection is one part of protecting a host, by preventing inbound
      packets from reaching higher layers.  This is no substitute for tight
      application layer security.  Strong network and host-level packet
      filters mitigate a host's exposure when it is connected to
      a network.
    </p><p>
    </p><div class="example"><a name="ex-pf-iptables-reject"></a><p class="title"><b>Example 7.1. Blocking a destination and using the <code class="option">REJECT</code>
        target, cf. <a class="xref" href="#ex-tools-ip-route-add-prohibit" title="Example D.17. Adding a prohibit route with route add">Example D.17, &#8220;Adding a <code class="option">prohibit</code> route with <span class="command">route
            add</span>&#8221;</a></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -I FORWARD -p tcp -d 209.10.26.51 --dport 22 -j REJECT</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ssh 209.10.26.51</code></strong>
<code class="computeroutput">ssh: connect to address 209.10.26.51 port 22: Connection refused</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -nnq -i eth2</code></strong>
<code class="computeroutput">tcpdump: listening on eth2
22:16:59.111947 192.168.99.35.51991 &gt; 209.10.26.51.22: tcp 0 (DF)
22:16:59.112270 192.168.99.254 &gt; 192.168.99.35: icmp: 209.10.26.51 tcp port 22 unreachable (DF) [tos 0xc0]</code>
      </pre></div></div><br class="example-break"><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-network"></a>7. Protecting a Network</h2></div></div></div><p>
    </p><p>
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pf-further"></a>8. Further Resources</h2></div></div></div><p>
      The use of linux packet filtering features is mature and
      well-documented in many places throughout the Internet.  One of the most
      thorough introductions to the use of <span class="command"><strong>iptables</strong></span> has
      been collected by Oskar Andreasson at his
      <a class="ulink" href="http://iptables-tutorial.frozentux.net/" target="_top">Iptables
      tutorial</a>.  For further reference material on the use of
      <span class="command"><strong>iptables</strong></span> consult this resource.
    </p><p>
      For those continuing to use <span class="command"><strong>ipchains</strong></span> the
      <a class="ulink" href="http://www.tldp.org/HOWTO/IPCHAINS-HOWTO.html" target="_top">ipchains
      HOWTO</a> courtesy of TLDP provides an introduction to the world of
      <span class="command"><strong>ipchains</strong></span>.
    </p><p>
      For kernel 2.4, understanding the sequence of packet mangling, filtering
      and network address translation is key.  The
      <a class="ulink" href="http://www.docum.org/stef.coene/qos/kptd/" target="_top">kernel packet
      traveling diagram</a> provides a visual representation of the path a
      packet takes through the kernel.  Here you will see the netfilter hooks,
      traffic control, and routing stages.  A similar picture of kernel 2.4's
      packet path is available in a single page PDF entitled
      <a class="ulink" href="http://open-source.arkoon.net/kernel/kernel_net.png" target="_top">Linux
      Kernel 2.4 Packet handling</a>.
    </p><p>
      See also
      <a class="xref" href="#links-ipchains" title="1.8. ipchains Resources">Section 1.8, &#8220;<span class="command"><strong>ipchains</strong></span> Resources&#8221;</a> and
      <a class="xref" href="#links-netfilter" title="1.7. Netfilter Resources">Section 1.7, &#8220;Netfilter Resources&#8221;</a> in the appendices for a more complete
      set of references and links.
    </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm2911" class="footnote"><p><a href="#idm2911" class="para"><sup class="para">[34] </sup></a>
          See the following
          <a class="ulink" href="http://www.netmaster.com/products/ggos-dpf.pdf" target="_top">PDF</a>
          from NetMaster Digital Security.  Although I may disagree with their
          use of terms, I can appreciate their clear attempt to explain their
          use of these two terms.
        </p></div><div id="ftn.idm2940" class="footnote"><p><a href="#idm2940" class="para"><sup class="para">[35] </sup></a>
            In truth, there is some examination of data inside the network
            layer datagram.  Almost all packet filtering engines allow the
            user to distinguish between the different IP protocol types, such
            as GRE, TCP, UDP, ICMP, and even attributes of these datagrams and
            segments.  The important thing to realize is that a
            <span class="emphasis"><em>packet filter</em></span> makes no effort to examine the
            data stream.
          </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-state"></a>Chapter 8. Statefulness and Statelessness</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#state-intro">1. </a></span></dt><dt><span class="section"><a href="#state-routing">2. Statelessness of IP Routing</a></span></dt><dt><span class="section"><a href="#state-conntrack">3. Netfilter Connection Tracking</a></span></dt><dd><dl><dt><span class="section"><a href="#state-conntrack-filter">3.1. </a></span></dt><dt><span class="section"><a href="#state-conntrack-nat">3.2. </a></span></dt></dl></dd></dl></div><p>
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="state-intro"></a>1. </h2></div></div></div><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="state-routing"></a>2. Statelessness of IP Routing</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="state-conntrack"></a>3. Netfilter Connection Tracking</h2></div></div></div><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="state-conntrack-filter"></a>3.1. </h3></div></div></div><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="state-conntrack-nat"></a>3.2. </h3></div></div></div><p>
      </p></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="part-cookbook"></a>Part II. Cookbook</h1></div></div></div><div class="partintro"><div></div><p>
      The content in this part is intended as a practical, hands-on guide
      to users wanting real, tested solutions.
    </p><p>
      The remainder of this documentation is written in a less formal style,
      and is heavy on examples.  It should be viewed as practical explication
      of the above chapters.
    </p><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="chapter"><a href="#ch-advanced">9. Advanced IP Management</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-arp-problem">1. Multiple IPs and the ARP Problem</a></span></dt><dt><span class="section"><a href="#adv-media-share">2. Multiple IP Networks on one Ethernet Segment</a></span></dt><dt><span class="section"><a href="#adv-proxy-arp">3. Breaking a network in two with proxy ARP</a></span></dt><dt><span class="section"><a href="#adv-multi-ips">4. Multiple IPs on an Interface</a></span></dt><dt><span class="section"><a href="#adv-multi-ethernet">5. Multiple connections to the same Ethernet</a></span></dt><dt><span class="section"><a href="#adv-multi-homed">6. Multihomed Hosts</a></span></dt><dt><span class="section"><a href="#adv-nonlocal-bind">7. Binding to Non-local Addresses</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-advanced-routing">10. Advanced IP Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-routing">1. Introduction to Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-overview">2. Overview of Routing and Packet Filter Interactions</a></span></dt><dt><span class="section"><a href="#adv-rpdb">3. Using the Routing Policy Database and Multiple Routing
      Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-routing-tos">3.1. Using Type of Service Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-fwmark">3.2. Using fwmark for Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-nat">3.3. Policy Routing and NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#adv-multi-internet">4. Multiple Connections to the Internet</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-multi-internet-outbound">4.1. Outbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-inbound">4.2. Inbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-bidirectional">4.3. Using Multiple Connections to the Internet for Inbound and
        Outbound Connections</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ax-scripts">11. Scripts for Managing IP</a></span></dt><dd><dl><dt><span class="section"><a href="#scripts-proxy-arp">1. Proxy ARP Scripts</a></span></dt><dt><span class="section"><a href="#scripts-nat">2. NAT Scripts</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ch-trouble">12. Troubleshooting</a></span></dt><dd><dl><dt><span class="section"><a href="#trouble-intro">1. Introduction to Troubleshooting</a></span></dt><dt><span class="section"><a href="#trouble-ethernet">2. Troubleshooting at the Ethernet Layer</a></span></dt><dt><span class="section"><a href="#trouble-ip">3. Troubleshooting at the IP Layer</a></span></dt><dt><span class="section"><a href="#trouble-routing">4. Handling and Diagnosing Routing Problems</a></span></dt><dt><span class="section"><a href="#trouble-tcp">5. Identifying Problems with TCP Sessions</a></span></dt><dt><span class="section"><a href="#trouble-dns">6. DNS Troubleshooting</a></span></dt></dl></dd></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-advanced"></a>Chapter 9. Advanced IP Management</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#adv-arp-problem">1. Multiple IPs and the ARP Problem</a></span></dt><dt><span class="section"><a href="#adv-media-share">2. Multiple IP Networks on one Ethernet Segment</a></span></dt><dt><span class="section"><a href="#adv-proxy-arp">3. Breaking a network in two with proxy ARP</a></span></dt><dt><span class="section"><a href="#adv-multi-ips">4. Multiple IPs on an Interface</a></span></dt><dt><span class="section"><a href="#adv-multi-ethernet">5. Multiple connections to the same Ethernet</a></span></dt><dt><span class="section"><a href="#adv-multi-homed">6. Multihomed Hosts</a></span></dt><dt><span class="section"><a href="#adv-nonlocal-bind">7. Binding to Non-local Addresses</a></span></dt></dl></div><p>
    In many of the previous chapters, we have covered the many of the key
    elements required to understand basic networking with linux.  In this
    chapter, we will introduce a few new concepts, but will endeavor to put
    some of the ideas together to solve practical networking problems.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-arp-problem"></a>1. Multiple IPs and the ARP Problem</h2></div></div></div><p>
      ARP flux. <code class="filename">/proc/sys/net/ipv4/conf/all/hidden</code>
      Nothing here for now.  Refer to
      <a class="xref" href="#ether-arp-flux" title="1.4. The ARP Flux Problem">Section 1.4, &#8220;The ARP Flux Problem&#8221;</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-media-share"></a>2. Multiple IP Networks on one Ethernet Segment</h2></div></div></div><p>
      Media share; IP overlay; compare VLANS; consider bridging; consider
      migrating from one IP space to another (vrrpd, anybody?).
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-proxy-arp"></a>3. Breaking a network in two with proxy ARP</h2></div></div></div><a class="indexterm" name="idm3096"></a><a class="indexterm" name="idm3099"></a><p>
      Proxy ARP is a technique for splitting an IP network into two
      separate segments.  Hosts on one segment can only reach hosts in the
      other segment through the router performing proxy ARP.  If a router sits
      between two parts of an IP network and is not running bridging software,
      then routes to hosts in each segment and proxy ARP are required
      on the router to allow each half of the
      network to communicate with the other half.
    </p><p>
      Occasionally, this technique is incorrectly called proxy ARP bridging.
      An Ethernet bridge operates on frames and a router operates on packets.
      The proxy ARP router should have routes to all hosts on both segments.
      Once the router can reach all locally connected destinations via the
      correct interfaces, you can begin to configure the proxy ARP
      functionality.
    </p><p>
      Although proxy ARP complicates a network, a great advantage of proxy ARP
      technique is the greater control over IP connections between hosts.
    </p><p>
      There are two primary proxy ARP techniques.  With the 2.4 kernel, it is
      possible to use the sysctl
      <code class="filename">net/ipv4/conf/all/proxy_arp</code> to perform proxy ARP.
      Alternatively, manual population of the ARP table reaches the same end.
    </p><p>
      The key part of the correct functioning of proxy ARP in a network is
      that the host breaking a network into two parts has correct routes for
      all destinations in both halves of the network.  If the host which has
      interfaces in both networks does not have an accurate routing table, IP
      packets will get dropped on the routing device.
    </p><p>
      One common method of breaking a network in two involves making a very
      small stub subnet at one end or the other of the IP range.  This small
      subnet (maybe as small as a /30 network, with two usable IPs) makes an
      excellent sequestered location for a host which requires more
      protection or even, a generally untrusted host which shouldn't have
      complete access to the Ethernet to which the other machines connect.
    </p><p>
      For a practical example of this, see the relationship between the
      <code class="systemitem">service-router</code>, <code class="systemitem">masq-gw</code> and <code class="systemitem">isolde</code> in the
      <a class="link" href="#example-network-netmap" title="1. Example Network Map and General Notes">network map</a>.  <code class="systemitem">isolde</code> and
      <code class="systemitem">service-router</code> share the same IP network, 192.168.100.0/24.  If either
      has a packet for the other, it will generate an ARP request which should
      be answered by <code class="systemitem">masq-gw</code>.  Naturally, <code class="systemitem">masq-gw</code> has its routes
      configured in such a way that both hosts are reachable from it.  Thus,
      the packet will successfully pass through <code class="systemitem">masq-gw</code>.
    </p><p>
      Let's examine what the sequence of events is by which the packet will
      reach <code class="systemitem">service-router</code> from <code class="systemitem">isolde</code>.  In this example, <code class="systemitem">isolde</code> will
      send an echo request packet to <code class="systemitem">service-router</code>.  Please also refer to
      <a class="xref" href="#tools-arp" title="1. arp">Section 1, &#8220;<span class="command"><strong>arp</strong></span>&#8221;</a> for examples and command lines to create
      a proxy ARP configuration.
    </p><a name="list-adv-proxy-arp"></a><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          the admin on <code class="systemitem">isolde</code> creates an echo request packet 
          for 192.168.100.1 with
          <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a>
        </p></li><li class="listitem"><p>
          <code class="systemitem">isolde</code> sends an ARP request for the owner of 192.168.100.1
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> replies that <code class="systemitem">isolde</code> should send packets for
          192.168.100.1 to its Ethernet address, 00:80:c8:f8:5c:71
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> receives the packet, unwraps it and selects eth3 as
          the output interface
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> sends an ARP request for the owner of 192.168.100.1
        </p></li><li class="listitem"><p>
          <code class="systemitem">service-router</code> replies that <code class="systemitem">masq-gw</code> should send packets for
          192.168.100.1 to its Ethernet address, 00:c0:7b:7d:00:c8
        </p></li><li class="listitem"><p>
          <code class="systemitem">service-router</code> receives the packet unwraps it and hands it up
          the IP stack, which generates an echo reply bound for the source
          address, 192.168.100.17 (<code class="systemitem">isolde</code>'s IP)
        </p></li><li class="listitem"><p>
          <code class="systemitem">service-router</code> sends an ARP request for the owner of 192.168.100.17
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> replies that <code class="systemitem">service-router</code> should send packets for
          192.168.100.17 to its Ethernet address, 00:80:c8:f8:5c:74
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> receives the packet, unwraps it and selects eth0 as
          the output interface
        </p></li><li class="listitem"><p>
          <code class="systemitem">masq-gw</code> sends an ARP request for the owner of 192.168.100.17
        </p></li><li class="listitem"><p>
          <code class="systemitem">isolde</code> replies that <code class="systemitem">masq-gw</code> should send packets for
          192.168.100.17 to its Ethernet address, 00:80:c8:e8:4b:8e
        </p></li><li class="listitem"><p>
          <code class="systemitem">isolde</code> receives the reply, unwraps it and hands it up the IP stack
          to the awaiting
          <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a> command
        </p></li></ul></div><p>
      Where possible, a simplified network is easier to maintain, but
      occasionally, this sort of trickery is necessary.  This is an excellent
      way to insert a firewall into the middle of a network.  The firewall,
      naturally, has to have its routes set properly, and proxy ARP entries
      will be required for routers.
    </p><p>
      Now, here's a short script and configuration file which can be run as a
      SysVInit style script.  This script provides a great deal of control
      over the ARP table directly so may be preferable in some cases to an
      alternate solution outlined below.  This
      <a class="link" href="#ex-sc-proxy-arp" title="Example 11.1. Proxy ARP SysV initialization script">proxy-arp script</a> reads the
      following
      <a class="link" href="#ex-sc-proxy-arp-conf" title="Example 11.2. Proxy ARP configuration file">configuration file</a>.
      Each is commented heavily so it should be clear how to use them.
    </p><p>
      This chapter discussed how to break a network in twain with proxy ARP
      techniques.  For another explanation of the same concepts, read the
      <a class="ulink" href="http://www.linuxpowered.com/HOWTO/mini/Proxy-ARP-Subnet/" target="_top">Proxy
      ARP Subnet mini-HOWTO</a>.  Available in most (all?) 2.4 kernels is
      built-in capability for Proxy ARP.  This is documented in deeper detail
      <a class="link" href="#ether-arp-proxy-kernel">above</a>.
      Consider familiarizing yourself with the methods of suppressing
      and controling ARP through
      <a class="ulink" href="http://www.ssi.bg/~ja/" target="_top">Julian
      Anastasov's work</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-multi-ips"></a>4. Multiple IPs on an Interface</h2></div></div></div><p>
      Don't forget to add something here about multiple IPs bound to
      loopback; and refer to Julian's work.  FIXME
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-multi-ethernet"></a>5. Multiple connections to the same Ethernet</h2></div></div></div><p>
      Assume a machine has multiple connections to the same Ethernet segment,
      and has individual IPs bound to each interface.  A peculiar feature of
      linux is its willingness to respond to ARP requests for any IP bound
      to any interface.  This can lead to ARP flux, a situation where a
      given IP is sometimes accessed on one MAC address and sometimes
      another.
    </p><p>
    </p><p>
    </p><p>
    </p><p>
      <code class="filename">/proc/sys/net/ipv4/conf/all/hidden</code>; consider  arp
      suppression issues.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-multi-homed"></a>6. Multihomed Hosts</h2></div></div></div><p>
      Consider ARP suppression issues.  Leakage of sensitive (IP addressing)
      information from other interfaces.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-nonlocal-bind"></a>7. Binding to Non-local Addresses</h2></div></div></div><p>
    </p><p>
      FIXME!! Don't forget to note that iproute2 NAT and binding to
      non-local IPs do not play well together.  I disagree with
      <a class="ulink" href="http://www.cs.helsinki.fi/linux/linux-kernel/2001-22/0813.html" target="_top">this</a>.
      Binding to a non-local socket, which was possible under
      kernel 2.2 with when the kernel was compiled with
      CONFIG_IP_TRANSPROXY, is available under kernel 2.4 via the
      <code class="filename">/proc</code> IP sysctl interface.  If you wish to be
      able to bind to non-local sockets:
      </p><pre class="programlisting">
<code class="prompt"># </code><strong class="userinput"><code>echo 1 &gt; /proc/sys/net/ipv4/ip_nonlocal_bind</code></strong>
      </pre><p>
      Thanks go to Oskar Andreasson for his IP sysctl tutorial page.
      If using sysctl to allow binding to non-local IP doesn't solve
      your problem, then see if
      <a class="link" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">netfilter NAT</a>
      can be used to solve this class of problem.
      Some people view the technique of binding to non-local IPs as
      spoofing, and indeed, it can be used for nefarious purposes, if an
      attacker controls a machine on the route between a target and a
      victim.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-advanced-routing"></a>Chapter 10. Advanced IP Routing</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#adv-routing">1. Introduction to Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-overview">2. Overview of Routing and Packet Filter Interactions</a></span></dt><dt><span class="section"><a href="#adv-rpdb">3. Using the Routing Policy Database and Multiple Routing
      Tables</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-routing-tos">3.1. Using Type of Service Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-fwmark">3.2. Using fwmark for Policy Routing</a></span></dt><dt><span class="section"><a href="#adv-routing-nat">3.3. Policy Routing and NAT</a></span></dt></dl></dd><dt><span class="section"><a href="#adv-multi-internet">4. Multiple Connections to the Internet</a></span></dt><dd><dl><dt><span class="section"><a href="#adv-multi-internet-outbound">4.1. Outbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-inbound">4.2. Inbound traffic Using Multiple Connections to the
        Internet</a></span></dt><dt><span class="section"><a href="#adv-multi-internet-bidirectional">4.3. Using Multiple Connections to the Internet for Inbound and
        Outbound Connections</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-routing"></a>1. Introduction to Policy Routing</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-overview"></a>2. Overview of Routing and Packet Filter Interactions</h2></div></div></div><p>
      One of the most difficult aspects of working with the advanced routing
      features of linux is gaining an understanding the sequence of events
      as a packet traverses the kernel space.  It is, in fact, the key
      knowledge needed to grasp the potential of advanced routing scenarios
      and to troubleshoot successfully when things don't go as planned.
    </p><p>
      If you are reading this for the first time, stop now and go visit and
      study 
      <a class="ulink" href="http://docum.org/stef.coene/qos/kptd/" target="_top">the kernel
      packet traveling diagram</a> and
      <a class="ulink" href="http://open-source.arkoon.net/kernel/kernel_net.png" target="_top">the
      kernel packet handling diagram</a> now.  These represent two
      different efforts to describe the order in which different
      networking subsystems inside the linux kernel have an opportunity to
      inspect, manipulate and redirect a packet.  Understanding this
      sequence of events is key to harnessing the power of linux networking.
    </p><p>
      Now, let's examine some of the different commands you can use to
      manipulate packets at each of these stages.  The list below describes
      the sequence of events for a packet bound for a non-local destination.
    </p><a name="adv-overview-kptd-forwarded"></a><div class="itemizedlist"><p class="title"><b>Packet Traversal; Non-Local Destination</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          All of the PREROUTING netfilter hooks are called here.  This
          means that we get our first opportunity to inspect and drop a
          packet, we can perform DNAT on the packet to make sure that the
          destination IP is rewritten before we make a routing decision
          (at which time the destination address becomes very important).
          We can also set ToS or an fwmark on the packet at this time.  If
          we want to use an IMQ device for ingress control, we can put our
          hooks here.
        </p></li><li class="listitem"><p>
          If we are using ipchains, the input chain is traversed.
        </p></li><li class="listitem"><p>
          Any traffic control on the real device on which the packet arrived
          is now performed.
        </p></li><li class="listitem"><p>
          The input routing stage is traversed by any packet entering the
          local machine.  Here we concern ourselves only with packets which
          are routed through this machine to another destination
          Additionally, iproute2 NAT occurs here
          <a href="#ftn.idm3231" class="footnote" name="idm3231"><sup class="footnote">[36]</sup></a>.
        </p></li><li class="listitem"><p>
          The packet enters the FORWARD netfilter hooks.  Here, the packet
          can be mangled with ToS or fwmark.  After the mangle chain is
          passed, the filter chain will be traversed.  For kernel 2.4-based
          routing devices this will be the location for packet filtering
          rules.  If we are using ipchains, the forward chain would be
          traversed here instead of the netfilter FORWARD hooks.
        </p></li><li class="listitem"><p>
          The output chain in an ipchains installation would be traversed
          here.
        </p></li><li class="listitem"><p>
          The POSTROUTING netfilter hooks are traversed.  These include
          packet mangling, NAT and IMQ for egress.
        </p></li><li class="listitem"><p>
          Finally, the packet is transmitted via the outbound device per
          traffic control configuration on that outbound device.
        </p></li></ul></div><p>
      The above describes the sequence of events for packets passing through
      the linux routing device.  Let's look at a similar descriptions of the
      paths that packets bound for local destinations take through the
      kernel.
    </p><a name="adv-overview-kptd-local-dest"></a><div class="itemizedlist"><p class="title"><b>Packet Traversal; Local Destination</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          All of the PREROUTING netfilter hooks are called here.  This
          means that we get our first opportunity to inspect and drop a
          packet, we can perform DNAT on the packet to make sure that the
          destination IP is rewritten before we make a routing decision
          (at which time the destination address becomes very important).
          We can also set ToS or an fwmark on the packet at this time.  If
          we want to use an IMQ device for ingress control, we can put our
          hooks here.
        </p></li><li class="listitem"><p>
          If we are using ipchains, the input chain is traversed.
        </p></li><li class="listitem"><p>
          Any traffic control on the real device on which the packet arrived
          is now performed.
        </p></li><li class="listitem"><p>
          The input routing stage is traversed by any packet entering the
          local machine.  Here we concern ourselves with packets bound for
          local destinations only.
        </p></li><li class="listitem"><p>
          The INPUT netfilter hooks are traversed.  Commonly this is
          filtering for inbound connections, but can include packet
          mangling.
        </p></li><li class="listitem"><p>
          The local destination process receives the connection.  If there
          is no open socket, an error is generated.
        </p></li></ul></div><p>
      Naturally, packets need to go out from the machine as well, so let's
      look at the path for outbound packets which were locally generated.
    </p><a name="adv-overview-kptd-local-gen"></a><div class="itemizedlist"><p class="title"><b>Packet Traversal; Locally Generated</b></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          The process with the open socket sends data.
        </p></li><li class="listitem"><p>
          The routing decision is made.  This is frequently called output
          routing because it is only for packets leaving the system.  This
          routing code is (sometimes?) responsible for selecting the source
          IP of the outbound packet.
        </p></li><li class="listitem"><p>
          The netfilter OUTPUT hooks are traversed.  The basic filter, nat,
          and mangle hooks are available.  This is where SNAT can take
          place.
        </p></li><li class="listitem"><p>
          The output chain in an ipchains installation would be traversed
          here.
        </p></li><li class="listitem"><p>
          The POSTROUTING netfilter hooks are traversed.  These include
          packet mangling, NAT and IMQ for egress.
        </p></li><li class="listitem"><p>
          Finally, the packet is transmitted via the outbound device per
          traffic control configuration on that outbound device.
        </p></li></ul></div><p>
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-rpdb"></a>3. Using the Routing Policy Database and Multiple Routing
      Tables</h2></div></div></div><p>
      Understanding and practically applying the knowledge of how and when to
      harness the routing features of linux is a matter of experience.  The
      below is a set of examples for how to use the RPDB and multiple routing
      tables to solve different types of problems.  These are but a few simple
      examples which allude to the flexibility and power available with the
      complex policy routing system under linux.
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-routing-tos"></a>3.1. Using Type of Service Policy Routing</h3></div></div></div><p>
        Type of Service (ToS) is a flag in the header of an IP packet
        which is sometimes honored by upstream routers.  Some routers on the
        Internet respect the ToS flag and others do not, however, the ToS flag
        can be used as part of the decision about where to route a given
        packet (for a refresher on the keys used for routing to a destination
        read
        <a class="xref" href="#routing-selection" title="5. Route Selection">Section 5, &#8220;Route Selection&#8221;</a>).  Because it can be used as part
        of the routing decision, ToS can be used to select a route separate
        from the route chosen for normal packets (packets not marked with any
        ToS).
      </p><p>
      </p><p>
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-routing-fwmark"></a>3.2. Using fwmark for Policy Routing</h3></div></div></div><p>
        FIXME!! Don't forget to point out that fwmark with ipchains/iptables
        is a decimal number, but that iproute2 uses hexadecimal number.
        Thanks to Jose Luis Domingo Lopez for his <a class="ulink" href="http://mailman.ds9a.nl/pipermail/lartc/2002q3/005039.html" target="_top">post</a>
        to the LARTC list!
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-routing-nat"></a>3.3. Policy Routing and NAT</h3></div></div></div><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="adv-multi-internet"></a>4. Multiple Connections to the Internet</h2></div></div></div><p>
      The questions summarized in this section should rightly be entered
      into the FAQ, since they are FAQs on the
      <a class="ulink" href="http://mailman.ds9a.nl/mailman/listinfo/lartc" target="_top">LARTC
      list</a>.
    </p><p>
      There are many places where a linux based router/masquerading device
      can assist in managing multiple Internet connections.  We'll outline
      here some of the more common setups involving multiple Internet
      connections and how to manage them with <span class="command"><strong>iptables</strong></span>,
      <span class="command"><strong>ipchains</strong></span>, and <span class="command"><strong>iproute2</strong></span>.  One of
      the first distinctions you can make when planning how to use multiple
      Internet connections is what inbound services you expect to host and
      how you want to split traffic over the multiple links.
    </p><p>
      In the discussion and examples below, I'll address the issues involved
      with two separate uplinks to two different providers.  I assume the
      following:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          You are not using BGP, and you do not have your own AS.  If you
          are using BGP and have your own AS, you have a different set of
          problems than the problems described here
          <a href="#ftn.idm3309" class="footnote" name="idm3309"><sup class="footnote">[37]</sup></a>.
        </p></li><li class="listitem"><p>
          You have two netblocks from two different ISPs.
        </p></li><li class="listitem"><p>
          You are funneling your internal network through this routing
          device, which is performing masquerading/NAT to the Internet.
        </p></li></ul></div><p>
      Additionally, I'll restrict my comments to statically assigned public
      IP address ranges unless I mention (in particular) dynamically
      allocated addresses.
    </p><p>
      In the following sections we'll look at the use of multiple Internet
      connections first in terms of
      <a class="link" href="#adv-multi-internet-outbound" title="4.1. Outbound traffic Using Multiple Connections to the Internet">outbound
      traffic only</a>, then in terms of
      <a class="link" href="#adv-multi-internet-inbound" title="4.2. Inbound traffic Using Multiple Connections to the Internet">inbound traffic
      only</a>.  After that, we'll look at using multiple Internet
      connections for
      <a class="link" href="#adv-multi-internet-bidirectional" title="4.3. Using Multiple Connections to the Internet for Inbound and Outbound Connections">handling both
      inbound and outbound services</a>.
    </p><p>
    </p><p>
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-multi-internet-outbound"></a>4.1. Outbound traffic Using Multiple Connections to the
        Internet</h3></div></div></div><p>
        There are two main uses for multiple Internet links connected to the
        same internal network.  One common use is to select an outbound link
        based on the type of outbound service.  The other is to split traffic
        arbitrarily across multiple ISPs for reasons like failover and to
        accommodate greater aggregate bandwidth than would be available
        on a single uplink.
      </p><p>
        If your need is the latter, please consult the documentation on the
        <a class="ulink" href="http://lartc.org/howto/lartc.rpdb.multiple-links.html" target="_top">LARTC
        site</a>, as it does a good job of summarizing the issues
        involved and describes how to accomplish this.  This type of use of
        multiple Internet connections means that (from the perspective of
        the linux routing device), there is a multipath default route.  The
        LARTC documentation remarks that Julian Anastasov's patches "make
        things nicer to work with."  The patches to which the LARTC
        documents are referring are Julian's dead gateway detection
        patches (at least) which can help the linux routing device provide
        Internet service to the internal network when one of the links is
        down.  See <a class="ulink" href="http://www.ssi.bg/~ja/#routes" target="_top">here for
        Julian's route work</a>.
      </p><p>
        In the remainder of this section, we'll discuss how to classify
        traffic for different ISPs, how to handle the packet filtering for
        this sort of classification scheme, and how to create routing tables
        appropriate for the task at hand.
        If anything at all seems unclear in this section, you may find a
        quick re-reading of <a class="link" href="#adv-overview" title="2. Overview of Routing and Packet Filter Interactions">the advanced
        routing overview</a> quite fruitful.
      </p><p>
        The simplest way to split Internet access into two separate groups
        is by source IP of the outbound packet.  This can be done most
        simply with <span class="command"><strong>ip rule</strong></span> and a second routing table.
        We'll assume that <code class="systemitem">masq-gw</code> in the example network gets a second,
        low cost network connection through a DSL vendor.
      </p><p>
        The DSL IP on <code class="systemitem">masq-gw</code> will be 67.17.28.12 with a gateway of
        67.17.28.14.  We'll assume that this is for outbound connectivity
        only, and that the IP is active on eth4 of the <code class="systemitem">masq-gw</code> machine.
        Before beginning let's outline the process we are going to follow.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Copy the main routing table to another routing table and set the
            alternate default route
            <a href="#ftn.idm3340" class="footnote" name="idm3340"><sup class="footnote">[38]</sup></a>.
          </p></li><li class="listitem"><p>
            Use <span class="command"><strong>iptables</strong></span>/<span class="command"><strong>ipchains</strong></span> to
            mark traffic with fwmark.
          </p></li><li class="listitem"><p>
            Add a rule to the routing policy database.
          </p></li><li class="listitem"><p>
            Test!
          </p></li></ul></div><p>
        Here's a short snippet of shell which you may find handy for copying
        one routing table to another; see <a class="ulink" href="scripts/copy-routing-table.sh" target="_top">the full script</a> for a
        more generalized example.
      </p><div class="example"><a name="ex-adv-multi-internet-outbound-ip-routing"></a><p class="title"><b>Example 10.1. Multiple Outbound Internet links, part I;
          <span class="command">ip route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table main</code></strong>
<code class="computeroutput">192.168.100.0/30 dev eth3  scope link
67.17.28.0/28 dev eth4  scope link
205.254.211.0/24 dev eth1  scope link
192.168.100.0/24 dev eth0  scope link
192.168.99.0/24 dev eth0  scope link
192.168.98.0/24 via 192.168.99.1 dev eth0
10.38.0.0/16 via 192.168.100.1 dev eth3
127.0.0.0/8 dev lo  scope link 
default via 205.254.211.254 dev eth1</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush table 4</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table main | grep -Ev ^default \</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>  | while read ROUTE ; do</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>    ip route add table 4 $ROUTE</code></strong>
<code class="prompt">&gt; </code><strong class="userinput"><code>done</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add table 4 default via 67.17.28.14</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table 4</code></strong>
<code class="computeroutput">192.168.100.0/30 dev eth3  scope link
67.17.28.0/28 dev eth4  scope link
205.254.211.0/24 dev eth1  scope link
192.168.100.0/24 dev eth0  scope link
192.168.99.0/24 dev eth0  scope link
192.168.98.0/24 via 192.168.99.1 dev eth0
10.38.0.0/16 via 192.168.100.1 dev eth3
127.0.0.0/8 dev lo  scope link 
default via 67.17.28.14 dev eth4</code>
        </pre></div></div><br class="example-break"><p>
        Now, exactly what have we just done?  We have created two routing
        tables on <code class="systemitem">masq-gw</code> each of which has a different default gateway.
        We have successfully accomplished the first part of our
        preparations.
      </p><p>
        Now, let's mark the traffic we would like to route in using
        conditional logic.  We'll use <span class="command"><strong>iptables</strong></span> to select
        traffic bound for destination ports 80 and 443 originating in the
        main office desktop network.
      </p><div class="example"><a name="ex-adv-multi-internet-outbound-iptables"></a><p class="title"><b>Example 10.2. Multiple Outbound Internet links, part II;
          <span class="command">iptables</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -t mangle -A PREROUTING -p tcp --dport 80 -s 192.168.99.0/24 -j MARK --set-mark 4</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -t mangle -A PREROUTING -p tcp --dport 443 -s 192.168.99.0/24 -j MARK --set-mark 4</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -t mangle -nvL</code></strong>
<code class="computeroutput">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source                destination         
    0     0 MARK       tcp  --  *      *       192.168.99.0/24       0.0.0.0/0          tcp dpt:80 MARK set 0x4 
    0     0 MARK       tcp  --  *      *       192.168.99.0/24       0.0.0.0/0          tcp dpt:443 MARK set 0x4 

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
  pkts bytes target     prot opt in     out     source               destination</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -t nat -A POSTROUTING -o eth4 -j SNAT --to-source 67.17.28.12</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>iptables -t nat -A POSTROUTING -o eth1 -j SNAT --to-source 205.254.211.179</code></strong>
<code class="computeroutput">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 SNAT       all  --  *      eth4    0.0.0.0/0            0.0.0.0/0          to:67.17.28.12
    0     0 SNAT       all  --  *      eth1    0.0.0.0/0            0.0.0.0/0          to:205.254.211.179

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination</code>
        </pre></div></div><br class="example-break"><p>
        With these <span class="command"><strong>iptables</strong></span> lines we have instructed
        netfilter to mark packets matching these criteria with the fwmark
        and we have prepared the NAT rules so that our outbound packets will
        originate from the correct IPs.
      </p><p>
        Once again, it is important to realize that the fwmark added
        to a packet is only valid and discernible while the packet is
        still on the host running the packet filter.  The fwmark is stored
        in a data structure the kernel uses to track the packet.
        Because the fwmark is not a part of the packet itself, the fwmark is
        lost as soon as the packet has left the local machine.  For more
        detail on the use of fwmark, see
        <a class="xref" href="#adv-routing-fwmark" title="3.2. Using fwmark for Policy Routing">Section 3.2, &#8220;Using fwmark for Policy Routing&#8221;</a>.
      </p><p>
        <span class="command"><strong>iproute2</strong></span> supports the use of fwmark as a selector
        for rule lookups, so we can use fwmarks in the routing policy
        database to cause packets to be conditionally routed based on that
        fwmark.  This can lead to great complexity if a machine has multiple
        routing tables, packet filters, and other fancy networking tools,
        such as NAT or proxies.  Caveat emptor.
      </p><p>
        A convention I find sensible is to use the same number for a routing
        table and fwmark where possible.  This simplifies the maintenance of
        the systems which are using <span class="command"><strong>iproute2</strong></span> and fwmark,
        especially if the table identifier and fwmark are set in a
        configuration file with the same variable name.  Since we are
        testing this on the command line, we'll just make sure that we can
        add the rules first.
      </p><div class="example"><a name="ex-adv-multi-internet-outbound-ip-rule"></a><p class="title"><b>Example 10.3. Multiple Outbound Internet links, part III;
          <span class="command">ip rule</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add fwmark 4 table 4</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32765:  from all fwmark        4 lookup 4 
32766:  from all lookup main 
32767:  from all lookup 253</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush cache</code></strong>
        </pre></div></div><br class="example-break"><p>
        The last piece is in place.  Now, users in the 192.168.99.0/24 subnet
        who are browsing the Internet should be using the DSL line instead
        of the T1 line for connectivity.
      </p><p>
        In order to verify that traffic is indeed getting marked and
        routed appropriately, you should use <span class="command"><strong>tcpdump</strong></span> to
        profile the outbound traffic on each link at the same time as you
        generate outbound traffic on both links.  
      </p><p>
        The above is a cookbook example of categorizing traffic,
        and sending the traffic out across different
        providers.  To my knowledge, the commonest reason to use this sort
        of solution is to separate traffic by importance and use a reliable
        (and perhaps more costly) link for the more important traffic while
        reserving the less costly Internet connection for other connections.
        In the above illustrative case, we have simply selected the web
        traffic for the less reliable (DSL) provider.
      </p><p>
        Once again, if you would like to split load over multiple links
        regardless of classification of traffic, then you really want a
        multipath default route, which is described and documented very well
        <a class="ulink" href="http://lartc.org/howto/lartc.rpdb.multiple-links.html" target="_top">in
        the LARTC HOWTO</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-multi-internet-inbound"></a>4.2. Inbound traffic Using Multiple Connections to the
        Internet</h3></div></div></div><p>
        There are many different ways to handle hosting servers to multiple
        ISPs, and most of them are out of the scope of this document.  If
        you are in need of this sort of advanced networking, you probably
        already know where to research.  If not, I'd suggest starting your
        research in load balancing, global load balancing, failover, and
        layer 4-7 switching.  These are networking tools which can
        facilitate the management of a highly available service.
      </p><p>
        Publishing the same service on two different ISPs is can be
        formidable challenge.  While this is possible using
        some of the advanced networking features under linux, one should
        understand the greater issues involved with publishing a service on
        two public IPs, especially if the idea is to provide service to the
        general Internet even if one of the ISPs go down.  For a
        thorough examination of the topics involved with load balancing of
        all kinds, see Chandra Kopparapu's book Load Balancing Servers,
        Firewalls and Caches.
      </p><p>
        If you are aware of the many difficult issues involved in handling
        inbound connections to a network, and still want to publish a
        service on two different ISPs (perhaps before you have a more robust
        load balancing/upper layer switching technology in place), you'll
        find the recipe below.
      </p><p>
        Before we examine the recipe, let's look at a complex scenario to
        see what the crucial points are.  If you do not have the
        <a class="ulink" href="http://www.docum.org/stef.coene/qos/kptd/" target="_top">kernel
        packet traveling diagram</a> memorized, you may wish to refer to
        it in the following discussion.  One other item to remember is that
        routing decisions are stateless
        <a href="#ftn.idm3426" class="footnote" name="idm3426"><sup class="footnote">[39]</sup></a>.
      </p><p>
        We'll assume that the client IP is a fixed IP (64.70.12.210) and
        we'll discuss how this client IP would reach each of the services 
        published on <code class="systemitem">masq-gw</code>'s two public networks.  The IPs used for
        the services will be 67.17.28.10 and 205.254.211.17.
        Now, whether you are using NAT with <span class="command"><strong>iproute2</strong></span> or
        with iptables, you'll run across the problem here outlined.  Here
        is the flow of the packet through <code class="systemitem">masq-gw</code> to the server and back
        to the client.
      </p><a name="ol-adv-multi-internet-inbound"></a><div class="orderedlist"><p class="title"><b>Inbound NAT to the same server via two public IPs in two
          different networks</b></p><ol class="orderedlist" type="1"><li class="listitem"><p>
            inbound packet from 64.70.12.210 to 67.17.28.10 arrives on eth4
          </p></li><li class="listitem"><p>
            packet is accepted, rewritten, and routed; from 64.70.12.210 to
            192.168.100.17;  if <span class="command"><strong>iptables</strong></span> DNAT,
            packet is rewritten in PREROUTING chain of nat table, then
            routed;  if <span class="command"><strong>iproute2</strong></span>, packet is routed and
            rewritten simultaneously
          </p></li><li class="listitem"><p>
            rewritten packet is transmitted out eth0
          </p></li><li class="listitem"><p>
            <code class="systemitem">isolde</code> receives packet, accepts, responds
          </p></li><li class="listitem"><p>
            inbound packet from 192.168.100.17 to 64.70.12.210
          </p></li><li class="listitem"><p>
            routing decision is made; default route (via 205.254.211.254) is
            selected; if <span class="command"><strong>iproute2</strong></span> is used, packet is
            also rewritten from 67.17.28.10 to 64.70.12.210
          </p></li><li class="listitem"><p>
            if <span class="command"><strong>iptables</strong></span> DNAT is used, connection tracking
            will take care of rewriting this packet from 67.17.28.10 to
            64.70.12.210
          </p></li><li class="listitem"><p>
            packet is transmitted out eth1
          </p></li></ol></div><p>
        This is the problem!  The packet may have the correct source
        address, but it is leaving via the wrong interface.  Many ISPs
        filter traffic entering their network and will block traffic from
        your network with source IPs outside your allocated range.  To an
        ISP this looks like spoofed traffic.
      </p><p>
        The solution is marvelously elegant and simple.  Select one IP on
        the internal server which will be reachable via one provider and one
        IP which will be reachable via the other provider.  By using two IP
        addresses on the internal machine, we can use <span class="command"><strong>ip
        rule</strong></span> on <code class="systemitem">masq-gw</code> to select a routing table with a
        different default route based upon the source IP of the response
        packets to clients.  Below, we'll assume the same routing tables as
        in the previous section (cf.
        <a class="xref" href="#adv-multi-internet-outbound" title="4.1. Outbound traffic Using Multiple Connections to the Internet">Section 4.1, &#8220;Outbound traffic Using Multiple Connections to the
        Internet&#8221;</a>).
      </p><p>
        Here we have a server <code class="systemitem">isolde</code> which needs to be accessible via two
        different public IP addresses.  We'll add an IP address to <code class="systemitem">isolde</code>
        so that it is reachable on 192.168.100.10 as well as 192.168.100.17.
        Then, the following rules on <code class="systemitem">masq-gw</code> will ensure that packets are
        rewritten and routed in order to avoid the problem pointed out
        <a class="link" href="#ol-adv-multi-internet-inbound">above</a>.
      </p><div class="example"><a name="ex-adv-multi-internet-inbound"></a><p class="title"><b>Example 10.4. Multiple Internet links, inbound traffic; using
          <span class="command">iproute2</span> only
          <a href="#ftn.idm3470" class="footnote" name="idm3470"><sup class="footnote">[40]</sup></a>
        </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add nat 67.17.28.10 via 192.168.100.10</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add nat 67.17.28.10 from 192.168.100.10 table 4</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add nat 205.254.211.17 via 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add nat 205.254.211.17 from 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32765:  from 192.168.100.17 lookup main map-to 205.254.211.17
32765:  from 192.168.100.10 lookup 4 map-to 67.17.28.10
32766:  from all lookup main 
32767:  from all lookup 253</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table local | grep ^nat</code></strong>
<code class="computeroutput">nat 205.254.211.17 via 192.168.100.17  scope host 
nat 67.17.28.10 via 192.168.100.10  scope host</code>
        </pre></div></div><br class="example-break"><p>
      </p><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="adv-multi-internet-bidirectional"></a>4.3. Using Multiple Connections to the Internet for Inbound and
        Outbound Connections</h3></div></div></div><p>
      </p><p>
      </p><p>
      </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm3231" class="footnote"><p><a href="#idm3231" class="para"><sup class="para">[36] </sup></a>
              Leonardo calls this "dumb NAT" because the NAT performed by
              <span class="command"><strong>iproute2</strong></span> at the routing stage is stateless.
            </p></div><div id="ftn.idm3309" class="footnote"><p><a href="#idm3309" class="para"><sup class="para">[37] </sup></a>
              Anybody who has any experience with linux as a firewall behind
              a BGP device?  Linux as a firewall/router running BGP?
              Thoughts?  Things I should include here?  Yeah, I know about
              <a class="ulink" href="http://www.zebra.org/" target="_top">Zebra</a>, but I
              haven't ever used it.
            </p></div><div id="ftn.idm3340" class="footnote"><p><a href="#idm3340" class="para"><sup class="para">[38] </sup></a>
                Sometimes it may not be quite proper to simply copy the main
                routing table to another routing table.  You may want a
                subset of hosts on the internal network to access the
                alternate link.  Anybody have any sage advice here for the
                newbie in multiple routing tables?
              </p></div><div id="ftn.idm3426" class="footnote"><p><a href="#idm3426" class="para"><sup class="para">[39] </sup></a>
            The following discussion is actually a restatement of
            <a class="ulink" href="http://lists.netfilter.org/pipermail/netfilter/2001-May/011697.html" target="_top">Wes
            Hodges' posting</a> on his solution to this problem.
          </p></div><div id="ftn.idm3470" class="footnote"><p><a href="#idm3470" class="para"><sup class="para">[40] </sup></a>
              This example makes no reference to packet filtering.  If you are
              reading this, I assume you are competent at determining the
              packet filtering issues.  If you have doubts about what rules to
              add, see <a class="xref" href="#nat-stateless-pf-interaction" title="4. Stateless NAT and Packet Filtering">Section 4, &#8220;Stateless NAT and Packet Filtering&#8221;</a>.
            </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ax-scripts"></a>Chapter 11. Scripts for Managing IP</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#scripts-proxy-arp">1. Proxy ARP Scripts</a></span></dt><dt><span class="section"><a href="#scripts-nat">2. NAT Scripts</a></span></dt></dl></div><p>
    Here are some scripts which may come in handy for manipulating different
    features of the linux networking stack.  If you'd like, you can get a
    <a class="ulink" href="scripts/linux-ip-scripts.tar.gz" target="_top">tarball</a>
    of these scripts to take home with you.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripts-proxy-arp"></a>1. Proxy ARP Scripts</h2></div></div></div><p>
      The proxy ARP script was written before the kernel supported proxy ARP
      natively.  If you simply want proxy ARP to work, then you need only
      <a class="link" href="#ether-arp-proxy-kernel">enable it in your 2.4
      kernel</a>.  If you require more control than afforded by the kernel
      proxy ARP functionality and you wish to recompile
      <span class="command"><strong>iproute2</strong></span> and your kernel, you can use the
      <span class="command"><strong>iproute2</strong></span> extension,
      <a class="link" href="#ether-arp-filtering" title="3. ARP filtering"><span class="command"><strong>ip arp</strong></span></a>.
      Otherwise, you might try this script.
    </p><div class="example"><a name="ex-sc-proxy-arp"></a><p class="title"><b>Example 11.1. Proxy ARP SysV initialization script</b></p><div class="example-contents"><p>
        <a class="ulink" href="scripts/proxy-arp" target="_top">Download.</a>
      </p><pre class="programlisting">
#! /bin/sh -
#
# proxy-arp	Set proxy-arp settings in arp cache
#
# chkconfig: 2345 15 85
# description: using the arp command line utility, populate the arp
#              cache with IP addresses for hosts on different media
#              which share IP space.
#  
# Copyright (c)2002 SecurePipe, Inc. - http://www.securepipe.com/
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, 
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
# -- written initially during 1998
#    2002-08-14; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - cleaned up and commented extensively
#      - joined the process parsimony bandwagon, and eliminated
#        many unnecessary calls to ifconfig and awk
#

gripe () {  echo "$@" &gt;&amp;2;               }
abort () {  gripe "Fatal: $@"; exit 1;   }

CONFIG=${CONFIG:-/etc/proxy-arp.conf}
[ -r "$CONFIG" ] || abort $CONFIG is not readable

case "$1" in
  start)
        # -- create proxy arp settings according to
        #    table in the config file
        #
        grep -Ev '^#|^$' $CONFIG | {
          while read INTERFACE IPADDR ; do
            [ -z "$INTERFACE" -o -z "$IPADDR" ] &amp;&amp; continue
            arp -s $IPADDR -i $INTERFACE -D $INTERFACE pub
          done
        }
	;;
  stop)
	# -- clear the cache for any entries in the
        #    configuration file
        #
        grep -Ev '^#|^$' /etc/proxy-arp.conf | {
          while read INTERFACE IPADDR ; do
            [ -z "$INTERFACE" -o -z "$IPADDR" ] &amp;&amp; continue
            arp -d $IPADDR -i $INTERFACE
	  done
        }
	;;
  status)
        arp -an | grep -i perm
	;;
  restart)
	$0 stop
	$0 start
	;;
  *)
	echo "Usage: proxy-arp {start|stop|restart}"
	exit 1
esac

exit 0
#   
# - end of proxy-arp


      </pre></div></div><br class="example-break"><div class="example"><a name="ex-sc-proxy-arp-conf"></a><p class="title"><b>Example 11.2. Proxy ARP configuration file</b></p><div class="example-contents"><p>
        <a class="ulink" href="scripts/proxy-arp.conf" target="_top">Download.</a>
      </p><pre class="programlisting">
#  
# Proxy ARP configuration file
#
# -- This is the proxy-arp configuration file.  A sysV init script
#    (proxy-arp) reads this configuration file and creates the
#    required arp table entries.
#
# Copyright (c)2002 SecurePipe, Inc. - http://www.securepipe.com/
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, 
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#
# -- file was created during 1998
#    2002-08-15; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - format unchanged
#      - added comments
#
# -- field descriptions:
#    field 1   this field contains the ethernet interface on which
#              to advertise reachability of an IP.
#    field 2   this field contains the IP address for which to advertise
#
# -- notes
#
#    - white space, lines beginning with a comment and blank lines are ignored
#
# -- examples
#
#    - each example is commented with an English description of the
#      resulting configuration
#    - followed by a pseudo shellcode description of how to understand
#      what will happen
#
# -- example #0; advertise for 10.10.15.175 on eth1
#
# eth1 10.10.15.175
#
# for any arp request on eth1; do
#   if requested address is 10.10.15.175; then
#     answer arp request with our ethernet address from eth1 (so
#       that the reqeustor sends IP packets to us)
#   fi
# done
#
# -- example #1; advertise for 172.30.48.10 on eth0
#
# eth0 172.30.48.10
#
# for any arp request on eth0; do
#   if requested address is 172.30.48.10; then
#     answer arp request with our ethernet address from eth1 (so
#       that the reqeustor sends IP packets to us)
#   fi
# done
#
# -- add your own configuration here


# -- end /etc/proxy-arp.conf
#   

      </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripts-nat"></a>2. NAT Scripts</h2></div></div></div><p>
      The script will remove all NAT route entries and then all RPDB entries,
      other than the three default entries and anything saying "iif lo".  It
      will then populate the RPDB and create NAT route entries according to
      the configuration file.  Use this script with caution if you have
      customized your RPDB.
    </p><div class="example"><a name="ex-sc-nat"></a><p class="title"><b>Example 11.3. Static NAT SysV initialization script</b></p><div class="example-contents"><p>
        <a class="ulink" href="scripts/nat" target="_top">Download.</a>
      </p><pre class="programlisting">
#! /bin/sh -
#
# nat;  start and stop network address translations using iproute2 tools
#
# chkconfig: 345 45 55
# description: iproute2 tools allow for sophisticated routing, network
#              address translation, and policy based routing.  This script
#              generalizes static NAT mappings and exceptions.
#  
# Copyright (c)2002 SecurePipe, Inc. - http://www.securepipe.com/
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, 
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#
# -- written initially, 2002-03-02; -MAB
#    2002-08-14; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - cleaned up and commented the code a bit
#      - altered the script to provide support for NAT from user-specified
#        networks instead of assuming that anything from 0/0 should be
#        translated
#    2002-08-30; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - add configuration setting to flush all NAT rules and routes before
#        installing new rules and routes
#      - add a ./nat flush option
#    2003-01-31; Matthew Callaway &lt;matt@securepipe.com&gt;
#      - add validation routines
#    2003-02-05; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - oversight identified by Shawn Balestracci; not all NAT rules
#        were flushed--we were looking only for map-to, not the exclude
#        rules as well

gripe () {  echo "$@" &gt;&amp;2;               }
abort () {  gripe "Fatal: $@"; exit 1;   }

CONFIG=${CONFIG:-/etc/sysconfig/static-nat}
[ -r "$CONFIG" ] || abort $CONFIG is not readable

function isIP () {
  # -- this function validates a variable as a valid IP address or CIDR network
  #
  VAR=$1

  echo ${VAR} | grep -Eq \
    "[[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]]{1,3}(|[[:digit:]]{1,2})"

  [ $? -eq 0 ] &amp;&amp; return 0
  return 1
}

function isINT () {
  # -- this function validates a variable as a valid integer
  #
  VAR=$1

  echo ${VAR} | grep -Eq \
    "[[:digit:]]{1,}"

  [ $? -eq 0 ] &amp;&amp; return 0
  return 1
}

function validate () {
  grep -Ev '^#|^$' $CONFIG | while read NET NAT REAL NPRIO RPRIO EXCLUDE ; do
    # Fields 5 and 6 are optional
    if [ -z "$NET" -o -z "$NAT" -o -z "$REAL" -o -z "$NPRIO" ]; then
       echo Syntax error: Missing field: $NET $NAT $REAL $NPRIO $RPRIO $EXCLUDE
       exit 1
    fi
    if [ -n "$RPRIO" -a -z "$EXCLUDE" ]; then
       echo Syntax error: $NET $NAT $REAL $NPRIO $RPRIO $EXCLUDE
       echo Field 6 must be used with field 5
       exit 1
    fi
    for ITEM in $NET $NAT $REAL $EXCLUDE ; do
      isIP $ITEM
      if [ $? -ne 0 ]; then 
         echo "In line:"
         echo $NET $NAT $REAL $NPRIO $RPRIO $EXCLUDE
         echo $ITEM is not a valid IP or CIDR block
         exit 1
      fi
    done
    for ITEM in $NPRIO $RPRIO; do
      isINT $ITEM
      if [ $? -ne 0 ]; then 
         echo "In line:"
         echo $NET $NAT $REAL $NPRIO $RPRIO $EXCLUDE
         echo $ITEM is not an integer
         exit 1
      fi
    done
  done
}

function flush () {
  # -- this function should remove all NAT rules and routes
  #
  # -- remove all of the rules, except the three builtins and any IPSec
  #    rule; -MAB;
  #
  ip rule show | grep -Ev '^(0|32766|32767):|iif lo' \
    | while read PRIO NATRULE; do
    ip rule del prio ${PRIO%%:*} $( echo $NATRULE | sed 's|all|0/0|' )
  done
  # -- remove all of the rules
  #
  ip route show table local  | grep ^nat | while read NATROUTE; do
    ip route del $NATROUTE
  done
  ip route flush cache;
}

function nat () {
  grep -Ev '^#|^$' $CONFIG | while read NET NAT REAL NPRIO RPRIO EXCLUDE ; do

    # &lt;-- set up the route for the NAT IP to turn it into the real IP
    #
    ip route add from $NET nat $NAT via ${REAL%%/*}
    [ "$?" -eq "0" ] || \
      gripe cmd failed: ip route add nat $NAT via ${REAL%%/*}

    # &lt;-- establish the minimum routing policy database;
    #     this is required so that the outbound packet gets
    #     rewritten to be from the IP which sent us the packet
    #
    ip rule add to $NET nat ${NAT%%/*} from $REAL prio $NPRIO 
    [ "$?" -eq "0" ] || \
      gripe cmd failed: ip rule add nat ${NAT%%/*} from $REAL prio $NPRIO 

    # &lt;-- determine if the user has supplied networks or address to be
    #     excluded from the $NETwork address above
    #
    [ ! -z "$RPRIO" ] &amp;&amp; [ ! -z "$EXCLUDE" ] &amp;&amp; {
      for NETWORK in $EXCLUDE ; do
        ip rule add from $REAL to $NETWORK prio $RPRIO
        [ "$?" -eq "0" ] || \
          gripe cmd failed: ip rule add from $REAL to $NETWORK prio $RPRIO
      done;
    }
  done;
  # &lt;-- We don't want to forget to flush the cache, or the user will
  #     sit around wondering for the next few minutes why the NAT rules
  #     aren't working.  After flushing the cache, the NAT rules will
  #     work right away.
  #
  ip route flush cache;
}

# see how we were called
case "$1" in 
      start) validate &amp;&amp; nat
             ;;
       stop) flush
             ;;
    restart) $0 stop; $0 start
             ;;
     status) ip route show table local | grep ^nat
             ip rule show | grep map-to
             ;;
          *) echo "usage: nat {start|stop|restart|status}"
             ;;
esac

#   
# - end of nat

      </pre></div></div><br class="example-break"><div class="example"><a name="ex-sc-static-nat"></a><p class="title"><b>Example 11.4. Static NAT configuration file</b></p><div class="example-contents"><p>
        <a class="ulink" href="scripts/static-nat" target="_top">Download.</a>
      </p><pre class="programlisting">
#  
# NAT configuration file
#
# -- This file is used to configure NAT routes and rules
#    via the iproute2 package.  A sysV init script (nat)
#    uses this file to set up the routes/rules.
#
#
# Copyright (c)2002 SecurePipe, Inc. - http://www.securepipe.com/
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation, 
# Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#
# -- file created by Matt Callaway &lt;matt@securepipe.com&gt;
#    2002-03-01; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - first major revision; added comments
#    2002-08-14; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - cleaned up the file; added copious commenting and examples
#      - provided support for NAT only from specified networks (backwards
#        incompatibility added here; benefit is huge flexibility gain)
#    2003-02-10; Martin A. Brown &lt;mabrown@securepipe.com&gt;
#      - example #6 added.  Thanks for identification and description of
#        this scenario, and the example in the format of the other
#        examples go to Shawn Balestracci &lt;shawnb@securepipe.com&gt;
#
# -- field descriptions:
#    field 1   this field contains a network address.  Any packets from
#              this network will be translated according to fields two and
#              three, with the exception of any networks specified in fields
#              6 and higher
#    field 2   contains the NAT IP, the IP that only exists as a publicly
#              reachable IP for an internal host
#    field 3   contains the real IP of the machine, usually an internal IP
#    field 4   contains the priority for the NAT rule itself in the RPDB
#    field 5   contains the priority for the routing rule in the RPDB.  In
#              order for the internal networks to reach the real IP of the
#              server/host, this priority must be higher than the priority
#              for the NAT rule.  **lower numbers == higher priority**
#    field 6+  contains a whitespace separated list of networks which
#              should be able to reach the real IP (field 2) directly.
#              The entries into the rule policy database (RPDB) for these
#              networks will prevent packets from real-IP to dest-network
#              from being rewritten with the NAT IP as the source IP.
#              Networks specified here should be subnets of the network
#              specified in field 1.
#
# -- notes
#
#    - white space, lines beginning with a comment and blank lines are ignored
#    - field 5 should always be a lower number (higher priority) than field 4
#    - fields 5 and 6+ are optional
#    - fields 5 and 6+ must be used together, if used at all
#
# -- examples
#
#    - each example is commented with an English description of the network
#      address translation which will occur
#    - followed by a pseudo shellcode description of how to understand
#      exactly what the NAT will look like
#
# -- example #1; NAT a single IP from anywhere
#
# 0/0  10.10.0.14  172.31.254.1  1000
#
# for packets from any address (0/0);
#   if destination_address is 10.10.0.14 ; then
#      rewrite destination address from 10.10.0.14 to 172.31.254.1
#   fi
# done
#
# -- example #2; NAT an entire network (from anywhere)
#
# 0/0  10.13.0.0/16  172.17.0.0/16  1000
#
# for packets from any address (0/0); do
#   if destination_address is in 10.13.0.0/16 ; then
#      rewrite destination address from 10.13.x.x to 172.17.x.x
#   fi
# done
#
# -- example #3; NAT an entire network, but only from a specified nework
#
# 10.10.0.0/16  10.15.0.0/24  192.168.0.0/24  1000
#
# if packet is from 10.10.0.0/16 ; then
#    if destination_address is in 10.15.0.0/24 ; then
#       rewrite destination address from 10.15.0.x to 192.168.0.x
#    fi
# fi
#
# -- example #4; NAT an entire network, but only from a specified nework;
#                make an exception for certain IP ranges
#
# 10.10.0.0/16  10.15.2.0/24  192.168.2.0/24  1000  990  10.10.38.0/24
#
# if packet is from 10.10.0.0/16 and not from 10.10.38.0/24 ; then
#    if destination_address is in 10.15.2.0/24 ; then
#       rewrite destination address from 10.15.2.x to 192.168.2.x
#    fi
# fi
#
# -- example #5; NAT a single IP from anywhere; don't NAT if from specified
#                IP ranges
#
# 0/0  10.74.1.8  192.168.73.15  1000  990  192.168.71.0/24  192.168.70.0/24
#
# for packets from any address except 192.168.71.0/24 and 192.168.70.0/24; do
#    if destination_address is 10.74.1.8 ; then
#       rewrite destination address from 10.74.1.8 to 192.168.73.15
#    fi
# done
#
# -- example #6; NAT to the same IP differently based on the source
#                network IP ranges
#
# 0/0              10.74.1.8      192.168.73.15   1000
# 192.168.71.0/24  192.168.71.15  192.168.73.15    400
# 192.168.70.0/24  192.168.71.15  192.168.73.15    400
#
# N.B., the RPDB must traverse lines two and three first, hence the higher
#       priority.  If the source network is not 192.168.{71,70}.0/24 then
#       the we'll meet the next entry, 1000.
# N.B., the third entry in this example will cause an RTNETLINK: file
#       exists error, because there is already an entry in the local
#       routing table for 192.168.71.15 --NAT--&gt; 192.168.73.15.  Known bug.
#
# for packets from 192.168.71.0/24 or 192.168.70.0/24; do
#       if destination_address is 192.168.71.15 ; then
#         rewrite destination address from 192.168.71.15 to 192.168.73.15
#       fi
# done
#
# for packets from any address except 192.168.71.0/24 and 192.168.70.0/24; do
#       if destination_address is 10.74.1.8 ; then
#         rewrite destination address from 10.74.1.8 to 192.168.73.15
#       fi
# done
#
# -- add your own configuration here

# -- end /etc/sysconfig/static-nat
#   

      </pre></div></div><br class="example-break"></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ch-trouble"></a>Chapter 12. Troubleshooting</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#trouble-intro">1. Introduction to Troubleshooting</a></span></dt><dt><span class="section"><a href="#trouble-ethernet">2. Troubleshooting at the Ethernet Layer</a></span></dt><dt><span class="section"><a href="#trouble-ip">3. Troubleshooting at the IP Layer</a></span></dt><dt><span class="section"><a href="#trouble-routing">4. Handling and Diagnosing Routing Problems</a></span></dt><dt><span class="section"><a href="#trouble-tcp">5. Identifying Problems with TCP Sessions</a></span></dt><dt><span class="section"><a href="#trouble-dns">6. DNS Troubleshooting</a></span></dt></dl></div><p>
    Invariably, troubles and misconfigurations creep into networks.  New
    devices get connected and added to a network.  Old devices are removed,
    and something seemingly unrelated breaks.  Troubleshooting is really a
    test in discerning patterns.
  </p><p>
    My favored method for solving problems is to start with the simplest
    elements, verifying correct operation and proceeding to the next layer or
    element until I have isolated the problem element.  If you are lucky,
    you'll know from a symptom where the problem is likely to be, but more
    often, you'll have to start at the bottom of the networking hierarchy, and
    verify each other layer.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-intro"></a>1. Introduction to Troubleshooting</h2></div></div></div><p>
      The first thing to consider whenever somebody reports a strange
      networking problem is any recent change.  What has changed recently in
      the network?  Have any new machines been added?  Is the user using a
      service which was recently decommissioned?  Did a machine (firewall,
      mail server, DNS resolver) recently reboot?  Did all of the services
      restart?
    </p><p>
    </p><p>
    </p><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-ethernet"></a>2. Troubleshooting at the Ethernet Layer</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-ip"></a>3. Troubleshooting at the IP Layer</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-routing"></a>4. Handling and Diagnosing Routing Problems</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-tcp"></a>5. Identifying Problems with TCP Sessions</h2></div></div></div><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="trouble-dns"></a>6. DNS Troubleshooting</h2></div></div></div><p>
    </p></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="part-reference"></a>Part III. Appendices and Reference</h1></div></div></div><div class="partintro"><div></div><p>
      The content in this part is intended to function as supporting
      reference material for the above chapters.  Following you will find a
      reference for many common linux command line utilities as well as the
      example network map and network description.  A set of links to external
      resources, and a troubleshooting guide round out the content in
      this part of the document.
    </p><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="appendix"><a href="#ax-example-network">A. An Example Network and Description</a></span></dt><dd><dl><dt><span class="section"><a href="#example-network-netmap">1. Example Network Map and General Notes</a></span></dt><dt><span class="section"><a href="#example-network-addressing">2. Example Network Addressing Charts</a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-ethernet">B. Ethernet Layer Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-arp">1. <span class="command"><strong>arp</strong></span></a></span></dt><dt><span class="section"><a href="#tools-arping">2. <span class="command"><strong>arping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link">3. <span class="command"><strong>ip link</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-link-show">3.1. Displaying link layer characteristics with <span class="command"><strong>ip link
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set">3.2. Changing link layer characteristics with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-down">3.3. Deactivating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-up">3.4. Activating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-mtu">3.5. Using <span class="command"><strong>ip link set</strong></span> to change the MTU</a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-name">3.6. Changing the device name with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-address">3.7. Changing hardware or Ethernet broadcast address with
          <span class="command"><strong>ip link set</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-neighbor">4. <span class="command"><strong>ip neighbor</strong></span></a></span></dt><dt><span class="section"><a href="#tools-mii-tool">5. <span class="command"><strong>mii-tool</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-ip-management">C. IP Address Management</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ifconfig">1. <span class="command"><strong>ifconfig</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ifconfig-display">1.1. Displaying interface information with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-down">1.2. Bringing down an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-up">1.3. Bringing up an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-output">1.4. Reading <span class="command"><strong>ifconfig</strong></span> output</a></span></dt><dt><span class="section"><a href="#tools-ifconfig-mtu">1.5. Changing MTU with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-flags">1.6. Changing device flags with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-conclusion">1.7. General remarks about <span class="command"><strong>ifconfig</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-address">2. <span class="command"><strong>ip address</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-address-show">2.1. Displaying interface information with
            <span class="command"><strong>ip address show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-add">2.2. Using <span class="command"><strong>ip address add</strong></span> to configure
          IP address information</a></span></dt><dt><span class="section"><a href="#tools-ip-address-del">2.3. Using <span class="command"><strong>ip address del</strong></span> to remove IP addresses
          from an interface</a></span></dt><dt><span class="section"><a href="#tools-ip-address-flush">2.4. Removing all IP address information from an interface
          with <span class="command"><strong>ip address flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-conclusion">2.5. Conclusion</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#tools-ip-routing">D. IP Route Management</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-route">1. <span class="command"><strong>route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-route-show">1.1. Displaying the routing table with <span class="command"><strong>route</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-output">1.2. Reading <span class="command"><strong>route</strong></span>'s output</a></span></dt><dt><span class="section"><a href="#tools-route-show-cache">1.3. Using <span class="command"><strong>route</strong></span> to display the routing cache</a></span></dt><dt><span class="section"><a href="#tools-route-add">1.4. Creating a static route with <span class="command"><strong>route add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-add-default">1.5. Creating a default route with <span class="command"><strong>route add default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-del">1.6. Removing routes with <span class="command"><strong>route del</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-route">2. <span class="command"><strong>ip route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-route-show">2.1. Displaying a routing table with <span class="command"><strong>ip route
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-show-cache">2.2. Displaying the routing cache with <span class="command"><strong>ip route
          show cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add">2.3. Using <span class="command"><strong>ip route add</strong></span> to populate a routing
          table</a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-default">2.4. Adding a default route with <span class="command"><strong>ip route add
          default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-nat">2.5. Setting up NAT with <span class="command"><strong>ip route add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-del">2.6. Removing routes with <span class="command"><strong>ip route del</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-change">2.7. Altering existing routes with <span class="command"><strong>ip route
          change</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-get">2.8. Programmatically fetching route information with <span class="command"><strong>ip
          route get</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush">2.9. Clearing routing tables with <span class="command"><strong>ip route
          flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush-cache">2.10. <span class="command"><strong>ip route flush cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-summary">2.11. Summary of the use of <span class="command"><strong>ip route</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-rule">3. <span class="command"><strong>ip rule</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-rule-intro">3.1. <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-show">3.2. Displaying the RPDB with <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add">3.3. Adding a rule to the RPDB with <span class="command"><strong>ip rule
          add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add-nat">3.4. <span class="command"><strong>ip rule add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-del">3.5. <span class="command"><strong>ip rule del</strong></span></a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#tools-tunnels">E. Tunnels and VPNs</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-cipe">1. Lightweight encrypted tunnel with <span class="command"><strong>CIPE</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipip">2. GRE tunnels with <span class="command"><strong>ip tunnel</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ssh">3. All manner of tunnels with <span class="command"><strong>ssh</strong></span></a></span></dt><dt><span class="section"><a href="#tools-freeswan">4. IPSec implementation via <span class="command"><strong>FreeS/WAN</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipsec">5. IPSec implementation in the kernel</a></span></dt><dt><span class="section"><a href="#tools-pptp">6. <span class="command"><strong>PPTP</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-sockets">F. Sockets; Servers and Clients</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-telnet">1. <span class="command"><strong>telnet</strong></span></a></span></dt><dt><span class="section"><a href="#tools-nc">2. <span class="command"><strong>nc</strong></span></a></span></dt><dt><span class="section"><a href="#tools-socat">3. <span class="command"><strong>socat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpclient">4. <span class="command"><strong>tcpclient</strong></span></a></span></dt><dt><span class="section"><a href="#tools-xinetd">5. <span class="command"><strong>xinetd</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpserver">6. <span class="command"><strong>tcpserver</strong></span></a></span></dt><dt><span class="section"><a href="#tools-redir">7. <span class="command"><strong>redir</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-diagnostics">G. Diagnostic Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ping">1. <span class="command"><strong>ping</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ping-simple">1.1. Using <span class="command"><strong>ping</strong></span> to test reachability</a></span></dt><dt><span class="section"><a href="#tools-ping-stress">1.2. Using <span class="command"><strong>ping</strong></span> to stress a network</a></span></dt><dt><span class="section"><a href="#tools-ping-record-route">1.3. Recording a network route with <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-ttl">1.4. Setting the TTL on a <span class="command"><strong>ping</strong></span> packet</a></span></dt><dt><span class="section"><a href="#tools-ping-tos">1.5. Setting ToS for a diagnostic <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-specify-source">1.6. Specifying a source address for <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-summary">1.7. Summary on the use of <span class="command"><strong>ping</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-traceroute">2. <span class="command"><strong>traceroute</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-traceroute-basic">2.1. Using <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-icmp">2.2. Telling <span class="command"><strong>traceroute</strong></span> to use ICMP echo request
          instead of UDP</a></span></dt><dt><span class="section"><a href="#tools-traceroute-tos">2.3. Setting ToS with <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-summary">2.4. Summary on the use of <span class="command"><strong>traceroute</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-mtr">3. <span class="command"><strong>mtr</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat">4. <span class="command"><strong>netstat</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-netstat-socket">4.1. Displaying socket status with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-route">4.2. Displaying the main routing table with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-interface">4.3. Displaying network interface statistics with
          <span class="command"><strong>netstat</strong></span> command</a></span></dt><dt><span class="section"><a href="#tools-netstat-statistics">4.4. Displaying network stack statistics with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-masquerade">4.5. Displaying the masquerading table with
          <span class="command"><strong>netstat</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpdump">5. <span class="command"><strong>tcpdump</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-tcpdump-arp">5.1. Using <span class="command"><strong>tcpdump</strong></span> to view ARP messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-unreach">5.2. Using <span class="command"><strong>tcpdump</strong></span> to see ICMP unreachable
          messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-tcp">5.3. Using <span class="command"><strong>tcpdump</strong></span> to watch TCP sessions</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-file">5.4. Reading and writing <span class="command"><strong>tcpdump</strong></span> data</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-frag">5.5. Understanding fragmentation as reported by
          <span class="command"><strong>tcpdump</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpdump-other">5.6. Other options to the <span class="command"><strong>tcpdump</strong></span> command</a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpflow">6. <span class="command"><strong>tcpflow</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpreplay">7. <span class="command"><strong>tcpreplay</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#tools-misc">H. Miscellany</a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ipcalc">1. <span class="command"><strong>ipcalc</strong></span> and other IP addressing calculators</a></span></dt><dt><span class="section"><a href="#tools-iproute2-remarks">2. Some general remarks about <span class="command"><strong>iproute2</strong></span> tools</a></span></dt><dt><span class="section"><a href="#tools-sysctl-intro">3. Brief introduction to <span class="command"><strong>sysctl</strong></span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#ax-links">I. Links to other Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#links-doc">1. Links to Documentation</a></span></dt><dd><dl><dt><span class="section"><a href="#links-general-linux">1.1. Linux Networking Introduction and Overview Material</a></span></dt><dt><span class="section"><a href="#links-linux-security">1.2. Linux Security and Network Security</a></span></dt><dt><span class="section"><a href="#links-general-ip">1.3. General IP Networking Resources</a></span></dt><dt><span class="section"><a href="#links-masq">1.4. Masquerading topics</a></span></dt><dt><span class="section"><a href="#links-nat">1.5. Network Address Translation</a></span></dt><dt><span class="section"><a href="#links-iproute2">1.6. iproute2 documentation</a></span></dt><dt><span class="section"><a href="#links-netfilter">1.7. Netfilter Resources</a></span></dt><dt><span class="section"><a href="#links-ipchains">1.8. <span class="command"><strong>ipchains</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-ipfwadm">1.9. <span class="command"><strong>ipfwadm</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-systems">1.10. General Systems References</a></span></dt><dt><span class="section"><a href="#links-bridging">1.11. Bridging</a></span></dt><dt><span class="section"><a href="#links-tc">1.12. Traffic Control</a></span></dt><dt><span class="section"><a href="#links-multicast">1.13. IPv4 Multicast</a></span></dt><dt><span class="section"><a href="#links-misc">1.14. Miscellaneous Linux IP Resources</a></span></dt></dl></dd><dt><span class="section"><a href="#links-software">2. Links to Software</a></span></dt><dd><dl><dt><span class="section"><a href="#idm6929">2.1. Basic Utilities</a></span></dt><dt><span class="section"><a href="#idm6953">2.2. Virtual Private Networking software</a></span></dt><dt><span class="section"><a href="#idm6964">2.3. Traffic Control queueing disciplines and command line tools</a></span></dt><dt><span class="section"><a href="#idm6987">2.4. Interfaces to lower layer tools</a></span></dt><dt><span class="section"><a href="#idm7000">2.5. Packet sniffing and diagnostic tools</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#gfdl">J. GNU Free Documentation License</a></span></dt><dd><dl><dt><span class="section"><a href="#gfdl-0">1. PREAMBLE</a></span></dt><dt><span class="section"><a href="#gfdl-1">2. APPLICABILITY AND DEFINITIONS</a></span></dt><dt><span class="section"><a href="#gfdl-2">3. VERBATIM COPYING</a></span></dt><dt><span class="section"><a href="#gfdl-3">4. COPYING IN QUANTITY</a></span></dt><dt><span class="section"><a href="#gfdl-4">5. MODIFICATIONS</a></span></dt><dt><span class="section"><a href="#gfdl-5">6. COMBINING DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-6">7. COLLECTIONS OF DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-7">8. AGGREGATION WITH INDEPENDENT WORKS</a></span></dt><dt><span class="section"><a href="#gfdl-8">9. TRANSLATION</a></span></dt><dt><span class="section"><a href="#gfdl-9">10. TERMINATION</a></span></dt><dt><span class="section"><a href="#gfdl-10">11. FUTURE REVISIONS OF THIS LICENSE</a></span></dt><dt><span class="section"><a href="#gfdl-addendum">12. ADDENDUM: How to use this License for
  your documents</a></span></dt></dl></dd></dl></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="ax-example-network"></a>Appendix A. An Example Network and Description</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#example-network-netmap">1. Example Network Map and General Notes</a></span></dt><dt><span class="section"><a href="#example-network-addressing">2. Example Network Addressing Charts</a></span></dt></dl></div><p>
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-network-netmap"></a>1. Example Network Map and General Notes</h2></div></div></div><p>
      The below network map is a fictional network.  This network should
      provide examples of several of the common functions of a linux box in
      networking situations.  The hostnames used in the documentation are
      taken from this network map.  Where practical, I have tried to simulate
      real-world situations throughout the documentation, to ease the
      practical application of the concepts.
    </p><div class="mediaobject"><img src="images/example-netmap.png"></div><p>
      Because this guide focusses on linux networking, I have omitted discussion
      of the ISDN routers and unless relevant, the layer 2 devices (hubs and
      switches).  The remaining hosts on the example network can be
      broken into three main categories:  single-homed hosts (servers and
      workstations), masquerading (cf. NAT) routers, and public routers.
      For those viewing the above netmap from a security perspective,
      <code class="systemitem">wan-gw</code> and <code class="systemitem">masq-gw</code> would both run
      packet filters (at least), which turns the network into a traditional
      screened-subnet firewall.
    </p><p>
      The LAN shown above is a common leaf-network scenario for business
      offices.  Frequently, there are one or two machines on a public network
      segment, a masquerading firewall, and one or more networks behind the
      masquerading firewall.  Please do not consider this example network the
      only way to interconnect devices.  The above is one method of designing
      a network--there are many practical issues to weigh in network design.
      I am deliberately skirting the issue of network design here and
      proposing an example network similar to or a superset of a commonly
      found network design.
    </p><p>
      It is rare for a business which is not an ISP to own a class C sized
      network today, but I have nonetheless chosen a class C sized public
      network as our fictitious company's network.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="example-network-addressing"></a>2. Example Network Addressing Charts</h2></div></div></div><p>
        In addition to the network map above, you may find the following
        network address and host address information handy as you read through
        the various examples and documentation based on this fictional network.
      </p><div class="table"><a name="tb-example-network-networks"></a><p class="title"><b>Table A.1. Example Network; Network Addressing</b></p><div class="table-contents"><table class="table" summary="Example Network; Network Addressing" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">network address</th><th align="center">function</th></tr></thead><tbody><tr><td align="center">205.254.211.0/24</td><td align="center">public ISP-allocated network</td></tr><tr><td align="center">192.168.100.0/24</td><td align="center">internal server network</td></tr><tr><td align="center">192.168.99.0/24</td><td align="center">main office desktop network</td></tr><tr><td align="center">192.168.98.0/24</td><td align="center">branch office desktop network</td></tr></tbody></table></div></div><br class="table-break"><p>
        Host addressing information is summarized in this table.
        follows.
      </p><div class="table"><a name="tb-example-network-hosts"></a><p class="title"><b>Table A.2. Example Network; Host Addressing</b></p><div class="table-contents"><table class="table" summary="Example Network; Host Addressing" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th align="center">hostname</th><th align="center">interface</th><th align="center">IP address</th><th align="center">MAC address</th></tr></thead><tbody><tr><td align="center"><code class="systemitem">isolde</code></td><td align="center">eth0</td><td align="center">192.168.100.17/24</td><td align="center">00:80:c8:e8:4b:8e</td></tr><tr><td align="center"><code class="systemitem">tristan</code></td><td align="center">eth0</td><td align="center">192.168.99.35/24</td><td align="center">00:80:c8:f8:4a:51</td></tr><tr><td align="center"><code class="systemitem">morgan</code></td><td align="center">eth0</td><td align="center">192.168.98.82/24</td><td align="center">00:80:c8:f8:4a:53</td></tr><tr><td align="center"><code class="systemitem">masq-gw</code></td><td align="center">eth0</td><td align="center">192.168.100.254/24</td><td align="center">00:80:c8:f8:5c:71</td></tr><tr><td align="center"><code class="systemitem">masq-gw</code></td><td align="center">eth1</td><td align="center">205.254.211.179/24</td><td align="center">00:80:c8:f8:5c:72</td></tr><tr><td align="center"><code class="systemitem">masq-gw</code></td><td align="center">eth2</td><td align="center">192.168.99.254/24</td><td align="center">00:80:c8:f8:5c:73</td></tr><tr><td align="center"><code class="systemitem">masq-gw</code></td><td align="center">eth3</td><td align="center">192.168.100.2/30</td><td align="center">00:80:c8:f8:5c:74</td></tr><tr><td align="center"><code class="systemitem">wan-gw</code></td><td align="center">eth0</td><td align="center">205.254.211.254/24</td><td align="center">[ unknown ]</td></tr><tr><td align="center"><code class="systemitem">wan-gw</code></td><td align="center">wan0</td><td align="center">205.254.209.73/30</td><td align="center">[ n/a ]</td></tr><tr><td align="center"><code class="systemitem">isdn-router</code></td><td align="center">(Ethernet)</td><td align="center">192.168.99.1/24</td><td align="center">00:c0:7b:45:6a:39</td></tr><tr><td align="center"><code class="systemitem">branch-router</code></td><td align="center">(Ethernet)</td><td align="center">192.168.98.254/24</td><td align="center">00:c0:7b:37:af:91</td></tr><tr><td align="center"><code class="systemitem">service-router</code></td><td align="center">(Ethernet)</td><td align="center">192.168.100.1/24</td><td align="center">00:c0:7b:7d:00:c8</td></tr></tbody></table></div></div><br class="table-break"><p>
        I have referred liberally to this example network throughout this
        documentation.  Any example commands in the documentation assume
        the network configuration as shown on this network map.
      </p><p>
        Additionally, hosts which are not part of this (fictional) network but
        appear in the documentation will appear under the names <code class="systemitem">real-server</code>
        and <code class="systemitem">real-client</code>.  This convention exists simply to disambiguate
        real-world examples from the machines in the fictional network.
      </p><p>
      </p></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-ethernet"></a>Appendix B. Ethernet Layer Tools</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-arp">1. <span class="command"><strong>arp</strong></span></a></span></dt><dt><span class="section"><a href="#tools-arping">2. <span class="command"><strong>arping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link">3. <span class="command"><strong>ip link</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-link-show">3.1. Displaying link layer characteristics with <span class="command"><strong>ip link
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set">3.2. Changing link layer characteristics with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-down">3.3. Deactivating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-up">3.4. Activating a device with <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-mtu">3.5. Using <span class="command"><strong>ip link set</strong></span> to change the MTU</a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-name">3.6. Changing the device name with
          <span class="command"><strong>ip link set</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-link-set-address">3.7. Changing hardware or Ethernet broadcast address with
          <span class="command"><strong>ip link set</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-neighbor">4. <span class="command"><strong>ip neighbor</strong></span></a></span></dt><dt><span class="section"><a href="#tools-mii-tool">5. <span class="command"><strong>mii-tool</strong></span></a></span></dt></dl></div><p>
      The section here will cover tools which manipulate, display
      characteristics of or probe Ethernet devices.  Because Ethernet is one
      of the most available and widely spread networking media in use today,
      we'll concentrate on Ethernet rather than other link layer protocols.
    </p><p>
      As with any networking stack, the lower layers must be functioning
      properly in order for the higher layer protocols to operate.  The tools
      covered in this section will provide the resources you need to verify
      the proper operation of your linux machine in an Ethernet environment.
    </p><p>
      You probably knew before reading this that you can look at the link
      light on your Ethernet switch/hub and the link light on your Ethernet
      card to verify a good connection.  Now you can use
      <a class="link" href="#tools-mii-tool" title="5. mii-tool"><span class="command"><strong>mii-tool</strong></span></a> to
      ask the Ethernet driver if it agrees.  Once you have verified a good media
      connection, you may want to set other link layer characteristics on your
      Ethernet device.  For this,
      <a class="link" href="#tools-ip-link" title="3. ip link"><span class="command"><strong>ip link</strong></span></a> is
      the perfect tool.
    </p><p>
      To see if anybody is using an IP address already on the Ethernet to
      which you are connecting, you can use
      <a class="link" href="#tools-arping" title="2. arping"><span class="command"><strong>arping</strong></span></a>
      and if you want to play with the arp tables, the
      <a class="link" href="#tools-arping" title="2. arping"><span class="command"><strong>arp</strong></span></a> command
      is there to help you accomplish your objective.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-arp"></a>1. <span class="command"><strong>arp</strong></span></h2></div></div></div><p>
        An often overlooked tool, <span class="command"><strong>arp</strong></span> is used to view
        and manipulate the entries in the arp table.  See
        <a class="xref" href="#ether-arp-cache" title="1.2. The ARP cache">Section 1.2, &#8220;The ARP cache&#8221;</a> for a fuller discussion of the
        arp table.
      </p><p>
        The most common uses for <span class="command"><strong>arp</strong></span> are to add an
        address for which to proxy arp, delete an address from the arp table
        or view the arp table itself.
      </p><p>
        In the simplest invocation, you simply want to see the current state
        of the arp table.  Invoking <span class="command"><strong>arp</strong></span> with no options
        will provide you exactly the information you need.  Typically, you may
        not trust DNS (or may not wish to wait for the DNS lookups), and you
        may wish to specify the arp table on a particular interface.
      </p><div class="example"><a name="tools-arp-listing"></a><p class="title"><b>Example B.1. Displaying the arp table with <span class="command">arp</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -n -i eth3</code></strong>
<code class="computeroutput">Address                  HWtype  HWaddress           Flags Mask Iface
192.168.100.1           ether   00:C0:7B:7D:00:C8   C                     eth3</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -n -i eth0</code></strong>
<code class="computeroutput">Address                  HWtype  HWaddress           Flags Mask Iface
192.168.100.17          ether   00:80:C8:E8:4B:8E   C                     eth0</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -a -n -i eth0</code></strong>
<code class="computeroutput">? (192.168.100.17) at 00:80:C8:E8:4B:8E [ether] on eth0</code>
        </pre></div></div><br class="example-break"><p>
        The MAC address in the third column is always a six part hexadecimal
        number.  In practice, the MAC address (also known as the hardware
        address or the Ethernet address) is not normally needed for the
        majority of troubleshooting problems, however knowing how to retrieve
        the MAC address can help when tracking down problems in a network
        <a href="#ftn.idm3725" class="footnote" name="idm3725"><sup class="footnote">[41]</sup></a>.
      </p><p>
        The <span class="command"><strong>arp</strong></span> command can also force a permament entry
        into the arp table.  Let's look at an unusual networking need.
        Infrequently, a need arises to split a network into two parts, each
        part with the same network address and netmask.  The router which
        joins the two networks is connected to both sets of media.  See
        <a class="xref" href="#adv-proxy-arp" title="3. Breaking a network in two with proxy ARP">Section 3, &#8220;Breaking a network in two with proxy ARP&#8221;</a> for more detail on when and how to
        do this.
      </p><p>
        The command to add arp table entries makes a static entry in the arp
        table.  This is not recommended practice, and is probably only
        necessary in strange, experimental, hybrid, or pseudo-bridging
        situations.
      </p><div class="example"><a name="tools-arp-add"></a><p class="title"><b>Example B.2. Adding arp table entries with <span class="command">arp</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -s 192.168.100.17 -i eth3 -D eth3 pub</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -n -i eth3</code></strong>
<code class="computeroutput">Address                  HWtype  HWaddress           Flags Mask Iface
192.168.100.1           ether   00:C0:7B:7D:00:C8   C                     eth3
192.168.100.17          *       *                   MP                    eth3</code>
        </pre></div></div><br class="example-break"><p>
        After inserting an entry into the arp table on eth3, we will now
        respond for ARP requests on eth3 for the IP 192.168.100.17.  If the
        <code class="systemitem">service-router</code> has a
        packet bound for 192.168.100.17, it will generate an ARP request to
        which we will respond with the Ethernet address of our eth3 interface.
      </p><p>
        Moments after you have added this arp table entry, you realize that
        you really do not wish
        <code class="systemitem">service-router</code> and 
        <code class="systemitem">isolde</code> to exchange any IP
        packets.  There is no reason for the 
        <code class="systemitem">isolde</code> to initiate a
        telnet session with 
        <code class="systemitem">service-router</code> and
        correspondingly, there are no services on
        <code class="systemitem">isolde</code> which should be
        accessible from the router.
      </p><p>
        Fortunately, it's quite easy to remove the entry.
      </p><div class="example"><a name="tools-arp-delete"></a><p class="title"><b>Example B.3. Deleting arp table entries with <span class="command">arp</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -i eth3 -d 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arp -n -i eth3</code></strong>
<code class="computeroutput">Address                  HWtype  HWaddress           Flags Mask Iface
192.168.100.1           ether   00:C0:7B:7D:00:C8   C                     eth3</code>
        </pre></div></div><br class="example-break"><p>
        <span class="command"><strong>arp</strong></span> is a small utility, but one which can prove
        extremely handy.  One minor annoyance with the <span class="command"><strong>arp</strong></span>
        utility is option handling.  Options seem to be handled differently
        based on order.  If in doubt, try specifying the action as the first
        option.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-arping"></a>2. <span class="command"><strong>arping</strong></span></h2></div></div></div><p>
        An almost unknown command (mostly because it is not frequently
        necessary), the <span class="command"><strong>arping</strong></span> utility performs an action
        similar to <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a>,
        but at the Ethernet layer.   Where <span class="command"><strong>ping</strong></span> tests the
        reachability of an IP address, <span class="command"><strong>arping</strong></span> reports the
        reachability and round-trip time of an IP address hosted on the local
        network.
      </p><p>
        There are several modes of operation for this utility.  Under normal
        operation, <span class="command"><strong>arping</strong></span> displays the Ethernet and IP
        address of the target as well as the time elapsed between the
        arp request and the arp reply.
      </p><div class="example"><a name="ex-tools-arping-listing"></a><p class="title"><b>Example B.4. Displaying reachability of an IP on the local Ethernet with <span class="command">arping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>arping -I eth0 -c 2 192.168.100.17</code></strong>
<code class="computeroutput">ARPING 192.168.100.17 from 192.168.100.254 eth0
Unicast reply from 192.168.100.17 [00:80:C8:E8:4B:8E]  8.419ms
Unicast reply from 192.168.100.17 [00:80:C8:E8:4B:8E]  2.095ms
Sent 2 probes (1 broadcast(s))
Received 2 response(s)</code>
        </pre></div></div><br class="example-break"><p>
        Other options to the arping utility include the ability to send a
        broadcast arp using the <span class="command"><strong>-U</strong></span> option
        and the ability to send a gratuitous reply using the
        <span class="command"><strong>-A</strong></span> option.   A kernel with support for <a class="link" href="#adv-nonlocal-bind" title="7. Binding to Non-local Addresses">non-local bind</a> can be used with
        arping for the nefarious purpose of wreaking havoc on
        an otherwise properly configured Ethernet.  By performing gratuitous arp
        and broadcasting incorrect arp information, arp tables in poorly
        designed IP stacks can become quite confused.
      </p><p>
        <span class="command"><strong>arping</strong></span> can detect if an IP address is
        currently in use on an Ethernet.  Called duplicate address detection,
        this use of <span class="command"><strong>arping</strong></span> is increasingly common in
        networking scripts.
      </p><p>
        For a practical example, let's assume a laptop named
        <code class="systemitem">dietrich</code> is normally
        connected to a home network with the same IP address as
        <code class="systemitem">tristan</code> of
        our main office network.  In the boot scripts,
        <code class="systemitem">dietrich</code>
        might make good use of
        <span class="command"><strong>arping</strong></span> by testing reachability of the IP it wants
        to use before bringing up the IP layer.
      </p><div class="example"><a name="ex-tools-arping-dad"></a><p class="title"><b>Example B.5. Duplicate Address Detection with <span class="command">arping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@dietrich]# </code><strong class="userinput"><code>arping -D -q -I eth0 -c 2 192.168.99.35</code></strong>
<code class="prompt">[root@dietrich]# </code><strong class="userinput"><code>echo $?</code></strong>
<code class="computeroutput">1</code>
<code class="prompt">[root@dietrich]# </code><strong class="userinput"><code>arping -D -q -I eth0 -c 2 192.168.99.36</code></strong>
<code class="prompt">[root@dietrich]# </code><strong class="userinput"><code>echo $?</code></strong>
<code class="computeroutput">0</code>
        </pre></div></div><br class="example-break"><p>
        First, <code class="systemitem">dietrich</code> tests
        reachability of its preferred IP (192.168.99.35).  Because the IP
        address is in use by
        <code class="systemitem">tristan</code>, 
        <code class="systemitem">dietrich</code> receives a
        response.  Any response by a device on the Ethernet indicating that an
        IP address is in use will cause the <span class="command"><strong>arping</strong></span> command
        to exit with a non-zero exit code (specifically, exit code 1).
      </p><p>
        Note, that the Ethernet device must already be in an UP state (see
        <a class="xref" href="#tools-ip-link" title="3. ip link">Section 3, &#8220;<span class="command"><strong>ip link</strong></span>&#8221;</a>).  If the Ethernet device has not been
        brought up, the <span class="command"><strong>arping</strong></span> utility will exit with a
        non-zero exit code (specifically, exit code 2).
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ip-link"></a>3. <span class="command"><strong>ip link</strong></span></h2></div></div></div><p>
        Part of the <span class="command"><strong>iproute2</strong></span> suite, <span class="command"><strong>ip
        link</strong></span> provides the ability to
        <a class="link" href="#tools-ip-link-show" title="3.1. Displaying link layer characteristics with ip link show">display link layer
        information</a>,
        <a class="link" href="#tools-ip-link-set-up" title="3.4. Activating a device with ip link set">activate an interface</a>,
        <a class="link" href="#tools-ip-link-set-down" title="3.3. Deactivating a device with ip link set">deactivate an interface</a>,
        <a class="link" href="#tools-ip-link-set" title="3.2. Changing link layer characteristics with ip link set">change link layer state
        flags</a>, <a class="link" href="#tools-ip-link-set-mtu" title="3.5. Using ip link set to change the MTU">change MTU</a>,
        <a class="link" href="#tools-ip-link-set-name" title="3.6. Changing the device name with ip link set">the name of the interface</a>,
        and even the <a class="link" href="#tools-ip-link-set-address" title="3.7. Changing hardware or Ethernet broadcast address with ip link set">hardware and
        Ethernet broadcast address</a>.
      </p><p>
        The <span class="command"><strong>ip link</strong></span> tool provides the following two verbs:
        <a class="link" href="#tools-ip-link-show" title="3.1. Displaying link layer characteristics with ip link show"><span class="command"><strong>ip link show</strong></span></a> and
        <a class="link" href="#tools-ip-link-set" title="3.2. Changing link layer characteristics with ip link set"><span class="command"><strong>ip link set</strong></span></a>.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-show"></a>3.1. Displaying link layer characteristics with <span class="command"><strong>ip link
          show</strong></span></h3></div></div></div><p>
          To display link layer information, <span class="command"><strong>ip link show</strong></span>
          will fetch characteristics of the link layer devices currently
          available.  Any networking device which has a driver loaded can be
          classified as an available device.  It is immaterial to <span class="command"><strong>ip
          link</strong></span> whether the device is in use by any higher layer
          protocols (e.g., IP).  You can specify which device you want to
          know more about with the <span class="command"><strong>dev &lt;interface&gt;</strong></span>
          option.
        </p><div class="example"><a name="ex-tools-ip-link-show"></a><p class="title"><b>Example B.6. Using <span class="command">ip link show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show</code></strong>
<code class="computeroutput">1: lo: &lt;LOOPBACK,UP&gt; mtu 16436 qdisc noqueue 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
          </pre></div></div><br class="example-break"><p>
          Here we see that the only devices with drivers loaded on 
          <code class="systemitem">tristan</code> are
          <span class="command"><strong>lo</strong></span> and <span class="command"><strong>eth0</strong></span>.  Note, as with
          <a class="link" href="#tools-ip-address-show" title="2.1. Displaying interface information with ip address show"><span class="command"><strong>ip address
          show</strong></span></a>, the <span class="command"><strong>ip</strong></span> utility will
          sequentially number the output.  These numbers are dynamically
          calcualted, so should not be used to refer to the interfaces.  It is
          far better (and more intuitive) to refer to the interfaces by name.
        </p><p>
          For each device, two lines will summarize the link state and
          characteristics.  If you are familiar with <a class="link" href="#tools-ifconfig-output" title="1.4. Reading ifconfig output"><span class="command"><strong>ifconfig</strong></span>
          output</a>, you should notice that these two lines are a terse
          summary of lines 1 and 3 of each <span class="command"><strong>ifconfig</strong></span> device
          entry.
        </p><p>
          The flags here are the same <a class="link" href="#tb-tools-ifconfig-flags" title="Table C.1. Interface Flags">
          flags reported by <span class="command"><strong>ifconfig</strong></span></a>, although
          by contrast to <span class="command"><strong>ifconfig</strong></span>, <span class="command"><strong>ip link
          show</strong></span> seems to report the state of the device flags
          accurately.
        </p><p>
          Let's take a brief tour of the <span class="command"><strong>ip link show</strong></span>
          output.  Line one summarizes the
          current name of the device, the flags set on the device,
          <a class="link" href="#routing-icmp-mtu" title="10.1. MTU, MSS, and ICMP">the maximum transmission unit
          (MTU)</a> the active queueing mechanism (if any), and
          the queue size if there is a queue present.  The second line will
          always indicate the type of link layer in use on the device, and
          link layer specific information.  For Ethernet, the common case,
          the current hardware address and Ethernet broadcast address will be
          displayed.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set"></a>3.2. Changing link layer characteristics with
          <span class="command"><strong>ip link set</strong></span></h3></div></div></div><p>
          Frankly, with the exception of 
          <a class="link" href="#tools-ip-link-set-up" title="3.4. Activating a device with ip link set"><span class="command"><strong>ip link set
          up</strong></span></a> and <a class="link" href="#tools-ip-link-set-down" title="3.3. Deactivating a device with ip link set"><span class="command"><strong>ip link set
          down</strong></span></a>
          I have not found need to use the <span class="command"><strong>ip link
          set</strong></span> command with any of the toggle flags  Regardless, 
          here's an example of the proper operation of the utility.  Paranoid
          network administrators or those who wish to map Ethernet addresses
          manually should take special note of the <span class="command"><strong>ip link set arp
          off</strong></span> command.
        </p><div class="example"><a name="ex-tools-ip-link-set"></a><p class="title"><b>Example B.7. Using <span class="command">ip link set</span> to change device flags</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 promisc on</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 multicast off promisc off</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set arp off</code></strong>
<code class="computeroutput">Not enough of information: "dev" argument is required.</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set arp off dev eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,NOARP,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
[root@enclitic root]# ip link set dev eth0 arp on 
<code class="prompt">[root@tristan root]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
          </pre></div></div><br class="example-break"><p>
          Any of the below flags are valid on any device.
        </p><div class="table"><a name="tb-ip-link-set-flags"></a><p class="title"><b>Table B.1. <span class="command">ip link</span> link layer device states</b></p><div class="table-contents"><table class="table" summary="ip link link layer device states" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Flag</th><th align="center">Possible States</th></tr></thead><tbody><tr><td align="center">arp</td><td align="center">on | off</td></tr><tr><td align="center">promisc</td><td align="center">on | off</td></tr><tr><td align="center">allmulti</td><td align="center">on | off</td></tr><tr><td align="center">multicast</td><td align="center">on | off</td></tr><tr><td align="center">dynamic</td><td align="center">on | off</td></tr></tbody></table></div></div><br class="table-break"><p>
          Users who would like more information about flags on link layer
          devices and their meanings should refer to Alexey Kuznetsov's
          excellent <span class="command"><strong>iproute2</strong></span> reference.  See the
          <a class="xref" href="#links-iproute2" title="1.6. iproute2 documentation">Section 1.6, &#8220;iproute2 documentation&#8221;</a> for further links.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set-down"></a>3.3. Deactivating a device with <span class="command"><strong>ip link set</strong></span></h3></div></div></div><p>
          In the same way that using the tool <span class="command"><strong>ifconfig
          &lt;interface&gt; down</strong></span> can summarily stop networking,
          <span class="command"><strong>ip link set dev &lt;interface&gt; down</strong></span> will have
          a number of side effects for higher networking layers which are
          bound to this device.
        </p><p>
          Let's look at the side effects of using <span class="command"><strong>ip link</strong></span>
          to bring an interface down.
        </p><div class="example"><a name="ex-tools-ip-link-set-down"></a><p class="title"><b>Example B.8. Deactivating a link layer device with <span class="command">ip link
            set</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.99.0/24 dev eth0  proto kernel  scope link  src 192.168.99.35
127.0.0.0/8 dev lo  scope link 
default via 192.168.99.254 dev eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 down</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">127.0.0.0/8 dev lo  scope link</code>
          </pre></div></div><br class="example-break"><p>
          In our first command, we are able to determine that the
          <span class="command"><strong>eth0</strong></span> is in an UP state.  Naturally, <span class="command"><strong>ip
          link</strong></span> will not tell us if there is an IP bound to the
          device (use <a class="link" href="#tools-ip-address" title="2. ip address"><span class="command"><strong>ip
          address</strong></span></a> to answer this question).   Let's assume
          that <code class="systemitem">tristan</code> was
          operating normally on 192.168.199.35.  If so, the routing table will
          appear exactly is it appears in
          <a class="xref" href="#ex-tools-ip-link-set-down" title="Example B.8. Deactivating a link layer device with ip link set">Example B.8, &#8220;Deactivating a link layer device with <span class="command">ip link
            set</span>&#8221;</a>.
        </p><p>
          Now when we down the link layer on <span class="command"><strong>eth0</strong></span>, we'll
          see that there is now no longer a flag UP in the link layer output
          of <a class="link" href="#tools-ip-address-show" title="2.1. Displaying interface information with ip address show"><span class="command"><strong>ip
          address</strong></span></a>.  More interesting, though, all of our
          IP routes to destinations via <span class="command"><strong>eth0</strong></span> are now
          missing.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set-up"></a>3.4. Activating a device with <span class="command"><strong>ip link set</strong></span></h3></div></div></div><p>
          Before an interface can be bound to a device, the kernel needs to
          support the physical networking device (beyond the scope of this
          document) either as a module or as part of the monolithic kernel.
          If <span class="command"><strong>ip link show</strong></span> lists the device, then this
          condition has been satisfied, and <span class="command"><strong>ip link set dev
          &lt;interface&gt;</strong></span> can be used to activate the interface.
        </p><div class="example"><a name="ex-tools-ip-link-set-up"></a><p class="title"><b>Example B.9. Activating a link layer device with <span class="command">ip link
            set</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>arping -D -I eth0 192.168.99.35</code></strong>
<code class="computeroutput">Interface "eth0" is down</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 up</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.99.0/24 dev eth0  proto kernel  scope link  src 192.168.99.35
127.0.0.0/8 dev lo  scope link</code>
          </pre></div></div><br class="example-break"><p>
          Once the device itself has been activated, operations which require
          the ability to read data from the device or write data to the device
          will succeed.  Refer to <a class="xref" href="#ex-tools-arping-dad" title="Example B.5. Duplicate Address Detection with arping">Example B.5, &#8220;Duplicate Address Detection with <span class="command">arping</span>&#8221;</a> for
          a clear example of a network operation which does not require a
          functional IP layer but need access to a functioning link layer.
        </p><p>
          I'll suggest that the reader consider what other common networking
          device might not want to have a functional IP layer, but would need
          a functioning link layer.  FIXME -- Why in the world does tcpdump
          work even though the link layer is down? -- FIXME
        </p><p>
          In <a class="xref" href="#ex-tools-ip-link-set-up" title="Example B.9. Activating a link layer device with ip link set">Example B.9, &#8220;Activating a link layer device with <span class="command">ip link
            set</span>&#8221;</a>, we are bringing up a
          device which already has IP address information bound to the device.
          Notice that as soon as the link layer is brought up, the network
          route to the local network is entered into the main routing table.
          By comparing <a class="xref" href="#ex-tools-ip-link-set-up" title="Example B.9. Activating a link layer device with ip link set">Example B.9, &#8220;Activating a link layer device with <span class="command">ip link
            set</span>&#8221;</a> and
          <a class="xref" href="#ex-tools-ip-link-set-down" title="Example B.8. Deactivating a link layer device with ip link set">Example B.8, &#8220;Deactivating a link layer device with <span class="command">ip link
            set</span>&#8221;</a>, we notice that when the
          link layer is brought up the default route is not returned!  This is the
          most significant side effect of bringing down an interface through
          which other networks are reachable.  There are several ways to 
          repair the frightful missing default route condition: you can use
          <a class="link" href="#tools-ip-route-add-default" title="2.4. Adding a default route with ip route add default"><span class="command"><strong>ip route
          add</strong></span></a>, <a class="link" href="#tools-route-add-default" title="1.5. Creating a default route with route add default"><span class="command"><strong>route
          add</strong></span></a>, or you can run the
          networking startup scripts again.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set-mtu"></a>3.5. Using <span class="command"><strong>ip link set</strong></span> to change the MTU</h3></div></div></div><p>
          Changing the MTU on an interface is a classical example of an
          operation which, prior to the arrival of <span class="command"><strong>iproute2</strong></span>
          one could only accomplish with the <span class="command"><strong>ifconfig</strong></span>
          command.  Since <span class="command"><strong>iproute2</strong></span> has separate
          utilities for managing the link layer, addressing, routing, and
          other IP-related objects, it becomes clear even with
          the command-line utilities that the MTU is really a function of
          the link layer protocol.
        </p><div class="example"><a name="ex-tools-ip-link-set-mtu"></a><p class="title"><b>Example B.10. Using <span class="command">ip link set</span> to change device flags</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code># ip link set dev eth0 mtu 1412</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1412 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
          </pre></div></div><br class="example-break"><p>
          This simple example demonstrates exactly how to change the MTU.  For
          a broader discussion of MTU, please consult
          <a class="xref" href="#routing-icmp-mtu" title="10.1. MTU, MSS, and ICMP">Section 10.1, &#8220;MTU, MSS, and ICMP&#8221;</a>.  The remaining options to the <span class="command"><strong>ip
          link</strong></span> command cannot be used while the interface is in an
          UP state.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set-name"></a>3.6. Changing the device name with
          <span class="command"><strong>ip link set</strong></span></h3></div></div></div><p>
          For the occasional need to rename an interface from one name to
          another, the command <span class="command"><strong>ip link set</strong></span> provides the
          desired functionality. Though this command must be used when the
          device is not in an UP state, the command itself is quite simple.
          Let's name the interface <span class="command"><strong>inside0</strong></span>.
        </p><div class="example"><a name="ex-tools-ip-link-set-name"></a><p class="title"><b>Example B.11. Changing the device name with <span class="command">ip link set</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 mtu 1500</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 name inside</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev inside</code></strong>
<code class="computeroutput">2: inside: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
          </pre></div></div><br class="example-break"><p>
          The convenience of being able to rename devices can be substantial
          when you are managing many machines and want to use the same
          name on many different machines, which may have different hardware.
          Of course, by changing the name of the device, you may foil any
          scripts which assume conventional device names
          (<span class="command"><strong>eth0</strong></span>, <span class="command"><strong>eth1</strong></span>,
          <span class="command"><strong>ppp0</strong></span>).
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-link-set-address"></a>3.7. Changing hardware or Ethernet broadcast address with
          <span class="command"><strong>ip link set</strong></span></h3></div></div></div><p>
          This command changes the hardware or broadcast address of a device
          as used on the media to which it is connected.  Supposedly there can
          be name clashes between two different Ethernet cards sharing the
          same hardware address.  I have yet to see this problem, so I suspect
          that changing the hardware address is more commonly used in
          vulnerabliity testing or even more nefarious purposes.
        </p><p>
          Alternatively, one can set the broadcast address to a different
          value, which as Alexey remarks as an aside in the
          <span class="command"><strong>iproute2</strong></span> manual will "break networking."
          Changing the Ethernet broadcast address implies that no
          conventionally configured host will answer broadcast ARP frames
          transmitted onto the Ethernet.  Since conventional ARP requests
          are sent to the Ethernet broadcast of
          <code class="constant">ff:ff:ff:ff:ff:ff</code>, broadcast frames sent after
          changing the link layer broadcast address will not be received by
          other hosts on the segment.  To echo
          Alexey's sentiments:  if you are not sure what you are doing, don't
          change this.  You'll break networking terribly.
        </p><div class="example"><a name="ex-tools-ip-link-set-address"></a><p class="title"><b>Example B.12. Changing broadcast and hardware addresses with <span class="command">ip link set</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev inside name eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 address 00:80:c8:f8:be:ef</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:be:ef brd ff:ff:ff:ff:ff:ff</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link set dev eth0 broadcast ff:ff:88:ff:ff:88</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip link show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:be:ef brd ff:ff:88:ff:ff:88</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ping -c 1 -n 192.168.99.254 &gt;/dev/null 2&gt;&amp;1 &amp;</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>tcpdump -nnqtei eth0</code></strong>
<code class="computeroutput">tcpdump: listening on eth0
0:80:c8:f8:be:ef ff:ff:88:ff:ff:88 42: arp who-has 192.168.99.254 tell 192.168.99.35
0:80:c8:f8:be:ef ff:ff:88:ff:ff:88 42: arp who-has 192.168.99.254 tell 192.168.99.35</code>
          </pre></div></div><br class="example-break"><p>
          This practical example demonstrates setting the hardware address and
          the broadcast address.  Changing the hardware address, also known as
          the media access control (MAC) address, is not usually necessary.
          It is a simple operation without detrimental side effects, provided
          there is no address clash with an existing device.
        </p><p>
          Note, however, in the tcpdump output, the effect of changing
          the Ethernet broadcast address.  As discussed in the paragraph
          above, changing the broadcast is probably not a good idea
          <a href="#ftn.idm4075" class="footnote" name="idm4075"><sup class="footnote">[42]</sup></a>.
        </p><p>
          As you can see, the <span class="command"><strong>ip link</strong></span> utility is a treasure
          trove of information and allows a great deal of control over the
          devices on a linux system.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ip-neighbor"></a>4. <span class="command"><strong>ip neighbor</strong></span></h2></div></div></div><p>
        Part of the <span class="command"><strong>iproute2</strong></span> command suite, <span class="command"><strong>ip
        neighbor</strong></span> provides a command line interface to
        <a class="link" href="#ex-tools-ip-neighbor-show" title="Example B.13. Displaying the ARP cache with ip neighbor show">display the neighbor table
        (ARP cache)</a>,
        <a class="link" href="#ex-tools-ip-neighbor-add" title="Example B.16. Entering a permanent entry into the ARP cache with ip neighbor add">insert permanent
        entries</a>,
        <a class="link" href="#ex-tools-ip-neighbor-del" title="Example B.19. Removing an entry from the ARP cache with ip neighbor del">remove specific
        entries</a> and
        <a class="link" href="#ex-tools-ip-neighbor-flush" title="Example B.20. Removing learned entries from the ARP cache with ip neighbor flush">remove a large number of
        entries</a>.
        For peculiarities and commonalities of the <span class="command"><strong>iproute2</strong></span>
        tools, refer to
        <a class="xref" href="#tools-iproute2-remarks" title="2. Some general remarks about iproute2 tools">Section 2, &#8220;Some general remarks about <span class="command"><strong>iproute2</strong></span> tools&#8221;</a>.
      </p><p>
        The more commonly used analog to <span class="command"><strong>ip neighbor show</strong></span>,
        <a class="link" href="#tools-arp" title="1. arp"><span class="command"><strong>arp -n</strong></span></a> displays
        the ARP cache in a possibly more recognizable format.
      </p><div class="example"><a name="ex-tools-ip-neighbor-show"></a><p class="title"><b>Example B.13. Displaying the ARP cache with <span class="command">ip neighbor
          show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show</code></strong>
<code class="computeroutput">192.168.99.254 dev eth0 lladdr 00:80:c8:f8:5c:73 nud reachable</code>
        </pre></div></div><br class="example-break"><p>
        On routers and other machines with large ARP caches, you may find you
        wish to look at the ARP cache only on a particular interface.  By
        specifying the interface on which you wish to see the neighbor table,
        you can limit the output.
      </p><div class="example"><a name="ex-tools-ip-neighbor-show-interface"></a><p class="title"><b>Example B.14. Displaying the ARP cache on an interface with <span class="command">ip
          neighbor show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@wan-gw]# </code><strong class="userinput"><code>ip neighbor show dev eth0</code></strong>
<code class="computeroutput">205.254.211.39 lladdr 00:02:b3:a1:b8:df nud delay
205.254.211.54 lladdr 00:d0:b7:80:ce:ce nud delay
205.254.211.179 lladdr 00:80:c8:f8:5c:72 nud reachable</code>
        </pre></div></div><br class="example-break"><p>
        Another way to limit the output is to specify the subnet in which you
        are interested.  Simply append the subnet specification to the
        command.
      </p><div class="example"><a name="ex-tools-ip-neighbor-show-network"></a><p class="title"><b>Example B.15. Displaying the ARP cache for a particular network with
          <span class="command">ip neighbor show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neighbor show 192.168.100.0/24</code></strong>
<code class="computeroutput">192.168.100.1 dev eth3 lladdr 00:c0:7b:7d:00:c8 nud stale
192.168.100.17 dev eth0 lladdr 00:80:c8:e8:4b:8e nud reachable</code>
        </pre></div></div><br class="example-break"><p>
        Note that in the case of <code class="systemitem">masq-gw</code>, there are neighbor table entries
        for IPs on more than one interface, because <code class="systemitem">masq-gw</code> breaks the
        192.168.100.0/24 network into two parts.  This is an advanced
        technique described in fuller detail in
        <a class="xref" href="#adv-proxy-arp" title="3. Breaking a network in two with proxy ARP">Section 3, &#8220;Breaking a network in two with proxy ARP&#8221;</a>.
      </p><p>
        In addition to displaying the neighbor table, it is possible to make
        static mappings.  For paranoid systems administrators, who do not want
        to enable ARP on their networks or on particular links, the
        <span class="command"><strong>ip neighbor add</strong></span> command may prove useful.  Refer to
        <a class="xref" href="#ether-arp-filtering" title="3. ARP filtering">Section 3, &#8220;ARP filtering&#8221;</a> for a discussion of the
        ramifications of disabling ARP.
      </p><p>
        In <a class="xref" href="#ex-tools-ip-neighbor-add" title="Example B.16. Entering a permanent entry into the ARP cache with ip neighbor add">Example B.16, &#8220;Entering a permanent entry into the ARP cache with <span class="command">ip
          neighbor add</span>&#8221;</a>, let's assume that the
        service router is incapable of correctly answering ARP requests.  The
        administrator of <code class="systemitem">masq-gw</code> could make a permanent entry in the ARP
        cache mapping 192.168.100.1 to the link layer address of
        <code class="systemitem">service-router</code>.
      </p><div class="example"><a name="ex-tools-ip-neighbor-add"></a><p class="title"><b>Example B.16. Entering a permanent entry into the ARP cache with <span class="command">ip
          neighbor add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neighbor add 192.168.100.1 lladdr 00:c0:7b:7d:00:c8 dev eth3 nud permanent</code></strong>
        </pre></div></div><br class="example-break"><p>
        This creates an entry in the neighbor table which maps
        192.168.100.1 to link layer address 00:c0:7b:7d:00:c8.  Subsequent IP
        packets bound for 192.168.100.1 will be encapsulated in Ethernet
        frames with 00:c0:7b:7d:00:c8 in the destination bytes.  This
        permanent mapping cannot be overridden by ARP.  It would need to be
        removed with
        <a class="link" href="#ex-tools-ip-neighbor-del" title="Example B.19. Removing an entry from the ARP cache with ip neighbor del"><span class="command"><strong>ip neighbor
        delete</strong></span></a>.
      </p><p>
        For those who insist on such a thing, there is support for creating
        and deleting proxy ARP entries with <span class="command"><strong>ip neighbor</strong></span>,
        although this has been deprecated.  For a long discussion of this
        topic, see
        <a class="ulink" href="http://www.uwsg.iu.edu/hypermail/linux/kernel/0110.2/index.html#523" target="_top">this
        discussion on the kernel mailing list</a>.  Other tools should be
        used to create proxy ARP entries.  Refer to
        <a class="xref" href="#tools-arp" title="1. arp">Section 1, &#8220;<span class="command"><strong>arp</strong></span>&#8221;</a>,
        <a class="xref" href="#adv-proxy-arp" title="3. Breaking a network in two with proxy ARP">Section 3, &#8220;Breaking a network in two with proxy ARP&#8221;</a> and
        <a class="xref" href="#ether-arp-proxy" title="2. Proxy ARP">Section 2, &#8220;Proxy ARP&#8221;</a>.
      </p><div class="example"><a name="ex-tools-ip-neighbor-add-proxy"></a><p class="title"><b>Example B.17. Entering a proxy ARP entry with <span class="command">ip
          neighbor add proxy</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="computeroutput"># -- this is deprecated; use arp or kernel proxy_arp instead --#</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neighbor add proxy 192.168.100.1 dev eth0</code></strong>
<code class="computeroutput"># -- this is deprecated; use arp or kernel proxy_arp instead --#</code>
        </pre></div></div><br class="example-break"><p>
        Strangely, the <span class="command"><strong>ip neighbor show</strong></span> command does not
        display any entries added and deleted with <span class="command"><strong>ip neighbor
        add proxy</strong></span>, so
        <a class="link" href="#tools-arp" title="1. arp"><span class="command"><strong>arp</strong></span></a> is required
        to view these entries.  In short, don't use <span class="command"><strong>ip neighbor add
        proxy</strong></span>.
      </p><p>
        Entries can also be modified at any time.  This allows learned entries
        to be replaced with 
        static entries if there's already an entry in the ARP cache for
        a specified IP.
      </p><div class="example"><a name="ex-tools-ip-neighbor-change"></a><p class="title"><b>Example B.18. Altering an entry in the ARP cache with <span class="command">ip neighbor
          change</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor add 192.168.99.254 lladdr 00:80:c8:27:69:2d dev eth3</code></strong>
<code class="computeroutput">RTNETLINK answers: File exists</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.254</code></strong>
<code class="computeroutput">192.168.99.254 dev eth0 lladdr 00:80:c8:f8:5c:73 nud reachable</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor change 192.168.99.254 lladdr 00:80:c8:27:69:2d dev eth3</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor show 192.168.99.254</code></strong>
<code class="computeroutput">192.168.99.254 dev eth0 lladdr 00:80:c8:27:69:2d nud permanent</code>
        </pre></div></div><br class="example-break"><p>
        To remove the entry we added above in
        <a class="xref" href="#ex-tools-ip-neighbor-add" title="Example B.16. Entering a permanent entry into the ARP cache with ip neighbor add">Example B.16, &#8220;Entering a permanent entry into the ARP cache with <span class="command">ip
          neighbor add</span>&#8221;</a>, we could run the following
        command.  This invalidates the entry forcing the NUD of the entry
        into <span class="emphasis"><em>failed</em></span> state.  
      </p><div class="example"><a name="ex-tools-ip-neighbor-del"></a><p class="title"><b>Example B.19. Removing an entry from the ARP cache with <span class="command">ip
          neighbor del</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neighbor del 192.168.100.1 dev eth3</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip neighbor show dev eth3</code></strong>
<code class="computeroutput">192.168.100.1  nud failed</code>
        </pre></div></div><br class="example-break"><p>
        Subsequent attempts to reach the IP address 192.168.100.1 will require
        the generation of a new ARP request, which (you hope!) returns the new
        or currently available link layer address.
      </p><p>
        While I have never found a good use for the <span class="command"><strong>ip neighbor
        flush</strong></span> command, it is provided, and accepts a
        destination network address as an argument.  Without a destination
        network address, an interface specification is required.
      </p><div class="example"><a name="ex-tools-ip-neighbor-flush"></a><p class="title"><b>Example B.20. Removing learned entries from the ARP cache with <span class="command">ip
          neighbor flush</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip neighbor flush dev eth3</code></strong>
        </pre></div></div><br class="example-break"><p>
        Although it is not commonly required, the <span class="command"><strong>ip
        neighbor</strong></span> tool is a convenient tool for displaying and
        altering the ARP cache (neighbor table).
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-mii-tool"></a>5. <span class="command"><strong>mii-tool</strong></span></h2></div></div></div><p>
        A key tool for determining if you are connected to the Ethernet, and
        if so, at what speed.  The <span class="command"><strong>mii-tool</strong></span> program
        does not support all Ethernet devices, as some Ethernet devices have
        their own vendor-supplied tools to report the same information.  The
        <span class="command"><strong>mii-tool</strong></span> source code is based on a tool called
        <span class="command"><strong>mii-diag</strong></span> which provides slightly more information
        but is less user friendly.
      </p><p>
        The information reported by <span class="command"><strong>mii-tool</strong></span> is quite
        terse.  The following table should clarify the meaning of the speeds
        you'll encounter in output from <span class="command"><strong>mii-tool</strong></span>
        <a href="#ftn.idm4208" class="footnote" name="idm4208"><sup class="footnote">[43]</sup></a>.
      </p><div class="table"><a name="tb-mii-tool-port-speed"></a><p class="title"><b>Table B.2. Ethernet Port Speed Abbreviations</b></p><div class="table-contents"><table class="table" summary="Ethernet Port Speed Abbreviations" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Port Speed</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">10baseT-HD</td><td align="center">10 megabit half duplex</td></tr><tr><td align="center">10baseT-FD</td><td align="center">10 megabit full duplex</td></tr><tr><td align="center">100baseTx-HD</td><td align="center">100 megabit half duplex</td></tr><tr><td align="center">100baseTx-FD</td><td align="center">100 megabit full duplex</td></tr></tbody></table></div></div><br class="table-break"><p>
        The raw number indicates the number of bits which can be exchanged
        between two Ethernet devices over the wire.  So 10 megabit Ethernet
        can support the transmission of ten million bits per second.  The
        suffix to each identifier indicates whether both hosts can send and
        receive simultaneously or not.  Half duplex means that each device can
        either send or receive in the same instant.  Full duplex means that
        both devices can send and receive simultaneously.
      </p><p>
        The simplest use of <span class="command"><strong>mii-tool</strong></span> reports the link
        status of all Ethernet devices on a system.  Any argument
        to <span class="command"><strong>mii-tool</strong></span> is interpreted as an interface name to
        query for link status.
      </p><div class="example"><a name="tools-mii-tool-list"></a><p class="title"><b>Example B.21. Detecting link layer status with <span class="command">mii-tool</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool</code></strong>
<code class="computeroutput">eth0: negotiated 100baseTx-FD, link ok</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool -v</code></strong>
<code class="computeroutput">eth0: negotiated 100baseTx-FD, link ok
  product info: vendor 08:00:17, model 1 rev 0
  basic mode:   autonegotiation enabled
  basic status: autonegotiation complete, link ok
  capabilities: 100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD
  advertising:  100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD
  link partner: 100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD flow-control</code>
        </pre></div></div><br class="example-break"><p>
        In the above example, we can infer that
        <code class="systemitem">tristan</code> has only one
        Ethernet device (or no Ethernet drivers loaded for any other present
        Ethernet devices).  The first Ethernet device has successfully
        negotiated a 100 megabit full duplex connection with the device to
        which it is connected.
      </p><p>
        Although a great rarity, you may have occasion to dictate to the
        Ethernet interface the speed at which it should talk to the switch or
        hub.  <span class="command"><strong>mii-tool</strong></span> supports a mode of operation under
        which you indicate supported modes for autonegotiation.  Normally, two
        connected devices will negotiate the fastest possible commonly shared
        speed.  You can select what speeds you want to support on an Ethernet
        interface by using <span class="command"><strong>mii-tool</strong></span>.
      </p><div class="example"><a name="tools-mii-tool-advertise"></a><p class="title"><b>Example B.22. Specifying Ethernet port speeds with <span class="command">mii-tool --advertise</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool mii-tool --advertise 10baseT-HD,10baseT-FD</code></strong>
<code class="computeroutput">restarting autonegotiation...</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool</code></strong>
<code class="computeroutput">eth0: negotiated 10baseT-FD, link ok</code>
        </pre></div></div><br class="example-break"><p>
        After we specified that we wished only to support 10baseT-HD and
        10baseT-FD as acceptable speeds, mii-tool caused the Ethernet driver
        to renegotiate port speed with the attached device.  Here we selected
        10baseT-FD.
      </p><div class="example"><a name="tools-mii-tool-force"></a><p class="title"><b>Example B.23. Forcing Ethernet port speed with <span class="command">mii-tool --force</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool --force 10baseT-FD</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool</code></strong>
<code class="computeroutput">eth0: 10 Mbit, full duplex, link ok</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool --restart</code></strong>
<code class="computeroutput">restarting autonegotiation...</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>mii-tool</code></strong>
<code class="computeroutput">eth0: negotiated 100baseTx-FD, link ok</code>
        </pre></div></div><br class="example-break"><p>
        After manipulating the speed at which the Ethernet driver would
        communicate with the connected device on <code class="systemitem">tristan</code>, we chose to
        restart the autonegotiation process without forcing a particular speed
        or advertising a particular speed.
      </p><p>
        So, if you must know at what speed your linux machine is connected to
        another device, <span class="command"><strong>mii-tool</strong></span> comes to your rescue.
      </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm3725" class="footnote"><p><a href="#idm3725" class="para"><sup class="para">[41] </sup></a>
            I know of one instance where some devices which used DHCP
            to join the network were suddenly and apparently inexplicably
            receiving addresses in an unexpected netblock.
            After some head-scratching and judicious use of
            <span class="command"><strong>tcpdump</strong></span> to record the Ethernet address of the
            DHCP server giving out the bogus IP information, the administrator
            was able to track down a device through the switch to a port on
            the LAN.
            It turned out to be a tiny (4-port) hub with an embedded DHCP server
            which was intended for home use!  The knowledge of the Ethernet
            address of the rogue DHCP server was the key to physically
            locating the device.
          </p></div><div id="ftn.idm4075" class="footnote"><p><a href="#idm4075" class="para"><sup class="para">[42] </sup></a>
              I refer the reader to an adage:  <span class="emphasis"><em>Just because it can
              be done doesn't mean it should be done.</em></span>
            </p></div><div id="ftn.idm4208" class="footnote"><p><a href="#idm4208" class="para"><sup class="para">[43] </sup></a>
            There is a standard speed/Ethernet transmission style supported by
            <span class="command"><strong>mii-tool</strong></span> to which I have not referred.  That is
            100BaseT4.  100BaseT4 provides support for 100 megabit Ethernet
            networking over Category 3 rated cable.  This is probably not a
            concern for most recently upgraded network infrastructure.  The
            standard networking cable pulled in new construction and
            renovation is now Category 5 cable which supports 100Base-Tx-FD
            and possibly gigabit Ethernet.  So, let's relegate 100BaseT4 to
            this footnote, and resume.
          </p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-ip-management"></a>Appendix C. IP Address Management</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-ifconfig">1. <span class="command"><strong>ifconfig</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ifconfig-display">1.1. Displaying interface information with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-down">1.2. Bringing down an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-up">1.3. Bringing up an interface with
          <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-output">1.4. Reading <span class="command"><strong>ifconfig</strong></span> output</a></span></dt><dt><span class="section"><a href="#tools-ifconfig-mtu">1.5. Changing MTU with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-flags">1.6. Changing device flags with <span class="command"><strong>ifconfig</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ifconfig-conclusion">1.7. General remarks about <span class="command"><strong>ifconfig</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-address">2. <span class="command"><strong>ip address</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-address-show">2.1. Displaying interface information with
            <span class="command"><strong>ip address show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-add">2.2. Using <span class="command"><strong>ip address add</strong></span> to configure
          IP address information</a></span></dt><dt><span class="section"><a href="#tools-ip-address-del">2.3. Using <span class="command"><strong>ip address del</strong></span> to remove IP addresses
          from an interface</a></span></dt><dt><span class="section"><a href="#tools-ip-address-flush">2.4. Removing all IP address information from an interface
          with <span class="command"><strong>ip address flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-address-conclusion">2.5. Conclusion</a></span></dt></dl></dd></dl></div><p>
      A machine which can access Internet resources has an IP address, whether
      that IP address is a public address or a private address hidden behind
      an
      <a class="link" href="#ch-snat" title="Chapter 6. Masquerading and Source Network Address Translation">SNAT router</a>
      <a href="#ftn.idm4284" class="footnote" name="idm4284"><sup class="footnote">[44]</sup></a>.
      With the increasingly common use of linux machines as servers, desktops,
      and
      embedded devices and with changing network topologies and re-addressing,
      the need to be able to determine the current IP address of a machine and
      modify that address has consequently become a common need.
    </p><p>
      I assume in this chapter that the reader has some familiarity with CIDR
      addressing and netmasks.  If any of these concepts are unfamiliar, or
      the reader would like to brush up, I suggest a visit to some of the
      links which can be found in <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
    </p><p>
      We'll begin our tour of the utilities for
      observing, changing, removing, and adding IP addresses to network
      devices with <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a>, the
      traditional utility for IP management.  We will also examine the newer
      and more flexible <a class="link" href="#tools-ip-address" title="2. ip address"><span class="command"><strong>ip address</strong></span></a>, a key
      part of the <span class="command"><strong>iproute2</strong></span> package.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ifconfig"></a>1. <span class="command"><strong>ifconfig</strong></span></h2></div></div></div><p>
        The venerable <span class="command"><strong>ifconfig</strong></span> is available on almost every
        unix I have encountered.  In addition to
        <a class="link" href="#tools-ifconfig-display" title="1.1. Displaying interface information with ifconfig">reporting the IP addressing and
        usage statistics</a> of an optionally specified interface,
        <span class="command"><strong>ifconfig</strong></span> can modify
        <a class="link" href="#tools-ifconfig-mtu" title="1.5. Changing MTU with ifconfig">an interface's MTU</a>
        and other <a class="link" href="#tools-ifconfig-flags" title="1.6. Changing device flags with ifconfig">flags and interface
        characteristics</a>,
        <a class="link" href="#tools-ifconfig-up" title="1.3. Bringing up an interface with ifconfig">bring up an interface</a> and
        <a class="link" href="#tools-ifconfig-down" title="1.2. Bringing down an interface with ifconfig">bring down an interface</a>.
        This tool is the primary tool for manipulation of IP addressing on many
        linux distributions.
      </p><p>
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-display"></a>1.1. Displaying interface information with
          <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
          In its simplest use, <span class="command"><strong>ifconfig</strong></span> merely reports the
          IP interface and relevant statistics.  For Ethernet devices, the
          hardware address, IP address, broadcast, netmask, IP interface states,
          and some other additional information is presented.  For other
          interfaces, different information may be presented to the user, but
          the basic summary of IP addressing information will always be
          available.  Be sure to read <a class="xref" href="#tools-ifconfig-output" title="1.4. Reading ifconfig output">Section 1.4, &#8220;Reading <span class="command"><strong>ifconfig</strong></span> output&#8221;</a>
          also.
        </p><div class="example"><a name="ex-tools-ifconfig-display"></a><p class="title"><b>Example C.1. Viewing interface information with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:306 errors:0 dropped:0 overruns:0 frame:0
          TX packets:306 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:29504 (28.8 Kb)  TX bytes:29504 (28.8 Kb)</code>
          </pre></div></div><br class="example-break"><p>
          It is fairly common to specify the name of an interface as an argument
          to <span class="command"><strong>ifconfig</strong></span>, which will restrict the output to the
          named interface.  This is the only way to retrieve information from
          <span class="command"><strong>ifconfig</strong></span> about link layer devices which are
          available, but not in an UP state.  See also
          <a class="xref" href="#tools-ip-link" title="3. ip link">Section 3, &#8220;<span class="command"><strong>ip link</strong></span>&#8221;</a> and <a class="xref" href="#tools-ip-address" title="2. ip address">Section 2, &#8220;<span class="command"><strong>ip address</strong></span>&#8221;</a>.
        </p><p>
          There are many other options available to the
          <span class="command"><strong>ifconfig</strong></span> command to control addressing and
          interface state.  Contrary to the behaviour of most other standard
          unix command line utilities which operate on arguments and options,
          <span class="command"><strong>ifconfig</strong></span> operates on a grammar after the specified
          interface.  Subsequent examples will demonstrate how this differs from
          conventional modern unix tools.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-down"></a>1.2. Bringing down an interface with
          <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
          Let's look at some simple operations you can perform with
          <span class="command"><strong>ifconfig</strong></span>.  Occasionally, you will need to bring
          down a network interface.
          For an introduction to this and its side effects, see
          <a class="xref" href="#ex-basic-ifconfig-down" title="Example 1.6. Bringing down a network interface with ifconfig">Example 1.6, &#8220;Bringing down a network interface with
          <span class="command">ifconfig</span>&#8221;</a> and
          <a class="link" href="#list-basic-ifconfig-side-effects-down">the list of
          side effects</a>.
        </p><div class="example"><a name="ex-tools-ifconfig-down"></a><p class="title"><b>Example C.2. Bringing down an interface with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 down</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig</code></strong>
<code class="computeroutput">lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:306 errors:0 dropped:0 overruns:0 frame:0
          TX packets:306 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:29504 (28.8 Kb)  TX bytes:29504 (28.8 Kb)</code>
          </pre></div></div><br class="example-break"><p>
          Naturally, when we view the active interfaces after downing the first
          Ethernet interface, we see that eth0 is no longer present.  This is
          exactly what we had intended.  Now to bring up the interface, we'll
          need the IP address and netmask information.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-up"></a>1.3. Bringing up an interface with
          <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
          Bringing up an interface is slightly more complex than bringing an
          interface down because you need to have the IP addressing
          information handy in order to bring the interface back.
          For an introduction to the side effects of bringing up an IP address
          on an interface, see
          <a class="xref" href="#ex-basic-ifconfig-up" title="Example 1.7. Bringing up an Ethernet interface with ifconfig">Example 1.7, &#8220;Bringing up an Ethernet interface with <span class="command">ifconfig</span>&#8221;</a> and
          <a class="link" href="#list-basic-ifconfig-side-effects-up">the list of
          side effects</a>.
        </p><div class="example"><a name="ex-tools-ifconfig-up"></a><p class="title"><b>Example C.3. Bringing up an interface with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 192.168.99.35 netmask 255.255.255.0 up</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:306 errors:0 dropped:0 overruns:0 frame:0
          TX packets:306 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:29504 (28.8 Kb)  TX bytes:29504 (28.8 Kb)</code>
          </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-output"></a>1.4. Reading <span class="command"><strong>ifconfig</strong></span> output</h3></div></div></div><p>
          The above operations are the simple operations one can perform with
          <span class="command"><strong>ifconfig</strong></span>.  Let's examine the output a bit more
          closely now, with an eye toward the other flags and settings we can
          manually twiddle.
        </p><p>
          The first line of each interface definition represents data which
          cannot be altered with ifconfig.  If we consider only Ethernet
          interfaces, the link encapsulation will always say "Ethernet", and the
          hardware address cannot be altered with <span class="command"><strong>ifconfig</strong></span>
          <a href="#ftn.idm4367" class="footnote" name="idm4367"><sup class="footnote">[45]</sup></a>.
          Below this, one line summarizes the IP information associated with
          this logical interface.
        </p><p>
          The third line indicates the current states of the interface, maximum
          transmission unit, and the metric for this interface.  Possible
          state options are itemized in the table below.  The maximimum
          transmission unit is routinely set to 1500 bytes for Ethernet and 
          promptly forgotten.  MTU suddenly becomes important when IP packets
          are forwarded across a link layer which requires a smaller MTU.  Thus
          <span class="command"><strong>ifconfig</strong></span> provides a method to set the MTU on an
          interface.  For more on MTU, see <a class="xref" href="#routing-icmp-mtu" title="10.1. MTU, MSS, and ICMP">Section 10.1, &#8220;MTU, MSS, and ICMP&#8221;</a>.  The
          remaining lines of output are taken from the Ethernet driver.  See
          further discussion of these statistics below.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-mtu"></a>1.5. Changing MTU with <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
           It is a rare occasion on which the MTU needs to be changed, but
           when it needs to be changed, nothing else will suffice.  Here's an
           example of setting the MTU on an interface to 1412 bytes.
        </p><div class="example"><a name="ex-tools-ifconfig-mtu"></a><p class="title"><b>Example C.4. Changing MTU with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 mtu 1412</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1412  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000</code>
          </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-flags"></a>1.6. Changing device flags with <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
          Every device on a system has flags which indicate the state the
          device may be in.  These flags can be altered by the
          <span class="command"><strong>ifconfig</strong></span> utility.
        </p><div class="table"><a name="tb-tools-ifconfig-flags"></a><p class="title"><b>Table C.1. Interface Flags</b></p><div class="table-contents"><table class="table" summary="Interface Flags" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Flag</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">UP</td><td align="center">device is functioning</td></tr><tr><td align="center">BROADCAST</td><td align="center">device can send traffic to all hosts on the link</td></tr><tr><td align="center">RUNNING</td><td align="center">???</td></tr><tr><td align="center">MULTICAST</td><td align="center">device can perform and receive multicast packets</td></tr><tr><td align="center">ALLMULTI</td><td align="center">device receives all multicast packets on the link</td></tr><tr><td align="center">PROMISC</td><td align="center">device receives all traffic on the link</td></tr></tbody></table></div></div><br class="table-break"><p>
          I cannot confidently recommend believing the flags as reported by
          <span class="command"><strong>ifconfig</strong></span> output.  Attestations from others and
          experimentation has proven to me that these flags (particularly the
          PROMISC flag) do not accurately represent the state of the device as
          reported in log files (by the kernel) and by the <a class="link" href="#tools-ip-link-show" title="3.1. Displaying link layer characteristics with ip link show"><span class="command"><strong>ip link show</strong></span></a>
          utility.
        </p><p>
          This does not mean, however, that the flags cannot be set with the
          ifconfig utility.  Manipulation of the flags on an interface operates
          according to a peculiar grammar.  To set the PROMISC flag, one issues
          a command with the <span class="command"><strong>promisc</strong></span> option from the grammar.
          If one wishes to remove the PROMISC flag from an interface, 
          the <span class="command"><strong>-promisc</strong></span> option is required.
        </p><div class="example"><a name="ex-tools-ifconfig-flags"></a><p class="title"><b>Example C.5. Setting interface flags with <span class="command">ifconfig</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 promisc</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1412  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 -promisc</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 -arp</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING NOARP MULTICAST  MTU:1412  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig eth0 arp</code></strong>
          </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ifconfig-conclusion"></a>1.7. General remarks about <span class="command"><strong>ifconfig</strong></span></h3></div></div></div><p>
          Since linux 2.0 the kernel has supported multiple IP addresses hosted
          on the same device.  By suffixing the real interface name with a
          colon and a non-negative integer, you can bring up additional IP
          adresses on the same device.  Example alias names are eth0:0 eth0:7.
          See <a class="xref" href="#adv-multi-ips" title="4. Multiple IPs on an Interface">Section 4, &#8220;Multiple IPs on an Interface&#8221;</a> for further details.
        </p><p>
          As you can see, <span class="command"><strong>ifconfig</strong></span> is both a powerful and
          idiosyncratic tool for controlling network interfaces and devices.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ip-address"></a>2. <span class="command"><strong>ip address</strong></span></h2></div></div></div><p>
        Part of the <span class="command"><strong>iproute2</strong></span> suite, <span class="command"><strong>ip
        address</strong></span> can
        <a class="link" href="#tools-ip-address-show" title="2.1. Displaying interface information with ip address show">list the IP addresses</a>
        affiliated with
        interfaces,
        <a class="link" href="#tools-ip-address-add" title="2.2. Using ip address add to configure IP address information">add IPs</a>,
        <a class="link" href="#tools-ip-address-del" title="2.3. Using ip address del to remove IP addresses from an interface">delete IPs</a>, and
        <a class="link" href="#tools-ip-address-flush" title="2.4. Removing all IP address information from an interface with ip address flush">remove all IPs on a given
        device</a>.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-address-show"></a>2.1. Displaying interface information with
            <span class="command"><strong>ip address show</strong></span></h3></div></div></div><p>
          The first thing you'll want to do is list the IPs on your machine.
          The <span class="command"><strong>ip address</strong></span> tool will display IP (and
          terse encapsulation information) when invoked with the
          <span class="command"><strong>show</strong></span> verb.  To specify that you wish to see the IP
          information for only one interface, you can add <span class="command"><strong>dev
          &lt;device-name&gt;</strong></span>
        </p><div class="example"><a name="ex-tools-ip-address-display"></a><p class="title"><b>Example C.6. Displaying IP information with <span class="command">ip address</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show</code></strong>
<code class="computeroutput">1: lo: &lt;LOOPBACK,UP&gt; mtu 16436 qdisc noqueue 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 brd 127.255.255.255 scope host lo
2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0</code>
<code class="prompt">[root@wan-gw]# </code><strong class="userinput"><code>ip address show wan0</code></strong>
<code class="computeroutput">8: wan0: &lt;POINTOPOINT,NOARP,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ppp 01:f4 peer 00:00
    inet 205.254.209.73 peer 205.254.209.74/32 scope global wan0</code>
<code class="prompt">[root@real-example]# </code><strong class="userinput"><code>ip address show ppp0</code></strong>
<code class="computeroutput">5: ppp0: &lt;POINTOPOINT,MULTICAST,NOARP,UP&gt; mtu 1492 qdisc htb qlen 3
    link/ppp 
    inet 67.38.163.197 peer 67.38.163.254/32 scope global ppp0</code>
          </pre></div></div><br class="example-break"><p>
          You should notice some similarity between the output of
          <span class="command"><strong>ip address</strong></span> and
          <a class="link" href="#tools-ifconfig-output" title="1.4. Reading ifconfig output"><span class="command"><strong>ifconfig</strong></span></a>.
          Each device is given an sequential number as an identifying number.
          This is merely a convenience, and should not be used to refer to
          devices.  The second field in an entry is the interface name (which
          usually corresponds to the device name).  Next, we see the familiar
          device <a class="link" href="#tb-tools-ifconfig-flags" title="Table C.1. Interface Flags">flags</a> and
          maximum transmission unit size.
        </p><p>
          The final fields in the first line of output for each device entry
          refer to the traffic control queueing discipline (qdisc) and the
          Ethernet buffer transmit queue length (qlen).  For more on
          understanding and using traffic control under linux, see
          <a class="ulink" href="http://lartc.org/howto/" target="_top">the LARTC documentation</a>.
        </p><p>
          The second line of output describes the link layer characteristics
          of the device.  For Ethernet devices, this will always say
          "link/ether" followed by the hardware address of the device and the
          media broadcast address.  For more detail on the link layer
          characteristics of a device see <a class="xref" href="#tools-ip-link" title="3. ip link">Section 3, &#8220;<span class="command"><strong>ip link</strong></span>&#8221;</a>.
        </p><p>
          Subsequent lines of output describe the IP addresses available on each
          interface.  In a typical installation only one address is used on
          each interface, although an arbitrary number of addresses can also be
          used on each interface.
        </p><p>
          Each line contains the IP address and netmask in CIDR notation, an
          optional broadcast address, scope information and a label.  Let's
          examine the scope and label first and then discuss IP addressing and
          broadcast calculation.  The possible values for scope are outlined in
          the following table.
        </p><div class="table"><a name="tb-tools-ip-addr-scope"></a><p class="title"><b>Table C.2. IP Scope under <span class="command">ip address</span></b></p><div class="table-contents"><table class="table" summary="IP Scope under ip address" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Scope</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">global</td><td align="center">valid everywhere</td></tr><tr><td align="center">site</td><td align="center">valid only within this site (IPv6)</td></tr><tr><td align="center">link</td><td align="center">valid only on this device</td></tr><tr><td align="center">host</td><td align="center">valid only inside this host (machine)</td></tr></tbody></table></div></div><br class="table-break"><p>
          Scope is normally determined by the <span class="command"><strong>ip</strong></span> utility
          without explicit use on the command line.  For example, an IP address
          in the 127.0.0.0/8 range falls in the range of localhost IPs, so
          should not be routed out any device.  This explains the presence of
          the <span class="command"><strong>host</strong></span> scope for addresses bound to interface
          <span class="command"><strong>lo</strong></span>.  Usually, addresses on other interfaces are
          public interfaces, which means that their scope will be global.  We
          will revisit scope again when we discuss routing with <span class="command"><strong>ip
          route</strong></span>, and there we will also encounter the link scope.
        </p><p>
          Now, let's examine IP addressing with the <span class="command"><strong>ip
          address</strong></span> utility by adding and removing IP addresses from
          active interfaces. 
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-address-add"></a>2.2. Using <span class="command"><strong>ip address add</strong></span> to configure
          IP address information</h3></div></div></div><p>
          If you need to host an additional IP address on
          <code class="systemitem">tristan</code>, here's how you
          would accomplish this task.
        </p><div class="example"><a name="ex-tools-ip-address-add"></a><p class="title"><b>Example C.7. Adding IP addresses to an interface with <span class="command">ip address</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address add 192.168.99.37/24 brd + dev eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0
    inet 192.168.99.37/24 brd 192.168.99.255 scope global secondary eth0</code>
          </pre></div></div><br class="example-break"><p>
          There are a few items of note.  You can use <span class="command"><strong>ip address
          add</strong></span> even if the link layer on the device is down.  This
          means that you can readdress an interface without bringing it up.
          When you add an address within the same CIDR network as another
          address on the same interface, the second address becomes a secondary
          address, meaning that if the first address is removed, the second
          address will also be purged from the interface.
        </p><p>
          In order to support compatibility with
          <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a> the
          <span class="command"><strong>ip address</strong></span> command allows the user to specify a
          label on every hosted address on a given device.  After adding an
          address to an interface as we did in
          <a class="xref" href="#ex-tools-ip-address-add" title="Example C.7. Adding IP addresses to an interface with ip address">Example C.7, &#8220;Adding IP addresses to an interface with <span class="command">ip address</span>&#8221;</a>,
          <span class="command"><strong>ifconfig</strong></span> will not report that the new IP
          192.168.99.37 is hosted on the same device as the primary IP
          192.168.99.35.  In order to prevent this sort of confusion or apparently
          contradictory output, you should get in the habit of using the
          <span class="command"><strong>label</strong></span> option to identify each IP hosted on a
          device.  Let's take a look at how to remove the 192.168.99.37 IP from
          eth0 and add it back so that <span class="command"><strong>ifconfig</strong></span> will report
          the presence of another IP on the eth0 device.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-address-del"></a>2.3. Using <span class="command"><strong>ip address del</strong></span> to remove IP addresses
          from an interface</h3></div></div></div><p>
          There is a difference between IPs considered as primary addresses on
          an interface and secondary addresses.  If in the output, an address
          is listed as a secondary address, removing the primary address will
          also remove the secondary address.
        </p><p>
          A workaround is to set the netmask on the second address added to
          the interface to /32.  Unfortunately, this subterfuge will prevent
          the kernel from entering the correct corresponding network and
          broadcast routes.
        </p><div class="example"><a name="ex-tools-ip-address-del"></a><p class="title"><b>Example C.8. Removing IP addresses from interfaces with <span class="command">ip address</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address del 192.168.99.37/24 brd + dev eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address add 192.168.99.37/24 brd + dev eth0 label eth0:0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0
    inet 192.168.99.37/24 brd 192.168.99.255 scope global secondary eth0:0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ifconfig</code></strong>
<code class="computeroutput">eth0      Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51
          inet addr:192.168.99.35  Bcast:192.168.99.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:190312 errors:0 dropped:0 overruns:0 frame:0
          TX packets:86955 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:100 
          RX bytes:30701229 (29.2 Mb)  TX bytes:7878951 (7.5 Mb)
          Interrupt:9 Base address:0x5000 

eth0:0    Link encap:Ethernet  HWaddr 00:80:C8:F8:4A:51  
          inet addr:10.10.20.10  Bcast:10.10.20.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          Interrupt:9 Base address:0x1000

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:306 errors:0 dropped:0 overruns:0 frame:0
          TX packets:306 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:29504 (28.8 Kb)  TX bytes:29504 (28.8 Kb)</code>
          </pre></div></div><br class="example-break"><p>
          Taking the minor precaution of using <span class="command"><strong>label</strong></span>s on IP
          addresses added to an interface will prevent confusion if there are
          multiple administrators of a machine, some of whom use
          <span class="command"><strong>ifconfig</strong></span>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-address-flush"></a>2.4. Removing all IP address information from an interface
          with <span class="command"><strong>ip address flush</strong></span></h3></div></div></div><p>
          Finally, let's look at the use of <span class="command"><strong>ip address flush</strong></span>.
          If an interface has already had IP addresses assigned to it, and all
          of the addresses need to be removed (along with their routes), there
          is one handy command to accomplish all of these tasks.  <span class="command"><strong>ip
          address flush</strong></span> takes an interface name as an argument.
          Let's look at the output of <span class="command"><strong>ip address show</strong></span> just
          before and just after removing all IPs.
        </p><div class="example"><a name="ex-tools-ip-address-flush"></a><p class="title"><b>Example C.9. Removing all IPs on an interface with <span class="command">ip address flush</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.99.35/24 brd 192.168.99.255 scope global eth0
    inet 192.168.99.37/24 brd 192.168.99.255 scope global secondary eth0:0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address flush</code></strong>
<code class="computeroutput">Flush requires arguments.</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address flush dev eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip address show dev eth0</code></strong>
<code class="computeroutput">2: eth0: &lt;BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast qlen 100
    link/ether 00:80:c8:f8:4a:51 brd ff:ff:ff:ff:ff:ff</code>
          </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-address-conclusion"></a>2.5. Conclusion</h3></div></div></div><p>
          As you can see, the <span class="command"><strong>ip address</strong></span> utility provides a
          wealth of information and a great deal of control over the IPs
          associated with each device.  For more detailed information about
          the <span class="command"><strong>iproute2</strong></span> package and included tools, see
          <a class="xref" href="#links-iproute2" title="1.6. iproute2 documentation">Section 1.6, &#8220;iproute2 documentation&#8221;</a>.
        </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm4284" class="footnote"><p><a href="#idm4284" class="para"><sup class="para">[44] </sup></a>
          I'm sure somebody will be glad to nitpick here and tell me that
          s/he has a machine connected to the Internet which uses SNA,
          DecNET, IPX, or NetBEUI to connect to another host which actually
          <span class="emphasis"><em>does</em></span> speak IP, thus proving that not every host
          which has access to the Internet is actually directly speaking IP.
          Another example is doubtless, wireless devices, such as telephones.
          Here, I'll concern myself with the majority case.
        </p></div><div id="ftn.idm4367" class="footnote"><p><a href="#idm4367" class="para"><sup class="para">[45] </sup></a>
              If you need to change the hardware address of an Ethernet
              interface, you have a strange need, but you can accomplish this
              using the <a class="link" href="#tools-ip-link-set-address" title="3.7. Changing hardware or Ethernet broadcast address with ip link set"><span class="command"><strong>ip
              link set address</strong></span></a> command.
            </p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-ip-routing"></a>Appendix D. IP Route Management</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-route">1. <span class="command"><strong>route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-route-show">1.1. Displaying the routing table with <span class="command"><strong>route</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-output">1.2. Reading <span class="command"><strong>route</strong></span>'s output</a></span></dt><dt><span class="section"><a href="#tools-route-show-cache">1.3. Using <span class="command"><strong>route</strong></span> to display the routing cache</a></span></dt><dt><span class="section"><a href="#tools-route-add">1.4. Creating a static route with <span class="command"><strong>route add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-add-default">1.5. Creating a default route with <span class="command"><strong>route add default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-route-del">1.6. Removing routes with <span class="command"><strong>route del</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-route">2. <span class="command"><strong>ip route</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-route-show">2.1. Displaying a routing table with <span class="command"><strong>ip route
          show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-show-cache">2.2. Displaying the routing cache with <span class="command"><strong>ip route
          show cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add">2.3. Using <span class="command"><strong>ip route add</strong></span> to populate a routing
          table</a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-default">2.4. Adding a default route with <span class="command"><strong>ip route add
          default</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-add-nat">2.5. Setting up NAT with <span class="command"><strong>ip route add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-del">2.6. Removing routes with <span class="command"><strong>ip route del</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-change">2.7. Altering existing routes with <span class="command"><strong>ip route
          change</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-get">2.8. Programmatically fetching route information with <span class="command"><strong>ip
          route get</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush">2.9. Clearing routing tables with <span class="command"><strong>ip route
          flush</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-flush-cache">2.10. <span class="command"><strong>ip route flush cache</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-route-summary">2.11. Summary of the use of <span class="command"><strong>ip route</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-ip-rule">3. <span class="command"><strong>ip rule</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ip-rule-intro">3.1. <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-show">3.2. Displaying the RPDB with <span class="command"><strong>ip rule show</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add">3.3. Adding a rule to the RPDB with <span class="command"><strong>ip rule
          add</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-add-nat">3.4. <span class="command"><strong>ip rule add nat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ip-rule-del">3.5. <span class="command"><strong>ip rule del</strong></span></a></span></dt></dl></dd></dl></div><p>
      Routing and understanding routing in an IP network is one of the
      fundamentals you will need to grasp the flexibility of IP networking,
      and services which run on IP networks.  It is not enough to address the
      machines and mix yourself a dirty martini.  You'll need to verify that
      the machine has a route to any network with which it needs to exchange
      IP packets.
    </p><p>
      One key element to remember when designing networks, viewing routing
      tables, debugging networking problems, and viewing network traffic on
      the wire is that IP routing is stateless
      <a href="#ftn.idm4600" class="footnote" name="idm4600"><sup class="footnote">[46]</sup></a>.
      This means that every time a new packet hits the routing stage, the
      router makes an independent decision about where to send this
      packet.
    </p><p>
      In this section, we'll look at the tools available to manipulate and
      view the routing table(s).  We'll start with the well known <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a> command, and move
      on to the increasingly used <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip
      route</strong></span></a> and <a class="link" href="#tools-ip-rule" title="3. ip rule"><span class="command"><strong>ip
      rule</strong></span></a> tools which are part of the
      <span class="command"><strong>iproute2</strong></span> package.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-route"></a>1. <span class="command"><strong>route</strong></span></h2></div></div></div><p>
        In the same way that
        <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a> is
        the venerable utility for IP address management,
        <span class="command"><strong>route</strong></span> is a tremendously useful command for
        manipulating and displaying IP routing tables.
      </p><p>
        Here we'll look at several tasks you can perform with
        <span class="command"><strong>route</strong></span>.  You can <a class="link" href="#tools-route-show" title="1.1. Displaying the routing table with route">display routes</a>, <a class="link" href="#tools-route-add" title="1.4. Creating a static route with route add">add routes</a> (most importantly, the
        <a class="link" href="#tools-route-add-default" title="1.5. Creating a default route with route add default">default route</a>),
        <a class="link" href="#tools-route-del" title="1.6. Removing routes with route del">remove routes</a>, and <a class="link" href="#tools-route-show-cache" title="1.3. Using route to display the routing cache">examine the routing cache</a>.
        I will switch between traditional and CIDR notation for network
        addressing in this (and subsequent) sections, so the reader unaware of
        these notations is encouraged to refer liberally to the links provided
        in <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
      </p><p>
        When using <span class="command"><strong>route</strong></span> and <span class="command"><strong>ip route</strong></span> on
        the same machine, it is important to understand that not all routing
        table entries can be shown with <span class="command"><strong>route</strong></span>.  The key
        distinction is that <span class="command"><strong>route</strong></span> only displays
        information in the main routing table.  NAT routes, and routes in
        tables other than the main routing table must be managed and viewed
        separately with the <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip
        route</strong></span></a> tool.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-show"></a>1.1. Displaying the routing table with <span class="command"><strong>route</strong></span></h3></div></div></div><p>
          By far the simplest and most common task one performs with
          <span class="command"><strong>route</strong></span> is 
          viewing the routing table.  On a single-homed desktop like
          <code class="systemitem">tristan</code>, the routing
          table will be very simple, probably comprised of only a few routes.
          Compare this to a complex routing table on a host with multiple
          interfaces and static routes to internal networks, such as
          <code class="systemitem">masq-gw</code>.  It is by using
          the <span class="command"><strong>route</strong></span> command that you can determine where a
          packet goes when it leaves your machine.
        </p><div class="example"><a name="ex-tools-route-show-simple"></a><p class="title"><b>Example D.1. Viewing a simple routing table with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
          </pre></div></div><br class="example-break"><p>
          In the simplest routing tables, as in
          <code class="systemitem">tristan</code>'s case, you'll
          see three separate routes.  The route which is customarily present
          on all machines (and which I'll not remark on after this) is the
          route to the loopback interface.  The loopback interface is an IP
          interface completely local to the host itself.  Most commonly,
          loopback is configured as a single IP address in a class A-sized
          network.  This entire network has been set aside for use on loopback
          devices.  The address used is usually 127.0.0.1/8, and the device
          name under all default installations of linux I have seen is
          <span class="command"><strong>lo</strong></span>.  It is not at all unheard of for people to
          host services on loopback which are intended only for consumption on
          that machine, e.g., SMTP on tcp/25.
        </p><p>
          The remaining two lines define how 
          <code class="systemitem">tristan</code> should reach any
          other IP address anywhere on the Internet.  These two routing table
          entries divide the world into two different categories: a locally
          reachable network (192.168.99.0/24) and everything else.  If an
          address falls within the 192.168.99.0/24 range, 
          <code class="systemitem">tristan</code> knows it can
          reach the IP range directly on the wire, so any packets bound for
          this range will be pushed out onto the local media.
        </p><p>
          If the packet falls in any other range
          <code class="systemitem">tristan</code> will consult its
          routing table and find no single route that matches.  In this case,
          the default route functions as a terminal choice.  If no other route
          matches, the packet will be forwarded to this destination address,
          which is usually a router to another set of networks and routers
          (which eventually lead to the Internet).
        </p><p>
          Viewing a complex routing table is no more difficult than viewing a
          simple routing table, although it can be a bit more diffiult to
          read, interpret, and sometimes even find the route you wish to
          examine.
        </p><div class="example"><a name="ex-tools-route-show-complex"></a><p class="title"><b>Example D.2. Viewing a complex routing table with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.100.0   0.0.0.0         255.255.255.252 U     0      0        0 eth3
205.254.211.0   0.0.0.0         255.255.255.0   U     0      0        0 eth1
192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth2
192.168.98.0    192.168.99.1    255.255.255.0   UG    0      0        0 eth2
10.38.0.0       192.168.100.1   255.255.0.0     UG    0      0        0 eth3
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         205.254.211.254 0.0.0.0         UG    0      0        0 eth1</code>
          </pre></div></div><br class="example-break"><p>
          The above routing table shows a more complex set of static routes
          than one finds on a single-homed host.  By comparing the network
          mask of the routes above, we can see that the network mask is listed
          from the most specific to the least specific.  Refer to
          <a class="xref" href="#routing-selection" title="5. Route Selection">Section 5, &#8220;Route Selection&#8221;</a> for more discussion.
        </p><p>
          A quick glance down this routing table also provides us with a good
          deal of knowledge about the topology of the network.  Immediately we
          can identify four separate Ethernet interfaces, 3 locally connected
          class C sized networks, and one tiny subnet (192.168.100.0/30).  We
          can also determine that there are two networks reachable via static
          routes behind internal routers.
        </p><p>
          Now that we have taken a quick glance at the output from the route
          command, let's examine a bit more systematically what it's reporting
          to us.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-output"></a>1.2. Reading <span class="command"><strong>route</strong></span>'s output</h3></div></div></div><p>
          For this discussion refer to the network map in the appendix, and
          also to <a class="xref" href="#ex-tools-route-show-complex" title="Example D.2. Viewing a complex routing table with route">Example D.2, &#8220;Viewing a complex routing table with <span class="command">route</span>&#8221;</a>.
          <span class="command"><strong>route</strong></span> is a venerable command, one which can
          manipulate routing tables for protocols other than IP.  If you wish
          to know what other protocols are supported, try <strong class="userinput"><code>route
          --help</code></strong> at your leisure.  Fortunately,
          <span class="command"><strong>route</strong></span> defaults to inet (IPv4) routes if no other
          address family is specified.
        </p><p>
          By combining the values in columns one and three you can determine
          the destination network or host address.  The first line in 
          <code class="systemitem">masq-gw</code>'s routing table
          shows 192.168.100.0/255.255.255.252, which is more conveniently
          written in CIDR notation as 192.168.100.0/30.  This is the smallest
          possible network according to <a class="ulink" href="http://www.isi.edu/in-notes/rfc1878.txt" target="_top">RFC 1878</a>.  The
          only two useable addresses are 192.168.100.1 
          (<code class="systemitem">service-router</code>)
          and 192.168.100.2
          (<code class="systemitem">masq-gw</code>).
        </p><p>
          The second column holds the IP address of the gateway to the
          destination if the destination is not a locally connected network.
          If there is a value other than 0.0.0.0 in this field, the kernel
          will address the outbound packet for this device (a router of some
          kind) rather than directly for the destination.  The column after
          the netmask column (Flags) should always contain a
          <span class="command"><strong>G</strong></span> for destination not locally connected to the
          linux machine.
        </p><p>
          The fields Metric, Ref and Use are not generally used in simple or
          even moderately complex routing tables, however, we will discuss the
          Use column further in <a class="xref" href="#tools-route-show-cache" title="1.3. Using route to display the routing cache">Section 1.3, &#8220;Using <span class="command"><strong>route</strong></span> to display the routing cache&#8221;</a>.
        </p><p>
          The final field in the <span class="command"><strong>route</strong></span> output contains the
          name of the interface through which the destination is reachable.
          This can be any interface known to the kernel which has an IP
          address.  In <a class="xref" href="#ex-tools-route-show-complex" title="Example D.2. Viewing a complex routing table with route">Example D.2, &#8220;Viewing a complex routing table with <span class="command">route</span>&#8221;</a> we can
          learn immediately that 192.168.98.0/24 is reachable through
          interface <code class="constant">eth2</code>.
        </p><p>
          After this brief examination of the commonest of output from
          <span class="command"><strong>route</strong></span>, let's look at some of the other things we
          can learn from <span class="command"><strong>route</strong></span> and also how we can change
          the routing table.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-show-cache"></a>1.3. Using <span class="command"><strong>route</strong></span> to display the routing cache</h3></div></div></div><p>
          The routing cache is used by the kernel as a lookup table analogous
          to a quick reference card.  It's faster for the kernel to refer to
          the cache (internally implemented as a hash table) for a recently
          used route than to lookup the destination address again.  Routes
          existing in the route cache are periodically expired.  If you need
          to clean out the routing cache entirely, you'll want to become
          familiar with <a class="link" href="#tools-ip-route-flush" title="2.9. Clearing routing tables with ip route flush"><span class="command"><strong>ip
          route flush cache</strong></span></a>.
        </p><p>
          At first, it might surprise you to learn that there are no entries
          for locally connected networks in a routing cache.  After a bit of
          reflection, you come to realize that there is on need to cache an IP
          route for a locally connected network because the machine is
          connected to the same Ethernet.  So, any given destination has an
          entry in either the arp table or in the routing cache.  For a
          clearer picture of the differences between each of the cached
          routse, I'd suggest adding a <code class="option">-e</code> switch.
        </p><div class="example"><a name="ex-tools-route-show-cache"></a><p class="title"><b>Example D.3. Viewing the routing cache with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -Cen</code></strong>
<code class="computeroutput">Kernel IP routing cache
Source          Destination     Gateway         Flags   MSS Window  irtt Iface
194.52.197.133  192.168.99.35   192.168.99.35     l      40 0          0 lo
192.168.99.35   194.52.197.133  192.168.99.254         1500 0         29 eth0
192.168.99.35   192.168.99.254  192.168.99.254         1500 0          0 eth0
192.168.99.254  192.168.99.35   192.168.99.35     il     40 0          0 lo
192.168.99.35   192.168.99.35   192.168.99.35     l   16436 0          0 lo
192.168.99.35   194.52.197.133  192.168.99.254         1500 0          0 eth0
192.168.99.35   192.168.99.254  192.168.99.254         1500 0          0 eth0</code>
          </pre></div></div><br class="example-break"><p>
          FIXME!  I don't really know why there are three entries in the routing
          cache for each destination.  Here, for example, we see three entries
          in the routing cache for 194.52.197.133 (a Swedish destination).
        </p><p>
          The MSS column tells us what the path MTU discovery has determined
          for a maximum segment size for the route to this destination.  By
          discovering the proper segment size for a route and caching this
          information, we can make most efficient use of bandwidth to the
          destination, without incurring the overhead of packet fragmentation
          enroute.  See <a class="xref" href="#routing-icmp-mtu" title="10.1. MTU, MSS, and ICMP">Section 10.1, &#8220;MTU, MSS, and ICMP&#8221;</a> for a more complete
          discussion of MSS and MTU.
        </p><p>
          FIXME!  There has to be more we can say about the routing cache
          here.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-add"></a>1.4. Creating a static route with <span class="command"><strong>route add</strong></span></h3></div></div></div><p>
          Static routes are explicit routes to non-local destinations through
          routers or gateways which are not the default gateway.  The case of
          the routing table on 
          <code class="systemitem">tristan</code> is a classic
          example of the need for a static route.  There are two routers in
          the same network, 
          <code class="systemitem">masq-gw</code> and
          <code class="systemitem">isdn-router</code>.  If 
          <code class="systemitem">tristan</code> has packets for
          the 192.168.98.0/24 network, they should be routed to 192.168.99.1
          (<code class="systemitem">isdn-router</code>).  Refer
          also to <a class="xref" href="#basic-changing-static" title="3.3. Adding and removing a static route">Section 3.3, &#8220;Adding and removing a static route&#8221;</a> for this example.
        </p><p>
          As with <a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a>,
          <span class="command"><strong>route</strong></span> has a syntax unlike most standard unix
          command line utilities, mixing options and arguments with less
          regularity.  Note the mandatory <code class="option">-net</code> or
          <code class="option">-host</code> options when adding or removing any route
          other than the default route.
        </p><p>
          In order to add a static route to the routing table, you'll need to
          gather several pieces of information about the remote network.
        </p><p>
          In our example network, 
          <code class="systemitem">masq-gw</code> can only reach
          10.38.0.0/16 through 
          <code class="systemitem">service-router</code>.  Let's
          add a static route to the masquerading firewall to ensure that
          10.38.0.0/16 is reachable.  Our intended routing table will look
          like the routing table in
          <a class="xref" href="#ex-tools-route-show-complex" title="Example D.2. Viewing a complex routing table with route">Example D.2, &#8220;Viewing a complex routing table with <span class="command">route</span>&#8221;</a>.
          Let's also view the output
          if we mistype the IP address of the default gateway and specify an
          address which is not a locally reachable address.
        </p><div class="example"><a name="ex-tools-route-add-net"></a><p class="title"><b>Example D.4. Adding a static route to a network <span class="command">route add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route add -net 10.38.0.0 netmask 255.255.0.0 gw 192.168.109.1</code></strong>
<code class="computeroutput">SIOCADDRT: Network is unreachable</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route add -net 10.38.0.0 netmask 255.255.0.0 gw 192.168.100.1</code></strong>
          </pre></div></div><br class="example-break"><p>
          It should be clear now that the gateway address must be reachable on
          a locally connected network for a static route to be useable (or
          even make sense).  In the first line, where we mistyped, the route
          could not be added to the routing table because the gateway address
          was not a reachable address.
        </p><p>
          Now, instead of sending packets with a destination of 10.38.0.0/16
          to the default gateway, 
          <code class="systemitem">wan-gw</code>,
          <code class="systemitem">masq-gw</code> will send this
          traffic to 
          <code class="systemitem">service-router</code> at IP
          address 192.168.100.1.
        </p><p>
          The above is a simple example of routing a network to a separate
          gateway, a gateway other than the default gateway.  This is a common
          need on networks central to an operation, and less common in branch
          offices and remote networks.
        </p><p>
          Occasionally, however, you'll have a single machine with an IP
          address in a different range on the same Ethernet as some other
          machines.  Or you might have a single machine which is reachable
          via a router.  Let's look at these two scenarios to see how we can
          create static routes to solve this routing need.
        </p><p>
          Occasionally, you may have a desire to restrict communication from
          one network to another by not including routes to the network.
          In our sample network, <code class="systemitem">tristan</code> may be a
          workstation of an employee who doesn't need to reach any machines in
          the branch office.  Perhaps this employee needs to periodically
          access some data or service supplied on 192.168.98.101.  We'll need
          to add a static route to allow this machine to access this single
          host IP in the branch office network
          <a href="#ftn.idm4750" class="footnote" name="idm4750"><sup class="footnote">[47]</sup></a>.
        </p><p>
          Here's a summary of the <a class="link" href="#basic-changing-static" title="3.3. Adding and removing a static route">required
          data</a> for our static route.  The destination is
          192.168.98.101/32 and the gateway is 192.168.99.1.
        </p><div class="example"><a name="ex-tools-route-add-host"></a><p class="title"><b>Example D.5. Adding a static route to a host with <span class="command">route add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route add -host 192.168.98.101 gw 192.168.99.1</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.98.101  192.168.99.1    255.255.255.255 UG    0      0        0 eth0
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
          </pre></div></div><br class="example-break"><p>
          Now, we have successfully altered the routing table to include a
          host route for the single machine we want our employee to be able to
          reach.
        </p><p>
          Even rarer, you may encounter a situation where a single Ethernet
          network is used to host multiple IP networks.  There are reasons
          people might do this, although I regard this is bad form.  If
          possible, it is cleaner, more secure, and easier to troubleshoot if
          you do not share IP networks on the same media segment.  With that
          said, you can still convince your linux box to be a part of each
          network
          <a href="#ftn.idm4768" class="footnote" name="idm4768"><sup class="footnote">[48]</sup></a>.
        </p><p>
          Let's assume for the sake of this example that NAT is not an option
          for us, and we need to move the machine 205.254.211.184 into another
          network.  Though it violates the concept of security partitioning,
          we have decided to put the server into the same network as
          <code class="systemitem">service-router</code>.
          Naturally, we'll need to modify the routing table on 
          <code class="systemitem">masq-gw</code>.
        </p><p>
          Be sure to refer to <a class="xref" href="#adv-proxy-arp" title="3. Breaking a network in two with proxy ARP">Section 3, &#8220;Breaking a network in two with proxy ARP&#8221;</a> for a
          complete discussion of this unusual networking scenario.
        </p><div class="example"><a name="ex-tools-route-add-host-dev"></a><p class="title"><b>Example D.6. Adding a static route to a host on the same media with <span class="command">route add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route add -host 205.254.211.184 dev eth3</code></strong>
          </pre></div></div><br class="example-break"><p>
          I'll leave as an exercise to the reader's imagination the question
          of how to send all traffic to a locally connected network to an
          interface.  In light of the host route above, it should be a logical
          step for the reader to make.
        </p><p>
          The above are common examples of the usage of the
          <span class="command"><strong>route</strong></span> command.
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-add-default"></a>1.5. Creating a default route with <span class="command"><strong>route add default</strong></span></h3></div></div></div><p>
          The default route is a special case of a static route.  Any machine
          which is connected to the Internet has a default route.  For the
          majority of smaller networks which are not running dynamic routing
          protocols, each machine on an internal network uses a router or
          firewall as its default gateway, forwarding all traffic to that
          destination.  Typically, this router or firewall forwards the
          traffic to the next router or device via a static route until the
          traffic reaches the ISP's service access router.  Many ISPs use
          dynamic routing internally to determine the best path out of their
          networks to remote destinations.
        </p><p>
          But we are only interested in adding a default route and
          understanding that packets are reaching the default gateway.  Once
          the packets have reached the default gateway, we assume that the
          administrator of that device is monitoring its correct operation.
        </p><p>
          With this bit of background about the default route, it is easy to
          see why a default route is a key part of any networking device's
          configuration.  If the machine is to reach machines other than the
          machines on the local network, it must know the address of the
          default gateway.
        </p><p>
          Because the default gateway is so important, there is particular
          support for adding a default route included in the
          <span class="command"><strong>route</strong></span> command.  Refer to
          <a class="xref" href="#ex-basic-set-default" title="Example 1.8. Adding a default route with route">Example 1.8, &#8220;Adding a default route with <span class="command">route</span>&#8221;</a> for a simple
          example of adding a
          default route.  The syntax of the command is as follows:
        </p><div class="example"><a name="ex-tools-route-add-default"></a><p class="title"><b>Example D.7. Setting the default route with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route add default gw 192.168.99.254</code></strong>
          </pre></div></div><br class="example-break"><p>
          This is the commonest method used for setting a default route,
          although the route can also be specified by the following command.
          I find the alternate method more explicit than the common method for
          setting default gateway, because the destination address and network
          mask are treated exactly like any other network address and netmask.
        </p><div class="example"><a name="ex-tools-route-add-default-alt"></a><p class="title"><b>Example D.8. An alternate method of setting the default route with <span class="command">route</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route add -net 0.0.0.0 netmask 0.0.0.0 gw 192.168.99.254</code></strong>
          </pre></div></div><br class="example-break"><p>
          The alternate method of setting a default route specifies a network
          and netmask of 0, which is shorthand for all destinations.  I'll
          reiterate that the kernel sees these two methods of setting the
          default route as identical.  The resulting routing table is exactly
          the same.  You may select whichever of these
          <span class="command"><strong>route</strong></span> invocations you find more comfortable.
        </p><p>
          Now that we have covered adding static routes and the special static
          route, the default route, let's try our hand at removing existing
          routes from routing tables.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-route-del"></a>1.6. Removing routes with <span class="command"><strong>route del</strong></span></h3></div></div></div><p>
          Any route can be removed from the routing table as easily as it can
          be added.  The syntax of the command is exactly the same as the
          syntax of the <span class="command"><strong>route add</strong></span> command.
        </p><p>
          After we went to all of the trouble above to put our machine
          205.254.211.184 into the network with
          <code class="systemitem">service-router</code>, we
          probably realize that from a security partitioning standpoint, it is
          not only stupid, but also foolhardy!  So now, we conclude that we
          need to return 205.254.211.184 to its former network (the DMZ
          proper).  We'll now remove the special host route for its IP, so the
          network route for 205.254.211.0/24 will now be used for reaching
          this host.  (If you have questions about why, read
          <a class="xref" href="#routing-selection" title="5. Route Selection">Section 5, &#8220;Route Selection&#8221;</a>.)
        </p><div class="example"><a name="ex-tools-route-del-host-dev"></a><p class="title"><b>Example D.9. Removing a static host route with <span class="command">route del</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
205.254.211.184 0.0.0.0         255.255.255.255 U     0      0        0 eth3
192.168.100.0   0.0.0.0         255.255.255.252 U     0      0        0 eth3
205.254.211.0   0.0.0.0         255.255.255.0   U     0      0        0 eth1
192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth2
192.168.98.0    192.168.99.1    255.255.255.0   UG    0      0        0 eth2
10.38.0.0       192.168.100.1   255.255.0.0     UG    0      0        0 eth3
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         205.254.211.254 0.0.0.0         UG    0      0        0 eth1</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>route del -host 205.254.211.184 dev eth3</code></strong>
          </pre></div></div><br class="example-break"><p>
          Another possible example might be the prohibition of Internet
          traffic to a particular user.  If a machine does not have a default
          route, but instead has a routing table populated only with routes to
          internal networks, then that machine can only reach IP addresses in
          networks to which it has a routing table entry.  Let's say that you
          have a user who routinely spends work hours browsing the Internet,
          fetching mail from a POP account outside your network, and in short
          wastes time on the Internet.  You can easily prevent this user from
          reaching anything except your internal networks.  Naturally, this
          sort of a problem employee should probably face some sort of
          administrative sanction to address the real problem, but as a
          technical component of the strategy to prevent this user from
          wasting time on the Internet, you could remove access to the
          Internet from this employee's machine.
        </p><p>
          In the below example, we'll use the <span class="command"><strong>route</strong></span> command
          a number of times for different operations, all of which you should
          be familiar with by now.
        </p><div class="example"><a name="ex-tools-route-del-default"></a><p class="title"><b>Example D.10. Removing the default route with <span class="command">route del</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.98.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.98.254  0.0.0.0         UG    0      0        0 eth0</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route del default gw 192.168.98.254</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -net 192.168.99.0 netmask 255.255.255.0 gw 192.168.98.254</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -net 192.168.100.0 netmask 255.255.255.0 gw 192.168.98.254</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route add -net 205.254.211.0 netmask 255.255.255.0 gw 192.168.98.254</code></strong>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
205.254.211.0   192.168.98.254  255.255.255.0   U     0      0        0 eth0
192.168.100.0   192.168.98.254  255.255.255.0   U     0      0        0 eth0
192.168.99.0    192.168.98.254  255.255.255.0   U     0      0        0 eth0
192.168.98.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo</code>
          </pre></div></div><br class="example-break"><p>
          Now, the user on <code class="systemitem">morgan</code>
          can only reach the specified networks.  The networks we have entered
          here are all of our corporate networks.  If the user tries to
          generate a packet to any other destination, the kernel is not going
          to know where to send it, so will return in error code to the
          application trying to make the network connection.
        </p><p>
          While this can be a very effective way to restrict access to an
          individual machine, it is an ineffective method of systems
          administration, since it requires that the user log in to the
          affected machine and make changes to the routing table on demand.  A
          better solution would be to use <a class="link" href="#pf-network" title="7. Protecting a Network">packet
          filter rules</a>.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ip-route"></a>2. <span class="command"><strong>ip route</strong></span></h2></div></div></div><p>
        Another part of the <span class="command"><strong>iproute2</strong></span> suite of tools for IP
        management, <span class="command"><strong>ip route</strong></span> provides management tools for
        manipulating any of the routing tables.  Operations
        include
        <a class="link" href="#tools-ip-route-show" title="2.1. Displaying a routing table with ip route show">displaying routes</a> or the
        <a class="link" href="#tools-ip-route-show-cache" title="2.2. Displaying the routing cache with ip route show cache">routing cache</a>,
        <a class="link" href="#tools-ip-route-add" title="2.3. Using ip route add to populate a routing table">adding routes</a>,
        <a class="link" href="#tools-ip-route-del" title="2.6. Removing routes with ip route del">deleting routes</a>,
        <a class="link" href="#tools-ip-route-change" title="2.7. Altering existing routes with ip route change">modifying existing routes</a>, and
        <a class="link" href="#tools-ip-route-get" title="2.8. Programmatically fetching route information with ip route get">fetching a route</a> and
        <a class="link" href="#tools-ip-route-flush" title="2.9. Clearing routing tables with ip route flush">clearing an entire routing table or
        the routing cache</a>.
      </p><p>
        One thing to keep in mind when using the <span class="command"><strong>ip route</strong></span>
        is that you can operate on any of the 255 routing tables with this
        command.  Where the <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a>
        command operated only on the main routing table (table 254), the
        <span class="command"><strong>ip route</strong></span> command operates by default on the main
        routing table, but can be easily coaxed into using other tables with
        the <code class="option">table</code> parameter.
      </p><p>
        Fortunately, as mentioned earlier, the <span class="command"><strong>iproute2</strong></span>
        suite of tools does not rely on DNS for any operation so, the
        ubiquitous <code class="option">-n</code> switch in previous examples will not be
        required in any example here.
      </p><p>
        All operations with the <span class="command"><strong>ip route</strong></span> command are
        atomic, so each command will return either <code class="computeroutput">RTNETLINK
        answers: No such process</code> in the case of an error, or
        nothing in the face of success.  The <code class="option">-s</code> switch which
        provides additional statistical information when reporting link layer
        information will only provide additional information when reporting on
        the state of the <a class="link" href="#tools-ip-route-show-cache" title="2.2. Displaying the routing cache with ip route show cache">routing
        cache</a> or <a class="link" href="#tools-ip-route-get" title="2.8. Programmatically fetching route information with ip route get">fetching a specific
        route</a>..
      </p><p>
        The <span class="command"><strong>ip route</strong></span> utility when used in conjunction with
        the <a class="link" href="#tools-ip-rule" title="3. ip rule"><span class="command"><strong>ip rule</strong></span></a>
        utility can create stateless NAT tables.  It can even manipulate the
        local routing table, a routing table used for traffic bound for
        broadcast addresses and IP addresses hosted on the machine itself.
      </p><p>
        In order to understand the context in which this tool runs, you need
        to understand some of the basics of IP routing, so if you have read
        the above introduction to the <span class="command"><strong>ip route</strong></span> tool, and
        are confused, you may want to read <a class="xref" href="#ch-routing" title="Chapter 4. IP Routing">Chapter 4, <i>IP Routing</i></a> and 
        grasp some of the concepts of IP routing (with linux) before
        continuing here. 
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-show"></a>2.1. Displaying a routing table with <span class="command"><strong>ip route
          show</strong></span></h3></div></div></div><p>
          In its simplest form, <span class="command"><strong>ip route</strong></span> can be used to
          display the main routing table output.  The output of this command
          is significantly different from the output of the <a class="link" href="#tools-route-show" title="1.1. Displaying the routing table with route"><span class="command"><strong>route</strong></span></a>.  For
          comparison, let's look at the output of both <span class="command"><strong>route
          -n</strong></span> and <span class="command"><strong>ip route show</strong></span>.
        </p><div class="example"><a name="ex-tools-ip-route-show-main"></a><p class="title"><b>Example D.11. Viewing the main routing table with <span class="command">ip route
            show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>route -n</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.99.0    0.0.0.0         255.255.255.0   U     0      0        0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
0.0.0.0         192.168.99.254  0.0.0.0         UG    0      0        0 eth0</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.99.0/24 dev eth0  scope link 
127.0.0.0/8 dev lo  scope link 
default via 192.168.99.254 dev eth0</code>
          </pre></div></div><br class="example-break"><p>
          If you are accustomed to the <span class="command"><strong>route</strong></span> output format,
          the <span class="command"><strong>ip route</strong></span> output can seem terse.  The
          same basic information is displayed, however.  As with our former
          example, let's ignore the 127.0.0.0/8 loopback route for the moment.
          This is a required route for any IPs hosted on the loopback
          interface.  We are far more interested in the other two routes.
        </p><p>
          The network 192.168.99.0/24 is available on eth0 with a scope of
          link, which means that the network is valid and reachable through
          this device (eth0).  Refer to <a class="xref" href="#tb-tools-ip-addr-scope" title="Table C.2. IP Scope under ip address">Table C.2, &#8220;IP Scope under <span class="command">ip address</span>&#8221;</a>
          for definitions of possible scopes.  As long as link remains good on
          that device, we should be able to reach any IP address inside of
          192.168.99.0/24 through the eth0 interface.
        </p><p>
          Finally, our all-important default route is expressed in the routing
          table with the word default.  Note that any destination which is
          reachable through a gateway appears in the routing table output with
          the keyword <code class="option">via</code>.  This final line matches
          semantically with the final line of output from <span class="command"><strong>route
          -n</strong></span> above.
        </p><p>
          Now, let's have a look at the local routing table, which we can't
          see with <span class="command"><strong>route</strong></span>.  To be fair, it is usually
          completely unnecessary to view and/or manipulate the local routing
          table, which is why <span class="command"><strong>route</strong></span> provides no way to
          access this information.
        </p><div class="example"><a name="ex-tools-ip-route-show-local"></a><p class="title"><b>Example D.12. Viewing the local routing table with <span class="command">ip route show
            table local</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show table local</code></strong>
<code class="computeroutput">local 192.168.99.35 dev eth0  proto kernel  scope host  src 192.168.99.35 
broadcast 127.255.255.255 dev lo  proto kernel  scope link  src 127.0.0.1 
broadcast 192.168.99.255 dev eth0  proto kernel  scope link  src 192.168.99.35 
broadcast 127.0.0.0 dev lo  proto kernel  scope link  src 127.0.0.1 
local 127.0.0.1 dev lo  proto kernel  scope host  src 127.0.0.1 
local 127.0.0.0/8 dev lo  proto kernel  scope host  src 127.0.0.1</code>
          </pre></div></div><br class="example-break"><p>
          This gives us a good deal of information about the IP networks to
          which the machine is directly connected, and an inside look into the 
          way that the routing tables treat special addresses like broadcast
          addresses and locally configured addresses.
        </p><p>
          The first field in this output tells us whether the route is for a
          broadcast address or an IP address or range locally hosted on this
          machine.  Subsequent fields inform us through which device the
          destination is reachable, and notably (in this table) that the
          kernel has added these routes as part of bringing up the IP layer
          interfaces.
        </p><p>
          For each IP hosted on the machine, it makes sense that the machine
          should restrict accessiblity to that IP or IP range to itself only.
          This explains why, in <a class="xref" href="#ex-tools-ip-route-show-local" title="Example D.12. Viewing the local routing table with ip route show table local">Example D.12, &#8220;Viewing the local routing table with <span class="command">ip route show
            table local</span>&#8221;</a>,
          192.168.99.35 has a host scope.  Because <code class="systemitem">tristan</code> hosts this IP, there's no
          reason for the packet to be routed off the box.  Similarly, a
          destination of localhost (127.0.0.1) does not need to be forwarded
          off this machine.  In each of these cases, the scope has been set to
          host.
        </p><p>
          For broadcast addresses, which are intended for any listeners who
          happen to share the IP network, the destination only makes sense as
          for a scope of devices connected to the same link layer
          <a href="#ftn.idm4932" class="footnote" name="idm4932"><sup class="footnote">[49]</sup></a>.
        </p><p>
          The final characteristic available to us in each line of the local
          routing table output is the <code class="option">src</code> keyword.  This is
          treated as a hint to the kernel about what IP address to select for
          a source address on outgoing packets on this interface.  Naturally,
          this is most commonly used (and abused) on multi-homed hosts,
          although almost every machine out there uses this hint for
          connections to localhost
          <a href="#ftn.idm4936" class="footnote" name="idm4936"><sup class="footnote">[50]</sup></a>.
        </p><p>
          Now that we have inspected the main routing table and the local
          routing table, let's see how easy it is to look at any one of the
          other routing tables.  This is as simple as specifying the table by
          its name in <code class="filename">/etc/iproute2/rt_tables</code> or by
          number.  There are a few reserved table identifiers in this file,
          but the other table numbers between 1 and 252 are available for the
          user.  Please note that this example is for demonstration only and
          has no intrinsic value other than showing the use of the
          <code class="option">table</code> parameter.
        </p><div class="example"><a name="ex-tools-ip-route-show-table"></a><p class="title"><b>Example D.13. Viewing a routing table with <span class="command">ip route
            show table</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show table special</code></strong>
<code class="computeroutput">Error: argument "special" is wrong: table id value is invalid
</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>echo 7 special &gt;&gt; /etc/iproute2/rt_tables</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show table special</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route add table special default via 192.168.99.254</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show table special</code></strong>
<code class="computeroutput">default via 192.168.99.254 dev eth0</code>
          </pre></div></div><br class="example-break"><p>
          In the above example you get a first glance at how to add a route to
          a table other than the main routing table, but what we are really
          interested in is the final command and output.  In
          <a class="xref" href="#ex-tools-ip-route-show-table" title="Example D.13. Viewing a routing table with ip route show table">Example D.13, &#8220;Viewing a routing table with <span class="command">ip route
            show table</span>&#8221;</a>, we have identified table 7
          by the name "special" and have added a route to this table.  The
          command <strong class="userinput"><code>ip route show table special</code></strong> shows us
          routing table number 7 from the kernel.
        </p><p>
          <span class="command"><strong>ip route</strong></span> consults
          <code class="filename">/etc/iproute2/rt_tables</code> for a table identifier.
          If it finds no identifier, it complains that it cannot find a
          reference to such a table.  If a table identifier is found, then the
          corresponding routing table is displayed.
        </p><p>
          The use of multiple routing tables can make a router very complex,
          very quickly.  Using names instead of numbers for these tables can
          assist in the management of this complexity.  For further discussion
          on managing multiple routing tables and some issues of handling
          them see <a class="xref" href="#adv-rpdb" title="3. Using the Routing Policy Database and Multiple Routing Tables">Section 3, &#8220;Using the Routing Policy Database and Multiple Routing
      Tables&#8221;</a>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-show-cache"></a>2.2. Displaying the routing cache with <span class="command"><strong>ip route
          show cache</strong></span></h3></div></div></div><p>
          The routing cache is used by the kernel as a lookup table analogous
          to a quick reference card.  It's faster for the kernel to refer to
          the cache (internally implemented as a hash table) for a recently
          used route than to lookup the destination address again.  Routes
          existing in the route cache are periodically expired.
        </p><p>
          The routing cache can be displayed in all its glory with <span class="command"><strong>ip
          route show cache</strong></span>, which provides a detailed view of recent
          destination IP addresses and salient characteristics about those
          destinations.  On routers, masquerading boxen and firewalls, the
          routing cache can become very large.  Instead of viewing the entire
          routing cache even on a workstation, we'll select a particular
          destination from the routing cache to examine.
        </p><div class="example"><a name="ex-tools-ip-route-show-cache"></a><p class="title"><b>Example D.14. Displaying the routing cache with <span class="command">ip route
            show cache</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show cache 192.168.100.17</code></strong>
<code class="computeroutput">192.168.100.17 from 192.168.99.35 via 192.168.99.254 dev eth0 
    cache  mtu 1500 rtt 18ms rttvar 15ms cwnd 15 advmss 1460
192.168.100.17 via 192.168.99.254 dev eth0  src 192.168.99.35 
    cache  mtu 1500 advmss 1460</code>
          </pre></div></div><br class="example-break"><p>
          FIXME!  I don't know how to explain rtt, rttvar, and cwnd, even
          after reading Alexey's comments in the iproute2 documentation!
          Not only that, I'm not sure why there are two entries!
        </p><p>
          The output in <a class="xref" href="#ex-tools-ip-route-show-cache" title="Example D.14. Displaying the routing cache with ip route show cache">Example D.14, &#8220;Displaying the routing cache with <span class="command">ip route
            show cache</span>&#8221;</a>
          summarizes the reachability of the destination 192.168.100.17 from
          192.168.99.35.  The first line of each entry provides some important
          information for us:  the destination IP, the source IP, the gateway
          through which the destination is reachable, and the interface
          through which packets were routed.  Together, these data
          identify a route entry in the cache.
        </p><p>
          Characteristics of that route
          are summarized in the second line of each entry.  For the route
          between <code class="systemitem">tristan</code> and
          <code class="systemitem">isolde</code>, we see that Path
          MTU discovery has identified 1500 bytes as the maximum packet size
          from end to end.  The maximum segment size (MSS) of data is 1460
          bytes.  Although this is not usually of any but the most casual of
          interest, it can be helpful diagnostic information.
        </p><p>
          If you are a die-hard fan of statistics, and can't get enough
          information about the routing on your machine, you can always
          throw the <code class="option">-s</code> switch.
        </p><div class="example"><a name="ex-tools-ip-route-show-cache-stats"></a><p class="title"><b>Example D.15. Displaying statistics from the routing cache with
            <span class="command">ip -s route show cache</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip -s route show cache 192.168.100.17</code></strong>
<code class="computeroutput">192.168.100.17 from 192.168.99.35 via 192.168.99.254 dev eth0 
    cache  users 1 used 326 age 12sec mtu 1500 rtt 72ms rttvar 22ms cwnd 2 advmss 1460
192.168.100.17 via 192.168.99.254 dev eth0  src 192.168.99.35 
    cache  users 1 used 326 age 12sec mtu 1500 advmss 1460</code>
          </pre></div></div><br class="example-break"><p>
          With this output, you'll get just a bit more information about the
          routes.  The most interesting datum is usually the "used" field,
          which indicates the number of times this route has been accessed in
          the routing cache.  This can give you a very good idea of how many
          times a particular route has been used.  The age field is used by
          the kernel to decide when to expire a cache entry.  The age is reset
          every time the route is accessed
          <a href="#ftn.idm4994" class="footnote" name="idm4994"><sup class="footnote">[51]</sup></a>.
        </p><p>
          In sum, you can use the routing cache to learn a good deal about
          remote IP destinations and some of the characteristics of the
          network path to those destinations.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-add"></a>2.3. Using <span class="command"><strong>ip route add</strong></span> to populate a routing
          table</h3></div></div></div><p>
          <span class="command"><strong>ip route add</strong></span> is a used to populate a
          routing table.  Although you can use <a class="link" href="#tools-route-add" title="1.4. Creating a static route with route add"><span class="command"><strong>route add</strong></span></a> to do
          the same thing, <span class="command"><strong>ip route add</strong></span> offers a large
          number of options that are not possible with the venerable
          <span class="command"><strong>route</strong></span> command.
          After we have looked at some simple examples, we'll discuss more
          complex routes with <span class="command"><strong>ip route</strong></span>.
        </p><p>
          In <a class="xref" href="#tools-route" title="1. route">Section 1, &#8220;<span class="command"><strong>route</strong></span>&#8221;</a>, we used two classic examples of
          adding a network route (to our service provider's network from )
          and a host route.  Let's look at the
          difference in syntax with the <span class="command"><strong>ip route</strong></span> command.
        </p><div class="example"><a name="ex-tools-ip-route-add-net"></a><p class="title"><b>Example D.16. Adding a static route to a network with <span class="command">route
            add</span>, cf. <a class="xref" href="#ex-tools-route-add-net" title="Example D.4. Adding a static route to a network route add">Example D.4, &#8220;Adding a static route to a network <span class="command">route add</span>&#8221;</a></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add 10.38.0.0/16 via 192.168.100.1</code></strong>
          </pre></div></div><br class="example-break"><p>
          This is one of the simplest examples of the syntax of the
          <span class="command"><strong>ip route</strong></span>.  As you may recall, you can only add a
          route to a destination network through a gateway that is itself
          already reachable.  In this case,
          <code class="systemitem">masq-gw</code> already knows a
          route to 192.168.100.1
          (<code class="systemitem">service-router</code>).  Now
          any packets bound for 10.38.0.0/16 will be forwarded to
          192.168.100.1.
        </p><p>
          Other interesting examples of this command involve the use of
          <code class="option">prohibit</code> and <code class="option">from</code>.  Use of the
          <code class="option">prohibit</code> will cause the router to report that the
          requested destination is unreachable.  If you know a netblock that
          hosts a service you are not interested in allowing your users to
          access, this is an effective way to block the outbound connection
          attempts.
        </p><p>
          Let's look at an example of <a class="link" href="#tools-tcpdump" title="5. tcpdump"><span class="command"><strong>tcpdump</strong></span></a> output
          which shows the <code class="option">prohibit</code> route in action.
        </p><div class="example"><a name="ex-tools-ip-route-add-prohibit"></a><p class="title"><b>Example D.17. Adding a <code class="option">prohibit</code> route with <span class="command">route
            add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add prohibit 209.10.26.51</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ssh 209.10.26.51</code></strong>
<code class="computeroutput">ssh: connect to address 209.10.26.51 port 22: No route to host</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>tcpdump -nnq -i eth2</code></strong>
<code class="computeroutput">tcpdump: listening on eth2
22:13:13.740406 192.168.99.35.51973 &gt; 209.10.26.51.22: tcp 0 (DF)
22:13:13.740714 192.168.99.254 &gt; 192.168.99.35: icmp: host 209.10.26.51 unreachable - admin prohibited filter [tos 0xc0]</code>
          </pre></div></div><br class="example-break"><p>
          Compare the ICMP packet returned to the sender in this case with the
          <a class="link" href="#ex-pf-iptables-reject" title="Example 7.1. Blocking a destination and using the REJECT target, cf. Example D.17, &#8220;Adding a prohibit route with route add&#8221;">ICMP packet returned</a> if
          you used <span class="command"><strong>iptables</strong></span> and the <code class="option">REJECT</code>
          target
          <a href="#ftn.idm5051" class="footnote" name="idm5051"><sup class="footnote">[52]</sup></a>.
          Although the net effect is identical (the user is unable
          to reach the intended destinatioan), the user gets two different
          error messages.  With an <span class="command"><strong>iptables</strong></span>
          <code class="option">REJECT</code>, the user sees <code class="computeroutput">Connection
          refused</code>, where the user sees <code class="computeroutput">No
          route to host</code> with the use of
          <code class="option">prohibit</code>.  These are but two of the options for
          controlling outbound access from your network.
        </p><p>
          Supposing you don't want to block access to this particular host for
          all of your users, the <code class="option">from</code> option comes to your
          aid.
        </p><div class="example"><a name="ex-tools-ip-route-add-from"></a><p class="title"><b>Example D.18. Using <code class="option">from</code> in a routing command with
            <span class="command">route add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add prohibit 209.10.26.51 from 192.168.99.35</code></strong>
          </pre></div></div><br class="example-break"><p>
          Now, you have effectively blocked the source IP 192.168.99.35 from
          reaching 209.10.26.51.  Any packets matching this source and
          destination address will match this route.  In this case,
          <code class="systemitem">masq-gw</code> will generate an
          ICMP error message indicating that the destination is
          administratively unreachable.
        </p><p>
          If you are still following along here, you can see that the options
          for identifying particular routes are many and multi-faceted.  The
          <code class="option">src</code> option provides a hint to the kernel for source
          address selection.  When you are working with multiple routing
          tables and different classes of traffic, you can ease your
          administrative burden, by hosting several
          different IPs on your linux machine and setting the source address
          differently, depending on the type of traffic.
        </p><p>
          In the example below, let's assume that our masquerading host also
          runs a DNS resolver for the internal network and we have selected
          all of the outbound DNS packets to be routed according to table 7
          <a href="#ftn.idm5074" class="footnote" name="idm5074"><sup class="footnote">[53]</sup></a>.
          Now, any packet which originates on this box (or is masqueraded
          through this table) will have its source IP set to 205.254.211.198.
        </p><div class="example"><a name="ex-tools-ip-route-add-src"></a><p class="title"><b>Example D.19. Using <code class="option">src</code> in a routing command with
            <span class="command">route add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add default via 205.254.211.254 src 205.254.211.198 table 7</code></strong>
          </pre></div></div><br class="example-break"><p>
          FIXME!!  I have nothing to say about <code class="option">nexthop</code> yet,
          because I have never used it, this goes for
          <code class="option">equalize</code> and <code class="option">onlink</code> as well.  If
          anybody has some examples s/he would like to contribute, I'd love to
          hear.
        </p><p>
          There are other options to the <span class="command"><strong>ip route add</strong></span>
          documented in Alexey's thorough <span class="command"><strong>iproute2</strong></span>
          documentation.  For further research, I'd suggested acquiring and
          reading this manual.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-add-default"></a>2.4. Adding a default route with <span class="command"><strong>ip route add
          default</strong></span></h3></div></div></div><p>
          Naturally, one of the most important routes on a machine is its
          default route.  Adding a default route is one of the simplest
          operations with <span class="command"><strong>ip route</strong></span>.
        </p><p>
          We need exactly one piece of information in order to set the default
          route on a machine.  This is the IP address of the gateway.  The
          syntax of the command is extremely simple and aside from the use of
          the <code class="option">via</code> instead of <code class="option">gw</code>, it is
          almost the same command as the equivalent <span class="command"><strong>route
          -n</strong></span>.
        </p><div class="example"><a name="ex-tools-ip-route-add-default"></a><p class="title"><b>Example D.20. Setting the default route with <span class="command">ip route add default</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route add default via 192.168.99.254</code></strong>
          </pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-add-nat"></a>2.5. Setting up NAT with <span class="command"><strong>ip route add nat</strong></span></h3></div></div></div><p>
          Be sure to see <a class="xref" href="#ch-nat" title="Chapter 5. Network Address Translation (NAT)">Chapter 5, <i>Network Address Translation (NAT)</i></a> for a full treatment of the
          issues involved in network address translation (NAT).  If you are
          here to learn a bit more about how to set up NAT in your network,
          then you should know that the <span class="command"><strong>ip route add nat</strong></span> is
          only half of the solution.  You must understand that performing NAT
          with <span class="command"><strong>iproute2</strong></span> involves one component to rewrite
          the inbound packet (<span class="command"><strong>ip route add nat</strong></span>), and
          another command to rewrite the outbound packet (<a class="link" href="#tools-ip-rule-add-nat" title="3.4. ip rule add nat"><span class="command"><strong>ip rule add
          nat</strong></span></a>).  If you only get half of the system in place,
          your NAT will only work halfway--or not at all, depending on how you
          define "work".
        </p><p>
          Alexey documents clearly in the appendix to the
          <span class="command"><strong>iproute2</strong></span> manual that the NAT provided by the
          <span class="command"><strong>iproute2</strong></span> suite is stateless.  This is distinctly
          unlike NAT with netfilter.  Refer to <a class="xref" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">Section 5, &#8220;Destination NAT with netfilter (DNAT)&#8221;</a> and
          <a class="xref" href="#state-conntrack" title="3. Netfilter Connection Tracking">Section 3, &#8220;Netfilter Connection Tracking&#8221;</a>
          for a better look at the connection tracking and network address
          translation support available under netfilter.
        </p><p>
          The <span class="command"><strong>ip route add nat</strong></span> command is used to rewrite
          the destination address of a packet from one IP or range to another
          IP or range.  The <span class="command"><strong>iproute2</strong></span> tools can only operate
          on the entire IP packet.  There is no provision directly within the
          <span class="command"><strong>iproute2</strong></span> suite to support conditional rewriting
          based on the destination port of a UDP datagram or TCP segment.
          It's the whole packet, every packet, and nothing but the packet
          <a href="#ftn.idm5125" class="footnote" name="idm5125"><sup class="footnote">[54]</sup></a>.
        </p><div class="example"><a name="ex-tools-ip-route-nat-simple"></a><p class="title"><b>Example D.21. Creating a NAT route for a single IP with <span class="command">ip route add
            nat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add nat 205.254.211.17 via 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table local | grep ^nat</code></strong>
<code class="computeroutput">nat 205.254.211.17 via 192.168.100.17  scope host</code>
          </pre></div></div><br class="example-break"><p>
          The route entry we have just made tells the kernel to rewrite any
          inbound packet bound for 205.254.211.17 to 192.168.100.17.  The
          actual rewriting of the packet occurs at the routing stage of the
          packets trip through the kernel.  This is an important detail,
          illuminated more fully in
          <a class="xref" href="#nat-stateless-pf-interaction" title="4. Stateless NAT and Packet Filtering">Section 4, &#8220;Stateless NAT and Packet Filtering&#8221;</a>.
        </p><p>
          Not only can <span class="command"><strong>iproute2</strong></span> support network address
          translation for single IPs, but also for entire network ranges.  The
          syntax is substantially similar to the syntax above, but uses a
          CIDR network address instead of a single IP.
        </p><div class="example"><a name="ex-tools-ip-route-nat-network"></a><p class="title"><b>Example D.22. Creating a NAT route for an entire network with <span class="command">ip
            route add nat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add nat 205.254.211.32/29 via 192.168.100.32</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show table local | grep ^nat</code></strong>
<code class="computeroutput">nat 205.254.211.32/29 via 192.168.100.32  scope host</code>
          </pre></div></div><br class="example-break"><p>
          In this example, we are adding a route for an entire network.  Any
          IP packets which come to us destined for any address between
          205.254.211.32 and 205.254.211.39 will be rewritten to the
          corresponding address in the range 192.168.100.32 through
          192.168.100.39.  This is a shorthand way to specify multiple
          translations with CIDR notation.
        </p><p>
          Again, this is only one half of the story for NAT with
          <span class="command"><strong>iproute2</strong></span>.  Please be certain to read 
          the section below for usage information on <a class="link" href="#tools-ip-rule-add-nat" title="3.4. ip rule add nat"><span class="command"><strong>ip rule add
          nat</strong></span></a>, in addition to <a class="xref" href="#ch-nat" title="Chapter 5. Network Address Translation (NAT)">Chapter 5, <i>Network Address Translation (NAT)</i></a> which
          will provide fuller documentation for NAT support under linux.
          Don't forget to use <a class="link" href="#tools-ip-route-flush-cache" title="2.10. ip route flush cache"><span class="command"><strong>ip route flush
          cache</strong></span></a> after you add NAT routes and
          the corresponding NAT rules
          <a href="#ftn.idm5161" class="footnote" name="idm5161"><sup class="footnote">[55]</sup></a>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-del"></a>2.6. Removing routes with <span class="command"><strong>ip route del</strong></span></h3></div></div></div><p>
          The <span class="command"><strong>ip route del</strong></span> takes exactly the same syntax as
          the <a class="link" href="#tools-ip-route-add" title="2.3. Using ip route add to populate a routing table"><span class="command"><strong>ip route
          add</strong></span></a> command, so if you have familiarized yourself
          with the syntax, this should be a snap.
        </p><p>
          It is, in fact, almost trivial to delete routes on the command line
          with <span class="command"><strong>ip route del</strong></span>.  You can simply identify the
          route you wish to remove with <a class="link" href="#tools-ip-route-show" title="2.1. Displaying a routing table with ip route show"><span class="command"><strong>ip route show</strong></span></a>
          command and append the output line verbatim to <span class="command"><strong>ip route
          del</strong></span>.
        </p><div class="example"><a name="ex-tools-ip-route-del"></a><p class="title"><b>Example D.23. Removing routes with <span class="command">ip route del</span>
          <a href="#ftn.idm5180" class="footnote" name="idm5180"><sup class="footnote">[56]</sup></a>
          </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.100.0/30 dev eth3  scope link
205.254.211.0/24 dev eth1  scope link
192.168.100.0/24 dev eth0  scope link
192.168.99.0/24 dev eth0  scope link
192.168.98.0/24 via 192.168.99.1 dev eth0
10.38.0.0/16 via 192.168.100.1 dev eth3
127.0.0.0/8 dev lo  scope link 
default via 205.254.211.254 dev eth1</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route del 10.38.0.0/16 via 192.168.100.1 dev eth3</code></strong>
          </pre></div></div><br class="example-break"><p>
          We identified the network route to 10.38.0.0/16 as the route we
          wished to remove, and simply appended the description of the route
          to our <span class="command"><strong>ip route del</strong></span> command.
        </p><p>
          This command can be used to remove routes such as broadcast routes
          and routes to locally hosted IPs in addition to manipulation of
          any of the other routing tables.  This means that you can cause some
          very strange problems on your machine by inadvertently removing
          routes, especially routes to locally hosted IP addresses.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-change"></a>2.7. Altering existing routes with <span class="command"><strong>ip route
          change</strong></span></h3></div></div></div><p>
          Occasionally, you'll want to remove a route and replace it with
          another one.  Fortunately, this can be done atomically with
          <span class="command"><strong>ip route change</strong></span>.
        </p><p>
          Let's change the default route on tristan with this command.
        </p><div class="example"><a name="ex-tools-ip-route-change"></a><p class="title"><b>Example D.24. Altering existing routes with <span class="command">ip route
            change</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route change default via 192.168.99.113 dev eth0</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.99.0/24 dev eth0  scope link 
127.0.0.0/8 dev lo  scope link 
default via 192.168.99.113 dev eth0</code>
          </pre></div></div><br class="example-break"><p>
          If you do use the <span class="command"><strong>ip route change</strong></span> command, you
          should be aware that it does not communicate a routing table state
          change to the routing cache, so here is another good place to get in
          the habit of using <a class="link" href="#tools-ip-route-flush-cache" title="2.10. ip route flush cache"><span class="command"><strong>ip route flush
          cache</strong></span></a>.
        </p><p>
          There's not much more to say about the use of this command.  If you
          don't want to use an <a class="link" href="#tools-ip-route-del" title="2.6. Removing routes with ip route del"><span class="command"><strong>ip route del</strong></span></a>
          immediately followed by an <a class="link" href="#tools-ip-route-add" title="2.3. Using ip route add to populate a routing table"><span class="command"><strong>ip route add</strong></span></a>
          you can use <span class="command"><strong>ip route change</strong></span>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-get"></a>2.8. Programmatically fetching route information with <span class="command"><strong>ip
          route get</strong></span></h3></div></div></div><p>
          When configuring routing tables, it is not always sufficient to
          search for the destination manually.  Especially with large routing
          tables, this can become a rather boring and time-consuming endeavor.
          Fortunately, <span class="command"><strong>ip route get</strong></span> elegantly solves the
          problem.  By simulating a request for the specified destination,
          <span class="command"><strong>ip route get</strong></span> causes the routing selection
          algorithm to be run.  When this is complete, it prints out the
          resulting path to the destination.  In one sense, this is almost
          equivalent to sending an ICMP echo request packet and then using
          <a class="link" href="#tools-ip-route-show-cache" title="2.2. Displaying the routing cache with ip route show cache"><span class="command"><strong>ip route show
          cache</strong></span></a>.
        </p><div class="example"><a name="ex-tools-ip-route-get"></a><p class="title"><b>Example D.25. Testing routing tables with <span class="command">ip route
            get</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip -s route get 127.0.0.1/32</code></strong>
<code class="computeroutput">ip -s route get 127.0.0.1/32
local 127.0.0.1 dev lo  src 127.0.0.1 
    cache &lt;local&gt;  users 1 used 1 mtu 16436 advmss 16396</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip -s route get 127.0.0.1/32</code></strong>
<code class="computeroutput">local 127.0.0.1 dev lo  src 127.0.0.1 
    cache &lt;local&gt;  users 1 used 2 mtu 16436 advmss 16396</code>
          </pre></div></div><br class="example-break"><p>
          For casual use, <span class="command"><strong>ip route get</strong></span> is an invaluable
          tool.  An obvious side effect of using <span class="command"><strong>ip route
          get</strong></span> the increase in the usage count of every touched entry
          in the routing cache.  While this is no problem, it will alter the
          count of packets which have used that particular route.  If you are
          using <span class="command"><strong>ip</strong></span> to count outbound packets (people have
          done it!) you should be cautious with this command.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-flush"></a>2.9. Clearing routing tables with <span class="command"><strong>ip route
          flush</strong></span></h3></div></div></div><p>
          The <code class="option">flush</code> option, when used with <span class="command"><strong>ip
          route</strong></span> empties a routing table or removes the route for a
          particular destination.  In <a class="xref" href="#ex-tools-ip-route-flush" title="Example D.26. Removing a specific route and emptying a routing table with ip route flush">Example D.26, &#8220;Removing a specific route and emptying a routing table with
            <span class="command">ip route flush</span>&#8221;</a>,
          we'll first remove a route for a destination network using
          <span class="command"><strong>ip route flush</strong></span>, and then we'll remove all of the
          routes in the main routing table with one command.
        </p><p>
          If you do not wish to delete routes by hand, you can quickly
          empty all of the routes in a table by specifying a table identifier
          to the <span class="command"><strong>ip route flush</strong></span> command.
        </p><div class="example"><a name="ex-tools-ip-route-flush"></a><p class="title"><b>Example D.26. Removing a specific route and emptying a routing table with
            <span class="command">ip route flush</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush</code></strong>
<code class="computeroutput">"ip route flush" requires arguments</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush 10.38</code></strong>
<code class="computeroutput">Nothing to flush.</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush 10.38.0.0/16</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="computeroutput">192.168.100.0/30 dev eth3  scope link
205.254.211.0/24 dev eth1  scope link
192.168.100.0/24 dev eth0  scope link
192.168.99.0/24 dev eth0  scope link
192.168.98.0/24 via 192.168.99.1 dev eth0
127.0.0.0/8 dev lo  scope link 
default via 205.254.211.254 dev eth1</code>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush table main</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route show</code></strong>
<code class="prompt">[root@masq-gw]# </code>
          </pre></div></div><br class="example-break"><p>
          Note that you should exercise caution when using <span class="command"><strong>ip route
          flush table</strong></span> because you can easily destroy your own route
          to the machine by specifying the main routing table or a routing
          table that is used to send packets to your workstation.  Naturally,
          this is not a problem if you are connected to the machine via a
          serial, modem, console, or other out of band connection.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-flush-cache"></a>2.10. <span class="command"><strong>ip route flush cache</strong></span></h3></div></div></div><p>
          Above, in <a class="xref" href="#tools-ip-route-show-cache" title="2.2. Displaying the routing cache with ip route show cache">Section 2.2, &#8220;Displaying the routing cache with <span class="command"><strong>ip route
          show cache</strong></span>&#8221;</a>, we looked at
          the contents of the routing cache, a hash table in the kernel which
          contains recently used routes.  To quote John S. Denker, you
          should not forget to use <span class="command"><strong>ip route flush cache</strong></span>
          after you have changed the routing tables; "otherwise changes will
          take effect only after some maddeningly irreproducible delay."
          <a href="#ftn.idm5279" class="footnote" name="idm5279"><sup class="footnote">[57]</sup></a>
        </p><p>
          Since the kernel refers to the routing cache before fetching a new
          route from the routing tables, <span class="command"><strong>ip route flush
          cache</strong></span> empties the cache of any data.  Now when the kernel
          goes to the routing cache to locate the best route to a destination,
          it finds the cache empty.  Next, it traverses the routing policy
          database and routing tables.  When the kernel finds the route, it
          will enter the newly fetched destination into the routing cache.
        </p><div class="example"><a name="ex-tools-ip-route-flush-cache"></a><p class="title"><b>Example D.27. Emptying the routing cache with <span class="command">ip route flush
            cache</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show cache</code></strong>
<code class="computeroutput">local 127.0.0.1 from 127.0.0.1 tos 0x10 dev lo 
    cache &lt;local&gt;  mtu 16436 advmss 16396
local 127.0.0.1 from 127.0.0.1 dev lo 
    cache &lt;local&gt;  mtu 16436 advmss 16396
192.168.100.17 from 192.168.99.35 via 192.168.99.254 dev eth0 
    cache  mtu 1500 rtt 18ms rttvar 15ms cwnd 15 advmss 1460
192.168.100.17 via 192.168.99.254 dev eth0  src 192.168.99.35 
    cache  mtu 1500 advmss 1460</code>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route flush cache</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show cache</code></strong>
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>ip route show cache</code></strong>
<code class="computeroutput">local 127.0.0.1 from 127.0.0.1 tos 0x10 dev lo 
    cache &lt;local&gt;  mtu 16436 advmss 16396
local 127.0.0.1 from 127.0.0.1 dev lo 
    cache &lt;local&gt;  mtu 16436 advmss 16396</code>
          </pre></div></div><br class="example-break"><p>
          When making routing changes to a linux box, you can save yourself
          some troubleshooting time (and confusion) by getting in the habit of
          finishing your routing commands with <span class="command"><strong>ip route flush
          cache</strong></span>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-route-summary"></a>2.11. Summary of the use of <span class="command"><strong>ip route</strong></span></h3></div></div></div><p>
          With this overview of the use of the <span class="command"><strong>ip route</strong></span>
          utility, you should be ready to step into some advanced territory to
          harness multiple routing tables, take advantage of special types of
          routes, use network address translation, and gather detailed
          statistics on the usage of your routing tables.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ip-rule"></a>3. <span class="command"><strong>ip rule</strong></span></h2></div></div></div><p>
        Another part of the <span class="command"><strong>iproute2</strong></span> software package,
        <span class="command"><strong>ip rule</strong></span> is the single tool for manipulating the
        routing policy database under linux (RPDB).  For a fuller discussion
        of the RPDB, see <a class="xref" href="#adv-rpdb" title="3. Using the Routing Policy Database and Multiple Routing Tables">Section 3, &#8220;Using the Routing Policy Database and Multiple Routing
      Tables&#8221;</a>.  The RPDB can be <a class="link" href="#tools-ip-rule-show" title="3.2. Displaying the RPDB with ip rule show">displayed with <span class="command"><strong>ip rule
        show</strong></span></a>.  Particular rules can be added and removed with
        (predictably, if you have been reading the sections on the other
        <span class="command"><strong>iproute2</strong></span> tools) <a class="link" href="#tools-ip-rule-add" title="3.3. Adding a rule to the RPDB with ip rule add"><span class="command"><strong>ip rule add</strong></span></a>
        command and the <a class="link" href="#tools-ip-rule-add" title="3.3. Adding a rule to the RPDB with ip rule add"><span class="command"><strong>ip rule del</strong></span></a>
        command.  We'll make a particular example of the <a class="link" href="#tools-ip-rule-add-nat" title="3.4. ip rule add nat"><span class="command"><strong>ip rule add
        nat</strong></span></a>.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-rule-intro"></a>3.1. <span class="command"><strong>ip rule show</strong></span></h3></div></div></div><p>
          Briefly, the RPDB mediates access to the routing tables.  In the
          overwhelming majority of installations (most workstations, servers,
          and even routers),
          there is no need to take advantage of the RPDB.  A single IP routing
          table is all that is required for basic connectivity.  In more complex
          networking configurations, however, the RPDB allows the administrator
          to programmatically select a routing table based on characteristics of
          a packet.
        </p><p>
          Along with this freedom and flexibility comes the power to break
          networking in strange and unexpected ways.  I will reiterate:
          <span class="emphasis"><em>IP routing is stateless</em></span>.  Because IP routing is
          stateless, the network architect, planner or administrator needs to be
          aware of the issues involved with using multiple routing tables.
        </p><p>
          For a fuller discussion of some of these issues, be sure to read
          <a class="xref" href="#adv-rpdb" title="3. Using the Routing Policy Database and Multiple Routing Tables">Section 3, &#8220;Using the Routing Policy Database and Multiple Routing
      Tables&#8221;</a>.  Now, let's look at some of the ways to use
          <span class="command"><strong>ip rule</strong></span>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-rule-show"></a>3.2. Displaying the RPDB with <span class="command"><strong>ip rule show</strong></span></h3></div></div></div><p>
          To display the RPDB, use the command <span class="command"><strong>ip route show</strong></span>.
          The output of the command is a list of rules in the RPDB sorted by
          order of priority.  The rules with the highest priority will be
          displayed at the top of the output.
        </p><div class="example"><a name="ex-tools-ip-rule-show"></a><p class="title"><b>Example D.28. Displaying the RPDB with <span class="command">ip rule
            show</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          There are some interesting items to observe here.  First, these are
          the three default rules in the RPDB which will be available on any
          machine with an RPDB.  The first rule specifies that any packet from
          any where should first be matched against routes in the local
          routing table.  Remember that the local routing table is for
          broadcast addresses on link layers, network address translation, and
          locally hosted IP addresses.
        </p><p>
          If a packet is not bound for any of these three destinations, the
          kernel will check the next entry in the RPDB.  In the simple case
          above, on <code class="systemitem">isolde</code>, a
          packet bound for 205.254.211.182 would first pass through the local
          routing table without matching any of the local destinations.  The
          next entry in the RPDB recommends using the main routing table to
          select a destination route.
        </p><p>
          In <code class="systemitem">isolde</code>'s main routing
          table, it is likely that there is no host nor network match for this
          destination, thus the packet will match the default route in the
          main routing table.
        </p><p>
          FIXME!!  Can anybody (somebody?) explain to me why there is a rule
          priority 32767 which refers to table 253?  I'm still confused about
          this.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-rule-add"></a>3.3. Adding a rule to the RPDB with <span class="command"><strong>ip rule
          add</strong></span></h3></div></div></div><p>
          Adding a rule to the routing policy database is simple.  The syntax
          of the <span class="command"><strong>ip rule add</strong></span> command should be familiar to
          those who have read <a class="xref" href="#tools-ip-route" title="2. ip route">Section 2, &#8220;<span class="command"><strong>ip route</strong></span>&#8221;</a> or have used the
          <span class="command"><strong>ip route</strong></span> to populate routing tables.
        </p><p>
          A simple rule selects a packet on the packet's characteristics.
          Some characteristics available as selection criteria  are the
          source address, the destination, the type of service (ToS), the
          interface on which the packet arrived, and an fwmark.
        </p><p>
          One great way to take advantage of the RPDB is to split different
          types of traffic to different providers based on packet
          characteristics.  Let's assume two network connections on
          <code class="systemitem">masq-gw</code>, one that is a
          highly reliable high cost connection, and a much lower cost less
          reliable connection.  Let's also assume that we are using Type of
          Service flags on IP packets on the internal network.
        </p><p>
          We might want to prefer a low-latency, highly reliable link
          for one type of packet.  By using <code class="option">tos</code> as a
          selection criterion with <span class="command"><strong>ip rule</strong></span> we can
          effectively route these packets via our faster and more reliable
          internet connection.
        </p><div class="example"><a name="ex-tools-ip-rule-add-simple"></a><p class="title"><b>Example D.29. Creating a simple entry in the RPDB with <span class="command">ip rule
            add</span>
            <a href="#ftn.idm5364" class="footnote" name="idm5364"><sup class="footnote">[58]</sup></a>
          </b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route add default via 205.254.211.254 table 8</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add tos 0x08 table 8</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip route flush cache</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32765:  from all tos 0x08 lookup 8 
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          Note that the rule we inserted was added to the next available
          higher priority in the RPDB because we did not specify a priority.
          If we wished to specify a priority, we could use
          <code class="option">prio</code>.
        </p><p>
          Now any packet with an IP ToS field matching 0x08 will be routed
          according to the instructions in table 8.  If no route in table 8
          applies to the matched packet (not possible, since we added a
          default route), the packet would be routed according to the
          instructions in table "main".
        </p><p>
          The selection criteria for matching a packet can be grouped.  Let's
          look at a more complex example of <span class="command"><strong>ip rule</strong></span> where
          we use multiple selection criteria.
        </p><div class="example"><a name="ex-tools-ip-rule-add-complex"></a><p class="title"><b>Example D.30. Creating a complex entry in the RPDB with <span class="command">ip rule
            add</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add from 192.168.100.17 tos 0x08 fwmark 4 table 7</code></strong>
          </pre></div></div><br class="example-break"><p>
          Frankly, that's a very complex rule!  I do not know if I could
          describe a scenario where this particular rule would be required.
          The point, though, is that you can have arbitrarily complex
          selection criteria, and multiple rules which lookup routes in as
          many of the 253 routing tables as you wish.
        </p><p>
          <span class="command"><strong>ip rule add</strong></span>, while a powerful tool, can quickly
          make a routing table or router too complex to easily understand.
          It's important to try to design and implement the simplest
          configuration to maintain on your router.  If you cannot avoid using
          multiple routing tables and the RPDB, at least be systematic about
          it.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-rule-add-nat"></a>3.4. <span class="command"><strong>ip rule add nat</strong></span></h3></div></div></div><p>
          As discussed more thoroughly in <a class="xref" href="#ch-nat" title="Chapter 5. Network Address Translation (NAT)">Chapter 5, <i>Network Address Translation (NAT)</i></a>, this is the
          other half of <span class="command"><strong>iproute2</strong></span> supported network address
          translation.  The two components are <a class="link" href="#tools-ip-route-add-nat" title="2.5. Setting up NAT with ip route add nat"><span class="command"><strong>ip route add
          nat</strong></span></a> and <span class="command"><strong>ip rule add nat</strong></span>.
        </p><p>
          <span class="command"><strong>ip rule add nat</strong></span> is used to rewrite the source IP
          on packets during the routing stage.  Each packet from the real IP
          is translated to the NAT IP without altering the destination address
          of the packet.
        </p><p>
          NAT is commonly used to publish a service in an internal network on
          a public IP.  Thus packets returning to the public network need to
          be readdressed to appear with a source address of the publicly
          accessibly IP.
        </p><div class="example"><a name="ex-tools-ip-rule-add-nat-simple"></a><p class="title"><b>Example D.31. Creating a NAT rule with <span class="command">ip rule add
            nat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add nat 205.254.211.17 from 192.168.100.17</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32765:  from 192.168.100.17 lookup main map-to 205.254.211.17
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          In more complex situations, entire subnets can be translated to
          provide NAT for a range of IPs.  The example below shows how to
          specify the <span class="command"><strong>ip rule add nat</strong></span> to complete the NAT
          mapping in <a class="xref" href="#ex-tools-ip-route-nat-network" title="Example D.22. Creating a NAT route for an entire network with ip route add nat">Example D.22, &#8220;Creating a NAT route for an entire network with <span class="command">ip
            route add nat</span>&#8221;</a>.
        </p><div class="example"><a name="ex-tools-ip-rule-add-nat-network"></a><p class="title"><b>Example D.32. Creating a NAT rule for an entire network with <span class="command">ip
            rule add nat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule add nat 205.254.211.32 from 192.168.100.32/29</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32765:  from 192.168.100.32/29 lookup main map-to 205.254.211.32
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          Notice the <span class="command"><strong>ip rule</strong></span> synonym for the
          <code class="option">nat</code> option.  It is valid to substitute
          <code class="option">map-to</code> for <code class="option">nat</code>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ip-rule-del"></a>3.5. <span class="command"><strong>ip rule del</strong></span></h3></div></div></div><p>
          Naturally, no <span class="command"><strong>iproute2</strong></span> tool would be complete
          without the ability to undo what has been done.  With <span class="command"><strong>ip
          rule del</strong></span>, individual rules can be removed from the RPDB.
        </p><p>
          It is at first quite confusing that the word <code class="option">all</code> in
          the <span class="command"><strong>ip rule show</strong></span> output needs to be replaced with
          the network address 0/0.  I do not know why <code class="option">all</code> is
          not acceptable as a synonym for 0/0, but you'll save yourself some
          headache by getting in the habit of replacing <code class="option">all</code>
          with 0/0.
        </p><p>
          By replacing the verb <code class="option">add</code> in any of the command
          lines above with the verb <code class="option">del</code>, you can remove the
          specified entry from the RPDB.
        </p><div class="example"><a name="ex-tools-ip-rule-del-nat-network"></a><p class="title"><b>Example D.33. Removing a NAT rule for an entire network with <span class="command">ip
            rule del nat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule del nat 205.254.211.32 from 192.168.100.32/29</code></strong>
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ip rule show</code></strong>
<code class="computeroutput">0:      from all lookup local 
32766:  from all lookup main 
32767:  from all lookup 253</code>
          </pre></div></div><br class="example-break"><p>
          The <span class="command"><strong>ip rule</strong></span> utility can be a great boon in the
          manipulation and maintenance of complex routers.
        </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm4600" class="footnote"><p><a href="#idm4600" class="para"><sup class="para">[46] </sup></a>
          For those who have some doubt, netfilter provides a connection
          tracking mechanism for packets passing through a linux router.  This
          connection tracking, however, is independent of routing.  It is
          important to not conflate the packet filtering connection tracking
          statefulness with the statelessness of IP routing.  For an example
          of a complex networking setup where netfilter's statefulness and the
          statelessness of IP routing collide, see
          <a class="xref" href="#adv-multi-internet" title="4. Multiple Connections to the Internet">Section 4, &#8220;Multiple Connections to the Internet&#8221;</a>.
        </p></div><div id="ftn.idm4750" class="footnote"><p><a href="#idm4750" class="para"><sup class="para">[47] </sup></a>
              Though <code class="systemitem">tristan</code> does not
              have a direct route to the 192.168.98.0/24 network, it does have
              a default route which knows about this destination network.
              Therefore, for the purposes of this illustrative example, we'll
              assume that <code class="systemitem">masq-gw</code> is
              configured to drop or reject all traffic to 192.168.98.0/24 from
              192.168.99.0/24 and vice versa.  Effectively this means that the
              only path to reach the branch office from the main office is via 
              <code class="systemitem">isdn-router</code>.
            </p></div><div id="ftn.idm4768" class="footnote"><p><a href="#idm4768" class="para"><sup class="para">[48] </sup></a>
              There can potentially be routing problems with multiple IP
              networks on the same media segment, but if you can remember that
              IP routing is essentially stateless, you can plan around these
              routing problems and solve these problems.  For a fuller
              discussion of these issues, see <a class="xref" href="#adv-multi-ips" title="4. Multiple IPs on an Interface">Section 4, &#8220;Multiple IPs on an Interface&#8221;</a>
              and <a class="xref" href="#adv-media-share" title="2. Multiple IP Networks on one Ethernet Segment">Section 2, &#8220;Multiple IP Networks on one Ethernet Segment&#8221;</a>.
            </p></div><div id="ftn.idm4932" class="footnote"><p><a href="#idm4932" class="para"><sup class="para">[49] </sup></a>
              I'm going to specifically neglect a discussion of bridging and
              broadcast addresses for now.  Let's assume a simple Ethernet
              where the entire IP network is on one hub or switch.
            </p></div><div id="ftn.idm4936" class="footnote"><p><a href="#idm4936" class="para"><sup class="para">[50] </sup></a>
              When a user initiates a connection to localhost (let's say
              localhost:25, where a private SMTP server is listening), the
              connection could, of course, come from the IP assigned to any of
              the Ethernet interfaces. It makes the most sense, however, for the
              source IP to be set to 127.0.0.1, since the connection is
              actually initiated from on the local machine.  Some services
              running on a local machine rely on the loopback interface and
              will restrict incoming connections to source addresses of
              127.0.0.1.  Frankly, I find this quite sensible for services
              which are not intended for public use.
            </p></div><div id="ftn.idm4994" class="footnote"><p><a href="#idm4994" class="para"><sup class="para">[51] </sup></a>
              Be wary of using
              <a class="link" href="#tools-ip-route-get" title="2.8. Programmatically fetching route information with ip route get"><span class="command"><strong>ip route
              get</strong></span></a> and <span class="command"><strong>ip route show cache</strong></span>
              because <span class="command"><strong>ip route get</strong></span>
              implicitly causes a route lookup to be performed, thus
              increasing the used counter on the route, and resetting the age.
              This will alter the statistics reported by <span class="command"><strong>ip -s route
              show cache</strong></span>.
            </p></div><div id="ftn.idm5051" class="footnote"><p><a href="#idm5051" class="para"><sup class="para">[52] </sup></a>
              Please note that I in the cross-referenced example I have used
              <span class="command"><strong>iptables</strong></span>.  The same behaviour should be
              expected with <span class="command"><strong>ipchains</strong></span>. (Anybody have any
              proof?)
            </p></div><div id="ftn.idm5074" class="footnote"><p><a href="#idm5074" class="para"><sup class="para">[53] </sup></a>
              If you wonder how this kind of magic is accomplished, you'll
              want to read <a class="xref" href="#adv-routing-fwmark" title="3.2. Using fwmark for Policy Routing">Section 3.2, &#8220;Using fwmark for Policy Routing&#8221;</a>.
            </p></div><div id="ftn.idm5125" class="footnote"><p><a href="#idm5125" class="para"><sup class="para">[54] </sup></a>
              This should not lead you into believing it cannot be done.  This
              is linux after all!  By routing via fwmark, and using the
              <code class="option">--mark</code> option to <span class="command"><strong>ipchains</strong></span> or
              the MARK target and <code class="option">--set-mark</code> option in
              <span class="command"><strong>iptables</strong></span>, you can perform conditional routing
              based on characteristics and contents of the packet.
            </p></div><div id="ftn.idm5161" class="footnote"><p><a href="#idm5161" class="para"><sup class="para">[55] </sup></a>
              You can always use my
              <a class="link" href="#ex-sc-nat" title="Example 11.3. Static NAT SysV initialization script">SysV initialization script</a>
              and
              <a class="link" href="#ex-sc-static-nat" title="Example 11.4. Static NAT configuration file">configuration file</a>
              instead of entering your own commands, however, it is
              always important to understand the tool you are using.
            </p></div><div id="ftn.idm5180" class="footnote"><p><a href="#idm5180" class="para"><sup class="para">[56] </sup></a>
              Please note that this is the same routing table as is shown in
              the <a class="xref" href="#ex-tools-route-show-complex" title="Example D.2. Viewing a complex routing table with route">Example D.2, &#8220;Viewing a complex routing table with <span class="command">route</span>&#8221;</a>, which
              displays the output from <span class="command"><strong>route -n</strong></span> on
              <code class="systemitem">masq-gw</code>.
            </p></div><div id="ftn.idm5279" class="footnote"><p><a href="#idm5279" class="para"><sup class="para">[57] </sup></a>
              See this remark in his
              <a class="ulink" href="http://www.quintillion.com/moat/ipsec+routing/iproute2.html" target="_top">documentation</a>
              of a workaround with FreeS/WAN and iproute2 to approximate more
              RFC-like SPD behaviour for a linux IPSec tunnel.
            </p></div><div id="ftn.idm5364" class="footnote"><p><a href="#idm5364" class="para"><sup class="para">[58] </sup></a>
                Please note that this is an incomplete example.  Simply put,
                I'm not dealing with the issues of inbound packets or packets
                destined for locally connected networks in this example.  Keep
                in mind the instructional nature of this example, and plan
                your own network accordingly.  For a fuller discussion of the
                issues involved with handling multiple Internet links, see
                <a class="xref" href="#adv-multi-internet" title="4. Multiple Connections to the Internet">Section 4, &#8220;Multiple Connections to the Internet&#8221;</a>.  Note also, that there is
                no corresponding network connection in the example network for
                this network connection.
              </p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-tunnels"></a>Appendix E. Tunnels and VPNs</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-cipe">1. Lightweight encrypted tunnel with <span class="command"><strong>CIPE</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipip">2. GRE tunnels with <span class="command"><strong>ip tunnel</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ssh">3. All manner of tunnels with <span class="command"><strong>ssh</strong></span></a></span></dt><dt><span class="section"><a href="#tools-freeswan">4. IPSec implementation via <span class="command"><strong>FreeS/WAN</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ipsec">5. IPSec implementation in the kernel</a></span></dt><dt><span class="section"><a href="#tools-pptp">6. <span class="command"><strong>PPTP</strong></span></a></span></dt></dl></div><p>
      FIXME
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-cipe"></a>1. Lightweight encrypted tunnel with <span class="command"><strong>CIPE</strong></span></h2></div></div></div><p>
        FIXME; Crypto IP Encapsulation.  Lightweight, because the carrier
        protocol is UDP.  Visit the
        <a class="ulink" href="http://sites.inka.de/sites/bigred/devel/cipe.html" target="_top">main
        CIPE page</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ipip"></a>2. GRE tunnels with <span class="command"><strong>ip tunnel</strong></span></h2></div></div></div><p>
        FIXME; Good way to get a static IP!
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ssh"></a>3. All manner of tunnels with <span class="command"><strong>ssh</strong></span></h2></div></div></div><p>
        FIXME; abuses of ssh.....ssh -o GatewayPorts=yes and PPP/SSH.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-freeswan"></a>4. IPSec implementation via <span class="command"><strong>FreeS/WAN</strong></span></h2></div></div></div><p>
        FIXME; (get links from Matt)
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ipsec"></a>5. IPSec implementation in the kernel</h2></div></div></div><p>
        FIXME; the development kernel 2.5.46+ contains support for IPSec
        natively.  This has been documented at
        <a class="ulink" href="http://lartc.org/howto/lartc.ipsec.html" target="_top">LARTC by
        bert hubert</a>.  It won't be here for quite some time.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-pptp"></a>6. <span class="command"><strong>PPTP</strong></span></h2></div></div></div><p>
        FIXME; ugh...you don't really want to do PPTP (I don't think), but, if
        you do
        <a class="ulink" href="http://www.poptop.org/" target="_top">PoPToP</a> is the software for
        you.
      </p></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-sockets"></a>Appendix F. Sockets; Servers and Clients</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-telnet">1. <span class="command"><strong>telnet</strong></span></a></span></dt><dt><span class="section"><a href="#tools-nc">2. <span class="command"><strong>nc</strong></span></a></span></dt><dt><span class="section"><a href="#tools-socat">3. <span class="command"><strong>socat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpclient">4. <span class="command"><strong>tcpclient</strong></span></a></span></dt><dt><span class="section"><a href="#tools-xinetd">5. <span class="command"><strong>xinetd</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpserver">6. <span class="command"><strong>tcpserver</strong></span></a></span></dt><dt><span class="section"><a href="#tools-redir">7. <span class="command"><strong>redir</strong></span></a></span></dt></dl></div><p>
      There is little point to the huge study of routing and network
      configuration if we can't move data from one host to another.
      This appendix will cover many of the command line tools (and a few
      daemons) which can be used to initiate TCP connections, receive TCP
      connections and send and receive UDP datagrams.  Many of these tools are
      included with stock installations.
    </p><p>
      <a class="link" href="#tools-telnet" title="1. telnet"><span class="command"><strong>telnet</strong></span></a> and 
      <a class="link" href="#tools-nc" title="2. nc"><span class="command"><strong>nc</strong></span></a> are the most
      common tools used for quickly creating a TCP connection.  The less
      common utility
      <a class="link" href="#tools-tcpclient" title="4. tcpclient"><span class="command"><strong>tcpclient</strong></span></a>
      provides a scriptable method for initiating TCP sessions, equally as
      well as <span class="command"><strong>nc</strong></span>.  Finally, the tool
      <a class="link" href="#tools-socat" title="3. socat"><span class="command"><strong>socat</strong></span></a> includes
      support for a large number of other types of sockets and files in
      addition to TCP and UDP.
    </p><p>
      Some services expect to run under another utility which will handle the
      socket operations.  We'll tour the following utilities:
      <a class="link" href="#tools-xinetd" title="5. xinetd"><span class="command"><strong>xinetd</strong></span></a>,
      <a class="link" href="#tools-tcpserver" title="6. tcpserver"><span class="command"><strong>tcpserver</strong></span></a> and
      the very specifically designed port redirection utility
      <a class="link" href="#tools-redir" title="7. redir"><span class="command"><strong>redir</strong></span></a>.
    </p><p>
      It's important to remember that tools like <span class="command"><strong>socat</strong></span> and
      <span class="command"><strong>nc</strong></span> are suited equally well to initiate or receive TCP
      connections, but may not have the flexibility of administrative control
      afforded by tools such as <span class="command"><strong>xinetd</strong></span> and
      <span class="command"><strong>tcpserver</strong></span> where this was inherent to the design of
      the software.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-telnet"></a>1. <span class="command"><strong>telnet</strong></span></h2></div></div></div><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-nc"></a>2. <span class="command"><strong>nc</strong></span></h2></div></div></div><p>
        Quick example of <span class="command"><strong>nc</strong></span> (pronounced net-cat) in action.
      </p><div class="example"><a name="ex-tools-nc-basic"></a><p class="title"><b>Example F.1. Simple use of <span class="command">nc</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>nc 192.168.100.17 25</code></strong>
<code class="computeroutput">220 isolde ESMTP</code>
<strong class="userinput"><code>quit</code></strong>
<code class="computeroutput">221 isolde</code>
        </pre></div></div><br class="example-break"><p>
        <span class="command"><strong>nc</strong></span> is one of a large number of tools for making a
        simple TCP connection.
      </p><p>
      </p><div class="example"><a name="ex-tools-nc-timeout"></a><p class="title"><b>Example F.2. Specifying timeout with <span class="command">nc</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>nc -w 5 192.168.98.82 22</code></strong>
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-nc-source"></a><p class="title"><b>Example F.3. Specifying source address with <span class="command">nc</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>nc -s 192.168.99.254 192.168.47.3 25</code></strong>
        </pre></div></div><br class="example-break"><p>
      </p><p>
      </p><p>
      </p><div class="example"><a name="ex-tools-nc-server"></a><p class="title"><b>Example F.4. Using <span class="command">nc</span> as a server</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>nc -l -p 2048</code></strong>
        </pre></div></div><br class="example-break"><p>
      </p><p>
      </p><p>
      </p><div class="example"><a name="ex-tools-nc-delay"></a><p class="title"><b>Example F.5. Delaying a stream with <span class="command">nc</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>nc -l -p 2048</code></strong>
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-nc-udp"></a><p class="title"><b>Example F.6. Using <span class="command">nc</span> with UDP</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>nc -u 192.168.100.17 3000</code></strong>
        </pre></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-socat"></a>3. <span class="command"><strong>socat</strong></span></h2></div></div></div><p>
      </p><div class="example"><a name="ex-tools-socat-basic"></a><p class="title"><b>Example F.7. Simple use of <span class="command">socat</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-proxy"></a><p class="title"><b>Example F.8. Using <span class="command">socat</span> with proxy connect</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-openssl"></a><p class="title"><b>Example F.9. Using <span class="command">socat</span> perform SSL</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-file-descriptor"></a><p class="title"><b>Example F.10. Connecting one end of <span class="command">socat</span> to a file
          descriptor</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-serial"></a><p class="title"><b>Example F.11. Connecting <span class="command">socat</span> to a serial line</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-pty"></a><p class="title"><b>Example F.12. Using a PTY with <span class="command">socat</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-exec"></a><p class="title"><b>Example F.13. Executing a command with <span class="command">socat</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-socat-socat"></a><p class="title"><b>Example F.14. Connecting one <span class="command">socat</span> to another one</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-tcpclient"></a>4. <span class="command"><strong>tcpclient</strong></span></h2></div></div></div><p>
      </p><div class="example"><a name="ex-tools-tcpclient-basic"></a><p class="title"><b>Example F.15. Simple use of <span class="command">tcpclient</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-tcpclient-localport"></a><p class="title"><b>Example F.16. Specifying the local port which <span class="command">tcpclient</span>
          should request</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-tcpclient-localip"></a><p class="title"><b>Example F.17. Specifying the local IP to which <span class="command">tcpclient</span>
          should bind</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-xinetd"></a>5. <span class="command"><strong>xinetd</strong></span></h2></div></div></div><p>
      </p><div class="example"><a name="ex-tools-xinetd-redir"></a><p class="title"><b>Example F.18. IP redirection with <span class="command">xinetd</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><p>
      </p><div class="example"><a name="ex-tools-xinetd-server"></a><p class="title"><b>Example F.19. Publishing a service with <span class="command">xinetd</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-tcpserver"></a>6. <span class="command"><strong>tcpserver</strong></span></h2></div></div></div><p>
      </p><div class="example"><a name="ex-tools-tcpserver-basic"></a><p class="title"><b>Example F.20. Simple use of <span class="command">tcpserver</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-tcpserver-cdb"></a><p class="title"><b>Example F.21. Specifying a CDB for <span class="command">tcpserver</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-tcpserver-concurrency"></a><p class="title"><b>Example F.22. Limiting the number of concurrently accept TCP sessions
          under <span class="command">tcpserver</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-tcpserver-uid"></a><p class="title"><b>Example F.23. Specifying a UID for <span class="command">tcpserver</span>'s
          spawned processes</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-redir"></a>7. <span class="command"><strong>redir</strong></span></h2></div></div></div><p>
      </p><div class="example"><a name="ex-tools-redir-basic"></a><p class="title"><b>Example F.24. Redirecting a TCP port with <span class="command">redir</span></b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
        Here we are going to talk about port redirection, so point out
        <a class="xref" href="#nat-dnat" title="5. Destination NAT with netfilter (DNAT)">Section 5, &#8220;Destination NAT with netfilter (DNAT)&#8221;</a> and <a class="xref" href="#nat-pat-userspace" title="6. Port Address Translation (PAT) from Userspace">Section 6, &#8220;Port Address Translation (PAT) from Userspace&#8221;</a>.
      </p><div class="example"><a name="ex-tools-redir-transproxy"></a><p class="title"><b>Example F.25. Running <span class="command">redir</span> in transparent mode</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-redir-inetd"></a><p class="title"><b>Example F.26. Running <span class="command">redir</span> from another TCP server</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p><div class="example"><a name="ex-tools-redir-bindaddr"></a><p class="title"><b>Example F.27. Specifying a source address for <span class="command">redir</span>'s client
          side</b></p><div class="example-contents"><pre class="programlisting">
        </pre></div></div><br class="example-break"><p>
      </p></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-diagnostics"></a>Appendix G. Diagnostic Tools</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-ping">1. <span class="command"><strong>ping</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-ping-simple">1.1. Using <span class="command"><strong>ping</strong></span> to test reachability</a></span></dt><dt><span class="section"><a href="#tools-ping-stress">1.2. Using <span class="command"><strong>ping</strong></span> to stress a network</a></span></dt><dt><span class="section"><a href="#tools-ping-record-route">1.3. Recording a network route with <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-ttl">1.4. Setting the TTL on a <span class="command"><strong>ping</strong></span> packet</a></span></dt><dt><span class="section"><a href="#tools-ping-tos">1.5. Setting ToS for a diagnostic <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-specify-source">1.6. Specifying a source address for <span class="command"><strong>ping</strong></span></a></span></dt><dt><span class="section"><a href="#tools-ping-summary">1.7. Summary on the use of <span class="command"><strong>ping</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-traceroute">2. <span class="command"><strong>traceroute</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-traceroute-basic">2.1. Using <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-icmp">2.2. Telling <span class="command"><strong>traceroute</strong></span> to use ICMP echo request
          instead of UDP</a></span></dt><dt><span class="section"><a href="#tools-traceroute-tos">2.3. Setting ToS with <span class="command"><strong>traceroute</strong></span></a></span></dt><dt><span class="section"><a href="#tools-traceroute-summary">2.4. Summary on the use of <span class="command"><strong>traceroute</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-mtr">3. <span class="command"><strong>mtr</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat">4. <span class="command"><strong>netstat</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-netstat-socket">4.1. Displaying socket status with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-route">4.2. Displaying the main routing table with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-interface">4.3. Displaying network interface statistics with
          <span class="command"><strong>netstat</strong></span> command</a></span></dt><dt><span class="section"><a href="#tools-netstat-statistics">4.4. Displaying network stack statistics with
          <span class="command"><strong>netstat</strong></span></a></span></dt><dt><span class="section"><a href="#tools-netstat-masquerade">4.5. Displaying the masquerading table with
          <span class="command"><strong>netstat</strong></span></a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpdump">5. <span class="command"><strong>tcpdump</strong></span></a></span></dt><dd><dl><dt><span class="section"><a href="#tools-tcpdump-arp">5.1. Using <span class="command"><strong>tcpdump</strong></span> to view ARP messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-unreach">5.2. Using <span class="command"><strong>tcpdump</strong></span> to see ICMP unreachable
          messages</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-tcp">5.3. Using <span class="command"><strong>tcpdump</strong></span> to watch TCP sessions</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-file">5.4. Reading and writing <span class="command"><strong>tcpdump</strong></span> data</a></span></dt><dt><span class="section"><a href="#tools-tcpdump-frag">5.5. Understanding fragmentation as reported by
          <span class="command"><strong>tcpdump</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpdump-other">5.6. Other options to the <span class="command"><strong>tcpdump</strong></span> command</a></span></dt></dl></dd><dt><span class="section"><a href="#tools-tcpflow">6. <span class="command"><strong>tcpflow</strong></span></a></span></dt><dt><span class="section"><a href="#tools-tcpreplay">7. <span class="command"><strong>tcpreplay</strong></span></a></span></dt></dl></div><a class="indexterm" name="idm5698"></a><p>
      Now that we have covered most of the basic tools for management of
      routes, IP addresses, and a few Ethernet tools, we come to a set of
      tools which are used primarily to help you figure out what is wrong in
      your network, where a route is broken, or even, simply, whether a host
      is reachable.
    </p><p>
      Some of these tools are available on other platforms, but may have
      different command line switches or may use different packet signatures
      than those described here.  The concepts in many cases, transfer, but,
      of course, the command line options may be different.
    </p><p>
      We are going to start with one of the first networking tools that many
      people learn, <a class="link" href="#tools-ping" title="1. ping"><span class="command"><strong>ping</strong></span></a>
      and we'll move along to the common 
      <a class="link" href="#tools-traceroute" title="2. traceroute"><span class="command"><strong>traceroute</strong></span></a>,
      which maps out a route from one host to another,
      <a class="link" href="#tools-mtr" title="3. mtr"><span class="command"><strong>mtr</strong></span></a>, which
      represents traceroute-type information in a richer format,
      <a class="link" href="#tools-netstat" title="4. netstat"><span class="command"><strong>netstat</strong></span></a>, for
      examining sockets (and routes) in use, and finally, the indispensable
      <a class="link" href="#tools-tcpdump" title="5. tcpdump"><span class="command"><strong>tcpdump</strong></span></a>, which
      reports on all traffic passing through a device.
    </p><p>
      By learning both how and when to use these tools, but even more
      importantly, how to read their output, you can perform a tremendous
      amount of reconnaisance on your own network and frequently quickly
      isolate problems and identify error conditions.  These tools are some of
      the core tools of any linux administrator who is responsible for an IP
      network.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ping"></a>1. <span class="command"><strong>ping</strong></span></h2></div></div></div><a class="indexterm" name="idm5717"></a><a class="indexterm" name="idm5720"></a><p>
        <span class="command"><strong>ping</strong></span> is one of the oldest IP utilities around.
        Simply put, <span class="command"><strong>ping</strong></span> asks another host if it is alive,
        and records the round-trip time between the request and the reply.
      </p><p>
        In this section, we'll look at several examples of the use of
        <span class="command"><strong>ping</strong></span> to
        <a class="link" href="#tools-ping-simple" title="1.1. Using ping to test reachability">test reachability</a>,
        <a class="link" href="#ex-tools-ping-simple-count" title="Example G.2. Using ping to specify number of packets to send">send a specified number of
        packets</a>,
        <a class="link" href="#ex-tools-ping-simple-quiet" title="Example G.3. Using ping to specify number of packets to send">suppress all but summary
        output</a>,
        <a class="link" href="#tools-ping-stress" title="1.2. Using ping to stress a network">stress the network</a>,
        <a class="link" href="#tools-ping-record-route" title="1.3. Recording a network route with ping">record the route a
        packet takes</a>,
        <a class="link" href="#tools-ping-ttl" title="1.4. Setting the TTL on a ping packet">set the TTL</a>,
        <a class="link" href="#tools-ping-tos" title="1.5. Setting ToS for a diagnostic ping">specify ToS</a>,
        and <a class="link" href="#tools-ping-specify-source" title="1.6. Specifying a source address for ping">specify the source
        IP</a>.
      </p><p>
        The <span class="command"><strong>ping</strong></span> utility has a simple and elegant design.
        When run, it will craft a packet bound for the specified destination,
        send the packet, and record the time it took that packet to reach its
        destination.  The generated packet is an ICMP packet known as an
        echo-request.  If the destination host receives the packet, it should
        generate an echo-reply.  The success or failure of this very simple
        operation can provide some insight into the state of a network or a
        series of networks.
      </p><a class="indexterm" name="idm5740"></a><p>
        In most cases, the ICMP echo-request packets and echo-reply packets,
        upon which <span class="command"><strong>ping</strong></span>'s functionality relies, are allowed
        through routers and firewalls, however with the advent of trojans and
        distributed denial of service tools which transmit information within
        ICMP packets, some networks and network administrators block ICMP at
        their borders.  For an example of such a trojan, see this
        <a class="ulink" href="http://staff.washington.edu/dittrich/misc/tfn.analysis" target="_top">dissection
        of the trinoo</a> distributed denial of service tool.  As a result
        of these nefarious uses of echo-request and echo-reply packets, some
        cautious network administrators block all non-essential ICMP at their
        border routers.  See <a class="xref" href="#routing-icmp" title="10. ICMP and Routing">Section 10, &#8220;ICMP and Routing&#8221;</a> for a more complete
        discussion of ICMP.
      </p><p>
        Thus, we can no longer assume (as perhaps we once could) that simply
        because a host is not answering our <span class="command"><strong>ping</strong></span> request,
        this host is down.  There may be a device which has been configured to
        filter out this traffic.
      </p><p>
        If a host is reachable and answering our echo-requests, then we may
        also wish to believe that the round-trip times recorded by ping are
        an accurate representation of network conditions.  This can be
        misleading.  Some routers are configured to give ICMP diagnostic
        messages the lowest priority of any IP packets travelling through
        them, in which case that router may contribute significantly to the
        round trip time of any echo-request packet passing through it.
      </p><p>
        With knowledge of these two potential roadblocks to the successful use
        of <span class="command"><strong>ping</strong></span> as a network diagnostic tool, we can begin
        to explore how <span class="command"><strong>ping</strong></span> is useful.  In most internal
        networks, and many public networks, there are no filters to block our
        echo-request packets.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-simple"></a>1.1. Using <span class="command"><strong>ping</strong></span> to test reachability</h3></div></div></div><a class="indexterm" name="idm5758"></a><p>
          In its simplest form, <span class="command"><strong>ping</strong></span> is used interactively
          on the command line to test reachability of a remote host.  Again,
          you'll see in all of the examples below the use of the
          <code class="option">-n</code> switch to suppress DNS lookups.  Since the
          proper functioning of DNS relies on a properly configured network,
          and <span class="command"><strong>ping</strong></span> is one of your tools for diagnosing
          network problems, it makes sense to suppress all name lookup until
          you have verified that the IP layer is functioning properly.
        </p><p>
          Let's see first if the host
          <code class="systemitem">morgan</code> can reach its default gateway.  This example is similar
          to the test we performed in <a class="xref" href="#ex-basic-ping" title="Example 1.2. Testing reachability of a locally connected host with ping">Example 1.2, &#8220;Testing reachability of a locally connected host with
          <span class="command">ping</span>&#8221;</a>
          from <code class="systemitem">tristan</code>.
        </p><p>
          On many systems, <span class="command"><strong>ping</strong></span> can be used by non-root
          users, but there are some options and features to
          <span class="command"><strong>ping</strong></span> which require the user to have
          administrative privilege or root-level access to the box.
          Therefore, all examples below will be run as the root user.  Please
          be aware, that many diagnostics can be run without this high a level
          of privilege.
        </p><div class="example"><a name="ex-tools-ping-simple"></a><p class="title"><b>Example G.1. Using <span class="command">ping</span> to test reachability</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -n 192.168.98.254</code></strong>
<code class="computeroutput">PING 192.168.98.254 (192.168.98.254) from 192.168.98.82 : 56(84) bytes of data.
64 bytes from 192.168.98.254: icmp_seq=0 ttl=255 time=231 usec
64 bytes from 192.168.98.254: icmp_seq=1 ttl=255 time=179 usec
64 bytes from 192.168.98.254: icmp_seq=2 ttl=255 time=215 usec</code>
<strong class="userinput"><code>&lt;ctrl-C&gt;</code></strong>
<code class="computeroutput"> 
--- 192.168.98.254 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max/mdev = 0.179/0.208/0.231/0.024 ms</code>
          </pre></div></div><br class="example-break"><p>
          We have verified from 
          <code class="systemitem">morgan</code> that its default
          gateway, <code class="systemitem">branch-router</code>
          is reachable.  The first line of output tells us what the source
          and destination addresses (and names, if using DNS) are.
          Additionally, we learn the size of the data segment of the ping
          packet, 56 bytes, and the size of the entire outbound IP packet 84
          bytes.
        </p><p>
          Each subsequent line of output before the summary is a record of the
          receipt of a reply from the destination (and what IP address sent
          the reply).  Because <span class="command"><strong>ping</strong></span> needs to keep track of
          the number of bytes
          it has sent, and the round-trip time, each time you run ping, it
          creates a sequence number inside the data of the ping packet and
          reports the sequence number on any packets which return.  By
          analyzing the timestamps on the returned packets,
          <span class="command"><strong>ping</strong></span> can determine the round trip time of the
          journey and reports this as the final field in each line of output.
        </p><p>
          At the end of the run, <span class="command"><strong>ping</strong></span> summarizes the number
          of replies, and performs some calculations on the round-trip times.
          As with much data collection, you need a large sample set of data to
          draw conclusions about your network.  You can usually conclude that
          something is quite wrong if you cannot reach a remote host, but you
          should be cautious when concluding that your Ethernet card is bad
          simply because round-trip times to a destination on the LAN is high.
          It is more likely that there's another problem.  Collecting
          <span class="command"><strong>ping</strong></span> data from a number of hosts to a number of
          destinations can help you determine if the problem is a localized to
          a single machine.
        </p><p>
          Frequently, you'll want to use <span class="command"><strong>ping</strong></span> in a script,
          or you'll want to specify that <span class="command"><strong>ping</strong></span> should only
          run for a few cycles.  Fortunately, this is trivial (and I'll use
          the count option many times further below in this section).  The
          <code class="option">-c</code> restricts the number of packets which
          <span class="command"><strong>ping</strong></span> will send (or receive).  It can be combined
          with some of the other options for a variety of diagnostic purposes.
        </p><div class="example"><a name="ex-tools-ping-simple-count"></a><p class="title"><b>Example G.2. Using <span class="command">ping</span> to specify number of packets to
            send</b></p><div class="example-contents"><a class="indexterm" name="idm5799"></a><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -c 10 -n 192.168.100.17</code></strong>
<code class="computeroutput">PING 192.168.100.17 (192.168.100.17) from 192.168.98.82 : 56(84) bytes of data.
64 bytes from 192.168.100.17: icmp_seq=0 ttl=251 time=39.568 msec
64 bytes from 192.168.100.17: icmp_seq=1 ttl=251 time=38.529 msec
64 bytes from 192.168.100.17: icmp_seq=2 ttl=251 time=38.214 msec
64 bytes from 192.168.100.17: icmp_seq=3 ttl=251 time=38.173 msec
64 bytes from 192.168.100.17: icmp_seq=4 ttl=251 time=38.652 msec
64 bytes from 192.168.100.17: icmp_seq=5 ttl=251 time=38.278 msec
64 bytes from 192.168.100.17: icmp_seq=6 ttl=251 time=38.472 msec
64 bytes from 192.168.100.17: icmp_seq=7 ttl=251 time=38.481 msec
64 bytes from 192.168.100.17: icmp_seq=8 ttl=251 time=38.248 msec
64 bytes from 192.168.100.17: icmp_seq=9 ttl=251 time=38.188 msec

--- 192.168.100.17 ping statistics ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max/mdev = 38.173/38.480/39.568/0.423 ms</code>
          </pre></div></div><br class="example-break"><p>
          In this example, we see a very regular 38 millisecond round trip
          time between <code class="systemitem">morgan</code> (192.168.98.82) and <code class="systemitem">isolde</code>
          (192.168.100.17).  After sending 10 echo request packets and
          receiving the replies, <span class="command"><strong>ping</strong></span> summarizes the data
          for us and exits. 
        </p><p>
          Occasionally, either in a script, or on the command line, you may
          not care about the output of each individual line.  In this case,
          you can suppress everything except the summary data with the
          <code class="option">-q</code> switch.  In the following example, we are again
          testing reachability of <code class="systemitem">isolde</code> (192.168.100.17)
          though we only care about the summary output.
        </p><div class="example"><a name="ex-tools-ping-simple-quiet"></a><p class="title"><b>Example G.3. Using <span class="command">ping</span> to specify number of packets to
            send</b></p><div class="example-contents"><a class="indexterm" name="idm5818"></a><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -q -c 10 -n 192.168.100.17</code></strong>
<code class="computeroutput">PING 192.168.100.17 (192.168.100.17) from 192.168.98.82 : 56(84) bytes of data.

--- 192.168.100.17 ping statistics ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max/mdev = 37.853/38.370/39.320/0.430 ms</code>
          </pre></div></div><br class="example-break"><p>
          Here, we see only the output from <span class="command"><strong>ping</strong></span> as it
          begins to send packets to the destination, and the summary output
          when it has completed its run.
        </p><p>
          These are some simple examples of the use of <span class="command"><strong>ping</strong></span>
          to gather and present statistics on reachability of destination
          hosts, packet loss, and round trip times.  Some other diagnostics
          information can be gathered with <span class="command"><strong>ping</strong></span>, too.
          Let's look at the use of <span class="command"><strong>ping</strong></span> to test
          reachability as aggressively as possible.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-stress"></a>1.2. Using <span class="command"><strong>ping</strong></span> to stress a network</h3></div></div></div><a class="indexterm" name="idm5836"></a><p>
          Occasionally, you'll want to stress the network to test how many
          packets you can squeeze through a link, and how gracefully
          performance on that link degrades.  Fortunately,
          <span class="command"><strong>ping</strong></span>, when run with the <code class="option">-f</code>
          switch can perform exactly this kind of test for you.
        </p><div class="example"><a name="ex-tools-ping-stress"></a><p class="title"><b>Example G.4. Using <span class="command">ping</span> to stress a network</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -c 400 -f -n 192.168.99.254</code></strong>
<code class="computeroutput">PING 192.168.99.254 (192.168.99.254) from 192.168.98.82 : 56(84) bytes of data.
............
--- 192.168.99.254 ping statistics ---
411 packets transmitted, 400 packets received, 2% packet loss
round-trip min/avg/max/mdev = 37.840/62.234/97.807/12.946 ms</code>
          </pre></div></div><br class="example-break"><p>
          In this example, we have used the default packet size and sent 411
          packets, receiving only 400 back from the remote host for a mere 2%
          packet loss.  By increasing the packet size of the packet we are
          sending across the link we can get a sense for how quickly
          performance degrades on this link.  If we use a much larger packet
          size (still smaller than Ethernet's 1500 byte frame), we see even
          more packet loss.  We'll specify a packet size of 512 bytes with the
          <code class="option">-s</code> option.
        </p><div class="example"><a name="ex-tools-ping-stress-size"></a><p class="title"><b>Example G.5. Using <span class="command">ping</span> to stress a network with large
            packets</b></p><div class="example-contents"><a class="indexterm" name="idm5856"></a><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -s 512 -c 400 -f -n 192.168.99.254</code></strong>
<code class="computeroutput">PING 192.168.99.254 (192.168.99.254) from 192.168.98.82 : 512(540) bytes of data.
............................................................................
................................................................
--- 192.168.99.254 ping statistics ---
551 packets transmitted, 400 packets received, 27% packet loss
round-trip min/avg/max/mdev = 47.854/295.711/649.595/153.345 ms</code>
          </pre></div></div><br class="example-break"><p>
          Flooding a low bandwidth link, like the ISDN link between
          <code class="systemitem">morgan</code> and
          <code class="systemitem">masq-gw</code> can be
          detrimental to other traffic on that link, so it is wise to use the
          <code class="option">-f</code> with restraint.  Although
          <span class="command"><strong>ping</strong></span> is a versatile tool for network diagnostics,
          it is not intended as a network performance measurement tool.  For
          this sort of task, try <a class="ulink" href="http://www.netperf.org/" target="_top">netperf</a> or collect some data
          with SNMP to analyze with <a class="ulink" href="http://people.ee.ethz.ch/~oetiker/webtools/mrtg/" target="_top">MRTG</a>.
        </p><p>
          As you can see, the use of ping floods is a good way to stress the
          network to which you are connected, and can be a good diagnostic
          tool.  Be careful to stress the network for short periods of time if
          possible, or in a carefully controlled setting.  Unless you want to
          alienate coworkers and anger your network administrator, you shouldn't
          start a ping flood and go home for the night.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-record-route"></a>1.3. Recording a network route with <span class="command"><strong>ping</strong></span></h3></div></div></div><a class="indexterm" name="idm5876"></a><p>
          The options we have outlined above are common options to
          <span class="command"><strong>ping</strong></span>, but now, let's look at some of the less
          common options.  Occasionally, you may find yourself on a linux box
          without <a class="link" href="#tools-traceroute" title="2. traceroute"><span class="command"><strong>traceroute</strong></span></a> or 
          <a class="link" href="#tools-mtr" title="3. mtr"><span class="command"><strong>mtr</strong></span></a>.  Perhaps
          it's an embedded linux host, or a minimal installation with
          <span class="command"><strong>ping</strong></span>.  There is an almost unknown option for
          recording the route a packet takes.  By comparison to the more
          sophisticated tools for tracing network paths,
          <span class="command"><strong>ping</strong></span> with the record route option
          (<code class="option">-R</code>) doesn't convey the information in as visually
          an appealing way, but it can get the job done.
        </p><div class="example"><a name="ex-tools-ping-record-route"></a><p class="title"><b>Example G.6. Recording a network route with <span class="command">ping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -c 2 -n -R 192.168.99.35</code></strong>
<code class="computeroutput">PING 192.168.99.35 (192.168.99.35) from 192.168.98.82 : 56(124) bytes of data.
64 bytes from 192.168.99.35: icmp_seq=0 ttl=253 time=56.311 msec
RR:     192.168.98.82
        192.168.98.254
        192.168.99.1
        192.168.99.35
        192.168.99.35
        192.168.99.1
        192.168.98.254
        192.168.98.82

64 bytes from 192.168.99.35: icmp_seq=1 ttl=253 time=47.893 msec  (same route)

--- 192.168.99.35 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/mdev = 47.893/52.102/56.311/4.209 ms</code>
          </pre></div></div><br class="example-break"><p>
          As always, <span class="command"><strong>ping</strong></span> summarizes the output after it
          has completed its run, but let's examine the new section.  By using
          the record route option, we are asking all routers along the way to
          include their IPs in the header.  Although some routers may not
          observe this courtesy, many do.  Unfortunately, there is only room
          to record 8 different hops (FIXME--verify this!), so the use of
          <span class="command"><strong>ping</strong></span> <code class="option">-R</code> is mostly useful only
          in smaller networks.
        </p><p>
          The first IP we hit is our own IP on the way out our Ethernet
          interface, 192.168.98.82.  Then it is a palindromic journey through
          the network stacks of each of the following hosts in order:
          <code class="systemitem">branch-router</code>, <code class="systemitem">isdn-router</code>, <code class="systemitem">tristan</code>, and back again
          in reverse order.
        </p><p>
          <span class="command"><strong>ping</strong></span> is even nice enough to report to us that a
          subsequent journey took the same route as the first packet.  If you
          have a statically routed internal network, any subsequent packets
          should look exactly like the second packet.  If dynamic routing is
          in use on your internal network, you may find that the routes change
          occasionally.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-ttl"></a>1.4. Setting the TTL on a <span class="command"><strong>ping</strong></span> packet</h3></div></div></div><a class="indexterm" name="idm5910"></a><p>
          Now, frankly, I'm not sure of a practical use for the following
          option to <span class="command"><strong>ping</strong></span>, however, you can specify the TTL
          for an outbound echo requust packet.  By setting the TTL you are
          specifying the maximum number of hops this packet will travel before
          it will be dropped.  Conventionally, the TTL is set by the kernel to
          a reasonable number of hops (like 64).  The <code class="option">-t</code>
          provides us the capability to force the TTL for our echo requests.
          Now that we know it takes four hops to get to 
          <code class="systemitem">tristan</code> from <code class="systemitem">morgan</code> we should be able
          to test whether setting the TTL makes any difference.
        </p><div class="example"><a name="ex-tools-ping-ttl"></a><p class="title"><b>Example G.7. Setting the TTL on a <span class="command">ping</span> packet</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -c 1 -n -t 4 192.168.99.35</code></strong>
<code class="computeroutput">tcpdump: listening on eth0
02:02:04.679152 192.168.98.82 &gt; 192.168.99.35: icmp: echo request (DF)
02:02:04.711474 192.168.99.35 &gt; 192.168.98.82: icmp: echo reply</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>ping -c 1 -n -t 3 192.168.99.35</code></strong>
<code class="computeroutput">tcpdump: listening on eth0
02:01:50.810567 192.168.98.82 &gt; 192.168.99.35: icmp: echo request (DF)
02:01:50.841917 192.168.99.1 &gt; 192.168.98.82: icmp: time exceeded in-transit</code>
          </pre></div></div><br class="example-break"><p>
          Clearly, we are able to reach <code class="systemitem">tristan</code> if we set the
          TTL on our echo requests to 4, but as soon as we drop the TTL to 3,
          we get a reply from the third hop (<code class="systemitem">isdn-router</code>), telling
          us that our packet was too old to be forwarded to its destination.
          If you are unclear on the rationale for TTL, I'd suggest reviewing
          some of the general IP documentation available in
          <a class="xref" href="#links-general-ip" title="1.3. General IP Networking Resources">Section 1.3, &#8220;General IP Networking Resources&#8221;</a>.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-tos"></a>1.5. Setting ToS for a diagnostic <span class="command"><strong>ping</strong></span></h3></div></div></div><a class="indexterm" name="idm5937"></a><p>
          Type of Service (ToS) is increasingly in use on backbones across the
          Internet which has brought with it Service Level Agreements (SLA).
          If you have an SLA with your provider, you may find the use of
          <span class="command"><strong>ping</strong></span> <code class="option">-Q</code> to set the IP packet ToS
          flags will help you to determine if your provider is holding up
          their end of the bargain.
        </p><p>
          In <a class="xref" href="#ex-tools-ping-tos" title="Example G.8. Setting ToS for a diagnostic ping">Example G.8, &#8220;Setting ToS for a diagnostic <span class="command">ping</span>&#8221;</a> we'll set the ToS flag and
          verify with <a class="link" href="#tools-tcpdump" title="5. tcpdump">tcpdump</a> that the
          ToS flag on the outbound packets have actually been set.  Let's
          assume that we have an SLA with a backbone provider for our link
          between our German office (195.73.22.45) and our North American
          office (205.254.209.73).  We'll send two test packets to the remote
          end, and observe the data on the wire.
        </p><div class="example"><a name="ex-tools-ping-tos"></a><p class="title"><b>Example G.8. Setting ToS for a diagnostic <span class="command">ping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@wan-gw]# </code><strong class="userinput"><code>ping -c 2 -Q 8 -n 195.73.22.45</code></strong>
<code class="computeroutput">PING 195.73.22.45 (195.73.22.45) from 205.254.209.73 : 56(84) bytes of data.
64 bytes from 195.73.22.45: icmp_seq=0 ttl=252 time=51.633 msec
64 bytes from 195.73.22.45: icmp_seq=1 ttl=252 time=36.323 msec

--- 195.73.22.45 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/mdev = 36.323/43.978/51.633/7.655 ms</code>
<code class="prompt">[root@wan-gw]# </code><strong class="userinput"><code>tcpdump -nni wan0 icmp</code></strong>
<code class="computeroutput">tcpdump: listening on wan0
21:55:37.983149 10.10.14.2 &gt; 10.10.22.254: icmp: echo request (DF) [tos 0x8] 
21:55:38.034770 10.10.22.254 &gt; 10.10.14.2: icmp: echo reply [tos 0x8] 
21:55:38.982277 10.10.14.2 &gt; 10.10.22.254: icmp: echo request (DF) [tos 0x8] 
21:55:39.018588 10.10.22.254 &gt; 10.10.14.2: icmp: echo reply [tos 0x8]</code>
          </pre></div></div><br class="example-break"><p>
          Naturally, <span class="command"><strong>ping</strong></span> reports to us the round-trip
          times, the source and destination IPs, and that there was no packet
          loss.  And our <span class="command"><strong>tcpdump</strong></span> output shows that the ToS
          flags were properly set on the packet.  With all of this
          information, we can collect data about the reliability of the
          network between our two offices.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-specify-source"></a>1.6. Specifying a source address for <span class="command"><strong>ping</strong></span></h3></div></div></div><a class="indexterm" name="idm5964"></a><p>
          Occasionally, you'll find yourself on a heavily packet filtered
          host, or a host which employs conditional routing for packets with
          certain source addresses.  Such packet filtering can prevent or
          conflict with the use of <span class="command"><strong>ping</strong></span>.  Fortunately,
          <span class="command"><strong>ping</strong></span> allows the user to specify the source
          address of an outbound packet, thus allowing traversal of packet
          filters and conditional routing tables.
        </p><p>
          My classic example of a need for specifying source address on a
          <span class="command"><strong>ping</strong></span> is a VPN connected network.  Let's assume 
          <code class="systemitem">masq-gw</code> has a <a class="link" href="#tools-cipe" title="1. Lightweight encrypted tunnel with CIPE">CIPE</a>peer in
          another city.  Let's assume the internal IP on the peer
          is 192.168.70.254.  If <code class="systemitem">masq-gw</code> sends a packet
          to the peer with a source address of 205.254.211.179, the peer might
          drop the inbound packet on a VPN interface from the public IP of the
          peer
          <a href="#ftn.idm5977" class="footnote" name="idm5977"><sup class="footnote">[59]</sup></a>.
          In this case, the peer should still accept traffic from <code class="systemitem">masq-gw</code>
          if the originating IP is inside the private network IP range.
        </p><p>
          In the <a class="xref" href="#ex-tools-ping-specify-source" title="Example G.9. Specifying a source address for ping">Example G.9, &#8220;Specifying a source address for <span class="command">ping</span>&#8221;</a> we'll use
          <span class="command"><strong>ping</strong></span> to check reachability of the inside
          interface of the CIPE peer of <code class="systemitem">masq-gw</code>.
        </p><div class="example"><a name="ex-tools-ping-specify-source"></a><p class="title"><b>Example G.9. Specifying a source address for <span class="command">ping</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>ping -c 2 -n -I 192.168.99.254 192.168.70.254</code></strong>
<code class="computeroutput">PING 192.168.70.254 (192.168.70.254) from 192.168.99.254 : 56(84) bytes of data.
64 bytes from 192.168.70.254: icmp_seq=0 ttl=254 time=69.285 msec
64 bytes from 192.168.70.254: icmp_seq=1 ttl=254 time=53.976 msec

--- 192.168.70.254 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/mdev = 53.976/61.630/69.285/7.658 ms</code>
          </pre></div></div><br class="example-break"><p>
          By forcing the echo request packet to use the IP bound to one of our
          internal interfaces as the source address with the
          <code class="option">-I</code> we are able to send traffic through the <a class="link" href="#tools-cipe" title="1. Lightweight encrypted tunnel with CIPE">CIPE</a> tunnel to the other side, and back.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-ping-summary"></a>1.7. Summary on the use of <span class="command"><strong>ping</strong></span></h3></div></div></div><p>
          As you can see, <span class="command"><strong>ping</strong></span> is a versatile tool in the
          network administrator's toolkit, and can be used for a wide range of
          tests beyond the simple reachability test.  For a brief and
          humourous introduction to the program itself, see <a class="ulink" href="http://ftp.arl.mil/~mike/ping.html" target="_top">The Story of Ping</a>.
        </p><p>
          Now that we have a good idea of the uses of the
          <span class="command"><strong>ping</strong></span> utility, let's move on to some other tools
          which can provide us other diagnostic data about our networks.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-traceroute"></a>2. <span class="command"><strong>traceroute</strong></span></h2></div></div></div><a class="indexterm" name="idm6005"></a><p>
        <span class="command"><strong>traceroute</strong></span> is a utility for identifying the network
        path a packet will take to a destination.  Like ping, it can be called
        a number of ways.  <span class="command"><strong>traceroute</strong></span> takes advantage of a
        the TTL in an IP packet to determine hop by hop the reachability and
        addressing of routers between the <span class="command"><strong>traceroute</strong></span> host
        and the intended destination.
      </p><p>
        The tool <span class="command"><strong>traceroute</strong></span> is available on most Unix-like
        platforms and even under Windows as <span class="command"><strong>tracert</strong></span>.  Here,
        we will only consider the common <span class="command"><strong>traceroute</strong></span>
        installed on linux systems.
      </p><p>
      </p><p>
      </p><p>
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-traceroute-basic"></a>2.1. Using <span class="command"><strong>traceroute</strong></span></h3></div></div></div><a class="indexterm" name="idm6022"></a><p>
          The default packet type created by <span class="command"><strong>traceroute</strong></span>
          is a UDP packet.  The first packet will be addressed to udp/33435
          and each subsequent packet will be addressed to an incremented port
          number.  This allows <span class="command"><strong>traceroute</strong></span> to keep track of
          which return ICMP packets correspond to which outbound packets.
        </p><div class="example"><a name="ex-tools-traceroute-basic"></a><p class="title"><b>Example G.10. Simple usage of <span class="command">traceroute</span></b></p><div class="example-contents"><a class="indexterm" name="idm6031"></a><pre class="programlisting">
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>traceroute -n 192.168.99.35</code></strong>
<code class="prompt">[root@isolde]# </code><strong class="userinput"><code>tcpdump -nn -i eth0 not tcp</code></strong>
tcpdump: listening on eth0
20:13:36.905537 192.168.100.17.32978 &gt; 192.168.99.35.33435:  udp 10 [ttl 1]
20:13:36.905668 192.168.100.254 &gt; 192.168.100.17. icmp: time exceeded in-transit [tos 0xc0] 
20:13:36.906005 192.168.100.17.32978 &gt; 192.168.99.35.33436:  udp 10 [ttl 1]
20:13:36.906112 192.168.100.254 &gt; 192.168.100.17. icmp: time exceeded in-transit [tos 0xc0] 
20:13:36.906357 192.168.100.17.32978 &gt; 192.168.99.35.33437:  udp 10 [ttl 1]
20:13:36.906457 192.168.100.254 &gt; 192.168.100.17. icmp: time exceeded in-transit [tos 0xc0] 
20:13:36.906759 192.168.100.17.32978 &gt; 192.168.99.35.33438:  udp 10
20:13:36.907061 192.168.99.35 &gt; 192.168.100.17. icmp: 192.168.99.35 udp port 33438 unreachable [tos 0xc0] 
20:13:36.907293 192.168.100.17.32978 &gt; 192.168.99.35.33439:  udp 10
20:13:36.907543 192.168.99.35 &gt; 192.168.100.17. icmp: 192.168.99.35 udp port 33439 unreachable [tos 0xc0] 
20:13:36.907753 192.168.100.17.32978 &gt; 192.168.99.35.33440:  udp 10
20:13:36.907990 192.168.99.35 &gt; 192.168.100.17. icmp: 192.168.99.35 udp port 33440 unreachable [tos 0xc0] 

13 packets received by filter
0 packets dropped by kernel
          </pre></div></div><br class="example-break"><p>
          Note in
          <a class="xref" href="#ex-tools-traceroute-basic" title="Example G.10. Simple usage of traceroute">Example G.10, &#8220;Simple usage of <span class="command">traceroute</span>&#8221;</a> that
          <span class="command"><strong>tcpdump</strong></span> conveniently reports the low TTL on the
          first packets.  Packets transmitted from a router with a TTL of 1
          will expire at the next router they hit.  This is the concept and
          mechanism by which <span class="command"><strong>traceroute</strong></span> is able to detect
          the path by which packets arrive at their destination.
        </p><p>
          Each of the first three packets transmitted in the above example
          receive ICMP time exceeded replies from the upstream router
          (<code class="systemitem">masq-gw</code>).  The second set of packets have their TTL set to 2,
          which is not reported by <span class="command"><strong>tcpdump</strong></span>.  This allows
          these packets to reach the intended destination, <code class="systemitem">tristan</code>.
        </p><p>
          There is a liability of using UDP traceroute on the Internet.
          Many screening routers, firewalls, and even hosts will silently drop
          UDP packets, effectively destroying the usability of
          <span class="command"><strong>traceroute</strong></span>.  On internal networks, or networks
          known to have no firewalls, conventional
          <span class="command"><strong>traceroute</strong></span> can continue to provide diagnostic
          value.  In the case that the network is known to have a firewall,
          <a class="link" href="#tools-traceroute-icmp" title="2.2. Telling traceroute to use ICMP echo request instead of UDP"><span class="command"><strong>traceroute</strong></span>
          can use ICMP</a>, and
          <a class="link" href="#tools-mtr" title="3. mtr"><span class="command"><strong>mtr</strong></span></a> is a good
          example of a network diagnostic tool which uses ICMP only.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-traceroute-icmp"></a>2.2. Telling <span class="command"><strong>traceroute</strong></span> to use ICMP echo request
          instead of UDP</h3></div></div></div><a class="indexterm" name="idm6058"></a><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-traceroute-tos"></a>2.3. Setting ToS with <span class="command"><strong>traceroute</strong></span></h3></div></div></div><a class="indexterm" name="idm6068"></a><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-traceroute-summary"></a>2.4. Summary on the use of <span class="command"><strong>traceroute</strong></span></h3></div></div></div><p>
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-mtr"></a>3. <span class="command"><strong>mtr</strong></span></h2></div></div></div><p>
        FIXME
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-netstat"></a>4. <span class="command"><strong>netstat</strong></span></h2></div></div></div><a class="indexterm" name="idm6085"></a><p>
        The <span class="command"><strong>netstat</strong></span> utility summarizes a variety of
        characteristics of the networking stack.  With
        <span class="command"><strong>netstat</strong></span> you can learn a number of important things.
        If no other type of data is requested it will report on the <a class="link" href="#tools-netstat-socket" title="4.1. Displaying socket status with netstat">state of all active sockets</a>.
        You can however request the
        <a class="link" href="#tools-netstat-route" title="4.2. Displaying the main routing table with netstat">routing table</a>,
        <a class="link" href="#tools-netstat-masquerade" title="4.5. Displaying the masquerading table with netstat">masquerading table</a>,
        <a class="link" href="#tools-netstat-interface" title="4.3. Displaying network interface statistics with netstat command">network interface
        statistics</a>, and 
        <a class="link" href="#tools-netstat-statistics" title="4.4. Displaying network stack statistics with netstat">network stack
        statistics</a>
        <a href="#ftn.idm6096" class="footnote" name="idm6096"><sup class="footnote">[60]</sup></a>.
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-netstat-socket"></a>4.1. Displaying socket status with
          <span class="command"><strong>netstat</strong></span></h3></div></div></div><a class="indexterm" name="idm6103"></a><p>
          One of the most common uses of the <span class="command"><strong>netstat</strong></span>
          utility is to determine the state of sockets on a machine.
          There are many questions that <span class="command"><strong>netstat</strong></span> can 
          answer with the right set of options.  Here's a list of some of
          the things different things we can learn.
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              which services are listening on which sockets
            </p></li><li class="listitem"><p>
              what process (and controlling PID) is listening on a given socket
            </p></li><li class="listitem"><p>
              whether data is waiting to be read on a socket
            </p></li><li class="listitem"><p>
              what connections are currently established to which sockets
            </p></li></ul></div><p>
          By invoking <span class="command"><strong>netstat</strong></span> without any options, you are
          asking for a list of all currently open connections to and from the
          networking stack on the local machine.  This means IP network
          connections, unix domain sockets, IPX sockets and Appletalk sockets
          among others.  Naturally, we'll skip over the
          non-IP sockets since this is about IP networking with linux.
        </p><p>
          Assume the <code class="option">--inet</code> switch in all cases below unless
          we are examining a particular higher layer protocol (e.g., TCP with
          the <code class="option">--tcp</code> switch or UDP with <code class="option">--udp</code>
          switch.
        </p><p>
          A convenient feature of <span class="command"><strong>netstat</strong></span> is its ability to
          differentiate between two different sorts of name lookup.  Normally
          the <code class="option">-n</code> specifies no name lookup, but this is
          ambiguous when there are hostnames, port names, and user names.
          Fortunately, <span class="command"><strong>netstat</strong></span> offers the following options
          to differentiate the different forms of lookup and suppress only the
          [un-]desired lookup.
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="option">--numeric-hosts</code>
            </p></li><li class="listitem"><p>
              <code class="option">--numeric-ports</code>
            </p></li><li class="listitem"><p>
              <code class="option">--numeric-users</code>
            </p></li></ul></div><p>
          The option <code class="option">-n</code> (my favorite), suppress all hostname,
          port name and username lookup, and is a synonym for
          <code class="option">--numeric</code>.  I'll reiterate that hostnames and DNS in
          particular can be confusing, or worse, misleading when trying to
          diagnose or debug a networking related issue, so it is wise to
          suppress hostname lookups in these sorts of situations.
        </p><p>
          In <a class="xref" href="#ex-tools-netstat-inet" title="Example G.11. Displaying IP socket status with netstat">Example G.11, &#8220;Displaying IP socket status with
            <span class="command">netstat</span>&#8221;</a> we will look at
          <span class="command"><strong>netstat</strong></span>'s numeric output and then we'll invoke
          the same command but suppress the host lookups.  Though the output
          is almost the same, a particular situation might call for one or the
          other invocation.
        </p><div class="example"><a name="ex-tools-netstat-inet"></a><p class="title"><b>Example G.11. Displaying IP socket status with
            <span class="command">netstat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>netstat --inet -n</code></strong>
<code class="computeroutput">Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0    192 192.168.98.82:22        192.168.99.35:40991     ESTABLISHED
tcp        0      0 192.168.98.82:42929     192.168.100.17:993      ESTABLISHED
tcp       96      0 127.0.0.1:40863         127.0.0.1:6010          ESTABLISHED
tcp        0      0 127.0.0.1:6010          127.0.0.1:40863         ESTABLISHED
tcp        0      0 127.0.0.1:38502         127.0.0.1:6010          ESTABLISHED
tcp        0      0 127.0.0.1:6010          127.0.0.1:38502         ESTABLISHED
tcp        0      0 192.168.98.82:53733     209.10.26.51:80         SYN_SENT
tcp        0      0 192.168.98.82:44468     192.168.100.17:993      ESTABLISHED
tcp        0      0 192.168.98.82:44320     192.168.100.17:139      TIME_WAIT</code>
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>netstat --inet --numeric-hosts</code></strong>
<code class="computeroutput">Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 192.168.98.82:ssh       192.168.99.35:40991     ESTABLISHED
tcp        0      0 192.168.98.82:42929     192.168.100.17:imaps    ESTABLISHED
tcp        0      0 127.0.0.1:40863         127.0.0.:x11-ssh-offset ESTABLISHED
tcp        0      0 127.0.0.:x11-ssh-offset 127.0.0.1:40863         ESTABLISHED
tcp        0      0 127.0.0.1:38502         127.0.0.:x11-ssh-offset ESTABLISHED
tcp        0      0 127.0.0.:x11-ssh-offset 127.0.0.1:38502         ESTABLISHED
tcp        0      0 192.168.98.82:53733     209.10.26.51:http       SYN_SENT
tcp        0      0 192.168.98.82:44468     192.168.100.17:imaps    ESTABLISHED
tcp        0      0 192.168.98.82:44320     192.168.100:netbios-ssn TIME_WAIT</code>
          </pre></div></div><br class="example-break"><p>
          Each line represents a either the sending or
          receiving half of a connection.  In the above output on <code class="systemitem">morgan</code> it
          appears that there are no connections other than TCP connections.
          If you are very familiar with TCP ports and the service associated
          with that port, then the first format will suffice in most cases.  A
          possibly misleading aspect of the latter output is visible in the
          connections to and from localhost and the final line.
          <span class="command"><strong>netstat</strong></span> abbreviates the IP endpoint in order to
          reproduce the entire string retrieved from the port lookup
          (in <code class="filename">/etc/services</code>).  Also interestingly, this
          line conveys to us (in the first output) that the kernel is
          waiting for the remote endpoint to acknowledge the 192 bytes which
          are still in the Send-Q buffer.
        </p><p>
          The first line describes a TCP connection to the IP locally hosted
          on <code class="systemitem">morgan</code>'s Ethernet interface.  The connection was initiated from
          an ephemeral port (40991) on <code class="systemitem">tristan</code> to a service running on port
          22.  The service normally running on this well-known port is sshd,
          so we can conclude that somebody on <code class="systemitem">tristan</code> has connected to the
          <code class="systemitem">morgan</code>'s ssh server.
          The second line describes a TCP session open to port 993 on
          <code class="systemitem">isolde</code>, which probably means that the user on <code class="systemitem">morgan</code> has an open
          connection to an IMAP over SSL server.
        </p><p>
          The third through the sixth lines can be understood in pairs.  By
          examining the source and destination IP and port pairs, we can see
          that two different TCP sessions have been established with the
          source and destination address of 127.0.0.1.  For an administrator
          to publish services on localhost is not at all uncommon.  This makes
          the service harder to abuse from the network.  In this case, when we
          allow the service lookup, the port in question (6010) appears to be
          used to tunnel forwarded X applications over ssh.
        </p><p>
          The next line is the first TCP session in our output which is not in
          a state of ESTABLISHED.  Refer to
          <a class="xref" href="#tb-tools-netstat-socket-states" title="Table G.1. Possible Session States in netstat output">Table G.1, &#8220;Possible Session States in <span class="command">netstat</span>
            output&#8221;</a> for a full list of the
          possible values of the State field in the <span class="command"><strong>netstat</strong></span>
          output.  The state SYN_SENT means that an application has made
          arequest for a TCP session, but has not yet received the return
          SYN+ACK packet.
        </p><p>
          The final line of our <span class="command"><strong>netstat</strong></span>output shows a
          connection in the TIME_WAIT state, which means that the TCP sessions
          have been terminated, but the kernel is waiting for any packets
          which may still be left on the network for this session.  It is not
          at all abnormal for sockets to be in a TIME_WAIT state for a short
          period of time after a TCP session has ended.
        </p><p>
          If we needed to know exactly which application owned a particular
          network connection, we would use the <code class="option">-p | --program</code>
          switch which gives us the PID and process name of the owner process.
          If we want to see the unix user and the PID and process we'll add the
          <code class="option">-e | --extend</code> switch.
        </p><div class="example"><a name="ex-tools-netstat-inet-details"></a><p class="title"><b>Example G.12. Displaying IP socket status details with
            <span class="command">netstat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>netstat -p -e --inet --numeric-hosts</code></strong>
<code class="computeroutput">Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode      PID/Program name   
tcp        0      0 192.168.100.254:ssh     192.168.100.17:49796    ESTABLISHED root       25453      6326/sshd
tcp        0    240 192.168.99.254:ssh      192.168.99.35:42948     ESTABLISHED root       171748     31535/sshd</code>
          </pre></div></div><br class="example-break"><p>
          There doesn't appear to be a large number of connections to and
          from the <code class="systemitem">masq-gw</code> host.  The two sessions are initiated to the sshd
          running on port 22, and the process which owns each socket is a root
          process.
        </p><p>
        </p><p>
        </p><p>
        </p><div class="table"><a name="tb-tools-netstat-socket-states"></a><p class="title"><b>Table G.1. Possible Session States in <span class="command">netstat</span>
            output</b></p><div class="table-contents"><table class="table" summary="Possible Session States in netstat
            output" border="1"><colgroup><col><col></colgroup><thead><tr><th align="left">State</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">LISTEN</td><td align="left">accepting connections</td></tr><tr><td align="left">ESTABLISHED</td><td align="left">connection up and passing data</td></tr><tr><td align="left">SYN_SENT</td><td align="left">TCP; session has been requested by us; waiting for
                       reply from remote endpoint</td></tr><tr><td align="left">SYN_RECV</td><td align="left">TCP; session has been requested by a remote endpoint
                       for a socket on which we were listening</td></tr><tr><td align="left">LAST_ACK</td><td align="left">TCP; our socket is closed; remote endpoint has also
                       shut down; we are waiting for a final
                       acknowledgement</td></tr><tr><td align="left">CLOSE_WAIT</td><td align="left">TCP; remote endpoint has shut down; the kernel is
                       waiting for the application to close the socket</td></tr><tr><td align="left">TIME_WAIT</td><td align="left">TCP; socket is waiting after closing for any packets
                       left on the network</td></tr><tr><td align="left">CLOSED</td><td align="left">socket is not being used (FIXME. What does mean?)</td></tr><tr><td align="left">CLOSING</td><td align="left">TCP; our socket is shut down; remote endpoint is shut
                       down; not all data has been sent</td></tr><tr><td align="left">FIN_WAIT1</td><td align="left">TCP; our socket has closed; we are in the process of
                       tearing down the connection</td></tr><tr><td align="left">FIN_WAIT2</td><td align="left">TCP; the connection has been closed; our socket is
                       waiting for the remote endpoint to shut down</td></tr></tbody></table></div></div><br class="table-break"><p>
        </p><p>
        </p><p>
        </p><p>
        </p><p>
        </p><p>
        </p><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-netstat-route"></a>4.2. Displaying the main routing table with
          <span class="command"><strong>netstat</strong></span></h3></div></div></div><a class="indexterm" name="idm6241"></a><p>
          One of the most common uses of <span class="command"><strong>netstat</strong></span>,
          especially in cross-platform environments is the reporting of the
          main routing table.  On many platforms, <span class="command"><strong>netstat
          -rn</strong></span> is the preferred method of displaying routing
          information, although linux provides at least two alternatives to
          this:  <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a>
          and <a class="link" href="#tools-ip-route" title="2. ip route"><span class="command"><strong>ip route
          show</strong></span></a>.
        </p><div class="example"><a name="ex-tools-netstat-route"></a><p class="title"><b>Example G.13. Displaying the main routing table with
            <span class="command">netstat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@morgan]# </code><strong class="userinput"><code>netstat -rn</code></strong>
<code class="computeroutput">Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
192.168.98.0    0.0.0.0         255.255.255.0   U        40 0          0 eth0
127.0.0.0       0.0.0.0         255.0.0.0       U        40 0          0 lo
0.0.0.0         192.168.98.254  0.0.0.0         UG       40 0          0 eth0</code>
          </pre></div></div><br class="example-break"><p>
          This output should look familiar.  The routing cache itself may not
          be as familiar to most, but can also be displayed with
          <span class="command"><strong>netstat</strong></span>.  The ouput below is exactly the same as
          the ouput from <span class="command"><strong>route -enC</strong></span>.  Refer also to
          <a class="xref" href="#ex-tools-route-show-cache" title="Example D.3. Viewing the routing cache with route">Example D.3, &#8220;Viewing the routing cache with <span class="command">route</span>&#8221;</a>.
        </p><div class="example"><a name="ex-tools-netstat-route-cache"></a><p class="title"><b>Example G.14. Displaying the routing cache with
            <span class="command">netstat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@tristan]# </code><strong class="userinput"><code>netstat -rnC</code></strong>
<code class="computeroutput">Kernel IP routing cache
Source          Destination     Gateway         Flags   MSS Window  irtt Iface
194.52.197.133  192.168.99.35   192.168.99.35     l      40 0          0 lo
192.168.99.35   194.52.197.133  192.168.99.254         1500 0         29 eth0
192.168.99.35   192.168.99.254  192.168.99.254         1500 0          0 eth0
192.168.99.254  192.168.99.35   192.168.99.35     il     40 0          0 lo
192.168.99.35   192.168.99.35   192.168.99.35     l   16436 0          0 lo
192.168.99.35   194.52.197.133  192.168.99.254         1500 0          0 eth0
192.168.99.35   192.168.99.254  192.168.99.254         1500 0          0 eth0</code>
          </pre></div></div><br class="example-break"><p>
          Consult <a class="xref" href="#tools-route-show" title="1.1. Displaying the routing table with route">Section 1.1, &#8220;Displaying the routing table with <span class="command"><strong>route</strong></span>&#8221;</a> for more detail on
          reading and interpreting the data in this output.  Because this is
          simply another way of reporting the routing table information, we'll
          skip over any detailed description.
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-netstat-interface"></a>4.3. Displaying network interface statistics with
          <span class="command"><strong>netstat</strong></span> command</h3></div></div></div><a class="indexterm" name="idm6277"></a><p>
          <span class="command"><strong>netstat -i</strong></span> summarizes interface statistics in a
          terse format.  This format 
        </p><p>
        </p><p>
        </p><p>
        </p><p>
          OK!  This is strange.  <span class="command"><strong>netstat -ie</strong></span> looks exactly
          like <span class="command"><strong>ifconfig</strong></span> output.  That's weird!
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-netstat-statistics"></a>4.4. Displaying network stack statistics with
          <span class="command"><strong>netstat</strong></span></h3></div></div></div><a class="indexterm" name="idm6294"></a><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-netstat-masquerade"></a>4.5. Displaying the masquerading table with
          <span class="command"><strong>netstat</strong></span></h3></div></div></div><a class="indexterm" name="idm6305"></a><p>
          For machines which perform masquerading, typically dual-homed
          packet-filtering firewalls like <code class="systemitem">masq-gw</code> a tool to list the current
          state of the masquerading table is convenient.
        </p><p>
          Each masqueraded connection can be described by a tuple of six
          pieces of data:  the source IP and source port, the destination IP
          and destination port, and the (usually implicit) locally hosted IP
          and a local port.
        </p><div class="example"><a name="ex-tools-netstat-masquerade"></a><p class="title"><b>Example G.15. Displaying the masquerading table with <span class="command">netstat</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code>netstat -Mn</code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><p>
          FIXME; this command seems to fail on all of the iptables boxen, even
          if I'm using the <code class="option">-j MASQUERADE</code> target.  I
          can use it successfully on ipchains boxen.  Anybody have any ideas
          or explanation here?
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-tcpdump"></a>5. <span class="command"><strong>tcpdump</strong></span></h2></div></div></div><p>
        The <span class="command"><strong>tcpdump</strong></span> utility is a not as friendly as some
        other network diagnostic tools.  Some of the output is 
      </p><p>
      </p><p>
        This is a good time to mention that tcpdump can capture and store
        packet flows for consumption at a later date.  Frequently, you may
        find yourself without a top-notch packet analysis utility such as
        <a class="ulink" href="http://www.ethereal.com/" target="_top"><span class="command"><strong>ethereal</strong></span></a>.
        Fortunately, you can
        <a class="link" href="#ex-tools-tcpdump-file-write" title="Example G.25. Writing tcpdump data to a file">create tcpdump data
        files</a> and view them with a tool such as
        <span class="command"><strong>ethereal</strong></span>.  Even if a stream analysis tool is not
        available, the
        <a class="ulink" href="http://www.ethereal.com/docs/user-guide/" target="_top">documentation
        for <span class="command"><strong>ethereal</strong></span></a> is tremendously helpful in
        packet analysis.
      </p><p>
        
      </p><p>
      </p><p>
      </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-arp"></a>5.1. Using <span class="command"><strong>tcpdump</strong></span> to view ARP messages</h3></div></div></div><p>
        </p><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-arp-broadcast"></a><p class="title"><b>Example G.16. Viewing an ARP broadcast request and reply with 
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-arp-gratuitous"></a><p class="title"><b>Example G.17. Viewing a gratuitous ARP packet with 
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-arp-unicast"></a><p class="title"><b>Example G.18. Viewing unicast ARP packets with 
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-unreach"></a>5.2. Using <span class="command"><strong>tcpdump</strong></span> to see ICMP unreachable
          messages</h3></div></div></div><p>
        </p><div class="example"><a name="ex-tools-tcpdump-unreach-port"></a><p class="title"><b>Example G.19. <span class="command">tcpdump</span> reporting port unreachable</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-unreach-host"></a><p class="title"><b>Example G.20. <span class="command">tcpdump</span> reporting host unreachable</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-unreach-net"></a><p class="title"><b>Example G.21. <span class="command">tcpdump</span> reporting net unreachable</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-tcp"></a>5.3. Using <span class="command"><strong>tcpdump</strong></span> to watch TCP sessions</h3></div></div></div><p>
        </p><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-tcp-windows"></a><p class="title"><b>Example G.22. Monitoring TCP window sizes with
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-tcp-flags"></a><p class="title"><b>Example G.23. Examining TCP flags with <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p><div class="example"><a name="ex-tools-tcpdump-tcp-ack"></a><p class="title"><b>Example G.24. Examining TCP acknowledgement numbers with
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-file"></a>5.4. Reading and writing <span class="command"><strong>tcpdump</strong></span> data</h3></div></div></div><p>
        </p><div class="example"><a name="ex-tools-tcpdump-file-write"></a><p class="title"><b>Example G.25. Writing <span class="command">tcpdump</span> data to a file</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><div class="example"><a name="ex-tools-tcpdump-file-read"></a><p class="title"><b>Example G.26. Reading <span class="command">tcpdump</span> data from a file</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><div class="example"><a name="ex-tools-tcpdump-file-line-buffer"></a><p class="title"><b>Example G.27. Causing <span class="command">tcpdump</span> to use a line buffer</b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-frag"></a>5.5. Understanding fragmentation as reported by
          <span class="command"><strong>tcpdump</strong></span></h3></div></div></div><p>
        </p><div class="example"><a name="ex-tools-tcpdump-frag"></a><p class="title"><b>Example G.28. Understanding fragmentation as reported by
            <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tools-tcpdump-other"></a>5.6. Other options to the <span class="command"><strong>tcpdump</strong></span> command</h3></div></div></div><p>
        </p><div class="example"><a name="ex-tools-tcpdump-interface"></a><p class="title"><b>Example G.29. Specifying interface with <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p><div class="example"><a name="ex-tools-tcpdump-timestamp"></a><p class="title"><b>Example G.30. Timestamp related options to <span class="command">tcpdump</span></b></p><div class="example-contents"><pre class="programlisting">
<code class="prompt">[root@masq-gw]# </code><strong class="userinput"><code></code></strong>
<code class="computeroutput">
</code>
          </pre></div></div><br class="example-break"><p>
        </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-tcpflow"></a>6. <span class="command"><strong>tcpflow</strong></span></h2></div></div></div><p>
        FIXME
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-tcpreplay"></a>7. <span class="command"><strong>tcpreplay</strong></span></h2></div></div></div><p>
        FIXME
      </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm5977" class="footnote"><p><a href="#idm5977" class="para"><sup class="para">[59] </sup></a>
              If the admin controls both sides of the link, it is a matter of
              choice and preference whether traffic from the outside IP of the
              peer VPN endpoint should be allowed.  I'll argue that traffic
              from the peer endpoint should not be allowed, but this is
              opinion only.
            </p></div><div id="ftn.idm6096" class="footnote"><p><a href="#idm6096" class="para"><sup class="para">[60] </sup></a>
            Additionally, <span class="command"><strong>netstat</strong></span> can display multicast
            information with the <code class="option">--group</code> switch.  I have zero
            experience here.  Anybody with experience want to write about
            this?
          </p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="tools-misc"></a>Appendix H. Miscellany</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#tools-ipcalc">1. <span class="command"><strong>ipcalc</strong></span> and other IP addressing calculators</a></span></dt><dt><span class="section"><a href="#tools-iproute2-remarks">2. Some general remarks about <span class="command"><strong>iproute2</strong></span> tools</a></span></dt><dt><span class="section"><a href="#tools-sysctl-intro">3. Brief introduction to <span class="command"><strong>sysctl</strong></span></a></span></dt></dl></div><p>
      This appendix is a collection of odds and ends which didn't fit anyplace
      else.  So, consider it a grab-bag of toys, tips, and remarks.  Here,
      you'll find a brief look at some
      <a class="link" href="#tools-ipcalc" title="1. ipcalc and other IP addressing calculators">IP calculators</a> and some
      <a class="link" href="#tools-iproute2-remarks" title="2. Some general remarks about iproute2 tools">general remarks about iproute2
      tools</a>.
    </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-ipcalc"></a>1. <span class="command"><strong>ipcalc</strong></span> and other IP addressing calculators</h2></div></div></div><p>
        There are a number of different utilities called ipcalc, almost all of
        which perform the same basic task.  These are handy calculators for
        converting from CIDR to traditional IP notation and determining network
        and broadcast addresses.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            A short
            <a class="ulink" href="http://packages.debian.org/unstable/net/ipcalc.html" target="_top">perl
            script</a>, this prints out alll the information you would
            want to know about an IP address.  It defaults to print colorized
            output, and comes with its own CGI (shown running
            <a class="ulink" href="http://jodies.de/ipcalc" target="_top">here</a>).
          </p></li><li class="listitem"><p>
            For those who perform all operations and research through a web
            browser, a
            <a class="ulink" href="http://www.hesketh.com/~schampeo/projects/ipcalc/" target="_top">DHTML
            calculator</a> should do the trick.
          </p></li><li class="listitem"><p>
            And here's another 
            <a class="ulink" href="http://www.telusplanet.net/public/sparkman/netcalc.htm" target="_top">IP
            calculator</a>.
          </p></li><li class="listitem"><p>
            You can run this
            <a class="ulink" href="http://www.ajw.com/ipcalc.htm" target="_top">ipcalc</a>,
            which features hexadecimal as well as decimal output, on your PDA.
          </p></li><li class="listitem"><p>
            RedHat has created their own <span class="command"><strong>ipcalc</strong></span> utility
            which prints out a shell variable assignment command instead of
            simply the requested piece of information.  In the startup
            scripts, RedHat evals this variable assignement into existence.
            Despite this shortcoming, it is a useful tool and is documented
            in its manpage (part of the initscripts RPM).
          </p></li></ul></div><p>
        Doubtless, there are a large number of other IP calculators available
        to ease the job of the network administrator.  The above tools are
        meant as a brief summary of some of the offerings.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-iproute2-remarks"></a>2. Some general remarks about <span class="command"><strong>iproute2</strong></span> tools</h2></div></div></div><p>
        This is a meant to be a collected set of thoughts which don't fit
        anyplace else about the <span class="command"><strong>iproute2</strong></span> tools.  If you are
        reading this in search of more details about the
        <span class="command"><strong>iproute2</strong></span> tools, you should run (not walk) to your
        nearest command line, and execute the following command:
        <strong class="userinput"><code>bash -c ' gv $( locate ip-cref.ps ) '</code></strong>.
      </p><p>
        In any case, I suggest that the reader consult the
        documentation which comes with the <span class="command"><strong>iproute2</strong></span>
        package for canonical answers.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The <span class="command"><strong>iproute2</strong></span> suite exposes all of the
            networking functionality of the linux kernel where the venerable
            tools
            (<a class="link" href="#tools-ifconfig" title="1. ifconfig"><span class="command"><strong>ifconfig</strong></span></a>,
            <a class="link" href="#tools-route" title="1. route"><span class="command"><strong>route</strong></span></a>) are
            hamstrung by history.
          </p></li><li class="listitem"><p>
            Each of the <span class="command"><strong>iproute2</strong></span> object names can be
            shortened to the shortest unique set of characters.  This means
            that <span class="command"><strong>ip route show</strong></span> can be abbreviated
            <span class="command"><strong>ip ro s</strong></span> and <span class="command"><strong>ip rule show</strong></span> can
            be abbreviated <span class="command"><strong>ip ru s</strong></span>.  Also <span class="command"><strong>ip
            address show</strong></span> can be <span class="command"><strong>ip a s</strong></span>.  Such
            convenient shortcuts on the command line are often confusing in
            documentation.  For this reason, I have preferred examples
            featuring the complete object names and action verbs.  Note also
            below that <span class="command"><strong>iproute2</strong></span> accepts not only
            abbreviations but also synonyms as described in
            <a class="xref" href="#tb-tools-iproute2-remarks" title="Table H.1. iproute2 Synonyms">Table H.1, &#8220;<span class="command">iproute2</span> Synonyms&#8221;</a>.
          </p></li><li class="listitem"><p>
            There are some syntactic synonyms available within the
            <span class="command"><strong>iproute2</strong></span> package.  See this
            <a class="xref" href="#tb-tools-iproute2-remarks" title="Table H.1. iproute2 Synonyms">Table H.1, &#8220;<span class="command">iproute2</span> Synonyms&#8221;</a> for a complete list
            of synonyms.
          </p></li><li class="listitem"><p>
            Because the <span class="command"><strong>iproute2</strong></span> command suite is under
            development, there may be slight differences between the output
            described in this documentation and that of your release of
            <span class="command"><strong>iproute2</strong></span>.  I have tried to focus on the
            overwhelmingly common uses of the <span class="command"><strong>iproute2</strong></span>
            tools rather than the ones which are under active development, and
            are subject to syntactic changes or new output presentations.
          </p></li><li class="listitem"><p>
            There are extensions to the <span class="command"><strong>iproute2</strong></span> command
            suite, which can alter the sets of objects or syntax
            available for manipulation and inspection.  Where these are
            covered in detail in this documentation, they will be relegated to
            a non-canonical ghetto.  Examples will (someday) include
            <a class="ulink" href="http://www.ssi.bg/~ja/#iparp" target="_top"><span class="command"><strong>ip
            arp</strong></span></a> and <span class="command"><strong>tc</strong></span> extensions.
          </p></li></ul></div><p>
      </p><p>
        There are some common synonyms in <span class="command"><strong>iproute2</strong></span> syntax.
        Outlined below in <a class="xref" href="#tb-tools-iproute2-remarks" title="Table H.1. iproute2 Synonyms">Table H.1, &#8220;<span class="command">iproute2</span> Synonyms&#8221;</a> is a list
        of the common synonyms.  Note, that these synonyms are available in
        addition to the abbreviations indicated above.
      </p><div class="table"><a name="tb-tools-iproute2-remarks"></a><p class="title"><b>Table H.1. <span class="command">iproute2</span> Synonyms</b></p><div class="table-contents"><table class="table" summary="iproute2 Synonyms" border="1"><colgroup><col><col></colgroup><thead><tr><th align="center">Command Variant</th><th align="center">Synonyms</th></tr></thead><tbody><tr><td align="center"><span class="command"><strong>ip neighbor</strong></span></td><td align="center"><span class="command"><strong>ip neighbour</strong></span></td></tr><tr><td align="center"><span class="command"><strong>ip tunnel</strong></span></td><td align="center"><span class="command"><strong>ip tunl</strong></span></td></tr><tr><td align="center"><span class="command"><strong>ip OBJECT show</strong></span></td><td align="center"><span class="command"><strong>ip OBJECT ls</strong></span>,
                       <span class="command"><strong>ip OBJECT list</strong></span></td></tr><tr><td align="center"><span class="command"><strong>ip OBJECT change</strong></span></td><td align="center"><span class="command"><strong>ip OBJECT chg</strong></span>,
                       <span class="command"><strong>ip OBJECT replace</strong></span></td></tr></tbody></table></div></div><br class="table-break"><p>
        Because the <span class="command"><strong>iproute2</strong></span> suite of tools is so tightly
        integrated with linux, it is not available for other operating
        systems.  This is at once its strength and weakness.  For users
        contemplating linux for the first time, <span class="command"><strong>ifconfig</strong></span>,
        <span class="command"><strong>netstat</strong></span>, and <span class="command"><strong>route</strong></span> are familiar
        and they feel intuitive.  More experienced users and control freaks
        will find the <span class="command"><strong>iproute2</strong></span> tools attractive and perhaps
        indispensable.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tools-sysctl-intro"></a>3. Brief introduction to <span class="command"><strong>sysctl</strong></span></h2></div></div></div><p>
        Many behaviours of the linux kernel can be modified through the use of
        run time variables.  These variables can be changed manually or with
        the use of a convenient command line utility.  Most linux
        distributions also include a standard configuration file which can
        store these parameters for use at boot time.
      </p><p>
        For a deeper reference into the matter and use of
        <span class="command"><strong>sysctl</strong></span> see
        <a class="ulink" href="http://ipsysctl-tutorial.frozentux.net/" target="_top">the IP Sysctl
        tutorial</a>, maintained by Oskar Andreasson.
      </p><p>
      </p><p>
      </p></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="ax-links"></a>Appendix I. Links to other Resources</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#links-doc">1. Links to Documentation</a></span></dt><dd><dl><dt><span class="section"><a href="#links-general-linux">1.1. Linux Networking Introduction and Overview Material</a></span></dt><dt><span class="section"><a href="#links-linux-security">1.2. Linux Security and Network Security</a></span></dt><dt><span class="section"><a href="#links-general-ip">1.3. General IP Networking Resources</a></span></dt><dt><span class="section"><a href="#links-masq">1.4. Masquerading topics</a></span></dt><dt><span class="section"><a href="#links-nat">1.5. Network Address Translation</a></span></dt><dt><span class="section"><a href="#links-iproute2">1.6. iproute2 documentation</a></span></dt><dt><span class="section"><a href="#links-netfilter">1.7. Netfilter Resources</a></span></dt><dt><span class="section"><a href="#links-ipchains">1.8. <span class="command"><strong>ipchains</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-ipfwadm">1.9. <span class="command"><strong>ipfwadm</strong></span> Resources</a></span></dt><dt><span class="section"><a href="#links-systems">1.10. General Systems References</a></span></dt><dt><span class="section"><a href="#links-bridging">1.11. Bridging</a></span></dt><dt><span class="section"><a href="#links-tc">1.12. Traffic Control</a></span></dt><dt><span class="section"><a href="#links-multicast">1.13. IPv4 Multicast</a></span></dt><dt><span class="section"><a href="#links-misc">1.14. Miscellaneous Linux IP Resources</a></span></dt></dl></dd><dt><span class="section"><a href="#links-software">2. Links to Software</a></span></dt><dd><dl><dt><span class="section"><a href="#idm6929">2.1. Basic Utilities</a></span></dt><dt><span class="section"><a href="#idm6953">2.2. Virtual Private Networking software</a></span></dt><dt><span class="section"><a href="#idm6964">2.3. Traffic Control queueing disciplines and command line tools</a></span></dt><dt><span class="section"><a href="#idm6987">2.4. Interfaces to lower layer tools</a></span></dt><dt><span class="section"><a href="#idm7000">2.5. Packet sniffing and diagnostic tools</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="links-doc"></a>1. Links to Documentation</h2></div></div></div><p>
      This chapter contains 
      some categorized links to various further reading and reference
      materials on many topics in the linux and networking arenas.  Also
      supplied are a number of links to software as well.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-general-linux"></a>1.1. Linux Networking Introduction and Overview Material</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The best first place to go (if you can't find any help on this
            page) is to visit the comprehensive TLDP
            <a class="ulink" href="http://www.tldp.org/HOWTO/HOWTO-INDEX/networking.html" target="_top">archive
            of networking-related documentation</a>.  Here you will find a
            breakdown of the available documentation, organized in a sensible
            way.
          </p></li><li class="listitem"><p>
            The <a class="ulink" href="http://www.tldp.org/LDP/nag2/index.html" target="_top">Linux
            Network Administrator's Guide</a> covers some of the
            same material as this guide.  It additionally covers
            UUCP, SLIP, PPP, NIS, NFS, IPX, email administration, and
            NNTP.  It is an excellent general reference.
          </p></li><li class="listitem"><p>
            The
            <a class="ulink" href="http://www.tldp.org/HOWTO/Net-HOWTO/index.html" target="_top">Networking
            HOWTO</a>
            provides a good overview of most of the networking protocols and
            link layer devices supported under linux,
            though it covers primarily the 2.0 and 2.2 kernels.
          </p></li><li class="listitem"><p>
            Here's one
            <a class="ulink" href="http://eressea.pikus.net/~pikus/plug_firewall/page0.html" target="_top">step-by-step
            tutorial</a> (among many) which shows how to configure a linux
            machine as a router/firewall.  A brief summary rather than a
            thorough explanation, it instructs well by example.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-linux-security"></a>1.2. Linux Security and Network Security</h3></div></div></div><p>
        Linux has been adopted widely as a platform on which to build
        network security devices as a result of its feature set.  Here,
        you'll find links to network security documentation.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The 
            <a class="ulink" href="http://tldp.org/HOWTO/Security-HOWTO/" target="_top">Security
            HOWTO</a> introduces many of the topics that touch on
            securing a linux machine, including many network security topics.
          </p></li><li class="listitem"><p>
            The
            <a class="ulink" href="http://tldp.org/HOWTO/Security-Quickstart-HOWTO/" target="_top">Security
            Quickstart HOWTO</a> is for the impatient.
          </p></li><li class="listitem"><p>
            FIXME
          </p></li><li class="listitem"><p>
            FIXME
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-general-ip"></a>1.3. General IP Networking Resources</h3></div></div></div><p>
          There are a number of resources available to cover a large range
          of IP networking topics.  I have selected a few here, but there
          are many other sources of this information both dead-tree versions
          and Internet documentation.
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            One of the key reference materials for any IP networking shop is
            the seminal
            <a class="ulink" href="http://www.kohala.com/start/" target="_top">work by the late W.
            Richard Stevens</a>.  Three volumes catalog the architecture of
            IP networking and higher layer protocols.
          </p></li><li class="listitem"><p>
            Here is a good introduction to
            <a class="ulink" href="http://www.ralphb.net/IPSubnet/" target="_top">Classless
            Inter Domain
            Routing (CIDR)</a>.  CIDR is a technique employed since the
            mid 1990s to reduce the load on the routing devices employed on
            the Internet.  A beneficial side effect is the simplicity of the
            CIDR addressing notation.  For a CIDR address reference,
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc1878.txt" target="_top">RFC
            1878</a>
            has proven invaluable to me.
          </p></li><li class="listitem"><p>
            Some general IP subnetting and other Internetworking questions are
            answered at
            <a class="ulink" href="http://www.subnetonline.com/" target="_top">SubnetOnline</a>.
            At Cisco's site, you can find a good introduction to
            <a class="ulink" href="http://www.cisco.com/univercd/cc/td/doc/cisintwk/idg4/nd20a.htm" target="_top">subnetting
            an IP space</a>.  Another one-page tutorial introduction to
            subnetting and CIDR networking is available
            <a class="ulink" href="http://www.j51.com/~sshay/tcpip/ip/ip.htm" target="_top">here</a>.
            And don't forget the
            <a class="ulink" href="http://www.linuxpowered.com/HOWTO/mini/IP-Subnetworking.html" target="_top">IP
            subnetting mini-HOWTO</a> from TLDP.
          </p></li><li class="listitem"><p>
            The <a class="ulink" href="http://www.iana.org/" target="_top">Internet Assigned Numbers
            Authority (IANA)</a> has selected a number of IP networks which
            are intended for discretionary use in private networks.
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc1918.txt" target="_top">RFC
            1918</a> outlines the address ranges which are available for
            private use.  Additionally, IANA has posted a <a class="ulink" href="http://www.iana.org/assignments/ipv4-address-space" target="_top">summary</a>
            of the identity of the subdelegates of each of the class A sized
            network address ranges. See also the update to RFC 1918 in
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc3330.txt" target="_top">RFC
            3330</a>
          </p></li><li class="listitem"><p>
            Address Resolution Protocol is used to provide the glue between
            Ethernet link layer information (hardware addresses) and the IP
            layer.  This
            <a class="ulink" href="http://www.erg.abdn.ac.uk/users/gorry/course/inet-pages/arp.html" target="_top">page</a>
            is instructive in ARP.
          </p></li><li class="listitem"><p>
            As discussed in <a class="xref" href="#routing-icmp-mtu" title="10.1. MTU, MSS, and ICMP">Section 10.1, &#8220;MTU, MSS, and ICMP&#8221;</a>, MSS and MTU are
            key matters for IP communication. 
            Path MTU discovery, as discussed in
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc1911.txt" target="_top">RFC
            1911</a>, is used as a way to make most efficient use of
            network resources by detecting the smallest link layer between two
            endpoints and setting the MTU accordingly.  This breaks when ICMP
            is assiduously filtered.  Visit this
            <a class="ulink" href="http://blue-labs.org/howto/mtu-mss.php" target="_top">discussion</a>
            or
            <a class="ulink" href="http://alive.znep.com/~marcs/mtu/" target="_top">this page on
            MTU and MSS</a>, and of course
            <a class="ulink" href="http://lartc.org/howto/lartc.cookbook.mtu-discovery.html" target="_top">LARTC's
            discussion and solution</a>.  For more on the general issue of
            ICMP and what is required see also
            <a class="ulink" href="http://rr.sans.org/audit/more_ICMP.php" target="_top">this SANS
            discussion</a>.  At a Usenix conference in late 2002, the
            issue of
            <a class="ulink" href="http://www.usenix.org/events/lisa02/tech/vanderberg.html" target="_top">MTU
            and MSS</a> prompted the
            <a class="ulink" href="http://home.earthlink.net/~jaymzh666/mss/index.html" target="_top">MSS
            Initiative</a>.  Because this is a widely misunderstood issue,
            there is even a workaround in the RFCs,
            <a class="ulink" href="http://www.isi.edu/in-notes/rfc2923.txt" target="_top">RFC
            2923</a>.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-masq"></a>1.4. Masquerading topics</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The Linux Documentation Project keeps a clear and up to date
            reference on
            <a class="ulink" href="http://www.tldp.org/HOWTO/IP-Masquerade-HOWTO/" target="_top">IP
            masquerading</a> which thoroughly covers the issues involved
            with masquerading.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-nat"></a>1.5. Network Address Translation</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            If you have a 2.4 kernel and are using <span class="command"><strong>iptables</strong></span>,
            you should read Rusty Russell's documentation on
            <a class="ulink" href="http://www.netfilter.org/unreliable-guides/NAT-HOWTO/NAT-HOWTO.linuxdoc.html" target="_top">NAT</a>
            with netfilter.
          </p></li><li class="listitem"><p>
            The command reference for the iproute2 tools provides sparse
            documentation of the NAT features, but has an
            <a class="ulink" href="http://linux-ip.net/gl/ip-cref/node157.html" target="_top">appendix</a>
            which covers the key questions with regard to iproute2 NAT.
          </p></li><li class="listitem"><p>
            SuSe has Michael Hasenstein's
            <a class="ulink" href="http://www.suse.de/~mha/linux-ip-nat/diplom/nat.html" target="_top">paper</a>
            on NAT, which is an excellent technical overview of the case for
            NAT.
          </p></li><li class="listitem"><p>
            Linas Vepstas has collected a number of
            <a class="ulink" href="http://www.linas.org/linux/load.html" target="_top">links to
            projects and implementations relying heavily on NAT</a>
            techniques.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-iproute2"></a>1.6. iproute2 documentation</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Timur A. Bolokhov has written a good (though dated)
            <a class="ulink" href="http://snafu.freedom.org/linux2.2/docs/advanced-routing/" target="_top">introduction</a>.
            to the policy routing features of iproute2 (supported by
            kernels 2.1 and later).
          </p></li><li class="listitem"><p>
            Mark Lamb hosts a good
            <a class="ulink" href="http://snafu.freedom.org/linux2.2/iproute-notes.html" target="_top">technical 
            overview</a> of both the iproute2 and tc packages.
          </p></li><li class="listitem"><p>
            If your copy of <span class="command"><strong>iproute2</strong></span> did not get packaged
            with <code class="filename">ip-cref.ps</code> or if you prefer online HTML,
            the command reference is available
            <span class="foreignphrase"><em class="foreignphrase">in toto</em></span> as HTML at
            <a class="ulink" href="http://linux-ip.net/gl/ip-cref/" target="_top">linux-ip.net</a>,
            <a class="ulink" href="http://www.linuxgrill.com/iproute2.doc.html" target="_top">www.linuxgrill.com</a>,
            or
            <a class="ulink" href="http://snafu.freedom.org/linux2.2/docs/ip-cref/ip-cref.html" target="_top">snafu.freedom.org</a>.
          </p></li><li class="listitem"><p>
            Julian Anastasov has been working on many aspects of traffic
            control and advanced routing with the <span class="command"><strong>iproute2</strong></span>
            package.  He has provided a large number of patches to
            <span class="command"><strong>iproute2</strong></span> and some documentation with
            for the linux virtual server (LVS) in addition to a great deal of
            code for LVS.  See his <a class="ulink" href="http://www.ssi.bg/~ja/" target="_top">main
            site</a> for both patches and documentation.
          </p></li><li class="listitem"><p>
            The
            <a class="ulink" href="http://lartc.org/" target="_top">Linux Advanced Routing and
            Traffic Control</a> site provides a wealth of expertise
            for complex networking configurations.
            I also recommend the LARTC
            <a class="ulink" href="http://mailman.ds9a.nl/mailman/listinfo/lartc" target="_top">mailing
            list</a> and
            <a class="ulink" href="http://mailman.ds9a.nl/pipermail/lartc/" target="_top">archive</a>.
          </p></li><li class="listitem"><p>
            A brief article distilled from Matthew Marsh's Policy Routing with
            Linux book, introduces the concepts of 
            <a class="ulink" href="http://www.unixreview.com/documents/s=1383/urmb16/" target="_top">policy
            routing under linux</a> quite admirably.  For a fifteen minute
            overview of policy routing under linux, read this article.
          </p></li><li class="listitem"><p>
            See this brief article on describing
            <a class="ulink" href="http://www.samag.com/documents/s=1824/sam0201h/0201h.htm" target="_top">advanced
            networking</a> features of linux.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-netfilter"></a>1.7. Netfilter Resources</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Visit
            <a class="ulink" href="http://iptables-tutorial.frozentux.net" target="_top">Oskar
            Andreasson's iptables tutorial</a> for examples, overview,
            details, and  full documentation of <span class="command"><strong>iptables</strong></span>.
          </p></li><li class="listitem"><p>
            The
            <a class="ulink" href="http://www.netfilter.org/" target="_top">netfilter site</a>
            provides a wealth of tutorials, examples, documentation, and a
            mailing list.  Of particular interest is the
            <a class="ulink" href="http://www.netfilter.org/documentation/" target="_top">documentation
            section</a>.
          </p></li><li class="listitem"><p>
            See this
            <a class="ulink" href="http://www.knowplace.org/netfilter/" target="_top">brief
            introduction</a> to packet filtering with
            <span class="command"><strong>iptables</strong></span>. 
          </p></li><li class="listitem"><p>
            Here is a brief summary of the
            <a class="ulink" href="http://logi.cc/linux/netfilter-log-format.php3#IPheader" target="_top">logging
            
            output</a> form from the netfilter engine.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-ipchains"></a>1.8. <span class="command"><strong>ipchains</strong></span> Resources</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <a class="ulink" href="http://www.netfilter.org/ipchains/" target="_top">Documentation
            for <span class="command"><strong>ipchains</strong></span></a> is available courtesy of
            the author, Rusty Russell.  A mirror of the
            <a class="ulink" href="http://www.tldp.org/HOWTO/IPCHAINS-HOWTO.html" target="_top"><span class="command"><strong>ipchains</strong></span>
            HOWTO</a> is available at TLDP.
          </p></li><li class="listitem"><p>
            Here is a brief summary of
            <a class="ulink" href="http://logi.cc/linux/ipchains-log-format.php3" target="_top">logging
            output</a>from the kernel.
          </p></li><li class="listitem"><p>
            Along with a huge pile of other linux-related traffic control and
            packet filtering documentation, there is a 
            <a class="ulink" href="http://snafu.freedom.org/linux2.2/docs/ipchains-refcard.letter.ps" target="_top">postscript
            reference card for <span class="command"><strong>ipchains</strong></span></a> at
            snafu.freedom.org.
          </p></li><li class="listitem"><p>
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-ipfwadm"></a>1.9. <span class="command"><strong>ipfwadm</strong></span> Resources</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Not covered in this documentation, <span class="command"><strong>ipfwadm</strong></span> is
            only supported in the linux 2.2 and 2.4 kernels via backward
            compatible interfaces to the internal packet filtering
            architectures.  Read more on <span class="command"><strong>ipfwadm</strong></span>
            <a class="ulink" href="http://www.xos.nl/linux/ipfwadm/paper/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-systems"></a>1.10. General Systems References</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            To learn how to
            <a class="ulink" href="http://www.tldp.org/HOWTO/Querying-libiptc-HOWTO/" target="_top">query
            the kernel's iptables</a> directly, you need this progamming
            reference.
          </p></li><li class="listitem"><p>
            For a description of the
            <a class="ulink" href="http://www.gnumonks.org/ftp/pub/doc/packet-journey-2.4.html" target="_top">path
            a frame on the wire takes</a> through the kernel from
            the Ethernet through to the upper layers, Harald Welte's
            brief proves instructive.
          </p></li><li class="listitem"><p>
            If you are only interested in the path an IP packet takes
            through the netfilter (ipchains or iptables), routing and
            ingress/egress QoS code, refer to Stef Coene's excellent
            ASCII representation, the
            <a class="ulink" href="http://www.docum.org/stef.coene/qos/kptd/" target="_top">kernel
            2.4 packet traveling diagram</a>.
          </p></li><li class="listitem"><p>
            Oskar Andreasson (of
            <a class="ulink" href="http://iptables-tutorial.frozentux.net/" target="_top">iptables
            tutorial</a> fame) has written an
            <a class="ulink" href="http://ipsysctl-tutorial.frozentux.net/" target="_top">IP sysctl
            tutorial</a> which covers the different
            <code class="filename">/proc</code> filesystem entries. (kernel 2.4 only)
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-bridging"></a>1.11. Bridging</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Your linux box can function as a bridge, and two boxen connected
            to the same hubs can use Spanning Tree Protocol (STP) to protect
            against failure of one or the other.  See the 
            <a class="ulink" href="http://www.tldp.org/HOWTO/BRIDGE-STP-HOWTO/index.html" target="_top">Bridge
            HOWTO</a>.
          </p></li><li class="listitem"><p>
            For a brief article on using a linux bridge as a firewall see
            <a class="ulink" href="http://www.sparkle-cc.co.uk/firewall/firewall.html" target="_top">David
            Whitmarsh's introduction</a> to the topic.
          </p></li><li class="listitem"><p>
            There's some fledgling documentation of the bridging code in kernel
            2.4 (and 2.2) available, especially in conjunction with netfilter
            <a class="ulink" href="http://bridge.sourceforge.net/docs/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            Consider also,
            <a class="ulink" href="http://users.pandora.be/bart.de.schuymer/ebtables/" target="_top">ebtables</a>
            named by analogy to iptables.  If you are bridging at all, or using
            ebtables at all, you'll want to know about the interaction between
            bridging and iptables, so visit the
            <a class="ulink" href="http://www.tldp.org/HOWTO/Ethernet-Bridge-netfilter-HOWTO.html" target="_top">bridge
            and Netfilter HOWTO</a>.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-tc"></a>1.12. Traffic Control</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The
            <a class="ulink" href="http://lartc.org/" target="_top">Linux Advanced Routing and Traffic
            Control</a> website is the first place to go for any traffic
            control (and advanced routing) documentation.
            I also recommend the LARTC
            <a class="ulink" href="http://mailman.ds9a.nl/mailman/listinfo/lartc" target="_top">mailing
            list</a> and
            <a class="ulink" href="http://mailman.ds9a.nl/pipermail/lartc/" target="_top">archive</a>.
          </p></li><li class="listitem"><p>
            Stef Coene has written prodigiously on
            <a class="ulink" href="http://www.docum.org/" target="_top">traffic control under
            linux</a>.  His site contains practical guidance on traffic
            control and bandwidth shaping matters.
          </p></li><li class="listitem"><p>
            There is an
            <a class="ulink" href="http://www.tldp.org/HOWTO/ADSL-Bandwidth-Management-HOWTO/" target="_top">ADSL
            Bandwidth Management HOWTO</a> on TLDP.
          </p></li><li class="listitem"><p>
            Michael Babcock has a page discussing
            <a class="ulink" href="http://www.fibrespeed.net/~mbabcock/linux/qos_tc/" target="_top">QoS
            on linux</a>.  This is a good introduction, though a bit dated
            (it seems to discuss only kernel 2.2).
          </p></li><li class="listitem"><p>
            Leonardo Balliache's has published a brief overview of the
            <a class="ulink" href="http://www.opalsoft.net/qos/" target="_top">compared QoS
            offerings</a>.
          </p></li><li class="listitem"><p>
          </p></li><li class="listitem"><p>
            Sally Floyd is apparently one of the leading researchers in the
            use of QoS on the Internet.  See her work as a researcher at
            <a class="ulink" href="http://www.icir.org/floyd/" target="_top">icir.org</a>.
          </p></li><li class="listitem"><p>
            Another major research center for QoS under linux is the
            University of Kansas.  For some very technical material on QoS
            under linux, see their
            <a class="ulink" href="http://qos.ittc.ukans.edu/" target="_top">main page</a>.  Here
            you will find some documentation of the tools available to those
            programming for QoS implementations under linux.
          </p></li><li class="listitem"><p>
            An implementation of
            <a class="ulink" href="http://diffserv.sourceforge.net/" target="_top">DiffServ</a>,
            is underway under linux.  DiffServ is an intermediate step to
            IntServ.  There are also the
            <a class="ulink" href="http://www.atm.tut.fi/list-archive/linux-diffserv/thrd6.html" target="_top">old
            DiffServ archive</a> and the 
            <a class="ulink" href="http://sourceforge.net/mailarchive/forum.php?forum=diffserv-general" target="_top">current
            archive</a>.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-multicast"></a>1.13. IPv4 Multicast</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            A dated
            <a class="ulink" href="http://jukie.net/~bart/multicast/Linux-Mrouted-MiniHOWTO.html" target="_top">multicast
            routing mini-HOWTO</a> provides the best introduction to
            multicast routing under linux.
          </p></li><li class="listitem"><p>
            The
            <a class="ulink" href="http://www.cschill.de/smcroute/" target="_top"><span class="command"><strong>smcroute</strong></span></a>
            utility provides a command line interface to manipulate the
            multicast routing tables via a method other than
            <span class="command"><strong>mrouted</strong></span>.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="links-misc"></a>1.14. Miscellaneous Linux IP Resources</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The <span class="command"><strong>sysctl</strong></span> utility is a convenient tool for
            manipulating kernel parameters.  Combined with the
            <code class="filename">/etc/sysctl.conf</code> this utility allows an
            administrator to alter or tune kernel parameters in a convenient
            fashion across a reboot.  See this
            <a class="ulink" href="http://www.redhat.com/docs/manuals/linux/RHL-7.3-Manual/ref-guide/s1-proc-sysctl.html" target="_top">brief
            RedHat page on the use of <span class="command"><strong>sysctl</strong></span></a>.  See
            also
            <a class="ulink" href="http://ipsysctl-tutorial.frozentux.net/" target="_top">Oskar
            Andreasson's IP Sysctl Tutorial</a> for a detailed examination
            of the parameters and their affect on system operation.
          </p></li><li class="listitem"><p>
            For users who need to provide a standards compliant VPN solution
            <a class="ulink" href="http://www.freeswan.org/" target="_top">FreeS/WAN</a> can be
            part of a good interoperable solution.  Additionally, there are
            issues with using FreeS/WAN on linux as a VPN solution.  John
            Denker (appropriate last name) has grappled with the issue of 
            <a class="ulink" href="http://www.quintillion.com/moat/ipsec+routing/iproute2.html" target="_top">IPSec
            and routing</a> and has suggested the following
            <a class="ulink" href="http://www.quintillion.com/moat/ipsec+routing/iproute2.html" target="_top">work
            around</a>.  Here's a
            <a class="ulink" href="http://www.quintillion.com/fdis/moat/index.html" target="_top">summary
            of one network admin's perspective</a>
            on some of the issues related to FreeS/WAN, roving users and
            network administration for VPN users.  Note!  The 2.5.x
            development kernel contains an IPSec implementation natively.
            This means that by the release of 2.6.x, linux may support IPSec
            out of the box.
          </p></li><li class="listitem"><p>
            <a class="ulink" href="http://www.icir.org/floyd/ecn.html" target="_top">Explicit
            Congestion Notification</a> is supported under linux kernel
            2.4 with a sysctl entry.
          </p></li><li class="listitem"><p>
            The 2.2 and 2.4 series support bonding of interfaces which allows
            both link aggregation (IEEE 802.3ad) and failover use of Ethernet
            interfaces.  The canonical source for documentation about bonding
            is <code class="filename">Documentation/networking/bonding.txt</code> in
            the kernel source distribution.
          </p></li><li class="listitem"><p>
            If you are looking for virtual router redundancy protocol
            (VRRP) support under linux, there are several fledgling options.
            The 
            <a class="ulink" href="http://w3.arobas.net/~jetienne/vrrpd/" target="_top">reference
            implementation</a> is (according to LARTC scuttlebut) mostly a
            proof of concpt endeavor.  At least one other implementation is
            available for linux--and this one has the reputation of being
            more practical:
            <a class="ulink" href="http://www.keepalived.org/" target="_top">keepalived</a>.
          </p></li><li class="listitem"><p>
            If you want your linux box to support 802.1q VLAN tagging,
            you should read up on
            <a class="ulink" href="http://www.candelatech.com/~greear/vlan.html" target="_top">Ben
            Greear's site</a>.
          </p></li><li class="listitem"><p>
            Don't forget the value of looking for the answer to your question
            in the linux-net
            <a class="ulink" href="http://www.uwsg.indiana.edu/hypermail/linux/net/" target="_top">mailing
            list archive</a>.
          </p></li><li class="listitem"><p>
            Linux Journal has published a two part article on by Gianluca
            Insolvibile describing the path a packet takes through the kernel.
            Part I covers
            <a class="ulink" href="http://www.linuxjournal.com/article.php?sid=4852" target="_top">the
            input of the packet until just before layer 4 processing</a>.
            Part II covers
            <a class="ulink" href="http://www.linuxjournal.com/article.php?sid=5617" target="_top">higher
            layer packet handling</a>, including
            <a class="ulink" href="http://www.linuxjournal.com/modules/NS-lj-issues/issue95/5617f1.png" target="_top">simple
            diagram of the kernel's decisions for each IP packet</a>.
          </p></li><li class="listitem"><p>
            This 
            <a class="ulink" href="http://www.linux-kongress.org/2002/papers/lk2002-heuven.pdf" target="_top">PDF
            from the linux-kongress</a> introduces some plans for MPLS and
            RSVP support under linux.  (There are also
            <a class="ulink" href="http://www.linux-kongress.org/2002/papers/" target="_top">many other
            interesting papers</a> available here.)  Another (the same?)
            <a class="ulink" href="http://mpls-linux.sourceforge.net/" target="_top">MPLS
            implementation</a> is available from SourceForge.
          </p></li><li class="listitem"><p>
            A clearly written but probably quite dated
            <a class="ulink" href="http://www.tldp.org/LDP/tlk/net/net.html" target="_top">introduction</a>
            in English to the kernel networking code was written by David
            Rusling.  (An update/replacement to this is under development by
            David Rusling, although no URL is available.)
          </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="links-software"></a>2. Links to Software</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm6929"></a>2.1. Basic Utilities</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The <a class="ulink" href="http://www.tazenda.demon.co.uk/phil/net-tools/" target="_top">net-tools</a>
            package is a collection of basic utilities for managing the
            Ethernet and IP layer under linux.
          </p></li><li class="listitem"><p>
            The <span class="command"><strong>iproute2</strong></span> package provides command-line
            support for the full functionality of the linux IP stack.  This
            package, written by Alexey Kuznetsov, is available
            <a class="ulink" href="ftp://ftp.inr.ac.ru/ip-routing/" target="_top">here</a> and is
            mirrored
            <a class="ulink" href="http://www.linuxgrill.com/anonymous/fire/alexey/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            A tool more convenient than <span class="command"><strong>traceroute</strong></span> for
            tracing routes, <a class="ulink" href="http://www.bitwizard.nl/mtr/" target="_top"><span class="command"><strong>mtr</strong></span></a>
            can be obtained
            <a class="ulink" href="ftp://ftp.bitwizard.nl/mtr/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            The network swiss army knife of <a class="ulink" href="http://www.atstake.com/research/tools/index.html#network_utilities" target="_top"><span class="command"><strong>nc</strong></span>
            (NetCat)</a> is available from @stake.
          </p></li><li class="listitem"><p>
            For a far more flexible tool in the same vein as nc, 
            <a class="ulink" href="http://www.dest-unreach.org/socat/" target="_top">socat</a>
            connects all manner of files, sockets, and file descriptors under
            most types of unix.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm6953"></a>2.2. Virtual Private Networking software</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <a class="ulink" href="http://sites.inka.de/sites/bigred/devel/cipe.html" target="_top">CIPE</a>
            is a lightweight nonstandard VPN technology which can use
            shared secrets or RSA keys.  CIPE is developed primarily for linux
            but includes a Windows port.
          </p></li><li class="listitem"><p>
            For a standards based VPN technology,
            <a class="ulink" href="http://www.freeswan.org/download.html" target="_top">FreeS/WAN</a>
            provides IPSec functionality for the linux kernel.  If you need an
            SRPM of the FreeSWAN IPSec software, get it
            <a class="ulink" href="http://www.sandelman.ottawa.on.ca/freeswan/rpm/" target="_top">here</a>.
            Note that development kernel 2.5.47+ contains kernel-native
            support for IPSec.  Refer to the
            <a class="ulink" href="http://lartc.org/howto/lartc.ipsec.html" target="_top">LARTC IPSec
            documentation</a> for more on this.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm6964"></a>2.3. Traffic Control queueing disciplines and command line tools</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Martin Devera has written a
            <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/" target="_top">queueing
            discipline called HTB</a> which has been incorporated into the
            2.4.20 kernel series.  As of this writing, HTBv3 is included in
            kernel 2.4.20+, but <span class="command"><strong>tc</strong></span> doesn't support htb
            without the patch available
            <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/v3/htb3.6-020525.tgz" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            Weighted Round Robin is a queueing discipline which distributes
            bandwidth among the multiple open connections.  Although the wrr
            qdisc is not included in the kernel, it is available
            <a class="ulink" href="http://wipl-wrr.sourceforge.net/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            Patrick McHardy has written a device which can be used independent
            of interface to perform traffic shaping.  The
            <a class="ulink" href="http://trash.net/~kaber/imq/" target="_top">Intermediate
            Queueing Device (IMQ)</a> is supported under kernel 2.4 and
            provides support for ingress shaping and traffic shaping over
            multiple physical devices.  (Site was available
            <a class="ulink" href="http://luxik.cdi.cz/~patrick/imq/" target="_top">here</a>.)
          </p></li><li class="listitem"><p>
            Werner Almesberger is working on a more user friendly traffic
            control front end called
            <a class="ulink" href="http://tcng.sourceforge.net/" target="_top">tcng</a>.  This
            package includes a userspace simulator <span class="command"><strong>tcsim</strong></span>.
          </p></li><li class="listitem"><p>
            DiffServ
          </p></li><li class="listitem"><p>
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm6987"></a>2.4. Interfaces to lower layer tools</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            A collection of various scripts and other interfaces for netfilter
            is available
            <a class="ulink" href="http://www.linuxguruz.org/iptables/" target="_top">here</a>.
          </p></li><li class="listitem"><p>
            A curses-based tool
            <a class="ulink" href="http://users.pandora.be/stes/ipmenu.html" target="_top">ipmenu</a>
            provides a single uniform interface to many of the IP layer
            features of linux.
          </p></li><li class="listitem"><p>
          </p></li><li class="listitem"><p>
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm7000"></a>2.5. Packet sniffing and diagnostic tools</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The <a class="ulink" href="http://www.tcpdump.org/" target="_top">tcpdump</a> utility
            is a well known cross-platform utility for sniffing traffic on
            the wire.
          </p></li><li class="listitem"><p>
            To watch plaintext protocol conversations, the
            <a class="ulink" href="http://www.circlemud.org/~jelson/software/tcpflow/" target="_top">tcpflow</a>
            tool can be invaluable.
          </p></li><li class="listitem"><p>
            To gather data on the nature and quality of the network path
            between two points, the 
            <a class="ulink" href="http://www.cnam.fr/reseau/bing.html" target="_top"><span class="command"><strong>bing</strong></span></a>
            program provides a running set of statistics by calculating
            the delta between ICMP echo replies from different hosts.
          </p></li><li class="listitem"><p>
            To help diagnose problems between network points, the
            <a class="ulink" href="http://www.caida.org/tools/utilities/others/pathchar/" target="_top"><span class="command"><strong>pathchar</strong></span></a>
            tool can be handy.  Unfortunately, it only comes in a binary
            release, apparently because Van Jacobsen did not feel it was
            ready for full release.
          </p></li><li class="listitem"><p>
            
          </p></li><li class="listitem"><p>
            Among the sniffing and spoofing tools,
            <a class="ulink" href="http://monkey.org/~dugsong/dsniff/" target="_top">dsniff</a>
            has received good press.  It is a collection of tools for
            network auditing and penetration testing.
          </p></li><li class="listitem"><p>
            If you need to capture and reinject packets into the network,
            <a class="ulink" href="http://www.packetfactory.net/Projects/Libnet/" target="_top">libnet</a>
            is a library you can use for these purposes.  This is a diagnostic
            and security tool.
          </p></li><li class="listitem"><p>
            To reproduce traffic from a captured file, use
            <a class="ulink" href="http://tcpreplay.sourceforge.net/" target="_top">tcpreplay</a>.
          </p></li></ul></div></div></div></div><div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="gfdl"></a>Appendix J. GNU Free Documentation License</h2></div><div><h3 class="subtitle"><i>Version 1.2, November 2002</i></h3></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#gfdl-0">1. PREAMBLE</a></span></dt><dt><span class="section"><a href="#gfdl-1">2. APPLICABILITY AND DEFINITIONS</a></span></dt><dt><span class="section"><a href="#gfdl-2">3. VERBATIM COPYING</a></span></dt><dt><span class="section"><a href="#gfdl-3">4. COPYING IN QUANTITY</a></span></dt><dt><span class="section"><a href="#gfdl-4">5. MODIFICATIONS</a></span></dt><dt><span class="section"><a href="#gfdl-5">6. COMBINING DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-6">7. COLLECTIONS OF DOCUMENTS</a></span></dt><dt><span class="section"><a href="#gfdl-7">8. AGGREGATION WITH INDEPENDENT WORKS</a></span></dt><dt><span class="section"><a href="#gfdl-8">9. TRANSLATION</a></span></dt><dt><span class="section"><a href="#gfdl-9">10. TERMINATION</a></span></dt><dt><span class="section"><a href="#gfdl-10">11. FUTURE REVISIONS OF THIS LICENSE</a></span></dt><dt><span class="section"><a href="#gfdl-addendum">12. ADDENDUM: How to use this License for
  your documents</a></span></dt></dl></div><div class="blockquote"><a name="fsf-copyright"></a><blockquote class="blockquote"><p>Copyright (C) 2000,2001,2002  Free Software Foundation, Inc.
59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
Everyone is permitted to copy and distribute verbatim copies
of this license document, but changing it is not allowed.</p></blockquote></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-0"></a>1. PREAMBLE</h2></div></div></div><p>The purpose of this License is to make a manual, textbook, or
other functional and useful document "free" in the sense of freedom: to
assure everyone the effective freedom to copy and redistribute it, with
or without modifying it, either commercially or noncommercially.
Secondarily, this License preserves for the author and publisher a way
to get credit for their work, while not being considered responsible for
modifications made by others.</p><p>This License is a kind of "copyleft", which means that derivative
works of the document must themselves be free in the same sense.  It
complements the GNU General Public License, which is a copyleft license
designed for free software.</p><p>We have designed this License in order to use it for manuals for
free software, because free software needs free documentation: a free
program should come with manuals providing the same freedoms that the
software does.  But this License is not limited to software manuals; it
can be used for any textual work, regardless of subject matter or
whether it is published as a printed book.  We recommend this License
principally for works whose purpose is instruction or reference.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-1"></a>2. APPLICABILITY AND DEFINITIONS</h2></div></div></div><p><a name="gfdl-doc"></a>This License applies to any manual or other work, in
any medium, that contains a notice placed by the copyright holder saying
it can be distributed under the terms of this License.  Such a notice
grants a world-wide, royalty-free license, unlimited in duration, to use
that work under the conditions stated herein.  The "Document", below,
refers to any such manual or work.  Any member of the public is a
licensee, and is addressed as "you".  You accept the license if you
copy, modify or distribute the work in a way requiring permission under
copyright law.</p><p><a name="gfdl-mod-ver"></a>A "Modified Version" of the Document means any
work containing the Document or a portion of it, either copied verbatim,
or with modifications and/or translated into another language.</p><p><a name="gfdl-secnd-sect"></a>A "Secondary Section" is a named appendix or
a front-matter section of the Document that deals exclusively with the
relationship of the publishers or authors of the Document to the
Document's overall subject (or to related matters) and contains nothing
that could fall directly within that overall subject.  (Thus, if the
Document is in part a textbook of mathematics, a Secondary Section may
not explain any mathematics.)  The relationship could be a matter of
historical connection with the subject or with related matters, or of
legal, commercial, philosophical, ethical or political position
regarding them.</p><p><a name="gfdl-inv-sect"></a>The "Invariant Sections" are certain Secondary
Sections whose titles are designated, as being those of Invariant
Sections, in the notice that says that the Document is released under
this License.  If a section does not fit the above definition of
Secondary then it is not allowed to be designated as Invariant.  The
Document may contain zero Invariant Sections.  If the Document does not
identify any Invariant Sections then there are none.</p><p><a name="gfdl-cov-text"></a>The "Cover Texts" are certain short passages of
text that are listed, as Front-Cover Texts or Back-Cover Texts, in the
notice that says that the Document is released under this License.  A
Front-Cover Text may be at most 5 words, and a Back-Cover Text may be at
most 25 words.</p><p><a name="gfdl-transparent"></a>A "Transparent" copy of the Document means a
machine-readable copy, represented in a format whose specification is
available to the general public, that is suitable for revising the
document straightforwardly with generic text editors or (for images
composed of pixels) generic paint programs or (for drawings) some widely
available drawing editor, and that is suitable for input to text
formatters or for automatic translation to a variety of formats suitable
for input to text formatters.  A copy made in an otherwise Transparent
file format whose markup, or absence of markup, has been arranged to
thwart or discourage subsequent modification by readers is not
Transparent.  An image format is not Transparent if used for any
substantial amount of text.  A copy that is not "Transparent" is called
"Opaque".</p><p>Examples of suitable formats for Transparent copies include plain
ASCII without markup, Texinfo input format, LaTeX input format, SGML or
XML using a publicly available DTD, and standard-conforming simple HTML,
PostScript or PDF designed for human modification.  Examples of
transparent image formats include PNG, XCF and JPG.  Opaque formats
include proprietary formats that can be read and edited only by
proprietary word processors, SGML or XML for which the DTD and/or
processing tools are not generally available, and the machine-generated
HTML, PostScript or PDF produced by some word processors for output
purposes only.</p><p><a name="gfdl-title-page"></a>The "Title Page" means, for a printed book,
the title page itself, plus such following pages as are needed to hold,
legibly, the material this License requires to appear in the title page.
For works in formats which do not have any title page as such, "Title
Page" means the text near the most prominent appearance of the work's
title, preceding the beginning of the body of the text.</p><p><a name="gfdl-entitled"></a>A section "Entitled XYZ" means a named subunit
of the Document whose title either is precisely XYZ or contains XYZ in
parentheses following text that translates XYZ in another language.
(Here XYZ stands for a specific section name mentioned below, such as
"Acknowledgements", "Dedications", "Endorsements", or "History".)  To
"Preserve the Title" of such a section when you modify the Document
means that it remains a section "Entitled XYZ" according to this
definition.</p><p>The Document may include Warranty Disclaimers next to the notice
which states that this License applies to the Document.  These Warranty
Disclaimers are considered to be included by reference in this License,
but only as regards disclaiming warranties: any other implication that
these Warranty Disclaimers may have is void and has no effect on the
meaning of this License.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-2"></a>3. VERBATIM COPYING</h2></div></div></div><p>You may copy and distribute the Document in any medium, either
commercially or noncommercially, provided that this License, the
copyright notices, and the license notice saying this License applies to
the Document are reproduced in all copies, and that you add no other
conditions whatsoever to those of this License.  You may not use
technical measures to obstruct or control the reading or further copying
of the copies you make or distribute.  However, you may accept
compensation in exchange for copies.  If you distribute a large enough
number of copies you must also follow the conditions in section 3.
</p><p>You may also lend copies, under the same conditions stated above,
and you may publicly display copies.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-3"></a>4. COPYING IN QUANTITY</h2></div></div></div><p>If you publish printed copies (or copies in media that commonly
have printed covers) of the Document, numbering more than 100, and the
Document's license notice requires Cover Texts, you must enclose the
copies in covers that carry, clearly and legibly, all these Cover Texts:
Front-Cover Texts on the front cover, and Back-Cover Texts on the back
cover.  Both covers must also clearly and legibly identify you as the
publisher of these copies.  The front cover must present the full title
with all words of the title equally prominent and visible.  You may add
other material on the covers in addition.  Copying with changes limited
to the covers, as long as they preserve the title of the Document and
satisfy these conditions, can be treated as verbatim copying in other
respects.</p><p>If the required texts for either cover are too voluminous to fit
legibly, you should put the first ones listed (as many as fit
reasonably) on the actual cover, and continue the rest onto adjacent
pages.</p><p>If you publish or distribute Opaque copies of the Document
numbering more than 100, you must either include a machine-readable
Transparent copy along with each Opaque copy, or state in or with each
Opaque copy a computer-network location from which the general
network-using public has access to download using public-standard
network protocols a complete Transparent copy of the Document, free of
added material.  If you use the latter option, you must take reasonably
prudent steps, when you begin distribution of Opaque copies in quantity,
to ensure that this Transparent copy will remain thus accessible at the
stated location until at least one year after the last time you
distribute an Opaque copy (directly or through your agents or retailers)
of that edition to the public.</p><p>It is requested, but not required, that you contact the authors of
the Document well before redistributing any large number of copies, to
give them a chance to provide you with an updated version of the
Document.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-4"></a>5. MODIFICATIONS</h2></div></div></div><p>You may copy and distribute a Modified Version of the Document
under the conditions of sections 2 and 3 above, provided that you
release the Modified Version under precisely this License, with the
Modified Version filling the role of the Document, thus licensing
distribution and modification of the Modified Version to whoever
possesses a copy of it.  In addition, you must do these things in the
Modified Version:</p><div class="orderedlist"><a name="gfdl-modif-cond"></a><ol class="orderedlist" type="A"><li class="listitem">Use in the Title Page (and on the covers, if any) a
  title distinct from that of the Document, and from those of previous
  versions (which should, if there were any, be listed in the History
  section of the Document).  You may use the same title as a previous
  version if the original publisher of that version gives permission.
</li><li class="listitem">List on the Title Page, as authors, one or more
  persons or entities responsible for authorship of the modifications in
  the Modified Version, together with at least five of the principal
  authors of the Document (all of its principal authors, if it has fewer
  than five), unless they release you from this requirement.
</li><li class="listitem">State on the Title page the name of the publisher of
  the Modified Version, as the publisher.</li><li class="listitem">Preserve all the copyright notices of the Document.
</li><li class="listitem">Add an appropriate copyright notice for your
  modifications adjacent to the other copyright notices.
</li><li class="listitem">Include, immediately after the copyright notices, a
  license notice giving the public permission to use the Modified
  Version under the terms of this License, in the form shown in the
  <a class="link" href="#gfdl-addendum" title="12. ADDENDUM: How to use this License for your documents">Addendum</a> below.
</li><li class="listitem">Preserve in that license notice the full lists of
  Invariant Sections and required Cover Texts given in the Document's
  license notice.</li><li class="listitem">Include an unaltered copy of this License.
</li><li class="listitem">Preserve the section Entitled "History", Preserve its
  Title, and add to it an item stating at least the title, year, new
  authors, and publisher of the Modified Version as given on the Title
  Page.  If there is no section Entitled "History" in the Document,
  create one stating the title, year, authors, and publisher of the
  Document as given on its Title Page, then add an item describing the
  Modified Version as stated in the previous sentence.
</li><li class="listitem">Preserve the network location, if any, given in the
  Document for public access to a Transparent copy of the Document, and
  likewise the network locations given in the Document for previous
  versions it was based on.  These may be placed in the "History"
  section.  You may omit a network location for a work that was
  published at least four years before the Document itself, or if the
  original publisher of the version it refers to gives permission.
</li><li class="listitem">For any section Entitled "Acknowledgements" or
  "Dedications", Preserve the Title of the section, and preserve in the
  section all the substance and tone of each of the contributor
  acknowledgements and/or dedications given therein.
</li><li class="listitem">Preserve all the Invariant Sections of the Document,
  unaltered in their text and in their titles.  Section numbers or the
  equivalent are not considered part of the section titles.
</li><li class="listitem">Delete any section Entitled "Endorsements".
  Such a section may not be included in the Modified Version.
</li><li class="listitem">Do not retitle any existing section to be Entitled
  "Endorsements" or to conflict in title with any Invariant Section.
</li><li class="listitem">Preserve any Warranty Disclaimers.
</li></ol></div><p>If the Modified Version includes new front-matter sections or
appendices that qualify as Secondary Sections and contain no material
copied from the Document, you may at your option designate some or all
of these sections as invariant.  To do this, add their titles to the
list of Invariant Sections in the Modified Version's license notice.
These titles must be distinct from any other section titles.</p><p>You may add a section Entitled "Endorsements", provided it
contains nothing but endorsements of your Modified Version by various
parties--for example, statements of peer review or that the text has
been approved by an organization as the authoritative definition of a
standard.</p><p>You may add a passage of up to five words as a Front-Cover Text,
and a passage of up to 25 words as a Back-Cover Text, to the end of the
list of Cover Texts in the Modified Version.  Only one passage of
Front-Cover Text and one of Back-Cover Text may be added by (or through
arrangements made by) any one entity.  If the Document already includes
a cover text for the same cover, previously added by you or by
arrangement made by the same entity you are acting on behalf of, you may
not add another; but you may replace the old one, on explicit permission
from the previous publisher that added the old one.</p><p>The author(s) and publisher(s) of the Document do not by this
License give permission to use their names for publicity for or to
assert or imply endorsement of any Modified Version.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-5"></a>6. COMBINING DOCUMENTS</h2></div></div></div><p>You may combine the Document with other documents released under
this License, under the terms defined in <a class="link" href="#gfdl-4" title="5. MODIFICATIONS">section
4</a> above for modified versions, provided that you include in the
combination all of the Invariant Sections of all of the original
documents, unmodified, and list them all as Invariant Sections of your
combined work in its license notice, and that you preserve all their
Warranty Disclaimers.</p><p>The combined work need only contain one copy of this License, and
multiple identical Invariant Sections may be replaced with a single
copy.  If there are multiple Invariant Sections with the same name but
different contents, make the title of each such section unique by adding
at the end of it, in parentheses, the name of the original author or
publisher of that section if known, or else a unique number.  Make the
same adjustment to the section titles in the list of Invariant Sections
in the license notice of the combined work.</p><p>In the combination, you must combine any sections Entitled
"History" in the various original documents, forming one section
Entitled "History"; likewise combine any sections Entitled
"Acknowledgements", and any sections Entitled "Dedications".  You must
delete all sections Entitled "Endorsements".</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-6"></a>7. COLLECTIONS OF DOCUMENTS</h2></div></div></div><p>You may make a collection consisting of the Document and other
documents released under this License, and replace the individual copies
of this License in the various documents with a single copy that is
included in the collection, provided that you follow the rules of this
License for verbatim copying of each of the documents in all other
respects.</p><p>You may extract a single document from such a collection, and
distribute it individually under this License, provided you insert a
copy of this License into the extracted document, and follow this
License in all other respects regarding verbatim copying of that
document.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-7"></a>8. AGGREGATION WITH INDEPENDENT WORKS</h2></div></div></div><p>A compilation of the Document or its derivatives with other
separate and independent documents or works, in or on a volume of a
storage or distribution medium, is called an "aggregate" if the
copyright resulting from the compilation is not used to limit the legal
rights of the compilation's users beyond what the individual works
permit.  When the Document is included an aggregate, this License does
not apply to the other works in the aggregate which are not themselves
derivative works of the Document.</p><p>If the Cover Text requirement of section 3 is applicable to these
copies of the Document, then if the Document is less than one half of
the entire aggregate, the Document's Cover Texts may be placed on covers
that bracket the Document within the aggregate, or the electronic
equivalent of covers if the Document is in electronic form.  Otherwise
they must appear on printed covers that bracket the whole
aggregate.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-8"></a>9. TRANSLATION</h2></div></div></div><p>Translation is considered a kind of modification, so you may
distribute translations of the Document under the terms of section 4.
Replacing Invariant Sections with translations requires special
permission from their copyright holders, but you may include
translations of some or all Invariant Sections in addition to the
original versions of these Invariant Sections.  You may include a
translation of this License, and all the license notices in the
Document, and any Warrany Disclaimers, provided that you also include
the original English version of this License and the original versions
of those notices and disclaimers.  In case of a disagreement between the
translation and the original version of this License or a notice or
disclaimer, the original version will prevail.</p><p>If a section in the Document is Entitled "Acknowledgements",
"Dedications", or "History", the requirement (section 4) to Preserve its
Title (section 1) will typically require changing the actual
title.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-9"></a>10. TERMINATION</h2></div></div></div><p>You may not copy, modify, sublicense, or distribute the Document
except as expressly provided for under this License.  Any other attempt
to copy, modify, sublicense or distribute the Document is void, and will
automatically terminate your rights under this License.  However,
parties who have received copies, or rights, from you under this License
will not have their licenses terminated so long as such parties remain
in full compliance.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-10"></a>11. FUTURE REVISIONS OF THIS LICENSE</h2></div></div></div><p>The Free Software Foundation may publish new, revised versions of
the GNU Free Documentation License from time to time.  Such new versions
will be similar in spirit to the present version, but may differ in
detail to address new problems or concerns.  See
http://www.gnu.org/copyleft/.</p><p>Each version of the License is given a distinguishing version
number.  If the Document specifies that a particular numbered version of
this License "or any later version" applies to it, you have the option
of following the terms and conditions either of that specified version
or of any later version that has been published (not as a draft) by the
Free Software Foundation.  If the Document does not specify a version
number of this License, you may choose any version ever published (not
as a draft) by the Free Software Foundation.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl-addendum"></a>12. ADDENDUM: How to use this License for
  your documents</h2></div></div></div><p>To use this License in a document you have written, include a copy
of the License in the document and put the following copyright and
license notices just after the title page:</p><div class="blockquote"><a name="copyright-sample"></a><blockquote class="blockquote"><p>
    Copyright (c)  YEAR  YOUR NAME.
    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.2
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
</p></blockquote></div><p>If you have Invariant Sections, Front-Cover Texts and Back-Cover
Texts, replace the "with...Texts." line with this:</p><div class="blockquote"><a name="inv-cover-sample"></a><blockquote class="blockquote"><p>
    with the Invariant Sections being LIST THEIR TITLES, with the
    Front-Cover Texts being LIST, and with the Back-Cover Texts being LIST.
</p></blockquote></div><p>If you have Invariant Sections without Cover Texts, or some other
combination of the three, merge those two alternatives to suit the
situation.</p><p>If your document contains nontrivial examples of program code, we
recommend releasing these examples in parallel under your choice of free
software license, such as the GNU General Public License, to permit
their use in free software.</p></div></div></div><div class="bibliography"><div class="titlepage"><div><div><h1 class="title"><a name="biblio"></a>Reference Bibliography and Recommended Reading</h1></div></div></div><div class="biblioentry"><a name="idm7136"></a><p><span class="biblioset"><span class="author"><span class="firstname">Chandra</span> <span class="surname">Kopparapu</span>. </span><span class="copyright">Copyright © 2002 unknown holder (FIXME). </span><span class="isbn">0-471-41550-2. </span><i>Load Balancing Servers, Firewalls, and Caches</i>. <span class="publisher"><span class="publishername">John Wiley &amp; Sons, Inc.. </span></span></span></p></div><div class="biblioentry"><a name="idm7150"></a><p><span class="biblioset"><span class="author"><span class="firstname">W.</span> <span class="othername">Richard</span> <span class="surname">Stevens</span>. </span><span class="copyright">Copyright © 1994 Addison Wesley. </span><span class="isbn">0-201-63346-9 (v.1). </span><i>TCP/IP Illustrated, Volume I</i>. <span class="publisher"><span class="publishername">Addison Wesley. </span></span></span></p></div><div class="biblioentry"><a name="idm7165"></a><p><span class="biblioset"><span class="author"><span class="firstname">Robert</span> <span class="othername">L.</span> <span class="surname">Ziegler</span>. </span><span class="copyright">Copyright © 2001 New Riders. </span><span class="isbn">0-2357-1099-6. </span><i>Linux Firewalls</i>. <span class="publisher"><span class="publishername">New Riders. </span></span><span class="pubdate">2001. </span></span></p></div><div class="biblioentry"><a name="idm7181"></a><p><span class="biblioset"><span class="author"><span class="firstname">Rich</span> <span class="surname">Seifert</span>. </span><span class="copyright">Copyright © 2000 Rich Seifert. </span><span class="isbn">0-471-34586-5. </span><i>The Switch Book</i>. <span class="subtitle">The Complete Guide to LAN Switching Technology. </span><span class="publisher"><span class="publishername">John Wiley &amp; Sons, Inc.. </span></span></span></p></div><div class="biblioentry"><a name="idm7197"></a><p><span class="biblioset"><span class="author"><span class="firstname">Tony</span> <span class="surname">Mancill</span>. </span><span class="copyright">Copyright © 2000 Prentice Hall. </span><span class="isbn">0-1308-6113-8. </span><i>Linux Routers</i>. <span class="publisher"><span class="publishername">Prentice Hall. </span></span></span></p></div></div><div class="index"><div class="titlepage"><div><div><h1 class="title"><a name="bookindex"></a>Index</h1></div></div></div><div xmlns:xlink="http://www.w3.org/1999/xlink" class="index"><div class="indexdiv"><h3>A</h3><dl><dt id="ientry-idm734">Address Resolution Protocol, <a class="indexterm" href="#ether-arp">Address Resolution Protocol (ARP)</a> (see <a href="#ientry-idm737">ARP</a>)</dt><dt id="ientry-idm737">ARP, <a class="indexterm" href="#ether-arp">Address Resolution Protocol (ARP)</a>, <a class="indexterm" href="#ex-ether-arp-gratuitous">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-ether-arp-unsolicited">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-ether-arp-dad">Overview of Address Resolution Protocol</a></dt><dd><dl><dt>duplicate address detection, <a class="indexterm" href="#ex-ether-arp-dad">Overview of Address Resolution Protocol</a></dt><dt>gratuitous, <a class="indexterm" href="#ex-ether-arp-gratuitous">Overview of Address Resolution Protocol</a></dt><dd><dl><dt>(see also <a href="#ientry-idm759">ARP reply</a>)</dt></dl></dd><dt>unsolicited, <a class="indexterm" href="#ex-ether-arp-unsolicited">Overview of Address Resolution Protocol</a></dt><dd><dl><dt>(see also <a href="#ientry-idm749">ARP request</a>)</dt></dl></dd></dl></dd><dt id="ientry-idm884">ARP cache, <a class="indexterm" href="#ether-arp-cache">The ARP cache</a>, <a class="indexterm" href="#ex-ether-arp-cache">The ARP cache</a>, <a class="indexterm" href="#ether-arp-cache-expiry">The ARP cache</a>, <a class="indexterm" href="#ether-arp-cache-expiry">The ARP cache</a>, <a class="indexterm" href="#tb-ether-arp-cache-states">The ARP cache</a>, <a class="indexterm" href="#ex-ether-arp-cache-timeout">The ARP cache</a></dt><dd><dl><dt>displaying, <a class="indexterm" href="#ex-ether-arp-cache">The ARP cache</a></dt><dt>expiration, <a class="indexterm" href="#ether-arp-cache-expiry">The ARP cache</a></dt><dt>expiration sequence, <a class="indexterm" href="#ex-ether-arp-cache-timeout">The ARP cache</a></dt><dt>lifetime, <a class="indexterm" href="#ether-arp-cache-expiry">The ARP cache</a></dt><dt>states, <a class="indexterm" href="#tb-ether-arp-cache-states">The ARP cache</a></dt></dl></dd><dt id="ientry-idm1240">ARP filtering, <a class="indexterm" href="#ether-arp-filtering">ARP filtering</a></dt><dt id="ientry-idm1035">ARP flux, <a class="indexterm" href="#ether-arp-flux">The ARP Flux Problem</a>, <a class="indexterm" href="#ether-arp-flux-arpfilter">ARP flux prevention with arp_filter</a>, <a class="indexterm" href="#ether-arp-flux-hidden">ARP flux prevention with hidden</a></dt><dd><dl><dt>solving with arp_filter, <a class="indexterm" href="#ether-arp-flux-arpfilter">ARP flux prevention with arp_filter</a></dt><dt>solving with hidden, <a class="indexterm" href="#ether-arp-flux-hidden">ARP flux prevention with hidden</a></dt></dl></dd><dt id="ientry-idm759">ARP reply, <a class="indexterm" href="#ether-arp-reply">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-eao-reply-text">Overview of Address Resolution Protocol</a></dt><dt id="ientry-idm749">ARP request, <a class="indexterm" href="#ether-arp-request">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-eao-request-text">Overview of Address Resolution Protocol</a></dt><dt id="ientry-idm1025">ARP suppression, <a class="indexterm" href="#ether-arp-suppression">ARP Suppression</a></dt><dt id="ientry-idm1190">ARP, proxy, <a class="indexterm" href="#ether-arp-proxy">Proxy ARP</a>, <a class="indexterm" href="#ether-arp-proxy-mediumid">Proxy ARP</a>, <a class="indexterm" href="#ether-arp-proxy-kernel">Proxy ARP</a>, <a class="indexterm" href="#adv-proxy-arp">Breaking a network in two with proxy ARP</a></dt><dd><dl><dt>with arp, <a class="indexterm" href="#adv-proxy-arp">Breaking a network in two with proxy ARP</a></dt><dt>with kernel, <a class="indexterm" href="#ether-arp-proxy-mediumid">Proxy ARP</a>, <a class="indexterm" href="#ether-arp-proxy-kernel">Proxy ARP</a></dt><dd><dl><dt>medium_id, <a class="indexterm" href="#ether-arp-proxy-mediumid">Proxy ARP</a></dt><dt>proxy_arp, <a class="indexterm" href="#ether-arp-proxy-kernel">Proxy ARP</a></dt></dl></dd></dl></dd><dt id="ientry-idm777">arping, <a class="indexterm" href="#ex-ether-arp-overview">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-ether-arp-gratuitous">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-ether-arp-unsolicited">Overview of Address Resolution Protocol</a>, <a class="indexterm" href="#ex-ether-arp-dad">Overview of Address Resolution Protocol</a></dt><dd><dl><dt>basic usage, <a class="indexterm" href="#ex-ether-arp-overview">Overview of Address Resolution Protocol</a></dt><dt>duplicate address detection, <a class="indexterm" href="#ex-ether-arp-dad">Overview of Address Resolution Protocol</a></dt><dt>gratuitous, <a class="indexterm" href="#ex-ether-arp-gratuitous">Overview of Address Resolution Protocol</a></dt><dt>unsolicited, <a class="indexterm" href="#ex-ether-arp-unsolicited">Overview of Address Resolution Protocol</a></dt></dl></dd><dt id="ientry-idm1061">arp_filter, <a class="indexterm" href="#ether-arp-flux-arpfilter">ARP flux prevention with arp_filter</a></dt></dl></div><div class="indexdiv"><h3>B</h3><dl><dt id="ientry-idm1287">bonding, <a class="indexterm" href="#ether-bonding">Link Aggregation and High Availability with Bonding</a>, <a class="indexterm" href="#ether-bonding-aggregation">Link Aggregation</a>, <a class="indexterm" href="#ether-bonding-ha">High Availability</a></dt><dd><dl><dt>high availability, <a class="indexterm" href="#ether-bonding-ha">High Availability</a></dt><dt>link aggregation, <a class="indexterm" href="#ether-bonding-aggregation">Link Aggregation</a></dt></dl></dd><dt id="ientry-idm1574">broadcast address (IP), <a class="indexterm" href="#list-routing-intro-ipdefs-bcast">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, broadcast address</a>)</dt></dl></div><div class="indexdiv"><h3>C</h3><dl><dt id="ientry-idm1301">channel bonding, <a class="indexterm" href="#ether-bonding-aggregation">Link Aggregation</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt id="ientry-idm5698">diagnostic tools, <a class="indexterm" href="#tools-diagnostics">Diagnostic Tools</a></dt></dl></div><div class="indexdiv"><h3>E</h3><dl><dt id="ientry-idm718">Ethernet, <a class="indexterm" href="#ch-ether">Ethernet</a></dt></dl></div><div class="indexdiv"><h3>F</h3><dl><dt id="ientry-idm1676">forwarding, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a> (see <a href="#ientry-idm1674">IP forwarding</a>)</dt><dt id="ientry-idm1849">forwarding information base, <a class="indexterm" href="#routing-cache">Routing Cache</a> (see <a href="#ientry-idm1847">routing cache</a>)</dt></dl></div><div class="indexdiv"><h3>I</h3><dl><dt id="ientry-idm5740">ICMP echo reply, <a class="indexterm" href="#tools-ping">ping</a></dt><dd><dl><dt>tunnelling data in, <a class="indexterm" href="#tools-ping">ping</a></dt><dd><dl><dt>(see also ping)</dt></dl></dd></dl></dd><dt id="ientry-idm1472">IP address, <a class="indexterm" href="#list-routing-intro-ipdefs-ipaddr">Introduction to Linux Routing</a></dt><dd><dl><dt>(see also <a href="#ientry-idm1457">IP addressing, address</a>)</dt></dl></dd><dt id="ientry-idm1457">IP addressing, <a class="indexterm" href="#list-routing-intro-ipdefs-octet">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-ipaddr">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-hostaddr">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-netaddr">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-netmask">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-prefix">Introduction to Linux Routing</a>, <a class="indexterm" href="#list-routing-intro-ipdefs-bcast">Introduction to Linux Routing</a></dt><dd><dl><dt>address, <a class="indexterm" href="#list-routing-intro-ipdefs-ipaddr">Introduction to Linux Routing</a></dt><dt>broadcast address, <a class="indexterm" href="#list-routing-intro-ipdefs-bcast">Introduction to Linux Routing</a></dt><dt>host address portion, <a class="indexterm" href="#list-routing-intro-ipdefs-hostaddr">Introduction to Linux Routing</a></dt><dt>network address, <a class="indexterm" href="#list-routing-intro-ipdefs-netaddr">Introduction to Linux Routing</a></dt><dt>network mask, <a class="indexterm" href="#list-routing-intro-ipdefs-netmask">Introduction to Linux Routing</a></dt><dt>octet, <a class="indexterm" href="#list-routing-intro-ipdefs-octet">Introduction to Linux Routing</a></dt><dt>prefix length, <a class="indexterm" href="#list-routing-intro-ipdefs-prefix">Introduction to Linux Routing</a></dt></dl></dd><dt id="ientry-idm1242">ip arp, <a class="indexterm" href="#ether-arp-filtering">ARP filtering</a></dt><dt id="ientry-idm1674">IP forwarding, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a></dt><dt id="ientry-idm1404">IP Routing, <a class="indexterm" href="#ch-routing">IP Routing</a> (see <a href="#ientry-idm1603">routing</a>)</dt></dl></div><div class="indexdiv"><h3>L</h3><dl><dt id="ientry-idm2235">local routing table, <a class="indexterm" href="#routing-table-local">The Local Routing Table</a> (see <a href="#ientry-idm1995">routing tables, local</a>)</dt><dt id="ientry-idm1709">longest prefix match, <a class="indexterm" href="#routing-selection-lpm">The Common Case</a> (see <a href="#ientry-idm1691">route selection, longest prefix match</a>)</dt></dl></div><div class="indexdiv"><h3>M</h3><dl><dt id="ientry-idm2289">main routing table, <a class="indexterm" href="#routing-table-main">The Main Routing Table</a> (see <a href="#ientry-idm1995">routing tables, main</a>)</dt></dl></div><div class="indexdiv"><h3>N</h3><dl><dt id="ientry-idm886">neighbor table, <a class="indexterm" href="#ether-arp-cache">The ARP cache</a></dt><dd><dl><dt>(see also <a href="#ientry-idm884">ARP cache</a>)</dt></dl></dd><dt id="ientry-idm1534">netmask, <a class="indexterm" href="#list-routing-intro-ipdefs-netmask">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, network mask</a>)</dt><dt id="ientry-idm6085">netstat command, <a class="indexterm" href="#tools-netstat">netstat</a>, <a class="indexterm" href="#tools-netstat-socket">Displaying socket status with
          netstat</a>, <a class="indexterm" href="#tools-netstat-route">Displaying the main routing table with
          netstat</a>, <a class="indexterm" href="#tools-netstat-interface">Displaying network interface statistics with
          netstat command</a>, <a class="indexterm" href="#tools-netstat-statistics">Displaying network stack statistics with
          netstat</a>, <a class="indexterm" href="#tools-netstat-masquerade">Displaying the masquerading table with
          netstat</a></dt><dd><dl><dt>displaying IP stack statistics
            (-s or --statistics), <a class="indexterm" href="#tools-netstat-statistics">Displaying network stack statistics with
          netstat</a></dt><dt>displaying network interface statistics
            (-i or --interface), <a class="indexterm" href="#tools-netstat-interface">Displaying network interface statistics with
          netstat command</a></dt><dt>displaying socket status 
              (--inet), <a class="indexterm" href="#tools-netstat-socket">Displaying socket status with
          netstat</a></dt><dt>displaying the main routing table
            (-r or --route), <a class="indexterm" href="#tools-netstat-route">Displaying the main routing table with
          netstat</a></dt><dt>displaying the masquerading table
            (-M or --masquerade), <a class="indexterm" href="#tools-netstat-masquerade">Displaying the masquerading table with
          netstat</a></dt></dl></dd><dt id="ientry-idm1505">network address, <a class="indexterm" href="#list-routing-intro-ipdefs-netaddr">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, network address</a>)</dt><dt id="ientry-idm1537">network mask, <a class="indexterm" href="#list-routing-intro-ipdefs-netmask">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, network mask</a>)</dt></dl></div><div class="indexdiv"><h3>O</h3><dl><dt id="ientry-idm1454">octet, <a class="indexterm" href="#list-routing-intro-ipdefs-octet">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, octet</a>)</dt></dl></div><div class="indexdiv"><h3>P</h3><dl><dt id="ientry-idm5717">ping command, <a class="indexterm" href="#tools-ping">ping</a>, <a class="indexterm" href="#tools-ping">ping</a>, <a class="indexterm" href="#tools-ping-simple">Using ping to test reachability</a>, <a class="indexterm" href="#ex-tools-ping-simple-count">Using ping to test reachability</a>, <a class="indexterm" href="#ex-tools-ping-simple-quiet">Using ping to test reachability</a>, <a class="indexterm" href="#tools-ping-stress">Using ping to stress a network</a>, <a class="indexterm" href="#ex-tools-ping-stress-size">Using ping to stress a network</a>, <a class="indexterm" href="#tools-ping-record-route">Recording a network route with ping</a>, <a class="indexterm" href="#tools-ping-ttl">Setting the TTL on a ping packet</a>, <a class="indexterm" href="#tools-ping-tos">Setting ToS for a diagnostic ping</a>, <a class="indexterm" href="#tools-ping-specify-source">Specifying a source address for ping</a></dt><dd><dl><dt>basic use, <a class="indexterm" href="#tools-ping-simple">Using ping to test reachability</a></dt><dt>description of, <a class="indexterm" href="#tools-ping">ping</a></dt><dd><dl><dt>(see also ICMP echo request and ICMP echo reply)</dt></dl></dd><dt>preferring a source address (-I), <a class="indexterm" href="#tools-ping-specify-source">Specifying a source address for ping</a></dt><dt>quiet mode (-q), <a class="indexterm" href="#ex-tools-ping-simple-quiet">Using ping to test reachability</a></dt><dt>recording a route (-R), <a class="indexterm" href="#tools-ping-record-route">Recording a network route with ping</a></dt><dt>sending specified number of packets
              (-c), <a class="indexterm" href="#ex-tools-ping-simple-count">Using ping to test reachability</a></dt><dt>setting a TTL manually (-t), <a class="indexterm" href="#tools-ping-ttl">Setting the TTL on a ping packet</a></dt><dt>setting ToS flag manually (-Q), <a class="indexterm" href="#tools-ping-tos">Setting ToS for a diagnostic ping</a></dt><dt>specifying packet size (-s), <a class="indexterm" href="#ex-tools-ping-stress-size">Using ping to stress a network</a></dt><dt>stressing a network (-f), <a class="indexterm" href="#tools-ping-stress">Using ping to stress a network</a></dt></dl></dd><dt id="ientry-idm1555">prefix length, <a class="indexterm" href="#list-routing-intro-ipdefs-prefix">Introduction to Linux Routing</a> (see <a href="#ientry-idm1457">IP addressing, prefix length</a>)</dt><dt id="ientry-idm3096">proxy ARP, <a class="indexterm" href="#adv-proxy-arp">Breaking a network in two with proxy ARP</a> (see <a href="#ientry-idm737">ARP, proxy</a>)</dt></dl></div><div class="indexdiv"><h3>R</h3><dl><dt id="ientry-idm1691">route selection, <a class="indexterm" href="#routing-selection">Route Selection</a>, <a class="indexterm" href="#routing-selection-lpm">The Common Case</a>, <a class="indexterm" href="#routing-selection-algorithm">The Whole Story</a>, <a class="indexterm" href="#tb-routing-selection-adv">The Whole Story</a></dt><dd><dl><dt>algorithm, <a class="indexterm" href="#routing-selection-algorithm">The Whole Story</a></dt><dt>longest prefix match, <a class="indexterm" href="#routing-selection-lpm">The Common Case</a></dt><dt>lookup keys, <a class="indexterm" href="#tb-routing-selection-adv">The Whole Story</a></dt></dl></dd><dt id="ientry-idm2095">route types, <a class="indexterm" href="#routing-tables-keys">Routing Tables</a> (see <a href="#ientry-idm1995">routing tables, entry types</a>)</dt><dt id="ientry-idm1671">router, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a></dt><dd><dl><dt>operating as a, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a></dt></dl></dd><dt id="ientry-idm1407">Routing, <a class="indexterm" href="#ch-routing">IP Routing</a></dt><dt id="ientry-idm1603">routing, <a class="indexterm" href="#routing-local">Routing to Locally Connected Networks</a>, <a class="indexterm" href="#routing-default">Sending Packets Through a Gateway</a></dt><dd><dl><dt>to a default gateway, <a class="indexterm" href="#routing-default">Sending Packets Through a Gateway</a></dt><dt>to locally reachable networks, <a class="indexterm" href="#routing-local">Routing to Locally Connected Networks</a></dt></dl></dd><dt id="ientry-idm1847">routing cache, <a class="indexterm" href="#routing-cache">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-dst">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-src">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-tos">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-fwmark">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-iif">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-cwnd">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-advmss">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-src">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-mtu">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-rtt">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-rttvar">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-age">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-users">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-used">Routing Cache</a></dt><dd><dl><dt>attributes, <a class="indexterm" href="#list-routing-cache-attrs-cwnd">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-advmss">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-src">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-mtu">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-rtt">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-rttvar">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-age">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-users">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-attrs-used">Routing Cache</a></dt><dd><dl><dt>advmss, <a class="indexterm" href="#list-routing-cache-attrs-advmss">Routing Cache</a></dt><dt>age, <a class="indexterm" href="#list-routing-cache-attrs-age">Routing Cache</a></dt><dt>cwnd, <a class="indexterm" href="#list-routing-cache-attrs-cwnd">Routing Cache</a></dt><dt>mtu, <a class="indexterm" href="#list-routing-cache-attrs-mtu">Routing Cache</a></dt><dt>rtt, <a class="indexterm" href="#list-routing-cache-attrs-rtt">Routing Cache</a></dt><dt>rttvar, <a class="indexterm" href="#list-routing-cache-attrs-rttvar">Routing Cache</a></dt><dt>src, <a class="indexterm" href="#list-routing-cache-attrs-src">Routing Cache</a></dt><dt>used, <a class="indexterm" href="#list-routing-cache-attrs-used">Routing Cache</a></dt><dt>users, <a class="indexterm" href="#list-routing-cache-attrs-users">Routing Cache</a></dt></dl></dd><dt>lookup keys, <a class="indexterm" href="#list-routing-cache-lookup-keys-dst">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-src">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-tos">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-fwmark">Routing Cache</a>, <a class="indexterm" href="#list-routing-cache-lookup-keys-iif">Routing Cache</a></dt><dd><dl><dt>dst, <a class="indexterm" href="#list-routing-cache-lookup-keys-dst">Routing Cache</a></dt><dt>fwmark, <a class="indexterm" href="#list-routing-cache-lookup-keys-fwmark">Routing Cache</a></dt><dt>iif, <a class="indexterm" href="#list-routing-cache-lookup-keys-iif">Routing Cache</a></dt><dt>src, <a class="indexterm" href="#list-routing-cache-lookup-keys-src">Routing Cache</a></dt><dt>tos, <a class="indexterm" href="#list-routing-cache-lookup-keys-tos">Routing Cache</a></dt></dl></dd></dl></dd><dt id="ientry-idm2313">routing policy database, <a class="indexterm" href="#routing-rpdb">Routing Policy Database (RPDB)</a> (see <a href="#ientry-idm2316">RPDB</a>)</dt><dt id="ientry-idm1995">routing tables, <a class="indexterm" href="#routing-tables">Routing Tables</a>, <a class="indexterm" href="#routing-tables-keys">Routing Tables</a>, <a class="indexterm" href="#routing-tables-keys">Routing Tables</a>, <a class="indexterm" href="#list-routing-route-types-unicast">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-broadcast">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-local">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-nat">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-unreachable">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-prohibit">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-blackhole">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-throw">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#routing-table-local">The Local Routing Table</a>, <a class="indexterm" href="#routing-table-main">The Main Routing Table</a></dt><dd><dl><dt>entry types, <a class="indexterm" href="#routing-tables-keys">Routing Tables</a>, <a class="indexterm" href="#list-routing-route-types-unicast">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-broadcast">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-local">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-nat">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-unreachable">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-prohibit">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-blackhole">Routing Table Entries (Routes)</a>, <a class="indexterm" href="#list-routing-route-types-throw">Routing Table Entries (Routes)</a></dt><dd><dl><dt>blackhole, <a class="indexterm" href="#list-routing-route-types-blackhole">Routing Table Entries (Routes)</a></dt><dt>broadcast, <a class="indexterm" href="#list-routing-route-types-broadcast">Routing Table Entries (Routes)</a></dt><dt>local, <a class="indexterm" href="#list-routing-route-types-local">Routing Table Entries (Routes)</a></dt><dt>nat, <a class="indexterm" href="#list-routing-route-types-nat">Routing Table Entries (Routes)</a></dt><dt>prohibit, <a class="indexterm" href="#list-routing-route-types-prohibit">Routing Table Entries (Routes)</a></dt><dt>throw, <a class="indexterm" href="#list-routing-route-types-throw">Routing Table Entries (Routes)</a></dt><dt>unicast, <a class="indexterm" href="#list-routing-route-types-unicast">Routing Table Entries (Routes)</a></dt><dt>unreachable, <a class="indexterm" href="#list-routing-route-types-unreachable">Routing Table Entries (Routes)</a></dt></dl></dd><dt>key fields, <a class="indexterm" href="#routing-tables-keys">Routing Tables</a></dt><dt>local, <a class="indexterm" href="#routing-table-local">The Local Routing Table</a></dt><dt>main, <a class="indexterm" href="#routing-table-main">The Main Routing Table</a></dt><dt>multiple, <a class="indexterm" href="#routing-tables">Routing Tables</a></dt></dl></dd><dt id="ientry-idm2316">RPDB, <a class="indexterm" href="#routing-rpdb">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-unicast">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-nat">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-unreachable">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-prohibit">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-blackhole">Routing Policy Database (RPDB)</a></dt><dd><dl><dt>entry types, <a class="indexterm" href="#list-routing-rule-types-unicast">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-nat">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-unreachable">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-prohibit">Routing Policy Database (RPDB)</a>, <a class="indexterm" href="#list-routing-rule-types-blackhole">Routing Policy Database (RPDB)</a></dt><dd><dl><dt>blackhole, <a class="indexterm" href="#list-routing-rule-types-blackhole">Routing Policy Database (RPDB)</a></dt><dt>nat, <a class="indexterm" href="#list-routing-rule-types-nat">Routing Policy Database (RPDB)</a></dt><dt>prohibit, <a class="indexterm" href="#list-routing-rule-types-prohibit">Routing Policy Database (RPDB)</a></dt><dt>unicast, <a class="indexterm" href="#list-routing-rule-types-unicast">Routing Policy Database (RPDB)</a></dt><dt>unreachable, <a class="indexterm" href="#list-routing-rule-types-unreachable">Routing Policy Database (RPDB)</a></dt></dl></dd></dl></dd></dl></div><div class="indexdiv"><h3>S</h3><dl><dt id="ientry-idm1810">source address selection, <a class="indexterm" href="#routing-saddr-selection">Source Address Selection</a></dt><dd><dl><dt>(see also <a href="#ientry-idm1691">route selection</a>)</dt></dl></dd><dt id="ientry-idm1150">sysctl, <a class="indexterm" href="#ether-arp-flux-hidden">ARP flux prevention with hidden</a>, <a class="indexterm" href="#ether-arp-proxy-mediumid">Proxy ARP</a>, <a class="indexterm" href="#ether-arp-proxy-kernel">Proxy ARP</a>, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a></dt><dd><dl><dt>hidden, <a class="indexterm" href="#ether-arp-flux-hidden">ARP flux prevention with hidden</a></dt><dt>ip_forward, <a class="indexterm" href="#routing-forwarding">Operating as a Router</a></dt><dt>medium_id, <a class="indexterm" href="#ether-arp-proxy-mediumid">Proxy ARP</a></dt><dt>proxy_arp, <a class="indexterm" href="#ether-arp-proxy-kernel">Proxy ARP</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>T</h3><dl><dt id="ientry-idm6005">traceroute command, <a class="indexterm" href="#tools-traceroute">traceroute</a>, <a class="indexterm" href="#tools-traceroute">traceroute</a>, <a class="indexterm" href="#tools-traceroute">traceroute</a>, <a class="indexterm" href="#tools-traceroute-icmp">Telling traceroute to use ICMP echo request
          instead of UDP</a>, <a class="indexterm" href="#tools-traceroute-icmp">Telling traceroute to use ICMP echo request
          instead of UDP</a></dt><dd><dl><dt>basic use, <a class="indexterm" href="#tools-traceroute">traceroute</a></dt><dt>setting ToS flags (-t), <a class="indexterm" href="#tools-traceroute-icmp">Telling traceroute to use ICMP echo request
          instead of UDP</a></dt><dt>using ICMP packets (-I), <a class="indexterm" href="#tools-traceroute-icmp">Telling traceroute to use ICMP echo request
          instead of UDP</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>V</h3><dl><dt id="ientry-idm1261">VLAN, <a class="indexterm" href="#ether-vlan">Connecting to an Ethernet 802.1q VLAN</a></dt></dl></div></div></div></div></body></html>
