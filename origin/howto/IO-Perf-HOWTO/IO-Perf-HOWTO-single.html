<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>I/O Performance HOWTO</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="description" content="This HOWTO covers information on available patches for the 2.4 kernel that can improve the I/O performance of your Linux&#8482; operating system."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article"><div class="titlepage"><div><div><h2 class="title"><a name="IO-Perf-HOWTO"></a>I/O Performance HOWTO</h2></div><div><div class="author"><h3 class="author"><span class="firstname">Sharon</span> <span class="surname">Snider</span></h3></div></div><div><div class="legalnotice"><a name="idm10"></a><p>Linux is a trademark of Linus Torvalds. Other company, products, and service names may be trademarks or service marks of others.</p></div></div><div><p class="pubdate">v1.1, 05/2002</p></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision v1.1</td><td align="left">2002-05-01</td><td align="left">sds</td></tr><tr><td align="left" colspan="3">Updated technical information and links.</td></tr><tr><td align="left">Revision v1.0</td><td align="left">2002-04-01</td><td align="left">sds</td></tr><tr><td align="left" colspan="3">Wrote and converted to DocBook XML.</td></tr></table></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>This HOWTO covers information on available patches for the 2.4 kernel that can improve the I/O performance of your Linux&#8482; operating system. </p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idm26">1. Distribution Policy</a></span></dt><dt><span class="sect1"><a href="#INTRODUCTION">2. Introduction</a></span></dt><dt><span class="sect1"><a href="#OVERVIEW">3. Avoiding Bounce Buffers</a></span></dt><dd><dl><dt><span class="sect2"><a href="#idm40">3.1. Memory and Addressing in the Linux 2.4 Kernel</a></span></dt><dt><span class="sect2"><a href="#idm44">3.2. The Problem with Bounce Buffers</a></span></dt><dt><span class="sect2"><a href="#config">3.3. Locating the Patch</a></span></dt><dt><span class="sect2"><a href="#idm85">3.4. Modifying Your Device Driver to Avoid Bounce Buffers</a></span></dt></dl></dd><dt><span class="sect1"><a href="#idm159">4. Raw I/O Variable-Size Optimization Patch</a></span></dt><dd><dl><dt><span class="sect2"><a href="#idm164">4.1. Locating the Patch</a></span></dt><dt><span class="sect2"><a href="#idm180">4.2. Modifying Your Driver for the Raw I/O Variable-Size Optimization Patch</a></span></dt></dl></dd><dt><span class="sect1"><a href="#idm191">5. I/O Request Lock Patch</a></span></dt><dd><dl><dt><span class="sect2"><a href="#idm197">5.1. Locating the Patch</a></span></dt><dt><span class="sect2"><a href="#idm205">5.2. Modifying Your Driver for the I/O Request Lock Patch</a></span></dt></dl></dd><dt><span class="sect1"><a href="#idm216">6. Additional Resources</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm26"></a>1. Distribution Policy</h2></div></div></div><p>The I/O Performance-HOWTO is copyrighted © 2002, by IBM Corporation </p><p>Permission is granted to copy, distribute, and/or modify this document under the terms of the GNU Free Documentation License, Version 1.1 or any later version published by the Free Software Foundation with no Invariant Sections, no Front-Cover text, and no Back-Cover text. A copy of the license can be found at <a class="ulink" href="http://www.gnu.org/licenses/fdl.txt" target="_top">http://www.gnu.org/licenses/fdl.txt</a>.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="INTRODUCTION"></a>2. Introduction</h2></div></div></div><p>This HOWTO provides information on improving the input/output (I/O) performance of  the Linux operating system for 		the 2.4 kernel. Additional patches will be added as they become available.</p><p>Please send any comments, or contributions via e-mail to <a class="ulink" href="mailto:snidersd@us.ibm.com" target="_top"> Sharon 				Snider</a>. </p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="OVERVIEW"></a>3. Avoiding Bounce Buffers</h2></div></div></div><p>This section provides information on applying and using the bounce buffer patch on the Linux 2.4 kernel. The bounce buffer patch, written by Jens Axboe, enables device drivers that support direct memory access (DMA) I/O  to high-address physical memory to avoid bounce buffers.</p><p>This document provides a brief overview on memory and addressing in the Linux kernel, followed by information on why and how to make use of the bounce buffer patch.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm40"></a>3.1. Memory and Addressing in the Linux 2.4 Kernel</h3></div></div></div><p>The Linux 2.4 kernel includes configuration options for specifying the amount of physical memory in the target computer.  By default, the configuration is limited to the amount of memory that can be directly mapped into the kernel's virtual address space starting at PAGE_OFFSET. On i386 systems the default mapping scheme limits kernel-mode addressability to the first gigabyte (GB) of physical memory, also known as low memory. Conversely, high memory is normally the memory above 1 GB. High memory is not directly accessible or permanently mapped by the kernel. Support for high memory is an option that is enabled during <a class="link" href="#config" title="3.3. Locating the Patch">configuration of the Linux kernel</a>.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm44"></a>3.2. The Problem with Bounce Buffers</h3></div></div></div><p>When DMA I/O is performed to or from high memory, an area is allocated in low memory known as a bounce buffer. When data travels between a device and high memory, it is first copied through the bounce buffer.</p><p>Systems with a large amount of high memory and intense I/O activity can create a large number of bounce buffers that can cause memory shortage problems. In addition, the excessive number of bounce buffer data copies can lead to performance degradation.</p><p>Peripheral component interface (PCI) devices normally address up to 4 GB of physical memory. When a bounce buffer is used for high memory that is below 4 GB, time and memory are wasted because the peripheral has the ability to address that memory directly. Using the bounce buffer patch can decrease, and possibly eliminate, the use of bounce buffers.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="config"></a>3.3. Locating the Patch</h3></div></div></div><p> The latest version of the bounce buffer patch is <span class="emphasis"><em>block-highmem-all-18b.bz2</em></span>, and it is available from Andrea Arcangeli's -aa series kernels at 
 <a class="ulink" href="http://kernel.org/pub/linux/kernel/people/andrea/kernels/v2.4/" target="_top">http://kernel.org/pub/linux/kernel/people/andrea/kernels/v2.4/</a>.</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="idm54"></a>3.3.1. Configuring the Linux Kernel to Avoid Bounce Buffers</h4></div></div></div><p>This section includes information on configuring the Linux kernel to avoid bounce buffers. The Linux Kernel-HOWTO at <a class="ulink" href="http://www.linuxdoc.org/HOWTO/Kernel-HOWTO.html" target="_top">http://www.linuxdoc.org/HOWTO/Kernel-HOWTO.html</a> explains the process of re-compiling the Linux kernel.</p><p>The following kernel configuration options are required to enable the bounce buffer patch:</p><p><span class="bold"><strong>Development Code</strong></span> - To enable the configurator to display the <code class="option">High I/O Support</code> option, select the <code class="option">Code maturity level options</code> category and specify "y" to <code class="option">Prompt for development and/or incomplete code/drivers</code>.</p><p><span class="bold"><strong>High Memory Support</strong></span> - To enable support for physical memory that is 			greater than 1 GB, select the <code class="option">Processor type and features</code> category, and select a value from the  <code class="option">High Memory Support</code> option.</p><p><span class="bold"><strong>High Memory I/O Support</strong></span> - To enable DMA I/O to physical 					addresses greater than 1 GB, select the  <code class="option">Processor type and features</code> category, and enter "y" 			to  the <code class="option">HIGHMEM I/O support</code> option. This configuration option is a new option introduced by the bounce buffer patch.</p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="enabled"></a>3.3.2. Enabled Device Drivers</h4></div></div></div><p>The bounce buffer patch provides the kernel infrastructure, as well as the SCSI and IDE mid-level driver modifications to support DMA I/O to high memory.  Updates for several device drivers to make use of the added support are also included with the patch.</p><p>If the bounce buffer patch is applied and you configure the kernel to support 						high memory I/O, many IDE configurations and the device drivers listed below					perform DMA I/O without the use of bounce buffers:</p><table border="0" summary="Simple list" class="simplelist"><tr><td>aic7xxx_drv.o</td></tr><tr><td>aic7xxx_old.o</td></tr><tr><td>cciss.o</td></tr><tr><td>cpqarray.o</td></tr><tr><td>megaraid.o</td></tr><tr><td>qlogicfc.o</td></tr><tr><td>sym53c8xx.o</td></tr></table></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm85"></a>3.4. Modifying Your Device Driver to Avoid Bounce Buffers</h3></div></div></div><p>If your device drivers are not listed above in the 
<a class="link" href="#enabled" title="3.3.2. Enabled Device Drivers">Enabled Device Drivers</a> section, and the device is capable of high-memory DMA I/O, you can modify your device driver to make use of the bounce buffer patch as follows. More information on rebuilding a Linux device driver is available at <a class="ulink" href="http://www.xml.com/ldd/chapter/book/index.html" target="_top">http://www.xml.com/ldd/chapter/book/index.html</a>.
</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>A.) For SCSI Adapter Drivers: set the <em class="structfield"><code>highmem_io</code></em> bit in the <em class="structfield"><code>Scsi_Host_Template</code></em>  structure. </p><p>B.) For IDE Adapter Drivers: set the <em class="structfield"><code>highmem</code></em>bit in the <em class="structfield"><code>ide_hwif_t</code></em> structure.</p></li><li class="listitem"><p>Call <em class="structfield"><code>pci_set_dma_mask(struct pci_dev *pdev, dma_addr_t mask)</code></em> to specify the address bits that the device can successfully use on DMA operations. </p><p>If DMA I/O can be supported with the specified mask, <em class="structfield"><code>pci_set_dma_mask()</code></em> will set <em class="structfield"><code>pdev-&gt;dma_mask</code></em> and return 0. For SCSI or IDE, the mask value will also be passed by the mid-level drivers to <em class="structfield"><code>blk_queue_bounce_limit(request_queue_t *q, u64 dma_addr)</code></em> so that bounce buffers are not created for memory directly addressable by the device. Drivers other than SCSI or IDE must call <em class="structfield"><code>blk_queue_bounce_limit()</code></em> directly. </p></li><li class="listitem"><p>Use <em class="structfield"><code>pci_map_page(dev, page, offset, size, direction)</code></em>, instead of <em class="structfield"><code>pci_map_single(dev, address, size, direction)</code></em> to map a memory region so that it is accessible by the peripheral device. <em class="structfield"><code>pci_map_page() </code></em> supports both high and low memory.</p><p>The <em class="structfield"><code>address </code></em> parameter for <em class="structfield"><code>pci_map_single()</code></em> correlates to the <em class="structfield"><code>page</code></em> and<em class="structfield"><code> offset </code></em> parameters for <em class="structfield"><code>pci_map_page()</code></em>. Use the <em class="structfield"><code>virt_to_page()</code></em> macro to convert an <em class="structfield"><code>address</code></em> to a <em class="structfield"><code>page </code></em> and <em class="structfield"><code>offset</code></em>. The <em class="structfield"><code>virt_to_page()</code></em> macro is defined by including pci.h. For example:</p><pre class="screen"><em class="structfield"><code>void *address;</code></em></pre><p>

</p><pre class="screen"><em class="structfield"><code>struct page *page;</code></em></pre><p>

</p><pre class="screen"><em class="structfield"><code>unsigned long offset;</code></em></pre><p>

</p><pre class="screen"><em class="structfield"><code>page = virt_to_page(address);</code></em></pre><p>

</p><pre class="screen"><em class="structfield"><code>offset = (unsigned long) address &amp; ~PAGE_MASK;</code></em></pre><p>Call <em class="structfield"><code>pci_unmap_page()</code></em> after the DMA I/O transfer is complete to remove the mapping established by <em class="structfield"><code>pci_map_page()</code></em>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><em class="structfield"><code>pci_map_single()</code></em> is implemented using <em class="structfield"><code>virt_to_bus()</code></em>. <em class="structfield"><code>virt_to_bus()</code></em> handles low memory addresses only. Drivers supporting high memory should no longer call <em class="structfield"><code>virt_to_bus()</code></em> or <em class="structfield"><code>bus_to_virt()</code></em>.</p></div></li><li class="listitem"><p>If your driver calls <em class="structfield"><code>pci_map_sg()</code></em> to map a scatter-gather DMA operation, your driver should set the <em class="structfield"><code>page</code></em> and <em class="structfield"><code>offset</code></em> fields instead of the <em class="structfield"><code>address</code></em> field of the <em class="structfield"><code>scatterlist</code></em> structure. Refer to step 3 for converting an <em class="structfield"><code>address</code></em> to a <em class="structfield"><code>page</code></em> and <em class="structfield"><code>offset</code></em>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>If your driver is already using the PCI DMA API, continue to use <em class="structfield"><code>pci_map_page()				</code></em> or <em class="structfield"><code>pci_map_sg()</code></em> as appropriate. However, do not use the <em class="structfield"><code>address</code></em> field of the <em class="structfield"><code>scatterlist</code></em> structure.</p></div></li></ol></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm159"></a>4. Raw I/O Variable-Size Optimization Patch</h2></div></div></div><p>This section provides information on the raw I/O variable-size optimization patch for the Linux 2.4 kernel written by Badari Pulavarty. This patch is also known as the RAW VARY or PAGESIZE_io patch. </p><p>The raw I/O variable-size patch changes the block size used for raw I/O from <em class="structfield"><code>hardsect_size</code></em> (normally 512 bytes) to 4 kilobytes (K).	The patch improves I/O throughput and CPU utilization by reducing the number of buffer heads needed for raw I/O operations.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm164"></a>4.1. Locating the Patch</h3></div></div></div><p>You can download the patch from one of the following locations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Andrea Arcangeli has made the patch available at			
<a class="ulink" href="http://www.kernel.org/pub/linux/kernel/people/andrea/kernels/v2.4/2.4.18pre7aa2/" target="_top">http://www.kernel.org/pub/linux/kernel/people/andrea/kernels/v2.4/2.4.18pre7aa2/</a>. 
The name of the file is <span class="emphasis"><em>10_rawio-vary-io-1</em></span>.</p></li><li class="listitem"><p>Alan Cox has included the patch in the <span class="emphasis"><em>2.4.18pre9-ac2</em></span> kernel patch. The patch is available at <a class="ulink" href="http://www.kernel.org/pub/linux/kernel/people/alan/linux-2.4/2.4.18/" target="_top">http://www.kernel.org/pub/linux/kernel/people/alan/linux-2.4/2.4.18/</a>. </p></li><li class="listitem"><p>The patch is available from SourceForge at <a class="ulink" href="http://sourceforge.net/projects/lse/io" target="_top">http://sourceforge.net/projects/lse/io</a>. The latest version is <span class="emphasis"><em>PAGESIZE_io-2.4.17.patch</em></span>.</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm180"></a>4.2. Modifying Your Driver for the Raw I/O Variable-Size Optimization Patch</h3></div></div></div><p>In previous versions of this patch, changes were enabled for all drivers. However, the 2.4.17 and later 				versions of the patch enable the changes only for the Adaptec, Qlogic ISP1020, and IBM ServerRAID drivers. All other drivers for version 2.4.17 and later must be modified to make use of the patch by setting the <em class="structfield"><code>can_do_varyio</code></em> bit in the <em class="structfield"><code>Scsi_Host_Template</code></em>  structure.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Drivers that have the raw I/O patch enabled must support buffer heads of variable sizes <em class="structfield"><code>(b_size)</code></em> in a single I/O request because <em class="structfield"><code>hardsect_size</code></em> is used until the data buffer is aligned  on a 4 K boundary.</p><p>Additional information is available on rebuilding Linux device drivers at <a class="ulink" href="http://www.xml.com/ldd/chapter/book/index.html" target="_top">http://www.xml.com/ldd/chapter/book/index.html</a>.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm191"></a>5. I/O Request Lock Patch</h2></div></div></div><p>This section provides information on the I/O request lock patch, also known as the scsi concurrent queuing patch 			(sior1), written by Johnathan Lahr. </p><p>The I/O request lock patch improves SCSI I/O performance on Linux 2.4 multi-processor systems by providing concurrent I/O request 	queuing. There are significant I/O performance and CPU utilization improvements possible by enabling multi-processors to concurrently drive multiple block devices.</p><p>Before the patch is applied block I/O requests are queued one at a time holding the global spin lock, <em class="structfield"><code> 				io_request_lock</code></em>.	Once the patch is applied, SCSI requests are queued while holding the  lock specific to the queue associated with the request. Requests that are made to different devices are queued concurrently, and requests that are made to the same device are queued serially.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm197"></a>5.1. Locating the Patch</h3></div></div></div><p>You can download the I/O request patch from Sourceforge at <a class="ulink" href="http://sourceforge.net/projects/lse/io" target="_top">http://sourceforge.net/projects/lse/io</a>. The latest version is <span class="emphasis"><em>sior1-v1.2416</em></span>. Patches that enable concurrent queuing for specific drivers are also available at SourceForge. The patch for the Emulex SCSI/FC is <span class="emphasis"><em>lpfc_sior1-v0.249</em></span> and the patch for Adaptec SCSI is <span class="emphasis"><em>aic_sior1-v0.249</em></span>.</p><p></p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm205"></a>5.2. Modifying Your Driver for the I/O Request Lock Patch</h3></div></div></div><p>The I/O request lock patch installs concurrent queuing capability into the SCSI midlayer. Concurrent queuing is 
activated for each SCSI adapter device driver. To activate the driver, the <em class="structfield"><code>concurrent_queue</code></em> field in the 	<em class="structfield"><code>Scsi_Host_Template</code></em> structure must be set when the driver is registered.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Drivers that activate concurrent queuing must ensure that any access of the <em class="structfield"><code>request_queue</code></em> by the driver is protected by the <em class="structfield"><code>request_queue.queue_lock</code></em>.</p><p>Additional information is available on rebuilding device drivers at <a class="ulink" href="http://www.xml.com/ldd/chapter/book/index.html" target="_top">http://www.xml.com/ldd/chapter/book/index.html</a>.</p></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm216"></a>6. Additional Resources</h2></div></div></div><p>The following list of Web sites provides additional information on modifying device drivers and configuring the Linux kernel.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Information on Dynamic DMA mapping is available at 
<a class="ulink" href="http://lwn.net/2001/0712/a/dma-interface.php3" target="_top">http://lwn.net/2001/0712/a/dma-interface.php3</a>.</p></li><li class="listitem"><p>Kernel-HOWTO is available from the Linux Documentation Project at 
<a class="ulink" href="http://www.linuxdoc.org/HOWTO/Kernel-HOWTO.html" target="_top">http://www.linuxdoc.org/HOWTO/Kernel-HOWTO.html</a>.</p></li><li class="listitem"><p>Linux Device Drivers, 2nd Edition published by O'Reilly is available online at 
<a class="ulink" href="http://www.xml.com/ldd/chapter/book/index.html" target="_top">http://www.xml.com/ldd/chapter/book/index.html</a>.</p></li></ul></div></div></div></body></html>
