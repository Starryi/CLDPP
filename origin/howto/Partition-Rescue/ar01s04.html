<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>4. Solving the problem</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Partition-Rescue"><link rel="up" href="index.html" title="Partition-Rescue"><link rel="prev" href="ar01s03.html" title="3. Technical info"><link rel="next" href="ar01s05.html" title="5. References"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Solving the problem</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s03.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s05.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm122"></a>4. Solving the problem</h2></div></div></div><p>Please, beware! Following the explanations given here will lead you to revert back to a previous system, losing all your recent changes, if any! You must choose... </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm125"></a>4.1. The simpler case</h3></div></div></div><p>All is simple if you have at hand: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A disk (floppy, usb key or CD) able to start Linux by itself with fdisk available - most rescue disks of any distribution can do that; </p></li><li class="listitem"><p>A paper with the <span class="command"><strong>fdisk -l</strong></span> and <span class="command"><strong>fdisk -u -l</strong></span> content written down. </p></li></ul></div><p>It's enough to: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Start Linux; </p></li><li class="listitem"><p>Start <span class="command"><strong>fdisk /dev/hda</strong></span> (or whatever is the disk to rescue); </p></li><li class="listitem"><p>Use fdisk to delete (d option) all the existing partitions on the damaged disk; </p></li><li class="listitem"><p>Use fdisk to create all the primary (1 - 4) partitions mentioned on the paper; </p></li><li class="listitem"><p>Give them the appropriate tag (t option) : 82 is for Linux swap, 83 for Linux main (L gives you the list), 5 is extended and must be done before creating logical partitions, c is MS Windows FAT32, and f is MS Windows extended when 6 is MS Windows FAT16. </p></li><li class="listitem"><p>Create any logical partition. </p></li></ol></div><p>On my SUSE installation and any time I had to do this for other people, this has produced good results. </p><p>However, I said that some fdisks may cut partitions on a sector basis, not cylinder. So the <span class="command"><strong>fdisk -u -l</strong></span> version of the paper. </p><p>For using the <span class="command"><strong>fdisk -u -l</strong></span> listing one must start <span class="command"><strong>fdisk -u</strong></span> :-). In my opinion, using sector limit is a very bad idea, but it may have a real use I'm not aware of. The problem is that, with cylinder limit, it's easy to guess even if you don't have paper. With sector one, there are many more guesses... </p><p>fdisk is a small and very smart programs. There are many other makes of fdisk, but I always prefer the bare bones one. (I speak of Linux ones, of course, not the others....) </p><p>Be aware that fdisk doesn't write anything to disk before you hit w and return. If you fear a mistake, hit q (quit) or Ctrl C (^C) to quit safe without saving changes. </p><p>When your new partition table is written, start your Linux. It's possible you might not be able to do that as usual: lilo/grub may have been damaged also, and you thus may need a boot floppy or CD. Choose the option "booting the installed partition".  </p><p>If you are accustomed to booting with lilo, as soon as you are logged in as root, key in "lilo" and hit return to reinstall your favourite boot loader. Right now, I'm not sure that the same thing is as easy with GRUB, but it should not be very difficult, either. </p><p>Your Linux should be all here; test it. Try, also, to start MS Windows if applicable. If you can't, there is a (very small) chance you can read your data from Linux, maybe with a raw sector-by-sector read. If you can identify the disk sectors your data is on, using dd you can copy it to a file. This is wise for text only. This recovery is NOT in the scope of this mini-HOWTO. </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm161"></a>4.2. A not-so-simple case</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idm163"></a>4.2.1. By hand</h4></div></div></div><p>This is when the previous case can't be used, for lack of fdisk paper, or if it won't work for use of an out-of-date one. </p><p><span class="strong"><strong>Warning</strong></span> </p><p>You can only try <span class="emphasis"><em>primary</em></span> partitions with no fear. <span class="emphasis"><em>logical</em></span> partition uses ordinary sectors of the disk to store their own housekeeping data, so, each time you write some logical partition with fdisk, you write some sectors, erasing the data content, if any. There is still a chance you don't have any data there or the data is unimportant, but, the less often you do such tries, the better. </p><p>First, be aware that as soon as you don't write to the disk (except with fdisk), you don't erase your data, so that you can use a block-by-block try. That is you need to know the beginning of the partition to start it. If, say a 153 doesn't fit, try a 154, and so on. </p><p>This can be tiresome, but, if you remember approximately the size of the Linux partition, there is a chance to win. </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="idm173"></a>4.2.2. Linux's own info and other hacks</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm175"></a>4.2.2.1. Kernel</h5></div></div></div><p>If you just destroyed your own partition table, but have not rebooted Linux: Don't reboot! You can still retrieve the partition information stored in the Kernel: </p><p><span class="command"><strong>cat /proc/partitions</strong></span> gives </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col class="col_0"><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><tbody><tr><td><p> major </p></td><td><p> minor </p></td><td><p> #blocks </p></td><td><p> name </p></td></tr><tr><td><p> 3 </p></td><td><p> 0 </p></td><td align="right"><p> 19535040 </p></td><td><p> hda </p></td></tr><tr><td><p> 3 </p></td><td><p> 1 </p></td><td align="right"><p> 2096451 </p></td><td><p> hda1 </p></td></tr><tr><td><p> 3 </p></td><td><p> 2 </p></td><td align="right"><p> 4980150 </p></td><td><p> hda2 </p></td></tr><tr><td><p> 3 </p></td><td><p> 3 </p></td><td align="right"><p> 1 </p></td><td><p> hda3 &lt;--- this marks an extended partition </p></td></tr><tr><td><p> 3 </p></td><td><p> 5 </p></td><td align="right"><p> 4980118 </p></td><td><p> hda5 </p></td></tr><tr><td><p> 3 </p></td><td><p> 6 </p></td><td align="right"><p> 4972086 </p></td><td><p> hda6 </p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm250"></a>4.2.2.2. hdparm</h5></div></div></div><p><span class="command"><strong>hdparm -g /dev/hda1/dev/hda1</strong></span> : </p><p>geometry = 2432/255/63, sectors = 4192902, start = 63 </p><p>You'll need to do a few unit conversions. "blocks" are usually 1K in length. "Sectors" are disk sectors, often 512 bytes. But usually the disk partitioning tools work in units of cylinders. (Here, 255*63=16065 sectors.) Using this information, you can build a new partition table. </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm256"></a>4.2.2.3. I know the start of the partition, but not the end.</h5></div></div></div><p>If you know the start of a Linux partition, but not the end, you can still mount it, and learn about the structure. Set the partition table start correctly, and set the end to something very large. See if you guessed correctly with: </p><pre class="screen">e2fsck -n /dev/hd??</pre><p>You can even mount the partition and check the size: </p><pre class="screen">mount -r /dev/hd?? /mnt
df -T</pre><p>This won't directly tell you where the next partition starts, because of rounding issues. But it can help you get close. Be sure to use the "-n" and "-r" flags, to treat the system as read-only!!! </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm263"></a>4.2.2.4. Other places partition information is stored</h5></div></div></div><p>Some distributions record partition information in a file. Of course, you probably won't be able to get to this file when you need it. But, just in case: </p><pre class="screen">SuSE: /var/lib/YaST/install.inf</pre><p>(if you are aware of others, please e-mail the maintainer of this document) </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm268"></a>4.2.2.5. gpart</h5></div></div></div><p>But there is a better way if you can still access the Net or have "gpart" on hand. gpart is available in most distribution, at <a class="ulink" href="http://freshmeat.net/" target="_top">http://freshmeat.net/</a> or directly from <a class="ulink" href="http://www.stud.uni-hannover.de/user/76201/gpart" target="_top">http://www.stud.uni-hannover.de/user/76201/gpart</a>. </p><p>Please note that gpart is <span class="strong"><strong>not</strong></span> gparted - the GNOME partition editor. </p><p>"gpart - guess PC-type hard disk partitions" as the first line of the it's man page states (man gpart). And goes on to say: </p><p>"gpart tries to guess which partitions are on a hard disk. If the primary partition table has been lost, overwritten, or destroyed, the partitions still exist on the disk, but the operating system cannot access them." </p><p>This is exactly what we need. gpart is a very useful tool. </p><p>The problem is the following: the first block of any partition is marked. But it's never "unmarked" if not overwritten. So, many "first partition block" exist on an old disk, and gpart tries to do its best guessing what is the good one. In fact, it's not too difficult to try; nothing is written on the disk by gpart. </p><p>Here is the result of gpart on the previously seen disk, hdb: </p><pre class="screen">root@charles:/home/jdd &gt; gpart /dev/hdb
Begin scan...
Possible partition(Linux ext2), size(1200Mb), offset(0Mb)
Possible partition(Windows NTFS), size(1200Mb), offset(1200Mb)
Possible partition(Linux ext2), size(1004Mb), offset(2402Mb)
Possible partition(Windows NTFS), size(1600Mb), offset(4102Mb)
End scan.
Checking partitions...
* Warning: partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX) ends beyond disk end .
Partition(Linux ext2 filesystem): primary
Partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX): primary
Partition(Linux ext2 filesystem): primary
Partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX): invalid primary
Ok.
Guessed primary partition table:
Primary partition(1)
type: 131(0x83)(Linux ext2 filesystem)
size: 1200mb #s(2457880) s(63-2457942)
chs: (0/1/1)-(152/254/61)d (0/1/1)-(152/254/61)r
Primary partition(2)
type: 007(0x07)(OS/2 HPFS, NTFS, QNX or Advanced UNIX)
size: 1200mb #s(2457880) s(2457944-4915823)
chs: (152/254/63)-(305/253/60)d (152/254/63)-(305/253/60)r
Primary partition(3)
type: 131(0x83)(Linux ext2 filesystem)
size: 1004mb #s(2056256) s(4919781-6976036)
chs: (306/61/49)-(434/60/47)d (306/61/49)-(434/60/47)r
Primary partition(4)
type: 000(0x00)(unused) size: 0mb #s(0) s(0-0) chs: (0/0/0)-(0/0/0)d (0/0/0)-(0/0/0)r</pre><p>As you see, primary partition can be recovered, but, for extended ones, it's still to be done. </p><p>DOS partitions are labelled "Windows NTFS" because they were created while trying to install MS Windows 2000 (a very awful experience in year 2000!). The "invalid" one is, in fact the extended partition. </p><p>With this, one can use fdisk and try re-creating the partition table. (Remember, this is risk-free given the original one is already lost.) </p><p>gpart is updated on a weekly basis <span class="inlinemediaobject"><img src="http://wiki.tldp.org/moin_static172/gugiel/img/smile.png" width="16" alt=":-)"></span> and so new versions may be more powerful than I know. </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm290"></a>4.2.2.6. Recovering partitions inside an extended partition</h5></div></div></div><p>Extended partition information is scattered on the disk, not stored with the primary partition. To recover these often requires more work. The process is: </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Scan for the start of the first partition (using gpart's -k option); </p></li><li class="listitem"><p>Create a temporary primary partition entry with the true start position and a fake end position. (This may drive you to delete an actual primary partition if no one is available - this is risk free if you don't reuse the sectors of the deleted partition); </p></li><li class="listitem"><p>Use "<span class="command"><strong>e2fsk -n</strong></span>", "<span class="command"><strong>mount -r</strong></span>", and "<span class="command"><strong>df</strong></span>" to determine the true end point. Write this value down (warning: read the man page for each program mentioned, and use the read-only options; you do not want to write to your disk until all partitions are in the correct place); </p></li><li class="listitem"><p>Repeat this process for each partition to be recovered; </p></li><li class="listitem"><p>Build a complete new correct partition table. </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="idm307"></a>4.2.2.7. If your hard drive has errors</h5></div></div></div><p>If your hard drive has errors, you may have real trouble mounting, checking, or using data. (The drive read errors get in the way.) Gpart may not even find it. But if you know the start of the partition, you can easily copy the data to a temporary file stored on a different drive. Sectors with read errors will usually be set to zero by this process: </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Copy the partition data to a file. You must know the start block of the partition; </p></li></ul></div><pre class="screen">dd if=/dev/hd?? of=/tmp/recover_hd?? bs=512 skip=XXXX count=YYY</pre><p>XXX is the sector start and YYY the sector count (can be guessed). </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Mount the file as a loop file system. </p></li></ul></div><pre class="screen">mount -r -t ext2 -o loop /tmp/recover_hd?? /mnt/recover</pre><p>Use <span class="command"><strong>dd_rescue</strong></span> if the disk is really badly damaged. </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm321"></a>4.3. The rich man's case</h3></div></div></div><p>Partition Magic is a commercial (and proprietary) software product, not so cheap given the little use one can have (approx a hundred bucks in France), but with a very high reputation all around there. However, I never use it and will not rate it. It's said to be able to do anything with partitions, including restoring them. </p><p>Ralf's original partition-rescue mini HOWTO was essentially based around the use of Partition Magic, so I assume it's a very good solution, if you have valuable data on your Linux partition and little Linux capability. However, there are now much more recent releases of Partition Magic and I think it's better for you to read the manual. </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idm325"></a>4.4. PMagic</h3></div></div></div><p><a class="ulink" href="http://partedmagic.com/wiki/PartedMagic.php" target="_top">PartedMagic</a> if the tool of choice for any partition work, including recovery. Extremely good product (and open, of course). Read the HOWTO anyway, because you may need it to prevent disasters, but all the tools are on pmagic, this is the best recovery cd ever... </p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s03.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s05.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3. Technical info </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5. References</td></tr></table></div></body></html>
