<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.72">
 <TITLE>Linux Shadow Password HOWTO</TITLE>
</HEAD>
<BODY>
<H1>Linux Shadow Password HOWTO</H1>

<H2>Michael H. Jackson, <CODE>mhjack@tscnet.com</CODE></H2>v1.3, 3 April 1996
<HR>
<EM>This document aims to describe how to obtain, install, and configure the Linux
password Shadow Suite. It also discusses obtaining, and [re]installing other software and network daemons that require access to user
passwords.  This other software is not actually part of the Shadow Suite, but
these programs will need to be recompiled to support the Shadow
Suite.  This document also contains a programming example for adding shadow support to a program.  Answers to some of the more frequently asked questions are included near the end of this document.</EM>
<HR>
<H2><A NAME="s1">1. Introduction.</A></H2>

<P>This is the Linux Shadow-Password-HOWTO.  This document describes why and how
to add shadow password support on a Linux system.  Some examples of how to
use some of the <EM>Shadow Suite's</EM> features is also included.</P>
<P>When installing the <EM>Shadow Suite</EM> and when using many of the utility
programs, you must be logged in as <EM>root</EM>.  When installing the
<EM>Shadow Suite</EM> you will be making changes to system software, and it
is highly recommended that you make backup copies of programs as indicated. 
I also recommend that you read and understand all the instructions before
you begin.</P>

<H2><A NAME="ss1.1">1.1 Changes from the previous release.</A>
</H2>

<P>
<PRE>
Additions:
        Added a sub-section on why you might not want to install shadow
        Added a sub-section on updating the xdm program
        Added a section on how to put Shadow Suite features to work
        Added a section containing frequently asked questions

Corrections/Updates:
        Corrected html references on Sunsite
        Corrected section on wu-ftp to reflect adding -lshadow to the Makefile
        Corrected minor spelling and verbiage errors
        Changed section on wu-ftpd to support ELF
        Updated to reflect security problems in various login programs
        Updated to recommend the Linux Shadow Suite by Marek Michalkiewicz
</PRE>
</P>

<H2><A NAME="ss1.2">1.2 New versions of this document.</A>
</H2>

<P>The latest released version of this document can always be retrieved by 
anonymous FTP from:</P>
<P><B>sunsite.unc.edu</B>
<PRE>
/pub/Linux/docs/HOWTO/Shadow-Password-HOWTO
</PRE>

or:
<PRE>
/pub/Linux/docs/HOWTO/other-formats/Shadow-Password-HOWTO{-html.tar,ps,dvi}.gz
</PRE>
</P>
<P>or via the World Wide Web from the
<A HREF="http://sunsite.unc.edu/mdw/linux.html">Linux Documentation Project Web Server</A>, at page:
<A HREF="http://sunsite.unc.edu/linux/HOWTO/Shadow-Password-HOWTO.html">Shadow-Password-HOWTO</A>
or directly from me, <CODE>&lt;mhjack@tscnet.com></CODE>. It will
also be posted to the newsgroup: <CODE>comp.os.linux.answers</CODE></P>
<P>This document is now packaged with the Shadow-YYDDMM packages.</P>


<H2><A NAME="ss1.3">1.3 Feedback.</A>
</H2>

<P>Please send any comments, updates, or suggestions to me:
<A HREF="mailto:mhjack@tscnet.com">Michael H. Jackson &lt;mhjack@tscnet.com></A>  The sooner I get feedback, 
the sooner I can update and correct this document.  If you find any problems
with it, please mail me directly as I very rarely stay up-to-date on the 
newsgroups.</P>

<H2><A NAME="s2">2. Why shadow your passwd file?</A></H2>

<P>By default, most current Linux distributions do not contain the
<EM>Shadow Suite</EM> installed.  This includes Slackware 2.3, Slackware 3.0,
and other popular distributions.  One of the reasons for this is that
the copyright notices in the original <EM>Shadow Suite</EM> were not clear
on redistribution if a fee was charged.  Linux uses a GNU Copyright
(sometimes refereed to as a Copyleft) that allows people to package it into a
convenient package (like a CD-ROM distribution) and charge a fee for it. </P>
<P>The current maintainer of the <EM>Shadow Suite</EM>, 
<A HREF="mailto:marekm@i17linuxb.ists.pwr.wroc.pl">Marek Michalkiewicz &lt;marekm@i17linuxb.ists.pwr.wroc.pl></A> 
received the source code from the original author under a BSD style
copyright that allowed redistribution.   Now that the copyright issues 
are resolved, it is expected that future distributions will contain 
password shadowing by default.  Until then, you will need to install it
yourself.</P>
<P>If you installed your distribution from a CD-ROM, you may find that, even 
though the distribution did not have the <EM>Shadow Suite</EM> installed, 
some of the files you need to install the <EM>Shadow Suite</EM> may be on 
the CD-ROM.  </P>
<P><EM>However, Shadow Suite versions 3.3.1, 3.3.1-2, and shadow-mk all have
security problems with their login program and several other <EM>suid
root</EM> programs that came with them, and should no longer be used.</EM></P>
<P>All of the necessary files may be obtained via anonymous FTP or through the 
World Wide Web.</P>
<P>On a Linux system without the <EM>Shadow Suite</EM> installed, user
information including passwords is stored in the <CODE>/etc/passwd</CODE> file.
The password is stored in an <EM>encrypted</EM> format.  If you ask a
cryptography expert, however, he or she will tell you that the password
is actually in an <EM>encoded</EM> rather than <EM>encrypted</EM> format 
because when using crypt(3), the text is set to null and the password is the
key.  Therefore, from here on, I will use the term <EM>encoded</EM> in this
document.</P>
<P>The algorithm used to encode the password field is technically
referred to as a <EM>one way hash function</EM>.  This is an algorithm that
is easy to compute in one direction, but very difficult to calculate in the
reverse direction.  More about the actual algorithm used can be found
in section 2.4 or your crypt(3) manual page.</P>
<P>When a user picks or is assigned a password, it is encoded with a randomly 
generated value called the <EM>salt</EM>.  This means that any particular 
password could be stored in 4096 different ways.  The <EM>salt</EM> value 
is then stored with the encoded password.</P>
<P>When a user logs in and supplies a password, the <EM>salt</EM> is first
retrieved from the stored encoded password.  Then the supplied password is
<EM>encoded</EM> with the <EM>salt</EM> value, and then compared with the
<EM>encoded</EM> password.  If there is a match, then the user is
authenticated.</P>
<P>It is computationally difficult (but not impossible) to take a randomly
<EM>encoded</EM> password and recover the original password.  However, on
any system with more than just a few users, at least some of the passwords
will be common words (or simple variations of common words).</P>
<P>System crackers know all this, and will simply encrypt a dictionary of
words and common passwords using all possible 4096 <EM>salt</EM> values.  
Then they will compare the encoded passwords in your <CODE>/etc/passwd</CODE>
file with their database.  Once they have found a match, they have the
password for another account.  This is referred to as a <EM>dictionary 
attack</EM>, and is one of the most common methods for gaining or expanding
unauthorized access to a system.</P>
<P>If you think about it, an 8 character password encodes to 4096 * 13 character
strings.  So a dictionary of say 400,000 common words, names, passwords, and
simple variations would easily fit on a 4GB hard drive.  The attacker need
only sort them, and then check for matches.  Since a 4GB hard drive can be
had for under $1000.00, this is well within the means of most system
crackers.</P>
<P>Also, if a cracker obtains your <CODE>/etc/passwd</CODE> file first, they only 
need to encode the dictionary with the <CODE>salt</CODE> values actually 
contained in your <CODE>/etc/passwd</CODE> file.  This method is usable by your 
average teenager with a couple of hundred spare Megabytes and a 486 class 
computer.</P>
<P>Even without lots of drive space, utilities like crack(1) can usually break
at least a couple of passwords on a system with enough users (assuming the
users of the system are allowed to pick their own passwords).</P>
<P>The <CODE>/etc/passwd</CODE> file also contains information like user ID's and
group ID's that are used by many system programs.  Therefore, the 
<CODE>/etc/passwd</CODE> file <EM>must</EM> remain world readable.  If you were 
to change the <CODE>/etc/passwd</CODE> file so that nobody can read it, the 
first thing that you would notice is that the <CODE>ls -l</CODE> command now 
displays user ID's instead of names!</P>
<P>The <EM>Shadow Suite</EM> solves the problem by relocating the passwords to 
another file (usually <CODE>/etc/shadow</CODE>).  The <CODE>/etc/shadow</CODE> file is set so
that it cannot be read by just anyone.  Only <EM>root</EM> will be able to
read and write to the <CODE>/etc/shadow</CODE> file.  Some programs (like xlock)
don't need to be able to change passwords, they only need to be able to
verify them.  These programs can either be run <EM>suid root</EM> or you can
set up a group <EM>shadow</EM> that is allowed read only access to the 
<CODE>/etc/shadow</CODE> file.  Then the program can be run <EM>sgid
shadow</EM>.</P>
<P>By moving the passwords to the <CODE>/etc/shadow</CODE> file, we are effectively
keeping the attacker from having access to the encoded passwords with which
to perform a <EM>dictionary attack</EM>.</P>
<P>Additionally, the <EM>Shadow Suite</EM> adds lots of other nice features:
<UL>
<LI>A configuration file to set login defaults (<CODE>/etc/login.defs</CODE>)</LI>
<LI>Utilities for adding, modifying, and deleting user accounts and groups</LI>
<LI>Password aging and expiration</LI>
<LI>Account expiration and locking</LI>
<LI>Shadowed group passwords (optional)</LI>
<LI>Double length passwords (16 character passwords) [NOT RECOMMENDED]</LI>
<LI>Better control over user's password selection</LI>
<LI>Dial-up passwords</LI>
<LI>Secondary authentication programs [NOT RECOMMENDED]</LI>
</UL>
</P>
<P>Installing the <EM>Shadow Suite</EM> contributes toward a more 
secure system, but there are many other things that can also be done to 
improve the security of a Linux system, and there will eventually be a 
series of Linux Security HOWTO's that will discuss other security measures 
and related issues.</P>
<P>For current information on other Linux security issues, including warnings on
known vulnerabilities see the 
<A HREF="http://bach.cis.temple.edu/linux/linux-security/">Linux Security home page.</A></P>


<H2><A NAME="ss2.1">2.1 Why you might NOT want to shadow your passwd file.</A>
</H2>

<P>There are a few circumstances and configurations in which installing the
<EM>Shadow Suite</EM> would <EM>NOT</EM> be a good idea:
<UL>
<LI>The machine does not contain user accounts.</LI>
<LI>Your machine is running on a LAN and is using NIS (Network Information
Services) to get or supply user names and passwords to other machines on
the network.  (This can actually be done, but is beyond the scope of this
document, and really won't increase security much anyway)</LI>
<LI>Your machine is being used by terminal servers to verify users via NFS
(Network File System), NIS, or some other method.</LI>
<LI>Your machine runs other software that validates users, and there is no
shadow version available, and you don't have the source code.</LI>
</UL>
</P>


<H2><A NAME="ss2.2">2.2 Format of the /etc/passwd file</A>
</H2>

<P>A non-shadowed <CODE>/etc/passwd</CODE> file has the following format:
<BLOCKQUOTE><CODE>
<PRE>
username:passwd:UID:GID:full_name:directory:shell
</PRE>
</CODE></BLOCKQUOTE>

Where:
<DL>
<DT><B><CODE>username</CODE></B><DD>
<P>The user (login) name</P>
<DT><B><CODE>passwd</CODE></B><DD>
<P>The encoded password</P>
<DT><B><CODE>UID</CODE></B><DD>
<P>Numerical user ID</P>
<DT><B><CODE>GID</CODE></B><DD>
<P>Numerical default group ID</P>
<DT><B><CODE>full_name</CODE></B><DD>
<P>The user's full name - Actually this field is
called the GECOS (General Electric Comprehensive Operating System) field
and can store information other than just the full name.  The Shadow
commands and manual pages refer to this field as the comment field.</P>
<DT><B><CODE>directory</CODE></B><DD>
<P>User's home directory (Full pathname)</P>
<DT><B><CODE>shell</CODE></B><DD>
<P>User's login shell (Full Pathname)</P>
</DL>

For example:
<BLOCKQUOTE><CODE>
<PRE>
username:Npge08pfz4wuk:503:100:Full Name:/home/username:/bin/sh
</PRE>
</CODE></BLOCKQUOTE>

Where <CODE>Np</CODE> is the salt and <CODE>ge08pfz4wuk</CODE> is the <EM>encoded</EM>
password.  The encoded salt/password could just as easily have been
<CODE>kbeMVnZM0oL7I</CODE> and the two are exactly the same password.  There are
4096 possible encodings for the same password.  (The example password in 
this case is 'password', a really <EM>bad</EM> password).</P>
<P>Once the shadow suite is installed, the <CODE>/etc/passwd</CODE> file would 
instead contain:
<BLOCKQUOTE><CODE>
<PRE>
username:x:503:100:Full Name:/home/username:/bin/sh
</PRE>
</CODE></BLOCKQUOTE>

The <CODE>x</CODE> in the second field in this case is now just a place holder.
The format of the <CODE>/etc/passwd</CODE> file really didn't change, it just no 
longer contains the <EM>encoded</EM> password.  This means that any program 
that reads the <CODE>/etc/passwd</CODE> file but does not actually need to verify
passwords will still operate correctly.</P>
<P>The passwords are now relocated to the shadow file (usually 
<CODE>/etc/shadow</CODE> file).</P>

<H2><A NAME="ss2.3">2.3 Format of the shadow file</A>
</H2>

<P>The <CODE>/etc/shadow</CODE> file contains the following information:
<BLOCKQUOTE><CODE>
<PRE>
username:passwd:last:may:must:warn:expire:disable:reserved
</PRE>
</CODE></BLOCKQUOTE>

Where:
<DL>
<DT><B><CODE>username</CODE></B><DD>
<P>The User Name</P>
<DT><B><CODE>passwd</CODE></B><DD>
<P>The Encoded password</P>
<DT><B><CODE>last</CODE></B><DD>
<P>Days since Jan 1, 1970 that password was last changed</P>
<DT><B><CODE>may</CODE></B><DD>
<P>Days before password may be changed</P>
<DT><B><CODE>must</CODE></B><DD>
<P>Days after which password must be changed</P>
<DT><B><CODE>warn</CODE></B><DD>
<P>Days before password is to expire that user is warned</P>
<DT><B><CODE>expire</CODE></B><DD>
<P>Days after password expires that account is disabled</P>
<DT><B><CODE>disable</CODE></B><DD>
<P>Days since Jan 1, 1970 that account is disabled</P>
<DT><B><CODE>reserved</CODE></B><DD>
<P>A reserved field</P>
</DL>

The previous example might then be:
<BLOCKQUOTE><CODE>
<PRE>
username:Npge08pfz4wuk:9479:0:10000::::
</PRE>
</CODE></BLOCKQUOTE>
</P>

<H2><A NAME="ss2.4">2.4 Review of crypt(3).</A>
</H2>

<P>From the crypt(3) manual page:</P>
<P>&#34;<EM>crypt</EM> is the password encryption function.  It is based on
the <EM>Data Encryption Standard</EM> algorithm with variations intended (among 
other things) to discourage use of hardware implementations of a key search.</P>
<P>[The] key is a user's typed password.  [The encoded string is all NULLs]</P>
<P>[The] <EM>salt</EM> is a two-character string chosen from the set
[a-zA-Z0-9./].  This string is used to perturb the algorithm in one of 4096
different ways.</P>
<P>By taking the lowest 7 bit[s] of each character of the key, a 56-bit key is 
obtained.  This 56-bit key is used to encrypt repeatedly a constant string
(usually a string consisting of all zeros).  The returned value points to
the encrypted password, a series of 13 printable ASCII characters (the first
two characters represent the salt itself).  The return value points to static
data whose content is overwritten by each call.</P>
<P> 
<B>Warning:</B> The key space consists of 2**56 equal 7.2e16 possible values.
Exhaustive searches of this key space <B>are possible</B> using massively
parallel computers.  Software, such as <CODE>crack(1)</CODE>, is available which
will search the portion of this key space that is generally used by humans 
for passwords.  Hence, password selection should, at minimum, avoid common
words and names.  The use of a <CODE>passwd(1)</CODE> program that checks for
crackable passwords during the selection process is recommended.</P>
<P>The DES algorithm itself has a few quirks which make the use of the
<CODE>crypt(3)</CODE> interface a very poor choice for anything other than 
password authentication.  If you are planning on using the <CODE>crypt(3)</CODE> 
interface for a cryptography project, don't do it: get a good book on 
encryption and one of the widely available DES libraries.&#34;</P>
<P>Most <EM>Shadow Suites</EM> contain code for doubling the length of the
password to 16 characters.  Experts in <CODE>des</CODE> recommend against this, 
as the encoding is simply applied first to the left half and then to the 
right half of the longer password.  Because of the way <CODE>crypt</CODE> works, 
this may make for a <EM>less</EM> secure encoded password then if double 
length passwords were not used in the first place.  Additionally, it is less 
likely that a user will be able to remember a 16 character password.</P>
<P>There is development work under way that would allow the authentication 
algorithm to be replaced with something more secure and with support for 
longer passwords (specifically the MD5 algorithm) and retain compatibility
with the <CODE>crypt</CODE> method.</P>
<P>If you are looking for a good book on encryption, I recommend:
<PRE>
        "Applied Cryptography: Protocols, Algorithms, and Source Code in C"
        by Bruce Schneier &lt;schneier@chinet.com>
        ISBN: 0-471-59756-2
</PRE>
</P>


<H2><A NAME="s3">3. Getting the Shadow Suite.</A></H2>

<H2><A NAME="ss3.1">3.1 History of the Shadow Suite for Linux</A>
</H2>

<P><EM>DO NOT USE THE PACKAGES IN THIS SECTION, THEY HAVE SECURITY PROBLEMS</EM></P>
<P>The original <EM>Shadow Suite</EM> was written by <CODE>John F. Haugh II</CODE>.</P>
<P>There are several versions that have been used on Linux systems:
<UL>
<LI><CODE>shadow-3.3.1</CODE> is the original.</LI>
<LI><CODE>shadow-3.3.1-2</CODE> is Linux specific patch made by
<A HREF="mailto:flla@stud.uni-sb.de">Florian La Roche &lt;flla@stud.uni-sb.de></A> and contains some further
enhancements.</LI>
<LI><CODE>shadow-mk</CODE> was specifically packaged for Linux.</LI>
</UL>
</P>
<P>The <CODE>shadow-mk</CODE> package contains the <CODE>shadow-3.3.1</CODE> package
distributed by <CODE>John F. Haugh II</CODE> with the <CODE>shadow-3.3.1-2 patch</CODE> 
installed, a few fixes made by 
<A HREF="mailto:magnus@texas.net">Mohan Kokal &lt;magnus@texas.net></A>
that make installation a lot easier, a patch by <CODE>Joseph R.M. Zbiciak</CODE>
for <CODE>login1.c</CODE> (login.secure) that eliminates the -f, -h security
holes in /bin/login, and some other miscellaneous patches.</P>
<P>The <CODE>shadow.mk</CODE> package was the <EM>previously</EM> recommended
package, but should be replaced due to a <EM>security problem</EM> with the
<CODE>login</CODE> program.</P>
<P>There are <EM>security problems</EM> with Shadow versions 3.3.1, 3.3.1-2, 
and shadow-mk involving the <CODE>login</CODE> program.  This <CODE>login</CODE> bug 
involves not checking the length of a login name.  This causes the buffer to
overflow causing crashes or worse.  It has been rumored that this buffer
overflow can allow someone with an account on the system to use this bug and
the shared libraries to gain <EM>root</EM> access.  I won't discuss exactly 
how this is possible because there are a lot of Linux systems that are 
affected, but systems with these <EM>Shadow Suites</EM> installed, and 
most pre-ELF distributions <EM>without</EM> the <EM>Shadow Suite</EM> 
are vulnerable!</P>
<P>For more information on this and other Linux security issues, see the 
<A HREF="http://bach.cis.temple.edu/linux/linux-security/Linux-Security-FAQ/Linux-telnetd.html">Linux Security home page (Shared Libraries and login Program Vulnerability)</A></P>


<H2><A NAME="ss3.2">3.2 Where to get the Shadow Suite.</A>
</H2>

<P>The only recommended <EM>Shadow Suite</EM> is still in BETA testing, however 
the latest versions are safe in a production environment and don't contain a
vulnerable <CODE>login</CODE> program.</P>
<P>The package uses the following naming convention:
<BLOCKQUOTE><CODE>
<PRE>
shadow-YYMMDD.tar.gz
</PRE>
</CODE></BLOCKQUOTE>

where <CODE>YYMMDD</CODE> is the issue date of the Suite.</P>
<P>This version will eventually be <EM>Version 3.3.3</EM> when it is released
from Beta testing, and is maintained by 
<A HREF="mailto:marekm@i17linuxb.ists.pwr.wroc.pl">Marek Michalkiewicz &lt;marekm@i17linuxb.ists.pwr.wroc.pl></A>. 
It's available as: 
<A HREF="ftp://i17linuxb.ists.pwr.wroc.pl/pub/linux/shadow/shadow-current.tar.gz">shadow-current.tar.gz</A>.</P>
<P>The following mirror sites have also been established:
<UL>
<LI>
<A HREF="ftp://ftp.icm.edu.pl/pub/Linux/shadow/shadow-current.tar.gz">ftp://ftp.icm.edu.pl/pub/Linux/shadow/shadow-current.tar.gz</A></LI>
<LI>
<A HREF="ftp://iguana.hut.fi/pub/linux/shadow/shadow-current.tar.gz">ftp://iguana.hut.fi/pub/linux/shadow/shadow-current.tar.gz</A></LI>
<LI>
<A HREF="ftp://ftp.cin.net/usr/ggallag/shadow/shadow-current.tar.gz">ftp://ftp.cin.net/usr/ggallag/shadow/shadow-current.tar.gz</A></LI>
<LI>
<A HREF="ftp://ftp.netural.com/pub/linux/shadow/shadow-current.tar.gz">ftp://ftp.netural.com/pub/linux/shadow/shadow-current.tar.gz</A></LI>
</UL>
</P>
<P>You should use the currently available version.</P>
<P>You should NOT use a version <EM>older</EM> than <CODE>shadow-960129</CODE> as 
they also have the <CODE>login</CODE> security problem discussed above. </P>
<P>When this document refers to the <EM>Shadow Suite</EM> I am referring to the 
this package.  It is assumed that this is the package that you are using.</P>
<P>For reference, I used <CODE>shadow-960129</CODE> to make these installation
instructions.</P>
<P>If you were previously using <CODE>shadow-mk</CODE>, you should upgrade to this
version and rebuild everything that you originally compiled.</P>

<H2><A NAME="ss3.3">3.3 What is included with the Shadow Suite.</A>
</H2>

<P>The <EM>Shadow Suite</EM> contains replacement programs for:</P>
<P><CODE>su, login, passwd, newgrp, chfn, chsh, and id</CODE></P>
<P>The package also contains the new programs:</P>
<P><CODE>chage, newusers, dpasswd, gpasswd, useradd, userdel, usermod, groupadd,
groupdel, groupmod, groups, pwck, grpck, lastlog, pwconv, and pwunconv</CODE></P>
<P>Additionally, the library: <CODE>libshadow.a</CODE> is included for writing and/or
compiling programs that need to access user passwords.</P>
<P>Also, manual pages for the programs are also included.</P>
<P>There is also a configuration file for the login program which will be
installed as <CODE>/etc/login.defs</CODE>.</P>

<H2><A NAME="s4">4. Compiling the programs.</A></H2>

<H2><A NAME="ss4.1">4.1 Unpacking the archive.</A>
</H2>

<P>The first step after retrieving the package is unpacking it.  The package
is in the tar (tape archive) format and compressed using gzip, so first move
it to <CODE>/usr/src</CODE>, then type:
<BLOCKQUOTE><CODE>
<PRE>
tar -xzvf shadow-current.tar.gz
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>This will unpack it into the directory: <CODE>/usr/src/shadow-YYMMDD</CODE></P>

<H2><A NAME="ss4.2">4.2 Configuring with the config.h file</A>
</H2>

<P>The first thing that you need to do is to copy over the <CODE>Makefile</CODE>
and the <CODE>config.h</CODE> file:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src/shadow-YYMMDD
cp Makefile.linux Makefile
cp config.h.linux config.h
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>You should then take a look at the <CODE>config.h</CODE> file.  This file 
contains definitions for some of the configuration options.  If you are 
using the <EM>recommended</EM> package, I recommend that you disable group
shadow support for your first time around.</P>
<P>By default shadowed group passwords are enabled.  To disable these edit the 
<CODE>config.h</CODE> file, and change the <CODE>#define SHADOWGRP</CODE> to 
<CODE>#undef SHADOWGRP</CODE>. I recommend that you disable them to start 
with, and then if you really want group passwords and group administrators 
that you enable it later and recompile.  If you leave it enabled, you 
<EM>must</EM> create the file <CODE>/etc/gshadow</CODE>.</P>
<P>Enabling the long passwords option is NOT recommended as discussed above.</P>
<P><EM>Do NOT</EM> change the setting: <CODE>#undef AUTOSHADOW</CODE></P>
<P>The <CODE>AUTOSHADOW</CODE> option was originally designed so that programs 
that were shadow ignorant would still function.  This sounds good in theory, 
but does not work correctly.  If you enable this option, and the program runs
as root, it may call <CODE>getpwnam()</CODE> as root, and later write the modified 
entry back to the <CODE>/etc/passwd</CODE> file (with the <EM>no-longer-shadowed 
password</EM>).  Such programs include chfn and chsh.  (You can't get around 
this by swapping real and effective uid before calling <CODE>getpwnam()</CODE>
because root may use chfn and chsh too.)</P>
<P>The same warning is also valid if you are building libc, it has a 
<CODE>SHADOW_COMPAT</CODE> option which does the same thing.  It <EM>should
NOT</EM> be used!  If you start getting encoded passwords back in your 
<CODE>/etc/passwd</CODE> file, this is the problem.</P>
<P>If you are using a <CODE>libc</CODE> version prior to 4.6.27, you will need to
make a couple more changes to <CODE>config.h</CODE> and the <CODE>Makefile</CODE>. 
To <CODE>config.h</CODE> edit and change:
<BLOCKQUOTE><CODE>
<PRE>
#define HAVE_BASENAME
</PRE>
</CODE></BLOCKQUOTE>

to:
<BLOCKQUOTE><CODE>
<PRE>
#undef HAVE_BASENAME
</PRE>
</CODE></BLOCKQUOTE>

And then in the <CODE>Makefile</CODE>, change:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
SOBJS = smain.o env.o entry.o susetup.o shell.o \
        sub.o mail.o motd.o sulog.o age.o tz.o hushed.o

SSRCS = smain.c env.c entry.c setup.c shell.c \
        pwent.c sub.c mail.c motd.c sulog.c shadow.c age.c pwpack.c rad64.c \
        tz.c hushed.c
</PRE>
</CODE></BLOCKQUOTE>

<BLOCKQUOTE><CODE>
<PRE>
SOBJS = smain.o env.o entry.o susetup.o shell.o \
        sub.o mail.o motd.o sulog.o age.o tz.o hushed.o basename.o

SSRCS = smain.c env.c entry.c setup.c shell.c \
        pwent.c sub.c mail.c motd.c sulog.c shadow.c age.c pwpack.c rad64.c \
        tz.c hushed.c basename.c
</PRE>
</CODE></BLOCKQUOTE>

These changes add the code contained in <CODE>basename.c</CODE> which is
contained in <CODE>libc 4.6.27</CODE> and later.</P>

<H2><A NAME="ss4.3">4.3 Making backup copies of your original programs.</A>
</H2>

<P>It would also be a good idea to track down and make backup copies of the
programs that the shadow suite will replace.  On a Slackware 3.0 system 
these are:
<UL>
<LI>/bin/su</LI>
<LI>/bin/login</LI>
<LI>/usr/bin/passwd</LI>
<LI>/usr/bin/newgrp</LI>
<LI>/usr/bin/chfn</LI>
<LI>/usr/bin/chsh</LI>
<LI>/usr/bin/id</LI>
</UL>
</P>
<P>The BETA package has a <EM>save</EM> target in the Makefile, but it's 
commented out because different distributions place the programs in
different places.</P>
<P>You should also make a backup copy of your <CODE>/etc/passwd</CODE> file, but be
careful to name it something else if you place it in the same directory
so you don't overwrite the <CODE>passwd</CODE> command.</P>

<H2><A NAME="ss4.4">4.4 Running make</A>
</H2>

<P><EM>You need to be logged as root to do most of the installation</EM>.</P>
<P>Run make to compile the executables in the package:
<BLOCKQUOTE><CODE>
<PRE>
make all
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>You may see the warning: <CODE>rcsid defined but not used</CODE>.  This is fine,
it just happens because the author is using a version control package.</P>

<H2><A NAME="s5">5. Installing</A></H2>

<H2><A NAME="ss5.1">5.1 Have a boot disk handy in case you break anything.</A>
</H2>

<P>If something goes terribly wrong, it would be handy to have a boot disk.
If you have a boot/root combination from your installation, that will work,
otherwise see the 
<A HREF="http://sunsite.unc.edu/mdw/HOWTO/Bootdisk-HOWTO.html">Bootdisk-HOWTO</A>, which describes how to make a bootable disk.</P>

<H2><A NAME="ss5.2">5.2 Removing duplicate man pages</A>
</H2>

<P>You should also move the manual pages that are about to be replaced.  Even
if you are brave enough install the Shadow Suite without making backups, you
will still want to remove the old manual pages.  The new manual pages won't
normally overwrite the old ones because the old ones are probably compressed.</P>
<P>You can use a combination of: <CODE>man -aW command</CODE> and <CODE>locate
command</CODE> to locate the manual pages that need to be (re)moved.  It's
generally easier to figure out which are the older pages before you run 
<CODE>make install</CODE>.</P>
<P>If you are using the Slackware 3.0 distribution, then the manual pages you 
want to remove are:
<UL>
<LI>/usr/man/man1/chfn.1.gz</LI>
<LI>/usr/man/man1/chsh.1.gz</LI>
<LI>/usr/man/man1/id.1.gz</LI>
<LI>/usr/man/man1/login.1.gz</LI>
<LI>/usr/man/man1/passwd.1.gz</LI>
<LI>/usr/man/man1/su.1.gz</LI>
<LI>/usr/man/man5/passwd.5.gz</LI>
</UL>
</P>
<P>There may also be man pages of the same name in the <CODE>/var/man/cat[1-9]</CODE>
subdirectories that should also be deleted.</P>

<H2><A NAME="ss5.3">5.3 Running make install</A>
</H2>

<P>You are now ready to type: (do this as root)
<BLOCKQUOTE><CODE>
<PRE>
make install
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>This will install the new and replacement programs and fix-up the file
permissions.  It will also install the man pages.</P>
<P>This also takes care of installing the Shadow Suite include files in the
correct places in <CODE>/usr/include/shadow</CODE>.</P>
<P>Using the BETA package you must manually copy the file <CODE>login.defs</CODE>
to the <CODE>/etc</CODE> subdirectory and make sure that only <EM>root</EM> can
make changes to it.
<BLOCKQUOTE><CODE>
<PRE>
cp login.defs /etc
chmod 700 /etc/login.defs
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>This file is the configuration file for the <EM>login</EM> program.  
You should review and make changes to this file for your particular system.
This is where you decide which tty's root can login from, and set other
security policy settings (like password expiration defaults).</P>

<H2><A NAME="ss5.4">5.4 Running pwconv</A>
</H2>

<P>The next step is to run <CODE>pwconv</CODE>.  This must also be done as
<EM>root</EM>, and is best done from the <CODE>/etc</CODE> subdirectory:
<BLOCKQUOTE><CODE>
<PRE>
cd /etc
/usr/sbin/pwconv
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P><CODE>pwconv</CODE> takes your <CODE>/etc/passwd</CODE> file and strips out the
fields to create two files: <CODE>/etc/npasswd</CODE> and <CODE>/etc/nshadow</CODE>.</P>
<P>A <CODE>pwunconv</CODE> program is also provided if you need to make a normal
<CODE>/etc/passwd</CODE> file out of an <CODE>/etc/passwd</CODE> and
<CODE>/etc/shadow</CODE> combination.</P>

<H2><A NAME="ss5.5">5.5 Renaming npasswd and nshadow</A>
</H2>

<P>Now that you have run <CODE>pwconv</CODE> you have created the files 
<CODE>/etc/npasswd</CODE> and <CODE>/etc/nshadow</CODE>.  These need to be copied
over to <CODE>/etc/passwd</CODE> and <CODE>/etc/shadow</CODE>.  We also want to make
a backup copy of the original <CODE>/etc/passwd</CODE> file, and make sure only
root can read it.  We'll put the backup in root's home directory:
<BLOCKQUOTE><CODE>
<PRE>
cd /etc
cp passwd ~passwd
chmod 600 ~passwd
mv npasswd passwd
mv nshadow shadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>You should also ensure that the file ownerships and permissions are
correct.  If you are going to be using <EM>X-Windows</EM>, the
<CODE>xlock</CODE> and <CODE>xdm</CODE> programs need to be able to read the 
<CODE>shadow</CODE> file (but not write it).</P>
<P>There are two ways that this can be done.  You can set <CODE>xlock</CODE> to
suid root (<CODE>xdm</CODE> is usually run as root anyway).  Or you can make
the <CODE>shadow</CODE> file owned by <CODE>root</CODE> with a group of 
<CODE>shadow</CODE>, but before you do this, make sure that you have a shadow 
group (look in <CODE>/etc/group</CODE>).  None of the users on the system 
should actually be in the shadow group.
<BLOCKQUOTE><CODE>
<PRE>
chown root.root passwd
chown root.shadow shadow
chmod 0644 passwd
chmod 0640 shadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Your system now has the password file shadowed.  You <EM>should</EM> now pop 
over to another virtual terminal and verify that you can login.</P>
<P><EM>Really, do this now!</EM></P>
<P>If you can't, then something is wrong!  To get back to a non-shadowed state,
do the following the following:
<BLOCKQUOTE><CODE>
<PRE>
cd /etc
cp ~passwd passwd
chmod 644 passwd
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>You would then restore the files that you saved earlier to their proper
locations.</P>


<H2><A NAME="s6">6. Other programs you may need to upgrade or patch</A></H2>

<P>Even though the shadow suite contains replacement programs for most
programs that need to access passwords, there are a few additional programs
on most systems that require access to passwords.</P>
<P>If you are running a <EM>Debian Distribution</EM> (or even if you are not), 
you can obtain Debian sources for the programs that need to be rebuild from:
ftp://ftp.debian.org/debian/stable/source/</P>
<P>The remainder of this section discusses how to upgrade <CODE>adduser</CODE>, 
<CODE>wu_ftpd</CODE>, <CODE>ftpd</CODE>, <CODE>pop3d</CODE>, <CODE>xlock</CODE>,
<CODE>xdm</CODE> and <CODE>sudo</CODE> so that they support the shadow suite.</P>
<P>See the section 
<A HREF="#sec-adding">Adding Shadow Support to a C program</A> 
for a discussion on how to put shadow support into any other program
that needs it (although the program must then be run SUID root or SGID shadow
to be able to actually access the shadow file).</P>

<H2><A NAME="ss6.1">6.1 Slackware adduser program</A>
</H2>

<P>Slackware distributions (and possibly some others) contain a interactive 
program for adding users called <CODE>/sbin/adduser</CODE>.  A shadow version
of this program can be obtained from 
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Admin/accounts/adduser.shadow-1.4.tgz">ftp://sunsite.unc.edu/pub/Linux/ system/Admin/accounts/adduser.shadow-1.4.tar.gz</A>.</P>
<P>I would encourage you to use the programs that are supplied with the
<EM>Shadow Suite</EM> (<CODE>useradd</CODE>, <CODE>usermod</CODE>, and
<CODE>userdel</CODE>) instead of the slackware <CODE>adduser</CODE> program.  They
take a little time to learn how to use, but it's well worth the effort
because you have much more control and they perform proper file locking on
the <CODE>/etc/passwd</CODE> and <CODE>/etc/shadow</CODE> file (<CODE>adduser</CODE> 
doesn't).</P>
<P>See the section on 
<A HREF="#sec-work">Putting the Shadow Suite to use</A> 
for more information.</P>
<P>But if you gotta have it, here is what you do:
<BLOCKQUOTE><CODE>
<PRE>
tar -xzvf adduser.shadow-1.4.tar.gz
cd adduser
make clean
make adduser
chmod 700 adduser
cp adduser /sbin
</PRE>
</CODE></BLOCKQUOTE>
</P>

<H2><A NAME="ss6.2">6.2 The wu_ftpd Server</A>
</H2>

<P>Most Linux systems some with the <CODE>wu_ftpd</CODE> server.  If your
distribution does not come with shadow installed, then your <CODE>wu_ftpd</CODE>
will not be compiled for shadow.  <CODE>wu_ftpd</CODE> is launched from
<CODE>inetd/tcpd</CODE> as a <EM>root</EM> process.  If you are running an old
<CODE>wu_ftpd</CODE> daemon, you will want to upgrade it anyway because older
ones had a bug that would allow the <EM>root</EM> account to be compromised
(For more info see the 
<A HREF="http://bach.cis.temple.edu/linux/linux-security/Linux-Security-FAQ/Linux-wu.ftpd-2.4-Update.html">Linux security home page</A>).</P>
<P>Fortunately, you only need to get the source code and recompile it
with shadow enabled.</P>
<P>If you are not running an ELF system, The <CODE>wu_ftp</CODE> server can be 
found on Sunsite as 
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Network/file-transfer/wu-ftpd-2.4-fixed.tar.gz">wu-ftp-2.4-fixed.tar.gz</A></P>
<P>Once you retrieve the server, put it in <CODE>/usr/src</CODE>, then type:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src
tar -xzvf wu-ftpd-2.4-fixed.tar.gz
cd wu-ftpd-2.4-fixed
cp ./src/config/config.lnx.shadow ./src/config/config.lnx
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then edit <CODE>./src/makefiles/Makefile.lnx</CODE>, and change the line:
<BLOCKQUOTE><CODE>
<PRE>
LIBES    = -lbsd -support
</PRE>
</CODE></BLOCKQUOTE>

to:
<BLOCKQUOTE><CODE>
<PRE>
LIBES    = -lbsd -support -lshadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Now you are ready to run the build script and install:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src/wu-ftpd-2.4-fixed
/usr/src/wu-ftp-2.4.fixed/build lnx
cp /usr/sbin/wu.ftpd /usr/sbin/wu.ftpd.old
cp ./bin/ftpd /usr/sbin/wu.ftpd
</PRE>
</CODE></BLOCKQUOTE>
 </P>
<P>This uses the Linux shadow configuration file, compiles and installs
the server.  </P>
<P>On my Slackware 2.3 system I also had to do the following before running
<CODE>build</CODE>:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/include/netinet
ln -s in_systm.h in_system.h
cd -
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Problems have been reported compiling this package under ELF systems, but
the Beta version of the next release works fine.
It can be found as 
<A HREF="ftp://tscnet.com/pub/linux/network/ftp/wu-ftpd-2.4.2-beta-10.tar.gz">wu-ftp-2.4.2-beta-10.tar.gz</A></P>
<P>Once you retrieve the server, put it in <CODE>/usr/src</CODE>, then type:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src
tar -xzvf wu-ftpd-2.4.2-beta-9.tar.gz
cd wu-ftpd-beta-9
cd ./src/config
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then edit <CODE>config.lnx</CODE>, and change:
<BLOCKQUOTE><CODE>
<PRE>
#undef SHADOW.PASSWORD
</PRE>
</CODE></BLOCKQUOTE>

to:
<BLOCKQUOTE><CODE>
<PRE>
#define SHADOW.PASSWORD
</PRE>
</CODE></BLOCKQUOTE>

Then,
<BLOCKQUOTE><CODE>
<PRE>
cd ../Makefiles
</PRE>
</CODE></BLOCKQUOTE>

and edit the file <CODE>Makefile.lnx</CODE>
and change:
<BLOCKQUOTE><CODE>
<PRE>
LIBES = -lsupport -lbsd # -lshadow
</PRE>
</CODE></BLOCKQUOTE>

to:
<BLOCKQUOTE><CODE>
<PRE>
LIBES = -lsupport -lbsd -lshadow
</PRE>
</CODE></BLOCKQUOTE>

Then build and install:
<BLOCKQUOTE><CODE>
<PRE>
cd ..
build lnx
cp /usr/sbin/wu.ftpd /usr/sbin/wu.ftpd.old
cp ./bin/ftpd /usr/sbin/wu.ftpd
</PRE>
</CODE></BLOCKQUOTE>
 </P>
<P>Note that you should check your <CODE>/etc/inetd.conf</CODE> file to make sure
that this is where your wu.ftpd server really lives.  It has been reported
that some distributions place the server daemons in different places, and
then wu.ftpd in particular may be named something else.</P>

<H2><A NAME="ss6.3">6.3 Standard ftpd</A>
</H2>

<P>If you are running the standard <CODE>ftpd</CODE> server, I would recommend that
you upgrade to the <CODE>wu_ftpd</CODE> server.  Aside from the known bug
discussed above, it's generally thought to be more secure.</P>
<P>If you insist on the standard one, or you need <EM>NIS</EM> support, Sunsite
has 
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Network/file-transfer/ftpd-shadow-nis.tgz">ftpd-shadow-nis.tgz</A></P>

<H2><A NAME="ss6.4">6.4 pop3d (Post Office Protocol 3)</A>
</H2>

<P>If you need to support the third <EM>Post Office Protocol (POP3)</EM>, you
will need to recompile a <CODE>pop3d</CODE> program.  <CODE>pop3d</CODE> is normally
run by <CODE>inetd/tcpd</CODE> as <CODE>root</CODE>.</P>
<P>There are two versions available from Sunsite: 
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Mail/pop/pop3d-1.00.4.linux.shadow.tar.gz">pop3d-1.00.4.linux.shadow.tar.gz</A>
and 
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Mail/pop/pop3d+shadow+elf.tar.gz">pop3d+shadow+elf.tar.gz</A></P>
<P>Both of these are fairly straight forward to install.</P>

<H2><A NAME="ss6.5">6.5 xlock</A>
</H2>

<P>If you install the shadow suite, and then run <EM>X Windows System</EM> and 
lock the screen without upgrading your <CODE>xlock</CODE>, you will have to use
<CODE>CNTL-ALT-Fx</CODE> to switch to another <EM>tty</EM>, login, and kill the
<CODE>xlock</CODE> process (or use <CODE>CNTL-ALT-BS</CODE> to kill the X server).
Fortunately it's fairly easy to upgrade your <CODE>xlock</CODE> program.</P>
<P>If you are running XFree86 Versions 3.x.x, you are probably using
<CODE>xlockmore</CODE> (which is a great screen-saver in addition to a lock).
This package supports <EM>shadow</EM> with a recompile.  If you have an
older <CODE>xlock</CODE>, I recommend that you upgrade to this one.</P>
<P><CODE>xlockmore-3.5.tgz</CODE> is available at:
<A HREF="ftp://sunsite.unc.edu/pub/Linux/X11/xutils/screensavers/xlockmore-3.7.tgz">ftp://sunsite.unc.edu/pub/Linux/X11/xutils/screensavers/xlockmore-3.7.tgz</A></P>
<P>Basically, this is what you need to do:</P>
<P>Get the <CODE>xlockmore-3.7.tgz</CODE> file and put it in <CODE>/usr/src</CODE> unpack it:
<BLOCKQUOTE><CODE>
<PRE>
tar -xzvf xlockmore-3.7.tgz
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Edit the file: <CODE>/usr/X11R6/lib/X11/config/linux.cf</CODE>, and change the line:
<BLOCKQUOTE><CODE>
<PRE>
#define HasShadowPasswd    NO

to

#define HasShadowPasswd    YES
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then build the executables:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src/xlockmore
xmkmf
make depend
make
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then move everything into place and update file ownerships and permissions:
<BLOCKQUOTE><CODE>
<PRE>
cp xlock /usr/X11R6/bin/
cp XLock /var/X11R6/lib/app-defaults/
chown root.shadow /usr/X11R6/bin/xlock
chmod 2755 /usr/X11R6/bin/xlock
chown root.shadow /etc/shadow
chmod 640 /etc/shadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Your xlock will now work correctly.</P>

<H2><A NAME="ss6.6">6.6 xdm</A>
</H2>

<P><CODE>xdm</CODE> is a program that presents a login screen for X-Windows.  Some
systems start <CODE>xdm</CODE> when the system is told to goto a specified run
level (see <CODE>/etc/inittab</CODE>.</P>
<P>With the <EM>Shadow Suite</EM> install, <CODE>xdm</CODE> will need to be
updated.  Fortunately it's fairly easy to upgrade your <CODE>xdm</CODE> program.</P>

<P><CODE>xdm.tar.gz</CODE> is available at:
<A HREF="ftp://sunsite.unc.edu/pub/Linux/X11/xutils/xdm.tar.gz">ftp://sunsite.unc.edu/pub/Linux/X11/xutils/xdm.tar.gz</A></P>
<P>Get the <CODE>xdm.tar.gz</CODE> file and put it in <CODE>/usr/src</CODE>, then to 
unpack it:
<BLOCKQUOTE><CODE>
<PRE>
tar -xzvf xdm.tar.gz
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Edit the file: <CODE>/usr/X11R6/lib/X11/config/linux.cf</CODE>, and change the line:
<BLOCKQUOTE><CODE>
<PRE>
#define HasShadowPasswd    NO

to

#define HasShadowPasswd    YES
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then build the executables:
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src/xdm
xmkmf
make depend
make
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then move everything into place:
<BLOCKQUOTE><CODE>
<PRE>
cp xdm /usr/X11R6/bin/
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P><CODE>xdm</CODE> is run as <EM>root</EM> so you don't need to change it file
permissions.</P>


<H2><A NAME="ss6.7">6.7 sudo</A>
</H2>

<P>The program <CODE>sudo</CODE> allows a system administrator to let users run
programs that would normally require root access.  This is handy because it
lets the administrator limit access to the root account itself while still
allowing users to do things like mounting drives.</P>
<P><CODE>sudo</CODE> needs to read passwords because it verifies the users password
when it's invoked.  <CODE>sudo</CODE> already runs SUID root, so accessing the
<CODE>/etc/shadow</CODE> file is not a problem.</P>
<P><CODE>sudo</CODE> for the shadow suite, is available as at:
<A HREF="ftp://sunsite.unc.edu/pub/Linux/system/Admin/sudo-1.2-shadow.tgz">ftp://sunsite.unc.edu/pub/Linux/system/Admin/sudo-1.2-shadow.tgz</A></P>
<P><EM>Warning</EM>: When you install <CODE>sudo</CODE> your <CODE>/etc/sudoers</CODE>
file will be replaced with a default one, so you need to make a backup of it
if you have added anything to the default one.  (you could also edit the
Makefile and remove the line that copies the default file to <CODE>/etc</CODE>).</P>
<P>The package is already setup for shadow, so all that's required is to
recompile the package (put it in <CODE>/usr/src</CODE>):
<BLOCKQUOTE><CODE>
<PRE>
cd /usr/src
tar -xzvf sudo-1.2-shadow.tgz
cd sudo-1.2-shadow
make all
make install
</PRE>
</CODE></BLOCKQUOTE>
</P>

<H2><A NAME="ss6.8">6.8 imapd (E-Mail [pine package])</A>
</H2>

<P><CODE>imapd</CODE> is an e-mail server similar to <CODE>pop3d</CODE>. 
<CODE>imapd</CODE> comes with the <EM>Pine E-mail</EM> package.  The 
documentation that comes with the package states that the default for 
Linux systems is to include support for shadow.  However, I have found 
that this is not true.  Furthermore, the build script / Makefile combination 
on this package is makes it very difficult to add the <CODE>libshadow.a</CODE>
library at compile time, so I was unable to add shadow support for
<CODE>imapd</CODE>.</P>
<P>If anyone has this figured out, please E-mail me, and I'll include the
solution here.</P>

<H2><A NAME="ss6.9">6.9 pppd (Point-to-Point Protocol Server)</A>
</H2>

<P>The pppd server can be setup to use several types of authentication:
<EM>Password Authentication Protocol</EM> (PAP) and <EM>Cryptographic
Handshake Authentication Protocol</EM> (CHAP).  The pppd server usually
reads the password strings that it uses from <CODE>/etc/ppp/chap-secrets</CODE>
and/or <CODE>/etc/ppp/pap-secrets</CODE>.  If you are using this default behavior
of pppd, it is not necessary to reinstall pppd.</P>
<P>pppd also allows you to use the <EM>login</EM> parameter (either on the
command line, or in the configuration or <CODE>options</CODE> file).  If the
<EM>login</EM> option is given, then pppd will use the <CODE>/etc/passwd</CODE>
file for the username and passwords for the <EM>PAP</EM>.  This, of course,
will no longer work now that our password file is shadowed.  For pppd-1.2.1d
this requires adding code for shadow support.</P>
<P>The example given in the next section is adding shadow support to
<CODE>pppd-1.2.1d</CODE> (an older version of pppd).</P>
<P><CODE>pppd-2.2.0</CODE> already contains shadow support.</P>

<H2><A NAME="sec-work"></A> <A NAME="s7">7. Putting the Shadow Suite to use.</A></H2>

<P>This section discusses some of the things that you will want to know now
that you have the <EM>Shadow Suite</EM> installed on your system.  More
information is contained in the manual pages for each command.</P>

<H2><A NAME="ss7.1">7.1 Adding, Modifying, and deleting users</A>
</H2>

<P>The <EM>Shadow Suite</EM> added the following command line oriented commands 
for adding, modifying, and deleting users.  You may also have installed the
<CODE>adduser</CODE> program.</P>

<H3>useradd</H3>

<P>The <CODE>useradd</CODE> command can be used to add users to the system.  You
also invoke this command to change the default settings.</P>
<P>The first thing that you should do is to examine the default settings and
make changes specific to your system:
<BLOCKQUOTE><CODE>
<PRE>
useradd -D
</PRE>
</CODE></BLOCKQUOTE>
<HR>
<PRE>
GROUP=1
HOME=/home
INACTIVE=0
EXPIRE=0
SHELL=
SKEL=/etc/skel
</PRE>
<HR>
</P>
<P>The defaults are probably not what you want, so if you started adding users
now you would have to specify all the information for each user.  However, we 
can and should change the default values.</P>
<P>On my system:
<UL>
<LI>I want the default group to be 100</LI>
<LI>I want passwords to expire every 60 days</LI>
<LI>I don't want to lock an account because the password is expired</LI>
<LI>I want to default shell to be <CODE>/bin/bash</CODE></LI>
</UL>

To make these changes I would use:
<BLOCKQUOTE><CODE>
<PRE>
useradd -D -g100 -e60 -f0 -s/bin/bash
</PRE>
</CODE></BLOCKQUOTE>
 </P>
<P>Now running <CODE>useradd -D</CODE> will give:
<HR>
<PRE>
GROUP=100
HOME=/home
INACTIVE=0
EXPIRE=60
SHELL=/bin/bash
SKEL=/etc/skel
</PRE>
<HR>
</P>
<P>Just in case you wanted to know, these defaults are stored in the file 
<CODE>/etc/default/useradd</CODE>.</P>
<P>Now you can use <CODE>useradd</CODE> to add users to the system.  For example,
to add the user <CODE>fred</CODE>, using the defaults, you would use the
following:
<BLOCKQUOTE><CODE>
<PRE>
useradd -m -c "Fred Flintstone" fred
</PRE>
</CODE></BLOCKQUOTE>

This will create the following entry in the <CODE>/etc/passwd</CODE> file:
<BLOCKQUOTE><CODE>
<PRE>
fred:*:505:100:Fred Flintstone:/home/fred:/bin/bash
</PRE>
</CODE></BLOCKQUOTE>

And the following entry in the <CODE>/etc/shadow</CODE> file:
<BLOCKQUOTE><CODE>
<PRE>
fred:!:0:0:60:0:0:0:0
</PRE>
</CODE></BLOCKQUOTE>

<CODE>fred</CODE>'s home directory will be created and the contents of
<CODE>/etc/skel</CODE> will be copied there because of the <CODE>-m</CODE> switch.</P>
<P>Also, since we did not specify a UID, the next available one was used.</P>
<P><CODE>fred</CODE>'s account is created, but <CODE>fred</CODE> still won't be able to
login until we unlock the account.  We do this by changing the password.
<BLOCKQUOTE><CODE>
<PRE>
passwd fred
</PRE>
</CODE></BLOCKQUOTE>

<HR>
<PRE>
Changing password for fred
Enter the new password (minimum of 5 characters)
Please use a combination of upper and lower case letters and numbers.
New Password: *******
Re-enter new password: *******
</PRE>
<HR>

Now the <CODE>/etc/shadow</CODE> will contain:
<BLOCKQUOTE><CODE>
<PRE>
fred:J0C.WDR1amIt6:9559:0:60:0:0:0:0
</PRE>
</CODE></BLOCKQUOTE>

And <CODE>fred</CODE> will now be able to login and use the system.  The nice
thing about <CODE>useradd</CODE> and the other programs that come with the
<EM>Shadow Suite</EM> is that they make changes to the <CODE>/etc/passwd</CODE>
and <CODE>/etc/shadow</CODE> files atomically.  So if you are adding a user, and
another user is changing their password at the same time, both operations
will be performed correctly.</P>
<P>You should use the supplied commands rather than directly editing 
<CODE>/etc/passwd</CODE> and <CODE>/etc/shadow</CODE>.  If you were editing the
<CODE>/etc/shadow</CODE> file, and a user were to change his password while you
are editing, and then you were to save the file you were editing, the user's
password change would be lost.</P>
<P>Here is a small interactive script that adds users using <CODE>useradd</CODE> 
and <CODE>passwd</CODE>:
<HR>
<PRE>
#!/bin/bash
#
# /sbin/newuser - A script to add users to the system using the Shadow
#                 Suite's useradd and passwd commands.
#
# Written my Mike Jackson &lt;mhjack@tscnet.com> as an example for the Linux
# Shadow Password Howto.  Permission to use and modify is expressly granted.
#
# This could be modified to show the defaults and allow modification similar
# to the Slackware Adduser program.  It could also be modified to disallow
# stupid entries.  (i.e. better error checking).
#
##
#  Defaults for the useradd command
##
GROUP=100        # Default Group
HOME=/home       # Home directory location (/home/username)
SKEL=/etc/skel   # Skeleton Directory
INACTIVE=0       # Days after password expires to disable account (0=never)
EXPIRE=60        # Days that a passwords lasts
SHELL=/bin/bash  # Default Shell (full path)
##
#  Defaults for the passwd command
##
PASSMIN=0        # Days between password changes
PASSWARN=14      # Days before password expires that a warning is given
##
#  Ensure that root is running the script.
##
WHOAMI=`/usr/bin/whoami`
if [ $WHOAMI != "root" ]; then
        echo "You must be root to add news users!"
        exit 1
fi
##
#  Ask for username and fullname.
##
echo ""
echo -n "Username: "
read USERNAME
echo -n "Full name: "
read FULLNAME
#
echo "Adding user: $USERNAME."
#
# Note that the "" around $FULLNAME is required because this field is
# almost always going to contain at least on space, and without the "'s
# the useradd command would think that you we moving on to the next
# parameter when it reached the SPACE character.
#
/usr/sbin/useradd -c"$FULLNAME" -d$HOME/$USERNAME -e$EXPIRE \
        -f$INACTIVE -g$GROUP -m -k$SKEL -s$SHELL $USERNAME
##
#  Set password defaults
##
/bin/passwd -n $PASSMIN -w $PASSWARN $USERNAME >/dev/null 2>&amp;1
##
#  Let the passwd command actually ask for password (twice)
##
/bin/passwd $USERNAME
##
#  Show what was done.
##
echo ""
echo "Entry from /etc/passwd:"
echo -n "   "
grep "$USERNAME:" /etc/passwd
echo "Entry from /etc/shadow:"
echo -n "   "
grep "$USERNAME:" /etc/shadow
echo "Summary output of the passwd command:"
echo -n "   "
passwd -S $USERNAME
echo ""
</PRE>
<HR>
 </P>
<P>Using a script to add new users is really much more preferable than editing
the <CODE>/etc/passwd</CODE> or <CODE>/etc/shadow</CODE> files directly or using a
program like the Slackware <CODE>adduser</CODE> program.  Feel free to use and
modify this script for your particular system.</P>
<P>For more information on the <CODE>useradd</CODE> see the online manual page.</P>

<H3>usermod</H3>

<P>The <CODE>usermod</CODE> program is used to modify the information on a user. 
The switches are similar to the <CODE>useradd</CODE> program. </P>
<P>Let's say that you want to change <CODE>fred</CODE>'s shell, you would do the
following:
<BLOCKQUOTE><CODE>
<PRE>
usermod -s /bin/tcsh fred
</PRE>
</CODE></BLOCKQUOTE>

Now <CODE>fred</CODE>'s <CODE>/etc/passwd</CODE> file entry would be change to this:
<BLOCKQUOTE><CODE>
<PRE>
fred:*:505:100:Fred Flintstone:/home/fred:/bin/tcsh
</PRE>
</CODE></BLOCKQUOTE>

Let's make <CODE>fred</CODE>'s account expire on 09/15/97:
<BLOCKQUOTE><CODE>
<PRE>
usermod -e 09/15/97 fred
</PRE>
</CODE></BLOCKQUOTE>

Now <CODE>fred</CODE>'s entry in <CODE>/etc/shadow</CODE> becomes:
<BLOCKQUOTE><CODE>
<PRE>
fred:J0C.WDR1amIt6:9559:0:60:0:0:10119:0
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>For more information on the <CODE>usermod</CODE> command see the online manual
page.</P>

<H3>userdel</H3>

<P><CODE>userdel</CODE> does just what you would expect, it deletes the user's
account.  You simply use:
<BLOCKQUOTE><CODE>
<PRE>
userdel -r username
</PRE>
</CODE></BLOCKQUOTE>

The <CODE>-r</CODE> causes all files in the user's home directory to be removed 
along with the home directory itself.  Files located in other file system 
will have to be searched for and deleted manually.</P>
<P>If you want to simply lock the account rather than delete it, use the 
<CODE>passwd</CODE> command instead. </P>

<H2><A NAME="ss7.2">7.2 The passwd command and passwd aging.</A>
</H2>

<P>The <CODE>passwd</CODE> command has the obvious use of changing passwords. 
Additionally, it is used by the <EM>root</EM> user to:
<UL>
<LI>Lock and unlock accounts (<CODE>-l</CODE> and <CODE>-u</CODE>)</LI>
<LI>Set the maximum number of days that a password remains valid
(<CODE>-x</CODE>)</LI>
<LI>Set the minimum days between password changes (<CODE>-n</CODE>)</LI>
<LI>Sets the number of days of warning that a password is about to expire
(<CODE>-w</CODE>)</LI>
<LI>Sets the number of days after the password expires before the account
is locked (<CODE>-i</CODE>)</LI>
<LI>Allow viewing of account information in a clearer format (<CODE>-S</CODE>)</LI>
</UL>
</P>
<P>For example, let look again at <CODE>fred</CODE>
<BLOCKQUOTE><CODE>
<PRE>
passwd -S fred
fred P 03/04/96 0 60 0 0
</PRE>
</CODE></BLOCKQUOTE>

This means that <CODE>fred</CODE>'s password is valid, it was last changed on
03/04/96, it can be changed at any time, it expires after 60 days, fred will
not be warned, and the account won't be disabled when the password
expires.</P>
<P>This simply means that if <CODE>fred</CODE> logs in after the password expires,
he will be prompted for a new password at login.</P>
<P>If we decide that we want to warn <CODE>fred</CODE> 14 days before his password
expires and make his account inactive 14 days after he lets it expire, we 
would need to do the following:
<BLOCKQUOTE><CODE>
<PRE>
passwd -w14 -i14 fred
</PRE>
</CODE></BLOCKQUOTE>

Now <CODE>fred</CODE> is changed to:
<BLOCKQUOTE><CODE>
<PRE>
fred P 03/04/96 0 60 14 14
</PRE>
</CODE></BLOCKQUOTE>

For more information on the <CODE>passwd</CODE> command see the online manual
page.</P>

<H2><A NAME="ss7.3">7.3 The login.defs file.</A>
</H2>

<P>The file <CODE>/etc/login</CODE> is the configuration file for the
<CODE>login</CODE> program and also for the <EM>Shadow Suite</EM> as a whole.</P>
<P><CODE>/etc/login</CODE> contains settings from what the prompts will look like
to what the default expiration will be when a user changes his password.</P>
<P>The <CODE>/etc/login.defs</CODE> file is quite well documented just by the
comments that are contained within it.  However, there are a few things to
note:
<UL>
<LI>It contains flags that can be turned on or off that determine the
amount of logging that takes place.</LI>
<LI>It contains pointers to other configuration files.</LI>
<LI>It contains defaults assignments for things like password aging.</LI>
</UL>
</P>
<P>From the above list you can see that this is a rather important file, and
you should make sure that it is present, and that the settings are what you
desire for your system.</P>

<H2><A NAME="ss7.4">7.4 Group passwords.</A>
</H2>

<P>The <CODE>/etc/groups</CODE> file may contain passwords that permit a user to
become a member of a particular group.  This function is enabled if you
define the constant <CODE>SHADOWGRP</CODE> in the
<CODE>/usr/src/shadow-YYMMDD/config.h</CODE> file.</P>
<P>If you define this constant and then compile, you must create an
<CODE>/etc/gshadow</CODE> file to hold the group passwords and the group
administrator information.</P>
<P>When you created the <CODE>/etc/shadow</CODE>, you used a program called
<CODE>pwconv</CODE>, there no equivalent program to create the
<CODE>/etc/gshadow</CODE> file, but it really doesn't matter, it takes care of
itself.</P>
<P>To create the initial <CODE>/etc/gshadow</CODE> file do the following:
<BLOCKQUOTE><CODE>
<PRE>
touch /etc/gshadow
chown root.root /etc/gshadow
chmod 700 /etc/gshadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Once you create new groups, they will be added to the <CODE>/etc/group</CODE>
and the <CODE>/etc/gshadow</CODE> files.  If you modify a group by adding or
removing users or changing the group password, the <CODE>/etc/gshadow</CODE>
file will be changed.</P>
<P>The programs <CODE>groups</CODE>, <CODE>groupadd</CODE>, <CODE>groupmod</CODE>, and 
<CODE>groupdel</CODE> are provided as part of the <EM>Shadow Suite</EM> to
modify groups.</P>
<P>The format of the <CODE>/etc/group</CODE> file is as follows:
<BLOCKQUOTE><CODE>
<PRE>
groupname:!:GID:member,member,...
</PRE>
</CODE></BLOCKQUOTE>

Where:
<DL>
<DT><B><CODE>groupname</CODE></B><DD>
<P>The name of the group</P>
<DT><B><CODE>!</CODE></B><DD>
<P>The field that normally holds the password, but that
is now relocated to the <CODE>/etc/gshadow</CODE> file.</P>
<DT><B><CODE>GID</CODE></B><DD>
<P>The numerical group ID number</P>
<DT><B><CODE>member</CODE></B><DD>
<P>List of group members</P>
</DL>
</P>
<P>The format of the <CODE>/etc/gshadow</CODE> file is as follows:
<BLOCKQUOTE><CODE>
<PRE>
groupname:password:admin,admin,...:member,member,...
</PRE>
</CODE></BLOCKQUOTE>

Where:
<DL>
<DT><B><CODE>groupname</CODE></B><DD>
<P>The name of the group</P>
<DT><B><CODE>password</CODE></B><DD>
<P>The encoded group password.</P>
<DT><B><CODE>admin</CODE></B><DD>
<P>List of group administrators </P>
<DT><B><CODE>member</CODE></B><DD>
<P>List of group members</P>
</DL>
</P>
<P>The command <CODE>gpasswd</CODE> is used only for adding or removing
administrators and members to or from a group.  <CODE>root</CODE> or someone in
the list of administrators may add or remove group members.</P>
<P>The groups password can be changed using the <CODE>passwd</CODE> command by 
<EM>root</EM> or anyone listed as an administrator for the group. </P>
<P>Despite the fact that there is not currently a manual page for
<CODE>gpasswd</CODE>, typing <CODE>gpasswd</CODE> without any parameters gives a
listing of options.  It's fairly easy to grasp how it all works once you
understand the file formats and the concepts.</P>


<H2><A NAME="ss7.5">7.5 Consistency checking programs</A>
</H2>



<H3>pwck</H3>

<P>The program <CODE>pwck</CODE> is provided to provide a consistency check on the
<CODE>/etc/passwd</CODE> and <CODE>/etc/shadow</CODE> files.  It will check each
username and verify that it has the following:
<UL>
<LI>the correct number of fields</LI>
<LI>unique user name</LI>
<LI>valid user and group identifier</LI>
<LI>valid primary group</LI>
<LI>valid home directory</LI>
<LI>valid login shell</LI>
</UL>
</P>
<P>It will also warn of any account that has no password.</P>
<P>It's a good idea to run <CODE>pwck</CODE> after installing the <EM>Shadow
Suite</EM>.  It's also a good idea to run it periodically, perhaps weekly or
monthly.  If you use the <CODE>-r</CODE> option, you can use <CODE>cron</CODE> to run
it on a regular basis and have the report mailed to you.</P>

<H3>grpck</H3>

<P><CODE>grpck</CODE> is the consistency checking program for the
<CODE>/etc/group</CODE> and <CODE>/etc/gshadow</CODE> files.  It performs the
following checks: 
<UL>
<LI>the correct number of fields</LI>
<LI>unique group name</LI>
<LI>valid list of members and administrators</LI>
</UL>
</P>
<P>It also has the <CODE>-r</CODE> option for automated reports.</P>

<H2><A NAME="ss7.6">7.6 Dial-up passwords.</A>
</H2>

<P>Dial-up passwords are another optional line of defense for systems that allow
dial-in access.  If you have a system that allows many people to connect
locally or via a network, but you want to limit who can dial in and connect,
then dial-up passwords are for you.  To enable dial-up passwords, you must 
edit the file <CODE>/etc/login.defs</CODE> and ensure that 
<CODE>DIALUPS_CHECK_ENAB</CODE> is set to <CODE>yes</CODE>.</P>
<P>Two files contain the dial-up information, <CODE>/etc/dialups</CODE> which
contains the ttys (one per line, with the leading "/dev/" removed).  If a
tty is listed then dial-up checks are performed. </P>
<P>The second file is the <CODE>/etc/d_passwd</CODE> file.  This file contains the
fully qualified path name of a shell, followed by an optional password.</P>
<P>If a user logs into a line that is listed in <CODE>/etc/dialups</CODE>, and his
shell is listed in the file <CODE>/etc/d_passwd</CODE> he will be allowed access
only by suppling the correct password.</P>
<P>Another useful purpose for using dial-up passwords might be to setup a line 
that only allows a certain type of connect (perhaps a PPP or UUCP connection). 
If a user tries to get another type of connection (i.e. a list of shells),
he must know a password to use the line.</P>
<P>Before you can use the dial-up feature, you must create the files.</P>
<P>The command <CODE>dpasswd</CODE> is provided to assign passwords to the shells
in the <CODE>/etc/d_passwd</CODE> file.  See the manual page for more
information.</P>


<H2><A NAME="sec-adding"></A> <A NAME="s8">8. Adding shadow support to a C program</A></H2>

<P>Adding shadow support to a program is actually fairly straightforward.  The
only problem is that the program must be run by root (or SUID root) in order
for the program to be able to access the <CODE>/etc/shadow</CODE> file.</P>
<P>This presents one big problem: very careful programming practices must be
followed when creating SUID programs.  For instance, if a program has a shell
escape, this must not occur as root if the program is SUID root.  </P>
<P>For adding shadow support to a program so that it can check passwords, but
otherwise does need to run as root, it's a lot safer to run the program SUID
shadow instead.  The <CODE>xlock</CODE> program is an example of this.</P>
<P>In the example given below, <CODE>pppd-1.2.1d</CODE> already runs SUID as root, 
so adding shadow support should not make the program any more vulnerable.</P>

<H2><A NAME="ss8.1">8.1 Header files</A>
</H2>

<P>The header files should reside in <CODE>/usr/include/shadow</CODE>.  There
should also be a <CODE>/usr/include/shadow.h</CODE>, but it will be a symbolic
link to <CODE>/usr/include/shadow/shadow.h</CODE>.</P>
<P>To add shadow support to a program, you need to include the header files:
<PRE>
#include &lt;shadow/shadow.h>
#include &lt;shadow/pwauth.h>
</PRE>
</P>
<P>It might be a good idea to use compiler directives to conditionally compile
the shadow code (I do in the example below).</P>

<H2><A NAME="ss8.2">8.2 libshadow.a library</A>
</H2>

<P>When you installed the <EM>Shadow Suite</EM> the <CODE>libshadow.a</CODE> file
was created and installed in <CODE>/usr/lib</CODE>.</P>
<P>When compiling shadow support into a program, the linker needs to be told to
include the <CODE>libshadow.a</CODE> library into the link.</P>
<P>This is done by:
<BLOCKQUOTE><CODE>
<PRE>
gcc program.c -o program -lshadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>However, as we will see in the example below, most large programs use a
<CODE>Makefile</CODE>, and usually have a variable called <CODE>LIBS=...</CODE> that
we will modify.</P>

<H2><A NAME="ss8.3">8.3 Shadow Structure</A>
</H2>

<P>The <CODE>libshadow.a</CODE> library uses a structure called <CODE>spwd</CODE>
for the information it retrieves from the <CODE>/etc/shadow</CODE> file.  This is
the definition of the <CODE>spwd</CODE> structure from the
<CODE>/usr/include/shadow/shadow.h</CODE> header file:
<HR>
<PRE>
struct spwd
{
  char *sp_namp;                /* login name */
  char *sp_pwdp;                /* encrypted password */
  sptime sp_lstchg;             /* date of last change */
  sptime sp_min;                /* minimum number of days between changes */
  sptime sp_max;                /* maximum number of days between changes */
  sptime sp_warn;               /* number of days of warning before password
                                   expires */
  sptime sp_inact;              /* number of days after password expires
                                   until the account becomes unusable. */
  sptime sp_expire;             /* days since 1/1/70 until account expires
*/
  unsigned long sp_flag;        /* reserved for future use */
};
</PRE>
<HR>
</P>
<P>The <EM>Shadow Suite</EM> can put things into the <CODE>sp_pwdp</CODE> field
besides just the encoded passwd.  The password field could contain:
<BLOCKQUOTE><CODE>
<PRE>
username:Npge08pfz4wuk;@/sbin/extra:9479:0:10000::::
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>This means that in addition to the password, the program
<CODE>/sbin/extra</CODE> should be called for further authentication.  The
program called will get passed the username and a switch that indicates
why it's being called.  See the file <CODE>/usr/include/shadow/pwauth.h</CODE>
and the source code for <CODE>pwauth.c</CODE> for more information.</P>
<P>What this means is that we should use the function <CODE>pwauth</CODE> to
perform the actual authentication, as it will take care of the secondary
authentication as well.  The example below does this.</P>
<P>The author of the <EM>Shadow Suite</EM> indicates that since most
programs in existence don't do this, and that it may be removed or changed
in future versions of the <EM>Shadow Suite</EM>.</P>

<H2><A NAME="ss8.4">8.4 Shadow Functions</A>
</H2>

<P>The <CODE>shadow.h</CODE> file also contains the function prototypes for the
functions contained in the <CODE>libshadow.a</CODE> library:
<HR>
<PRE>
extern void setspent __P ((void));
extern void endspent __P ((void));
extern struct spwd *sgetspent __P ((__const char *__string));
extern struct spwd *fgetspent __P ((FILE *__fp));
extern struct spwd *getspent __P ((void));
extern struct spwd *getspnam __P ((__const char *__name));
extern int putspent __P ((__const struct spwd *__sp, FILE *__fp));
</PRE>
<HR>
</P>
<P>The function that we are going to use in the example is: <CODE>getspnam</CODE>
which will retrieve for us a <CODE>spwd</CODE> structure for the supplied name.</P>


<H2><A NAME="ss8.5">8.5 Example</A>
</H2>

<P>This is an example of adding shadow support to a program that needs it, but
does not have it by default.</P>
<P>This example uses the <EM>Point-to-Point Protocol Server</EM> (pppd-1.2.1d), 
which has a mode in which it performs <EM>PAP</EM> authentication using 
user names and passwords from the <CODE>/etc/passwd</CODE> file instead of the 
<EM>PAP</EM> or <EM>CHAP</EM> files.  You would not need to add this code 
to <CODE>pppd-2.2.0</CODE> because it's already there.</P>
<P>This feature of pppd probably isn't used very much, but if you installed the
<EM>Shadow Suite</EM>, it won't work anymore because the passwords are no 
longer stored in <CODE>/etc/passwd</CODE>.</P>
<P>The code for authenticating users under <CODE>pppd-1.2.1d</CODE> is located in
the <CODE>/usr/src/pppd-1.2.1d/pppd/auth.c</CODE> file.</P>
<P>The following code needs to be added to the top of the file where all the
other <CODE>#include</CODE> directives are.  We have surrounded the 
<CODE>#includes</CODE> with conditional directives (i.e. only include if we 
are compiling for shadow support).</P>
<P>
<HR>
<PRE>
#ifdef HAS_SHADOW
#include &lt;shadow.h>
#include &lt;shadow/pwauth.h>
#endif
</PRE>
<HR>
 </P>
<P>The next thing to do is to modify the actual code.  We are still making
changes to the <CODE>auth.c</CODE> file.</P>
<P>Function <CODE>auth.c</CODE> before modifications:
<HR>
<PRE>
/*
 * login - Check the user name and password against the system
 * password database, and login the user if OK.
 *
 * returns:
 *      UPAP_AUTHNAK: Login failed.
 *      UPAP_AUTHACK: Login succeeded.
 * In either case, msg points to an appropriate message.
 */
static int
login(user, passwd, msg, msglen)
    char *user;
    char *passwd;
    char **msg;
    int *msglen;
{
    struct passwd *pw;
    char *epasswd;
    char *tty;

    if ((pw = getpwnam(user)) == NULL) {
        return (UPAP_AUTHNAK);
    }
     /*
     * XXX If no passwd, let them login without one.
     */
    if (pw->pw_passwd == '\0') {
        return (UPAP_AUTHACK);
    }

    epasswd = crypt(passwd, pw->pw_passwd);
    if (strcmp(epasswd, pw->pw_passwd)) {
        return (UPAP_AUTHNAK);
    }

    syslog(LOG_INFO, "user %s logged in", user);

    /*
     * Write a wtmp entry for this user.
     */
    tty = strrchr(devname, '/');
    if (tty == NULL)
        tty = devname;
    else
        tty++;
    logwtmp(tty, user, "");             /* Add wtmp login entry */
    logged_in = TRUE;

    return (UPAP_AUTHACK);
}
</PRE>
<HR>
</P>
<P>The user's password is placed into <CODE>pw->pw_passwd</CODE>, so all we really
need to do is add the function <CODE>getspnam</CODE>.  This will put the
password into <CODE>spwd->sp_pwdp</CODE>.</P>
<P>We will add the function <CODE>pwauth</CODE> to perform the actual authentication. 
This will automatically perform secondary authentication if the shadow file
is setup for it.</P>
<P>Function <CODE>auth.c</CODE> after modifications to support shadow:</P>
<P>
<HR>
<PRE>
/*
 * login - Check the user name and password against the system
 * password database, and login the user if OK.
 *
 * This function has been modified to support the Linux Shadow Password
 * Suite if USE_SHADOW is defined.
 *
 * returns:
 *      UPAP_AUTHNAK: Login failed.
 *      UPAP_AUTHACK: Login succeeded.
 * In either case, msg points to an appropriate message.
 */
static int
login(user, passwd, msg, msglen)
    char *user;
    char *passwd;
    char **msg;
    int *msglen;
{
    struct passwd *pw;
    char *epasswd;
    char *tty;

#ifdef USE_SHADOW
    struct spwd *spwd;
    struct spwd *getspnam();
#endif

    if ((pw = getpwnam(user)) == NULL) {
        return (UPAP_AUTHNAK);
    }

#ifdef USE_SHADOW
        spwd = getspnam(user);
        if (spwd)
                pw->pw_passwd = spwd->sp-pwdp;
#endif
 
     /*
     * XXX If no passwd, let NOT them login without one.
     */
    if (pw->pw_passwd == '\0') {
        return (UPAP_AUTHNAK);
    }
#ifdef HAS_SHADOW
    if ((pw->pw_passwd &amp;&amp; pw->pw_passwd[0] == '@'
         &amp;&amp; pw_auth (pw->pw_passwd+1, pw->pw_name, PW_LOGIN, NULL))
        || !valid (passwd, pw)) {
        return (UPAP_AUTHNAK);
    }
#else
    epasswd = crypt(passwd, pw->pw_passwd);
    if (strcmp(epasswd, pw->pw_passwd)) {
        return (UPAP_AUTHNAK);
    }
#endif

    syslog(LOG_INFO, "user %s logged in", user);

    /*
     * Write a wtmp entry for this user.
     */
    tty = strrchr(devname, '/');
    if (tty == NULL)
        tty = devname;
    else
        tty++;
    logwtmp(tty, user, "");             /* Add wtmp login entry */
    logged_in = TRUE;

    return (UPAP_AUTHACK);
}
</PRE>
<HR>
</P>
<P>Careful examination will reveal that we made another change as well.  The
original version allowed access (returned <CODE>UPAP_AUTHACK</CODE> if there
was NO password in the <CODE>/etc/passwd</CODE> file.  This is <EM>not</EM> 
good, because a common use of this login feature is to use one account 
to allow access to the PPP process and then check the username and password 
supplied by PAP with the username in the <CODE>/etc/passwd</CODE> file and 
the password in the <CODE>/etc/shadow</CODE> file.</P>
<P>So if we had set the original version up to run as the shell for a user i.e.
<CODE>ppp</CODE>, then anyone could get a ppp connection by setting their PAP to user
<CODE>ppp</CODE> and a password of null.</P>
<P>We fixed this also by returning <CODE>UPAP_AUTHNAK</CODE> instead of
<CODE>UPAP_AUTHACK</CODE> if the password field was empty.</P>
<P>Interestingly enough, <CODE>pppd-2.2.0</CODE> has the same problem.</P>
<P>Next we need to modify the Makefile so that two things occur:
<CODE>USE_SHADOW</CODE> must be defined, and <CODE>libshadow.a</CODE> needs to be
added to the linking process.</P>
<P>Edit the Makefile, and add:
<BLOCKQUOTE><CODE>
<PRE>
LIBS = -lshadow
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Then we find the line:
<BLOCKQUOTE><CODE>
<PRE>
COMPILE_FLAGS = -I.. -D_linux_=1 -DGIDSET_TYPE=gid_t
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>And change it to:
<BLOCKQUOTE><CODE>
<PRE>
COMPILE_FLAGS = -I.. -D_linux_=1 -DGIDSET_TYPE=gid_t -DUSE_SHADOW
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>Now make and install.</P>

<H2><A NAME="s9">9. Frequently Asked Questions.</A></H2>

<P><EM>Q:</EM> I used to control which tty's <EM>root</EM> could log into using
the file <CODE>/etc/securettys</CODE>, but it doesn't seem to work anymore,
what's going on?</P>
<P><EM>A:</EM> The file <CODE>/etc/securettys</CODE> does absolutely nothing now
that the <EM>Shadow Suite</EM> is installed.  The tty's that <EM>root</EM>
can use are now located in the login configuration file
<CODE>/etc/login.defs</CODE>.  The entry in this file may point to another file.</P>

<P><EM>Q:</EM> I installed the <EM>Shadow Suite</EM>, but now I can't login,
what did I miss?</P>
<P><EM>A:</EM> You probably installed the Shadow programs, but didn't run
<CODE>pwconv</CODE> or you forgot to copy <CODE>/etc/npasswd</CODE> to
<CODE>/etc/passwd</CODE> and <CODE>/etc/nshadow</CODE> to <CODE>/etc/shadow</CODE>.
Also, you may need to copy <CODE>login.defs</CODE> to <CODE>/etc</CODE>.</P>

<P><EM>Q:</EM> In the section on xlock, it said to change the group ownership
of the <CODE>/etc/shadow</CODE> file to <CODE>shadow</CODE>.  I don't have a
<CODE>shadow</CODE> group, what do I do?</P>
<P><EM>A:</EM> You can add one.  Simply edit the <CODE>/etc/group</CODE> file, and
insert a line for the shadow group.  You need to ensure that the group
number is not used by another group, and you need to insert it before the
<CODE>nogroup</CODE> entry.  Or you can simply suid <CODE>xlock</CODE> to root. </P>

<P><EM>Q:</EM> Is there a mailing list for the Linux Shadow Password Suite?</P>
<P><EM>A:</EM> Yes, but it's for the development and beta testing of the
next Shadow Suite for Linux.  You can get added to the list by mailing to: 
<CODE>shadow-list-request@neptune.cin.net</CODE> with a subject of: 
<CODE>subscribe</CODE>.  The list is actually for discussions of the Linux 
<CODE>shadow-YYMMSS</CODE> series of releases.  You should join if you want to 
get involved in further development or if you install the Suite on your
system and want to get information on newer releases.  </P>

<P><EM>Q:</EM> I installed the <EM>Shadow Suite</EM>, but when I use the
<CODE>userdel</CODE> command, I get "userdel: cannot open shadow group file",
what did I do wrong?</P>
<P><EM>A:</EM> You compiled the <EM>Shadow Suite</EM> with the
<CODE>SHADOWGRP</CODE> option enabled, but you don't have an
<CODE>/etc/gshadow</CODE> file.  You need to either edit the <CODE>config.h</CODE>
file and recompile, or create an <CODE>/etc/group</CODE> file.  See the section
on shadow groups.</P>

<P><EM>Q:</EM> I installed the <EM>Shadow Suite</EM> but now I'm getting
encoded passwords back in my <CODE>/etc/passwd</CODE> file, what's wrong?</P>
<P><EM>A:</EM> You either enabled the <CODE>AUTOSHADOW</CODE> option in the Shadow
<CODE>config.h</CODE> file, or your <CODE>libc</CODE> was compiled with the
<CODE>SAHDOW_COMPAT</CODE> option.  You need to determine which is the problem,
and recompile.</P>

<H2><A NAME="s10">10. Copyright Message.</A></H2>

<P>The Linux Shadow Password HOWTO is Copyright (c) 1996 Michael H. Jackson.</P>
<P>Permission is granted to make and distribute verbatim copies of
this document provided the copyright notice and this permission notice
are preserved on all copies.</P>
<P>Permission is granted to copy and distribute modified versions of this
document under the conditions for verbatim copies above, provided a notice
clearly stating that the document is a modified version is also included in
the modified document.</P>
<P>Permission is granted to copy and distribute translations of this document
into another language, under the conditions specified above for modified
versions.</P>
<P>Permission is granted to convert this document into another media under
the conditions specified above for modified versions provided the requirement
to acknowledge the source document is fulfilled by inclusion of an obvious
reference to the source document in the new media. Where there is any
doubt as to what defines 'obvious' the copyright owner reserves the right
to decide.</P>

<H2><A NAME="s11">11. Miscellaneous and Acknowledgments.</A></H2>

<P>The code examples for <CODE>auth.c</CODE> are taken from pppd-1.2.1d and
ppp-2.1.0e, Copyright (c) 1993 and The Australian National University and
Copyright (c) 1989 Carnegie Mellon University.</P>
<P>Thanks to Marek Michalkiewicz &lt;marekm@i17linuxb.ists.pwr.wroc.pl> for
writing and maintaining the <EM>Shadow Suite</EM> for Linux, and for his
review and comments on this document.</P>
<P>Thanks to Ron Tidd &lt;rtidd@tscnet.com> for his helpful review and testing.</P>
<P>Thanks to everyone who has sent me feedback to help improve this document.</P>
<P>Please, if you have any comments or suggestions then mail them to me.</P>
<P>regards</P>
<P>
<A HREF="mailto:mhjack@tscnet.com">Michael H. Jackson &lt;mhjack@tscnet.com></A></P>

</BODY>
</HTML>
