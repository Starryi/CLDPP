<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Traffic Control using tcng and HTB HOWTO</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="article"><div class="titlepage"><div><div><h2 class="title"><a name="idm1"></a>Traffic Control using tcng and HTB HOWTO</h2></div><div><h3 class="subtitle"><i>Version 1.0.1</i></h3></div><div><div class="author"><h3 class="author"><span class="firstname">Martin</span> <span class="othername">A.</span> <span class="surname">Brown</span></h3><div class="affiliation"><span class="orgname">
        <a class="ulink" href="http://linux-ip.net/" target="_top">linux-ip.net</a>
        <br></span> <span class="orgdiv">Network Administration<br></span><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:martin@linux-ip.net">martin@linux-ip.net</a>&gt;</code></p></div></div></div></div><div><div class="legalnotice"><a name="legalnotice"></a><p>© 2006, Martin A. Brown</p><div class="blockquote"><blockquote class="blockquote"><p>Permission is granted to copy, distribute and/or modify this 		document under the terms of the GNU Free Documentation License, 		Version 1.1 or any later version published by the Free Software 		Foundation; with no invariant sections, with no Front-Cover Texts, 		with no Back-Cover Text.  A copy of the license is located at <a class="ulink" href="http://www.gnu.org/licenses/fdl.html" target="_top">www.gnu.org/copyleft/fdl.html</a>.</p></blockquote></div></div></div><div><p class="pubdate">April 2006</p></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision 1.0.1</td><td align="left">2006-10-28</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">Updating contact information</td></tr><tr><td align="left">Revision 1.0</td><td align="left">2003-04-16</td><td align="left">tab</td></tr><tr><td align="left" colspan="3">Initial Release, reviewed by LDP</td></tr><tr><td align="left">Revision 0.5</td><td align="left">2002-04-01</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">submit to tldp, rename/retitle with HOWTO</td></tr><tr><td align="left">Revision 0.4</td><td align="left">2002-03-31</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">new example, bucket crash course</td></tr><tr><td align="left">Revision 0.3</td><td align="left">2002-03-16</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">corrections and notes from Jacob Teplitsky, raptor and Joshua
        Heling</td></tr><tr><td align="left">Revision 0.2</td><td align="left">2002-03-15</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">links, cleanup, publish</td></tr><tr><td align="left">Revision 0.1</td><td align="left">2002-03-14</td><td align="left">MAB</td></tr><tr><td align="left" colspan="3">initial revision</td></tr></table></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#intro">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#intro-tc">1.1. What is traffic control and how does it work?</a></span></dt><dt><span class="section"><a href="#intro-htb">1.2. What is htb?</a></span></dt><dt><span class="section"><a href="#intro-tcng">1.3. What is <span class="command"><strong>tcng</strong></span>?</a></span></dt></dl></dd><dt><span class="section"><a href="#requirements">2. Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="#requirements-kernel">2.1. kernel requirements</a></span></dt><dt><span class="section"><a href="#requirements-tc">2.2. <span class="command"><strong>tc</strong></span> requirements</a></span></dt><dt><span class="section"><a href="#requirements-tcng">2.3. <span class="command"><strong>tcng</strong></span> requirements</a></span></dt></dl></dd><dt><span class="section"><a href="#examples">3. Configuration examples</a></span></dt><dd><dl><dt><span class="section"><a href="#examples-adsl">3.1. Using tcng to shape download only</a></span></dt><dt><span class="section"><a href="#examples-1">3.2. Using a two-rate three-color meter</a></span></dt></dl></dd><dt><span class="section"><a href="#misc">4. Miscellaneous Notes</a></span></dt><dt><span class="section"><a href="#further">5. Links and Further documentation</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro"></a>1. Introduction</h2></div></div></div><p>
    This is a brief tutorial on using <span class="command"><strong>tcng</strong></span>
    (<a class="ulink" href="http://tcng.sourceforge.net" target="_top">Traffic Control Next
    Generation</a>) with HTB
    (<a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/" target="_top">Hierarchical Token
    Bucket</a>) to perform traffic shaping on a Linux machine.
  </p><p>
    This tutorial is intended for systems administrators who have
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          AT LEAST, a basic understanding of traffic control
        </p></li><li class="listitem"><p>
          EITHER the capability to compile iproute2 and tcng from source
        </p><p>
          OR the capability of building RPMS from provided SRPMs
        </p></li><li class="listitem"><p>
          EITHER a modular kernel with support for htb and dsmark
        </p><p>
          OR capability to compile a kernel with support for htb and dsmark
        </p></li></ul></div><p>
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>This article is neither comprehensive nor authoritative.  The
      author solicits positive and negative feedback at <code class="email">&lt;<a class="email" href="mailto:martin@linux-ip.net">martin@linux-ip.net</a>&gt;</code>.  Corrections,
      additions, and further examples are always welcome.</p></div><p>
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-tc"></a>1.1. What is traffic control and how does it work?</h3></div></div></div><p>
      Traffic control is the term given to the entire packet queuing
      subsystem in a network or network device.  Traffic control consists of
      several distinct operations.  Classifying is a mechanism by which to
      identify packets and place them in individual flows or classes.
      Policing is a mechanism by which one limits the number of packets or
      bytes in a stream matching a particular classification.  Scheduling is
      the decision-making process by which packets are ordered and re-ordered
      for transmission.  Shaping is the process by which packets are delayed
      and transmitted to produce an even and predictable flow rate.
    </p><p>
      These many characteristics of a traffic control system can be combined
      in complex ways to reserve bandwidth for a particular flow (or
      application) or to limit the amount of bandwidth available to a
      particular flow or application.
    </p><p>
      One of the key concepts of traffic control is the concept of tokens.
      A policing or shaping implementation needs to calculate the number of
      bytes or packets which have passed at what rate.  Each packet or byte
      (depending on the implementation), corresponds to a token, and the
      policing or shaping implementation will only transmit or pass the packet
      if it has a token available.  A common metaphorical container in
      which an implementation keeps its token is the bucket.  In short, a
      bucket represents the both the number of tokens which can be used
      instantaneously (the size of the bucket), and the rate at which the
      tokens are replenished (how fast the bucket gets refilled).
    </p><p>
      See
      <a class="xref" href="#intro-htb" title="1.2. What is htb?">Section 1.2, &#8220;What is htb?&#8221;</a> for an example of buckets in a linux traffic
      control system.
    </p><p>
      Under linux, traffic control has historically been a complex
      endeavor.  The <span class="command"><strong>tc</strong></span> command line tool provides an
      interface to the kernel structures which perform the shaping,
      scheduling, policing and classifying.  The syntax of this command is,
      however, arcane.  The <span class="command"><strong>tcng</strong></span> project provides a much
      friendlier interface to the human by layering a language on top of the
      powerful <span class="command"><strong>tc</strong></span> command line tool.  By writing traffic
      control configurations in <span class="command"><strong>tcng</strong></span> they become easily
      maintainable, less arcane, and importantly also more portable.
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-htb"></a>1.2. What is htb?</h3></div></div></div><p>
      <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/" target="_top">Hierarchichal Token
      Bucket</a> is a classful qdisc written by Martin Devera 
      with a simpler set of
      configuration parameters than CBQ.  There is a great deal of
      documentation on the author's site and also on 
      <a class="ulink" href="http://www.docum.org/" target="_top">Stef Coene's website</a> about
      HTB and its uses.  Below is a very brief sketch of the HTB system.
    </p><p>
      Conceptually, HTB is an arbitrary number of token buckets arranged in a
      hierarchy (yes, you probably could have figured that out without my
      sentence).  Let's consider the simplest scenario.
      The primary egress queuing discipline on any device is known as
      the <code class="constant">root</code> qdisc.
    </p><p>
      The <code class="constant">root</code> qdisc will contain one class (complex
      scenarios could have multiple classes attached to the
      <code class="constant">root</code> qdisc).  This single HTB class will be set
      with two parameters, a <code class="constant">rate</code> and a
      <code class="constant">ceil</code>.  These values should be the same for the
      top-level class, and will represent the total
      available bandwidth on the link.
    </p><p>
      In HTB, <code class="constant">rate</code> means the guaranteed bandwidth
      available for a given class and <code class="constant">ceil</code> is short for
      ceiling, which indicates the maximum bandwidth that class is allowed to
      consume.  Any bandwidth used between <code class="constant">rate</code> and
      <code class="constant">ceil</code> is borrowed from a parent class, hence the
      suggestion that <code class="constant">rate</code> and <code class="constant">ceil</code>
      be the same in the top-level class.
    </p><p>
      A number of children classes can be made under this class, each of which
      can be allocated some amount of the available bandwidth from the parent
      class.  In these children classes, the <code class="constant">rate</code> and
      <code class="constant">ceil</code> parameter values need not be the same as
      suggested for the parent class.  This allows you to reserve a specified
      amount of bandwidth to a particular class.  It also
      allows HTB to calculate the ratio of distribution of available bandwidth
      to the ratios of the classes themselves.  This should be more apparent
      in the examples below.
    </p><p>
      Hierarchical Token Bucket implements a classful queuing mechanism for
      the linux traffic control system, and provides <code class="constant">rate</code>
      and <code class="constant">ceil</code> to allow the user to control the absolute
      bandwidth to particular classes of traffic as well as indicate the ratio
      of distribution of bandwidth when extra bandwidth becomes available (up
      to <code class="constant">ceil</code>).
    </p><p>
      Keep in mind when choosing the bandwidth for your top-level class that
      traffic shaping only helps if you are the bottleneck between your LAN
      and the Internet.  Typically, this is the case in home and office
      network environments, where an entire LAN is serviced by a DSL or T1
      connection.
    </p><p>
      In practice, this means that you should probably set the bandwidth for
      your top-level class to your available bandwidth minus a fraction of
      that bandwidth.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-tcng"></a>1.3. What is <span class="command"><strong>tcng</strong></span>?</h3></div></div></div><p>
      <a class="ulink" href="http://tcng.sourceforge.net/" target="_top">Traffic Control Next
      Generation (tcng)</a> is a project by Werner Almesberger to provide
      a powerful, abstract, and uniform language in which to describe traffic
      control structures.  The <span class="command"><strong>tcc</strong></span> parser in the
      <span class="command"><strong>tcng</strong></span> distribution transforms tcng the language into a
      number of output formats.  By default, <span class="command"><strong>tcc</strong></span> will read
      a file (specified as an argument or as STDIN) and print to STDOUT the
      series of <span class="command"><strong>tc</strong></span> commands (see
      <span class="command"><strong>iproute2</strong></span> below) required to create the desired traffic
      control structure in the kernel.
    </p><p>
      Consult the 
      <a class="ulink" href="http://linux-ip.net/gl/tcng/node159.html" target="_top">parameter
      reference for <span class="command"><strong>tcng</strong></span></a> to see the supported
      queuing disciplines.  Jacob Teplitsky, active on the
      <a class="ulink" href="http://lartc.org/#mailinglist" target="_top">LARTC mailing list</a>
      and a contributor to the tcng project,
      wrote the htb support for <span class="command"><strong>tcng</strong></span>.
    </p><p>
      The <span class="command"><strong>tcc</strong></span> tool can produce a number of different types
      of output, but this document will only consider the conventional and
      default output.  Consult the
      <a class="ulink" href="http://linux-ip.net/gl/tcng/" target="_top">TCNG manual</a> for
      more detailed information about the use of <span class="command"><strong>tcng</strong></span>.
    </p><p>
      The
      <span class="command"><strong>tcsim</strong></span> tool is a traffic control simulator which
      accepts tcng configuration files and reads a control language to
      simulate the behaviour of a kernel sending and receiving packets with
      the specified control structures.  Although <span class="command"><strong>tcsim</strong></span>
      is a significant portion of the <span class="command"><strong>tcng</strong></span> project,
      <span class="command"><strong>tcsim</strong></span> will not be covered here at all.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="requirements"></a>2. Requirements</h2></div></div></div><p>
    There are a few requirements in order for the
    <a class="link" href="#requirements-kernel" title="2.1. kernel requirements">kernel to support HTB and
    DSMARK</a>, 
    <a class="link" href="#requirements-tc" title="2.2. tc requirements">tc to support HTB and DSMARK</a>, and
    <a class="link" href="#requirements-tcng" title="2.3. tcng requirements">tcng itself</a>. 
  </p><p>
    Specifically, support for HTB in the kernel and tc is absolutely required
    in order for this tutorial to be remotely useful (refer to the title if
    htere is any doubt in your mind).  DSMARK support is, strictly speaking,
    optional, although some
    <a class="link" href="#examples" title="3. Configuration examples">examples</a> (class selection path, in
    particular, but maybe others) may not operate without dsmark support.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="requirements-kernel"></a>2.1. kernel requirements</h3></div></div></div><p>
      The kernel requirements are very easy to meet.  Kernel 2.4.20 and newer
      include support for HTB and dsmark, so simply be certain that these
      options are turned on in the QoS/Fair Queuing portion of your kernel
      configuration.  For a brief summary of the options to select in kernel
      configuration, visit
      <a class="ulink" href="http://diffserv.sourceforge.net/#24" target="_top">the DiffServ project
      kernel configuration notes</a>.
    </p><p>
      For kernels older than 2.4.20, the following
      <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/v3/htb3.6-020525.tgz" target="_top">tarball
      containing a patch</a> should be applied to your 2.4.17 or newer
      kernel tree.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="requirements-tc"></a>2.2. <span class="command"><strong>tc</strong></span> requirements</h3></div></div></div><p>
      The <span class="command"><strong>tc</strong></span> command is a part of the
      <span class="command"><strong>iproute2</strong></span> utility suite.  For general documentation on
      <span class="command"><strong>iproute2</strong></span>, see
      <a class="ulink" href="http://linux-ip.net/" target="_top">http://linux-ip.net/</a> and
      <a class="ulink" href="http://linux-ip.net/gl/ip-cref/" target="_top">the
      <span class="command"><strong>iproute2</strong></span> manual</a>.  The software itself is
      available directly from
      <a class="ulink" href="ftp://ftp.inr.ac.ru/ip-routing/" target="_top">Alexey Kuznetsov'z FTP
      archive</a> but commonly also via packages supplied with your
      linux distribution.  If your distribution can make use of RPMS, you can
      download this
      <a class="ulink" href="http://linux-ip.net/traffic-control/iproute-2.4.7-7.src.rpm" target="_top">SRPM</a>
      and compile it on your own system.
    </p><p>
      If you need to compile <span class="command"><strong>iproute2</strong></span> yourself, use the
      <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/v3/htb3.6-020525.tgz" target="_top">patch
      to <span class="command"><strong>tc</strong></span> from this tarball</a> at
      <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/" target="_top">Martin Devera's HTB
      site</a> in order to provide support for HTB in
      <span class="command"><strong>tc</strong></span>.
    </p><p>
      Your <span class="command"><strong>tc</strong></span> will also need to support dsmark, the
      diffserv marking mechanism.  Fortunately, this is a simple change to 
      the <code class="filename">Config</code> file from the
      <span class="command"><strong>iproute2</strong></span> source package.  Simply change
      <code class="computeroutput">TC_CONFIG_DIFFSERV=n</code> to
      <code class="computeroutput">TC_CONFIG_DIFFSERV=y</code> and recompile.
    </p><p>
      The
      <a class="ulink" href="http://linux-ip.net/traffic-control/iproute-2.4.7-7.src.rpm" target="_top">SRPM</a>
      creates a <span class="command"><strong>tc</strong></span> binary with support for
      dsmark and for HTB, both of which are required for this example.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="requirements-tcng"></a>2.3. <span class="command"><strong>tcng</strong></span> requirements</h3></div></div></div><p>
      Support for <span class="command"><strong>tcng</strong></span> is the easiest part of the process.
      Simply untar the tcng source and run <strong class="userinput"><code>./configure
      --no-tcsim</code></strong> before compiling.
    </p><p>
      If you are on an RPM-based system, you can use the SPEC file in
      <code class="filename">tcng/build/tcng.spec</code> to build for your
      distribution, or you can download and compile this
      <a class="ulink" href="http://linux-ip.net/traffic-control/tcng-9d-1.src.rpm" target="_top">SRPM</a>.
      The SRPM produces two packages, tcc and tcc-devel.  You need only tcc to
      create configurations.
    </p><p>
      In order to run the <span class="command"><strong>tcc</strong></span> parser, you will also need to
      have the <span class="command"><strong>cpp</strong></span> package installed.
      <span class="command"><strong>tcc</strong></span> uses cpp.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="examples"></a>3. Configuration examples</h2></div></div></div><p>
    Examples shown here will be modified examples of downloadable
    configurations available in
    <a class="ulink" href="http://linux-ip.net/code/tcng/" target="_top">this directory</a>.
  </p><p>
    These examples can be used as standalone configuration files to be fed
    into a <span class="command"><strong>tcc</strong></span> parser, or they can be used in
    conjunction with the example
    <a class="ulink" href="http://linux-ip.net/code/tcng/tcng.init" target="_top">SysV startup
    script</a>.  The startup script is a modification of a
    <a class="ulink" href="http://mailman.ds9a.nl/pipermail/lartc/2002q4/005411.html" target="_top">script
    posted on the LARTC mailing list by raptor</a>.
  </p><p>
    If you are going to use the above startup script, take a look at
    this example <code class="filename">/etc/sysconfig/tcng</code>:
  </p><div class="example"><a name="ex-sysconfig-tcng"></a><p class="title"><b>Example 1. <code class="filename">/etc/sysconfig/tcng</code></b></p><div class="example-contents"><pre class="programlisting">
# - tcng meta-configuration file
#   (I never meta-configuration file I didn't like)
#
# -- 2003-03-15 created; -MAB
# -- 2003-03-31 modified to allow ENVAR override; -MAB
#
# -- this directory will hold all of the tcng configurations
#    used on this host
#
TCCONFBASEDIR=${TCCONFBASEDIR:-/etc/sysconfig/tcng-configs}

# -- this is the active, desired tcng configuration
#    note, that, because tcng provides the #include construct,
#    the modularity of configuration can be built into the
#    configuration files in $TCCONFBASEDIR
#
TCCONF=${TCCONF:-$TCCONFBASEDIR/global.tcc}

tcstats=${tcstats:-no}   # -- will suppress statistical output
tcstats=${tcstats:-yes}  # -- will throw the "-s" option to tc

tcdebug=${tcdebug:-0}    # -- for typical startup script usage
tcdebug=${tcdebug:-1}    # -- for a bit of information about what's happening
tcdebug=${tcdebug:-2}    # -- for debugging information
#
#
# -- an additional measure to take, you can override the default tc and tcc
#    command line utilities by specifying their pathnames here, for example:
#
#  tc=/usr/local/bin/tc
#  tcc=/usr/local/tcng/bin/tcc
#
#
    </pre></div></div><br class="example-break"><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="examples-adsl"></a>3.1. Using tcng to shape download only</h3></div></div></div><p>
      Many general concepts will be introduced with this example.  This
      example can be compiled to its <span class="command"><strong>tc</strong></span> output with the
      command <strong class="userinput"><code>tcc
      <code class="filename">class-selection-path.tcc</code></code></strong>.
    </p><div class="example"><a name="ex-example-0"></a><p class="title"><b>Example 2. <code class="filename">/etc/sysconfig/tcng/class-selection-path.tcc</code></b></p><div class="example-contents"><pre class="programlisting">
/*
 * Simply commented example of a tcng traffic control file.
 *
 *   Martin A. Brown <code class="email">&lt;<a class="email" href="mailto:martin@linux-ip.net">martin@linux-ip.net</a>&gt;</code>
 *
 * Example:  Using class selection path.
 *
 * (If you are reading the processed output in HTML, the callouts are
 *  clickable links to the description text.)
 *
 */

#include "fields.tc"     <a class="co" name="ex-0-includes" href="#ex-0-includes-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>
#include "ports.tc"

#define INTERFACE  eth0  <a class="co" name="ex-0-defines" href="#ex-0-defines-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>

dev INTERFACE {
    egress { <a class="co" name="ex-0-egress" href="#ex-0-egress-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>

        /* In class selection path, the filters come first!  DSmark */ <a class="co" name="ex-0-csp" href="#ex-0-csp-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>

        class ( &lt;$ssh&gt; )    if tcp_sport ==  22 &amp;&amp; ip_tos_delay == 1 ;
        class ( &lt;$audio&gt; )  if tcp_sport == 554 || tcp_dport == 7070 ;
        class ( &lt;$bulk&gt; ) \
            if tcp_sport == PORT_SSH || tcp_dport == PORT_HTTP ; <a class="co" name="ex-0-portusage" href="#ex-0-portusage-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>
        class ( &lt;$other&gt; )  if 1 ; <a class="co" name="ex-0-leftover" href="#ex-0-leftover-text"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a>

        /* section in which we configure the qdiscs and classes */ 

        htb () { <a class="co" name="ex-0-root" href="#ex-0-root-text"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a>
            class ( rate 600kbps, ceil 600kbps ) { <a class="co" name="ex-0-topclass" href="#ex-0-topclass-text"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a>
                $ssh   = class ( rate  64kbps, ceil 128kbps ) { sfq; } ; 
              <a class="co" name="ex-0-classvariable" href="#ex-0-classvariable-text"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> $audio = class ( rate 128kbps, ceil 128kbps ) { sfq; } ;
                $bulk  = class ( rate 256kbps, ceil 512kbps ) { sfq; } ;
                $other = class ( rate 128kbps, ceil 384kbps ) { sfq; } ; <a class="co" name="ex-0-embedsfq" href="#ex-0-embedsfq-text"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a>
            }
        }
    }
}
      </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-includes-text"></a><a href="#ex-0-includes"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            The <span class="command"><strong>tcng</strong></span> language provides support for C-style
            include directives which can include any file.  Files are included
            relative to the current directory or the <span class="command"><strong>tcng</strong></span>
            library (normally <code class="filename">/usr/lib/tcng/include</code>).
            Strictly speaking, it is not necessary to
            <code class="constant">#include</code> <code class="filename">ports.tc</code> and
            <code class="filename">fields.tc</code>, because
            <span class="command"><strong>tcc</strong></span> will include these by default.
          </p><p>
            The use of <code class="constant">#include</code> can allow for flexible
            definition of variables and inclusion of common traffic control
            elements.
          </p><p>
            See also the tcng manual
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node35.html" target="_top">on
            includes</a>.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-defines-text"></a><a href="#ex-0-defines"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            These are CPP directives.  The <code class="constant">#define</code>
            can be used to create macros or constants.  For more on their use,
            you should see the <span class="command"><strong>tcng</strong></span> manual
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node111.html" target="_top">on
            variables</a>.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-egress-text"></a><a href="#ex-0-egress"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            The <code class="constant">egress</code> keyword is synonymous with the
            <code class="constant">dsmark</code> keyword.  The example here uses
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node32.html" target="_top">class
            selection path</a>.  It is the use of the
            <code class="constant">egress</code> keyword in this configuration which
            requires dsmark support in the kernel and <span class="command"><strong>tc</strong></span>.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-csp-text"></a><a href="#ex-0-csp"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            Class selection path is one approach to traffic shaping.  In class
            selection path, the packet is marked (DiffServ mark) upon entry
            into the router.  The router may take any number of actions or
            apply any number of policing, scheduling or shaping actions on the
            packet as a result of this initial classification.
          </p><p>
            Consult the <span class="command"><strong>tcng</strong></span> manual
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node32.html" target="_top">on class
            selection path</a> for further details.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-portusage-text"></a><a href="#ex-0-portusage"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            This example shows the use of names for the ports instead of
            numbers.  This is one of the conveniences of
            <span class="command"><strong>tcng</strong></span> afforded by the automatic inclusion of
            <code class="filename">ports.tc</code>.  The ports are named in accordance
            with IANA port names.  See
            <a class="ulink" href="http://www.iana.org/assignments/port-numbers" target="_top">IANA's
            registered ports</a> for these names or examine the file
            <code class="filename">ports.tc</code>.
          </p><p>
            Names and numbers are equally acceptable and valid.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-leftover-text"></a><a href="#ex-0-leftover"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            Note this peculiar construct which classifies any packet which
            have not yet been classified.  Any packet which has not been
            classified by the above classifiers is put into the class "$other"
            here.  The <code class="constant">if 1</code> construct can be used to
            classify the remainder of unclassified traffic.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-root-text"></a><a href="#ex-0-root"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            This is the creation of the root qdisc which is attached to
            device, <code class="constant">eth0</code> in this case.  Consult the
            reference material in the <span class="command"><strong>tcng</strong></span>
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node159.html" target="_top">appendix on
            queuing discipline parameters</a> for valid parameters to
            each qdisc.  Any qdisc parameters can be inserted into the
            parentheses in the same fashion as the class parameters further
            below in the example.  If no parameters need be specified, the
            parentheses are optional.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-topclass-text"></a><a href="#ex-0-topclass"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            The top level class in this example sets the maximum bandwidth
            allowed through this class.  Let's assume that
            <code class="constant">eth0</code> is the inside network interface of a
            machine.  This limits the total bandwidth to 600 kilobits per
            second transmitted to the internal network.
          </p><p>
            The parameters
            <code class="constant">rate</code> and <code class="constant">ceil</code> should be
            familiar to anybody who has used HTB.  These are HTB specific
            parameters and are translated properly by the
            <span class="command"><strong>tcc</strong></span> utility.  See the table
            <a class="link" href="#tb-misc-rates" title="Table 1. Speed/Rate syntax: tcng vs. tc">on <span class="command"><strong>tcng</strong></span> rate
            and speed specification</a>.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-classvariable-text"></a><a href="#ex-0-classvariable"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            This is the assignment of a class to a variable.  This is commonly
            done as part of class selection path.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-0-embedsfq-text"></a><a href="#ex-0-embedsfq"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            As suggested by Martin Devera on the HTB homepage, an embedded SFQ
            gives each class a fair queuing algorithm for distribution of
            resources to the contenders passing packets through that class.
            Note the absence of any parameters to the embedded queuing
            discipline.
          </p><p>
            If no queuing discipline is specified for leaf
            classes, they contain the default, a pfifo_fast qdisc.  The
            inclusion of a stochastic fair queuing qdisc in the leaf classes
            inhibits the ability of a single connection to dominate in a given
            class.
          </p></td></tr></table></div></div></div><br class="example-break"><p>
    </p><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="examples-1"></a>3.2. Using a two-rate three-color meter</h3></div></div></div><p>
    </p><div class="example"><a name="ex-example-1"></a><p class="title"><b>Example 3. <code class="filename">/etc/sysconfig/tcng/two-rate-three-color-meter.tcc</code></b></p><div class="example-contents"><pre class="programlisting">
/*
 * Simply commented example of a tcng traffic control file.
 *
 *   Martin A. Brown <code class="email">&lt;<a class="email" href="mailto:martin@linux-ip.net">martin@linux-ip.net</a>&gt;</code>
 *
 * Example:  Using a meter.
 *
 * (If you are reading the processed output in HTML, the callouts are
 *  clickable links to the description text.)
 *
 */

#define   EXCEPTION      192.168.137.50
#define   INTERFACE      eth0

$meter = trTCM( cir 128kbps, cbs 10kB, pir 256kbps, pbs 10kB );  <a class="co" name="ex-1-mdefine" href="#ex-1-mdefine-text"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a>

dev eth0 {
    egress {
        class ( &lt;$full&gt; )     if ip_src == EXCEPTION      ; <a class="co" name="ex-1-notmetered" href="#ex-1-notmetered-text"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a>
        class ( &lt;$fast&gt; )     if trTCM_green( $meter )    ; <a class="co" name="ex-1-green" href="#ex-1-green-text"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a>
        class ( &lt;$slow&gt; )     if trTCM_yellow( $meter )   ; <a class="co" name="ex-1-yellow" href="#ex-1-yellow-text"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a>
        drop                  if trTCM_red( $meter )      ; <a class="co" name="ex-1-red" href="#ex-1-red-text"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a>
        htb {
            class ( rate 600kbps, ceil 600kbps ) {
                $fast = class ( rate 256kbps, ceil 256kbps ) { sfq; } ;
                $slow = class ( rate 128kbps, ceil 128kbps ) { sfq; } ;
                $full = class ( rate 600kbps, ceil 600kbps ) { sfq; } ;
            }
        }
    }
}
      </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a name="ex-1-mdefine-text"></a><a href="#ex-1-mdefine"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            This is the declaration of the meter to be used for classifying
            traffic.  The underlying technology used to implement this meter
            is policing.  See the
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node53.html" target="_top">tcng manual
            on meters</a> for the different types of meters.
          </p><p>
            This meter is a two-rate three-color meter, the most complex meter
            available in the <span class="command"><strong>tcng</strong></span> language.  This meter
            returns the colors green, yellow and red, based on the rates
            offered in the committed and peak buckets.  If the metered rate
            exceeds the committed rate, this meter will turn yellow, and if
            the metered rate exceeds the peak rate, this meter will turn red.
          </p><p>
            The variable <code class="varname">$meter</code> can be operated on by
            functions applicable to the meter type.  In this case, there are
            three functions available for testing <code class="varname">$meter</code>'s
            state,
            <code class="function">trTCM_green</code>, <code class="function">trTCM_yellow</code>,
            and <code class="function">trTCM_red</code>.  For efficiency, consider also
            the
            <a class="ulink" href="http://linux-ip.net/gl/tcng/node58.html" target="_top">accelerated
            counterparts</a>.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-1-notmetered-text"></a><a href="#ex-1-notmetered"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            In this example, the IP 192.168.137.50 is specifically excluded
            from the policing control applied to traffic departing on eth0.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-1-green-text"></a><a href="#ex-1-green"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            Up to the committed information rate (<code class="constant">cir</code>),
            packets will pass through this class.  Tokens will be removed from
            the <code class="constant">cir</code>/<code class="constant">cbs</code> bucket.
          </p><p>
            The meter is green.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-1-yellow-text"></a><a href="#ex-1-yellow"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            Traffic flow exceeding the
            <code class="constant">cir</code>/<code class="constant">cbs</code> bucket will be
            classified here.  The
            <code class="constant">pir</code>/<code class="constant">pbs</code> bucket
            (<code class="constant">pir</code> is peak information rate,
            <code class="constant">pbs</code> is peak burst size).  This allows a
            particular flow to be guaranteed one class of service up to a
            given rate, and then be reclassified above that rate.
          </p><p>
            The meter is yellow.
          </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a name="ex-1-red-text"></a><a href="#ex-1-red"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>
            Traffic flow exceeding the
            <code class="constant">pir</code>/<code class="constant">pbs</code> bucket will be
            classified here.  A common configuration causes traffic to be
            dropped above peak rate, although traffic could be re-classified
            into a best-effort class from a guaranteed class.
          </p><p>
            The meter is red.
          </p></td></tr></table></div></div></div><br class="example-break"><p>
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="misc"></a>4. Miscellaneous Notes</h2></div></div></div><p>
    Thankfully, <span class="command"><strong>tcng</strong></span> does away with one of the minor
    annoyances of <span class="command"><strong>tc</strong></span>.  The following table maps the syntax
    and convention of these tools with English equivalents.
  </p><div class="table"><a name="tb-misc-rates"></a><p class="title"><b>Table 1. Speed/Rate syntax: tcng vs. tc</b></p><div class="table-contents"><table class="table" summary="Speed/Rate syntax: tcng vs. tc" border="1"><colgroup><col><col><col></colgroup><thead><tr><th align="left">tcng</th><th align="left">English</th><th align="left">tc</th></tr></thead><tbody><tr><td align="left">bps</td><td align="left">bit(s) per second</td><td align="left">bit</td></tr><tr><td align="left">Bps</td><td align="left">byte(s) per second</td><td align="left">bps (argh!)</td></tr><tr><td align="left">kbps</td><td align="left">kilobit(s) per second</td><td align="left">kbit</td></tr><tr><td align="left">kBps</td><td align="left">kilobyte(s) per second</td><td align="left">kbps</td></tr><tr><td align="left">Mbps</td><td align="left">megabit(s) per second</td><td align="left">mbit or Mbit</td></tr><tr><td align="left">MBps</td><td align="left">megabyte(s) per second</td><td align="left">mbps or Mbps</td></tr><tr><td align="left">pps</td><td align="left">packet per second</td><td align="left">??</td></tr></tbody></table></div></div><br class="table-break"><p>
    Note that this means a slight adjustment for longtime users of
    <span class="command"><strong>tc</strong></span>, but a much better choice for intuitive usablity for
    English speakers.
  </p><p>
    For example, we can use conventional expressions of rate in
    <span class="command"><strong>tcng</strong></span> configurations:  <strong class="userinput"><code>100Mbps</code></strong>,
    <strong class="userinput"><code>128kbps</code></strong>, and even <strong class="userinput"><code>2Gpps</code></strong>.
    See also the <span class="command"><strong>tcng</strong></span> manual
    <a class="ulink" href="http://linux-ip.net/gl/tcng/node21.html" target="_top">on units</a>.
  </p><p>
    In order for traffic control to be effective, it is important to
    understand where the bottlenecks are.  In most cases, you'll want to
    perform the traffic control at or near the bottleneck.
  </p><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="further"></a>5. Links and Further documentation</h2></div></div></div><p>
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <a class="ulink" href="http://diffserv.sourceforge.net/" target="_top">the linux DiffServ
        project</a>
      </p></li><li class="listitem"><p>
        <a class="ulink" href="http://luxik.cdi.cz/~devik/qos/htb/" target="_top">HTB
        site (<span class="emphasis"><em>Martin <span class="quote">&#8220;<span class="quote">devik</span>&#8221;</span> Devera</em></span>)</a>
      </p></li><li class="listitem"><p>
         <a class="ulink" href="http://tcng.sourceforge.net/" target="_top">Traffic Control Next
         Generation (<span class="command"><strong>tcng</strong></span>)</a>
      </p><p>
        <a class="ulink" href="http://linux-ip.net/gl/tcng/" target="_top">TCNG manual
        (<span class="emphasis"><em>Werner Almesberger</em></span>)</a>
      </p></li><li class="listitem"><p>
        <a class="ulink" href="ftp://ftp.inr.ac.ru/ip-routing/" target="_top">iproute2
        (<span class="emphasis"><em>Alexey Kuznetsov</em></span>)</a>
      </p><p>
        <a class="ulink" href="http://linux-ip.net/gl/ip-cref/" target="_top"><span class="command"><strong>iproute2</strong></span>
        manual (<span class="emphasis"><em>Alexey Kuznetsov</em></span>)</a>
      </p></li><li class="listitem"><p>
        <a class="ulink" href="http://www.docum.org/" target="_top">Research and documentation on
        traffic control under linux (<span class="emphasis"><em>Stef Coene</em></span>)</a>
      </p></li><li class="listitem"><p>
        <a class="ulink" href="http://lartc.org/howto/" target="_top">LARTC HOWTO (<span class="emphasis"><em>bert
        hubert, et.  al.</em></span>)</a>
      </p></li><li class="listitem"><p>
        <a class="ulink" href="http://linux-ip.net/" target="_top">guide to IP networking with
        linux (<span class="emphasis"><em>Martin A. Brown</em></span>)</a>
      </p></li></ul></div></div></div></body></html>
