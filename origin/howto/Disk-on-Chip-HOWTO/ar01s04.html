<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>4. Using M-Systems DiskOnChip 2000 TSOP as an additional storage drive in Linux</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Booting Linux from DiskOnChip HOWTO"><link rel="up" href="index.html" title="Booting Linux from DiskOnChip HOWTO"><link rel="prev" href="ar01s03.html" title="3. Assumptions"><link rel="next" href="ar01s05.html" title="5. Install Linux and LILO on DiskOnChip"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4. Using M-Systems DiskOnChip 2000 TSOP as an additional storage drive in Linux</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s03.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s05.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="steps"></a>4. Using M-Systems DiskOnChip 2000 TSOP as an additional storage drive in Linux</h2></div></div></div><p>The following are the steps performed for this purpose.</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step1"></a>4.1. Step 1: Patch the Kernel</h3></div></div></div><p>Download a fresh copy of Kernel 2.4.18 from <a class="ulink" href="http://www.kernel.org/pub/linux/kernel/v2.4" target="_top">http://www.kernel.org/pub/linux/kernel/v2.4</a>.</p><p>The kernel that is downloaded from the site does not have support for the M-Systems driver so we need to add this functionality.  This is done by adding a patch to the kernel.</p><p>The steps to conduct patching are as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Untar the kernel source file and the M-systems TrueFFS Linux driver version 5.14.  If the source code is in <code class="filename">.tar.gz</code> format, use</p><div class="cmdsynopsis"><p><code class="command">tar <code class="option">-xvzf</code> <code class="filename">linux-2.4.18.tar.gz</code></code> </p></div><p>If the source code is in <code class="filename">.tar.bz2</code> format, use</p><div class="cmdsynopsis"><p><code class="command">bunzip2 <code class="filename">linux-2.4.18.tar.bz2</code></code> </p></div><p>After using <span class="command"><strong>bunzip2</strong></span>, you will get a file named <code class="filename">linux-2.4.18.tar</code>.  Untar it using the command</p><div class="cmdsynopsis"><p><code class="command">tar <code class="option">-xvf</code> <code class="filename">linux-2.4.18.tar</code></code> </p></div><p>Unarchiving the driver is done using the command</p><div class="cmdsynopsis"><p><code class="command">tar <code class="option">-xvzf</code> <code class="filename">linux_binary.5_1_4.tgz</code></code> </p></div><p>This results in the creation of two directories: <code class="filename">linux</code> and <code class="filename">linux_binary.5_1_4</code>.</p></li><li class="listitem"><p>The TrueFFS Linux driver package contains three different folders:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="filename">Documentation</code>: this contains a PDF document describing the various functions of TrueFFS.</p></li><li class="listitem"><p><code class="filename">dformat_5_1_4_37</code>: this contains a utility <span class="command"><strong>dformat</strong></span>, which is used to update the firmware on the DiskOnChip (DOC) and to create low level partitions on the DOC.</p></li><li class="listitem"><p><code class="filename">doc-linux-5_1_4_20</code>: this contains patches, <code class="filename">initrd</code> scripts and other utilities.</p></li></ul></div></li><li class="listitem"><p>Now apply the patch to the kernel.  We will use the <code class="filename">linux-2_4_7-patch</code> file that is present in <code class="filename">linux_binary.5_1_4/doc-linux-5_1_4_20/driver</code>.  The following commands are used for this purpose:</p><div class="cmdsynopsis"><p><code class="command">cd <code class="filename">linux_binary.5_1_4/doc-linux-5_1_4_20/driver</code></code> </p></div><div class="cmdsynopsis"><p><code class="command">patch <code class="option">-p1 -d</code> <code class="filename">/usr/src/linux</code> &lt; <code class="filename">linux-2_4_7-patch</code></code> </p></div><p>This will create a directory named <code class="filename">doc</code> in the <code class="filename">linux/drivers/block</code> directory.</p></li><li class="listitem"><p>The patch created the <code class="filename">doc</code> directory, but did not copy the source files of the M-Systems driver, which are necessary in order to build the driver, into this directory.  So execute the following command:</p><div class="cmdsynopsis"><p><code class="command">cp <code class="filename">linux_binary.5_1_4/doc-linux-5_1_4_20/driver/doc/* /usr/src/linux/drivers/block/doc</code></code> </p></div></li></ol></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Kernel version</h3><p>The patch will fail for kernels other than 2.4.18 since the source files where the patch is to be applied may be somewhat different in different kernels. The patch has been provided specifically for kernel 2.4.18.</p></div><p>Before moving on to Step 2, do the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Login as root.</p></li><li class="listitem"><p>Make sure that <span class="command"><strong>gcc</strong></span> version is 2.95.3 else the build will fail. Use <span class="command"><strong>gcc <code class="option">--version</code></strong></span> to check this.  If your <span class="command"><strong>gcc</strong></span> version is different compile gcc-2.95.3. Refer to <a class="ulink" href="http://xlife.zuarvra.net.columns/20020316" target="_top">http://xlife.zuarvra.net.columns/20020316</a> for this purpose.</p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step2"></a>4.2. Step 2: Compile the Kernel</h3></div></div></div><p>Complete the following tasks for compiling the kernel:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p><span class="command"><strong>cd <code class="filename">linux</code></strong></span></p></li><li class="listitem"><p><span class="command"><strong>make <em class="parameter"><code>menuconfig</code></em></strong></span></p><p>Check for the following options:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>In the <span class="quote">&#8220;<span class="quote">Block devices menu</span>&#8221;</span>, select:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>M-Systems driver as module i.e. (M)</p></li><li class="listitem"><p>Loopback device support as built-in i.e. (*)</p></li><li class="listitem"><p>RAM disk support as built-in i.e. (*)</p></li><li class="listitem"><p>Initial RAM disk (initrd) support as built .in i.e. (*)</p></li></ul></div></li><li class="listitem"><p>In the <span class="quote">&#8220;<span class="quote">Processor type and features menu</span>&#8221;</span>, select <span class="quote">&#8220;<span class="quote">Disable Symmetric Multiprocessor Support</span>&#8221;</span>.</p></li><li class="listitem"><p>In the <span class="quote">&#8220;<span class="quote">filesystem menu</span>&#8221;</span>, select:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>Ext3 journaling file system support as built-in</p></li><li class="listitem"><p>DOS FAT fs support as built-in<sup>a</sup></p></li><li class="listitem"><p>MSDOS fs support as built-in<sup>b</sup></p></li><li class="listitem"><p>VFAT (Windows-95) fs support as built-in<sup>c</sup> </p></li></ul></div></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">File System Menu</h3><p>a,b,c options should be activated if you want to mount your MS Windows partition, else they can be left out.  It is, however, generally recommended to use them.</p></div><p>An excellent resource on kernel compilation is the <a class="ulink" href="http://www.digitalhermit.com/linux/Kernel-Build-HOWTO.html" target="_top">Kernel Rebuild Guide</a>.</p><p>The configuration file, <code class="filename">linux/.config</code> should essentially contain the following lines (only a part of the config file has been given):</p><pre class="screen">
#
# Loadable module support
#
CONFIG_MODULES=y
CONFIG_MODVERSIONS=y
CONFIG_KMOD=y

#
# Processor type and features
#

# CONFIG_SMP is not set


#
# Memory Technology Devices (MTD)
#
# CONFIG_MTD is not set

#
# Block devices
#
# CONFIG_BLK_DEV_FD is not set
# CONFIG_BLK_DEV_XD is not set
# CONFIG_PARIDE is not set
# CONFIG_BLK_CPQ_DA is not set
# CONFIG_BLK_CPQ_CISS_DA is not set
# CONFIG_BLK_DEV_DAC960 is not set
CONFIG_BLK_DEV_LOOP=y
# CONFIG_BLK_DEV_NBD is not set
CONFIG_BLK_DEV_RAM=y
CONFIG_BLK_DEV_RAM_SIZE=4096
CONFIG_BLK_DEV_INITRD=y
CONFIG_BLK_DEV_MSYS_DOC=m

#
# File systems
#
# CONFIG_QUOTA is not set
# CONFIG_AUTOFS_FS is not set
# CONFIG_AUTOFS4_FS is not set
CONFIG_EXT3_FS=y
CONFIG_FAT_FS=y
CONFIG_MSDOS_FS=y
# CONFIG_UMSDOS_FS is not set
CONFIG_VFAT_FS=y
# CONFIG_EFS_FS is not set
# CONFIG_JFFS_FS is not set
# CONFIG_JFFS2_FS is not set
# CONFIG_CRAMFS is not set
CONFIG_TMPFS=y
# CONFIG_RAMFS is not set
CONFIG_ISO9660_FS=y
# CONFIG_JOLIET is not set
# CONFIG_HPFS_FS is not set
CONFIG_PROC_FS=y
# CONFIG_DEVFS_FS is not set
# CONFIG_DEVFS_MOUNT is not set
# CONFIG_DEVFS_DEBUG is not set
CONFIG_DEVPTS_FS=y
# CONFIG_QNX4FS_FS is not set
# CONFIG_QNX4FS_RW is not set
# CONFIG_ROMFS_FS is not set
CONFIG_EXT2_FS=y
</pre></li><li class="listitem"><p><span class="command"><strong>make <em class="parameter"><code>dep</code></em></strong></span></p></li><li class="listitem"><p><span class="command"><strong>make <em class="parameter"><code>bzImage</code></em></strong></span></p></li><li class="listitem"><p><span class="command"><strong>make <em class="parameter"><code>modules</code></em></strong></span></p></li><li class="listitem"><p><span class="command"><strong>make <em class="parameter"><code>modules_install</code></em></strong></span></p></li><li class="listitem"><p>Copy the newly created <code class="filename">bzImage</code> to the <code class="filename">/bott</code> directory and name it <code class="filename">vmlinuz-2.4.18</code>, using this command:</p><div class="cmdsynopsis"><p><code class="command">cp <code class="filename">/arch/i386/boot/bzImage /boot/vmlinuz-2.4.18</code></code> </p></div></li></ol></div><p>Check for <code class="filename">lib/modules/2.4.18/kernel/drivers/block/doc.o</code>.  This is the M-Systems driver that we need to access DiskOnChip.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step3"></a>4.3. Step 3: Create Nodes</h3></div></div></div><p>Now we will create block devices, which are required to access the DOC
These block devices will use the M-Systems driver that was built in <a class="xref" href="ar01s04.html#step2" title="4.2. Step 2: Compile the Kernel">Section 4.2, &#8220;Step 2: Compile the Kernel&#8221;</a> to access the DOC. The script <span class="command"><strong>mknod_fl</strong></span> in <code class="filename">linux_binary.5_1_4/doc-linux-5_1_4_20/driver</code> is used for this purpose.</p><p>We need to create the block devices with the major number of 62. For this purpose we will pass the argument 62 while creating the nodes:</p><div class="cmdsynopsis"><p><code class="command">./mknod_fl <em class="parameter"><code>62</code></em></code> </p></div><p>This will create the following devices in <code class="filename">/dev/msys</code> with major number 62:</p><pre class="screen">
fla...fla4
flb...flb4
flc...flc4
fld...fld4
</pre></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step4"></a>4.4. Step 4: Reboot with the new kernel</h3></div></div></div><p>In order to have the DiskOnChip recognized by Linux OS, we need to insert the DOC driver module into the kernel. Since the currently running kernel doesn't have support for the M-Systems Driver, we need to boot into new kernel we just compiled in <a class="xref" href="ar01s04.html#step2" title="4.2. Step 2: Compile the Kernel">Section 4.2, &#8220;Step 2: Compile the Kernel&#8221;</a>.</p><p>For this purpose we need to add the following entries in the <code class="filename">/boot/grub/menu.lst</code> file:</p><pre class="screen">
title Debian GNU/Linux,Kernel 2.4.18
root (hd0,7)
kernel /boot/vmlinuz-2.4.18 root=/dev/hda8
safedefault
boot
</pre><p>Where (hd0,7) is the partition holding the kernel image <code class="filename">vmlinuz-2.4.18</code> and <code class="filename">/dev/hda8</code> is the partition holding the <span class="emphasis"><em>root filesystem</em></span>.  These partitions may vary from one system to another. Now reboot and choose the kernel 2.4.18 option (the kernel that has been compiled in Step 2) in the <span class="command"><strong>grub</strong></span> menu to boot into the new kernel.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step5"></a>4.5. Step 5: Insert M-Systems Driver/Module in the new Kernel</h3></div></div></div><p>The M-Systems driver by default gets loaded with major number 100, but our newly created nodes (see <a class="xref" href="ar01s04.html#step3" title="4.3. Step 3: Create Nodes">Section 4.3, &#8220;Step 3: Create Nodes&#8221;</a>) have a major number 62. Therefore we need to insert this module with a major number 62. This can be done in either of two ways:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>While inserting the module using <span class="command"><strong>insmod</strong></span> also mention the major number for the module which needs to be assigned to it otherwise it will take the default major number of 100:</p><div class="cmdsynopsis"><p><code class="command">insmod <em class="parameter"><code>doc major=62</code></em></code> </p></div></li><li class="listitem"><p>Add the following line to <code class="filename">/etc/modules.conf</code>:</p><pre class="screen">options doc major=62</pre><p>Then use <span class="command"><strong>modprobe <em class="parameter"><code>doc</code></em></strong></span> to insert the modules.</p></li></ol></div><p>Check for the correct loading of the module using the <span class="command"><strong>lsmod</strong></span> command without options.</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step6"></a>4.6. Step 6: Create a filesystem on the DiskOnChip</h3></div></div></div><p>Before we can start using DiskOnChip we need to create a filesystem on it.  We will create an ext2 filesystem since it is small in size.</p><p>This involves a hidden step of making partitions on the DOC using <span class="command"><strong>fdisk</strong></span>.  The actual steps are as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="cmdsynopsis"><p><code class="command">fdisk <code class="filename">/dev/msys/fla</code></code> </p></div><p>This command will ask to create partitions.  Create a primary partition number 1 with start cylinder as 1 and final cylinder as 1002.</p><p>Check the partition table, which should look like this:</p><pre class="screen">
Device             Boot  Start      End        Blocks    ID     System
/dev/msys/fla1            1         1002        255984   83     Linux
</pre></li><li class="listitem"><p>Make the filesystem on <code class="filename">/dev/msys/fla1</code> with the command</p><div class="cmdsynopsis"><p><code class="command">mke2fs <code class="option">-c</code> <code class="filename">/dev/msys/fla1</code></code> </p></div><p>Where <code class="filename">fla1</code> is the first primary partition on the DOC. (We have created only one partition in order to avoid unnecessary complexity.)</p></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="step7"></a>4.7. Step 7: Mount the newly created partition to start accessing DOC</h3></div></div></div><p>Create a new mount point for the DiskOnChip in the <code class="filename">/mnt</code> directory:</p><div class="cmdsynopsis"><p><code class="command">mkdir <code class="filename">/mnt/doc</code></code> </p></div><p>Mount the DOC partition on the newly created directory:</p><div class="cmdsynopsis"><p><code class="command">mount <code class="option">-t</code> <em class="parameter"><code>auto</code></em> <code class="filename">/dev/msys/fla1 /mnt/doc</code></code> </p></div><p>You will now be able to read and write to the DOC as an additional storage drive.</p><p>When you reboot your system, make the DOC available by inserting the driver into the kernel (see <a class="xref" href="ar01s04.html#step5" title="4.5. Step 5: Insert M-Systems Driver/Module in the new Kernel">Section 4.5, &#8220;Step 5: Insert M-Systems Driver/Module in the new Kernel&#8221;</a>) and mounting the device.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s03.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s05.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">3. Assumptions </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 5. Install Linux and LILO on DiskOnChip</td></tr></table></div></body></html>
