<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>MMBase Installation HOWTO</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="description" content="This document describes the installation of the MMBase content management system on a Red Hat Linux distribution, using the Tomcat application server, and integrating it with MySQL and Apache."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article"><div class="titlepage"><div><div><h2 class="title"><a name="MMBase-Inst-HOWTO"></a>
  <span class="application">MMBase</span> Installation HOWTO
  </h2></div><div><div class="author"><h3 class="author"><span class="firstname">Adrian</span> <span class="surname">Offerman</span></h3><div class="affiliation"><div class="address"><p><br>
    <code class="email">&lt;<a class="email" href="mailto:tldp@NOSPAM.offerman.net">tldp@NOSPAM.offerman.net</a>&gt;</code><br>
    </p></div></div></div></div><div><p class="releaseinfo">minor corrections</p></div><div><p class="copyright">Copyright © 2003 - 2006 Adrian Offerman</p></div><div><p class="pubdate">June 25, 2006</p></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision 0.3.5</td><td align="left">2006-06-25</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">Tomcat init script</td></tr><tr><td align="left">Revision 0.3.4</td><td align="left">2005-09-18</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">minor corrections</td></tr><tr><td align="left">Revision 0.3.2</td><td align="left">2005-01-25</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">MMBase 1.7.3, Java 1.5.0-01</td></tr><tr><td align="left">Revision 0.3.1</td><td align="left">2004-12-26</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">Email module</td></tr><tr><td align="left">Revision 0.3.0</td><td align="left">2004-12-25</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">MMBase 1.7.2, Tomcat 5.5.4, Java 1.5.0, MySQL Connector/J 3.0.16-ga, Jikes 1.22</td></tr><tr><td align="left">Revision 0.2.6</td><td align="left">2004-07-27</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">minor additions</td></tr><tr><td align="left">Revision 0.2.5</td><td align="left">2004-02-28</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">Creative Commons copyright license adjusted</td></tr><tr><td align="left">Revision 0.2.4</td><td align="left">2004-01-22</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">Creative Commons copyright license; minor additions and corrections</td></tr><tr><td align="left">Revision 0.2.3</td><td align="left">2003-12-26</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">minor additions and corrections</td></tr><tr><td align="left">Revision 0.2.2</td><td align="left">2003-12-20</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">copyright adjusted</td></tr><tr><td align="left">Revision 0.2.1</td><td align="left">2003-12-18</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">minor corrections</td></tr><tr><td align="left">Revision 0.2.0</td><td align="left">2003-12-15</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">JK 2 Connector setup added</td></tr><tr><td align="left">Revision 0.1.0</td><td align="left">2003-12-10</td><td align="left">AO</td></tr><tr><td align="left" colspan="3">initial draft</td></tr></table></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
  This document describes the installation of the
  <span class="application">MMBase</span>
  content management system
  on a <code class="systemitem">Red Hat Linux</code> distribution,
  using the <span class="application">Tomcat</span> application
  server,
  and integrating it with <span class="application">MySQL</span>
  and <span class="application">Apache</span>.
  </p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#idm113">1. Introduction</a></span></dt><dt><span class="sect1"><a href="#idm201">2. Installation</a></span></dt><dt><span class="sect1"><a href="#idm212">3. Installing <span class="application">Java</span></a></span></dt><dt><span class="sect1"><a href="#idm321">4. Installing <span class="application">Tomcat</span></a></span></dt><dt><span class="sect1"><a href="#idm433">5. 
Replacing <span class="application">Tomcat</span>'s
default <acronym class="acronym">JSP</acronym> compiler
<span class="application">Jasper</span>
with <acronym class="acronym">IBM</acronym>'s
<span class="application">Jikes</span> compiler
</a></span></dt><dt><span class="sect1"><a href="#idm482">6. 
Installing <span class="application">ImageMagick</span>
</a></span></dt><dt><span class="sect1"><a href="#idm502">7. Installing <span class="application">MMBase</span></a></span></dt><dt><span class="sect1"><a href="#idm572">8. 
Connecting <span class="application">MMBase</span>
to <span class="application">MySQL</span>
using <code class="systemitem">MySQL Connector/J</code>
</a></span></dt><dt><span class="sect1"><a href="#idm634">9. 
Installing <span class="application">MMBase</span>
additional applications
</a></span></dt><dd><dl><dt><span class="sect2"><a href="#idm644">9.1. 
Installing
the <span class="application">CloudContext Security</span> module
</a></span></dt><dt><span class="sect2"><a href="#idm679">9.2. 
Installing
the <span class="application">Media</span> module
</a></span></dt><dt><span class="sect2"><a href="#idm683">9.3. 
Installing
the <span class="application">Email</span> module
</a></span></dt></dl></dd><dt><span class="sect1"><a href="#idm719">10. 
Configuring initial
<span class="application">MMBase</span> settings
</a></span></dt><dt><span class="sect1"><a href="#idm759">11. Running <span class="application">MMBase</span></a></span></dt><dt><span class="sect1"><a href="#JK2">12. 
Connecting <span class="application">Apache</span>
and <span class="application">Tomcat</span>
using <code class="systemitem">mod_jk2</code>
</a></span></dt><dt><span class="sect1"><a href="#idm1037">13. 
Installing an <span class="application">Apache</span>
reverse proxy
as a front-end
to your <span class="application">MMBase</span> server
</a></span></dt><dt><span class="sect1"><a href="#idm1064">14. 
Installing more <span class="application">MMBase</span> servers
on a single <span class="application">Tomcat</span> server
</a></span></dt><dt><span class="sect1"><a href="#idm1141">15. Acknowledgements</a></span></dt><dt><span class="sect1"><a href="#idm1147">16. Contributers</a></span></dt><dt><span class="sect1"><a href="#idm1156">17. Revision history</a></span></dt><dt><span class="sect1"><a href="#idm1201">18. Disclaimer</a></span></dt><dt><span class="sect1"><a href="#idm1206">19. Copyright</a></span></dt></dl></div><p>
This document describes the installation of the
<span class="application">MMBase</span> content management system
on a <code class="systemitem">Red Hat Linux</code> distribution,
using the <span class="application">Tomcat</span> application
server,
and integrating it with <span class="application">MySQL</span>
and <span class="application">Apache</span>.
</p><p>
Version: 0.3.5; June 25, 2006.
</p><p>
Author: <a class="ulink" href="http://www.offerman.net/" target="_top">Adrian Offerman</a>
</p><p>
The latest version of this document can be found at:
</p><pre class="screen">
  <a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/" target="_top">http://www.offerman.net/MMBase-Installation-HOWTO/</a>
</pre><p>
</p><p>
Feedback is welcome at:
</p><pre class="screen">
  <a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/feedback.html" target="_top">http://www.offerman.net/MMBase-Installation-HOWTO/feedback.html</a>
</pre><p>
</p><p>
For questions, check out the
<span class="application">MMBase</span> website:
</p><pre class="screen">
  <a class="ulink" href="http://www.mmbase.org/" target="_top">http://www.mmbase.org/</a>
</pre><p>
</p><p>
You can find the
<span class="application">MMBase</span> documentation at:
</p><pre class="screen">
  <a class="ulink" href="http://www.mmbase.org/docs/" target="_top">http://www.mmbase.org/docs/</a>
</pre><p>
</p><p>
Good luck!
</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm113"></a>1. Introduction</h2></div></div></div><p>
&gt;From the <span class="application">MMBase</span> website
(<a class="ulink" href="http://www.mmbase.org" target="_top">www.mmbase.org</a>):
</p><div class="blockquote"><blockquote class="blockquote"><p>
<span class="quote">&#8220;<span class="quote"><span class="application">MMBase</span>
is a Web Content Management System
with strong multimedia features.
<span class="application">MMBase</span>
has a large installed base in The Netherlands,
and is used by major Dutch broadcasters, publishers, educational institutes,
national and local governments.
<span class="application">MMBase</span>
is written in <span class="application">Java</span>,
it is Open Source Software (<acronym class="acronym">MPL</acronym>)
and all standards used are as 'open' as possible.
The system can be used with all major operating systems, application servers
and databases.</span>&#8221;</span>
</p></blockquote></div><p>
</p><p>
Unfortunately, the installation of
<span class="application">MMBase</span>
is not well documented.
Furthermore, when searching the internet looking for installation clues
and trying out tips,
it turns out that the details of the installation have changed frequently.
</p><p>
This document describes the installation of the
<span class="application">MMBase</span> content management system
on a <code class="systemitem">Red Hat Linux</code> distribution,
using the <span class="application">Tomcat</span> application
server,
and the integration with <span class="application">MySQL</span>
and <span class="application">Apache</span>.
</p><p>
It is based on our own experience
and compiled to the benefit of the community.
</p><p>
These are the ingredients we used to cook up this recipe ourselves:
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
<code class="systemitem">Red Hat 8.0</code> distribution
running a <code class="systemitem">2.4.20 kernel</code>,
with <code class="systemitem">Alan Cox 2</code>
and
<code class="systemitem"><acronym class="acronym">EA</acronym>/<acronym class="acronym">ACL</acronym></code>
extensions.
</p></li><li class="listitem"><p>
<span class="application">Java 2 Software Developers Kit (<acronym class="acronym">SDK</acronym>)</span>
and <span class="application">Java 2 Run-time Engine (<acronym class="acronym">J2RE</acronym>)</span>
from <span class="application">Sun's Java 2 Platform Standard Edition 5.0 (<acronym class="acronym">J2SE</acronym>) (version 1.5.0-01)</span>,
</p></li><li class="listitem"><p>
<span class="application">Apache Jakarta Tomcat 5.5.4</span>,
</p></li><li class="listitem"><p>
<span class="application">ImageMagick 6.1.3-7</span>,
</p></li><li class="listitem"><p>
<span class="application">MMBase 1.7.3 with various modules</span>,
</p></li><li class="listitem"><p>
<span class="application">MySQL Connector/J 3.0.16-ga</span>,
</p></li><li class="listitem"><p>
<span class="application">Jikes 1.22</span>.
</p></li></ul></div><p>

And before:
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
<code class="systemitem">Red Hat 8.0</code> distribution
running a <code class="systemitem">2.4.20 kernel</code>,
with <code class="systemitem">Alan Cox 2</code>
and
<code class="systemitem"><acronym class="acronym">EA</acronym>/<acronym class="acronym">ACL</acronym></code>
extensions.
</p></li><li class="listitem"><p>
<span class="application">Java 2 Software Developers Kit (<acronym class="acronym">SDK</acronym>)</span>
and <span class="application">Java 2 Run-time Engine (<acronym class="acronym">J2RE</acronym>)</span>
from the <span class="application">Blackdown Java 2 <acronym class="acronym">JDK</acronym> version v1.4.1-01</span>,
</p></li><li class="listitem"><p>
<span class="application">Apache Jakarta Tomcat 4.1.27</span>,
</p></li><li class="listitem"><p>
<span class="application">ImageMagick 5.4.7-5</span>,
</p></li><li class="listitem"><p>
<span class="application">MMBase 1.6.5 for <acronym class="acronym">JDK</acronym> 1.4</span>,
</p></li><li class="listitem"><p>
<span class="application">MySQL Connector/J 3.0.8</span>,
</p></li><li class="listitem"><p>
<span class="application">Jikes 1.18</span>.
</p></li></ul></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm201"></a>2. Installation</h2></div></div></div><p>
Although we installed <span class="application">MMBase</span>
on a kernel with the <code class="systemitem">Alan Cox</code>
and
<code class="systemitem"><acronym class="acronym">EA</acronym>/<acronym class="acronym">ACL</acronym></code>
extensions,
these features are no prerequisites.
</p><p>
We assume that you have already installed and configured
<span class="application">Apache</span>
and <span class="application">MySQL</span>
on your server.
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm212"></a>3. Installing <span class="application">Java</span></h2></div></div></div><p>
Download the latest versions of the
<span class="application">Java 2 Development Kit
(<acronym class="acronym">JDK</acronym>)</span> or
<span class="application">Run-time Engine
(<acronym class="acronym">JRE</acronym>)</span>,
and the accompanying documentation from:
</p><pre class="screen">
  <a class="ulink" href="http://java.sun.com/" target="_top">http://java.sun.com</a>
</pre><p>
</p><p>
Installation instructions and release notes for the
<span class="application"><acronym class="acronym">JDK</acronym></span> and
<span class="application"><acronym class="acronym">JRE</acronym></span>
are available at the download page.
</p><p>
Make the binary distribution of the
<span class="application"><acronym class="acronym">JDK</acronym></span>
executable
and extract in a new directory:
</p><pre class="programlisting">
  
  chmod +x jdk-xxx.bin
  cd /usr/local/
  .../jdk-xxx.bin
  
  </pre><p>
</p><p>
Install the <span class="application"><acronym class="acronym">JDK</acronym></span>
documentation
by unzipping it in the
<span class="application"><acronym class="acronym">JDK</acronym></span> directory:
</p><pre class="programlisting">
  
  cd /usr/local/jdk-xxx/
  unzip .../jdk-xxx-doc.zip
  
  </pre><p>
</p><p>
Change the ownership of the
<span class="application"><acronym class="acronym">JDK</acronym></span> directory
and make it available as
<code class="filename">/usr/local/j2sdk/</code>:
</p><pre class="programlisting">
  
  chown -R root:root /usr/local/jdk-xxx/
  ln -s /usr/local/jdk-xxx /usr/local/j2sdk
  
  </pre><p>
</p><p>
If you need only the
<span class="application"><acronym class="acronym">JRE</acronym></span>,
the installation would be like this:
</p><pre class="programlisting">
  
  chmod +x jre-xxx.bin
  cd /usr/local/
  .../jre-xxx.bin
  chown -R root:root /usr/local/jre-xxx/
  ln -s /usr/local/jre-xxx /usr/local/j2re
  
  </pre><p>
</p><p>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
Using <span class="application"><acronym class="acronym">JDK</acronym></span>
version 1.5.0 caused
our <span class="application">Tomcat</span> server
to crash every now and then:
</p><pre class="programlisting">
  
  #
  # An unexpected error has been detected by HotSpot Virtual Machine:
  #
  #  SIGSEGV (0xb) at pc=0x4042db3f, pid=11991, tid=16386
  #
  # Java VM: Java HotSpot(TM) Server VM (1.5.0-b64 mixed mode)
  # Problematic frame:
  # V  [libjvm.so+0x3abb3f]
  #
  
  </pre><p>
Upgrading to version 1.5.0-01 seemed to solve these problems.
</p></div><p>
</p><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
For the (previously used)
<span class="application">BlackDown Java for Linux distribution</span>:
</p><p>
Find yourself a mirror for the
<span class="application">BlackDown Java Development Kit</span>
at:
</p><pre class="screen">
  <a class="ulink" href="http://www.blackdown.org/java-linux/mirrors.html" target="_top">http://www.blackdown.org/java-linux/mirrors.html</a>
</pre><p>
</p><p>
There you can download the latest versions of the
<span class="application">J2 Software Development Kit (<acronym class="acronym">SDK</acronym>)</span>
and
<span class="application">Run-time Engine (<acronym class="acronym">RE</acronym>)</span>.
</p><p>
Make sure you pick out the right version for the
<code class="systemitem">gcc</code> library installed on your system.
You can find out the version currently installed by typing:
</p><pre class="programlisting">
  
  rpm -q libgcc
  
  </pre><p>
</p><p>
Installation instructions for the
<span class="application">Java Development Kit</span>
are available as
<code class="filename">INSTALL-j2sdk</code>
and <code class="filename">INSTALL-j2re</code>.
</p><p>
Make the binary distribution of the
<span class="application"><acronym class="acronym">SDK</acronym></span>
executable
and extract in a new directory:
</p><pre class="programlisting">
  
  chmod +x j2sdk-xxx.bin
  cd /usr/local/
  .../j2sdk-xxx.bin
  
  </pre><p>
</p><p>
Change the ownership of the
<span class="application"><acronym class="acronym">J2SDK</acronym></span>
directory
and make it available as
<code class="filename">/usr/local/j2sdk/</code>:
</p><pre class="programlisting">
  
  chown -R root:root /usr/local/j2sdk-xxx/
  ln -s /usr/local/j2sdk-xxx /usr/local/j2sdk
  
  </pre><p>
</p><p>
Do the same for the
<span class="application"><acronym class="acronym">RE</acronym></span>:
</p><pre class="programlisting">
  
  chmod +x j2re-xxx.bin
  cd /usr/local/
  .../j2re-xxx.bin
  chown -R root:root /usr/local/j2re-xxx/
  ln -s /usr/local/j2re-xxx /usr/local/j2re
  
  </pre><p>
</p></div><p>
</p><p>
Since we didn't install the
<span class="application"><acronym class="acronym">JDK</acronym></span>
and <span class="application"><acronym class="acronym">JRE</acronym></span>
in our path,
we have to add the <code class="filename">bin/</code> directories
to our <code class="envar">$PATH</code> environment variable.
To make sure the <span class="application">Java</span>
distributions and classes can be found,
we set the <code class="envar">$JAVA_HOME</code>
and <code class="envar">$CLASSPATH</code> variables as well.
</p><p>
For the <span class="application">Bourne shells</span>,
create a file <code class="systemitem">/etc/profile.d/java.sh</code>:
</p><pre class="programlisting">
  
  if ! echo ${PATH} | grep -q /usr/local/j2sdk/bin ; then
    export PATH=/usr/local/j2sdk/bin:${PATH}
    fi
  if ! echo ${PATH} | grep -q /usr/local/j2re/bin ; then
    export PATH=/usr/local/j2re/bin:${PATH}
    fi
  export JAVA_HOME=/usr/local/j2sdk
  export CLASSPATH=.:/usr/local/j2sdk/lib/tools.jar:/usr/local/j2re/lib/rt.jar
  
  </pre><p>
</p><p>
Set its ownership and access rights:
</p><pre class="programlisting">
  
  chown root:root /etc/profile.d/java.sh
  chmod 755 /etc/profile.d/java.sh
  
  </pre><p>
</p><p>
Do the same for <span class="application">C shells</span>,
by creating the file
<code class="systemitem">/etc/profile.d/java.csh</code>:
</p><pre class="programlisting">
  
  if ( "${path}" !~ */usr/local/j2sdk/bin* ) then
    set path = ( /usr/local/j2sdk/bin $path )
    endif
  if ( "${path}" !~ */usr/local/j2re/bin* ) then
    set path = ( /usr/local/j2re/bin $path )
    endif
  setenv JAVA_HOME /usr/local/j2sdk
  setenv CLASSPATH .:/usr/local/j2sdk/lib/tools.jar:/usr/local/j2re/lib/rt.jar
  
  </pre><p>
</p><p>
and setting its ownership and access rights:
</p><pre class="programlisting">
  
  chown root:root /etc/profile.d/java.csh
  chmod 755 /etc/profile.d/java.csh
  
  </pre><p>
</p><p>
Now the <span class="application"><acronym class="acronym">JDK</acronym></span>
should be available to everyone on your system.
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
You can test the <span class="application">Java</span> engine
by typing:
</p><pre class="programlisting">
  
  java -version
  
  </pre><p>
</p><p>
or create a file <code class="filename">Test.java</code>:
</p><pre class="programlisting">
  
  public class Test {
    public static void main(String[] args) {
      System.out.println("Hello world");
      }
    }
  
  </pre><p>
</p><p>
and test the compiler:
</p><pre class="programlisting">
  
  javac Test.java
  java Test
  
  </pre><p>
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm321"></a>4. Installing <span class="application">Tomcat</span></h2></div></div></div><p>
Download a binary distribution of
<span class="application">Tomcat</span>
from the <span class="application">Apache Jakarta</span> website:
</p><pre class="screen">
  <a class="ulink" href="http://jakarta.apache.org/tomcat/" target="_top">http://jakarta.apache.org/tomcat/</a>
</pre><p>
</p><p>
If you don't want to run the
<span class="application">Tomcat</span> daemon as
<code class="systemitem">root</code>,
create a new user/group <code class="systemitem">tomcat</code>
(first make sure that the
<acronym class="acronym">UID</acronym> and <acronym class="acronym">GID</acronym>
you use
are still available
by checking the files <code class="filename">/etc/passwd</code>
and <code class="filename">/etc/group</code>):
</p><pre class="programlisting">
  
  groupadd -g 220 tomcat
  useradd -u 220 -g tomcat -c "Tomcat" -r -d /usr/local/tomcat -s "/sbin/nologin" tomcat
  
  </pre><p>
</p><p>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
You really should not use the
<code class="systemitem">root</code> account
to run the <span class="application">Tomcat</span> daemon;
(using Tomcat version 4.1.27) we found out that this allows the
<span class="application">MMBase</span>
<code class="systemitem">admin</code> user
to write backup dumps of his sites anywhere on the system.
</p></div><p>
</p><p>
&lt;TODO: better solution available?&gt;
</p><p>
Extract the <span class="application">Tomcat</span> distribution
in a new directory:
</p><pre class="programlisting">
  
  cd /usr/local/
  tar -zxvf .../jakarta-tomcat-xxx.tar.gz
  
  </pre><p>
</p><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Version 4.1.27 came with a hot-fix:
</p><pre class="programlisting">
  
  cd /usr/local/jakarta-tomcat-xxx/
  tar -zxvf .../xxx-hotfix-xxx.tar.gz
  
  </pre><p>
</p></div><p>
</p><p>
Change the ownership of the
<span class="application">Tomcat</span> directory
and make it available as
<code class="filename">/usr/local/tomcat/</code>:
</p><pre class="programlisting">
  
  chown -R tomcat:tomcat /usr/local/jakarta-tomcat-xxx
  ln -s /usr/local/jakarta-tomcat-xxx /usr/local/tomcat
  
  </pre><p>
</p><p>
Open up the firewall for web access
to the <span class="application">Tomcat</span> server
by adding to the file
<code class="filename">/etc/sysconfig/iptables</code>:
</p><pre class="programlisting">
  
  -A RH-Lokkit-0-50-INPUT -p tcp -m tcp --dport 8080 --syn -j ACCEPT
  
  </pre><p>
</p><p>
You need to reboot your system to make this rule effective
or restart the <span class="application">iptables</span> firewall:
</p><pre class="programlisting">
  
  service iptables restart
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
Since (for some odd reason) some network managers allow outgoing web
connections only to
<code class="systemitem"><acronym class="acronym">TCP</acronym> port 80</code>,
there might be people around that cannot access your
<span class="application">Tomcat</span>
(and <span class="application">MMBase</span>) server
through <code class="systemitem">port 8080</code>.
Further <a class="link" href="#JK2" title="12.  Connecting Apache and Tomcat using mod_jk2">below</a>
we will explain how to install
a <acronym class="acronym">JK 2</acronym> mapping or a reverse proxy
in <span class="application">Apache</span>,
so <span class="application">Tomcat</span>
and <span class="application">MMBase</span>
can be accessed through the
<span class="application">Apache</span> web server
at <code class="systemitem">port 80</code>.
Apart from the port issue,
this has the advantage that you can use
<span class="application">Apache</span>
to manage you <acronym class="acronym">SSL</acronym> connections
and use your existing
<span class="application">Apache</span>
logs and statistics facilities
for <span class="application">Tomcat</span>
and <span class="application">MMBase</span> as well.
</p><p>
If you decide to use
<span class="application">Apache</span>
as a front-end to your
<span class="application">Tomcat</span>
and <span class="application">MMBase</span> server,
there's no need to open up
<code class="systemitem">port 8080</code>
in your firewall.
</p></div><p>
</p><p>
To run <span class="application">Tomcat</span>,
set the <code class="envar">$CATALINA_HOME</code> environment variable:
</p><pre class="programlisting">
  
  CATALINA_HOME=/usr/local/tomcat
  
  </pre><p>
</p><p>
and fire it up:
</p><pre class="programlisting">
  
  /usr/local/tomcat/bin/startup.sh
  
  </pre><p>
</p><p>
Now you can access
<span class="application">Tomcat</span>'s home page through
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/
  
  </pre><p>
</p><p>
which should give you the <span class="application">Tomcat</span>
welcome screen.
</p><div class="screenshot"><div><img src="ApacheTomcat-600x420.png"></div></div><p>
</p><p>
To shutdown again:
</p><pre class="programlisting">
  
  /usr/local/tomcat/bin/shutdown.sh
  
  </pre><p>
</p><p>
Since we want to automate the starting up and shutting down of the
<span class="application">Tomcat</span> server,
we create a file
<code class="filename">/etc/rc.d/init.d/tomcat</code>
to do this for us:
</p><pre class="programlisting">
  
  #!/bin/sh
  #
  # Startup script for the Jakarta Tomcat Java Servlets and JSP server
  #
  # chkconfig: - 85 15
  # description: Jakarta Tomcat Java Servlets and JSP server
  # processname: tomcat
  # pidfile: /var/run/tomcat.pid
  # config:

  # Source function library.
  . /etc/rc.d/init.d/functions

  # Source networking configuration.
  . /etc/sysconfig/network

  # Check that networking is up.
  [ ${NETWORKING} = "no" ] &amp;&amp; exit 0

  # Set Tomcat environment.
  export JAVA_HOME=/usr/local/j2sdk
  export CLASSPATH=.:/usr/local/j2sdk/lib/tools.jar:/usr/local/j2re/lib/rt.jar
  export CATALINA_HOME=/usr/local/tomcat
  export CATALINA_OPTS="-server -Xms64m -Xmx512m -Dbuild.compiler.emacs=true"
  export PATH=/usr/local/j2sdk/bin:/usr/local/j2re/bin:$PATH

  [ -f /usr/local/tomcat/bin/startup.sh ] || exit 0
  [ -f /usr/local/tomcat/bin/shutdown.sh ] || exit 0

  export PATH=$PATH:/usr/bin:/usr/local/bin

  # See how we were called.
  case "$1" in
    start)
          # Start daemon.
          echo -n "Starting Tomcat: "
          /usr/local/tomcat/bin/startup.sh
          RETVAL=$?
          echo
          [ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/tomcat
          ;;
    stop)
          # Stop daemons.
          echo -n "Shutting down Tomcat: "
          /usr/local/tomcat/bin/shutdown.sh
          RETVAL=$?
          echo
          [ $RETVAL = 0 ] &amp;&amp; rm -f /var/lock/subsys/tomcat
          ;;
    restart)
          $0 stop
          $0 start
          ;;
    condrestart)
         [ -e /var/lock/subsys/tomcat ] &amp;&amp; $0 restart
         ;;
    status)
          status tomcat
          ;;
    *)
          echo "Usage: $0 {start|stop|restart|status}"
          exit 1
  esac

  exit 0
  
  </pre><p>
</p><p>
Set its ownership and access rights:
</p><pre class="programlisting">
  
  chown root:root /etc/rc.d/init.d/tomcat
  chmod 755 /etc/rc.d/init.d/tomcat
  
  </pre><p>
</p><p>
And add this init script to
<span class="application">chkconfig</span>:
</p><pre class="programlisting">
  
  chkconfig --add tomcat
  chkconfig tomcat on
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
Instead of creating your own init script,
you can use the script that comes with
the <span class="application">Tomcat</span> package:
<code class="filename">/usr/local/tomcat/bin/catalina.sh</code>.
Make sure you set
the <span class="application">Tomcat</span> environment
at the start of this script.
Or create a short init script that calls
the original <span class="application">Tomcat</span> init script.
</p><p>
See
<a class="ulink" href="http://www.jguru.com/faq/view.jsp?EID=425628" target="_top">How can I start Tomcat as a daemon in Linux?</a>.
</p></div><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
To install two (or even more) versions of
<span class="application">Tomcat</span> server
on the same system,
increase the <code class="systemitem">port</code> numbers
of the second server (e.g. by 10),
by editing the configuration file
<code class="filename">/usr/local/tomcat55/conf/server.xml</code>:
</p><pre class="programlisting">
  
  &lt;Server port="8015" shutdown="SHUTDOWN"&gt;
  ...
  &lt;!-- Define a non-SSL HTTP/1.1 Connector on port 8080 --&gt;
  &lt;Connector port="8090"
      maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
      enableLookups="false" redirectPort="8453" acceptCount="100"
      connectionTimeout="20000" disableUploadTimeout="true" /&gt;
  ...
  &lt;!-- Define a SSL HTTP/1.1 Connector on port 8443 --&gt;
  &lt;!--
  &lt;Connector port="8453"
      maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
      enableLookups="false" disableUploadTimeout="true"
      acceptCount="100" scheme="https" secure="true"
      clientAuth="false" sslProtocol="TLS" /&gt;
  --&gt;
  ...
  &lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;
  &lt;Connector port="8019"
      enableLookups="false" redirectPort="8453" protocol="AJP/1.3" /&gt;
  ...
  &lt;!-- Define a Proxied HTTP/1.1 Connector on port 8082 --&gt;
  &lt;!-- See proxy documentation for more information about using this. --&gt;
  &lt;!--
  &lt;Connector port="8082"
      maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
      enableLookups="false" acceptCount="100" connectionTimeout="20000"
      proxyPort="80" disableUploadTimeout="true" /&gt;
  --&gt;
  
  </pre><p>
</p><p>
Complete this second
<span class="application">Tomcat</span> server installation
as above for the first server,
using adjusted directory and file names.
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm433"></a>5. 
Replacing <span class="application">Tomcat</span>'s
default <acronym class="acronym">JSP</acronym> compiler
<span class="application">Jasper</span>
with <acronym class="acronym">IBM</acronym>'s
<span class="application">Jikes</span> compiler
</h2></div></div></div><p>
Since <acronym class="acronym">IBM</acronym>'s
<span class="application">Java</span> compiler
<span class="application">Jikes</span>
is performing better than
<span class="application">Tomcat</span>'s own
<acronym class="acronym">JSP</acronym> compiler
<span class="application">Jasper</span>,
it's recommended to install
<span class="application">Jikes</span> instead.
</p><p>
Download the sources of <span class="application">Jikes</span>
from <acronym class="acronym">IBM</acronym>'s Research website:
</p><pre class="screen">
  <a class="ulink" href="http://jikes.sourceforge.net/" target="_top">http://jikes.sourceforge.net/</a>
</pre><p>
</p><p>
Extract and compile <span class="application">Jikes</span>:
</p><pre class="programlisting">
  
  ./configure --prefix=/usr/local/jikes
  make
  make check
  make install
  
  </pre><p>
</p><p>
Check support for the <code class="option">-encoding</code> option:
</p><pre class="programlisting">
  
  /usr/local/jikes/bin/jikes -help
  
  </pre><p>
</p><p>
To have <span class="application">Jikes</span>
output its error messages in a
<span class="application">Jasper</span> compatible way,
add this <code class="envar">$CATALINA_OPTS</code> environment variable
to <code class="filename">/etc/rc.d/init.d/tomcat</code>:
</p><pre class="programlisting">
  
  export CATALINA_OPTS="-Dbuild.compiler.emacs=true"
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
If you get an error message saying
<span class="application">Jikes</span> can not use
<acronym class="acronym">UTF8</acronym> encoding,
add the following option as well:
</p><pre class="programlisting">
  
  -DjavaEncoding=ISO-8859-1
  
  </pre><p>
</p></div><p>
</p><p>
Make <span class="application">Jikes</span>
your <acronym class="acronym">JSP</acronym> compiler
for <span class="application">Tomcat</span>
by adding to
<code class="filename">/usr/local/tomcat/conf/web.xml</code>:
</p><pre class="programlisting">
  
  &lt;init-param&gt;
      &lt;param-name&gt;compiler&lt;/param-name&gt;
      &lt;param-value&gt;jikes&lt;/param-value&gt;
  &lt;/init-param&gt;
  
  </pre><p>
</p><p>
Since entering the full path to
<span class="application">Jikes</span>
in <code class="filename">/usr/local/tomcat/conf/web.xml</code>
doesn't seem to work (version 4.1.27),
make the <span class="command"><strong>jikes</strong></span> program available in your path:
</p><pre class="programlisting">
  
  ln -s /usr/local/jikes/bin/jikes /usr/local/bin/jikes
  
  </pre><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm482"></a>6. 
Installing <span class="application">ImageMagick</span>
</h2></div></div></div><p>
<span class="application">MMBase</span>
uses <span class="application">ImageMagick</span>'s
<span class="command"><strong>convert</strong></span> tool
to build and convert its images.
</p><p>
<span class="application">ImageMagick</span>
is already part of the
<code class="systemitem">Red Hat</code> distribution.
Check its availability using:
</p><pre class="programlisting">
  
  rpm -q ImageMagick
  
  </pre><p>
</p><p>
If <span class="application">ImageMagick</span>
is not available on your system,
install it
using <span class="application">up2date</span>:
</p><pre class="programlisting">
  
  up2date
  
  </pre><p>
</p><p>
or download it from the Red Hat Network:
</p><pre class="screen">
  <a class="ulink" href="https://rhn.redhat.com/" target="_top">https://rhn.redhat.com/</a>
</pre><p>
</p><p>
and install it by hand:
</p><pre class="programlisting">
  
  rpm -ihv ImageMagick-xxx.rpm
  
  </pre><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm502"></a>7. Installing <span class="application">MMBase</span></h2></div></div></div><p>
Download the binary distribution of
<span class="application">MMBase</span>,
and the additional applications you need
(i.e. <span class="application">CloudContext Security</span>,
<span class="application">Media</span>,
<span class="application">Email</span>)
(see the next section),
from:
</p><pre class="screen">
  <a class="ulink" href="http://www.mmbase.org" target="_top">http://www.mmbase.org/</a> --&gt; Download --&gt; Releases
</pre><p>
</p><p>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
<span class="application">MMBase</span> version 1.7.2
contained a nasty bug,
resulting in problems with the editwizards.
The 1.7.3 release includes a bugfix for this problem.
</p></div><p>
</p><p>
Make sure you pick out the right version for the
<span class="application">Java 2 <acronym class="acronym">JDK</acronym></span>
installed on your system.
You can find out the version currently installed by typing:
</p><pre class="programlisting">
  
  java -version
  
  </pre><p>
</p><p>
Extract the binary distribution of
<span class="application">MMBase</span>,
copy it into the
<span class="application">Tomcat</span> directory,
and change the ownership of the
<span class="application">MMBase</span> directory:
</p><pre class="programlisting">
  
  unzip mmbase-xxx.zip
  cd /usr/local/tomcat/webapps/
  mkdir mmbase-webapp/
  cp -R .../mmbase-x.x.x/mmbase-webapp/* ./mmbase-webapp/
  chown -R tomcat:tomcat ./mmbase-webapp/
  
  </pre><p>
</p><p>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
Installing <span class="application">MMBase</span> version 1.7
on <span class="application">Tomcat</span> version 5
resulted in version incompatibilities:
</p><pre class="programlisting">
  
  FATAL org.mmbase.servlet.MMBaseStartThread -
      Could not find the MMBase module!Class
      javax/servlet/http/HttpServletResponse violates loader constraints
  
  </pre><p>
</p><p>
We had to disable
the <code class="systemitem">RMMCI</code> library
to get this installation up and running:
</p><pre class="programlisting">
  
  mv /usr/local/tomcat/webapps/web-app/WEB-INF/lib/mmbase-rmmci.jar \
      /usr/local/tomcat/webapps/web-app/WEB-INF/lib/mmbase-rmmci.jar.org
  
  </pre><p>
</p></div><p>
</p><p>
For <span class="application">MMBase</span> version 1.7
running on <span class="application">Tomcat</span> version 5,
enable the <code class="systemitem">Xerces</code> libraries:
</p><pre class="programlisting">
  
  mv /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xalan.renametojar \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xalan.jar
  mv /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xerces.renametojar \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xerces.jar
  mv /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xml-apis.renametojar \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xml-apis.jar
  
  </pre><p>
Or you will have fatal errors like:
</p><pre class="programlisting">
  
  FATAL org.mmbase.servlet.MMBaseStartThread -
      Could not find the MMBase module!org/apache/xpath/XPathAPI
  
  </pre><p>
</p><p>
For <span class="application">MMBase</span> version 1.6
running on <span class="application">Tomcat</span> version 4,
replace the <span class="application">Tomcat</span>
<code class="systemitem">Xerces</code> libraries
by those coming with <span class="application">MMBase</span>:
</p><pre class="programlisting">
  
  mv -i /usr/local/tomcat/common/endorsed/xercesImpl.jar ~/
  mv -i /usr/local/tomcat/common/endorsed/xmlParserAPIs.jar ~/
  cp /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xalan.jar \
      /usr/local/tomcat/common/endorsed/
  chown tomcat:tomcat /usr/local/tomcat/common/endorsed/xalan.jar
  chmod 644 /usr/local/tomcat/common/endorsed/xalan.jar
  cp /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xerces.jar \
      /usr/local/tomcat/common/endorsed/
  chown tomcat:tomcat /usr/local/tomcat/common/endorsed/xerces.jar
  chmod 644 /usr/local/tomcat/common/endorsed/xerces.jar
  cp /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/xml-apis.jar \
      /usr/local/tomcat/common/endorsed/
  chown tomcat:tomcat /usr/local/tomcat/common/endorsed/xml-apis.jar
  chmod 644 /usr/local/tomcat/common/endorsed/xml-apis.jar
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
If you will not be using an
<span class="application">Apache</span>
<acronym class="acronym">JK 2</acronym> mapping or reverse proxy
(see further <a class="link" href="#JK2" title="12.  Connecting Apache and Tomcat using mod_jk2">below</a>)
as a front-end to your
<span class="application">MMBase</span> server,
you can add to the file
<code class="filename">/usr/local/tomcat/conf/server.xml</code>:
</p><pre class="programlisting">
  
  &lt;Context path="/mmbase" docBase="/usr/local/tomcat/webapps/mmbase-webapp" debug="0"&gt;
  &lt;!-- if you want symlinks to work: --&gt;
  &lt;Resources className="org.apache.naming.resources.FileDirContext" allowLinking="true" /&gt;
  &lt;/Context&gt;
  
  </pre><p>
</p><p>
This will allow you to access your
<span class="application">MMBase</span> server
using
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase
  
  </pre><p>
</p><p>
instead of:
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase-webapp
  
  </pre><p>
</p></div><p>
</p><p>
Check if the <span class="application">ImageMagick</span>
<span class="command"><strong>convert</strong></span> tool
is in your path:
</p><pre class="programlisting">
  
  which convert
  
  </pre><p>
</p><p>
If not, add it to
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/applications/Resources/builders/images.xml</code>.
For example:
</p><pre class="programlisting">
  
  &lt;property name="ImageConvert.ConverterCommand"&gt;/usr/bin/X11/convert&lt;/property&gt;
  
  </pre><p>
</p><p>
Make sure that the directory
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/builders/applications</code>
is writable by the servlet engine user
(for auto-installing builders):
</p><pre class="programlisting">
  
  chown tomcat:tomcat /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/builders/applications
  chmod 775 /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/builders/applications
  
  </pre><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm572"></a>8. 
Connecting <span class="application">MMBase</span>
to <span class="application">MySQL</span>
using <code class="systemitem">MySQL Connector/J</code>
</h2></div></div></div><p>
We can connect
<span class="application">MMBase</span>
to our <span class="application">MySQL</span> database server
using <code class="systemitem">MySQL Connector/J</code>.
This <acronym class="acronym">JDBC</acronym> driver
for <span class="application">MySQL</span>
can be downloaded from:
</p><pre class="screen">
  <a class="ulink" href="http://www.mysql.com/downloads/api-jdbc.html" target="_top">http://www.mysql.com/downloads/api-jdbc.html</a>
</pre><p>
</p><p>
Copy the <acronym class="acronym">JDBC</acronym> driver
to the <span class="application">MMBase</span>
<code class="filename">lib/</code> directory:
</p><pre class="programlisting">
  
  cp mysql-connector-java-xxx-bin.jar /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/
  chown tomcat:tomcat /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/mysql-connector-java-xxx-bin.jar
  chmod 664 /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/mysql-connector-java-xxx-bin.jar
  
  </pre><p>
</p><p>
Make this your <acronym class="acronym">JDBC</acronym> driver
for <span class="application">MMBase</span>
by editing
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/jdbc.xml</code>.
Substitute the database name
(<em class="replaceable"><code>mmbase</code></em>),
user (<em class="replaceable"><code>mmuser</code></em>)
and password (<em class="replaceable"><code>mmpass</code></em>)
with the database settings you'd like
<span class="application">MMBase</span> to use.
</p><pre class="programlisting">
  
  &lt;property name="url"&gt;jdbc:mysql://$HOST:$PORT/$DBM&lt;/property&gt;
  &lt;property name="user"&gt;mmuser&lt;/property&gt;
  &lt;property name="password"&gt;mmpass&lt;/property&gt;
  &lt;property name="supportclass"&gt;org.mmbase.module.database.DatabaseSupportShim&lt;/property&gt;
  &lt;property name="database"&gt;mmbase&lt;/property&gt;
  &lt;property name="connections"&gt;20&lt;/property&gt;
  &lt;property name="host"&gt;localhost&lt;/property&gt;
  &lt;property name="driver"&gt;com.mysql.jdbc.Driver&lt;/property&gt;
  &lt;property name="port"&gt;3306&lt;/property&gt;
  &lt;property name="querys"&gt;256&lt;/property&gt;
  &lt;property name="probetime"&gt;30&lt;/property&gt;
  
  </pre><p>
</p><p>
Set the ownership and access rights of this configuration file.
Since it contains your database name, user name and password,
make sure other users can not read this file.
</p><pre class="programlisting">
  
  chown tomcat:tomcat /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/jdbc.xml
  chmod 640 /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/jdbc.xml
  
  </pre><p>
</p><p>
Now create the <span class="application">MySQL</span> database
you've just defined for
<span class="application">MMBase</span>:
</p><pre class="programlisting">
  
  mysql -u root -p
  
  </pre><p>
</p><p>
</p><pre class="programlisting">
  
  CREATE DATABASE &lt;mmbase&gt;;
  USE &lt;mmbase&gt;;
  GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP ON &lt;mmbase&gt;.* TO
      &lt;mmuser&gt;@'%' IDENTIFIED BY '&lt;password&gt;';
  GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP ON &lt;mmbase&gt;.* TO
      &lt;mmuser&gt;@localhost IDENTIFIED BY '&lt;password&gt;';
  GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP ON &lt;mmbase&gt;.* TO
      &lt;mmuser&gt;@localhost.&lt;domainname&gt; IDENTIFIED BY '&lt;password&gt;';
    # RH bug fix
  GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP ON &lt;mmbase&gt;.* TO
      &lt;mmuser&gt;@&lt;hostname&gt; IDENTIFIED BY '&lt;password&gt;';
  flush privileges;
  exit;
  
  </pre><p>
</p><p>
Substitute the hostname (<em class="replaceable"><code>&lt;hostname&gt;</code></em>)
and domain name (<em class="replaceable"><code>&lt;domainname&gt;</code></em>)
with your own hostname and domain name,
and the database name (<em class="replaceable"><code>&lt;mmbase&gt;</code></em>),
user (<em class="replaceable"><code>&lt;mmuser&gt;</code></em>)
and password (<em class="replaceable"><code>&lt;password&gt;</code></em>)
with the values you just entered in the JDBC driver configuration file.
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
To quickly empty
your <span class="application">MySQL</span> database,
i.e. after you've updated
your <span class="application">MMBase</span> configuration or
application
(replace the database name <em class="replaceable"><code>&lt;mmbase&gt;</code></em> with your
own):
</p><pre class="programlisting">
  
  mysqladmin -u root -p drop &lt;mmbase&gt;
  mysqladmin -u root -p create &lt;mmbase&gt;
  
  </pre><p>
</p></div><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
If you are already using quite some
<span class="application">MySQL</span> connections
(for example for authentication by and as a back-end to your mail daemons
and <span class="application">Apache</span> servers),
the <span class="application">MySQL</span> server
might run out of connections (its maximum number defaults to 100).
Then <span class="application">Tomcat</span>
could simply refuse to start or give an error message
when initiating the
<span class="application">MySQL</span> connection pool,
or your <span class="application">IMAP</span>
or <span class="application">POP</span> servers will have
problems authenticating their clients.
</p><p>
You can increase the maximum number of connections
to <span class="application">MySQL</span>
by adding to the configuration file
<code class="filename">/etc/my.cnf</code>:
</p><pre class="programlisting">
  
  [mysqld]
  set-variable = max_connections=200
  
  </pre><p>
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm634"></a>9. 
Installing <span class="application">MMBase</span>
additional applications
</h2></div></div></div><p>
With the release of version 1.7
<span class="application">MMBase</span>
was reworked into a more modular structure.
The developers decided to take several modules
(i.e. <span class="application">CloudContext Security</span>,
<span class="application">Media</span>,
<span class="application">Email</span>)
from the <span class="application">MMBase</span> tree,
and make these available as separate entities.
However, at this moment
<span class="application">MMBase</span>
doesn't have a module interface at all.
So, to use these additional applications,
the library and other files need to be placed into the installation tree
and the configuration needs to be added into the existing configuration files
by hand.
</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm644"></a>9.1. 
Installing
the <span class="application">CloudContext Security</span> module
</h3></div></div></div><p>
&gt;From the <span class="application">MMBase</span> website
(<a class="ulink" href="http://www.mmbase.org" target="_top">www.mmbase.org</a>):
</p><div class="blockquote"><blockquote class="blockquote"><p>
<span class="quote">&#8220;<span class="quote"><span class="application">Cloud security</span>
uses the object <code class="systemitem">mmbaseuser</code>
to store information used for authorisation and authentication of users.
The two main advantages of this security implementation are
that the user administration can be carried out by using a webbrowser
(instead of editing a file on the filesystem) and
that the users of your
<span class="application">MMBase</span> installation
are available as objects in the cloud.
For instance, it is possible to create groups of users,
which are allowed to carry out certain tasks.</span>&#8221;</span>
</p><p>
<span class="quote">&#8220;<span class="quote">A context exists of a set of rights
which describe what you can do within this context
with an object of
<span class="application">MMBase</span>.
For example you define read access to a the context
which is used by anonymous visitors of your site and
you can define a context with edit rights for registered users of your site.
</span>&#8221;</span>
</p></blockquote></div><p>
</p><p>
Move the library and other files of
the <span class="application">CloudContext Security</span> module
into the <span class="application">MMBase</span> installation tree:
</p><pre class="programlisting">
  
  mv -i web-app/WEB-INF/lib/* \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/
  mv -i web-app/WEB-INF/config/applications/* \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/applications/
  mv -i web-app/WEB-INF/config/builders/* \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/builders/
  
  </pre><p>
</p><p>
Save the documentation files for later reference:
</p><pre class="programlisting">
  
  mv -i web-app/README.txt web-app/README-PACKAGE.txt web-app/documentation web-app/src \
      /usr/local/tomcat/webapps/mmbase-webapp/mmdocs/security/
  
  </pre><p>
</p><p>
Make sure all these new files are owned by
your <code class="systemitem">tomcat</code> user as well:
</p><pre class="programlisting">
  
  chown -R tomcat:tomcat /usr/local/tomcat/webapps/mmbase-webapp
  
  </pre><p>
</p><p>
Disable the existing configuration
in the security configuration file
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/security/security.xml</code>:
</p><pre class="programlisting">
  
  &lt;!--
  &lt;authentication class="org.mmbase.security.implementation.context.ContextAuthentication" url="context/config.xml" /&gt;
  --&gt;
  ...
  &lt;!--
  &lt;authorization class="org.mmbase.security.implementation.context.ContextAuthorization" url="context/config.xml" /&gt;
  --&gt;
  
  </pre><p>
</p><p>
And add
(from <code class="filename">web-app/WEB-INF/config/security/security.xml</code>):
</p><pre class="programlisting">
  
  &lt;!--
  Example security.xml to switch on Cloud Context Security.
  No other configuration needed
  (Cloud Context Security is configured in the cloud)
  @version $Id$
  --&gt;
  &lt;authentication class="org.mmbase.security.implementation.cloudcontext.Authenticate" url="" /&gt;
  &lt;authorization  class="org.mmbase.security.implementation.cloudcontext.Verify"       url="" /&gt;
  
  </pre><p>
</p><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Make sure to include the configuration above before
the <code class="classname">&lt;sharedsecret&gt;</code> statement,
or you will get an error like this:
</p><pre class="programlisting">
  
  ERROR org.mmbase.util.XMLErrorHandler - security.xml line:71 column:12:
      The content of element type "security" must match "(authentication,authorization,sharedsecret)".
  
  </pre><p>
</p></div><p>
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm679"></a>9.2. 
Installing
the <span class="application">Media</span> module
</h3></div></div></div><p>
&lt;TODO&gt;
</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idm683"></a>9.3. 
Installing
the <span class="application">Email</span> module
</h3></div></div></div><p>
The <span class="application">Email</span> module
makes it possible to send email
with <span class="application">MMBase</span>,
using either <code class="systemitem">SendMail</code>
or <code class="systemitem">JMSendMail</code>.
</p><p>
Move the library and other files of
the <span class="application">Email</span> module
into the <span class="application">MMBase</span> installation tree:
</p><pre class="programlisting">
  
  mv -i web-app/WEB-INF/lib/* \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/lib/
  mv -i web-app/WEB-INF/config/builders/* \
      /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/builders/
  mkdir /usr/local/tomcat/webapps/mmbase-webapp/email-examples/
  cp -iR web-app/examples/* \
      /usr/local/tomcat/webapps/mmbase-webapp/email-examples/
  
  </pre><p>
</p><p>
Save the documentation files for later reference:
</p><pre class="programlisting">
  
  mkdir /usr/local/tomcat/webapps/mmbase-webapp/mmdocs/email/
  mv -i web-app/README.txt web-app/README-PACKAGE.txt web-app/documentation web-app/src \
      /usr/local/tomcat/webapps/mmbase-webapp/mmdocs/email/
  
  </pre><p>
</p><p>
Make sure all these new files are owned by
your <code class="systemitem">tomcat</code> user as well:
</p><pre class="programlisting">
  
  chown -R tomcat:tomcat /usr/local/tomcat/webapps/mmbase-webapp
  
  </pre><p>
</p><p>
Edit the email configuration file
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/sendmail.xml</code>
(from <code class="filename">web-app/WEB-INF/config/modules/sendmail.xml</code>):
</p><pre class="programlisting">
  
  ...
  &lt;status&gt;active&lt;/status&gt;
  ...
  &lt;classfile&gt;org.mmbase.applications.email.SendMail&lt;/classfile&gt;
  ...
  
  </pre><p>
</p><p>
Add to <span class="application">Tomcat</span>'s
root <code class="classname">Context</code>
(in /usr/local/tomcat/conf/context.xml for Tomcat version 5,
in /usr/local/tomcat/conf/server.xml for Tomcat version 4)
(replace &lt;smtp.domain.tld&gt; with the adres of your
<code class="systemitem"><acronym class="acronym">SMTP</acronym> server</code>):
</p><pre class="programlisting">
  
  Resource name="mail/Session" auth="Container"
           type="javax.mail.Session"/&gt;
    &lt;ResourceParams name="mail/Session"&gt;
      &lt;parameter&gt;
        &lt;name&gt;mail.smtp.host&lt;/name&gt;
        &lt;value&gt;smtp.domain.tld&lt;/value&gt;
      &lt;/parameter&gt;
    &lt;/ResourceParams&gt;
    &lt;ResourceLink name="linkToGlobalResource"
                  global="simpleValue"
                  type="java.lang.Integer"/&gt;
  
  </pre><p>
</p><p>
Failing to do this, results in a fatal error:
</p><pre class="programlisting">
  
  FATAL org.mmbase.module.JMSendMail -
      JMSendMail failure: Name mail is not bound in this Context
  
  </pre><p>
</p><p>
</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
Installing the <span class="application">Email</span> module
in <span class="application">MMBase</span> version 1.7
running on <span class="application">Tomcat</span> version 5
resulted in a fatal error:
</p><pre class="programlisting">
  
  FATAL org.mmbase.servlet.MMBaseStartThread -
  Could not find the MMBase module!javax/mail/Session
  
  </pre><p>
</p></div><p>
</p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm719"></a>10. 
Configuring initial
<span class="application">MMBase</span> settings
</h2></div></div></div><p>
Here are some initial configuration settings
for <span class="application">MMBase</span>.
</p><p>
Change the default password
<code class="systemitem">admin2k</code>
for the administrator <code class="systemitem">admin</code>
by editing
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/security/context/config.xml</code>:
</p><pre class="programlisting">
  
  &lt;user name="admin" context="admin"&gt;
      &lt;identify type="name/password" rank="administrator"&gt;admin2k&lt;/identify&gt;
  &lt;/user&gt;
  
  </pre><p>
</p><p>
Also, outcomment or remove the user
<code class="systemitem">foo/bar</code>.
</p><p>
Since this file contains your administrators password,
make sure other users can not read it:
</p><pre class="programlisting">
  
  chmod 640 /usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/security/context/config.xml
  
  </pre><p>
</p><p>
To use the <span class="application">MMBase</span>
builder <code class="systemitem">mmbaseuser</code>
(using the <span class="database">mmbaseuser</span> table
in your <span class="application">MySQL</span> database)
for user authentication,
set the <code class="classname">authentication</code> class
in the configuration file
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/security/security.xml</code>
to:
</p><pre class="programlisting">
  
  &lt;authentication class="org.mmbase.security.implementation.cloud.Authenticate" url="" /&gt;
  
  </pre><p>
</p><p>
and set the <code class="classname">authorization</code> class to:
</p><pre class="programlisting">
  
  &lt;authorization class="org.mmbase.security.implementation.cloud.Verify" url="" /&gt;
  
  </pre><p>
</p><p>
In the same file change the shared secret used to communicate with remote
builders
(on other <span class="application">MMBase</span> servers):
</p><pre class="programlisting">
  
  &lt;sharedsecret&gt;yoursharedsecret&lt;/sharedsecret&gt;
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
You can set the language
for <span class="application">MMBase</span>
by editing
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/mmbaseroot.xml</code>:
</p><pre class="programlisting">
  
  &lt;property name="language"&gt;en&lt;/property&gt;
  
  </pre><p>
</p></div><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
You can set the <acronym class="acronym">SMTP</acronym> gateway by editing
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/modules/sendmail.xml</code>:
</p><pre class="programlisting">
  
  &lt;property name="mailhost"&gt;localhost&lt;/property&gt;
  
  </pre><p>
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm759"></a>11. Running <span class="application">MMBase</span></h2></div></div></div><p>
Now you are ready to start <span class="application">Tomcat</span>:
</p><pre class="programlisting">
  
  service tomcat start
  
  </pre><p>
</p><p>
and access your new <span class="application">MMBase</span> server
through
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase-webapp/
  
  </pre><p>
</p><p>
If everything you just did worked out,
you should get the
<span class="application">MMBase</span> welcome screen
where you can change the settings, look at the demos, and install the
samples.
</p><div class="screenshot"><div><img src="MMBase-600x415.png"></div></div><p>
</p><p>
When asked for a login use the name
<code class="systemitem">admin</code>
and the password
you just set in the security configuration file
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/security/context/config.xml</code>.
</p><p>
<span class="application">MMBase</span> users
(i.e. front-end developers) will typically add their web files to
the <code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/</code> directory.
Applications (defining the content) will be placed in
the
<code class="filename">/usr/local/tomcat/webapps/mmbase-webapp/WEB-INF/config/applications/</code>
directory.
</p><p>
</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>
<span class="application">Tomcat</span>
consumes far more <acronym class="acronym">CPU</acronym> and memory resources
than <span class="application">Apache</span>.
Make sure the dimensions of your
<span class="application">Tomcat</span>/<span class="application">MMBase</span> server system meet these requirements.
</p></div><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
Shutting down (or restarting) the
<span class="application">Tomcat</span> server (version 1.6)
in our case always left a last process running.
If you experience this same problem,
kill the process by hand before starting it up again:
</p><pre class="programlisting">
  
  [root@hostname root]# service tomcat stop
  [root@hostname root]# ps -ax |grep j2
  24535 ?        S      4:12 /usr/local/j2sdk/bin/java -server -Xms64m -Xmx512m-Dbuild.compiler.emacs=true ...
  [root@hostname root]# kill 24535
  [root@hostname root]# service tomcat start
  [root@hostname root]# 
  
  </pre><p>
</p></div><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
You can save the original <code class="filename">index.jsp</code> file
by renaming it to <code class="filename">mmbase.jsp</code>:
</p><pre class="programlisting">
  
  mv -i /usr/local/tomcat/webapps/mmbase-webapp/index.jsp \
      /usr/local/tomcat/webapps/mmbase-webapp/mmbase.jsp
  
  </pre><p>
</p><p>
This will allow you to always access the original MMBase home page through
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase-webapp/mmbase.jsp
  
  </pre><p>
</p></div><p>
</p><p>
In case of any problems,
check the <span class="application">Tomcat</span>
and <span class="application">MMBase</span> log files
in the directory
<code class="filename">/usr/local/tomcat/logs/</code>
for hints.
</p><p>
&gt;From here, we refer to the documentation
on the <span class="application">MMbase</span> website
to complete your configuration
and start using <span class="application">MMBase</span>:
</p><pre class="screen">
  <a class="ulink" href="http://www.mmbase.org/docs/" target="_top">http://www.mmbase.org/docs/</a>
</pre><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="JK2"></a>12. 
Connecting <span class="application">Apache</span>
and <span class="application">Tomcat</span>
using <code class="systemitem">mod_jk2</code>
</h2></div></div></div><p>
Since (for some odd reason) some network managers allow outgoing web
connections only to <code class="systemitem">TCP port 80</code>,
there might be people around that cannot access your
<span class="application">Tomcat</span>
(and <span class="application">MMBase</span>) server
through <code class="systemitem">port 8080</code>.
You can install a <acronym class="acronym">JK 2</acronym> mapping or a reverse proxy
in <span class="application">Apache</span>,
so <span class="application">Tomcat</span>
and <span class="application">MMBase</span>
can be accessed through the
<span class="application">Apache</span> web server
at <code class="systemitem">port 80</code>.
Apart from the port issue,
this has the advantage that you can use
<span class="application">Apache</span>
to manage you <acronym class="acronym">SSL</acronym> connections
and use your existing
<span class="application">Apache</span>
logs and statistics facilities
for <span class="application">Tomcat</span>
and <span class="application">MMBase</span> as well.
</p><p>
Here we describe the installation and configuration of
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
connecting <span class="application">Apache</span>
and <span class="application">Tomcat</span>.
In this way,
<span class="application">Tomcat</span> paths can be mapped
into <span class="application">Apache</span>.
</p><p>
&gt;From the
<code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
website
(<a class="ulink" href="http://jakarta.apache.org/tomcat/tomcat-4.1-doc/config/jk2.html" target="_top">http://jakarta.apache.org/tomcat/tomcat-4.1-doc/config/jk2.html</a>):
</p><div class="blockquote"><blockquote class="blockquote"><p>
<span class="quote">&#8220;<span class="quote">
The <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
element represents
a <code class="classname">Connector</code> component that communicates
with a web connector via the <acronym class="acronym">AJP</acronym> protocol.
This is used for cases where you wish
to invisibly integrate <span class="application">Tomcat</span> 4
into an existing (or new)
<span class="application">Apache</span> installation,
and you want <span class="application">Apache</span> to handle
the static content contained in the web application,
and/or utilize <span class="application">Apache's</span>
<acronym class="acronym">SSL</acronym> processing.
In many application environments,
this will result in better overall performance
than running your applications
under <span class="application">Tomcat</span> stand-alone
using the
<code class="systemitem"><acronym class="acronym">HTTP/1.1</acronym> Connector</code>.
However, the only way to know for sure
whether it will provide better performance for your application
is to try it both ways.
</span>&#8221;</span>
</p></blockquote></div><p>
</p><p>
If you will only be needing a simple configuration--
typically a single <span class="application">Tomcat</span> server
sitting on the same system as
your <span class="application">Apache server</span>--
<span class="application">Apache</span> reverse proxies might be
an easier solution for you.
Although these are simpler in terms of the interconnection features,
reverse proxies provide more flexibility
in fiddling with your paths and other options.
The configuration of
<span class="application">Apache</span> reverse proxies is
described in the next section.
</p><p>
However, if you plan to build or grow to
a farm of several <span class="application">Tomcat</span> servers
behind an <span class="application">Apache</span> front-end
or build a high-performance system,
deploying
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
is the way to go.
</p><p>
Download the sources of
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
from the <span class="application">Apache Jakarta</span> website:
</p><pre class="screen">
  <a class="ulink" href="http://jakarta.apache.org/site/sourceindex.cgi" target="_top">http://jakarta.apache.org/site/sourceindex.cgi</a>
  </pre><p>
</p><p>
Extract and compile
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>:
</p><pre class="programlisting">
  
  tar -zxvf jakarta-tomcat-connectors-jk2-src-xxx.tar.gz
  cd jakarta-tomcat-connectors-jk2-src/jk/native2/
  ./configure \
    --with-apxs2=/usr/local/apache/bin/apxs
  make
  
  </pre><p>
</p><p>
Make sure your <code class="envar">$JAVA_HOME</code> environment variable is set
and the <span class="application">Java</span> binaries are
in your <code class="envar">$PATH</code>
or add this option to your <span class="command"><strong>./configure</strong></span> command:
</p><pre class="programlisting">
  <code class="option">--with-java-home=/usr/local/j2sdk</code>
  </pre><p>
</p><p>
Copy the module files <code class="filename">mod_jk2.so</code> and
<code class="filename">jkjni.so</code>
to the <code class="filename">modules/</code> directory
of <span class="application">Apache</span>:
</p><pre class="programlisting">
  
  cp -i ../build/jk2/apache2/*.so /usr/local/apache/modules/
  chmod 755 /usr/local/apache/modules/mod_jk2.so
  chown root:root /usr/local/apache/modules/mod_jk2.so
  chmod 755 /usr/local/apache/modules/jkjni.so
  chown root:root /usr/local/apache/modules/jkjni.so
  libtool --finish /usr/local/apache/modules
  
  </pre><p>
</p><p>
Copy the sample configuration file
<code class="filename">workers2.properties</code>
to the configuration directory
of <span class="application">Apache</span>:
</p><pre class="programlisting">
  

  cp -i ../../jk/conf/workers2.properties /usr/local/apache/conf/
  chown root:root /usr/local/apache/conf/workers2.properties
  chmod 644 /usr/local/apache/conf/workers2.properties
  
  </pre><p>
</p><p>
and adjust it to your own needs.
</p><p>
Here is a simple configuration that should get you up and running:
</p><pre class="programlisting">
  
  [logger]
  # outcomment this in production use
  level=DEBUG
  
  [config:]
  file=${serverRoot}/conf/workers2.properties
  debug=0
  debugEnv=0
  
  [uriMap:]
  info=Maps the requests. Options: debug
  debug=1
  
  [shm:]
  info=Scoreboard. Required for reconfiguration and status with multiprocess servers
  file=${serverRoot}/logs/jk2.shm
  size=1000000
  debug=0
  disabled=0
  
  [workerEnv:]
  info=Global server options
  timing=1
  debug=0
  
  [status:]
  info=Status worker, displays runtime informations
  
  [uri:&lt;hostname&gt;/jkstatus/*]
  info=Display status information and checks the config file for changes.
  group=status:
  
  [channel.socket:localhost:8009]
  info=Ajp13 forwarding over socket
  
  # Define the worker
  [ajp13:localhost:8009]
  channel=channel.socket:localhost:8009
  
  [uri:&lt;hostname&gt;/mmbase-webapp/*]
  info=MMBase
  
  </pre><p>
</p><p>
Most of this configuration is pretty standard.
The last <code class="classname">uri</code> declaration
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname)
is what this is all about;
it maps all client requests starting with
<code class="filename">/mmbase-webapp/</code>
from <span class="application">Apache</span>
to your <span class="application">Tomcat</span> server.
</p><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
When we made a virtual host mapping,
somehow the general mappings no longer worked for this virtual host
(other virtual hosts on the same
<code class="systemitem">IP address</code> had no problem at all).
We had to explicitly add the general mappings for this virtual host
to make these work again.
A bug?
Or a consequence of the way
<span class="application">Apache</span>
implements name based virtual hosts?
</p></div><p>
</p><p>
So now, the same application you accessed
through <span class="application">Tomcat</span> as
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase-webapp/
  
  </pre><p>
</p><p>
will be available through
<span class="application">Apache</span> as:
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;/mmbase-webapp/
  
  </pre><p>
</p><p>
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
Only name based virtual hosts are supported this way.
Make sure you add the virtual host name
(pointing to this very same (web) server)
to the <code class="filename">/etc/hosts</code> file
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  192.168.3.17 &lt;hostname&gt;
  
  </pre><p>
</p><p>
or things will not work
(running <acronym class="acronym">DNS</acronym> is not sufficient here!).
</p></div><p>
</p><p>
If your <span class="application">Apache</span> installation
is serving only a single website,
you can leave out the hostname:
</p><pre class="programlisting">
  
  [uri:/mmbase-webapp/*]
  info=MMBase
  
  </pre><p>
</p><p>
which will serve the
mapped <code class="filename">/mmbase-webapp/</code> directory
on every address and site
of your <span class="application">Apache</span> installation.
</p><p>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
Using
<code class="systemitem"><acronym class="acronym">JK</acronym> Connector</code>
version 2,
all configuration settings will be in the
<code class="filename">workers2.properties</code> file.
Even though <span class="application">Tomcat</span>
comes with its own
<acronym class="acronym">JK 2</acronym> configuration file
<code class="filename">/usr/local/tomcat/conf/jk2.properties</code>,
there's no need to edit this
as long as you stick with the standard
<code class="systemitem">port 8009</code>.
</p><p>
If you do have to edit this file
(for example when changing the port),
make sure that you do it
when your <span class="application">Tomcat</span> server
is not running;
the file is auto-edited
by <span class="application">Tomcat</span> itself.
</p></div><p>
</p><p>
After adding the <code class="systemitem">mod_jk2</code> module
to your <span class="application">Apache</span> configuration
(in the file
<code class="filename">/etc/httpd/conf/httpd.conf</code>
or in a new file <code class="filename">jk2.conf</code>
in the <span class="application">Apache</span>
configuration directory
<code class="filename">/etc/httpd/conf.d</code>):
</p><pre class="programlisting">
  
  # Load mod_jk2 module
  LoadModule jk2_module modules/mod_jk2.so
  
  </pre><p>
</p><p>
</p><pre class="programlisting">
  
  chown root:root /etc/httpd/conf.d/jk2.conf
  chmod 644 /etc/httpd/conf.d/jk2.conf
  
  </pre><p>
</p><p>
you can now restart <span class="application">Apache</span>
and give your new entrance a try:
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;/mmbase-webapp/
  
  </pre><p>
</p><p>
To check the status of
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;/jkstatus/
  
  </pre><p>
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
You can reread the configuration in
<code class="filename">/usr/local/apache/conf/workers2.properties</code>
by (re)loading the <span class="guimenu">JK Status</span> page.
This allows you to add new mappings
without restarting <span class="application">Apache</span>
or having it reload its configuration.
However, existing mappings can not be removed this way
and require <span class="application">Apache</span> to reconfigure.
</p><p>
Although it's also possible to place the <acronym class="acronym">JK 2</acronym> configurations
(in a slightly different form)
in your <span class="application">Apache</span> configuration file,
this is a good reason to stick with the
<code class="filename">workers2.properties</code> setup.
</p></div><p>
</p><p>
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
To protect access to the <span class="guimenu">JK Status</span> page,
add an authentication declaration
to the <span class="application">Apache</span> configuration.
For example:
</p><pre class="programlisting">
  
  &lt;Location /jkstatus/&gt;
  AuthType Basic
  AuthName "JK 2 Connector Status"
  AuthUserFile /etc/httpd/conf/users
  AuthGroupFile /etc/httpd/conf/groups
  Require group admin
  &lt;/Location&gt;
  
  </pre><p>
</p><p>
This will prompt for a login from a user
from the <code class="systemitem">admin</code> group.
</p></div><p>
</p><p>
In case of any problems,
check
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
log messages
that will be written to your <span class="application">Apache</span>
<code class="filename">error_log</code>.
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
In case the
<code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
has difficulties connecting to
<span class="application">Tomcat</span>,
check whether <span class="application">Tomcat</span> is indeed
available on
<code class="systemitem">port 8009</code>:
</p><pre class="programlisting">
  
  netstat -tln
  
  </pre><p>
</p></div><p>
</p><p>
Access requests mapping to <span class="application">Tomcat</span>
will be logged in the <code class="filename">access_log</code>'s
and <code class="filename">error_log</code>'s
of <span class="application">Apache</span>.
</p><p>
For more information on the
<code class="filename">workers2.properties</code> configuration,
check the documentation at:
</p><pre class="programlisting">
  <a class="ulink" href="http://jakarta.apache.org/tomcat/tomcat-4.1-doc/jk2/jk2/configwebcom.html" target="_top">http://jakarta.apache.org/tomcat/tomcat-4.1-doc/jk2/jk2/configwebcom.html</a>
  </pre><p>
</p><p>
There you will read about
setting up more (remote)
<span class="application">Tomcat</span> workers,
grouping these together in load-balancing pools,
setting up <acronym class="acronym">RPC</acronym> channels,
using <code class="systemitem">Unix</code> sockets,
using the
<code class="systemitem">Java Native Interface (<acronym class="acronym">JNI</acronym></code>)
to interconnect with
<span class="application">Tomcat</span> directly (in-process),
setting up alternative loggers, 
and optimizing your time-outs.
</p><p>
</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
<span class="application">Apache</span> is far more efficient
than <span class="application">Tomcat</span>
in serving ordinary content files.
You could have both the <span class="application">Apache</span>
and <span class="application">Tomcat</span> document directories
point to the same directory on your filesystem
and only forward requests for <acronym class="acronym">JSP</acronym> pages
and <code class="systemitem">Java Servlets</code>.
For example (in <code class="filename">workers2.conf</code>):
</p><pre class="programlisting">
  
  #[uri:/examples/servlet/*]
  #info=Prefix mapping

  #[uri:/examples/*.jsp]
  #info=Extension mapping
  
  </pre><p>
</p><p>
However, now you need to protect
<span class="application">Tomcat's</span>
<code class="filename">WEB-INF/</code> directories
(and other directories and files you don't want visitors to have access to)
from being served by <span class="application">Apache</span>.
For example (in <span class="application">Apache</span>'s
<code class="filename">httpd.conf</code>):
</p><pre class="programlisting">
  
  &lt;Location "/examples/WEB-INF/"&gt;
  AllowOverride None
  deny from all
  &lt;Location&gt;
  
  </pre><p>
</p><p>
Also, realize that a setup like this bypasses
any security constraints you may have configured
in the file
<code class="filename">/usr/local/tomcat/webapps/examples/WEB-INF/web.xml</code>.
</p></div><p>
</p><p>
You can find more general information about
the <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
at:
</p><pre class="screen">
  <a class="ulink" href="http://jakarta.apache.org/tomcat/tomcat-4.1-doc/jk2/" target="_top">http://jakarta.apache.org/tomcat/tomcat-4.1-doc/jk2/</a>
  </pre><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1037"></a>13. 
Installing an <span class="application">Apache</span>
reverse proxy
as a front-end
to your <span class="application">MMBase</span> server
</h2></div></div></div><p>
Installing an <span class="application">Apache</span> reverse proxy
is an easy alternative to the
<code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code>
to use <span class="application">Apache</span> as a front-end
to your <span class="application">Tomcat</span> server.
</p><p>
Add to your <span class="application">Apache</span>
(virtual) server configuration
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  ProxyPass /tomcat/ http://&lt;hostname&gt;:8080/
  ProxyPassReverse /tomcat/ http://&lt;hostname&gt;:8080/
  ProxyPass /mmbase/ http://&lt;hostname&gt;:8080/mmbase-webapp/
  ProxyPassReverse /mmbase/ http://&lt;hostname&gt;:8080/mmbase-webapp/
  
  </pre><p>
</p><p>
This allows you to access your
<span class="application">Tomcat</span> server
as
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;/tomcat/
  
  </pre><p>
</p><p>
and your <span class="application">MMBase</span> server as
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;/mmbase/
  
  </pre><p>
</p><p>
</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Caution</h3><p>
Our MMBase version 1.7 installation used
absolute directory paths in the web pages it generated.
In order to get the reverse proxies to work properly,
the Apache proxy paths had to be the same
(replace <em class="replaceable"><code>&lt;hostname&gt;</code></em> with your hostname):
</p><pre class="programlisting">
  
  ProxyPass /mmbase-webapp/ http://&lt;hostname&gt;:8080/mmbase-webapp/
  ProxyPassReverse /mmbase-webapp/ http://&lt;hostname&gt;:8080/mmbase-webapp/
  
  </pre><p>
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1064"></a>14. 
Installing more <span class="application">MMBase</span> servers
on a single <span class="application">Tomcat</span> server
</h2></div></div></div><p>
If you want to support
more instances of <span class="application">MMBase</span>,
for example if you would like
to make <span class="application">MMBase</span>
available to more or all of your users,
you can create several
<span class="application">MMBase</span> installations
and have these all run on the same
<span class="application">Tomcat</span> server.
</p><p>
Install <span class="application">MMBase</span>
in the home directory
of the user <em class="replaceable"><code>&lt;user&gt;</code></em>
performing all steps before:
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
create a directory <code class="filename">mmbase/</code>
in the users home directory,
</p></li><li class="listitem"><p>
copy all <span class="application">MMBase</span> files
into the directory
<code class="filename">/home/<em class="replaceable"><code>&lt;user&gt;</code></em>/mmbase/</code>,
</p></li><li class="listitem"><p>
build the directory structure and configuration files
in the very same way we did before,
</p></li><li class="listitem"><p>
for <span class="application">MMBase</span> version 1.7
running on <span class="application">Tomcat</span> version 5,
enable the <code class="systemitem">Xerces</code> libraries,
</p></li><li class="listitem"><p>
for <span class="application">MMBase</span> version 1.6
running on <span class="application">Tomcat</span> version 4,
remove the <code class="systemitem">Xerces</code> libraries
in <span class="application">MMBase</span>
(after you have copied these
from <span class="application">MMBase</span>
to <span class="application">Tomcat</span>
the first time),
</p></li><li class="listitem"><p>
install the <span class="application">MySQL</span>
<acronym class="acronym">JDBC</acronym> driver
and create a new <span class="application">MySQL</span> database
for this user.
</p></li></ul></div><p>
</p><p>
Make sure both the user
and the <span class="application">Tomcat</span> server
have access to the
<span class="application">MMBase</span> installation:
</p><pre class="programlisting">
  
  chown -R &lt;user&gt;:tomcat /home/&lt;user&gt;/mmbase/
  
  </pre><p>
</p><p>
Make sure that the directory
<code class="filename">/home/<em class="replaceable"><code>&lt;user&gt;</code></em>/mmbase/WEB-INF/config/builders/applications</code>
is writable and accessible by the servlet engine user
(for auto-installing builders):
</p><pre class="programlisting">
  
  chmod 770 /home/&lt;user&gt;/mmbase/WEB-INF/config/builders/applications
  chmod 750 /home/&lt;user&gt;/mmbase/WEB-INF/config/builders/
  chmod 750 /home/&lt;user&gt;/mmbase/WEB-INF/config/
  chmod 750 /home/&lt;user&gt;/mmbase/WEB-INF/
  chmod 750 /home/&lt;user&gt;/mmbase/
  
  </pre><p>
</p><p>
Now the home directory of this user has to be accessible
to the <span class="application">Tomcat</span> server
as well.
You can change the group owner of the users home directory
to the <code class="systemitem">tomcat</code> user group:
</p><pre class="programlisting">
  
  chown -g tomcat /home/&lt;user&gt;/
  
  </pre><p>
</p><p>
Or, if you don't want this,
use the Access Control Lists (<acronym class="acronym">ACL</acronym>'s)
to accomplish the same:
</p><pre class="programlisting">
  
  setfacl -m u:tomcat:r-x /home/&lt;user&gt;/
  
  </pre><p>
</p><p>
Finally, link the new
<span class="application">MMBase</span> installation
to the <span class="application">Tomcat</span> server:
</p><pre class="programlisting">
  
  ln -s /home/&lt;user&gt;/mmbase /usr/local/tomcat/webapps/mmbase-&lt;user&gt;
  
  </pre><p>
</p><p>
and restart <span class="application">Tomcat</span>:
</p><pre class="programlisting">
  
  service tomcat restart
  
  </pre><p>
</p><p>
which will make
this users <span class="application">MMBase</span> installation
available through:
</p><pre class="programlisting">
  
  http://&lt;hostname&gt;:8080/mmbase-&lt;user&gt;/
  
  </pre><p>
</p><p>
Again, you can set up a <acronym class="acronym">JK 2</acronym> mapping or a reverse proxy
in <span class="application">Apache</span>
like we did before.
</p><p>
</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
In order to run
several instances of <span class="application">MMBase</span>
on a single <span class="application">Tomcat</span> server,
make sure you increase the available memory resources, i.e.
by adding to the <code class="envar">$CATALINA_OPTS</code> environment variable
in <code class="filename">/etc/rc.d/init.d/tomcat</code>:
</p><pre class="programlisting">
  
  -Xms64m -Xmx512m
  
  </pre><p>
</p></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1141"></a>15. Acknowledgements</h2></div></div></div><p>
This document is a follow-up on the
<span class="quote">&#8220;<span class="quote"><span class="application">MMBase</span> Mini-HOWTO:
Installation on <code class="systemitem">Debian Woody</code></span>&#8221;</span>,
by Casper Joost Eyckelhof, University of Twente, The Netherlands.
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1147"></a>16. Contributers</h2></div></div></div><p>
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
Felipe Caballero Gil,
</p></li><li class="listitem"><p>
André van Elst,
<a class="ulink" href="http://www.finalist.nl" target="_top">Finalist</a>,
The Netherlands.
</p></li></ul></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1156"></a>17. Revision history</h2></div></div></div><p>
</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.3.5.DocBook.html" target="_top">Version 0.3.5</a>, June 25, 2006: Tomcat init script,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.3.4.DocBook.html" target="_top">Version 0.3.4</a>, September 19, 2005: minor corrections,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.3.2.DocBook.html" target="_top">version 0.3.2</a>, January 25, 2005: MMBase 1.7.3, Java 1.5.0-01,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.3.1.DocBook.html" target="_top">version 0.3.1</a>, December 26, 2004: Email module,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.3.0.DocBook.html" target="_top">version 0.3.0</a>, December 25, 2004: MMBase 1.7.2, Tomcat 5.5.4, Java 1.5.0, MySQL Connector/J 3.0.16-ga, Jikes 1.22,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.6.DocBook.html" target="_top">version 0.2.6</a>, July 27, 2004: minor additions,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.5.DocBook.html" target="_top">version 0.2.5</a>, February 28, 2004: Creative Commons copyright license adjusted,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.4.DocBook.html" target="_top">version 0.2.4</a>, January 22, 2004: Creative Commons copyright license; minor additions and corrections,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.3.DocBook.html" target="_top">version 0.2.3</a>, December 26, 2003: minor additions and corrections,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.2.DocBook.html" target="_top">version 0.2.2</a>, December 20, 2003: copyright adjusted,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.1.DocBook.html" target="_top">version 0.2.1</a>, December 18, 2003: minor corrections,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.2.DocBook.html" target="_top">version 0.2</a>, December 15, 2003: <code class="systemitem"><acronym class="acronym">JK 2</acronym> Connector</code> setup added,
</p></li><li class="listitem"><p>
<a class="ulink" href="http://www.offerman.net/MMBase-Installation-HOWTO/MMBase-Installation-HOWTO-0.1.DocBook.html" target="_top">version 0.1</a>, December 10, 2003: initial draft.
</p></li></ul></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1201"></a>18. Disclaimer</h2></div></div></div><p>
This document is provided <span class="quote">&#8220;<span class="quote">as is</span>&#8221;</span>,
without any expressed or implied warranties.
Use the ideas, concepts, scripts, examples, helping hands and other
information at your own risk.
</p><p>
The specific products and their respective manufacturers are not to be taken
as endorsements of, nor commercials for, the manufacturer.
</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idm1206"></a>19. Copyright</h2></div></div></div><p>
Compiled, Copyright © 2003 - 2006, by
<a class="ulink" href="http://www.offerman.net/" target="_top">Adrian Offerman</a>.
</p><p>
<a class="ulink" href="http://www.creativecommons.org/licenses/by-sa/1.0/" target="_top"><img src="./CreativeCommons-SomeRightsReserved.gif" height="31"></a>
This document is licensed under the
<a class="ulink" href="http://www.creativecommons.org/licenses/by-sa/1.0/" target="_top">Creative Commons Attribution-ShareAlike copyright license</a>.
</p><p>
This allows you to copy, distribute, display, and print this work,
and make derivative works,
and make commercial use of the work,
under the conditions that you give the original author credit,
and if you alter, transform, or build upon this work,
you may distribute the resulting work only under a license
identical to this one.
For any reuse or distribution,
you must make clear to others the license terms of this work.
Any of these conditions can be waived if you get permission from the author.
Your fair use and other rights are in no way affected by the above.
</p></div></div></body></html>
