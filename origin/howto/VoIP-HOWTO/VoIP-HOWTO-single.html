<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.72">
 <TITLE>VoIP Howto</TITLE>
</HEAD>
<BODY>
<H1>VoIP Howto</H1>

<H2>Roberto Arcomano berto@fatamorgana.com</H2>v1.7, August 7, 2002
<HR>
<EM>Voice Over IP is a new communication means that let you telephone
 with Internet at almost null cost. How this is possible, what systems
 are used, what is the standard, all that is covered by this Howto.
 Web site 
<A HREF="http://www.fatamorgana.com/bertolinux">http://www.fatamorgana.com/bertolinux</A> contains latest version of this document.</EM>
<HR>
<H2><A NAME="s1">1. Introduction</A></H2>

<H2><A NAME="ss1.1">1.1 Introduction</A>
</H2>

<P>This document explains about VoIP systems. Recent happenings
like Internet diffusion at low cost, new integration of dedicated
voice compression processors, have changed common user requirements
allowing VoIP standards to diffuse. This howto tries to define some
basic lines of VoIP architecture.</P>
<P>Please send suggestions and critics to 
<A HREF="mailto:berto@fatamorgana.com">my email address</A></P>
<H2><A NAME="ss1.2">1.2 Copyright</A>
</H2>

<P>Copyright (C) 2000,2001 Roberto Arcomano. This document is free;
you can redistribute it and/or modify it under the terms of the GNU
General Public License as published by the Free Software Foundation;
either version 2 of the License, or (at your option) any later version.
This document is distributed in the hope that it will be useful,
but</P>
<P>WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
for more details. You can get a copy of the GNU GPL 
<A HREF="http://www.gnu.org/copyleft/gpl.html">here</A></P>
<H2><A NAME="ss1.3">1.3 Translations</A>
</H2>

<P>If you want to translate this document you are free, you only
have to: </P>
<P>
<OL>
<LI>Check that another version of it doesn't already exist at your
local LDP</LI>
<LI>Maintain all 'Introduction' section (including 'Introduction',
'Copyright', 'Translations', 'Credits').</LI>
</OL>
</P>
<P>Warning! You don't have to translate TXT or HTML file, you have
to modify LYX file, so that it is possible to convert it all other
formats (TXT, HTML, RIFF, etc.): to do that you can use "LyX" application
you download from 
<A HREF="http://www.lyx.org">http://www.lyx.org</A>.</P>
<P>No need to ask me to translate! You just have to let me know
(if you want) about your translation.</P>
<P>Thank you for your translation!</P>
<H2><A NAME="ss1.4">1.4 Credits</A>
</H2>

<P>Thanks to 
<A HREF="http://www.fatamorgana.com">Fatamorgana Computers</A> for hardware equipment and experimental opportunity.</P>
<P>Thanks to 
<A HREF="http://www.linuxdoc.org">Linux Documentation Project</A> for publishing and uploading my document in a very
quickly fashion.</P>
<P>Thanks to 
<A HREF="mailto:dprice@intercorp.com.au">David Price</A> for his support.</P>
<H2><A NAME="s2">2. Background</A></H2>

<H2><A NAME="ss2.1">2.1 The past</A>
</H2>

<P>More than 30 years ago Internet didn't exist. Interactive communications
were only made by telephone at PSTN line cost.</P>
<P>Data exchange was expansive (for a long distance) and no one
had been thinking to video interactions (there was only television
that is not interactive, as known).</P>
<H2><A NAME="ss2.2">2.2 Yesterday</A>
</H2>

<P>Few years ago we saw appearing some interesting things: PCs to
large masses, new technologies to communicate like cellular phones
and finally the great net: Internet; people begun to communicate
with new services like email, chat, etc. and business reborned with
the web allowing people buy with a "click".</P>
<H2><A NAME="ss2.3">2.3 Today</A>
</H2>

<P>Today we can see a real revolution in communication world: everybody
begins to use PCs and Internet for job and free time to communicate
each other, to exchange data (like images, sounds, documents) and,
sometimes, to talk each other using applications like Netmeeting
or Internet Phone. Particularly starts to diffusing a common idea
that could be the future and that can allow real-time vocal communication:
VoIP.</P>
<H2><A NAME="ss2.4">2.4 The future</A>
</H2>

<P>We cannot know what is the future, but we can try to image it
with many computers, Internet almost everywhere at high speed and
people talking (audio and video) in a real time fashion. We only
need to know what will be the means to do this: UMTS, VoIP (with
video extension) or other? Anyway we can notice that Internet has
grown very much in the last years, it is free (at least as international
means) and could be the right communication media for future.</P>
<H2><A NAME="s3">3. Overview</A></H2>

<H2><A NAME="ss3.1">3.1 What is VoIP?</A>
</H2>

<P>VoIP stands for 'V'oice 'o'ver 'I'nternet 'P'rotocol. As the
term says VoIP tries to let go voice (mainly human) through IP packets
and, in definitive through Internet. VoIP can use accelerating hardware
to achieve this purpose and can also be used in a PC environment.</P>
<H2><A NAME="ss3.2">3.2 How does it work? </A>
</H2>

<P>Many years ago we discovered that sending a signal to a remote
destination could have be done also in a digital fashion: before
sending it we have to digitalize it with an ADC (analog to digital
converter), transmit it, and at the end transform it again in analog
format with DAC (digital to analog converter) to use it. </P>
<P>VoIP works like that, digitalizing voice in data packets, sending
them and reconverting them in voice at destination.  </P>
<P>Digital format can be better controlled: we can compress it,
route it, convert it to a new better format, and so on; also we saw
that digital signal is more noise tolerant than the analog one (see
GSM vs TACS).</P>
<P>TCP/IP networks are made of IP packets containing a header (to
control communication) and a payload to transport data: VoIP use
it to go across the network and come to destination.</P>
<P>
<PRE>
Voice (source)  - - ADC - - - - Internet - - - DAC  - - Voice (dest)
</PRE>
</P>
<H2><A NAME="ss3.3">3.3 What is the advantages using VoIP rather PSTN?</A>
</H2>

<P>When you are using PSTN line, you typically pay for time used
to a PSTN line manager company: more time you stay at phone and more
you'll pay. In addition you couldn't talk with other that one person
at a time.</P>
<P>In opposite with VoIP mechanism you can talk all the time with
every person you want (the needed is that other person is also connected
to Internet at the same time), as far as you want (money independent)
and, in addition, you can talk with many people at the same time.</P>

<P>If you're still not persuaded you can consider that, at the same
time, you can exchange data with people are you talking with, sending
images, graphs and videos.</P>
<H2><A NAME="ss3.4">3.4 Then, why everybody doesn't use it yet?</A>
</H2>

<P>Unfortunately we have to report some problem with the integration
between VoIP architecture and Internet. As you can easy imagine,
voice data communication must be a real time stream (you couldn't
speak, wait for many seconds, then hear other side answering): this
is in contrast with the Internet heterogeneous architecture that
can be made of many routers (machines that route packets), about
20-30 or more and can have a very high round trip time (RTT), so
we need to modify something to get it properly working. </P>
<P>In next sections we'll try to understand how to solve this great
problem. In general we know that is very difficult to guarantee a
bandwidth in Internet for VoIP application.</P>
<H2><A NAME="s4">4. Technical info about VoIP</A></H2>

<P>Here we see some important info about VoIP, needed to understand
it.</P>
<H2><A NAME="ss4.1">4.1 Overview on a VoIP connection</A>
</H2>

<P>To setup a VoIP communication we need:</P>
<P>
<OL>
<LI>First the ADC to convert analog voice to digital signals (bits)</LI>
<LI>Now the bits have to be compressed in a good format for transmission:
there is a number of protocols we'll see after.</LI>
<LI>Here we have to insert our voice packets in data packets using
a real-time protocol (typically RTP over UDP over IP)</LI>
<LI>We need a signaling protocol to call users: ITU-T H323 does that.</LI>
<LI>At RX we have to disassemble packets, extract datas, then convert
them to analog voice signals and send them to sound card (or phone)</LI>
<LI>All that must be done in a real time fashion cause we cannot
waiting for too long for a vocal answer! (see QoS section)</LI>
</OL>
</P>
<P>
<PRE>
                         
                        Base architecture

Voice )) ADC - Compression Algorithm -  Assembling RTP in TCP/IP -----
                                                         ----&gt;      |
                                                         &lt;----      |
Voice (( DAC - Decompress. Algorithm -  Disass. RTP from TCP/IP  -----
</PRE>
</P>
<H2><A NAME="ss4.2">4.2 Analog to Digital Conversion</A>
</H2>

<P>This is made by hardware, typically by card integrated ADC. </P>
<P>Today every sound card allows you convert with 16 bit a band
of 22050 Hz (for sampling it you need a freq of 44100 Hz for Nyquist
Principle) obtaining a throughput of 2 bytes * 44100 (samples per
second) = 88200 Bytes/s, 176.4 kBytes/s for stereo stream.</P>
<P>For VoIP we needn't such a throughput (176kBytes/s) to send voice
packet: next we'll see other coding used for it.</P>
<H2><A NAME="ss4.3">4.3 Compression Algorithms</A>
</H2>

<P>Now that we have digital data we may convert it to a standard
format that could be quickly transmitted.</P>
<P>
<PRE>
PCM, Pulse Code Modulation, Standard ITU-T G.711
</PRE>
</P>
<P>
<UL>
<LI>Voice bandwidth is 4 kHz, so sampling bandwidth has to be 8 kHz
(for Nyquist). </LI>
<LI>We represent each sample with 8 bit (having 256 possible values).</LI>
<LI>Throughput is 8000 Hz *8 bit = 64 kbit/s, as a typical digital
phone line.</LI>
<LI>In real application mu-law (North America) and a-law (Europe)
variants are used which code analog signal a logarithmic scale using
12 or 13 bits instead of 8 bits (see Standard ITU-T G.711).</LI>
</UL>
</P>
<P>
<PRE>
ADPCM, Adaptive differential PCM, Standard ITU-T G.726
</PRE>
</P>
<P>It converts only the difference between the actual and the previous
voice packet requiring 32 kbps (see Standard ITU-T G.726).</P>
<P>
<PRE>
LD-CELP, Standard ITU-T G.728
CS-ACELP, Standard ITU-T G.729 and G.729a
MP-MLQ, Standard ITU-T G.723.1, 6.3kbps, Truespeech
ACELP, Standard ITU-T G.723.1, 5.3kbps, Truespeech
LPC-10, able to reach 2.5 kbps!!
</PRE>
</P>
<P>This last protocols are the most important cause can guarantee
a very low minimal band using source coding; also G.723.1 codecs
have a very high MOS (Mean Opinion Score, used to measure voice fidelity)
but attention to elaboration performance required by them, up to
26 MIPS! </P>
<H2><A NAME="ss4.4">4.4 RTP Real Time Transport Protocol</A>
</H2>

<P>Now we have the raw data and we want to encapsulate it into TCP/IP
stack. We follow the structure:</P>
<P>
<PRE>
VoIP data packets
       RTP
       UDP
       IP
    I,II layers
</PRE>
</P>
<P>VoIP data packets live in RTP (Real-Time Transport Protocol)
packets which are inside UDP-IP packets.</P>
<P>Firstly, VoIP doesn't use TCP because it is too heavy for real
time applications, so instead a UDP (datagram) is used. </P>
<P>Secondly, UDP has no control over the order in which packets
arrive at the destination or how long it takes them to get there
(datagram concept). Both of these are very important to overall voice
quality (how well you can understand what the other person is saying)
and conversation quality (how easy it is to carry out a conversation).
RTP solves the problem enabling the receiver to put the packets back
into the correct order and not wait too long for packets that have
either lost their way or are taking too long to arrive (we don't
need every single voice packet, but we need a continuous flow of
many of them and ordered).</P>
<P>
<PRE>
                    Real Time Transport Protocol
 
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |V=2|P|X|  CC   |M|     PT      |       sequence number         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           timestamp                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           synchronization source (SSRC) identifier            |
   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
   |            contributing source (CSRC) identifiers             |
   |                             ....                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</PRE>
</P>
<P>Where:</P>
<P>
<UL>
<LI>V indicates the version of RTP used</LI>
<LI>P indicates the padding, a byte not used at bottom packet to
reach the parity packet dimension</LI>
<LI>X is the presence of the header extension</LI>
<LI>CC field is the number of CSRC identifiers following the fixed
header. CSRC field are used, for example, in conference case.</LI>
<LI>M is a marker bit</LI>
<LI>PT payload type</LI>
</UL>
</P>
<P>For a complete description of RTP protocol and all its applications
see relative RFCs
<A HREF="http://www.ietf.org/rfc/rfc1889.txt">1889</A> and 
<A HREF="http://www.ietf.org/rfc/rfc1890.txt">1890</A>.</P>
<H2><A NAME="ss4.5">4.5 RSVP</A>
</H2>

<P>There are also other protocols used in VoIP, like RSVP, that
can manage Quality of Service (QoS).</P>
<P>RSVP is a signaling protocol that requests a certain amount of
bandwidth and latency in every network hop that supports it. </P>
<P>For detailed info about RSVP see the
<A HREF="http://www.ietf.org/rfc/rfc2205.txt?number=2205">RFC 2205</A></P>
<H2><A NAME="ss4.6">4.6 Quality of Service (QoS)</A>
</H2>

<P>We said many times that VoIP applications require a real-time
data streaming cause we expect an interactive data voice exchange.</P>

<P>Unfortunately, TCP/IP cannot guarantee this kind of purpose,
it just make a "best effort" to do it. So we need to introduce tricks
and policies that could manage the packet flow in EVERY router we
cross.</P>
<P>So here are:</P>
<P>
<OL>
<LI>TOS field in IP protocol to describe type of service: high values
indicate low urgency while more and more low values bring us more
and more real-time urgency</LI>
<LI>Queuing packets methods:
<OL>
<LI>FIFO (First in First Out), the more stupid method that allows
passing packets in arrive order.</LI>
<LI>WFQ (Weighted Fair Queuing), consisting in a fair passing of
packets (for example, FTP cannot consume all available bandwidth),
depending on kind of data flow, typically one packet for UDP and
one for TCP in a fair fashion.</LI>
<LI>CQ (Custom Queuing), users can decide priority.</LI>
<LI>PQ (Priority Queuing), there is a number (typically 4) of queues
with a priority level each one: first, packets in the first queue
are sent, then (when first queue is empty) starts sending from the
second one and so on.</LI>
<LI>CB-WFQ (Class Based Weighted Fair Queuing), like WFQ but, in
addition, we have classes concept (up to 64) and the bandwidth value
associated for each one.</LI>
</OL>
</LI>
<LI>Shaping capability, that allows to limit the source to a fixed
bandwidth in:
<OL>
<LI>download</LI>
<LI>upload</LI>
</OL>
</LI>
<LI>Congestion Avoidance, like RED (Random Early Detection).</LI>
</OL>
</P>
<P>For an exhaustive information about QoS see 
<A HREF="http://www.ietf.org/html.charters/diffserv-charter.html">Differentiated Services</A> at IETF.</P>
<H2><A NAME="ss4.7">4.7 H323 Signaling Protocol</A>
</H2>

<P>H323 protocol is used, for example, by Microsoft Netmeeting to
make VoIP calls.</P>
<P>This protocol allow a variety of elements talking each other:</P>
<P>
<OL>
<LI>Terminals, clients that initialize VoIP connection. Although
terminals could talk together without anyone else, we need some additional
elements for a scalable vision.</LI>
<LI>Gatekeepers, that essentially operate:
<OL>
<LI>address translation service, to use names instead IP addresses</LI>
<LI>admission control, to allow or deny some hosts or some users</LI>
<LI>bandwidth management</LI>
</OL>
</LI>
<LI>Gateways, points of reference for conversion TCP/IP - PSTN.</LI>
<LI>Multipoint Control Units (MCUs) to provide conference.</LI>
<LI>Proxies Server also are used.</LI>
</OL>
</P>
<P>h323 allows not only VoIP but also video and data communications.</P>
<P>Concerning VoIP, h323 can carry audio codecs G.711, G.722, G.723,
G.728 and G.729 while for video it supports h261 and h263.</P>
<P>More info about h323 is available at 
<A HREF="http://www.openh323.org/standards.html">Openh323 Standards</A>, at 
<A HREF="http://www.cs.columbia.edu/~hgs/rtp/h323.html">this h323 web site</A> and at its standard
description: 
<A HREF="http://www.itu.int/itudoc/itu-t/rec/h/">ITU H-series Recommendations</A>.</P>
<P>You can find it implemented in various application software like
<A HREF="http://www.microsoft.com">Microsoft Netmeeting</A>, 
<A HREF="http://www.net2phone.com">Net2Phone</A>, 
<A HREF="http://www.dialpad.com">DialPad</A>, ... and also in freeware products you can find at 
<A HREF="http://www.openh323.org">Openh323 Web Site</A>.</P>
<H2><A NAME="s5">5. Requirement</A></H2>

<H2><A NAME="ss5.1">5.1 Hardware requirement</A>
</H2>

<P>To create a little VoIP system you need the following hardware:</P>
<P>
<OL>
<LI>PC 386 or more</LI>
<LI>Sound card, full duplex capable</LI>
<LI>a network card or connection to internet or other kind of interface
to allow communication between 2 PCs</LI>
</OL>
</P>
<P>All that has to be present twice to simulate a standard communication.</P>
<P>The tool above are the minimal requirement for a VoIP connection:
next we'll see that we should (and in Internet we must) use more
hardware to do the same in a real situation.</P>
<P>Sound card has be full duplex unless we couldn't hear anything
while speaking!</P>
<P>As additional you can use hardware cards (see next) able to manage
data stream in a compressed format (see Par 4.3).</P>
<H2><A NAME="ss5.2">5.2 Hardware accelerating cards </A>
</H2>

<P>We can use special cards with hardware accelerating capability.
Two of them (and also the only ones directly managed by the Linux
kernel at this moment) are the</P>
<P>
<OL>
<LI>Quicknet PhoneJack</LI>
<LI>Quicknet LineJack</LI>
<LI>VoiceTronix V4PCI</LI>
<LI>VoiceTronix VPB4</LI>
<LI>VoiceTronix VPB8L</LI>
</OL>
</P>
<P>Quicknet PhoneJack is a sound card that can use standard algorithms
to compress audio stream like G723.1 (section 4.3) down to 4.1 Kbps
rate. </P>
<P>It can be connected directly to a phone (POTS port) or a couple
mic-speaker.</P>
<P>It has a ISA or PCI connector bus.</P>
<P>Quicknet LineJack works like PhoneJack with some addition features
(see next).</P>
<P>VoiceTronix V4PCI is a PCI card pretty like Quicknet LineJack
but with 4 phone ports</P>
<P>VoiceTronix VPB4 is a ISA card equivalent to V4PCI.</P>
<P>VoiceTronix VPB8L is a logging card with 8 ports.</P>
<P>For more info see 
<A HREF="http://www.quicknet.net">Quicknet web site</A> and 
<A HREF="http://www.voicetronix.com.au">VoiceTronix web site</A></P>
<H2><A NAME="ss5.3">5.3 Hardware gateway cards</A>
</H2>

<P>Quicknet LineJack and VoiceTronix cards can be connected to a
PSTN line allowing VoIP gateway feature. </P>
<P>Then you'll need a software to manage it (see after).</P>
<H2><A NAME="ss5.4">5.4 Software requirement</A>
</H2>

<P>We can choose what O.S. to use:</P>
<P>
<OL>
<LI>Win9x</LI>
<LI>Linux</LI>
</OL>
</P>
<P>Under Win9x we have Microsoft Netmeeting, Internet Phone, DialPad
or others or Internet Switchboard (from 
<A HREF="http://www.quicknet.net">Quicknet web site</A>) for Quicknet cards. </P>
<P>Warning!!: Latest Quicknet cards using Swithboard (older version
too) NEED to be connected to Internet to get working for managing
Microtelco account (not free of charge), so if you plan to remain
isolated from Internet you need to install 
<A HREF="http://www.openh323.org">OpenH323 software</A>.</P>
<P>For VoiceTronix cards you can find software at 
<A HREF="http://www.voicetronix.com.au">VoiceTronix web site</A></P>
<P>Under Linux we have free software 
<A HREF="http://www.gnomemeeting.org">GnomeMeeting</A>, a clone of Microsoft Netmeeting,
while in console mode we use (also free software) applications from
<A HREF="http://www.openh323.org">OpenH323</A> web site: simph323 or ohphone that can also work with Quicknet accelerating
hardware.</P>
<P>Attention: all Openh323 source code has to be compiled in a user
directory (if not it is necessary to change some environment variable).
You are warned that compiling time could be very high and you could
need a lot of RAM to make it in a decent time. </P>
<H2><A NAME="ss5.5">5.5 Gateway software</A>
</H2>

<P>To manage gateway feature (join TCP/IP VoIP to PSTN lines) you
need some kind of software like this:</P>
<P>
<UL>
<LI>
<A HREF="http://www.quicknet.net">Internet SwitchBoard</A> (only when connected to Internet) for Windows systems also acting
as a h323 terminal;</LI>
<LI>PSTNGw for Linux and Windows systems you download from 
<A HREF="http://www.openh323.org/code.html">OpenH323</A>.</LI>
</UL>
</P>
<H2><A NAME="ss5.6">5.6 Gatekeeper software</A>
</H2>

<P>You can choose as gatekeeper:</P>
<P>
<OL>
<LI>Opengatekeeper, you can download from 
<A HREF="http://www.opengatekeeper.org">opengatekeeper web site</A> for Linux and Win9x.</LI>
<LI>Openh323 Gatekeeper (GK) from 
<A HREF="http://www.willamowius.de/openh323gk.html">here</A>.</LI>
</OL>
</P>
<H2><A NAME="ss5.7">5.7 Other software</A>
</H2>

<P>
<A NAME="Phonepatch"></A> In addition I report some useful software h323 compliant:</P>
<P>
<UL>
<LI>Phonepatch, able to solve problems behind a NAT firewall. It
simply allows users (external or internal) calling from a web page
(which is reachable from even external and internal users): when
web application understands the remote host is ready, it calls (h323)
the source telling it all is ok and communication can be established.
Phonepatch is a proprietary software (with also a demo version for
no more than 3 minutes long conversations) you download from 
<A HREF="http://www.equival.com/phonepatch">here</A>.</LI>
</UL>
</P>
<H2><A NAME="s6">6. Cards setup</A></H2>

<P>Here we see how to configure special hardware card in Linux and
Windows environment.</P>
<H2><A NAME="ss6.1">6.1 Quicknet PhoneJack</A>
</H2>

<P>As we saw, Quicknet Phonejack is a sound card with VoIP accelerating
capability. It supports:</P>
<P>
<UL>
<LI>G.711 normal and mu/A-law, G.728-9, G.723.1 (TrueSpeech) and
LPC10.</LI>
<LI>Phone connector (to allow calling directly from your phone) or</LI>
<LI>Mic &amp; speaker jacks.</LI>
</UL>
</P>
<P>Quicknet PhoneJack is a ISA (or PCI) card to install into your
Pc box. It can work without an IRQ.</P>
<H3>Software installation</H3>

<P>Under Windows you have to install:</P>
<P>
<OL>
<LI>Card driver</LI>
<LI>Internet Switchboard application (working only with Internet,
using newer Quicknet cards)</LI>
</OL>
</P>
<P>all downloadable from 
<A HREF="http://www.quicknet.net">Quicknet web site</A></P>
<P>After Switchboard has been installed, you need to register to
Quicknet to obtain full capability of your card.</P>
<P>When you pick up the phone Internet Switchboard wakes up and
waits for your calling number (directly entered from your phone),
you can:</P>
<P>
<OL>
<LI>enter an asterisk, then type an IP number (with asterisks in
place of dot) with a # in the end</LI>
<LI>type directly a PSTN phone number (with international prefix)
to call a classic phone user. In this case you need a registration
to a gateway manager to which pay for time.</LI>
<LI>enter directly a quick dial number (up to 2 digits) you have
previously stored which make a call (IP or PSTN).</LI>
</OL>
</P>
<P>Internet Swichboard is h323 compatible, so if you can use, for
example, Microsoft Netmeeting at the other end to talk. </P>
<P>Warning!! Internet Switchboard NEED to be connected to Internet
when used with newer Quicknet cards</P>
<P>In place of Internet Switchboard you can use openh323 application
<A HREF="http://www.openh323.org/code.html">openphone</A> (using GUI) or 
<A HREF="http://www.openh323.org/code.html">ohphone</A> (command line).</P>
<P>Under Linux you have to install:</P>
<P>
<OL>
<LI>Card driver, from 
<A HREF="http://www.quicknet.net">Quicknet web site</A>. After downloaded you have to compile it (you
must have a /usr/src/linux soft or hard link to your Linux source
directory): type make for instructions.</LI>
<LI>Application 
<A HREF="http://www.openh323.org/code.html">openphone</A> or 
<A HREF="http://www.openh323.org/code.html">ohphone</A>. </LI>
<LI>If you are a developer you can use 
<A HREF="ftp://ftp.quicknet.net/Developer/Linux/Docs/">SDK</A> to create your own application
(also for Windows).</LI>
</OL>
</P>
<H3>Settings</H3>

<P>With Internet Switchboard (and with other application) you can:</P>
<P>
<OL>
<LI>Change compression algorithm preferred</LI>
<LI>Tune jitter delay</LI>
<LI>Adjust volume</LI>
<LI>Adjust echo cancellation level.</LI>
</OL>
</P>
<H2><A NAME="ss6.2">6.2 Quicknet LineJack</A>
</H2>

<P>This card is very similar to the previous, it supports also gateway
feature. </P>
<P>We only notice that we have to 
<A HREF="http://www.quicknet.net/code.html">download</A> PSTNGx application (for Linux
and Windows) or we use Internet Switchboard to gateway feature.</P>
<H2><A NAME="ss6.3">6.3 VoiceTronix products</A>
</H2>

<P>
<OL>
<LI>First download software 
<A HREF="http://www.voicetronix.com.au/vpb-driver-2.1.8.tar.gz">here</A></LI>
<LI>Untar it</LI>
<LI>Modify 'src/vpbreglinux.cpp' according to file README</LI>
<LI>type 'make'</LI>
<LI>type 'make install'</LI>
<LI>cd to src</LI>
<LI>type 'insmod vpb.o'</LI>
<LI>retrieve (from console of from 'dmesg' output command) major
number, say MAJOR</LI>
<LI>type 'mknod /dev/vpb0 c MAJOR 0' where MAJOR is the above number</LI>
<LI>cd to unittest and type './echo'</LI>
</OL>
</P>
<P>Follow README file for more help.</P>
<P>I personally haven't tested VoiceTronix products so please contact
<A HREF="http://www.voicetronix.com.au">VoiceTronix web site</A> for support.</P>
<H2><A NAME="s7">7. Setup</A></H2>

<P>In this chapter we try to setup VoIP system, simple at first,
then more and more complex.</P>
<H2><A NAME="ss7.1">7.1 Simple communication: IP to IP</A>
</H2>

<P>
<PRE>
       A (Sound card)   -  -  -    B (Sound card)

        192.168.1.1     -  -  -     192.168.1.2

        
      192.168.1.1 calls 192.168.1.2 and viceversa.
</PRE>
</P>
<P>A and B should have</P>
<P>
<OL>
<LI>an application like Microsoft Netmeeting, Internet Switchboard,
Openh323 (under Windows environment) or Ohphone, Gnomemeeting (under
Linux), installed and properly configured.</LI>
<LI>a network card or other kind of TCP/IP interface to talk each
other.</LI>
</OL>
</P>
<P>In this kind of view A can make a H323 call to B (if B has server
side application active) using B IP address. Then B can answer to
it if it wants. After accepting call, VoIP data packets start to
flow.</P>
<H2><A NAME="ss7.2">7.2 Using names</A>
</H2>

<P>Under Microsoft Windows a NetBIOS name can be used instead of
an IP address.</P>
<P>
<PRE>
          A            -  -  -             B 
 
     192.168.1.1       -  -  -        192.168.1.2
   
        John           -  -  -           Alice

             
                    John calls Alice.
</PRE>
</P>
<P>This is possible cause John call request to Alice is converted
to IP calling by the NetBIOS protocol.</P>
<P>The above 2 examples are very easy to implement but aren't scalable.</P>

<P>In a more big view such as Internet it is impossible to use direct
calling cause, usually, the callers don't know the destination IP
address. Furthermore NetBIOS naming feature cannot work cause it
uses broadcast messages, which typically don't pass ISP routers .</P>
<P>You can also use DNS to solve name in IP address: for example
you can call ''box.domain.com''.</P>
<H2><A NAME="ss7.3">7.3 Internet calling using a WINS server</A>
</H2>

<P>The NetBIOS name calling idea can be implemented also in a Internet
environment, using a WINS server: NetBIOS clients can be configured
to use a WINS server to resolve names. </P>
<P>PCs using the same WINS server will be able to make direct calling
between them.</P>
<P>
<PRE>
A (WINS Server is S) - - - - I  - - - -  B (WINS Server is S)
                             N
                             T  
                             E  - - - - -   S (WINS Server)   
C (WINS Server is S) - - - - R  
                             N
                             E  - - - -  D (WINS Server is S)
                             T
 
                   Internet communication
</PRE>
</P>
<P>A, B, C and D are in different subnets, but they can call each
other in a NetBIOS name calling fashion. The needed is that all are
using S as WINS Server.</P>
<P>Note: WINS server hasn't very high performance cause it use NetBIOS
feature and should only be used for joining few subnets.</P>
<H2><A NAME="ss7.4">7.4 ILS server</A>
</H2>

<P>ILS is a kind of server which allows you to solve your name during
an H323 calling: when you start VoIP application you first register
to ILS server using a name, then everyone will be able to see you
using that name (if he uses same Server ILS!).</P>
<H2><A NAME="ss7.5">7.5 A big problem: the masquering.</A>
</H2>

<P>A problem of few IPs is commonly solved using the so called masquering
(also NAT, network address translation): there is only 1 IP public
address (that Internet can directly "see"), the others machines are
"masqueraded" using all this IP. </P>
<P>
<PRE>
        
           A  - - -

           B  - - -   Router with NAT  - - -  Internet

           C  - - -
     
                     
                       This doesn't work
</PRE>
</P>
<P>In the example A,B and C can navigate, pinging, using mail and
news services with Internet people, but they CANNOT make a VoIP call.
This because H323 protocol send IP address at application level,
so the answer will never arrive to source (that is using a private
IP address).</P>
<P>Solutions: </P>
<P>
<UL>
<LI>there is a Linux module that modifies H323 packets avoiding this
problem. You can download the module 
<A HREF="http://www.coritel.it/coritel/ip/sofia/nat/nat2/nat2.htm">here</A>. To install it you have to
copy it to source directory specified, modify Makefile and go compiling
and installing module with "modprobe ip_masq_h323". Unfortunately this
module cannot work with ohphone software at this moment (I don't
know why).</LI>
</UL>
</P>
<P>
<PRE>
 
           A  - - -   Router with NAT 
 
           B  - - -         +           - - -  Internet

           C  - - -  ip_masq_h323 module
 
 
                         This works
</PRE>
</P>
<P>
<UL>
<LI>There is a application program that also solves this problem:
for more see 
<A HREF="#Phonepatch">Par 5.7</A></LI>
</UL>
</P>
<P>
<PRE>
           
           A  - - -   
 
           B  - - -    PhonePatch   - - -  Internet

           C  - - -  
 
 
                         This works
</PRE>
</P>
<H2><A NAME="ss7.6">7.6 Open Source applications</A>
</H2>

<H3>Ohphone Sintax</H3>

<P>Sintax is:</P>
<P>"ohphone -l|--listen [options]"</P>
<P>"ohphone [options]... address"</P>
<P>
<UL>
<LI>"-l", listen to standard port (1720)</LI>
<LI>"address", mean that we don't wait for a call, but we connect to
"address" host</LI>
<LI>"-n", "--no-gatekeeper", this is ok if we haven't a gatekeeper</LI>
<LI>"-q num", "--quicknet num", it uses Quicknet card, device /dev/phone(num)</LI>
<LI>"-s device", "--sound device", it uses /dev/device sound device.</LI>
<LI>"-j delay", "--jitter delay", it change delay buffer to "delay".</LI>
</UL>
</P>
<P>Also, when you start ohphone, you can give command to the interpreter
directly (like decrease AEC, Automatic Echo Cancellation).</P>
<H3>Gnomemeeting</H3>

<P>Gnomemeeting is an application using GUI interface to make call
using VoIP. It is very simple to use and allows you to use ILS server,
chat and other things.</P>
<H2><A NAME="ss7.7">7.7 Setting up a gatekeeper</A>
</H2>

<P>You can also experiment gatekeeper feature</P>
<P>
<PRE>
Example
  
        (Terminal H323) A  - - -    
                                 \
        (Terminal H323) B  - -  - D (Gatekeeper)
                                 /
        (Terminal H323) C  - - -  
               
                   Gatekeeper configuration
</PRE>
</P>
<P>
<OL>
<LI>Hosts A,B and C have gatekeeper setting to point to D. </LI>
<LI>At start time each host tells D own address and own name (also
with aliases) which could be used by a caller to reach it.</LI>
<LI>When a terminal asks D for an host, D answers with right IP address,
so communication can be established.</LI>
</OL>
</P>
<P>We have to notice that the Gatekeeper is able only to solve name
in IP address, it couldn't join hosts that aren't reachable each
other (at IP level), in other words it couldn't act as a NAT router.</P>
<P>You can find gatekeeper code 
<A HREF="http://www.opengatekeeper.org">here</A>: 
<A HREF="http://www.openh323.org/code.html">openh323 library</A> is also required.</P>
<P>Program has only to be launch with -d (as daemon) or -x (execute)
parameter. </P>
<P>In addition you can use a config file (.ini) you find 
<A HREF="http://www.opengatekeeper.org/opengate.ini">here</A>.</P>
<H2><A NAME="ss7.8">7.8 Setting up a gateway</A>
</H2>

<P>As we said, gateway is an entity that can join VoIP to PSTN lines
allowing us to made call from Internet to a classic telephone. So,
in addition, we need a card that could manage PSTN lines: Quicknet
LineJack does it.</P>
<P>From 
<A HREF="http://www.openh323.org">OpenH323 web site</A> we download: </P>
<P>
<OL>
<LI>driver for Linejack</LI>
<LI>PSTNGw application to create our gateway.</LI>
</OL>
</P>
<P>If executable doesn't work you need to download source code and
<A HREF="http://www.openh323.org/code.html">openh323 library</A>, then install all in a home user directory.</P>
<P>After that you only need to launch PSTNGw to start your H323
gateway.</P>
<H2><A NAME="ss7.9">7.9 Compatibility Matrix</A>
</H2>

<P>First Matrix refers to:</P>
<P>
<OL>
<LI>Software intercommunications (i.e. Netmeeting with SwitchBoard)</LI>
<LI>Software/Driver/Hardware talking (i.e. Netmeeting can use a PhoneJACK
card).</LI>
</OL>
</P>
<P>
<PRE>
 _____________________________________________________________________________________________________________________
|            | Netmeeting |SwitchBoard |  Simph323  |  OhPhone   | LinPhone    |Speak-Freely|HW PhoneJACK|HW LineJACK |
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
| Netmeeting |      V            V            V           V             X            X            V            V            
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|SwitchBoard |      V            V            V           V             X            X            V            V            
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|  Simph323  |      V            V            V           V             X            X            X            X                   
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|  OhPhone   |      V            V            V           V             X            X            V            V            
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
| LinPhone   |      X            X            X           X             V            X            X            X            
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|SpeakFreely |      X            X            X           X             X            V            X            X
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|HW PhoneJACK|      V            V            X           V             X            X            _            _  
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
|HW LineJACK |      V            V            X           V             X            X            _            _
|____________|____________|____________|____________|____________|_____________|____________|____________|____________|
 
</PRE>
</P>
<P>Second Matrix refers to Gateway softwares that manage LineJACK
card.</P>
<P>
<PRE>
 ___________________________________________________________
|              |HW LineJACK GW| SwitchBoard  |    PSTNGW    |
|______________|______________|______________|______________|
|HW LineJACK GW|      _       |      V       |       V      |
|______________|______________|______________|______________|
| SwitchBoard  |      V       |      _       |       _      |
|______________|______________|______________|______________|
|    PSTNGW    |      V       |      _       |       _      |  
|______________|______________|______________|______________|
</PRE>
</P>
<P>Notation:</P>
<P>
<UL>
<LI>V : Works</LI>
<LI>X : Doesn't Work</LI>
<LI>-- : Doesn't care</LI>
</UL>
</P>
<H2><A NAME="s8">8. Communications using PSTN line</A></H2>

<H2><A NAME="ss8.1">8.1 Overview</A>
</H2>

<P>VoIP becomes very interesting when you start to use PSTN lines
to call other people in the world, directly to their home telephone.</P>
<H2><A NAME="ss8.2">8.2 Scenario</A>
</H2>

<P>A typical application is like that:</P>
<P>
<PRE>
Home telephone1 -- (PSTN) -- PC1 -- (Internet) -- PC2 -- (PSTN) -- Home telephone2
</PRE>
</P>
<P>
<OL>
<LI>Home Telephone1 make a calls to PC1 phone number (using PSTN
line, I mean classic telephone line).</LI>
<LI>PC1 answer to it.</LI>
<LI>Home telephone1 must tell PC1 what gateway use (PC2 in this case)
by giving the IP address (from DTMF keyboard) and/or what number
call (in this case Home telephone2).</LI>
<LI>After that PC1 will start to make an H323 call to PC2, then it
will pass Home telephone2 to PC2 to make it call it throught PSTN
line.</LI>
<LI>Home telephone2 answers to call and communication between Home
telephone1 and Home telephone2 begins.</LI>
</OL>
</P>
<H2><A NAME="ss8.3">8.3 What can be changed in this configuration? </A>
</H2>

<P>
<OL>
<LI>You may use a PBX to select many lines to access many PC1 gateway
(for example one to call within your state, one to go accross Europe,
and so on...): typically you don't have to change this, cause cost
is always the same.</LI>
<LI>You can select (after called your PC1 gateway) every PC2 you
want (for example a PC2 living in England to call an English person
so that you'd pay only intra-country costs).</LI>
</OL>
</P>
<P>So your decision will be taken considering PSTN line costs. In
fact what VoIP does is the convert this:</P>
<P>
<PRE>
Home Telephone1 --- (PSTN) --- Home Telephone2
             PSTN great distance calling cost
</PRE>
</P>
<P>into this:</P>
<P>
<PRE>
      Home Telephone1 --- (PSTN) --- PC1   +
      PC2 ---- (PSTN) --- Home Telephone2  =
      --------------------------------------
          2 PSTN short distance calling costs
</PRE>
</P>
<P>To save money you need that:</P>
<P>
<PRE>
2 PSTN short distance calling costs &lt; PSTN great distance calling cost 
</PRE>
</P>
<P>Typically "short distance calling" refers to a "city cal" while "great
distance calling" can be an "intercontinental call"!</P>
<H2><A NAME="s9">9. Bandwidth consideration</A></H2>

<P>From all we said before we noticed that we still have not solved
problems about bandwidth, how to create a real time streaming of
data.</P>
<P>We know we couldn't find a solution unless we enable a right
real-time manager protocol in each router we cross, so what do we
can do?</P>
<P>First we try to use a very (as more as possible) high rate compression
algorithms (like LPC10 which only consumes a 2.5 kbps bandwidth,
about 313 bytes/s).</P>
<P>Then we starts classify our packets, in TOS field, with the most
high priority level, so every router help us having urgently.</P>
<P>Important: all that is not sufficient to guarantee our conversation
would always be ok, but without an great infrastructure managing
shaping, bandwidth reservation and so on, it is not possible to do
it, TCP/IP is not a real time protocol. </P>
<P>A possible solution could be starts with little WAN at guaranteed
bandwidth and get larger step by step.</P>
<P>We finally have to notice a thing: also the so called guaranteed
services like PSTN line could not manage all clients they have: for
example a GSM call is not able to manage more that some hundred or
some thousand of clients.</P>
<P>Anyway for a starting service, limited to few users, VoIP can
be a valid alternative to classic PSTN service.</P>
<H2><A NAME="s10">10. Glossary</A></H2>

<P>PSTN: Public Switched Telephone Network</P>
<P>VoIP: Voice over Internet Protocol</P>
<P>LAN: Local Area Network</P>
<P>WAN: Wide Area Network</P>
<P>TOS: Type Of Service</P>
<P>ISP: Internet Service Provider</P>
<P>RTP: Real Time Protocol</P>
<P>RSVP: ReSerVation Protocol</P>
<P>QoS: Quality of Service</P>
<H2><A NAME="s11">11. Useful links</A></H2>

<H2><A NAME="ss11.1">11.1 Open software link</A>
</H2>

<P>
<UL>
<LI>
<A HREF="http://www.voxilla.org">Voxilla</A></LI>
<LI>
<A HREF="http://www.linuxtelephony.org">Linux Telephony</A></LI>
<LI>
<A HREF="http://www.openh323.org">Open H323 web site</A></LI>
<LI>
<A HREF="http://www.gnomemeeting.org/">http://www.gnomemeeting.org/</A></LI>
<LI>
<A HREF="http://www.speakfreely.org">Speak Freely</A></LI>
<LI>
<A HREF="http://www.linphone.org">http://www.linphone.org</A></LI>
<LI>
<A HREF="http://www.fsf.org/software/osip">http://www.fsf.org/software/osip</A></LI>
<LI>
<A HREF="http://www.gnu.org/software/bayonne">http://www.gnu.org/software/bayonne</A></LI>
</UL>
</P>
<H2><A NAME="ss11.2">11.2 Commercial link</A>
</H2>

<P>
<UL>
<LI>
<A HREF="http://www.fatamorgana.com">Fatamorgana Computers</A></LI>
<LI>
<A HREF="http://www.itu.org">International Communication Union</A></LI>
<LI>
<A HREF="http://www.voicetronix.com.au">Voicetronix web site</A></LI>
<LI>
<A HREF="http://www.quicknet.net">Quicknet Web site</A></LI>
<LI>
<A HREF="http://www.cisco.com">Cisco Systems</A></LI>
<LI>
<A HREF="www.metropark.com">www.metropark.com</A></LI>
<LI>
<A HREF="www.nbxsoftware.com">www.nbxsoftware.com</A></LI>
</UL>
</P>

</BODY>
</HTML>
