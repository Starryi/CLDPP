<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>How to guard against security vulnerabilities in PHP-Nuke</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PHP-Nuke: Management and Programming"
HREF="index.html"><LINK
REL="UP"
TITLE="Security "
HREF="security.html"><LINK
REL="PREVIOUS"
TITLE="Common PHP-Nuke security vulnerabilities"
HREF="common-php-nuke-security-vulnerabilities.html"><LINK
REL="NEXT"
TITLE="How to ban IP addresses"
HREF="ban-ip-addresses.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PHP-Nuke: Management and Programming</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="common-php-nuke-security-vulnerabilities.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 23. Security</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="ban-ip-addresses.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="GUARD-SECURITY-VULNERABILITIES-IN-PHP-NUKE"
>23.4. How to guard against security vulnerabilities in PHP-Nuke</A
></H1
><P
>After all the detailed excusion to the security risks lurking around your pristine installation of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> that was undertaken in the previous sections, you may be asking yourself if there is anything you can do to avoid them. Indeed, following the advice in this section, will render your <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> system as secure as can be. </P
><P
>But there is also one point you should understand while talking about software (and especially Web software) security: there is no absolute security! You can make life very difficult for the hypothetical &#8220;malicious user&#8221;, but then, given enough (time, money and criminal energy) resources, every system connected to the Web can become vulnerable. Thus, if your carreer depends on this, hire a security professional to check the code for you. </P
><P
>However, even if you are on your own, you can still do a lot to guard against security vulnerabilities. You can:</P
><P
></P
><UL
><LI
><P
>Stay current on developments and apply security fixes (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#SECURITY-FIXES"
>Section 23.4.1</A
>).</P
></LI
><LI
><P
>Take the right security measures (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#SECURITY-MEASURES"
>Section 23.4.2</A
>).</P
></LI
><LI
><P
>Perform a security audit of the code yourself (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#SECURITY-AUDIT"
>Section 23.4.3</A
>).</P
></LI
><LI
><P
>Check file permissions (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#PERMISSIONS2"
>Section 23.4.4</A
>) and cookie settings (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#COOKIES"
>Section 23.4.5</A
>).</P
></LI
></UL
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.png"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>Disable HTML and uploads!</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Many of the most important security risks arise from the fact that HTML is allowed in the News and Forums, or that users are allowed to upload avatars or mail attachments to the web server. You can thus diminish the attack potential against your site, if you disable HTML and uploads. But of course, this will not protect you from everything, so read on!
<SPAN
CLASS="INLINEMEDIAOBJECT"
><IMG
SRC="./images/icon_wink.png"></SPAN
></P
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SECURITY-FIXES"
>23.4.1. Security fixes</A
></H2
><P
>No piece of software is free from security related bugs. <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> is no exception to this rule. Due to its open source nature, everyone can search the source code for security holes. This is done by professionals and amateurs alike. When a security hole is found (i.e. a bug in the code that has the potential to enable unauthorized access and/or execution of code, leading to a compromise of the system's integrity or function), a bug fix will appear that closes it. It is of utmost importance to the integrity of your data to follow the developement in this area and apply those &#8220;security fixes&#8221; as soon as they become available.</P
><P
>If you run a fresh version of the analyze.php script (see <A
HREF="common-installation-problems.html#ANALYZE-PHP"
>Section 3.9.1.3</A
>), it will not only test your database connection and report errors, it will also warn you of any vulnerabilities regarding your <ACRONYM
CLASS="ACRONYM"
>PHP</ACRONYM
> version (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#FIG-ANALYZE-WARNING-PHP"
>Figure 23-1</A
>).

<DIV
CLASS="FIGURE"
><A
NAME="FIG-ANALYZE-WARNING-PHP"
></A
><P
><B
>Figure 23-1.    <ACRONYM
CLASS="ACRONYM"
>PHP</ACRONYM
> security warning from analyze.php.
   </B
></P
><DIV
CLASS="MEDIAOBJECT"
><P
><IMG
SRC="./images/analyze-warning-php.png"><DIV
CLASS="CAPTION"
><P
>PHP security warning from analyze.php.</P
></DIV
></P
></DIV
></DIV
></P
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.png"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>Run a fresh analyze.php regularly</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>analyze.php will also test other components of your system, such as MySQL, various modules etc. for known vulnerabilities, so you should run a fresh copy at regular intervalls (an old copy will not report new vulnerabilities, of course!). But it is also important that you do not rely completely on one script. There is no way around subscribing to the security mailing lists, if you want to stay current on developments in the software security field. </P
></TD
></TR
></TABLE
></DIV
><P
>You should register yourself to well-known security advisories, like those from <A
HREF="http://www.secunia.com"
TARGET="_top"
>secunia</A
>, <A
HREF="http://www.securityfocus.com"
TARGET="_top"
>securityfocus</A
>, <A
HREF="http://www.cert.org"
TARGET="_top"
>CERT</A
>, <A
HREF="http://neworder.box.sk"
TARGET="_top"
>http://neworder.box.sk</A
> or <A
HREF="http://www.linuxsecurity.com"
TARGET="_top"
>linuxsecurity</A
> and filter those that are relevant to <ACRONYM
CLASS="ACRONYM"
>PHP</ACRONYM
> and <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> (unless you plan to read emails all day!). </P
><P
>Upon reading about a new vulnerability for PHP-Nuke, you should reach the pages of</P
><P
></P
><UL
><LI
><P
><A
HREF="http://phpnuke.org"
TARGET="_top"
>PHP-Nuke</A
></P
></LI
><LI
><P
><A
HREF="http://www.nukecops.com"
TARGET="_top"
>nukecops</A
></P
></LI
><LI
><P
><A
HREF="http://www.nukeresources.com"
TARGET="_top"
>nukeresources</A
></P
></LI
><LI
><P
><A
HREF="http://www.nukesecurity.com"
TARGET="_top"
>nukesecurity</A
></P
></LI
></UL
><P
>looking for available security fixes to apply. For example, <A
HREF="http://www.nukeresources.com"
TARGET="_top"
>nukeresources</A
> collects all (security or not) fixes to the 6.x version of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> under <A
HREF="http://www.nukeresources.com/downloads-cat-63.html"
TARGET="_top"
>Downloads Category: PHPNuke 6.x / Fixes</A
>.</P
><P
>If a new <ACRONYM
CLASS="ACRONYM"
>PHP</ACRONYM
> vulnerability has been discovered, then the first place to run to, is <A
HREF="http://www.php.net"
TARGET="_top"
>php.net</A
>.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SECURITY-MEASURES"
>23.4.2. Security measures</A
></H2
><P
><DIV
CLASS="FIGURE"
><A
NAME="FIG-ANALYZE-WARNING-SITEKEY"
></A
><P
><B
>Figure 23-2.    Site key security warning from analyze.php.
   </B
></P
><DIV
CLASS="MEDIAOBJECT"
><P
><IMG
SRC="./images/analyze-warning-sitekey.png"><DIV
CLASS="CAPTION"
><P
>Site key security warning from analyze.php.</P
></DIV
></P
></DIV
></DIV
></P
><P
>Staying current on security fixes is only part of the story. The other part is a conservatively configured system. Regarding security, you cannot be overly conservative, so consider taking the following general security measures:</P
><P
></P
><UL
><LI
><P
>Apply any security fixes available for your <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> version (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#SECURITY-FIXES"
>Section 23.4.1</A
>).</P
></LI
><LI
><P
>Do not allow HTML in the news, forums, private messages or any other areas of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
>. Use BBcode instead.</P
></LI
><LI
><P
>Do not allow uploading of images (e.g. for a gallery), avatars (e.g. for a forum) or mail attachments, in any module, be it a forum, gallery, mail or whatever.</P
></LI
><LI
><P
>As long as the mailattach.php file is on the server, even if the module is not active, you can get hacked. Currently, the best fix is to delete the file (see <A
HREF="http://www.nukeforums.com/forums/viewtopic.php?t=15076"
TARGET="_top"
>mailattach</A
>). analyze.php (see <A
HREF="common-installation-problems.html#ANALYZE-PHP"
>Section 3.9.1.3</A
>) will issue a waring, if it finds the file in your installation (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#FIG-ANALYZE-WARNING-WEBMAIL"
>Figure 23-3</A
>).</P
></LI
><LI
><P
>Delete the nuke.sql file from your web server, as soon as you finished installation and everything is working correctly. First, you will not need it any more and second, if someone takes control of your site, he could have the nice idea to rerun the nuke.sql file on your database, thus bringing it to its original, pristine state (see <A
HREF="http://www.nukeforums.com/forums/viewtopic.php?p=55170"
TARGET="_top"
>Hacked - now what?</A
> for a real story).</P
></LI
><LI
><P
>You should also change your site key. The best time to do this is during installation, while entering all the other parameters in config.php. analyze.php will issue a warning, if it finds the default site key in your config.php (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#FIG-ANALYZE-WARNING-SITEKEY"
>Figure 23-2</A
>). A site key is an important but often overlooked security feature of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
>. It is used in generating security codes for authentication and resource access (e.g. downloads) purposes (see <A
HREF="http://phpnuke.org/modules.php?name=News&#38;file=article&#38;sid=6555"
TARGET="_top"
>PHP-Nuke Security GFX Mapping - Potential Risk</A
> for details on how this is done). Each installation of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> system requires choosing a unique site key. </P
><P
>You can use the <A
HREF="http://mil-sim.net/modules.php?name=Downloads&#38;op=getit&#38;lid=21"
TARGET="_top"
>Electric Dice</A
> for this purpose. ElectricDice generates true random site keys that can be easily pasted into the config.php file. As opposed to pseudo random numbers generated by computers, Electric Dice uses numbers generated from atmospheric noise in radio waves - a proven entropy source. ElectricDice is useful for both first time installation as well as updating your existing site key. </P
></LI
></UL
><P
><DIV
CLASS="FIGURE"
><A
NAME="FIG-ANALYZE-WARNING-WEBMAIL"
></A
><P
><B
>Figure 23-3.    WebMail security warning from analyze.php.
   </B
></P
><DIV
CLASS="MEDIAOBJECT"
><P
><IMG
SRC="./images/analyze-warning-webmail.png"><DIV
CLASS="CAPTION"
><P
>WebMail security warning from analyze.php.</P
></DIV
></P
></DIV
></DIV
></P
><P
>To reduce the risk of SQL injection (see <A
HREF="common-php-nuke-security-vulnerabilities.html#SQL-INJECTION-WITH-PHP-NUKE"
>Section 23.3.2</A
>) and cross-site scripting (see <A
HREF="common-php-nuke-security-vulnerabilities.html#CROSS-SITE-SCRIPTING-WITH-PHP-NUKE"
>Section 23.3.1</A
>), you can do the following:</P
><P
></P
><UL
><LI
><P
>Set &#8220;magic_quotes&#8221; to ON in php.ini. When magic_quotes are on, all ' (single-quote), " (double quote), \ (backslash) and NUL's are escaped with a backslash automatically, see <A
HREF="http://www.php.net/ref.info"
TARGET="_top"
>PHP Options and Information</A
>.</P
></LI
><LI
><P
>Set &#8220;register_globals&#8221; to OFF in php.ini. When on, register_globals will inject (poison) your scripts will all sorts of variables, like request variables from html forms. This coupled with the fact that <ACRONYM
CLASS="ACRONYM"
>PHP</ACRONYM
> doesn't require variable initialization means writing insecure code is that much easier (see <A
HREF="http://www.php.net/register_globals"
TARGET="_top"
>Using Register Globals</A
>).</P
></LI
><LI
><P
>Follow a well-thought user rights concept. Do not give users more rights to the database than it is absolutely necessary.</P
></LI
></UL
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/note.png"
HSPACE="5"
ALT="Note"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>PHP-Nuke now works with register_globals set to OFF!</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Contrary to the older 5.x versions that needed some extra script for this, newer versions (starting 6.0) of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> will work with register_globals set to OFF in the php.ini! Thus, there is no need to renounce this security measure, as far as  <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> is concerned. The reason is the following code that is now included in the start of mainfile.php:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>if (!ini_get("register_globals")) {
 import_request_variables('GPC');
} </PRE
></FONT
></TD
></TR
></TABLE
><P
>Since every module includes mainfile.php, it also includes the above code, and will thus work with register_globals OFF. If, for some unusual reason, your module does not include mainfile.php, just add the above lines of code to make it work with register_globals OFF.</P
></TD
></TR
></TABLE
></DIV
><P
>To avoid path disclosure (see <A
HREF="common-php-nuke-security-vulnerabilities.html#PATH-DISCLOSURE-WITH-PHP-NUKE"
>Section 23.3.3</A
>), you can:</P
><P
></P
><UL
><LI
><P
>Set "display_errors" to off in php.ini or </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>php_flag display_errors off</PRE
></FONT
></TD
></TR
></TABLE
><P
>in .htaccess (see <A
HREF="htaccess-file.html"
>Section 25.4</A
>) or in an http configuration file.</P
></LI
><LI
><P
>Use PHP's error handling functions to disable error reporting or alter the handling (to email an admin for example, and display a less explicit error). </P
></LI
></UL
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.png"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="MIDDLE"
><B
>Security Tip (from the <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> INSTALL file)</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>It's a good choice to put your config.php file outside the Web Server path, then you can create a new config.php with the line: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#60;?php include("../config.php"); ?&#62; </PRE
></FONT
></TD
></TR
></TABLE
></TD
></TR
></TABLE
></DIV
><P
>Some of the above measures may make <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> less attractive to you, or your visitors, who would very much like, for example, to be able to write in HTML, upload images at will, or attach nice files to their mails. It is up to you to weigh the risks and the merits of allowing or disabling a functionality. A small, amateur site may take a different approach than a big, professional one. </P
><P
>And remember  that the most secure website is one that is offline. <SPAN
CLASS="INLINEMEDIAOBJECT"
><IMG
SRC="./images/icon_wink.png"></SPAN
> </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SECURITY-AUDIT"
>23.4.3. Security audit</A
></H2
><P
>Unfortunately, the above measures will not be enough to protect you, if the code is flawed. Thus, the most effective measure, is the one that needs a programmer and a security specialist together:</P
><P
>If you are a programmer, or if you hire one: inspect (audit) the code and &#8220;sanitize&#8221; the data, whenever it is input by the user. Sanitization is best achieved through a default-deny regular expression, like [^a-zA-Z0-9] - whatever matches the expression should be removed. The regular expression acts like a filter on user input. Make that filter as narrow as possible: if at all possible, allow only numbers, else letters and numbers. Make sure that any other characters, like symbols or punctuation, are converted to their HTML entity equivalents. Further, prefix and append a quote to all user input. For more programming tips, see <A
HREF="http://www.nextgenss.com/papers/advanced_sql_injection.pdf"
TARGET="_top"
>Advanced SQL Injection In SQL Server Applications</A
> and <A
HREF="http://www.spidynamics.com/whitepapers/WhitepaperSQLInjection.pdf"
TARGET="_top"
>Web Applications and SQL Injection</A
>.</P
><P
>If you rather prefer an explicit list of what to block, try this one, taken from <A
HREF="http://www.securiteam.com/securityreviews/5DP0N1P76E.html"
TARGET="_top"
>SQL Injection Walkthrough</A
>:</P
><A
NAME="AEN16505"
></A
><BLOCKQUOTE
CLASS="BLOCKQUOTE"
><P
>Filter out characters like single quote, double quote, slash, backslash, semicolon, extended characters like NULL, carriage return, newline, etc, in all strings from:</P
><P
></P
><UL
><LI
><P
>Input from users</P
></LI
><LI
><P
>Parameters from URLs</P
></LI
><LI
><P
>Values from cookies</P
></LI
></UL
><P
>For a numeric value, convert it to an integer before parsing it into an SQL statement.</P
></BLOCKQUOTE
><P
>Currently, <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> checks with the following code for the presence of &#8220;bad code&#8221; in GET parameters:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>foreach ($_GET as $secvalue) {
    if ((eregi("&#60;[^&#62;]*script*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*object*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*iframe*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*applet*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*meta*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*style*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*form*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("&#60;[^&#62;]*img*\"?[^&#62;]*&#62;", $secvalue)) ||
        (eregi("\([^&#62;]*\"?[^)]*\)", $secvalue)) ||
        (eregi("\"", $secvalue))) {
        die ("I don't like you...");
    }
}</PRE
></FONT
></TD
></TR
></TABLE
><P
>Notice that the expressions in the first argument of the eregi functions above are regular expressions (see <A
HREF="regular-expressions.html"
>Section 25.3</A
>). Their meaning is the following:</P
><P
>For the sake of example, we explain the first regular expression</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#60;[^&#62;]*script*\"?[^&#62;]*&#62;</PRE
></FONT
></TD
></TR
></TABLE
><P
>meaning "anything that starts with "&#60;" (that's the first "&#60;" in the expression), immediately followed by zero or more occurrences (that's the "*" after the [^&#62;]) of a character that is NOT (that's the "^" inside the "[^&#62;]") "&#62;" (that's what follows the "^" in the square brackets), immediately followed by "script", followed by zero or more occurrences of "t" (that's the "*" after "script", but it is wrong here, you probably should have a blank between "script" and "*", meaning zero or more blanks....but let's continue ), immediately followed by zero or one """ (that's the ""?" - don't let the double quotes mislead you, what we mean is "zero or one double quote" ), immediately followed by zero or more occurrences of any character that is not "&#62;" (that's the "[^&#62;]*" again...)". Phew...</P
><P
>As it stands, an expression like that will match everything that contains &#8220;&#60; scriptxxxxxxxxx&#8221;, where the x's stay for &#8220;whatever&#8221;. This may be too restrictive for you, as you might want to allow words that contain &#8220;script&#8221; as part of the word, but not the word &#8220;script&#8221; itself. Try the following regular expression instead:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#60;[^&#62;]*script +\"?[^&#62;]*&#62;</PRE
></FONT
></TD
></TR
></TABLE
><P
>Uhmm...what's the difference? We have inserted a blank between "script" and the "*" immediately following it and have replaced the "*" with the "+". Thus, the "+" will refer to the preceding blank (meaning "one or more blanks", not "zero or more t's", as in the case of the original "script*"). Remember, the "*" and the "+" and the "?" all refer to the <EM
>preceding</EM
> "atom" - it is NOT like "dir *.exe" here!</P
><P
>Small, but crucial! <SPAN
CLASS="INLINEMEDIAOBJECT"
><IMG
SRC="./images/icon_cool.png"></SPAN
></P
><P
>Further, go to modules/Forums/admin/common.php and have a look at the start of the code. There you can see how to use <A
HREF="http://www.php.net/manual/en/function.addslashes.php"
TARGET="_top"
>addslashes</A
> to "escape" potentially dangerous characters (like quotes). Since we are dealing only with GET parameters in this discussion, you need only the part that is relevant to the $HTTP_GET_VARS array:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>//
// addslashes to vars if magic_quotes_gpc is off
// this is a security precaution to prevent someone
// trying to break out of a SQL statement.
//
if( !get_magic_quotes_gpc() )
{
        if( is_array($HTTP_GET_VARS) )
        {
                while( list($k, $v) = each($HTTP_GET_VARS) )
                {
                        if( is_array($HTTP_GET_VARS[$k]) )
                        {
                                while( list($k2, $v2) = each($HTTP_GET_VARS[$k]) )
                                {
                                        $HTTP_GET_VARS[$k][$k2] = addslashes($v2);
                                }
                                @reset($HTTP_GET_VARS[$k]);
                        }
                        else
                        {
                                $HTTP_GET_VARS[$k] = addslashes($v);
                        }
                }
                @reset($HTTP_GET_VARS);
        }
}</PRE
></FONT
></TD
></TR
></TABLE
><P
><A
HREF="http://www.nukeresources.com"
TARGET="_top"
>Chatserv</A
> has recently undergone <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> a detailed scrutiny from the security point of view and came up with <A
HREF="http://www.nukeresources.com/article492.html"
TARGET="_top"
>security patches for all 6.x and 7.x versions of PHP-Nuke</A
> that cover:</P
><P
></P
><UL
><LI
><P
>New Abstraction layer conversion.</P
></LI
><LI
><P
>Variables quoted on all sql queries.</P
></LI
><LI
><P
>Security check added to most variables.</P
></LI
><LI
><P
>Bugs in core files fixed.</P
></LI
><LI
><P
>Previous sec-fix patches applied.</P
></LI
></UL
><P
>You should include Chatserv's patches in your security audit and try to stay current on the developments in this area as much as you can. </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="PERMISSIONS2"
>23.4.4. Permissions on folders and files</A
></H2
><P
>This section is of importance only to those who use <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> under Linux/Unix (this is true for the greater part of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> sites that are hosted by providers, and often also those who test locally use Linux).</P
><P
>You have already set the right permissions on folders and files during installation (see <A
HREF="installation-process.html#PERMISSIONS"
>Section 3.2.3</A
>, where you will find a more in-depth treatment of the concept of file permissions). However, it is a good idea to think about permissions once again, in a security context.</P
><P
>Burzi says that the directories should be assigned a mode of 777, the files a mode of 666, but we may calmly let our <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> do its work under more restrictive permissions, as illustrated below:</P
><P
></P
><UL
><LI
><P
>config.php (666)</P
></LI
><LI
><P
>backend.php (666)</P
></LI
><LI
><P
>ultramode.txt (666)</P
></LI
><LI
><P
>All directories (755)</P
></LI
><LI
><P
>Other files (644)</P
></LI
></UL
><P
>The files config.php, backend.php, ultramode.txt must have the write permissions because :</P
><P
></P
><UL
><LI
><P
>For config.php editing the preferences we will write this file modifying the text.</P
></LI
><LI
><P
>For the backend and ultramode on the other side, we will write them (in an automatic way) modifying the titles and abstracts of the news. </P
></LI
></UL
><P
>There is however something particular we have to take into account: if we use modules that upload files in some directories, their permissions wil have to be raised. As an example, consider the IndyNews module, a non standard module that makes it possible to enclose files and images in articles. The structure of the module is the following:</P
><P
></P
><UL
><LI
><P
>modules/indynews/media</P
></LI
></UL
><P
>In the inside of the &#8220;indynews&#8221; folder the permissions of the folder &#8220;media&#8221; would have to be 777, due to an override problem, the 777 permissions will have to be imposed on everything that is below &#8220;modules&#8221;. For this reason, everything that resides in &#8220;modules&#8221; will be in 777 mode and this could cause a vulnerability. A solution is to move the folder that will have to accommodate the uploaded files to the outside of the modules folder, even to the document root, changing inside the module all the references to it.</P
><P
>Doing so will leave one single folder in root with permissions set to 777. But you still have to consider the risks associated with such a decision. To quote the <A
HREF="http://free-source.com/files/phpgw-howto.html#2.3"
TARGET="_top"
>phpGroupWare Installation and security HOWTO</A
>:</P
><A
NAME="AEN16625"
></A
><BLOCKQUOTE
CLASS="BLOCKQUOTE"
><P
>As discussed earlier, having a world writable file in you web root is a rather serious security risk, especially if that file will accept raw user data. It becomes trivial for someone to add php code or any type of script or cgi code your server supports and execute it on your system. Risk is reduced slightly because it would be executed as the "anonymous" nobody user that apache runs under but still would allow access to your ...[ed. config.php] and thus your database, as well as access to /etc/* where all sorts of fun and dangerous information could be abused.</P
></BLOCKQUOTE
><P
>Thus, if the upload feature is of utmost importance to you, you are well advised to double-check what kinds of files your users will be allowed to upload - and test any paranoid scenario you can think of. In case of doudt, it may be safer to disable uploading at the cost of making some users unhappy. Better safe than sory.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="COOKIES"
>23.4.5. Cookies - timeout and configuration</A
></H2
><P
>PHP-Nuke makes heavy use of cookies, be it for user authentication, or admin authentication. The cookies are text files that are saved on our computers and contain various information that is read when we enter a certain site. In the case of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> the information saved there pertains to the user, the chosen theme and the language used. </P
><P
>The cookie is also the instrument that enables us not to have to retype the password each time we log in. This way, each time we access a <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> site, the cookie works for us by managing the login operation.</P
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="COOKIE-HIJACK"
>23.4.5.1. Cookie hijack</A
></H3
><P
>The problem is that if the cookie does not have an expiry date low enough, someone can to steal it from us and be able to access the site as a user or administrator. This is possible for a series of reasons:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>The cookie of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> has a life duration close to infinite (31536000 seconds)</P
></LI
><LI
><P
>Explorer (most used browser, unfortunately) has vulnerabilities that allow the execution of malicious scripts on the client that &#8220;steal&#8221; the cookie from the user and send it to the &#8220;burglar&#8221;.</P
></LI
><LI
><P
>PHP-Nuke does not succeed in filtering all the malicious scripts (or, to put it better, Internet Explorer is so stupid that corrects inserted scripts with the wrong syntax in order not to be recognized).</P
></LI
></OL
><P
>Let's show a concrete example of how a script kiddie (those who hold themselves for hackers, but they are not...) can try to obtain administrator rights on our site:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>The script kiddie inserts a script that supposedly contains news: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#60; vb script give the cookie to me and send it to the server xyz&#62;</PRE
></FONT
></TD
></TR
></TABLE
><P
>that is not filtered by the function check_words() of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
>.</P
></LI
><LI
><P
>The administrator of <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> opens the page up with Internet Explorer!!! (This hack does not work if you're using Mozilla, or better yet, any <SPAN
CLASS="PRODUCTNAME"
>Linux</SPAN
> browser). The list of the news waiting to be approved for publishing is seen by the administrator. When he goes to look at the Submissions, Internet Explorer (stupidly) corrects the vbscript in this way: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#60;vbscript&#62;(script kiddies commands go here)</PRE
></FONT
></TD
></TR
></TABLE
><P
>succeeding to interpret the wrong syntax in the correct way (!!!), taking the cookie and sending it to the script kiddie.</P
></LI
><LI
><P
>The script kiddie puts the cookie among the other ones of his own, connects to the site and... is recognized as being the administartor!!!</P
></LI
></OL
><P
>But how is it possible to protect ourselves from this type of hack?</P
><P
>There are some solutions that should increase the security for our administration area:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>First of all STOP using Internet Explorer as a browser and pass the seat to <A
HREF="http://www.mozilla.org"
TARGET="_top"
>Mozilla</A
>. Mozilla is a browser that supports all sites in an optimal way and is not plagued by all the vulnerabilities of Microsoft. If you use <SPAN
CLASS="PRODUCTNAME"
>Linux</SPAN
> instead you won't encounter any problems of this sort...</P
><P
></P
><OL
TYPE="a"
><LI
><P
>In case you want to continue to use the Explorer, you should at least download the patches from <A
HREF="http://www.microsoft.com"
TARGET="_top"
>Microsoft</A
>.</P
></LI
></OL
></LI
><LI
><P
>Disable, where possible, the insertion of HTML tags (for example in the forum)</P
></LI
><LI
><P
>Narrow down the life of cookies. If for example we set up the life of the cookie to two hours, the script kiddie will be forced to use the cookie within that period, this limits much of their ability to act in time.</P
><P
>If instead we leave the life of the cookie to its preset value, the script kiddie may use our cookie even for 1 month after it was stolen.</P
><P
>How to set up the duration of the administartor cookie? The cookie is set up in the file includes/auth.php and the function to modify it is the following:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>if ((isset($aid)) &#38;&#38; (isset($pwd)) &#38;&#38; ($op == "login")) {
    if($aid! = "" AND $pwd!="") {
        $pwd = md5($pwd);
        $result=sql_query("select pwd, admlanguage from "$prefix."_authors  where aid='$aid'", $dbi);
        list($pass, $admlanguage)=sql_fetch_row($result, $dbi);
        if($pass == $pwd) {
            $admin = base64_encode("$aid:$pwd:$admlanguage");
            setcookie("admin", "$admin",time()+7200);
            unset($op);
        }
    }
}</PRE
></FONT
></TD
></TR
></TABLE
><P
>As you see we have modified the life duration of the second cookie from 2592000 (a month) to 7200 seconds (two hours). As you can easily see, we have reduced the action radius of the script kiddie down from one month to two hours.</P
></LI
><LI
><P
>A much more effective tag filter is realized through the check_html and filter_text functions in mainfile.php (see <A
HREF="allow-special-html-tags.html"
>Section 16.1</A
>). The admissible tags are defined in the file config.php in the $AllowableHTML array, these are valid for the comments, the insertion of news and many other user inputs (see <A
HREF="allow-special-html-tags.html#TAB-FILTER-TEXT"
>Table 16-1</A
> and <A
HREF="allow-special-html-tags.html#TAB-CHECK-HTML"
>Table 16-2</A
> for all instances of a call to the filter_text and check_html functions respectively).</P
></LI
></OL
><P
>All these actions and a correct configuration of the permissions as illustrated in <A
HREF="installation-process.html#PERMISSIONS"
>Section 3.2.3</A
> and <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#PERMISSIONS2"
>Section 23.4.4</A
>, should guarantee us a good security for our site. It is also important to closely follow the security warnings for <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> that are brought up on the various security advisories (see <A
HREF="guard-security-vulnerabilities-in-php-nuke.html#SECURITY-FIXES"
>Section 23.4.1</A
>).</P
></DIV
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="USER-COOKIE-CHANGE-DURATION"
>23.4.5.2. Changing the duration of the user cookie</A
></H3
><P
>If you want to redefine the duration of the <EM
>user</EM
> cookie (as opposed to the administrator cookie), you have to edit the file modules/Your_Account/index.php. There, find the function docookie():</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>function docookie($setuid, $setusername, $setpass, $setstorynum, $setumode, 
$setuorder, $setthold, $setnoscore, $setublockon, $settheme, $setcommentmax) {
    $info = base64_encode("$setuid:$setusername:$setpass:$setstorynum:$setumode:
$setuorder:$setthold:$setnoscore:$setublockon:$settheme:$setcommentmax");
    setcookie("user","$info",time()+2592000);
}</PRE
></FONT
></TD
></TR
></TABLE
><P
>and change the 2592000 seconds (30 days) to the duration of your choice. </P
><P
>If you want the user cookie to expire as soon as the user closes his browser, to avoid problems with internet cafes and similar situations where a user might forget to log off your site and leave his browser still running, thus making it trivial for others to use his <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> account, you should set a <EM
>temporary</EM
> cookie. This is done by removing the time altogether:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>setcookie("user","$info");</PRE
></FONT
></TD
></TR
></TABLE
><P
>See:</P
><P
></P
><UL
><LI
><P
><A
HREF="http://www.php.net/setcookie"
TARGET="_top"
>PHP Manual on setcookie</A
>,</P
></LI
><LI
><P
><A
HREF="http://www.nukeforums.com/forums/viewtopic.php?topic=15342&#38;forum=26"
TARGET="_top"
>user Log off</A
>,</P
></LI
><LI
><P
><A
HREF="http://www.nukeforums.com/forums/viewtopic.php?t=14003"
TARGET="_top"
>cookie expire time</A
></P
></LI
><LI
><P
><A
HREF="http://www.nukeforums.com/forums/viewtopic.php?p=57872"
TARGET="_top"
>how to force all users to relogin</A
> and </P
></LI
><LI
><P
><A
HREF="http://www.karakas-online.de/forum/viewtopic.php?t=78"
TARGET="_top"
>automatic logout</A
></P
></LI
></UL
><P
>for discussions on this subject.</P
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="common-php-nuke-security-vulnerabilities.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="ban-ip-addresses.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Common <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> security vulnerabilities</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="security.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>How to ban IP addresses</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>