<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>How to allow special HTML tags</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PHP-Nuke: Management and Programming"
HREF="index.html"><LINK
REL="UP"
TITLE="Modifying mainfile.php"
HREF="modifying-mainfile-php.html"><LINK
REL="PREVIOUS"
TITLE="Modifying mainfile.php"
HREF="modifying-mainfile-php.html"><LINK
REL="NEXT"
TITLE="How to change the order of messages"
HREF="change-order-of-messages.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PHP-Nuke: Management and Programming</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="modifying-mainfile-php.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 16. Modifying mainfile.php</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="change-order-of-messages.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="ALLOW-SPECIAL-HTML-TAGS"
>16.1. How to allow special HTML tags</A
></H1
><P
>User input is checked and filtered automatically by <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
>. For this purpose the functions filter_text and check_html are used. filter_text checks and replaces bad words, then calls check_html, which in turn checks for HTML tags and strips them completely off, if the second parameter is &#8220;nohtml&#8221;.</P
><P
><A
HREF="allow-special-html-tags.html#TAB-FILTER-TEXT"
>Table 16-1</A
> shows all modules that call filter_text, together with the line the call is made on. You can see that filter_text is used to filter</P
><P
></P
><UL
><LI
><P
>the text of a mail response in the WebMail module</P
></LI
><LI
><P
>the comments in the News module</P
></LI
><LI
><P
>the comments in the Reviews module</P
></LI
><LI
><P
>the subject, story and extended story text in the Submit_News module</P
></LI
><LI
><P
>the subject and comments in the Surveys module</P
></LI
><LI
><P
>the username and message in the Your_Account module</P
></LI
></UL
><P
><DIV
CLASS="TABLE"
><A
NAME="TAB-FILTER-TEXT"
></A
><P
><B
>Table 16-1. Calls to filter_text from <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> modules (v.6.8)</B
></P
><TABLE
BORDER="1"
RULES="all"
CLASS="CALSTABLE"
><COL
WIDTH="1*"
ALIGN="LEFT"
TITLE="COL0"><COL
WIDTH="1*"
ALIGN="LEFT"
TITLE="COL1"><TBODY
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Module</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Line with call to filter_text</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/WebMail/readmail.php     </P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$res = filter_text($res); // Security fix by Ulf Harnhammar 2002</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/News/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comment = FixQuotes(nl2br(filter_text($comment)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/News/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$subject = FixQuotes(filter_text($subject, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/News/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comment = FixQuotes(filter_text($comment));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comments = FixQuotes(nl2br(filter_text($comments)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Submit_News/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$subject = FixQuotes(filter_text($subject, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Submit_News/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$story = FixQuotes(nl2br(filter_text($story)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Submit_News/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$storyext = FixQuotes(nl2br(filter_text($storyext)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Submit_News/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$story = FixQuotes(filter_text($story));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Submit_News/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$storyext = FixQuotes(filter_text($storyext));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Surveys/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$subject = FixQuotes(filter_text($subject, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Surveys/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comment = FixQuotes(nl2br(filter_text($comment)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Surveys/comments.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comment = FixQuotes(filter_text($comment));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>filter_text($username);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>if ($bio) { filter_text($bio); $bio = $EditedMessage; $bio = FixQuotes($bio); }</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$the_message = FixQuotes(filter_text($the_message, "nohtml"));</P
></TD
></TR
></TBODY
></TABLE
></DIV
></P
><P
>check_html, in turn, is not only called from filter_text, but also in its own right. <A
HREF="allow-special-html-tags.html#TAB-CHECK-HTML"
>Table 16-2</A
> shows all modules that call check_html and the line it is called on. You can see that check_html is called to check the HTML input in</P
><P
></P
><UL
><LI
><P
>the query string in the Downloads, Encyclopedia, Web Links and Search sections</P
></LI
><LI
><P
>the title, text, reviewer, URL text and comments in the Reviews module</P
></LI
><LI
><P
>user name, e-mail, various user info fields in the Your Account module</P
></LI
><LI
><P
>bodytext and comments in the Journal module</P
></LI
></UL
><P
><DIV
CLASS="TABLE"
><A
NAME="TAB-CHECK-HTML"
></A
><P
><B
>Table 16-2. Calls to check_html from <SPAN
CLASS="APPLICATION"
>PHP-Nuke</SPAN
> modules (v.6.8)</B
></P
><TABLE
BORDER="1"
RULES="all"
CLASS="CALSTABLE"
><COL
WIDTH="1*"
ALIGN="LEFT"
TITLE="COL0"><COL
WIDTH="1*"
ALIGN="LEFT"
TITLE="COL1"><TBODY
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Module</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Line with call to filter_text</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Downloads/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$query = check_html($query, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Encyclopedia/search.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$query = check_html($query, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Encyclopedia/search.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$query = check_html($query, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$title = stripslashes(check_html($title, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$text = stripslashes(check_html($text, ""));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$reviewer = stripslashes(check_html($reviewer, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$url_title = stripslashes(check_html($url_title, "nohtml"));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$title = stripslashes(FixQuotes(check_html($title, "nohtml")));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$text = stripslashes(Fixquotes(urldecode(check_html($text, ""))));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Reviews/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$comments = stripslashes(FixQuotes(check_html($comments)));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Search/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$query = stripslashes(check_html($query, nohtml));</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Web_Links/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$query = check_html($query, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$username = check_html($username, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_email = check_html($user_email, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_email = check_html($user_email, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$femail = check_html($femail, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_website = check_html($user_website, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$bio = check_html($bio, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_avatar = check_html($user_avatar, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_icq = check_html($user_icq, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_aim = check_html($user_aim, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_yim = check_html($user_yim, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_msnm = check_html($user_msnm, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_occ = check_html($user_occ, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_from = check_html($user_from, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$user_interests = check_html($user_interests, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Your_Account/index.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$realname = check_html($realname, nohtml);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Journal/display.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$row[bodytext]=check_html($row[bodytext], $strip);</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>modules/Journal/display.php</P
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>$row[comment]=check_html($row[comment], $strip);</P
></TD
></TR
></TBODY
></TABLE
></DIV
></P
><P
>check_html uses the $AllowableHTML array that is defined in config.php. The idea is that only the tags that are included in the $AllowableHTML array should be allowed. However, even if you explicitly allow the img tag in $AllowableHTML, it will be stripped away by check_html (and by filter_text, which also calls it). The line that does this is </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$str = eregi_replace("&#60;[[:space:]]* img[[:space:]]*([^&#62;]*)[[:space:]]*&#62;", ", $str);</PRE
></FONT
></TD
></TR
></TABLE
><P
>You can comment out that line - though it is certainly a security issue (allowing people to post harmful code in img tags). </P
><P
>You can also comment out the line that eliminates all anchor attributes exept href in the &#60;a&#62; tag:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$str = eregi_replace("&#60;a[^&#62;]*href[[:space:]]*=[[:space:]]*\"?[[:space:]]*([^\" &#62;]*)[[:space:]]*\"?[^&#62;]*&#62;", '&#60;a href="\\1"&#62;', $str); # "</PRE
></FONT
></TD
></TR
></TABLE
><P
>These changes will affect the checks done at all places shown in both <A
HREF="allow-special-html-tags.html#TAB-FILTER-TEXT"
>Table 16-1</A
> and  <A
HREF="allow-special-html-tags.html#TAB-CHECK-HTML"
>Table 16-2</A
>, so again, be careful with security issues. You have to trust your users to give them this comfort.</P
><P
>Put the tags you want to allow in the $AllowableHTML array in the config.php file. Here is a (quite liberal) example:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$AllowableHTML = array("b"=&#62;1,
         "i"=&#62;1,
         "a"=&#62;2,
         "em"=&#62;1,
         "br"=&#62;1,
         "strong"=&#62;1,
         "blockquote"=&#62;1,
         "tt"=&#62;1,
         "li"=&#62;1,
         "ol"=&#62;1,
         "H1"=&#62;1,
         "H2"=&#62;1,
         "H3"=&#62;1,
         "H4"=&#62;1,
         "center"=&#62;1,
         "img"=&#62;2,
         "alt"=&#62;1,
         "table"=&#62;2,
         "tr"=&#62;2,
         "td"=&#62;2,
         "p"=&#62;2,
         "div"=&#62;2,
         "font"=&#62;2,
         "p"=&#62;1,
         "p"=&#62;1,
         "ul"=&#62;1);</PRE
></FONT
></TD
></TR
></TABLE
><P
>The numbers that appear next to each tag have the following meaning:</P
><P
></P
><UL
><LI
><P
>a 1 means the tag does not accept any attributes</P
></LI
><LI
><P
>a 2 indicates that the tag may also contain attributes</P
></LI
></UL
><P
>See also <A
HREF="config-php-file.html"
>Section 3.7</A
>.</P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="modifying-mainfile-php.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="change-order-of-messages.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Modifying mainfile.php</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="modifying-mainfile-php.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>How to change the order of messages</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>