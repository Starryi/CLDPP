<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Spam Filtering for Mail Exchangers</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="anti-spam, anti-virus, bogus virus warnings, collateral spam, delivery status notification, dsn, exim, exim4, exiscan, exiscan-acl, greylisting, junk mail, sa-exim, smtp, spam, spamassassin, teergrubing, transaction delay"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book"><div class="titlepage"><div><div><h1 class="title"><a name="idm1"></a>Spam Filtering for Mail Exchangers</h1></div><div><h2 class="subtitle">
      How to reject junk mail in incoming SMTP transactions.
    </h2></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Tor</span> <span class="surname">Slettnes</span></h3><div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:tor@slett.net">tor@slett.net</a>&gt;</code></p></div></div></div><div class="editor"><h4 class="editedby">Edited by</h4><h3 class="editor"><span class="firstname">Joost</span> <span class="surname">De Cock</span></h3><span class="contrib">Technical Review</span> <div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:joost.decock%20(at)%20astrid.be">joost.decock (at) astrid.be</a>&gt;</code></p></div></div></div><div class="editor"><h3 class="editor"><span class="firstname">Devdas</span> <span class="surname">Bhagat</span></h3><span class="contrib">Technical Review</span> <div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:devdas%20(at)%20dvb.homelinux.org">devdas (at) dvb.homelinux.org</a>&gt;</code></p></div></div></div><div class="editor"><h3 class="editor"><span class="firstname">Tom</span> <span class="surname">Wright</span></h3><span class="contrib">Language Review</span> <div class="affiliation"><div class="address"><p><code class="email">&lt;<a class="email" href="mailto:tom%20(at)%20maladmin.com">tom (at) maladmin.com</a>&gt;</code></p></div></div></div></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#idm53">Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#purpose">1. Purpose of this Document</a></span></dt><dt><span class="section"><a href="#audience">2. Audience</a></span></dt><dt><span class="section"><a href="#updates">3. New versions of this document</a></span></dt><dt><span class="section"><a href="#history">4. Revision History</a></span></dt><dt><span class="section"><a href="#credits">5. Credits</a></span></dt><dt><span class="section"><a href="#feedback">6. Feedback</a></span></dt><dt><span class="section"><a href="#translations">7. Translations</a></span></dt><dt><span class="section"><a href="#copyright">8. Copyright information</a></span></dt><dt><span class="section"><a href="#prerequisites">9. What do you need?</a></span></dt><dt><span class="section"><a href="#conventions">10. Conventions used in this document</a></span></dt><dt><span class="section"><a href="#organization">11. Organization of this document</a></span></dt></dl></dd><dt><span class="chapter"><a href="#background">1. Background</a></span></dt><dd><dl><dt><span class="section"><a href="#whysmtptime">1. Why Filter Mail During the SMTP Transaction?</a></span></dt><dd><dl><dt><span class="section"><a href="#statusquo">1.1. Status Quo</a></span></dt><dt><span class="section"><a href="#cause">1.2. The Cause</a></span></dt><dt><span class="section"><a href="#solution">1.3. The Solution</a></span></dt></dl></dd><dt><span class="section"><a href="#goodbadugly">2. The Good, The Bad, The Ugly</a></span></dt><dt><span class="section"><a href="#smtpintro">3. The SMTP Transaction</a></span></dt></dl></dd><dt><span class="chapter"><a href="#techniques">2. Techniques</a></span></dt><dd><dl><dt><span class="section"><a href="#smtpdelays">1. SMTP Transaction Delays</a></span></dt><dt><span class="section"><a href="#dnschecks">2. DNS Checks</a></span></dt><dd><dl><dt><span class="section"><a href="#dnsbl">2.1. DNS Blacklists</a></span></dt><dt><span class="section"><a href="#rdns">2.2. DNS Integrity Check</a></span></dt></dl></dd><dt><span class="section"><a href="#smtpchecks">3. SMTP checks</a></span></dt><dd><dl><dt><span class="section"><a href="#helocheck">3.1. Hello (HELO/EHLO) checks</a></span></dt><dt><span class="section"><a href="#senderchecks">3.2. Sender Address Checks</a></span></dt><dt><span class="section"><a href="#rcptchecks">3.3. Recipient Address Checks</a></span></dt></dl></dd><dt><span class="section"><a href="#greylisting">4. Greylisting</a></span></dt><dd><dl><dt><span class="section"><a href="#greylisting-theory">4.1. How it works</a></span></dt><dt><span class="section"><a href="#greylisting-multimx">4.2. Greylisting in Multiple Mail Exchangers</a></span></dt><dt><span class="section"><a href="#greylisting-results">4.3. Results</a></span></dt></dl></dd><dt><span class="section"><a href="#senderauth">5. Sender Authorization Schemes</a></span></dt><dd><dl><dt><span class="section"><a href="#spf">5.1. Sender Policy Framework (SPF)</a></span></dt><dt><span class="section"><a href="#ms-cide">5.2. Microsoft Caller-ID for E-Mail</a></span></dt><dt><span class="section"><a href="#rmxplus">5.3. RMX++</a></span></dt></dl></dd><dt><span class="section"><a href="#datachecks">6. Message data checks</a></span></dt><dd><dl><dt><span class="section"><a href="#headerchecks">6.1. Header checks</a></span></dt><dt><span class="section"><a href="#jmsr">6.2. Junk Mail Signature Repositories</a></span></dt><dt><span class="section"><a href="#garbagechars">6.3. Binary garbage checks</a></span></dt><dt><span class="section"><a href="#mimeerrors">6.4. MIME checks</a></span></dt><dt><span class="section"><a href="#fileext">6.5. File Attachment Check</a></span></dt><dt><span class="section"><a href="#virusscanners">6.6. Virus Scanners</a></span></dt><dt><span class="section"><a href="#spamscanners">6.7. Spam Scanners</a></span></dt></dl></dd><dt><span class="section"><a href="#collateral">7. Blocking Collateral Spam</a></span></dt><dd><dl><dt><span class="section"><a href="#bogusviruswarning">7.1. Bogus Virus Warning Filter</a></span></dt><dt><span class="section"><a href="#addspf">7.2. Publish SPF info for your domain</a></span></dt><dt><span class="section"><a href="#signedsender">7.3. Enveloper Sender Signature</a></span></dt><dt><span class="section"><a href="#dsnrealuser">7.4. Accept Bounces Only for Real Users</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#considerations">3. Considerations</a></span></dt><dd><dl><dt><span class="section"><a href="#multimx">1. Multiple Incoming Mail Exchangers</a></span></dt><dt><span class="section"><a href="#otherservers">2. Blocking Access to Other SMTP Servers</a></span></dt><dt><span class="section"><a href="#forwardedmail">3. Forwarded Mail</a></span></dt><dt><span class="section"><a href="#usersettings">4. User Settings and Data</a></span></dt></dl></dd><dt><span class="chapter"><a href="#qanda">4. Questions &amp; Answers</a></span></dt><dt><span class="appendix"><a href="#exim">A. Exim Implementation</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-prereq">1. Prerequisites</a></span></dt><dt><span class="section"><a href="#exim-configfile">2. The Exim Configuration File</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-acl">2.1. Access Control Lists</a></span></dt><dt><span class="section"><a href="#exim-expansions">2.2. Expansions</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-options">3. Options and Settings</a></span></dt><dt><span class="section"><a href="#exim-firstpass">4. Building the ACLs - First Pass</a></span></dt><dd><dl><dt><span class="section"><a href="#acl_connect_1">4.1. acl_connect</a></span></dt><dt><span class="section"><a href="#acl_helo_1">4.2. acl_helo</a></span></dt><dt><span class="section"><a href="#acl_mail_from_1">4.3. acl_mail_from</a></span></dt><dt><span class="section"><a href="#acl_rcpt_to_1">4.4. acl_rcpt_to</a></span></dt><dt><span class="section"><a href="#acl_data_1">4.5. acl_data</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-smtpdelays">5. Adding SMTP transaction delays</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-smtpdelays-simple">5.1. The simple way</a></span></dt><dt><span class="section"><a href="#exim-smtpdelays-selective">5.2. Selective Delays</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-greylisting">6. Adding Greylisting Support</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-greylistd">6.1. greylistd</a></span></dt><dt><span class="section"><a href="#exim-greylist-mysql">6.2. MySQL implementation</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-spf">7. Adding SPF Checks</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-spf-exiscan">7.1. SPF checks via Exiscan-ACL</a></span></dt><dt><span class="section"><a href="#exim-spf-query-perl">7.2. SPF checks via Mail::SPF::Query</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-mime">8. Adding MIME and Filetype Checks</a></span></dt><dt><span class="section"><a href="#exim-av">9. Adding Anti-Virus Software</a></span></dt><dt><span class="section"><a href="#exim-sa">10. Adding SpamAssassin</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-sa-exiscan">10.1. Invoke SpamAssassin via Exiscan</a></span></dt><dt><span class="section"><a href="#exim-sa-config">10.2. Configure SpamAssassin</a></span></dt><dt><span class="section"><a href="#exim-per-user">10.3. User Settings and Data</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-sign">11. Adding Envelope Sender Signatures</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-sign-transport">11.1. Create a Transport to Sign the Sender Address</a></span></dt><dt><span class="section"><a href="#exim-sign-router-remote">11.2. Create a New Router for Remote Deliveries</a></span></dt><dt><span class="section"><a href="#exim-sign-router-redirect">11.3. Create New Redirect Router for Local Deliveries</a></span></dt><dt><span class="section"><a href="#exim-sign-acl">11.4. ACL Signature Check</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-bounces">12. Accept Bounces Only for Real Users</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-dsn-mailbox">12.1. Check for Recipient Mailbox</a></span></dt><dt><span class="section"><a href="#exim-dsn-noalias">12.2. Check for Empty Sender in Aliases Router</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-forward">13. Exempting Forwarded Mail</a></span></dt><dt><span class="section"><a href="#exim-final">14. Final ACLs</a></span></dt><dd><dl><dt><span class="section"><a href="#acl_connect_final">14.1. acl_connect</a></span></dt><dt><span class="section"><a href="#acl_helo_final">14.2. acl_helo</a></span></dt><dt><span class="section"><a href="#acl_mail_from_final">14.3. acl_mail_from</a></span></dt><dt><span class="section"><a href="#acl_rcpt_to_final">14.4. acl_rcpt_to</a></span></dt><dt><span class="section"><a href="#acl_data_final">14.5. acl_data</a></span></dt></dl></dd></dl></dd><dt><span class="glossary"><a href="#glossary">Glossary</a></span></dt><dt><span class="appendix"><a href="#gpl">B. GNU General Public License</a></span></dt><dd><dl><dt><span class="sect1"><a href="#gpl-1">1. Preamble</a></span></dt><dt><span class="sect1"><a href="#gpl-2">2. TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION</a></span></dt><dd><dl><dt><span class="sect2"><a href="#gpl-2-0">2.1. Section 0</a></span></dt><dt><span class="sect2"><a href="#gpl-2-1">2.2. Section 1</a></span></dt><dt><span class="sect2"><a href="#gpl-2-2">2.3. Section 2</a></span></dt><dt><span class="sect2"><a href="#gpl-2-3">2.4. Section 3
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-4">2.5. Section 4
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-5">2.6. Section 5
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-6">2.7. Section 6
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-7">2.8. Section 7
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-8">2.9. Section 8
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-9">2.10. Section 9
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-10">2.11. Section 10
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-11">2.12. NO WARRANTY Section 11
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-12">2.13. Section 12
      </a></span></dt></dl></dd><dt><span class="sect1"><a href="#gpl-3">3. How to Apply These Terms to Your New Programs
    </a></span></dt></dl></dd></dl></div><div class="list-of-tables"><p><b>List of Tables</b></p><dl><dt>1. <a href="#conventiontable">Typographic and usage conventions</a></dt><dt>1.1. <a href="#smtpdialogue">Simple SMTP dialogue</a></dt><dt>A.1. <a href="#aclvarusage">Use of ACL connection/message variables</a></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="idm53"></a>Introduction</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#purpose">1. Purpose of this Document</a></span></dt><dt><span class="section"><a href="#audience">2. Audience</a></span></dt><dt><span class="section"><a href="#updates">3. New versions of this document</a></span></dt><dt><span class="section"><a href="#history">4. Revision History</a></span></dt><dt><span class="section"><a href="#credits">5. Credits</a></span></dt><dt><span class="section"><a href="#feedback">6. Feedback</a></span></dt><dt><span class="section"><a href="#translations">7. Translations</a></span></dt><dt><span class="section"><a href="#copyright">8. Copyright information</a></span></dt><dt><span class="section"><a href="#prerequisites">9. What do you need?</a></span></dt><dt><span class="section"><a href="#conventions">10. Conventions used in this document</a></span></dt><dt><span class="section"><a href="#organization">11. Organization of this document</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="purpose"></a>1. Purpose of this Document</h2></div></div></div><p>
	This document discusses various highly effective and low
	impact ways to weed out spam and malware during incoming SMTP
	transactions in a mail exchanger (MX host), with an added
	emphasis on eliminating so-called <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>.
      </p><p>
	The discussions are conceptual in nature, but a sample
	implementation is provided using the Exim MTA and other
	specific software tools.  Miscellaneous other bigotry is
	expressed throughout.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="audience"></a>2. Audience</h2></div></div></div><p>
	The intended audience is mail system administrators, who are
	already familiar with such acronyms as SMTP, MTA/MDA/MUA,
	DNS/rDNS, and MX records.  If you are an end user who is
	looking for a spam filtering solution for your mail reader
	(such as Evolution, Thunderbird, Mail.app or Outlook Express),
	this document is <span class="emphasis"><em>not</em></span> for you; but you may
	wish to point the mail system administrator for your domain
	(company, school, ISP...) to its existence.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="updates"></a>3. New versions of this document</h2></div></div></div><p>
	The newest version of this document can be found at
	<a class="ulink" href="http://slett.net/spam-filtering-for-mx/" target="_top">http://slett.net/spam-filtering-for-mx/</a>.
	Please check back periodically for corrections and additions.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="history"></a>4. Revision History</h2></div></div></div><p>
	</p><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision 1.0</td><td align="left">2004-09-08</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      First public release.
	    </td></tr><tr><td align="left">Revision 0.18</td><td align="left">2004-09-07</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated second language review from Tom Wright.
	    </td></tr><tr><td align="left">Revision 0.17</td><td align="left">2004-09-06</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated language review from Tom Wright.
	    </td></tr><tr><td align="left">Revision 0.16</td><td align="left">2004-08-13</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated third round of changes from Devdas Bhagat.
	    </td></tr><tr><td align="left">Revision 0.15</td><td align="left">2004-08-04</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated second round of changes from technical
	      review by Devdas Bhagat.
	    </td></tr><tr><td align="left">Revision 0.14</td><td align="left">2004-08-01</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated technical review comments/corrections from
	      Devdas Bhagat.
	    </td></tr><tr><td align="left">Revision 0.13</td><td align="left">2004-08-01</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated technical review from Joost De Cock.
	    </td></tr><tr><td align="left">Revision 0.12</td><td align="left">2004-07-27</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Replaced "A Note on Controversies" with a more
	      opinionated "The Good, The Bad, the Ugly" section.  Also
	      rewrote text on DNS blocklists.  Some corrections from
	      Seymour J. Metz.
	    </td></tr><tr><td align="left">Revision 0.11</td><td align="left">2004-07-19</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated comments from Rick Stewart on RMX++.
	      Swapped order of "Techniques" and "Considerations".
	      Minor typographic fixes in Exim implementation.
	    </td></tr><tr><td align="left">Revision 0.10</td><td align="left">2004-07-16</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Added &lt;?dbhtml..?&gt; tags to control generated HTML
	      filenames - should prevent broken links from google etc.
	      Swapped order of "Forwarded Mail" and "User Settings".
	      Correction from Tony Finch on Bayesian filters;
	      commented out check for Subject:, Date:, and Message-ID:
	      headers per Johannes Berg; processing time subtracted
	      from SMTP delays per suggestion from Alan Flavell.
	    </td></tr><tr><td align="left">Revision 0.09</td><td align="left">2004-07-13</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Elaborated on problems with envelope sender signatures
	      and mailing list servers, and a scheme to make such
	      signatures optional per host/domain for each user.
	      Moved "Considerations" section out as a separate
	      chapter; added subsections "Blocking Access to other
	      SMTP Server", "User Settings" and "Forwarded Mail".
	      Incorporated Matthew Byng-Maddick's comments on the
	      mechanism used to generate these signatures, Chris
	      Edwards' comments on sender callout verification, and
	      Hadmut Danisch's comments on RMX++ and other topics.
	      Changed license terms (GPL instead of GFDL).
	    </td></tr><tr><td align="left">Revision 0.08</td><td align="left">2004-07-09</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Additional work on Exim implementation: Added section on
	      per-user settings and data for SpamAssassin per
	      suggestion from Tollef Fog Heen.  Added SPF checks via
	      Exiscan-ACL.  Corrections from Sam Michaels.
	    </td></tr><tr><td align="left">Revision 0.07</td><td align="left">2004-07-08</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Made corrections to the Exim Envelope Sender Signatures
	      examples, and added support for users to "opt in" to
	      this feature, per suggestion from Christian Balzer.
	    </td></tr><tr><td align="left">Revision 0.06</td><td align="left">2004-07-08</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Incorporated Exim/MySQL greylisting implementation and
	      various corrections from Johannes Berg.  Moved "Sender
	      Authorization Schemes" up two levels to become a
	      top-level section in the Techniques chapter.  Added
	      greylisting for NULL empty envelope senders after DATA.
	      Added SpamAssassin configuration to match Exim examples.
	      Incorporated corrections from Dominik Ruff, Mark
	      Valites, "Andrew" at Supernews.
	    </td></tr><tr><td align="left">Revision 0.05</td><td align="left">2004-07-07</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Eliminated the (empty) Sendmail implementation for now,
	      to move ahead with the final review process.
	    </td></tr><tr><td align="left">Revision 0.04</td><td align="left">2004-07-06</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Reorganized layout a little: Combined "SMTP-Time
	      Filtering", "Introduction to SMTP", and "Considerations"
	      into a single "Background" chapter.  Split the previous
	      "Building ACLs" section in the Exim implementation into
	      top-level sections.  Added alternate sender
	      authorization schemes to SPF: Microsoft Caller-ID for
	      E-Mail and RMX++. Incorporated comments from Ken
	      Raeburn.
	    </td></tr><tr><td align="left">Revision 0.03</td><td align="left">2004-07-02</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">
	      Added discussion on Multiple Incoming Mail Exchangers;
	      minor corrections related to Sender Callout Verification.
	    </td></tr><tr><td align="left">Revision 0.02</td><td align="left">2004-06-30</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">Added Exim implementation as an appendix</td></tr><tr><td align="left">Revision 0.01</td><td align="left">2004-06-16</td><td align="left">TS</td></tr><tr><td align="left" colspan="3">Initial draft.</td></tr></table></div><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="credits"></a>5. Credits</h2></div></div></div><p>
	A number of people have provided feedback, corrections, and
	contributions, as indicated in the <a class="xref" href="#history" title="4. Revision History">Revision History</a>.
	Thank you!
      </p><p>
	The following are <span class="emphasis"><em>some</em></span> of the people and
	groups that have provided tools and ideas to this document, in
	no particular order:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    Evan Harris <code class="email">&lt;<a class="email" href="mailto:eharris%20(at)%20puremagic.com">eharris (at) puremagic.com</a>&gt;</code>, who
	    conceived and wrote a white paper on <a class="link" href="#greylisting" title="4. Greylisting">greylisting</a>.
	  </p></li><li class="listitem"><p>
	    Axel Zinser <code class="email">&lt;<a class="email" href="mailto:fifi%20(at)%20hiss.org">fifi (at) hiss.org</a>&gt;</code>, who
	    apparently conceived of
	    <a class="link" href="#smtpdelays" title="1. SMTP Transaction Delays">teergrubing</a>.
	  </p></li><li class="listitem"><p>
	    The developers of
	    <a class="ulink" href="http://spf.pobox.com/" target="_top">SPF</a>,
	    <a class="ulink" href="http://www.danisch.de/work/security/antispam.html" target="_top">RMX++</a>,
	    and other
	    <a class="xref" href="#senderauth" title="5. Sender Authorization Schemes">Sender Authorization Schemes</a>.
	  </p></li><li class="listitem"><p>
	    The creators and maintainers of distributed, collaborative
	    junk mail signature repositories, such as
	    <a class="ulink" href="http://rhyolite.com/anti-spam/dcc/" target="_top">DCC</a>,
	    <a class="ulink" href="http://razor.sf.net/" target="_top">Razor</a>, and
	    <a class="ulink" href="http://pyzor.sf.net/" target="_top">Pyzor</a>.
	  </p></li><li class="listitem"><p>
	    The creators and maintainers of various DNS blocklists and
	    whitelists, such as
	    <a class="ulink" href="http://www.spamcop.net/" target="_top">SpamCop</a>,
	    <a class="ulink" href="http://www.spamhaus.org/" target="_top">SpamHaus</a>,
	    <a class="ulink" href="http://www.sorbs.net/" target="_top">SORBS</a>,
	    <a class="ulink" href="http://cbl.abuseat.org/" target="_top">CBL</a>, and
	    <a class="ulink" href="http://moensted.dk/spam/" target="_top">many others</a>.
	  </p></li><li class="listitem"><p>
	    The
	    <a class="ulink" href="http://www.spamassassin.org/full/3.0.x/dist/CREDITS" target="_top">developers</a>
	    of
	    <a class="ulink" href="http://www.spamassassin.org/" target="_top">SpamAssassin</a>,
	    who have taken giant leaps forward in developing and
	    integrating various spam filtering techniques into a
	    sophisticated heuristics-based tool.
	  </p></li><li class="listitem"><p>
	    Tim Jackson <code class="email">&lt;<a class="email" href="mailto:tim%20(at)%20timj.co.uk">tim (at) timj.co.uk</a>&gt;</code> collated
	    and maintains a list of
	    <a class="link" href="#bogusviruswarning" title="7.1. Bogus Virus Warning Filter">bogus virus warnings</a>
	    for use with SpamAssassin.
	  </p></li><li class="listitem"><p>
	    A lot of smart people who developed the excellent <a class="link" href="#exim" title="Appendix A. Exim Implementation">Exim</a> MTA, including: Philip
	    Hazel <code class="email">&lt;<a class="email" href="mailto:ph10%20(at)%20cus.cam.ac.uk">ph10 (at) cus.cam.ac.uk</a>&gt;</code>, the
	    maintainer; Tom Kistner <code class="email">&lt;<a class="email" href="mailto:tom%20(at)%0A%09%20%20%20%20duncanthrax.net">tom (at)
	    duncanthrax.net</a>&gt;</code>, who wrote the Exiscan-ACL patch
	    for SMTP-time content checks; Andreas Metzler
	    <code class="email">&lt;<a class="email" href="mailto:ametzler%20(at)%20debian.org">ametzler (at) debian.org</a>&gt;</code>, who did a really
	    good job of building the Exim 4 Debian packages.
	  </p></li><li class="listitem"><p>
	    Many, many others who contributed ideas, software, and
	    other techniques to counter the spam epidemic.
	  </p></li><li class="listitem"><p>
	    You, for reading this document and your interest in
	    reclaiming e-mail as a useful communication tool
	  </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="feedback"></a>6. Feedback</h2></div></div></div><p>
	I would love to hear of your experiences with the techniques
	outlined in this document, and of any other comments,
	questions, suggestions, and/or contributions you may have.
	Please send me an e-mail at: <code class="email">&lt;<a class="email" href="mailto:tor@slett.net">tor@slett.net</a>&gt;</code>.
      </p><p>
	If you are able to provide implementations for other <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>s, such as Sendmail or Postfix, please let me
	know.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="translations"></a>7. Translations</h2></div></div></div><p>
	No translations exist yet.  If you would like to create one,
	please let me know.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="copyright"></a>8. Copyright information</h2></div></div></div><p>
	Copyright © 2004 Tor Slettnes.
      </p><p>
	This document is free software; you can redistribute it and/or
	modify it under the terms of the GNU General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.
      </p><p>
	This document is distributed in the hope that it will be
	useful, but WITHOUT ANY WARRANTY; without even the implied
	warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
	PURPOSE.  See the GNU General Public License for more details.
	A copy of the license is included in <a class="xref" href="#gpl" title="Appendix B. GNU General Public License">Appendix B, <i>GNU General Public License</i></a>.
      </p><p>
	Read <a class="ulink" href="http://www.fsf.org/gnu/manifesto.html" target="_top">The
	GNU Manifesto </a> if you want to know why this license
	was chosen for this book.
      </p><p>
	The logos, trademarks and symbols used in this book are the
	properties of their respective owners.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="prerequisites"></a>9. What do you need?</h2></div></div></div><p>
	The techniques described in this document predicate system
	access to the inbound <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a>(s) for the internet
	domain where you receive e-mail.  Essentially, you need to be
	able to install software and/or modify the configuration files
	for the <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a> on that system.
      </p><p>
	Although the discussions in this document are conceptual in
	nature and can be incorporated into a number of different
	MTAs, a sample Exim 4 implementation is provided.  This
	implementation, in turn, incorporates other software tools,
	such as <a class="ulink" href="http://www.spamassassin.org/" target="_top">SpamAssassin</a>.
	See <a class="xref" href="#exim" title="Appendix A. Exim Implementation">Appendix A, <i>Exim Implementation</i></a> for details.
      </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="conventions"></a>10. Conventions used in this document</h2></div></div></div><p>
	The following typographic and usage conventions occur in this text:
      </p><div class="table"><a name="conventiontable"></a><p class="title"><b>Table 1. Typographic and usage conventions</b></p><div class="table-contents"><table class="table" summary="Typographic and usage conventions" border="1"><colgroup><col><col></colgroup><thead><tr><th align="left">Text type</th><th align="left">Meaning</th></tr></thead><tbody><tr><td align="left"><span class="quote">&#8220;<span class="quote">Quoted text</span>&#8221;</span></td><td align="left">Quotes from people, quoted computer output.</td></tr><tr><td align="left"><pre class="screen">terminal view</pre></td><td align="left">
		Literal computer input and output captured from
		the terminal, usually rendered with a light grey
		background.
	      </td></tr><tr><td align="left"><span class="command"><strong>command</strong></span></td><td align="left">
		Name of a command that can be entered on the command
		line.
	      </td></tr><tr><td align="left"><code class="varname">VARIABLE</code></td><td align="left">
		Name of a variable or pointer to content of a
		variable, as in <code class="varname">$VARNAME</code>.
	      </td></tr><tr><td align="left"><code class="option">option</code></td><td align="left">
		Option to a command, as in <span class="quote">&#8220;<span class="quote">the
		<code class="option">-a</code> option to the
		<span class="command"><strong>ls</strong></span> command</span>&#8221;</span>.
	      </td></tr><tr><td align="left"><em class="parameter"><code>argument</code></em></td><td align="left">
		Argument to a command, as in
		<span class="quote">&#8220;<span class="quote">read <span class="command"><strong>man
		    <em class="parameter"><code>ls</code></em></strong></span>
		</span>&#8221;</span>.
	      </td></tr><tr><td align="left">
		<div class="cmdsynopsis"><p><code class="command">command
		    <code class="option">options</code>
		    <em class="parameter"><code>arguments</code></em>
		  </code> </p></div>
	      </td><td align="left">
		Command synopsis or general usage, on a separated
		line.
	      </td></tr><tr><td align="left"><code class="filename">filename</code></td><td align="left">
		Name of a file or directory, for example <span class="quote">&#8220;<span class="quote">Change
		to the <code class="filename">/usr/bin</code>
		directory.</span>&#8221;</span>
	      </td></tr><tr><td align="left"><span class="keycap"><strong>Key</strong></span></td><td align="left">
		Keys to hit on the keyboard, such as <span class="quote">&#8220;<span class="quote">type
		<span class="keycap"><strong>Q</strong></span> to quit</span>&#8221;</span>.
	      </td></tr><tr><td align="left"><span class="guibutton">Button</span></td><td align="left">
		Graphical button to click, like the
		<span class="guibutton">OK</span> button.
	      </td></tr><tr><td align="left">
		<span class="guimenu">Menu</span> &#8594; <span class="guimenuitem">Choice</span>
	      </td><td align="left">
		Choice to select from a graphical menu, for instance:
		<span class="quote">&#8220;<span class="quote">Select
		<span class="guimenu">Help</span> &#8594; <span class="guimenuitem">About
		Mozilla</span> in your
		browser.</span>&#8221;</span></td></tr><tr><td align="left">
		<span class="emphasis"><em>Terminology</em></span></td><td align="left">
		Important term or concept:
		<span class="quote">&#8220;<span class="quote">The Linux <span class="emphasis"><em>kernel</em></span>
		  is the heart of the system.</span>&#8221;</span>
	      </td></tr><tr><td align="left">
		See <a class="xref" href="#glossary" title="Glossary">Glossary</a>
	      </td><td align="left">
		link to related subject within this guide.
	      </td></tr><tr><td align="left">
		<a class="ulink" href="http://slett.net/gallery/2003-05/IMG_1655" target="_top">The author</a>
	      </td><td align="left">Clickable link to an external web resource.</td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="organization"></a>11. Organization of this document</h2></div></div></div><p>
	This document is organized into the following chapters:
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><a class="xref" href="#background" title="Chapter 1. Background">Background</a></span></dt><dd><p>
	      General introduction to SMTP time filtering, and to SMTP.
	    </p></dd><dt><span class="term"><a class="xref" href="#techniques" title="Chapter 2. Techniques">Techniques</a></span></dt><dd><p>
	      Various ways to block junk mail in an SMTP transaction.
	    </p></dd><dt><span class="term"><a class="xref" href="#considerations" title="Chapter 3. Considerations">Considerations</a></span></dt><dd><p>
	      Issues that pertain to transaction time filtering.
	    </p></dd><dt><span class="term"><a class="xref" href="#qanda" title="Chapter 4. Questions &amp; Answers">Questions &amp; Answers</a></span></dt><dd><p>
	      My attempt at anticipating your questions, and then
	      answering them.
	    </p></dd></dl></div><p>
	A sample Exim implementation is provided in <a class="xref" href="#exim" title="Appendix A. Exim Implementation">Appendix A, <i>Exim Implementation</i></a>.
      </p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="background"></a>Chapter 1. Background</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#whysmtptime">1. Why Filter Mail During the SMTP Transaction?</a></span></dt><dd><dl><dt><span class="section"><a href="#statusquo">1.1. Status Quo</a></span></dt><dt><span class="section"><a href="#cause">1.2. The Cause</a></span></dt><dt><span class="section"><a href="#solution">1.3. The Solution</a></span></dt></dl></dd><dt><span class="section"><a href="#goodbadugly">2. The Good, The Bad, The Ugly</a></span></dt><dt><span class="section"><a href="#smtpintro">3. The SMTP Transaction</a></span></dt></dl></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      Here we cover the advantages of filtering mail during an
      incoming SMTP transaction, rather than following the more
      conventional approach of offloading this task to the mail
      routing and delivery stage.  We also provide a brief
      introduction to the SMTP transaction.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="whysmtptime"></a>1. Why Filter Mail During the SMTP Transaction?</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="statusquo"></a>1.1. Status Quo</h3></div></div></div><p>
	If you receive spam, raise your hands.  Keep them up.
      </p><p>
	If you receive computer virii or other malware, raise your
	hands too.
      </p><p>
	If you receive bogus <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s (DSNs), such as
	<span class="quote">&#8220;<span class="quote">Message Undeliverable</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">Virus
	found</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">Please confirm delivery</span>&#8221;</span>, etc,
	related to messages you never sent, raise your hands as well.
	This is known as <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>.
      </p><p>
	This last form is particularly troublesome, because it is
	harder to weed out than <span class="quote">&#8220;<span class="quote">standard</span>&#8221;</span> spam or
	malware, and because such messages can be quite confusing to
	recipients who do not possess godly skills in parsing message
	headers.  In the case of virus warnings, this often causes
	unnecessary concern on the recipient's end; more generally, a
	common tendency will be to ignore all such messages, thereby
	missing out on legitimate DSNs.
      </p><p>
	Finally, I want those of you who have lost legitimate mail into
	a big black hole - due to misclassification by spam or virus
	scanners - to lift your feet.
      </p><p>
	If you were standing before and are still standing, I suggest
	that you may not be fully aware of what is happening to your
	mail.  If you have been doing any type of spam filtering, even
	by manually moving mails to the trash can in your mail reader,
	let alone by experimenting with primitive filtering techniques
	such as DNS blacklists (SpamHaus, SPEWS, SORBS...), chances
	are that you have lost some valid mail.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cause"></a>1.2. The Cause</h3></div></div></div><p>
	Spam, just like many other artifacts of greed, is a social
	disease.  Call it affluenza, or whatever you like; lower life
	forms seek to destroy a larger ecosystem, and if successful,
	will actually end up ruining their own habitat in the end.
      </p><p>
	Larger social issues and philosophy aside: You - the mail system
	administrator - face the very concrete and real life dilemma of
	finding a way to deal with all this junk.
      </p><p>
	As it turns out, there are some limitations with the
	conventional way that mail is being processed and delegated by
	the various components of mail transport and delivery
	software.  In a traditional setup, one or more <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a>(s) accept most or all incoming mail deliveries
	to addresses within a domain.  Often, they then forward the
	mail to one or more internal machines for further processing,
	and/or delivery to the user's mailboxes.  If any of these
	servers discovers that it is unable to perform the requested
	delivery or function, it generates and returns a DSN back to
	the sender address in the original mail.
      </p><p>
	As organizations started deploying spam and virus scanners,
	they often found that the path of least resistance was to work
	these into the message delivery path, as mail is transferred
	from the incoming <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a>(s) to internal delivery
	hosts and/or software.  For instance, a common way filter out
	spam is by <span class="emphasis"><em>routing</em></span> the mail through
	SpamAssassin or other software before it is delivered to a
	user's mailbox, and/or rely on spam filtering capabilities in
	the user's <a class="xref" href="#mua" title="Mail User Agent">Mail User Agent</a>.
      </p><p>
	Options for dealing with mail that is classified as spam or
	virus at this point are limited:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    You can return a <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> back to the sender.
	    The problem is that nearly all spam and e-mail borne
	    virii are delivered with faked sender addresses.  If you
	    return this mail, it will invariably go to innocent third
	    parties -- perhaps warning a grandmother in Sweden, who
	    uses Mac OS X and does not know much about computers, that
	    she is infected by the Blaster worm.  In other words, you
	    will be generating <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>.
	  </p></li><li class="listitem"><p>
	    You can drop the message into the bit bucket, without
	    sending any notification back to the sender.  This is an
	    even bigger problem in the case of <a class="xref" href="#falsepos" title="False Positive">False Positive</a>s, because neither the sender nor
	    the receiver will ever know what happened to the message
	    (or in the receiver's case, that it ever existed).
	  </p></li><li class="listitem"><p>
	    Depending on how your users access their mail (for
	    instance, if they access it via the IMAP protocol or use a
	    web-based mail reader, but not if they retreive it over
	    POP-3), you may be able to file it into a separate junk
	    folder for them -- perhaps as an option in their account
	    settings.
	  </p><p>
	    This may be the best of these three options.  Even so, the
	    messages may remain unseen for some time, or simply
	    overlooked as the receiver more-or-less periodically scans
	    through and deletes mail in their <span class="quote">&#8220;<span class="quote">Junk</span>&#8221;</span>
	    folder.
	  </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="solution"></a>1.3. The Solution</h3></div></div></div><p>
	As you would have guessed by now, the <span class="emphasis"><em>One
	True</em></span> solution to this problem is to do spam and
	virus filtering during the SMTP dialogue from the remote host,
	as the mail is being received by the inbound mail exchanger
	for your domain.  This way, if the mail turns out to be
	undesirable, you can issue a SMTP <span class="emphasis"><em>reject</em></span>
	response rather than face the dilemma described above.  As a
	result:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    You will be able to stop the delivery of most junk mail
	    early in the SMTP transaction, before the actual message
	    data has been received, thus saving you both network
	    bandwidth and CPU processing.
	  </p></li><li class="listitem"><p>
	    You will be able to deploy some spam filtering techniques
	    that are not possible later, such as
	    <a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a> and
	    <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a>.
	  </p></li><li class="listitem"><p>
	    You will be able to notify the sender in case of a
	    delivery failure (e.g. due to an invalid recipient
	    address) without directly generating <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>
	  </p><p>
	    We will discuss how you can avoid causing collateral spam
	    indirectly as a result of rejecting mail forwarded from
	    trusted sources, such as mailing list servers or mail
	    accounts on other sites
	    <a href="#ftn.idm419" class="footnote" name="idm419"><sup class="footnote">[1]</sup></a>.
	  </p></li><li class="listitem"><p>
	    You will be able to protect yourself against collateral
	    spam from others (such as bogus <span class="quote">&#8220;<span class="quote">You have a
	    virus</span>&#8221;</span> messages from anti-virus software).
	  </p></li></ul></div><p>
	OK, you can lower your hands now.  If you were standing, and
	your feet disappeared from under you, you can now also stand up
	again.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="goodbadugly"></a>2. The Good, The Bad, The Ugly</h2></div></div></div><p>
      Some filtering techniques are more suitable for use during the
      SMTP transaction than others.  Some are simply better than
      others.  Nearly all have their proponents and opponents.
    </p><p>
      Needless to say, these controversies extend to the methods
      described here as well.  For instance:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  Some argue that <a class="xref" href="#dnschecks" title="2. DNS Checks">DNS checks</a> penalize
	  individual mail senders purely based on their Internet
	  Service Provider (ISP), not on the merits of their
	  particular message.
	</p></li><li class="listitem"><p>
	  Some point out that ratware traps like <a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a> and <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a> are
	  easily overcome and will be less effective over time, while
	  continuing to degrade the Quality of Service for legitimate
	  mail.
	</p></li><li class="listitem"><p>
	  Some find that <a class="xref" href="#senderauth" title="5. Sender Authorization Schemes">Sender Authorization Schemes</a> like the <a class="xref" href="#spf" title="5.1. Sender Policy Framework (SPF)">Sender Policy Framework</a> give ISPs a way to lock their customers in,
	  and do not adequately address users who roam between
	  different networks or who forward their e-mail from one host
	  to another.
	</p></li></ul></div><p>
      I will steer away from most of these controversies.  Instead, I
      will try to provide a functional description of the various
      techniques available, including their possible side effects, and
      then talk a little about my own experiences using some of them.
    </p><p>
      That said, there are some filtering methods in use today that I
      deliberately omit from this document:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  Challenge/response systems (like <a class="ulink" href="http://tmda.net/" target="_top">TMDA</a>).  These are not
	  suitable for SMTP time filtering, as they rely on first
	  accepting the mail, then returning a confirmation request to
	  the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>.  This technique is therefore
	  outside the scope of this document.
	  <a href="#ftn.idm452" class="footnote" name="idm452"><sup class="footnote">[2]</sup></a>
	</p></li><li class="listitem"><p>
	  <a class="xref" href="#bayesian" title="Bayesian Filters">Bayesian Filters</a>.  These require training specific
	  to a particular user, and/or a particular language.  As
	  such, these too are not normally suitable for use during the
	  SMTP transaction (But see <a class="xref" href="#usersettings" title="4. User Settings and Data">User Settings and Data</a>).
	</p></li><li class="listitem"><p>
	  <a class="xref" href="#micropay" title="Micropayment Schemes">Micropayment Schemes</a> are not really suitable for
	  weeding out junk mail until all the world's legitimate mail
	  is sent with a virtual <span class="emphasis"><em>postage stamp</em></span>.
	  (Though in the mean time, they can be used for the opposite
	  purpose - that is, to accept mail carrying the stamp that
	  would otherwise be rejected).
	</p></li></ul></div><p>
      Generally, I have attempted to offer techniques that are as
      precise as possible, and to go to great lengths to avoid <a class="xref" href="#falsepos" title="False Positive">False Positive</a>s.  People's e-mail is important to them,
      and they spend time and effort writing it.  In my view,
      willfully using techniques or tools that reject large amounts of
      legitimate mail is a show of disrespect, both to the people that
      are directly affected and to the Internet as a whole.
      <a href="#ftn.idm465" class="footnote" name="idm465"><sup class="footnote">[3]</sup></a>

      This is especially true for SMTP-time system wide filtering,
      because end recipients usually have little or no control over
      the criteria being used to filter their mail.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="smtpintro"></a>3. The SMTP Transaction</h2></div></div></div><p>
      SMTP is the protocol that is used for mail delivery on the
      Internet.  For a detailed description of the protocol, please
      refer to <a class="ulink" href="http://www.ietf.org/rfc/rfc2821.txt" target="_top">RFC
      2821</a>, as well as Dave Crocker's introduction to
      <a class="ulink" href="http://www.brandenburg.com/specifications/draft-crocker-mail-arch-00.htm" target="_top">Internet Mail Architecture</a>.
    </p><p>
      Mail deliveries involve an SMTP transaction between the
      connecting host (client) and the receiving host (server).  For
      this discussion, the connecting host is the peer, and the
      receiving host is your server.
    </p><p>
      In a typical SMTP transaction, the client issues SMTP commands
      such as <span class="command"><strong>EHLO</strong></span>, <span class="command"><strong>MAIL FROM:</strong></span>,
      <span class="command"><strong>RCPT TO:</strong></span>, and <span class="command"><strong>DATA</strong></span>.  Your
      server responds to each command with a 3-digit numeric code
      indicating whether the command was accepted
      (<span class="command"><strong>2<em class="parameter"><code>xx</code></em></strong></span>), was subject to
      a temporary failure or restriction
      (<span class="command"><strong>4<em class="parameter"><code>xx</code></em></strong></span>), or failed
      definitively/permanently
      (<span class="command"><strong>5<em class="parameter"><code>xx</code></em></strong></span>), followed by
      some human readable explanation.  A full description of these
      codes is included in
      <a class="ulink" href="http://www.ietf.org/rfc/rfc2821.txt" target="_top">RFC 2821</a>.
    </p><p>
      A best case scenario SMTP transaction typically consists of the
      following relevant steps:
    </p><div class="table"><a name="smtpdialogue"></a><p class="title"><b>Table 1.1. Simple SMTP dialogue</b></p><div class="table-contents"><table class="table" summary="Simple SMTP dialogue" border="1"><colgroup><col><col></colgroup><thead><tr><th align="left">Client</th><th align="left">Server</th></tr></thead><tbody><tr><td align="left">
	      <p>
		Initiates a TCP connection to server.
	      </p>
	    </td><td align="left">
	      <p>
		Presents an SMTP banner - that is, a greeting that
		starts with the code <span class="command"><strong>220</strong></span> to indicate
		that it is ready to speak SMTP (or usually ESMTP, a
		superset of SMTP):

		</p><pre class="screen">220 <em class="parameter"><code>your.f.q.d.n</code></em> ESTMP...</pre><p>
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		Introduces itself by way of an Hello command, either
		<span class="command"><strong>HELO</strong></span> (now obsolete) or
		<span class="command"><strong>EHLO</strong></span>, followed by its own <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>:
		</p><pre class="screen">EHLO <em class="parameter"><code>peers.f.q.d.n</code></em></pre><p>
	      </p>
	    </td><td align="left">
	      <p>
		Accepts this greeting with a <span class="command"><strong>250</strong></span>
		response.  If the client used the
		<span class="emphasis"><em>extended</em></span> version of the Hello
		command (<span class="command"><strong>EHLO</strong></span>), your server knows
		that it is capable of handling multi-line responses,
		and so will normally send back several lines
		indicating the capabilities offered by your server:

</p><pre class="screen">
250-<em class="parameter"><code>your.f.q.d.n</code></em> Hello ...
250-SIZE 52428800
250-8BITMIME
250-PIPELINING
250-STARTTLS
250-AUTH
250 HELP
</pre><p>
	      </p>

	      <p>
		If the <span class="command"><strong>PIPELINING</strong></span> capability is
		included in this response, the client can from this point
		forward issue several commands at once, without waiting
		for the response to each one.
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		Starts a new mail transaction by specifying the
		<a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>:

		</p><pre class="screen">MAIL FROM:&lt;<em class="parameter"><code>sender</code></em>@<em class="parameter"><code>address</code></em>&gt;
		</pre><p>
	      </p>
	    </td><td align="left">
	      <p>
		Issues a <span class="command"><strong>250</strong></span> response to indicate
		that the sender is accepted.
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		Lists the <a class="xref" href="#envto" title="Envelope Recipient">Envelope Recipient</a>s of the message, one
		at a time, using the command:

		</p><pre class="screen">RCPT TO:&lt;<em class="parameter"><code>receiver</code></em>@<em class="parameter"><code>address</code></em>&gt;</pre><p>
	      </p>
	    </td><td align="left">
	      <p>
		Issues a response to each command
		(<span class="command"><strong>2<em class="parameter"><code>xx</code></em></strong></span>,
		<span class="command"><strong>4<em class="parameter"><code>xx</code></em></strong></span>, or
		<span class="command"><strong>5<em class="parameter"><code>xx</code></em></strong></span>,
		depending on whether delivery to this recipient was
		accepted, subject to a temporary failure, or
		rejected).
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		Issues a <span class="command"><strong>DATA</strong></span> command to indicate
		that it is ready to send the message.
	      </p>
	    </td><td align="left">
	      <p>
		Responds <span class="command"><strong>354</strong></span> to indicate that the
		command has been provisionally accepted.
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		Transmits the message, starting with RFC 2822
		compliant header lines (such as:
		<code class="option">From:</code>, <code class="option">To:</code>,
		<code class="option">Subject:</code>, <code class="option">Date:</code>,
		<code class="option">Message-ID:</code>).  The header and the
		body are separated by an empty line.  To indicate the
		end of the message, the client sends a single period
		(".") on a separate line.
	      </p>
	    </td><td align="left">
	      <p>
		Replies <span class="command"><strong>250</strong></span> to indicate that the
		message has been accepted.
	      </p>
	    </td></tr><tr><td align="left">
	      <p>
		If there are more messages to be delivered, issues the
		next <span class="command"><strong>MAIL FROM:</strong></span> command.
		Otherwise, it says <span class="command"><strong>QUIT</strong></span>, or in rare
		cases, simply disconnects.
	      </p>
	    </td><td align="left">
	      <p>
		Disconnects.
	      </p>
	    </td></tr></tbody></table></div></div><br class="table-break"></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm419" class="footnote"><p><a href="#idm419" class="para"><sup class="para">[1] </sup></a>
		Untrusted third party hosts may still generate
		collateral spam if you reject the mail.  However,
		unless that host is an <a class="xref" href="#openproxy" title="Open Proxy">Open Proxy</a> or
		<a class="xref" href="#openrelay" title="Open Relay">Open Relay</a>, it presumably delivers
		mail only from legitimate senders, whose addresses are
		valid.  If it <span class="emphasis"><em>is</em></span> an Open Proxy or
		SMTP Relay - well, it is better that you reject the
		mail and let it freeze in <span class="emphasis"><em>their</em></span>
		outgoing mail queue than letting it freeze in yours.
		Eventually, this ought to give the owners of that
		server a clue.
	      </p></div><div id="ftn.idm452" class="footnote"><p><a href="#idm452" class="para"><sup class="para">[2] </sup></a>
	      Personally I do not think challenge/response systems are
	      a good idea in any case.  They generate <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>, they require special attention for
	      mail sent from automated sources such as monthly bank
	      statements, and they degrade the usability of e-mail as
	      people need to jump through hoops to get in touch with
	      each other.  Many times, senders of legitimate mail will
	      not bother to or know that they need to follow up to the
	      confirmation request, and the mail is lost.
	    </p></div><div id="ftn.idm465" class="footnote"><p><a href="#idm465" class="para"><sup class="para">[3] </sup></a>
	  My view stands in sharp contrast to that of a large number
	  of <span class="quote">&#8220;<span class="quote">spam hacktivists</span>&#8221;</span>, such as the maintainers
	  of the <a class="ulink" href="http://www.spews.org/" target="_top">SPEWS</a>
	  <a class="link" href="#dnsbl" title="2.1. DNS Blacklists">blacklist</a>.  One of the stated
	  aims of this list is precisely to inflict <a class="xref" href="#coldamage" title="Collateral Damage">Collateral Damage</a> as a means of putting pressure on ISPs
	  to react on abuse complaints.  Listing complaints are
	  typically met with knee-jerk responses such as <span class="quote">&#8220;<span class="quote">bother
	  your ISP, not us</span>&#8221;</span>, or <span class="quote">&#8220;<span class="quote">get another ISP</span>&#8221;</span>.
	</p><p>
	  Often, these are not viable options.  Consider developing
	  countries.  For that matter, consider the fact that nearly
	  everywhere, broadband providers are regulated monopolies.  I
	  believe that these attitudes illustrate the exact crux of
	  the problem with trusting these groups.
	</p><p>
	  Put plainly, there are much better and more accurate ways
	  available to filter junk mail.
	</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="techniques"></a>Chapter 2. Techniques</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#smtpdelays">1. SMTP Transaction Delays</a></span></dt><dt><span class="section"><a href="#dnschecks">2. DNS Checks</a></span></dt><dd><dl><dt><span class="section"><a href="#dnsbl">2.1. DNS Blacklists</a></span></dt><dt><span class="section"><a href="#rdns">2.2. DNS Integrity Check</a></span></dt></dl></dd><dt><span class="section"><a href="#smtpchecks">3. SMTP checks</a></span></dt><dd><dl><dt><span class="section"><a href="#helocheck">3.1. Hello (HELO/EHLO) checks</a></span></dt><dt><span class="section"><a href="#senderchecks">3.2. Sender Address Checks</a></span></dt><dt><span class="section"><a href="#rcptchecks">3.3. Recipient Address Checks</a></span></dt></dl></dd><dt><span class="section"><a href="#greylisting">4. Greylisting</a></span></dt><dd><dl><dt><span class="section"><a href="#greylisting-theory">4.1. How it works</a></span></dt><dt><span class="section"><a href="#greylisting-multimx">4.2. Greylisting in Multiple Mail Exchangers</a></span></dt><dt><span class="section"><a href="#greylisting-results">4.3. Results</a></span></dt></dl></dd><dt><span class="section"><a href="#senderauth">5. Sender Authorization Schemes</a></span></dt><dd><dl><dt><span class="section"><a href="#spf">5.1. Sender Policy Framework (SPF)</a></span></dt><dt><span class="section"><a href="#ms-cide">5.2. Microsoft Caller-ID for E-Mail</a></span></dt><dt><span class="section"><a href="#rmxplus">5.3. RMX++</a></span></dt></dl></dd><dt><span class="section"><a href="#datachecks">6. Message data checks</a></span></dt><dd><dl><dt><span class="section"><a href="#headerchecks">6.1. Header checks</a></span></dt><dt><span class="section"><a href="#jmsr">6.2. Junk Mail Signature Repositories</a></span></dt><dt><span class="section"><a href="#garbagechars">6.3. Binary garbage checks</a></span></dt><dt><span class="section"><a href="#mimeerrors">6.4. MIME checks</a></span></dt><dt><span class="section"><a href="#fileext">6.5. File Attachment Check</a></span></dt><dt><span class="section"><a href="#virusscanners">6.6. Virus Scanners</a></span></dt><dt><span class="section"><a href="#spamscanners">6.7. Spam Scanners</a></span></dt></dl></dd><dt><span class="section"><a href="#collateral">7. Blocking Collateral Spam</a></span></dt><dd><dl><dt><span class="section"><a href="#bogusviruswarning">7.1. Bogus Virus Warning Filter</a></span></dt><dt><span class="section"><a href="#addspf">7.2. Publish SPF info for your domain</a></span></dt><dt><span class="section"><a href="#signedsender">7.3. Enveloper Sender Signature</a></span></dt><dt><span class="section"><a href="#dsnrealuser">7.4. Accept Bounces Only for Real Users</a></span></dt></dl></dd></dl></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      In this chapter, we look at various ways to weed out junk mail
      during the SMTP transaction from remote hosts.  We will also try
      to anticipate some of the side effects from deploying these
      techniques.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="smtpdelays"></a>1. SMTP Transaction Delays</h2></div></div></div><p>
      As it turns out, one of the more effective ways of stopping spam
      is by imposing transaction delays during an inbound SMTP
      dialogue.  This is a primitive form of
      <span class="emphasis"><em>teergrubing</em></span>, see: <a class="ulink" href="http://www.iks-jena.de/mitarb/lutz/usenet/teergrube.en.html" target="_top">http://www.iks-jena.de/mitarb/lutz/usenet/teergrube.en.html</a>
    </p><p>
      Most spam and nearly all e-mail borne virii are delivered
      directly to your server by way of specialized SMTP client
      software, optimized for sending out large amounts of mail in a
      very short time.  Such clients are commonly known as
      <a class="xref" href="#ratware" title="Ratware">Ratware</a>.
    </p><p>
      In order to accomplish this task, ratware authors commonly take
      a few shortcuts that, ahem, <span class="quote">&#8220;<span class="quote">diverge</span>&#8221;</span> a bit
      from the RFC 2821 specification.  One of the intrinsic traits of
      ratware is that it is notoriously impatient, especially with
      slow-responding mail servers.  They may issue the
      <span class="command"><strong>HELO</strong></span> or <span class="command"><strong>EHLO</strong></span> command
      before the server has presented the initial SMTP banner, and/or
      try to pipeline several SMTP commands before the server has
      advertised the <span class="command"><strong>PIPELINING</strong></span> capability.
    </p><p>
      Certain <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>s (such as Exim) automatically
      treat such SMTP protocol violations as
      <span class="emphasis"><em>synchronization errors</em></span>, and immediately
      drop the incoming connection.  If you happen to be using such an
      MTA, you may already see a lot of entries to this effect in your
      log files.  In fact, chances are that if you perform any
      time-consuming checks (such as 
      <a class="xref" href="#dnschecks" title="2. DNS Checks">DNS checks</a>) prior to presenting the initial
      SMTP banner, such errors will occur frequently, as ratware
      clients simply do not take the time to wait for your server to
      come alive (Things to do, people to spam).
    </p><p>
      We can help along by imposing additional delays.  For instance,
      you may decide to wait:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  20 seconds before presenting the initial SMTP banner,
	</p></li><li class="listitem"><p>
	  20 seconds after the Hello (<span class="command"><strong>EHLO</strong></span> or
	  <span class="command"><strong>HELO</strong></span>) greeting,
	</p></li><li class="listitem"><p>
	  20 seconds, after the <span class="command"><strong>MAIL FROM:</strong></span>
	  command, and
	</p></li><li class="listitem"><p>
	  20 seconds after each <span class="command"><strong>RCPT TO:</strong></span> command.
	</p></li></ul></div><p>
      Where did 20 seconds come from, you ask.  Why not a minute?  Or
      several minutes?  After all, RFC 2821 mandates that the sending
      host (client) should wait up to several minutes for every SMTP
      response.  The issue is that some receiving hosts, particularly
      those that use Exim, may perform <a class="xref" href="#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a> in
      response to incoming mail delivery attempts.  If you or one of
      your users send mail to such a host, it will contact the <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a> (MX host) for your domain and start an SMTP
      dialogue in order to validate the sender address.  The default
      timeout of such <a class="xref" href="#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a>s is 30 seconds - if
      you impose delays this long, the peer's sender callout
      verification would fail, and in turn the original mail delivery
      from you/your user might be rejected (usually with a temporary
      failure, which means the message delivery will be retried for 5
      days or so before the mail is finally returned to the sender).
    </p><p>
      In other words, 20 seconds is about as long as you can stall
      before you start interfering with legitimate mail deliveries.
    </p><p>
      If you do not like imposing such delays on every SMTP
      transaction (say, you have a very busy site and are low on
      machine resources), you may choose to use
      <span class="quote">&#8220;<span class="quote">selective</span>&#8221;</span> transaction delays.  In this case, you
      could impose the delay:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  If there is a problem with the peer's DNS information (see
	  <a class="xref" href="#dnschecks" title="2. DNS Checks">DNS checks</a>).
	</p></li><li class="listitem"><p>
	  After detecting some sign of trouble during the SMTP
	  transaction (see <a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a>).
	</p></li><li class="listitem"><p>
	  Only in the highest-numbered MX host in your DNS zone,
	  i.e. the mail exchanger with the last priority.  Often,
	  <a class="xref" href="#ratware" title="Ratware">Ratware</a> specifically target these hosts,
	  whereas legitimate MTAs will try the lower-numbered MX hosts
	  first.
	</p></li></ul></div><p>
      In fact, selective transaction delays may be a good way to
      incorporate some less conclusive checks that we will discuss in
      the following sections.  You probably do not wish to reject the
      mail outright based the results from e.g. the SPEWS <a class="link" href="#dnsbl" title="2.1. DNS Blacklists">blacklist</a>, but on the other hand, it may
      provide a strong enough indication of trouble that you can at
      least impose transaction delays.  After all, legitimate mail
      deliveries are not affected, other than being subjected to a
      slight delay.
    </p><p>
      Conversely, if you find conclusive evidence of spamming (e.g. by
      way of certain <a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a>), and your server
      can afford it, you may choose to impose an extended delay,
      e.g. 15 minutes or so, before finally rejecting the delivery
      <a href="#ftn.idm632" class="footnote" name="idm632"><sup class="footnote">[4]</sup></a>.
      This is for little or no benefit other than slowing down the
      spammer a little bit in their quest to reach as many people as
      possible before DNS blacklists and other collaborative network
      checks catch up.  In other words, pure altruism on your
      side. :-)
    </p><p>
      In my own case, selective transaction delays and the resulting
      SMTP synchronization errors account for nearly 50% of rejected
      incoming delivery attempts.  This roughly translates into saying
      that nearly 50% of incoming junk mail is stopped by SMTP
      transaction delays alone.
    </p><p>
      See also <a class="link" href="#qanda-adapt" title="Q:"><span class="emphasis"><em>What happens when
      spammers adapt...</em></span></a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dnschecks"></a>2. DNS Checks</h2></div></div></div><p>
      Some indication of the integrity of a particular peer can be
      gleaned directly from the <a class="xref" href="#dns" title="Domain Name System">Domain Name System</a> (DNS), even
      before SMTP commands are issued.  In particular, various DNS
      blacklists can be consulted to find out if a particular IP
      address is known to violate or fulfill certain criteria, and a
      simple pair of forward/reverse (DNS/rDNS) lookups can be used as
      a vague indicator of the host's general integrity.
    </p><p>
      Moreover, various data items presented during the SMTP dialogue
      (such as the name presented in the Hello greeting) can be
      subjected to DNS validation, once it becomes available.  For a
      discussion on these items, see the section on <a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a>, below.
    </p><p>
      A word of caution, though.  DNS checks are not always conclusive
      (e.g. a required DNS server may not be responding), and not
      always indicative of spam.  Moreover, if you have a very busy
      site, they can be expensive in terms of processing time per
      message.  That said, they can provide useful information for
      logging purposes, and/or as part of a more holistic integrity
      check.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dnsbl"></a>2.1. DNS Blacklists</h3></div></div></div><p>
	DNS blacklists (DNSbl's, formerly called "Real-time Black-hole
	Lists" after the original blacklist, "mail-abuse.org") make up
	perhaps the most common tool to perform transaction-time spam
	blocking.  The receiving server performs one or more rDNS
	lookups of the peer's IP address within various DNSbl zones,
	such as "dnsbl.sorbs.net", "opm.blitzed.org",
	"lists.dsbl.org", and so forth.  If a matching DNS record is
	found, a typical action is to reject the mail delivery.
	<a href="#ftn.idm649" class="footnote" name="idm649"><sup class="footnote">[5]</sup></a>
      </p><p>
	If in addition to the DNS address ("A" record) you look up the
	"TXT" record of an entry, you will typically receive a
	one-line description of the listing, suitable for inclusion in
	a SMTP reject response.  To try this out, you can use the
	"host" command provided on most Linux and UNIX systems:
	</p><pre class="screen">host -t txt 2.0.0.127.dnsbl.sorbs.net</pre><p>
      </p><p>
	There are currently hundreds of these lists available, each
	with different listing criteria, and with different
	listing/unlisting policies. Some lists even combine several
	listing criteria into the same DNSbl, and issue different data
	in response to the rDNS lookup, depending on which criterion
	affects the address provided.  For instance, a rDNS lookup
	against <code class="option">sbl-xbl.spamhaus.org</code> returns
	127.0.0.2 for IP addresses that are believed by the SpamHaus
	staff to directly belong to spammers and their providers,
	127.0.0.4 response for <a class="xref" href="#zombie" title="Zombie Host">Zombie Host</a>s, or a
	127.0.0.6 response for <a class="xref" href="#openproxy" title="Open Proxy">Open Proxy</a> servers.
      </p><p>
	Unfortunately, many of these lists contain large blocks of IP
	addresses that are not directly responsible for the alleged
	violations, don't have clear listing / delisting policies,
	and/or post misleading information about which addresses are
	listed<a href="#ftn.idm661" class="footnote" name="idm661"><sup class="footnote">[6]</sup></a>.

	The blind trust in such lists often cause a large amount of
	what is referred to as <a class="xref" href="#coldamage" title="Collateral Damage">Collateral Damage</a> (not to be
	confused with <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>).
      </p><p>
	For that reason, rather than rejecting mail deliveries
	outright based on a single positive response from DNS
	blacklists, many administrators prefer to use these lists in a
	more nuanced fashion.  They may consult several lists, and
	assign a "score" to each positive response.  If the total
	score for a given IP address reaches a given threshold,
	deliveries from that address are rejected.  This is how DNS
	blacklists are used by filtering software such as
	SpamAssassin (<a class="xref" href="#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a>).
      </p><p>
	One could also use such lists as one of several triggers for
	SMTP transaction delays on incoming connections
	(a.k.a. "teergrubing").  If a host is listed in a DNSbl, your
	server would delay its response to every SMTP command issued
	by the peer for, say, 20 seconds.  Several other criteria can
	be used as triggers for such delays; see the section on 
	<a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rdns"></a>2.2. DNS Integrity Check</h3></div></div></div><p>
	Another way to use DNS is to perform a reverse lookup of the
	peer's IP address, then a forward lookup of the resulting
	name.  If the original IP address is included in the result,
	its DNS integrity has been validated.  Otherwise, the DNS
	information for the connecting host is not valid.
      </p><p>
	Rejecting mails based on this criterion may be an option if
	you are a militant member of the DNS police, setting up an
	incoming MX for your own personal domain, and don't mind
	rejecting legitimate mail as a way to impress upon the sender
	that they need to ask their own system administrator to clean
	up their DNS records.  For everyone else, the result of a DNS
	integrity check should probably only be used as one data point
	in a larger set of heuristics.  Alternatively, as above, using
	SMTP transaction delays for misconfigured hosts may not be a
	bad idea.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="smtpchecks"></a>3. SMTP checks</h2></div></div></div><p>
      Once the SMTP dialogue is underway, you can perform various
      checks on the commands and arguments presented by the remote
      host.  For instance, you will want to ensure that the name
      presented in the Hello greeting is valid.
    </p><p>
      However, even if you decide to reject the delivery attempt early
      in the SMTP transaction, you may not want to perform the actual
      rejection right away.  Instead, you may stall the sender with
      SMTP transaction delays until after the <span class="command"><strong>RCPT
      TO:</strong></span>, then reject the mail at that point.
    </p><p>
      The reason is that some ratware does not understand rejections
      early in the SMTP transaction; they keep trying.  On the other
      hand, most of them give up if the <span class="command"><strong>RCPT TO:</strong></span>
      fails.
    </p><p>
      Besides, this gives a nice opportunity to do a little
      <span class="emphasis"><em>teergrubing</em></span>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="helocheck"></a>3.1. Hello (HELO/EHLO) checks</h3></div></div></div><p>
	Per RFC 2821, the first SMTP command issued by the client
	should be EHLO (or if unsupported, HELO), followed by its
	primary, <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>.  This is known as the Hello
	greeting.  If no meaningful FQDN is available, the client can
	supply its IP address enclosed in square brackets:
	"[1.2.3.4]".  This last form is known as an IPv4 address
	"literal" notation.
      </p><p>
	Quite understandably, <a class="xref" href="#ratware" title="Ratware">Ratware</a> rarely present
	their own FQDN in the Hello greeting.  Rather, greetings from
	ratware usually attempt to conceal the sending host's
	identity, and/or to generate confusing and/or misleading
	"Received:" trails in the message header.  Some examples of
	such greetings are:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    Unqualified names (i.e. names without a period), such as
	    the <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span> (username) of the
	    recipient address.
	  </p></li><li class="listitem"><p>
	    A plain IP address (i.e. not an IP literal); usually
	    yours, but can be a random one.
	  </p></li><li class="listitem"><p>
	    Your domain name, or the FQDN of your server.
	  </p></li><li class="listitem"><p>
	    Third party domain names, such as
	    <code class="option">yahoo.com</code> and
	    <code class="option">hotmail.com</code>.
	  </p></li><li class="listitem"><p>
	    Non-existing domain names, or domain names with
	    non-existing name servers.
	  </p></li><li class="listitem"><p>
	    No greeting at all.
	  </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="helosyntax"></a>3.1.1. Simple HELO/EHLO syntax checks</h4></div></div></div><p>
	  Some of these RFC 2821 violations are both easy to check
	  against, and clear indications that the sending host is
	  running some form of <a class="xref" href="#ratware" title="Ratware">Ratware</a>.  You can
	  reject such greetings -- either right away, or e.g. after
	  the <span class="command"><strong>RCPT TO:</strong></span> command.
	</p><p>
	  First, feel free to reject plain IP addresses in the Hello
	  greeting.  Even if you wish to generously allow everything
	  RFC 2821 mandates, recommends, and suggests, you will note
	  that IP addresses should always be enclosed in square
	  brackets when presented in lieu of a name.
	  <a href="#ftn.idm718" class="footnote" name="idm718"><sup class="footnote">[7]</sup></a>
	</p><p>
	  In particular, you may wish to issue a strongly worded
	  rejection message to hosts that introduce themselves using
	  <span class="emphasis"><em>your</em></span> IP address - or for that matter,
	  your host name.  They are plainly lying.  Perhaps you want
	  to stall the sender with an exceedingly long SMTP
	  transaction delay in response to such a greeting; say,
	  hours.
	</p><p>
	  For that matter, my own experience indicates that
	  <span class="emphasis"><em>no</em></span> legitimate sites on the internet
	  present themselves to other internet sites using an IP
	  address literal (the [x.y.z.w] notation) either.  Nor should
	  they; all hosts sending mail directly on the internet should
	  use their valid <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>.  The only use of use
	  of IP literals I have come across is from mail user agents
	  on my local area network, such as Ximian Evolution,
	  configured to use my server as outgoing SMTP server
	  (smarthost).  Indeed, I only accept literals from my own
	  LAN.
	</p><p>
	  You may or may not also wish to reject unqualified host
	  names (host names without a period).  I find that these are
	  rarely (but not never - how's that for double negative
	  negations) legitimate.
	</p><p>
	  Similarly, you can reject host names that contain invalid
	  characters.  For internet domains, only alphanumeric letters
	  and hyphen are valid characters; a hyphen is not allowed as
	  the first character.  (You may also want to consider the
	  underscore a valid character, because it is quite common to
	  see this from misconfigured, but ultimately well-meaning,
	  Windows clients).
	</p><p>
	  Finally, if you receive a <span class="command"><strong>MAIL FROM:</strong></span>
	  command without first having received a Hello greeting,
	  well, polite people greet first.
	</p><p>
	  On my servers, I reject greetings that fail any of these
	  syntax checks.  However, the rejection does not actually
	  take place until after the <span class="command"><strong>RCPT TO:</strong></span>
	  command.  In the mean time, I impose a 20 second transaction
	  delay after each SMTP command (<span class="command"><strong>HELO/EHLO</strong></span>,
	  <span class="command"><strong>MAIL FROM:</strong></span>, <span class="command"><strong>RCPT TO:</strong></span>).
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="heloverify"></a>3.1.2. Verifying the Hello greeting via DNS</h4></div></div></div><p>
	  Hosts that make it this far have presented at least a
	  superficially credible greeting.  Now it is time to verify
	  the provided name via DNS.  You can:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      Perform a forward lookup of the provided name, and
	      match the result against the peer's IP address
	    </p></li><li class="listitem"><p>
	      Perform a reverse lookup of the peer's IP address, and
	      match it against name provided in the greeting.
	    </p></li></ul></div><p>
	  If either of these two checks succeeds, the name has been
	  verified.
	</p><p>
	  Your MTA may have a built-in option to perform this check.
	  For instance, in Exim (see <a class="xref" href="#exim" title="Appendix A. Exim Implementation">Appendix A, <i>Exim Implementation</i></a>),
	  you want to set "helo_try_verify_hosts = *", and create ACLs
	  that take action based on the "verify = helo" condition.
	</p><p>
	  This check is a little more expensive in terms of processing
	  time and network resources than the simple syntax checks.
	  Moreover, unlike the syntax checks, a mismatch does not
	  always indicate ratware; several large internet sites, such
	  as hotmail.com, yahoo.com, and amazon.com, frequently
	  present unverifiable Hello greetings.
	</p><p>
	  On my servers, I do a DNS validation of the Hello greeting
	  if I am not already stalling the sender with transaction
	  delays based on prior checks.  Then, if this check fails, I
	  impose a 20 second delay on every SMTP command from this
	  point forward.  I also prepare a
	  <span class="quote">&#8220;<span class="quote">X-HELO-Warning:</span>&#8221;</span> header that I will later add
	  to the message(s), and use to increase the <a class="link" href="#spamassassin">SpamAssassin</a> score for
	  possible rejection after the message data has been received.
	</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="senderchecks"></a>3.2. Sender Address Checks</h3></div></div></div><p>
	After the client has presented the
	<span class="command"><strong>MAIL FROM:</strong></span> &lt;<em class="parameter"><code>address</code></em>&gt;
	command, you can validate the supplied
	<a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address as follows.
	<a href="#ftn.idm756" class="footnote" name="idm756"><sup class="footnote">[8]</sup></a>
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="sendersyntax"></a>3.2.1. Sender Address Syntax Check</h4></div></div></div><p>
	  Does the supplied address conform to the format
	  &lt;<em class="parameter"><code>localpart</code></em>@<em class="parameter"><code>domain</code></em>&gt;?
	  Is the <em class="parameter"><code>domain</code></em> part a syntactically
	  valid <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>?
	</p><p>
	  Often, your MTA performs these checks by default.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="impostor"></a>3.2.2. Impostor Check</h4></div></div></div><p>
	  In the case where you and your users send all your outgoing
	  mail only through a select few servers, you can reject
	  messages from other hosts in which the <span class="quote">&#8220;<span class="quote">domain</span>&#8221;</span>
	  of the sender address is your own.
	</p><p>
	  A more general alternative to this check is
	  <a class="xref" href="#spf" title="5.1. Sender Policy Framework (SPF)">Sender Policy Framework</a>.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="sendervalid"></a>3.2.3. Simple Sender Address Validation</h4></div></div></div><p>
	  If the address is local, is the <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span>
	  (the part before the @ sign) a valid mailbox on your
	  system?
	</p><p>
	  If the address is remote, does the <span class="quote">&#8220;<span class="quote">domain</span>&#8221;</span>
	  (the part after the @ sign) exist?
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="callback"></a>3.2.4. Sender Callout Verification</h4></div></div></div><p>
	  This is a mechanism that is offered by some MTAs, such as
	  Exim and Postfix, to validate the <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span>
	  of a remote sender address.  In Postfix terminology, it is
	  called <span class="quote">&#8220;<span class="quote">Sender Address Verification</span>&#8221;</span>.
	</p><p>
	  Your server contacts the MX for the
	  <em class="parameter"><code>domain</code></em> provided in the sender
	  address, attempting to initiate a secondary SMTP transaction
	  as if delivering mail to this address.  It does not actually
	  send any mail; rather, once the <span class="command"><strong>RCPT TO:</strong></span>
	  command has been either accepted or rejected by the remote
	  host, your server sends <span class="command"><strong>QUIT</strong></span>.
	</p><p>
	  By default, Exim uses an empty envelope sender address for
	  such callout verifications.  The goal is to determine if a
	  <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> would be accepted if returned to the
	  sender.
	</p><p>
	  Postfix, on the other hand, defaults to the sender address
	  &lt;<code class="option">postmaster@</code><em class="parameter"><code>domain</code></em>&gt;
	  for address verification purposes
	  (<em class="parameter"><code>domain</code></em> is taken from the
	  <code class="option">$myorigin</code> variable).  For this reason, you
	  may wish to treat this sender address the same way that you
	  treat the NULL envelope sender (for instance, avoid <a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a> or <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a>, but
	  require <a class="xref" href="#signedsender" title="7.3. Enveloper Sender Signature">Envelope Sender Signature</a>s in recipient
	  addresses).  More on this in the implementation appendices.
	</p><p>
	  You may find that this check alone may not be suitable as a
	  trigger to reject incoming mail.  Occasionally, legitimate
	  mail, such as a recurring billing statement, is sent out
	  from automated services with an invalid return address.
	  Also, an unfortunate side effect of spam is that some users
	  tend to mangle the return address in their outgoing mails
	  (though this may affect the <span class="quote">&#8220;<span class="quote">From:</span>&#8221;</span> header in
	  the message itself more often than the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>).
	</p><p>
	  Moreover, this check only verifies that an address is valid,
	  not that it was authentic as the sender of this particular
	  message (but see also <a class="xref" href="#signedsender" title="7.3. Enveloper Sender Signature">Envelope Sender Signature</a>).
	</p><p>
	  Finally, there are reports of sites, such as
	  <span class="quote">&#8220;<span class="quote">aol.com</span>&#8221;</span>, that will unconditionally blacklist
	  any system from which they discover sender callout requests.
	  These sites may be frequent victims of <a class="xref" href="#joejob" title="Joe Job">Joe Job</a>s, and as a result, receive storms of
	  sender callout requests.  By taking part in these DDoS
	  (Distributed Denial-of-Servcie) attacks, you are effectively
	  turning yourself into a pawn in the hands of the spammer.
	</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rcptchecks"></a>3.3. Recipient Address Checks</h3></div></div></div><p>
	This should be simple, you say.  A recipient address is either
	valid, in which case the mail is delivered, or invalid, in
	which case your MTA takes care of the rejection by default.
      </p><p>
	Let us have a look, shall we?
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="relayprevent"></a>3.3.1. Open Relay Prevention</h4></div></div></div><p>
	  <span class="emphasis"><em>Do not relay mail from remote hosts to remote
	  addresses!</em></span> (Unless the sender is authenticated).
	</p><p>
	  This may seem obvious to most of us, but apparently this is
	  a frequently overlooked consideration.  Also, not everyone
	  may have a full grasp of the various internet standards
	  related to e-mail addresses and delivery paths (consider
	  <span class="quote">&#8220;<span class="quote">percent hack domains</span>&#8221;</span>, <span class="quote">&#8220;<span class="quote">bang (!) 
	  paths</span>&#8221;</span>, etc).
	</p><p>
	  If you are unsure whether your MTA acts as an <a class="xref" href="#openrelay" title="Open Relay">Open Relay</a>, you can test it via
	  <span class="quote">&#8220;<span class="quote">relay-test.mail-abuse.org</span>&#8221;</span>.
	  At a shell prompt on your server, type:

	  </p><pre class="screen">telnet relay-test.mail-abuse.org</pre><p>
	</p><p>
	  This is a service that will use various tests to see whether
	  your SMTP server appears to forward mail to remote e-mail
	  addresses, and/or any number of address <span class="quote">&#8220;<span class="quote">hacks</span>&#8221;</span>
	  such as the ones mentioned above.
	</p><p>
	  Preventing your servers from acting as open relays is
	  extremely important.  If your server is an open relay, and
	  spammers find you, you will be listed in numerous DNS
	  blacklists instantly.  If the maintainers of certain other
	  DNS blacklists find you (by probing, and/or by acting on
	  complaints), you will be listed in those for an extended
	  period of time.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="rcptvalid"></a>3.3.2. Recipient Address Lookups</h4></div></div></div><p>
	  This, too may seem banal to most of us.  It is not always so.
	</p><p>
	  If your users' mail accounts and mailboxes are stored
	  directly on your incoming mail exchanger, you can simply
	  check that the <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span> of the recipient
	  address corresponds to a valid mailbox.  No problem here.
	</p><p>
	  There are two scenarios where verification of the recipient
	  address is more cumbersome:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      If your machine is a backup MX for the recipient
	      domain.
	    </p></li><li class="listitem"><p>
	      If your machine forwards all mail for your domain to
	      another (presumably internal) server.
	    </p></li></ul></div><p>
	  The alternative to recipient address verification is to
	  accept all recipient addresses within these respective
	  domains, which in turn means that you or the destination
	  server might have to generate a <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> for
	  recipient addresses that later turn out to be invalid.
	  Ultimately, this means that you would be generating
	  collateral spam.
	</p><p>
	  With that in mind, let us see how we can verify the
	  recipient in the scenarios listed above.
	</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="callforward"></a>3.3.2.1. Recipient Callout Verification</h5></div></div></div><p>
	    This is a mechanism that is offered by some MTAs, such as
	    Exim and Postfix, to verify the <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span>
	    of a remote recipient address (see <span class="emphasis"><em><a class="xref" href="#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a></em></span> for a description of how
	    this works).  In Postfix terminology, this is called
	    <span class="quote">&#8220;<span class="quote">Recipient Address Verification</span>&#8221;</span>.
	  </p><p>
	    In this case, server attempts to contact the final
	    destination host to validate each recipient address before
	    you, in turn, accept the <span class="command"><strong>RCPT TO:</strong></span>
	    command from your peer.
	  </p><p>
	    This solution is simple and elegant.  It works with any
	    MTA that might be running on the final destination host,
	    and without access to any particular directory service.
	    Moreover, if that MTA happens to perform a fuzzy match on
	    the recipient address (this is the case with Lotus Domino
	    servers), this check will accurately reflect whether the
	    recipient address is eventually going to be accepted or
	    not - something which may not be true for the mechanisms
	    described below.
	  </p><p>
	    Be sure to keep the original <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>
	    intact for the recipient callout, or the response from the
	    destination host may not be accurate.  For instance, it
	    may reject bounces (i.e. mail with no envelope sender) for
	    system users and aliases, as described in <a class="xref" href="#dsnrealuser" title="7.4. Accept Bounces Only for Real Users">Accept Bounces Only for Real Users</a>.
	  </p><p>
	    Among major MTAs, Exim and Postfix support this mechanism.
	  </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="ldap"></a>3.3.2.2. Directory Services</h5></div></div></div><p>
	    Another good solution would be a directory service
	    (e.g. one or more LDAP servers) that can be queried by
	    your MTA.  The most common MTAs all support LDAP, NIS,
	    and/or various other backends that are commonly used to
	    provide user account information.
	  </p><p>
	    The main sticking point is that unless the final
	    destination host of the e-mail already uses such a
	    directory service to map user names to mailboxes, there
	    may be some work involved in setting this up.
	  </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="replicdir"></a>3.3.2.3. Replicated Mailbox Lists</h5></div></div></div><p>
	    If none of the options above are viable, you could fall
	    back to a <span class="quote">&#8220;<span class="quote">poor man's directory service</span>&#8221;</span>,
	    where you would periodically copy a current list of
	    mailboxes from the machine where they are located, to your
	    MX host(s).  Your MTA would then consult this list to
	    validate <span class="command"><strong>RCPT TO:</strong></span> commands in incoming
	    mail.
	  </p><p>
	    If the machine(s) that host(s) your mailboxes is/are
	    running on some flavor of UNIX or Linux, you could write a
	    script to first generate such a list, perhaps from the
	    local <span class="quote">&#8220;<span class="quote">/etc/passwd</span>&#8221;</span> file, and then copy it to
	    your MX host(s) using the <span class="quote">&#8220;<span class="quote">scp</span>&#8221;</span> command from
	    the <a class="ulink" href="http://www.openssh.org/" target="_top">OpenSSH</a>
	    suite.  You could then set up a <span class="quote">&#8220;<span class="quote">cron</span>&#8221;</span> job
	    (type <span class="command"><strong>man cron</strong></span> for details) to
	    periodically run this script.
	  </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="rcptmisses"></a>3.3.3. Dictionary Attack Prevention</h4></div></div></div><p>
	  <span class="emphasis"><em>Dictionary Attack</em></span> is a term used to
	  describe SMTP transactions where the sending host keeps
	  issuing <span class="command"><strong>RCPT TO:</strong></span> commands to probe for
	  possible recipient addresses based on common names (often
	  alphabetically starting with <span class="quote">&#8220;<span class="quote">aaron</span>&#8221;</span>, but
	  sometimes starting later in the alphabet, and/or at random).
	  If a particular address is accepted by your server, that
	  address is added into the spammer's arsenal.
	</p><p>
	  Some sites, particularly larger ones, find that they are
	  frequent targets of such attacks.  From the spammer's
	  perspective, chances of finding a given username on a
	  large site is better than on sites with only a few users.
	</p><p>
	  One effective way to combat dictionary attacks is to issue
	  increasing transaction delays for each failed address.  For
	  instance, the first non-existing recipient address can be
	  rejected with a 20-second delay, the second address with a
	  30-second delay, and so on.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dsnonercpt"></a>3.3.4. Accept only one recipient for DSNs</h4></div></div></div><p>
	  Legitimate <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s should be sent to only one
	  recipient address - the originator of the original message
	  that triggered the notification.  You can drop the
	  connection if the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address is
	  empty, but there are more than one recipients.
	</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="greylisting"></a>4. Greylisting</h2></div></div></div><p>
      The <span class="emphasis"><em>greylisting</em></span> concept is presented by
      Evan Harris in a whitepaper at:
      <a class="ulink" href="http://projects.puremagic.com/greylisting/" target="_top">http://projects.puremagic.com/greylisting/</a>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="greylisting-theory"></a>4.1. How it works</h3></div></div></div><p>
	Like <a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a>, greylisting is a simple but
	highly effective mechanism to weed out messages that are being
	delivered via <a class="xref" href="#ratware" title="Ratware">Ratware</a>.  The idea is to
	establish whether a prior relationship exists between the
	sender and the receiver of a message.  For most legitimate
	mail it does, and the delivery proceeds normally.
      </p><p>
	On the other hand, if no prior relationship exists, the
	delivery is temporariliy rejected (with a
	<span class="command"><strong>451</strong></span> SMTP response).  Legitimate MTAs will
	treat this response accordingly, and retry the delivery in a
	little while<a href="#ftn.noretrysenders" class="footnote" name="noretrysenders"><sup class="footnote">[9]</sup></a>.  In contrast, ratware will either make repeated
	delivery attempts right away, and/or simply give up and move
	on to the next target in its address list.
      </p><p>
	Three pieces of information from a delivery attempt, referred
	to a as a <span class="emphasis"><em>triplet</em></span> are used to uniquely
	identify the relationship between a sender and a receiver:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    The <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>.
	  </p></li><li class="listitem"><p>
	    The sending host's IP address.
	  </p></li><li class="listitem"><p>
	    The <a class="xref" href="#envto" title="Envelope Recipient">Envelope Recipient</a>.
	  </p></li></ul></div><p>
	If a delivery attempt was temporarily rejected, this triplet
	is cached.  It remains greylisted for a given amount of time
	(nominally 1 hour), after which it is whitelisted, and new
	delivery attempts would succeed.  If no new delivery attempts
	occur prior to a given timeout (nominally 4 hours), then the
	triplet expires from the cache.
      </p><p>
	If a whitelisted triplet has not been seen for an extended
	duration (at minimum one month, to account for monthly billing
	statements and the like), it is expired.  This prevents
	unlimited growth of the list.
      </p><p>
	These timeouts are taken from Evan Harris' original
	greylisting whitepaper (or should we say, ahem,
	<span class="quote">&#8220;<span class="quote">greypaper</span>&#8221;</span>?)  Some people have found that a
	larger timeout may be needed before greylisted triplets
	expire, because certain ISPs (such as
	<span class="emphasis"><em>earthlink.net</em></span>) retry deliveries only
	every 6 hours or similar.
	<a href="#ftn.idm914" class="footnote" name="idm914"><sup class="footnote">[10]</sup></a>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="greylisting-multimx"></a>4.2. Greylisting in Multiple Mail Exchangers</h3></div></div></div><p>
	If you operate more than one incoming mail exchangers, and
	each exchanger maintains its own greylisting cache, then:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    First-time deliveries from a given sender to one of your
	    users may theoretically be delayed up to
	    <em class="parameter"><code>N</code></em> times the initial 1-hour delay,
	    where <em class="parameter"><code>N</code></em> is the number of mail
	    exchangers.  This is because the message would likely be
	    retried at a different server than the one that issued the
	    <span class="command"><strong>451</strong></span> response to the initial delivery.
	    In the worst case, the sender host may not get around to
	    retrying the delivery to the first exchanger for 4 hours,
	    or until after the greylist triplet has expired, thereby
	    causing the delivery attempt to be rejected over and over
	    again, until the sender gives up (usually after 4 days or
	    so).
	  </p><p>
	    In practice, this is unlikely.  If a delivery attempt
	    temporarily fails, the sender host normally retries the
	    delivery immediately, using a different MX.  Thus, after
	    one hour, any of these MX hosts would accept the message.
	  </p></li><li class="listitem"><p>
	    Even after a triplet has been whitelisted in one of your
	    MXs, the next message with the same triplet will be
	    greylisted if it is delivered to a different MX.
	  </p></li></ul></div><p>
	For these reasons, you may want to implement a solution where
	the database of greylist triplets is shared between your
	incoming mail exchangers.  However, since the machine that
	hosts this database would become a single point of failure,
	you would have to take a sensible action if that machine is
	down (e.g. accept all deliveries). Or you could use database
	replication techniques and have the SMTP server fall back to
	one of the replicating servers for lookups.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="greylisting-results"></a>4.3. Results</h3></div></div></div><p>
	In my own experience, <span class="emphasis"><em>greylisting</em></span> gets
	rid of about 90% of unique junk mail deliveries,
	<span class="emphasis"><em>after</em></span> most of the <a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a> previously described are applied!  If
	you used greylisting as a first defense, it would likely catch
	an even higher percentage of incoming junk mail.
      </p><p>
	Conversely, there are virtually zero <a class="xref" href="#falsepos" title="False Positive">False Positive</a>s
	resulting from this technique.  All major <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>s
	perform delivery retries after a temporary failure, in a manner
	that will eventually result in a successful delivery.
      </p><p>
	The downside to greylisting is a legitimate mail from people
	who have not e-mailed a particular recipient in the past is
	subject to a one-hour delay (or maybe several hours, if you
	operate several MX hosts). 
      </p><p>
	See also <a class="link" href="#qanda-adapt" title="Q:"><span class="emphasis"><em>What happens when
	spammers adapt...</em></span></a>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="senderauth"></a>5. Sender Authorization Schemes</h2></div></div></div><p>
      Various schemes have been developed for sender verification
      where not only the validity, but also the authenticity, of
      the sender address is checked.  The owner of a internet
      domain specifies certain criteria that must be fulfilled in
      authentic deliveries from senders within that domain.
    </p><p>
      Two early proposed schemes of this kind were:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  <code class="option">MAIL-FROM</code> MX records, conceived by Paul
	  Vixie <code class="email">&lt;<a class="email" href="mailto:paul%20(at)%20vix.com">paul (at) vix.com</a>&gt;</code>
	</p></li><li class="listitem"><p>
	  Reverse Mail Exchanger (RMX) records as an addition to DNS
	  itself, conceived and published by Hadmut Danisch
	  <code class="email">&lt;<a class="email" href="mailto:hadmut%20(at)%20danisch.de">hadmut (at) danisch.de</a>&gt;</code>.
	</p></li></ul></div><p>
      Under both of these schemes, all mails from
      <code class="email">&lt;<a class="email" href="mailto:user@domain.com">user@domain.com</a>&gt;</code> had to come from the hosts
      specified in <code class="email">&lt;<a class="email" href="mailto:domain.com">domain.com</a>&gt;</code>'s DNS zone.
    </p><p>
      These schemes have evolved.  Alas, they have also forked.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spf"></a>5.1. Sender Policy Framework (SPF)</h3></div></div></div><p>
	<span class="quote">&#8220;<span class="quote">Server Policy Framework</span>&#8221;</span> (previously
	<span class="quote">&#8220;<span class="quote">Sender Permitted From</span>&#8221;</span>) is perhaps the most
	well-known scheme for sender authorization.  It is loosely
	based on the original schemes described above, but allows
	for a bit more flexibility in the criteria that can be
	posted by the domain holder.
      </p><p>
	SPF information is published as a <code class="option">TXT</code>
	record in a domain's top-level DNS zone.  This record can
	specify:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    which hosts are allowed to send mail from that domain
	  </p></li><li class="listitem"><p>
	    the mandatory presence of a GPG (GNU Privacy Guard)
	    signature in outgoing mail from the domain
	  </p></li><li class="listitem"><p>
	    other criteria; see
	    <a class="ulink" href="http://spf.pobox.com/" target="_top">http://spf.pobox.com/</a> for details.
	  </p></li></ul></div><p>
	The structure of the <span class="command"><strong>TXT</strong></span> record is still
	undergoing development, however basic features to accomplish
	the above are in place.  It starts with the string
	<code class="option">v=spf1</code>, followed by such modifiers as:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    <code class="option">a</code> - the IP address of
	    the domain itself is a valid sender host
	  </p></li><li class="listitem"><p>
	    <code class="option">mx</code> - the incoming mail exchanger for
	    that domain is also a valid sender
	  </p></li><li class="listitem"><p>
	    <code class="option">ptr</code> - if a rDNS lookup of the
	    sending host's IP address yields a name within the
	    domain portion of the sender address, it is a valid
	    sender.
	  </p></li></ul></div><p>
	Each of these modifiers may be prefixed with a plus sign (+),
	minus sign (-), question mark (?), or tilde (~) to indicate
	whether it specifies an authorative source, an non-authorative
	source, a neutral stance, or a likely non-authorative source,
	respectively.
      </p><p>
	Each modifier may also be extended with a colon, followed by
	an alternate domain name.  For instance, if you are a Comcast
	subscriber, your own DNS zone may include the string
	<span class="quote">&#8220;<span class="quote"><code class="option">-ptr:client.comcast.net
	ptr:comcast.net</code></span>&#8221;</span> to indicate that your
	outgoing e-mail never comes from a host that resolves to
	<em class="parameter"><code>anything</code></em>.client.comcast.net, but could
	come from other hosts that resolve to
	<em class="parameter"><code>anything</code></em><code class="option">.comcast.net</code>.
      </p><p>
	SPF information is currently published for a number of
	high-profile internet domains, such as aol.com,
	altavista.com, dyndns.org, earthlink.net, and google.com.
      </p><p>
	Sender authorization schemes in general and SPF in particular
	are not universally accepted.  In particular, one objection is
	that domain holders may effectively establish a monopoly on
	relaying outgoing mail from their users/customers.
      </p><p>
	Another objection is that SPF breaks traditional e-mail
	forwarding - the forwarding host may not have the authority to
	do so per the SPF information in the envelope sender domain.
	This is partly addressed via <a class="ulink" href="http://spf.pobox.com/srs.html" target="_top">SRS</a>, or
	<span class="emphasis"><em>Sender Rewriting Scheme</em></span>, wherein the
	forwarder of the mail will modify the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address to the format:
	</p><pre class="screen"><em class="parameter"><code>user</code></em>=<em class="parameter"><code>source.domain</code></em>@<em class="parameter"><code>forwarder.domain</code></em></pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ms-cide"></a>5.2. Microsoft Caller-ID for E-Mail</h3></div></div></div><p>
	Similar to SPF, in that acceptance criteria are posted
	via a TXT record in the sending domain's DNS zone.
	However, rather than relying on simple keywords, MS CIDE
	information consists of fairly large structures encoded in
	XML.  The XML schema is published under a license by
	Microsoft.
      </p><p>
	While SPF would nominally be used to check the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address of an e-mail, MS CIDE is
	mainly a tool to validate the RFC 2822 header of the
	message itself.  Thus, the earliest point at which such a
	check could be applied would be after the message data has
	been delivered, before issuing the final
	<span class="command"><strong>250</strong></span> response.
      </p><p>
	Quite frankly, dead on arrival.  Encumbered by patent issues
	and sheer complexity.
      </p><p>
	That said, Recent SPF tools posted on <a class="ulink" href="http://spf.pobox.com/" target="_top">http://spf.pobox.com/</a> are capable of checking MS
	Caller-ID information in addition to SPF.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="rmxplus"></a>5.3. RMX++</h3></div></div></div><p>
	(part of <span class="emphasis"><em>Simple Caller Authorization Framework -
	SCAF</em></span>).  This scheme is developed by Hadmut Danisch,
	who also conceived of the original RMX.
      </p><p>
	RMX++ allows for dynamic authorization by way of HTTP servers.
	The domain owner publishes a server location via DNS, and the
	receiving host contacts that server in order to obtain an
	<span class="emphasis"><em>authorization record</em></span> to verify the
	authenticity of the caller.
      </p><p>
	This scheme allows the domain owner more fine-grained control
	of criteria used to authenticate the sender address, without
	having to publicly reveal the structure of their network (as
	with SPF information in static TXT records).  For instance, an
	example from Hadmut is an authorization server that allows no
	more than five messages from a given address per day after
	business hours, then issues an alert once the limit has been
	reached.
      </p><p>
	Moreover, SCAF is not limited to e-mail, but can also be used
	to provide caller authentication for other services such as
	Voice over IP (VoIP).  
      </p><p>
	One possible downside with RMX++, as noted by Rick Stewart
	<code class="email">&lt;<a class="email" href="mailto:rick.stewart%20(at)%20theinternetco.net">rick.stewart (at) theinternetco.net</a>&gt;</code>, is its
	impact on machine and network resources: Replies from HTTP
	servers are not as widely cached as information obtained
	directly via DNS, and it is signifcantly more expensive to
	make an HTTP request than a DNS request.
      </p><p>
	Further, Rick notes that the dynamic nature of RMX++ makes
	faults harder to track.  If there is a five-message-per-day
	limit, as in the example above, and one message gets checked
	five times, then the limit is hit with a single message.  It
	makes re-checking a message impossible.
      </p><p>
	For more information on RMX, RMX++, and SCAF, refer to: <a class="ulink" href="http://www.danisch.de/work/security/antispam.html" target="_top">http://www.danisch.de/work/security/antispam.html</a>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="datachecks"></a>6. Message data checks</h2></div></div></div><p>
      Time has come to look at the content of the message itself.
      This is what conventional spam and virus scanners do, as they
      normally operate on the message after it has been accepted.
      However, in our case, we perform these checks
      <span class="emphasis"><em>before</em></span> issuing the final
      <span class="command"><strong>250</strong></span> response, so that we have a chance to
      reject the mail on the spot rather than later generating <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a>.
    </p><p>
      If your incoming mail exchangers are very busy (i.e. large site,
      few machines), you may find that performing some or all of these
      checks directly in the mail exchanger is too costly.  In
      particular, running <a class="xref" href="#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a> and <a class="xref" href="#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a> do take up a fair amount of CPU
      bandwidth and time.
    </p><p>
      If so, you will want to set up dedicated machines for these
      scanning operations.  Most server-side anti-spam and anti-virus
      software can be invoked over the network, i.e. from your mail
      exchanger.  More on this in the following chapters, where we
      discuss implementation for the various MTAs.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headerchecks"></a>6.1. Header checks</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headersmissing"></a>6.1.1. Missing Header Lines</h4></div></div></div><p>
	  <a class="ulink" href="http://www.ietf.org/rfc/rfc2822.txt" target="_top">RFC
	  2822</a> mandates that a message
	  <span class="emphasis"><em>should</em></span> contain at least the following
	  header lines:

</p><pre class="screen">
From: ...
To: ...
Subject: ...
Message-ID: ...
Date: ...
</pre><p>
	</p><p>
	  The absence of any of these lines means that the message
	  is not generated by a mainstream <a class="xref" href="#mua" title="Mail User Agent">Mail User Agent</a>, and
	  that it is probably junk
	  <a href="#ftn.idm1045" class="footnote" name="idm1045"><sup class="footnote">[11]</sup></a>.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headersyntax"></a>6.1.2. Header Address Syntax Check</h4></div></div></div><p>
	  Addresses presented in the message header (i.e. the
	  <span class="command"><strong>To:</strong></span>, <span class="command"><strong>Cc:</strong></span>,
	  <span class="command"><strong>From:</strong></span> ... fields) should be syntactically
	  valid.  Enough said.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headeraddress"></a>6.1.3. Simple Header Address Validation</h4></div></div></div><p>
	  For each address in the message header:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      If the address is local, is the <span class="emphasis"><em>local
	      part</em></span> (before the @ sign) a valid mailbox?
	    </p></li><li class="listitem"><p>
	      If the address is remote, does the <span class="emphasis"><em>domain
	      part</em></span> (after the @ sign) exist?
	    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headercallout"></a>6.1.4. Header Address Callout Verification</h4></div></div></div><p>
	  This works similar to <a class="xref" href="#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a> and <a class="xref" href="#callforward" title="3.3.2.1. Recipient Callout Verification">Recipient Callout Verification</a>.  Each remote header address is
	  verified by calling the primary MX for the corresponding
	  domain to determine if a <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> would be
	  accepted.
	</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmsr"></a>6.2. Junk Mail Signature Repositories</h3></div></div></div><p>
	One trait of junk mail is that it is sent to a large number of
	addresses.  If 50 other recipients have already flagged a
	particular message as spam, why couldn't you use this fact to
	decide whether or not to accept the message when it is
	delivered to you?  Better yet, why not set up <a class="xref" href="#spamtrap" title="Spam Trap">Spam Trap</a>s that feed a public pool of known spam?
      </p><p>
	I am glad you asked.  As it turns out, such pools do exist:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    <a class="ulink" href="http://razor.sf.net/" target="_top">Razor</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://pyzor.sf.net/" target="_top">Pyzor</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://rhyolite.com/anti-spam/dcc/" target="_top">Distributed
	    Checksum Clearinghouse (DCC)</a>
	  </p></li></ul></div><p>
	These tools have progressed beyond simple signature checks
	that only trigger if you receive an identical copy of a
	message that is known to be junk mail.  Rather, they evaluate
	common patterns, to account for slight variations in the
	message header and body.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="garbagechars"></a>6.3. Binary garbage checks</h3></div></div></div><p>
	Messages containing non-printable characters are rare.  When
	they do show up, the message is nearly always a virus, or in 
	some cases spam written in a non-western language, without the
	appropriate MIME encoding.
      </p><p>
	One particular case is where the message contains NUL
	characters (ordinal zero).  Even if you decide that figuring
	out what a <span class="emphasis"><em>non-printable</em></span> character means
	is more complex than beneficial, you might consider checking
	for this character.  That is because some <a class="xref" href="#mda" title="Mail Delivery Agent">Mail Delivery Agent</a>s, such as the <a class="ulink" href="http://asg.web.cmu.edu/cyrus/" target="_top">Cyrus Mail Suite</a>,
	will ultimately reject mails that contain it.
	<a href="#ftn.idm1096" class="footnote" name="idm1096"><sup class="footnote">[12]</sup></a>.

	If you use such software, you should definitely consider
	getting rid of NUL characters.
      </p><p>
	On the other hand, the (now obsolete) RFC 822 specification
	did not explicitly prohibit NUL characters in the message.
	For this reason, as an alternative to rejecting mails
	containing it, you may choose to strip these characters from
	the message before delivering it to Cyrus.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mimeerrors"></a>6.4. MIME checks</h3></div></div></div><p>
	Similarly, it might be worthwhile to validate the MIME
	structure of incoming message.  MIME decoding errors or
	inconsistencies do not happen very often; but when they do,
	the message is definitely junk.  Moreover, such errors may
	indicate potential problems in subsequent checks, such as
	<a class="xref" href="#fileext" title="6.5. File Attachment Check">File Attachment Check</a>s, <a class="xref" href="#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>,
	or <a class="xref" href="#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a>.
      </p><p>
	In other words, if the MIME encoding is illegal, reject the
	message.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fileext"></a>6.5. File Attachment Check</h3></div></div></div><p>
	When was the last time someone sent you a Windows screensaver
	(<span class="quote">&#8220;<span class="quote">.scr</span>&#8221;</span> file) or Windows Program Information File
	(<span class="quote">&#8220;<span class="quote">.pif</span>&#8221;</span>) that you actually wanted?
      </p><p>
	Consider blocking messages with <span class="quote">&#8220;<span class="quote">Windows
	executable</span>&#8221;</span> file attachment(s) - i.e. file names that
	end with a period followed by any of a number of three-letter
	combinations such as the above.  This check consumes
	significantly less resources on your server than <a class="xref" href="#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>, and may also catch new virii for
	which a signature does not yet exist in your anti-virus
	scanner.
      </p><p>
	For a more-or-less comprehensive list of such <span class="quote">&#8220;<span class="quote">file name
	extensions</span>&#8221;</span>, please visit: <a class="ulink" href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;290497" target="_top">http://support.microsoft.com/default.aspx?scid=kb;EN-US;290497</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="virusscanners"></a>6.6. Virus Scanners</h3></div></div></div><p>
	A number of different server-side virus scanners are
	available.  To name a few:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    <a class="ulink" href="http://www.vanja.com/tools/sophie/" target="_top">Sophie</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://www.kapersky.com/" target="_top">KAVDaemon</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://clamav.elektrapro.com/" target="_top">ClamAV</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://www.sald.com/" target="_top">DrWeb</a>
	  </p></li></ul></div><p>
	In situations where you are not willing to block all
	potentially dangerous files based on their file names alone
	(consider <span class="quote">&#8220;<span class="quote">.zip</span>&#8221;</span> files), such scanners are
	helpful.  Also, they will be able to catch virii that are
	not transmitted as file attachments, such as the
	<span class="quote">&#8220;<span class="quote">Bagle.R</span>&#8221;</span> virus that arrived in March, 2004.
      </p><p>
	In most cases, the machine performing the virus scan does not
	need to be your mail exchanger.  Most of these anti-virus
	scanners can be invoked on a different host over a network
	connection.
      </p><p>
	Anti-virus software mainly detect virii based on a set of
	signatures for known virii, or <span class="emphasis"><em>virus
	definitions</em></span>.  These need to be updated regularly,
	as new virii are developed.  Also, the software itself
	should at any time be up to date for maximum accuracy.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spamscanners"></a>6.7. Spam Scanners</h3></div></div></div><p>
	Similarly, anti-spam software can be used to classify messages
	based on a large set of heuristics, including their content,
	standards compliance, and various network checks such as <a class="xref" href="#dnsbl" title="2.1. DNS Blacklists">DNS Blacklists</a> and <a class="xref" href="#jmsr" title="6.2. Junk Mail Signature Repositories">Junk Mail Signature Repository</a>.  In the end,
	such software typically assigns a composite
	<span class="quote">&#8220;<span class="quote">score</span>&#8221;</span> to each message, indicating the
	likelihood that the message is spam, and if the score is above
	a certain threshold, would classify it as such.
      </p><p>
	Two of the most popular server-side heuristic anti-spam
	filters are:

	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a name="spamassassin"></a>
	      <a class="ulink" href="http://www.spamassassin.org/" target="_top">SpamAssassin</a>
	    </p></li><li class="listitem"><p><a name="brightmail"></a>
	      <a class="ulink" href="http://www.brightmail.com/" target="_top">BrightMail</a>
	    </p></li></ul></div><p>
      </p><p>
	These tools undergo a constant evolution as spammers find ways
	to circumvent their various checks.  For instance, consider
	<span class="quote">&#8220;<span class="quote">creative</span>&#8221;</span> spelling, such as <span class="quote">&#8220;<span class="quote">GR0W lO
	1NCH35</span>&#8221;</span>.  So, just like anti-virus software, if you use
	anti-spam software, you should update it frequently for the
	highest level of accuracy.
      </p><p>
	I use SpamAssassin, although to minimize impact on machine
	resources, it is no longer my first line of defense.  Out of
	approximately 500 junk mail delivery attempts to my personal
	address per day, about 50 reach the point where they are being
	checked by SpamAssassin (mainly because they are forwarded
	from one of my other accounts, so the checks described above
	are not effective).  Out of these 50 messages, one message
	ends up in my inbox approximately every 2 or 3 days.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="collateral"></a>7. Blocking Collateral Spam</h2></div></div></div><p>
      <a class="xref" href="#colspam" title="Collateral Spam">Collateral Spam</a> is more difficult to block with the
      techniques described so far, because it normally arrives from
      legitimate sites using standard mail transport software (such as
      Sendmail, Postfix, or Exim).  The challenge is to distinguish
      these messages from valid <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s returned in
      response to mail sent from your own users.  Here are some
      ways that people do this:
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bogusviruswarning"></a>7.1. Bogus Virus Warning Filter</h3></div></div></div><p>
	Most of the time, collateral spam is virus warnings generated
	by anti-virus scanners<a href="#ftn.idm1165" class="footnote" name="idm1165"><sup class="footnote">[13]</sup></a>.  In turn,
	the wording in the <code class="option">Subject:</code> line of these
	virus warnings, and/or other characteristics, is usually
	provided by the anti-virus software itself.  As such, you
	could create a list of the more common characteristics, and
	filter out such bogus virus warnings.
      </p><p>
	Well, aren't you in luck - someone already did this for
	you. :-)
      </p><p>
	Tim Jackson <code class="email">&lt;<a class="email" href="mailto:tim%20(at)%20timj.co.uk">tim (at) timj.co.uk</a>&gt;</code> maintains a
	list of bogus virus warnings for use with <a class="link" href="#spamassassin">SpamAssassin</a>.  This list is
	available at:
	<a class="ulink" href="http://www.timj.co.uk/linux/bogus-virus-warnings.cf" target="_top">http://www.timj.co.uk/linux/bogus-virus-warnings.cf</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="addspf"></a>7.2. Publish SPF info for your domain</h3></div></div></div><p>
	The purpose of the <a class="xref" href="#spf" title="5.1. Sender Policy Framework (SPF)">Sender Policy Framework</a> is precisely to
	protect against <a class="xref" href="#joejob" title="Joe Job">Joe Job</a>s; i.e. to prevent
	forgeries of valid e-mail addresses.
      </p><p>
	If you publish SPF records in the DNS zone for your domain,
	then recipient hosts that incorporate SPF checks would not
	have accepted the forged message in the first place.  As such,
	they would not be sending a <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> to your
	site.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="signedsender"></a>7.3. Enveloper Sender Signature</h3></div></div></div><p>
	A different approach that I am currently experimenting with
	myself is to add a signature in the local part of the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address in outgoing mail, then check for
	this signature in the <a class="xref" href="#envto" title="Envelope Recipient">Envelope Recipient</a> address before
	accepting incoming <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s.  For instance, the
	generated sender address might be of the following format:
	</p><pre class="screen"><em class="parameter"><code>localpart</code></em>=<em class="parameter"><code>signature</code></em>@<em class="parameter"><code>domain</code></em></pre><p>
      </p><p>
	Normal message replies are unaffected.  These replies go to
	the address in the <code class="option">From:</code> or
	<code class="option">Reply-To:</code> field of the message, which are
	left intact.
      </p><p>
	Sounds easy, doesn't it?  Unfortunately, generating a
	signature that is suitable for this purpose is a bit more
	complex than it sounds.  There are a couple of conflicting
	considerations to take into account:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    To gain any benefit from this method, the signed envelope
	    sender address that you generate should be useless in the
	    hands of spammers.  Typically, this would imply that the
	    signature incorporates a time stamp that would eventually
	    expire:

	    </p><pre class="screen"><em class="parameter"><code>sender</code></em>=<em class="parameter"><code>timestamp</code></em>=<em class="parameter"><code>hash</code></em>@<em class="parameter"><code>domain</code></em></pre><p>
	  </p></li><li class="listitem"><p>
	    If you send mail to a site that incorporates <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a>, your envelope sender address
	    should remain constant for that particular recipient.
	    Otherwise, your mail will continuously be greylisted.
	  </p><p>
	    With this in mind, you could generate a <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> based on the <a class="xref" href="#envto" title="Envelope Recipient">Envelope Recipient</a>
	    address:

	    </p><pre class="screen"><em class="parameter"><code>sender</code></em>=<em class="parameter"><code>recipient</code></em>=<em class="parameter"><code>recipient.domain</code></em>=<em class="parameter"><code>hash</code></em>@<em class="parameter"><code>domain</code></em></pre><p>

	    Although this address does not expire, if you start seeing
	    junk mail to it, you will at least know the source of the
	    leak - it is incorported in the recipient address.
	    Moreover, you can easily block specific recipient address
	    signatures, without affecting normal mail delivery to that
	    same recipient.
	  </p></li><li class="listitem"><p>
	    Two more issues occur with mailing list servers.  Usually,
	    replies to request mails (such as
	    <span class="quote">&#8220;<span class="quote">subscribe</span>&#8221;</span>/<span class="quote">&#8220;<span class="quote">unsubscribe</span>&#8221;</span>) are
	    sent with no envelope sender.
	  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
		The first issue pertains to servers that send
		responses back to the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>
		address of the request mail (as in the case of
		<code class="email">&lt;<a class="email" href="mailto:discuss@en.tldp.org">discuss@en.tldp.org</a>&gt;</code>).  The problem is
		that commands for the mailing list server (such as
		<span class="command"><strong>subscribe</strong></span> or
		<span class="command"><strong>unsubscribe</strong></span>) are typically sent to
		one or more different addresses
		(e.g. <code class="email">&lt;<a class="email" href="mailto:discuss-subscribe@en.tldp.org">discuss-subscribe@en.tldp.org</a>&gt;</code> and
		<code class="email">&lt;<a class="email" href="mailto:discuss-unsubscribe@en.tldp.org">discuss-unsubscribe@en.tldp.org</a>&gt;</code>,
		respectively) than the address used for list mail.
		Hence, the subscriber address will be different from
		the sender address in messages sent to the list itself
		-- and in this example, also different from the
		address that will be generated for unsubscription
		requests.  As a result, you may not be able to post to
		the list, or unsubscribe.
	      </p><p>
		The compromise would be to incorporate only the
		recipient <span class="emphasis"><em>domain</em></span> in the sender
		signature.  The sender address might then look like:
		</p><pre class="screen"><em class="parameter"><code>subscribername</code></em>=en.tldp.org=<em class="parameter"><code>hash</code></em>@<em class="parameter"><code>subscriber.domain</code></em></pre><p>
	      </p></li><li class="listitem"><p>
		The second issue pertains to those that send responses
		back to the reply address in the message header of the
		request mail (such as
		<code class="email">&lt;<a class="email" href="mailto:spam-l-request@peach.ease.lsoft.com">spam-l-request@peach.ease.lsoft.com</a>&gt;</code>).
		Since this address is not signed, the response from
		the list server would be blocked by your server.
	      </p><p>
		There is not much you can do about this, other than to
		<span class="quote">&#8220;<span class="quote">whitelist</span>&#8221;</span> these particular servers in
		such a way that they are allowed to return mail to
		unsigned recipient addresses.
	      </p></li></ul></div></li></ul></div><p>
	At this point, this approach starts losing some of its edge.
	Moreover, even legitimate DSNs are rejected unless the
	original mail has been sent via your server.  Thus, you should
	only consider doing this if for those of your users that do
	not roam, or otherwise send their outgoing mail via servers
	outside your control.
      </p><p>
	That said, in situations where none of the above concerns
	apply to you, this method gives you a good way to not only
	eliminate collateral spam, but also a way to educate the
	owners of the sites that (presumably unwittingly) generate it.
	Moreover, as a side benefit, sites that perform <a class="xref" href="#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a> will only get a positive response from
	you if the original mail was, indeed, sent from your site.  In
	essence, you are reducing your exposure to sender address
	forgeries by spammers.
      </p><p>
	You could perhaps allow your users to specify whether to sign
	outgoing mails, and if so, specify which hosts should be
	allowed to return mails to the unsigned version of their
	address.  For instance, if they have system accounts on your
	mail server, you could check for the existence and content,
	respectively, of a given file in their home directory.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dsnrealuser"></a>7.4. Accept Bounces Only for Real Users</h3></div></div></div><p>
	Even if you check for envelope sender signatures, there may be
	a loophole that allows bogus bounces to be accepted.
	Specifically, if your users have to opt in to the scheme, you
	are probably not checking for this signature in mails sent to
	system aliases, such as <code class="option">postmaster</code> or
	<code class="option">mailer-daemon</code>.  Moreover, since these users
	do not generate outgoing mail, they should not receive any
	bounces.
      </p><p>
	You can reject mail if it is sent to such system aliases, or
	alternatively, if there is no mailbox for the provided
	recipient address.
      </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm632" class="footnote"><p><a href="#idm632" class="para"><sup class="para">[4] </sup></a>
	  Beware that while you are holding up an incoming SMTP
	  delivery, you are also holding up a TCP socket on your
	  server, as well as memory and other server resources.  If
	  your server is generally busy, imposing SMTP transaction
	  delays will make you more vulnerable to Denial-of-Service
	  attacks.  A more <span class="quote">&#8220;<span class="quote">scalable</span>&#8221;</span> option may be to
	  drop the connection once you have conclusive evidence that
	  the sender is a ratware client.
	</p></div><div id="ftn.idm649" class="footnote"><p><a href="#idm649" class="para"><sup class="para">[5] </sup></a>
	    Similar lists exist for different purposes.  For instance,
	    <span class="quote">&#8220;<span class="quote">bondedsender.org</span>&#8221;</span> is a <span class="emphasis"><em>DNS
	    whitelist</em></span> (DNSwl), containing
	    <span class="quote">&#8220;<span class="quote">trusted</span>&#8221;</span> IP addresses, whose owners have
	    posted a financial bond that will be debited in the event
	    that spam originates from that address.  Other lists
	    contain IP addresses in use by specific countries,
	    specific ISPs, etc.
	  </p></div><div id="ftn.idm661" class="footnote"><p><a href="#idm661" class="para"><sup class="para">[6] </sup></a>
	  For instance, the outgoing mail exchangers (<span class="quote">&#8220;<span class="quote">smart
	  hosts</span>&#8221;</span>) of the world's largest Internet Service
	  Provider (ISP), comcast.net, is as of the time of this
	  writing included in the SPEWS <span class="emphasis"><em>Level 1</em></span>
	  list.  Not wholly undeserved from the viewpoint that
	  Comcast needs to more effectively enforce their own AUP,
	  but this listing does affect 30% of all US internet users,
	  mostly <span class="quote">&#8220;<span class="quote">innocent</span>&#8221;</span> subscribers such as myself.
	</p><p>
	  To make matters worse, information published in the <a class="ulink" href="http://spews.org/faq.html" target="_top">SPEWS FAQ</a> states:
	  <span class="emphasis"><em>
	    The majority of the Level 1 list is made up of netblocks
	    owned by the spammers or spam support operations
	    themselves, with few or no other legitimate customers
	    detected.
	  </em></span>
	  Technically, this information is accurate if (a) you
	  consider Comcast a <span class="quote">&#8220;<span class="quote">spam support operation</span>&#8221;</span>,
	  and (b) pay attention to the word <span class="quote">&#8220;<span class="quote">other</span>&#8221;</span>.
	  Word parsing aside, this information is clearly misleading.
	</p></div><div id="ftn.idm718" class="footnote"><p><a href="#idm718" class="para"><sup class="para">[7] </sup></a>
	      Although this check is normally quite effective at
	      weeding out junk, there are reports of buggy L-Soft
	      <a class="ulink" href="http://www.lsoft.com/products/default.asp?item=listserv" target="_top">listserv</a>
	      installations that greet with the plain IP address of
	      the list server.
	    </p></div><div id="ftn.idm756" class="footnote"><p><a href="#idm756" class="para"><sup class="para">[8] </sup></a>
	    A special case is the NULL envelope sender address
	    (i.e. <span class="command"><strong>MAIL FROM:</strong></span> &lt;&gt;) used in
	    <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s and other automatically generated
	    responses.  This address should always be accepted.
	  </p></div><div id="ftn.noretrysenders" class="footnote"><p><a href="#noretrysenders" class="para"><sup class="para">[9] </sup></a>
	  Although rare, some <span class="quote">&#8220;<span class="quote">legitimate</span>&#8221;</span> bulk mail
	  senders, such as <code class="option">groups.yahoo.com</code>, will not
	  retry temporarily failed deliveries.  Evan Harris has
	  compiled a list of such senders, suitable for whitelisting
	  purposes: 
	  <a class="ulink" href="http://cvs.puremagic.com/viewcvs/greylisting/schema/whitelist_ip.txt?view=markup" target="_top">http://cvs.puremagic.com/viewcvs/greylisting/schema/whitelist_ip.txt?view=markup</a>.
	</p></div><div id="ftn.idm914" class="footnote"><p><a href="#idm914" class="para"><sup class="para">[10] </sup></a>
	    Large sites often use multiple servers to handle outgoing
	    mail.  For instance, one server or pool of servers may be
	    used for immediate delivery.  If the first delivery
	    attempt fails, the mail is handed off to a fallback server
	    which has been tuned for large queues.  Hence, from such
	    sites, the first two delivery attempts will fail. 
	  </p></div><div id="ftn.idm1045" class="footnote"><p><a href="#idm1045" class="para"><sup class="para">[11] </sup></a>
	      Some specialized MTAs, such as certain mailing list
	      servers, do not automatically generate a
	      <code class="option">Message-ID:</code> header for
	      <span class="quote">&#8220;<span class="quote">bounced</span>&#8221;</span> messages (<a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s).  These messages are identified by an
	      empty <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a>.
	    </p></div><div id="ftn.idm1096" class="footnote"><p><a href="#idm1096" class="para"><sup class="para">[12] </sup></a>
	    The IMAP protocol does not allow for NUL characters to be
	    transmitted to the mail user agent, so the Cyrus
	    developers decided that the easiest way to deal with mails
	    containing it was to reject them.
	  </p></div><div id="ftn.idm1165" class="footnote"><p><a href="#idm1165" class="para"><sup class="para">[13] </sup></a>Why on earth the authors
	of anti-virus software are stupid enough to trust the sender
	address in an e-mail containing a virus is perhaps a topic for
	a closer psychoanalytic study.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="considerations"></a>Chapter 3. Considerations</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#multimx">1. Multiple Incoming Mail Exchangers</a></span></dt><dt><span class="section"><a href="#otherservers">2. Blocking Access to Other SMTP Servers</a></span></dt><dt><span class="section"><a href="#forwardedmail">3. Forwarded Mail</a></span></dt><dt><span class="section"><a href="#usersettings">4. User Settings and Data</a></span></dt></dl></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      Some specific considerations come into play as a result of
      system-wide SMTP time filtering.  Here we cover some of those.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="multimx"></a>1. Multiple Incoming Mail Exchangers</h2></div></div></div><p>
      Most domains list more than one incoming <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a>s
      (a.k.a. <span class="quote">&#8220;<span class="quote">MX hosts</span>&#8221;</span>).  If you do so, then bear in
      mind that in order to have any effect, any SMTP time filtering
      you incorporate on the primary MX has to be incorporated on all
      the others as well.  Otherwise, the sending host would simply
      sidestep filtering by retrying the mail delivery through your
      backup server(s).
    </p><p>
      If the backup server(s) are not under your control, ask
      yourself whether you need multiple MXs in the first place.  In
      this situation, chances are that they serve only as
      <span class="emphasis"><em>redundant</em></span> mail servers, and that they in
      turn forward the mail to your primary MX.  If so, you probably
      don't need them.  If your host happens to be down for a little
      while, that's OK -- well-behaved sender hosts will retry
      deliveries for several days before giving up
      <a href="#ftn.noretrysenders" class="footnoteref"><sup class="footnoteref">[9]</sup></a>.
    </p><p>
      A situation where you <span class="emphasis"><em>may</em></span> need multiple
      MXs is to perform load balancing between several servers -
      i.e. if you receive so much mail that one machine alone could
      not handle it.  In this case, see if you could offload some
      tasks (such as <a class="link" href="#virusscanners" title="6.6. Virus Scanners">virus</a> and
      <a class="link" href="#spamscanners" title="6.7. Spam Scanners">spam</a> scanners) to other
      machines, in order to reduce or eliminate this need.
    </p><p>
      Again, if you do decide to keep using several MXs, your backup
      servers need to be (at least) as restrictive as the primary
      server, lest filtering in the primary MX is useless.
    </p><p>
      See also the section on <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a> for
      additional concerns related to multiple MX hosts.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="otherservers"></a>2. Blocking Access to Other SMTP Servers</h2></div></div></div><p>
      Any SMTP server that is not listed as a public <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a> in the DNS zone of your domain(s) should not
      accept incoming connections from the internet.  All incoming
      mail traffic should go through your incoming mail exchanger(s).
    </p><p>
      This consideration is not unique to SMTP servers.  If you have
      machines that only serve an internal purpose within your site,
      use a firewall to restrict access to these.
    </p><p>
      This is a rule, so therefore there must be exceptions.  However,
      if you don't know what they are, then the above applies to you.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="forwardedmail"></a>3. Forwarded Mail</h2></div></div></div><p>
      You should take care not to reject mail as a result of spam
      filtering if it is forwarded from <span class="quote">&#8220;<span class="quote">friendly</span>&#8221;</span>
      sources, such as:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	  Your backup MX hosts, if any.  Supposedly, these have
	  already filtered out most of the junk (see <a class="xref" href="#multimx" title="1. Multiple Incoming Mail Exchangers">Multiple Incoming Mail Exchangers</a>).
	</p></li><li class="listitem"><p>
	  Mailing lists, to which you or your users subscribe. You may
	  still filter such mail (it may not be as criticial if it
	  ends up in a black hole). However, if you reject the mail,
	  you may end up causing the list server to automatically
	  unsubscribe the recipient.
	</p></li><li class="listitem"><p>
	  Other accounts belonging to the recipient.  Again,
	  rejections will generate collateral spam, and/or create
	  problems for the host that forwards the mail.
	</p></li></ul></div><p>
      You may see a logistical issue with the last two of these
      sources: They are specific to each recipient.  How to you allow
      each user to specify which hosts they want to whitelist, and
      then use such individual whitelists in a system-wide SMTP-time
      filtering setup?  If the message is forwarded to several
      recipients at your site (as may often be true in the case of
      a mailing list), how do you decide whose whitelist to use?
    </p><p>
      There is no magic bullet here.  This is one of those situations
      where we just have to do a bit of work.  You can decide to
      accept all mails, regardless of spam classification, so long as
      it is sent from a host in the whitelist of any one of the
      recipients.  For instance, in response to each <span class="command"><strong>RCPT
      TO:</strong></span> command, we can match the sending host against the
      corresponding user's whitelist.  If found, set a flag that will
      prevent a subsequent rejection.  Effectively, you are using an
      <span class="emphasis"><em>aggregate</em></span> of each recipient's whitelist.
    </p><p>
      The implementation appendices cover this in more detail.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="usersettings"></a>4. User Settings and Data</h2></div></div></div><p>
      There are other situations where you may want to support
      settings and data for each user at site.  For instance, if you
      scan incoming mail with SpamAssassin (see <a class="xref" href="#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a>), you may want to allow for individual
      spam thresholds, acceptable languages and character sets, and
      Bayesian training/data.
    </p><p>
      A sticking point is that SMTP-time filtering of incoming mail is
      done at the system level, before mail is being delivered to a
      particular user, and as such, does not lend itself too well to
      individual preferences.  A single message may have several
      recipients; and unlike the case with <a class="xref" href="#forwardedmail" title="3. Forwarded Mail">Forwarded Mail</a>, using an aggregate of each
      recipient's preferences is not a good option.  Consider a
      scenario where you have users from different linguistic
      backgrounds.
    </p><p>
      As it turns out, though, there is a modification to this truth.
      The trick is to limit the number of recipients in incoming
      messages to one, so that the message can be analyzed in
      accordance with the settings and data that belongs to the
      corresponding user.
    </p><p>
      To do this, you would accept the first <span class="command"><strong>RCPT
      TO:</strong></span>, then issue a SMTP <span class="command"><strong>451</strong></span> (defer)
      response to subsequent commands.  If the caller is a
      well-behaved MTA, it will know how to interpret this response,
      and try later.  (If it is confused, then, well, it is probably a
      sender from which you don't want to receive mail in the first
      place).
    </p><p>
      Obviously, this is a hack.  Every mail sent to several users at
      your site will be slowed down by 30 minutes or more per
      recipient.  Especially in corporate environments, where it is
      common to see e-mail discussions involving several people on the
      inside and several others on the outside, and where timelines of
      mail deliveries are essential, this is probably not a good
      solution at all.
    </p><p>
      Another issue that mainly pertains to corporate enterprises and
      other large sites is that incoming mail is often forwarded to
      internal machines for delivery, and that recipients don't
      normally have accounts on the mail exchanger.  It may still be
      possible to support user-specific settings and data in these
      situations (e.g. via database lookups or LDAP queries), but you
      may also want to consider whether it's worth the effort.
    </p><p>
      That said, if you are on a small site, and where you are not
      afraid of delayed deliveries, this may be an acceptable way
      to allow each user to fine tune their filtering criteria.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="qanda"></a>Chapter 4. Questions &amp; Answers</h1></div></div></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      In this section I try to anticipate some of the questions that
      may come up, and to answer them.  If you have questions that are
      not listed, and/or would like to provide extra input in this
      section, please provide <a class="link" href="#feedback" title="6. Feedback">feedback</a>.
    </p></div><div class="qandaset"><h2 class="title"><a name="idm1308"></a>When Spammers Adapt</h2><dl><dt>Q: <a href="#qanda-adapt">
	  What happens when spammers adapt and try to get around the
	  techniques described in this document?
	</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question"><td align="left" valign="top"><a name="qanda-adapt"></a><a name="idm1311"></a><p><b>Q:</b></p></td><td align="left" valign="top"><p>
	  What happens when spammers adapt and try to get around the
	  techniques described in this document?
	</p></td></tr><tr class="answer"><td align="left" valign="top"><p><b>A:</b></p></td><td align="left" valign="top"><p>
	  Well, that depends. :-)
	</p><p>
	  Some of the checks described (such as <a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a> and <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a>)
	  specifically target <span class="emphasis"><em>ratware</em></span> behavior.
	  It is certainly possible to imagine that this behavior will
	  change if enough sites incorporate these checks.  Hatmut
	  Danisch notes:
	  <span class="emphasis"><em>
	    Ratware contains buggy SMTP protocols because they didn't
	    need to do any better.  It worked this way, so why should
	    they have spent more time?  Meanwhile
	    <span class="quote">&#8220;<span class="quote">ratware</span>&#8221;</span> has a higher quality, and even the
	    quality of spam messages has significantly improved.  Once
	    enough people reject spam by detecting bad SMTP protocols,
	    spam software authors will simply improve their
	    software.
	  </em></span>
	</p><p>
	  That said, there are challenges remaining for such ratware:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      To get around <a class="xref" href="#smtpdelays" title="1. SMTP Transaction Delays">SMTP transaction delays</a>, they need to
	      wait for each response from the receiving SMTP server.
	      At that point, we have collectively accomplished a
	      significant reduction in the rate of mail that a given
	      spamming host is able to deliver per unit of time.
	      Since spammers are racing against time to deliver as
	      many mails as possible before DNS blocklists and
	      collaborative content filters catch up, we are improving
	      the effectiveness of these tools.
	    </p><p>
	      The effect is similar to the goal of <a class="xref" href="#micropay" title="Micropayment Schemes">Micropayment Schemes</a>, wherein the sender spends a few
	      seconds working on a computational challenge for each
	      recipient of the mail, and adds a resulting signature to
	      the e-mail header for the recipient to validate.  The
	      main difference, aside from the complexity of these
	      schemes, is that they require the participation of
	      virtually everyone in the world before they can
	      effectively be used to weed out spam, whereas SMTP
	      transaction delays start being effective with the first
	      recipient machine that implements it.
	    </p></li><li class="listitem"><p>
	      To get around a <a class="xref" href="#helocheck" title="3.1. Hello (HELO/EHLO) checks">HELO/EHLO check</a>, they need
	      to provide a proper greeting, i.e. identify themselves
	      with a valid <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>.  This provides for
	      increased traceability, especially with receiving <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>s that do not automatically insert the
	      results of a rDNS lookup into the Received: header of
	      the message.
	    </p></li><li class="listitem"><p>
	      To get all of the <a class="xref" href="#senderchecks" title="3.2. Sender Address Checks">Sender Address Checks</a>, they
	      need to provide their own valid sender address (or, at
	      least, <span class="emphasis"><em>a</em></span> valid sender address
	      within their own domain).  Nuff said.
	    </p></li><li class="listitem"><p>
	      To get around <a class="xref" href="#greylisting" title="4. Greylisting">Greylisting</a>, they need
	      to retry deliveries to temporarily failed recipients
	      addresses after one hour (but before four hours).  (As
	      far as implementation goes, in order to minimize machine
	      resources, rather than keeping a copy of each
	      temporarily failed mail, ratware may keep only a list of
	      temporarily failed recipients, and perform a second
	      sweep through those addresses after an hour or two).
	    </p><p>
	      Even so, <span class="emphasis"><em>greylisting</em></span> will remain
	      fairly effective in conjunction with <a class="xref" href="#dnsbl" title="2.1. DNS Blacklists">DNS Blacklists</a> that are fed from <a class="xref" href="#spamtrap" title="Spam Trap">Spam Trap</a>s.  That is because the mandatory
	      one-hour retry delay will give these lists a chance to
	      list the sending host.
	    </p></li></ul></div><p>
	  Software tools, such as <a class="xref" href="#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a> and
	  <a class="xref" href="#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>, are in constant evolution.
	  As spammers evolve, so do these (and vice versa).  As long
	  as you use recent versions of these tools, they will remain
	  quite effective.
	</p><p>
	  Finally, this document is itself subject to change.  As the
	  nature of junk mail changes, people will come up with new,
	  creative ways to block it.
	</p></td></tr></tbody></table></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="exim"></a>Appendix A. Exim Implementation</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="#exim-prereq">1. Prerequisites</a></span></dt><dt><span class="section"><a href="#exim-configfile">2. The Exim Configuration File</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-acl">2.1. Access Control Lists</a></span></dt><dt><span class="section"><a href="#exim-expansions">2.2. Expansions</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-options">3. Options and Settings</a></span></dt><dt><span class="section"><a href="#exim-firstpass">4. Building the ACLs - First Pass</a></span></dt><dd><dl><dt><span class="section"><a href="#acl_connect_1">4.1. acl_connect</a></span></dt><dt><span class="section"><a href="#acl_helo_1">4.2. acl_helo</a></span></dt><dt><span class="section"><a href="#acl_mail_from_1">4.3. acl_mail_from</a></span></dt><dt><span class="section"><a href="#acl_rcpt_to_1">4.4. acl_rcpt_to</a></span></dt><dt><span class="section"><a href="#acl_data_1">4.5. acl_data</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-smtpdelays">5. Adding SMTP transaction delays</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-smtpdelays-simple">5.1. The simple way</a></span></dt><dt><span class="section"><a href="#exim-smtpdelays-selective">5.2. Selective Delays</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-greylisting">6. Adding Greylisting Support</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-greylistd">6.1. greylistd</a></span></dt><dt><span class="section"><a href="#exim-greylist-mysql">6.2. MySQL implementation</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-spf">7. Adding SPF Checks</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-spf-exiscan">7.1. SPF checks via Exiscan-ACL</a></span></dt><dt><span class="section"><a href="#exim-spf-query-perl">7.2. SPF checks via Mail::SPF::Query</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-mime">8. Adding MIME and Filetype Checks</a></span></dt><dt><span class="section"><a href="#exim-av">9. Adding Anti-Virus Software</a></span></dt><dt><span class="section"><a href="#exim-sa">10. Adding SpamAssassin</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-sa-exiscan">10.1. Invoke SpamAssassin via Exiscan</a></span></dt><dt><span class="section"><a href="#exim-sa-config">10.2. Configure SpamAssassin</a></span></dt><dt><span class="section"><a href="#exim-per-user">10.3. User Settings and Data</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-sign">11. Adding Envelope Sender Signatures</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-sign-transport">11.1. Create a Transport to Sign the Sender Address</a></span></dt><dt><span class="section"><a href="#exim-sign-router-remote">11.2. Create a New Router for Remote Deliveries</a></span></dt><dt><span class="section"><a href="#exim-sign-router-redirect">11.3. Create New Redirect Router for Local Deliveries</a></span></dt><dt><span class="section"><a href="#exim-sign-acl">11.4. ACL Signature Check</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-bounces">12. Accept Bounces Only for Real Users</a></span></dt><dd><dl><dt><span class="section"><a href="#exim-dsn-mailbox">12.1. Check for Recipient Mailbox</a></span></dt><dt><span class="section"><a href="#exim-dsn-noalias">12.2. Check for Empty Sender in Aliases Router</a></span></dt></dl></dd><dt><span class="section"><a href="#exim-forward">13. Exempting Forwarded Mail</a></span></dt><dt><span class="section"><a href="#exim-final">14. Final ACLs</a></span></dt><dd><dl><dt><span class="section"><a href="#acl_connect_final">14.1. acl_connect</a></span></dt><dt><span class="section"><a href="#acl_helo_final">14.2. acl_helo</a></span></dt><dt><span class="section"><a href="#acl_mail_from_final">14.3. acl_mail_from</a></span></dt><dt><span class="section"><a href="#acl_rcpt_to_final">14.4. acl_rcpt_to</a></span></dt><dt><span class="section"><a href="#acl_data_final">14.5. acl_data</a></span></dt></dl></dd></dl></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      Here we cover the integration of techniques and tools described
      in this document into the Exim <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-prereq"></a>1. Prerequisites</h2></div></div></div><p>
      For these examples, you need the <code class="option">Exim</code> <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>, preferrably with Tom Kistner's
      <code class="option">Exiscan-ACL</code> patch applied.  Prebuilt
      <code class="option">Exim+Exiscan-ACL</code> packages exist for the most
      popular Linux distributions as well as FreeBSD; see the <a class="ulink" href="http://duncanthrax.net/exiscan-acl/" target="_top">Exiscan-ACL</a>
      home page for details<a href="#ftn.idm1361" class="footnote" name="idm1361"><sup class="footnote">[14]</sup></a>.
    </p><p>
      The final implementation example at the end incorporates these
      additional tools:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <a class="ulink" href="http://www.spamassassin.org/" target="_top">SpamAssassin</a>
          - a popular spam filtering tool that analyzes mail content
          against a large and highly sophisticated set of
          heuristics.
        </p></li><li class="listitem"><p>
          <a class="ulink" href="http://packages.debian.org/unstable/mail/greylistd" target="_top">greylistd</a>
          - a simple greylisting solution written by yours truly,
          specifically with Exim in mind.
        </p></li></ul></div><p>
      Other optional software is used in examples throughout.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-configfile"></a>2. The Exim Configuration File</h2></div></div></div><p>
      The Exim configuration file contains global definitions at the
      top (we will call this the <span class="emphasis"><em>main section</em></span>),
      followed by several other sections<a href="#ftn.idm1380" class="footnote" name="idm1380"><sup class="footnote">[15]</sup></a>. Each of these other sections starts with:

      </p><pre class="screen">begin <em class="parameter"><code>section</code></em></pre><p>
    </p><p>
      We will spend most of our time in the <code class="option">acl</code>
      section (i.e. after <code class="option">begin acl</code>); but we will
      also add and/or modify a few items in the
      <code class="option">transports</code> and <code class="option">routers</code>
      sections, as well as in the main section at the top of the file.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-acl"></a>2.1. Access Control Lists</h3></div></div></div><p>
        As of version 4.xx, Exim incorporates perhaps the most
        sophisticated and flexible mechanism for SMTP-time filtering
        available anywhere, by way of so-called <span class="emphasis"><em>Access
        Control Lists</em></span> (ACLs).
      </p><p>
        An ACL can be used to evaluate whether to accept or reject an
        aspect of an incoming message transaction, such as the initial
        connection from a remote host, or the
        <span class="command"><strong>HELO/EHLO</strong></span>, <span class="command"><strong>MAIL FROM:</strong></span>,
        or <span class="command"><strong>RCPT TO:</strong></span> SMTP commands.  So, for
        instance, you may have an ACL named
        <code class="option">acl_rcpt_to</code> to validate each <span class="command"><strong>RCPT
        TO:</strong></span> command received from the peer.
      </p><p>
        An ACL consists of a series of <span class="emphasis"><em>statements</em></span>
        (or <span class="emphasis"><em>rules</em></span>).  Each statement starts with
        an action verb, such as <code class="option">accept</code>,
        <code class="option">warn</code>, <code class="option">require</code>,
        <code class="option">defer</code>, or <code class="option">deny</code>, followed by
        a list of conditions, options, and other settings pertaining
        to that statement.  Every <span class="emphasis"><em>statement</em></span> is
        evaluated in order, until a definitive action (besides
        <code class="option">warn</code>) is taken.  There is an implicit
        <code class="option">deny</code> at the end of the ACL.
      </p><p>
        A sample statement in the <code class="option">acl_rcpt_to</code> ACL
        above may look like this:
</p><pre class="screen">
  deny
    message  = relay not permitted
    !hosts   = +relay_from_hosts
    !domains = +local_domains : +relay_to_domains
    delay    = 1m
</pre><p>
      </p><p>
        This statement will reject the <span class="command"><strong>RCPT TO:</strong></span>
        command if it was not delivered by a host in the
        <span class="quote">&#8220;<span class="quote">+relay_from_hosts</span>&#8221;</span> host list, and the recipient
        domain is not in the <span class="quote">&#8220;<span class="quote">+local_domains</span>&#8221;</span> or
        <span class="quote">&#8220;<span class="quote">+relay_to_domains</span>&#8221;</span> domain lists.  However, before
        issuing the <span class="quote">&#8220;<span class="quote">550</span>&#8221;</span> SMTP response to this command,
        the server will wait for one minute.
      </p><p>
        To evaluate a particular ACL at a given stage of the message
        transaction, you need to point one of Exim's <span class="emphasis"><em>policy
        controls</em></span> to that ACL.  For instance, to use the
        <code class="option">acl_rcpt_to</code> ACL mentioned above to evaluate the
        <span class="command"><strong>RCPT TO:</strong></span>, the main section of your Exim
        configuration file (before any <code class="option">begin</code> keywords)
        should include:

        </p><pre class="screen">acl_smtp_rcpt = acl_rcpt_to</pre><p>
      </p><p>
        For a full list of such <span class="emphasis"><em>policy controls</em></span>,
        refer to section 14.11 in the Exim specifications.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-expansions"></a>2.2. Expansions</h3></div></div></div><p>
        A large number of <span class="emphasis"><em>expansion items</em></span> are
        available, including run-time variables, lookup functions,
        string/regex manipulations, host/domain lists, etc. etc.  An
        exhaustive reference for the last x.x0 release (i.e. 4.20,
        4.30..) can be found in the file <span class="quote">&#8220;<span class="quote">spec.txt</span>&#8221;</span>; ACLs
        are described in section 38.
      </p><p>
        In particular, Exim provides twenty general purpose expansion
        variables to which we can assign values in an ACL statement:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            <code class="varname">$acl_c0</code> - <code class="varname">$acl_c9</code> can
            hold values that will persist through the lifetime of an
            SMTP connection.
          </p></li><li class="listitem"><p>
            <code class="varname">$acl_m0</code> - <code class="varname">$acl_m9</code> can
            hold values while a message is being received, but are
            then reset.  They are also reset by the
            <span class="command"><strong>HELO</strong></span>, <span class="command"><strong>EHLO</strong></span>,
            <span class="command"><strong>MAIL</strong></span>, and <span class="command"><strong>RSET</strong></span>
            commands.
          </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-options"></a>3. Options and Settings</h2></div></div></div><p>
      The main section of the Exim configuration file (before the
      first <code class="option">begin</code> keyword) contains various macros,
      policy controls, and other general settings.  Let us start by
      defining a couple of macros we will use later:

</p><pre class="screen">
# Define the message size limit; we will use this in the DATA ACL.
MESSAGE_SIZE_LIMIT = 10M

# Maximum message size for which we will run Spam or Virus scanning.
# This is to reduce the load imposed on the server by very large messages.
MESSAGE_SIZE_SPAM_MAX = 1M

# Macro defining a secret that we will use to generate various hashes.
# PLEASE CHANGE THIS!.
SECRET = <em class="parameter"><code>some-secret</code></em>
</pre><p>
    </p><p>
      Let us tweak some general Exim settings:

</p><pre class="screen">
# Treat DNS failures (SERVFAIL) as lookup failures.
# This is so that we can later reject sender addresses 
# within non-existing domains, or domains for which no
# nameserver exists.
dns_again_means_nonexist = !+local_domains : !+relay_to_domains

# Enable HELO verification in ACLs for all hosts
helo_try_verify_hosts = *

# Remove any limitation on the maximum number of incoming
# connections we can serve at one time.  This is so that while
# we later impose SMTP transaction delays for spammers, we
# will not refuse to serve new connections.
smtp_accept_max = 0

# ..unless the system load is above 10
smtp_load_reserve = 10

# Do not advertise ESMTP "PIPELINING" to any hosts.
# This is to trip up ratware, which often tries to pipeline
# commands anyway.
pipelining_advertise_hosts = :
</pre><p>
    </p><p>
      Finally, we will point some Exim policy controls to five ACLs
      that we will create to evaluate the various stages of an
      incoming SMTP transaction:

</p><pre class="screen">
acl_smtp_connect = acl_connect
acl_smtp_helo    = acl_helo
acl_smtp_mail    = acl_mail_from
acl_smtp_rcpt    = acl_rcpt_to
acl_smtp_data    = acl_data
</pre><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-firstpass"></a>4. Building the ACLs - First Pass</h2></div></div></div><p>
      In the acl section (following <code class="option">begin acl</code>), we
      need to define these ACLs.  In doing so, we will incorporate
      some of the basic
      <span class="emphasis"><em><a class="xref" href="#techniques" title="Chapter 2. Techniques">Techniques</a></em></span>
      described earlier in this document, namely
      <span class="emphasis"><em><a class="xref" href="#dnschecks" title="2. DNS Checks">DNS checks</a></em></span> and
      <span class="emphasis"><em><a class="xref" href="#smtpchecks" title="3. SMTP checks">SMTP checks</a></em></span>. 
    </p><p>
      In this pass, we will do most of the checks in <a class="xref" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">acl_rcpt_to</a>, and leave the other ACLs largely
      empty.  That is because most of the commonly used ratware does
      not understand rejections early in the SMTP transaction - it
      keeps trying.  On the other hand, most ratware clients give up
      if the <span class="command"><strong>RCPT TO:</strong></span> fails.
    </p><p>
      We create all these ACLs, however, because we will use them
      later.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_connect_1"></a>4.1. acl_connect</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used at the start of an incoming
# connection.  The tests are run in order until the connection 
# is either accepted or denied.

acl_connect:

  # In this pass, we do not perform any checks here.
  accept
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_helo_1"></a>4.2. acl_helo</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for the HELO or EHLO command in
# an incoming SMTP transaction.  The tests are run in order until the
# greeting is either accepted or denied.

acl_helo:

  # In this pass, we do not perform any checks here.
  accept
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_mail_from_1"></a>4.3. acl_mail_from</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for the MAIL FROM: command in an
# incoming SMTP transaction.  The tests are run in order until the
# sender address is either accepted or denied.
#

acl_mail_from:

  # Accept the command.
  accept
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_rcpt_to_1"></a>4.4. acl_rcpt_to</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for every RCPT command in an
# incoming SMTP message.  The tests are run in order until the 
# recipient address is either accepted or denied.

acl_rcpt_to:

  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  # Recipient verification is omitted here, because in many
  # cases the clients are dumb MUAs that don't cope well with 
  # SMTP error responses.
  #
  accept
    hosts       = : +relay_from_hosts


  # Accept if the message arrived over an authenticated connection,
  # from any host. Again, these messages are usually from MUAs, so
  # recipient verification is omitted.
  #
  accept
    authenticated = *


  ######################################################################
  # DNS checks
  ######################################################################
  #
  # The results of these checks are cached, so multiple recipients
  # does not translate into multiple DNS lookups.
  #

  # If the connecting host is in one of a select few DNSbls, then
  # reject the message.  Be careful when selecting these lists; many
  # would cause a large number of false postives, and/or have no
  # clear removal policy.
  #
  deny
    dnslists    = dnsbl.sorbs.net : \
                  dnsbl.njabl.org : \
                  cbl.abuseat.org : \
                  bl.spamcop.net
    message     = $sender_host_address is listed in $dnslist_domain\
                  ${if def:dnslist_text { ($dnslist_text)}}


  # If reverse DNS lookup of the sender's host fails (i.e. there is
  # no rDNS entry, or a forward lookup of the resulting name does not
  # match the original IP address), then reject the message.
  #
  deny
    message     = Reverse DNS lookup failed for host $sender_host_address.
    !verify     = reverse_host_lookup


  
  ######################################################################
  # Hello checks
  ######################################################################

  # If the remote host greets with an IP address, then reject the mail.
  # 
  deny
    message     = Message was delivered by ratware
    log_message = remote host used IP address in HELO/EHLO greeting
    condition   = ${if isip {$sender_helo_name}{true}{false}}


  # Likewise if the peer greets with one of our own names
  # 
  deny
    message     = Message was delivered by ratware
    log_message = remote host used our name in HELO/EHLO greeting.
    condition   = ${if match_domain{$sender_helo_name}\
                       {$primary_hostname:+local_domains:+relay_to_domains}\
                       {true}{false}}


  deny
    message     = Message was delivered by ratware
    log_message = remote host did not present HELO/EHLO greeting.
    condition   = ${if def:sender_helo_name {false}{true}}


  # If HELO verification fails, we add a X-HELO-Warning: header in
  # the message.
  #
  warn
    message     = X-HELO-Warning: Remote host $sender_host_address \
                  ${if def:sender_host_name {($sender_host_name) }}\
                  incorrectly presented itself as $sender_helo_name
    log_message = remote host presented unverifiable HELO/EHLO greeting.
    !verify     = helo

  

  ######################################################################
  # Sender Address Checks
  ######################################################################

  # If we cannot verify the sender address, deny the message.
  #
  # You may choose to remove the "callout" option.  In particular, 
  # if you are sending outgoing mail through a smarthost, it will not
  # give any useful information.
  #
  # Details regarding the failed callout verification attempt are
  # included in the 550 response; to omit these, change
  # "sender/callout" to "sender/callout,no_details".
  #
  deny
    message     = &lt;$sender_address&gt; does not appear to be a \
                  valid sender address. 
    !verify     = sender/callout



  ######################################################################
  # Recipent Address Checks
  ######################################################################

  # Deny if the local part contains @ or % or / or | or !. These are
  # rarely found in genuine local parts, but are often tried by people
  # looking to circumvent relaying restrictions.
  #
  # Also deny if the local part starts with a dot. Empty components
  # aren't strictly legal in RFC 2822, but Exim allows them because
  # this is common.  However, actually starting with a dot may cause
  # trouble if the local part is used as a file name (e.g. for a
  # mailing list).
  #
  deny
    local_parts = ^.*[@%!/|] : ^\\.


  # Drop the connection if the envelope sender is empty, but there is
  # more than one recipient address.  Legitimate DSNs are never sent
  # to more than one address.
  #
  drop
    message      = Legitimate bounces are never sent to more than one \
                   recipient.
    senders      = : postmaster@*
    condition    = $recipients_count


  # Reject the recipient address if it is not in a domain for
  # which we are handling mail.
  #
  deny
    message     = relay not permitted
    !domains    = +local_domains : +relay_to_domains


  # Reject the recipient if it is not a valid mailbox.
  # If the mailbox is not on our system (e.g. if we are a
  # backup MX for the recipient domain), then perform a
  # callout verification; but if the destination server is
  # not responding, accept the recipient anyway.
  #
  deny
    message     = unknown user
    !verify     = recipient/callout=20s,defer_ok


  # Otherwise, the recipient address is OK.
  #
  accept

</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_data_1"></a>4.5. acl_data</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for message data received via 
# SMTP.  The tests are run in order until the recipient address 
# is either accepted or denied.

acl_data:

  # Add Message-ID if missing in messages received from our own hosts.
  warn
    condition   = ${if !def:h_Message-ID: {1}}
    hosts       = : +relay_from_hosts
    message     = Message-ID: &lt;E$message_id@$primary_hostname&gt;


  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  accept
    hosts       = : +relay_from_hosts

  # Accept if the message arrived over an authenticated connection, from
  # any host.
  #
  accept
    authenticated = *


  # Enforce a message-size limit
  #
  deny
    message     = Message size $message_size is larger than limit of \
                  MESSAGE_SIZE_LIMIT
    condition   = ${if &gt;{$message_size}{MESSAGE_SIZE_LIMIT}{true}{false}}


  # Deny unless the address list header is syntactically correct.
  #
  deny
    message     = Your message does not conform to RFC2822 standard
    log_message = message header fail syntax check
    !verify     = header_syntax


  # Deny non-local messages with no Message-ID, or no Date
  #
  # Note that some specialized MTAs, such as certain mailing list
  # servers, do not automatically generate a Message-ID for bounces.
  # Thus, we add the check for a non-empty sender.
  #
  deny
    message     = Your message does not conform to RFC2822 standard
    log_message = missing header lines
    !hosts      = +relay_from_hosts
    !senders    = : postmaster@*
    condition   = ${if or {{!def:h_Message-ID:}\
                           {!def:h_Date:}\
                           {!def:h_Subject:}} {true}{false}}
 

  # Warn unless there is a verifiable sender address in at least
  # one of the "Sender:", "Reply-To:", or "From:" header lines.
  #
  warn
    message     = X-Sender-Verify-Failed: No valid sender in message header
    log_message = No valid sender in message header
    !verify     = header_sender


  # Accept the message. 
  #
  accept
</pre><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-smtpdelays"></a>5. Adding SMTP transaction delays</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-smtpdelays-simple"></a>5.1. The simple way</h3></div></div></div><p>
        The simplest way to add SMTP transaction delays is to append a
        <code class="option">delay</code> control to the final
        <code class="option">accept</code> statement in each of the ACLs we have
        declared, as follows:

</p><pre class="screen">
  accept
    delay = 20s
</pre><p>
      </p><p>
        In addition, you may want to add progressive delays in the
        <code class="option">deny</code> statement pertaining to invalid
        recipients (<span class="quote">&#8220;<span class="quote">unknown user</span>&#8221;</span>) within <a class="xref" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">acl_rcpt_to</a>.  This is to slow down dictionary
        attacks.  For instance:

</p><pre class="screen">
  deny
    message     = unknown user
    !verify     = recipient/callout=20s,defer_ok,use_sender
    delay       = ${eval:$rcpt_fail_count*10 + 20}s
</pre><p>
      </p><p>
        It should be noted that there is no point in imposing a delay
        in <a class="xref" href="#acl_data_1" title="4.5. acl_data">acl_data</a>, after the message data has
        been received.  Ratware commonly disconnect at this point,
        before even receiving a response from your server.  In any
        case, whether or not the client disconnects at this point has
        no bearing on whether Exim will proceed with the delivery of
        the message.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-smtpdelays-selective"></a>5.2. Selective Delays</h3></div></div></div><p>
        If you are like me, you want to be a little bit more selective
        about which hosts you subject to SMTP transaction delays.  For
        instance, as described earlier in this document, you may
        decide that a match from a DNS blacklist or a non-verifiable
        EHLO/HELO greeting are not conditions that by themselves
        warrant a rejection - but they may well be sufficient triggers
        for transaction delays.
      </p><p>
        In order perform selective delays, we want move some of the
        checks that we previously did in <a class="xref" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">acl_rcpt_to</a> to earlier points in the SMTP
        transaction.  This is so that we can start imposing the delays
        as soon as we see any sign of trouble, and thereby increase
        the chance of causing synchronization errors and other trouble
        for ratware.
      </p><p>
        Specifically, we want to:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            Move the DNS checks to
            <a class="xref" href="#acl_connect_final" title="14.1. acl_connect">acl_connect</a>.
          </p></li><li class="listitem"><p>
            Move the Hello checks to <a class="xref" href="#acl_helo_final" title="14.2. acl_helo">acl_helo</a>.
            One exception: We cannot yet check for a missing Hello
            greeting at this point, because this ACL is processed
            <span class="emphasis"><em>in response</em></span> to an EHLO or HELO
            command.  We will do this check in the <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a> ACL.
          </p></li><li class="listitem"><p>
            Move the Sender Address Checks checks to <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a>.
          </p></li></ul></div><p>
        However, for reasons described above, we do not want to
        actually reject the mail until after the <span class="command"><strong>RCPT
        TO:</strong></span> command.  Instead, in the earlier ACLs, we
        will convert the various <code class="option">deny</code> statements
        into <code class="option">warn</code> statements, and use Exim's
        general purpose ACL variables to store any error messages or
        warnings until after the <span class="command"><strong>RCPT TO:</strong></span>
        command.  We do that as follows:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            If we decide to reject the delivery, we store an error
            message to be used in the forthcoming
            <span class="command"><strong>550</strong></span> response in
            <code class="varname">$acl_c0</code> or <code class="varname">$acl_m0</code>:
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                If we identify the condition before a mail delivery
                has started (i.e. in
                <a class="xref" href="#acl_connect_final" title="14.1. acl_connect">acl_connect</a> or
                <a class="xref" href="#acl_helo_final" title="14.2. acl_helo">acl_helo</a>), we use the
                connection-persistent variable
                <code class="varname">$acl_c0</code>
              </p></li><li class="listitem"><p>
                Once a mail transaction has started (i.e. after the
                <span class="command"><strong>MAIL FROM:</strong></span> command), we copy any
                contents from <code class="varname">$acl_c0</code> into the
                message-specific variable <code class="varname">$acl_m0</code>,
                and use the latter from this point forward.  This
                way, any conditions identified in this particular
                message will not affect any subsequent messages
                received in the same connection.
              </p></li></ul></div><p>
            Also, we store a corresponding <span class="emphasis"><em>log
            message</em></span> in <code class="varname">$acl_c1</code> or
            <code class="varname">$acl_m1</code>, in a similar manner.
          </p></li><li class="listitem"><p>
            If we come across a condition that does not warrant an
            outright rejection, we only store a warning message in
            <code class="varname">$acl_c1</code> or <code class="varname">$acl_m1</code>.
            Once a mail transaction has started (i.e. in <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a>), we add any content in
            this variable to the message header as well.
          </p></li><li class="listitem"><p>
            If we decide to <span class="emphasis"><em>accept</em></span> a message
            without regard to the results of any subsequent checks
            (such as a SpamAssassin scan), we set a flag in
            <code class="varname">$acl_c0</code> or <code class="varname">$acl_m0</code>, but
            <code class="varname">$acl_c1</code> and <code class="varname">$acl_m1</code>
            empty.
          </p></li><li class="listitem"><p>
            At the beginning of every ACL to and including <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a>, we record the current
            timestamp in <code class="varname">$acl_m2</code>.  At the end of the
            ACL, we use the presence of <code class="varname">$acl_c1</code> or
            <code class="varname">$acl_m1</code> to trigger a SMTP transaction
            delay until a total of 20 seconds has elapsed.
          </p></li></ul></div><p>
        The following table summarizes our use of these variables:
      </p><div class="table"><a name="aclvarusage"></a><p class="title"><b>Table A.1. Use of ACL connection/message variables</b></p><div class="table-contents"><table class="table" summary="Use of ACL connection/message variables" border="1"><colgroup><col><col><col></colgroup><thead><tr><th align="left">Variables:</th><th align="left">$acl_[cm]0 unset</th><th align="left">$acl_[cm]0 set</th></tr></thead><tbody><tr><td align="left">$acl_[cm]1 unset</td><td align="left">(No decision yet)</td><td align="left">Accept the mail</td></tr><tr><td align="left">$acl_[cm]1 set</td><td align="left">Add warning in header</td><td align="left">Reject the mail</td></tr></tbody></table></div></div><br class="table-break"><p>
        As an example of this approach, let us consider two checks
        that we do in response to the Hello greeting; one that will
        reject mails if the peer greets with an IP address, and one
        that will warn about an unverifiable name in the greeting.
        Previously, we did both of these checks in <a class="xref" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">acl_rcpt_to</a> - now we move them to the <a class="xref" href="#acl_helo_final" title="14.2. acl_helo">acl_helo</a> ACL.

</p><pre class="screen">
acl_helo:
  # Record the current timestamp, in order to calculate elapsed time
  # for subsequent delays
  warn
    set acl_m2  = $tod_epoch


  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  accept
    hosts       = : +relay_from_hosts


  # If the remote host greets with an IP address, then prepare a reject
  # message in $acl_c0, and a log message in $acl_c1.  We will later use
  # these in a "deny" statement.  In the mean time, their presence indicate
  # that we should keep stalling the sender.
  # 
  warn
    condition   = ${if isip {$sender_helo_name}{true}{false}}
    set acl_c0  = Message was delivered by ratware
    set acl_c1  = remote host used IP address in HELO/EHLO greeting


  # If HELO verification fails, we prepare a warning message in acl_c1.
  # We will later add this message to the mail header.  In the mean time,
  # its presence indicates that we should keep stalling the sender.
  # 
  warn
    condition   = ${if !def:acl_c1 {true}{false}}
    !verify     = helo
    set acl_c1  = X-HELO-Warning: Remote host $sender_host_address \
                  ${if def:sender_host_name {($sender_host_name) }}\
                  incorrectly presented itself as $sender_helo_name
    log_message = remote host presented unverifiable HELO/EHLO greeting.


  #
  # ... additional checks omitted for this example ...
  # 


  # Accept the connection, but if we previously generated a message in
  # $acl_c1, stall the sender until 20 seconds has elapsed.
  accept
    set acl_m2  = ${if def:acl_c1 {${eval:20 + $acl_m2 - $tod_epoch}}{0}}
    delay       = ${if &gt;{$acl_m2}{0}{$acl_m2}{0}}s

</pre><p>
      </p><p>
        Then, in <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a> we transfer the
        messages from <code class="option">$acl_c{0,1}</code> to
        <code class="option">$acl_m{0,1}</code>.  We also add the contents of
        <code class="varname">$acl_c1</code> to the message header.
</p><pre class="screen">
acl_mail_from:
  # Record the current timestamp, in order to calculate elapsed time
  # for subsequent delays
  warn
    set acl_m2  = $tod_epoch


  # Accept mail received over local SMTP (i.e. not over TCP/IP). 
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  accept
    hosts     = : +relay_from_hosts


  # If present, the ACL variables $acl_c0 and $acl_c1 contain rejection
  # and/or warning messages to be applied to every delivery attempt in
  # in this SMTP transaction.  Assign these to the corresponding 
  # $acl_m{0,1} message-specific variables, and add any warning message
  # from $acl_m1 to the message header.  (In the case of a rejection,
  # $acl_m1 actually contains a log message instead, but this does not
  # matter, as we will discard the header along with the message).
  #
  warn
    set acl_m0  = $acl_c0
    set acl_m1  = $acl_c1
    message     = $acl_c1


  #
  # ... additional checks omitted for this example ...
  #

  # Accept the sender, but if we previously generated a message in
  # $acl_c1, stall the sender until 20 seconds has elapsed.
  accept
    set acl_m2  = ${if def:acl_c1 {${eval:20 + $acl_m2 - $tod_epoch}}{0}}
    delay       = ${if &gt;{$acl_m2}{0}{$acl_m2}{0}}s

</pre><p>
      </p><p>
        All the pertinent changes are incorporated in the <a class="xref" href="#exim-final" title="14. Final ACLs">Final ACLs</a>, to follow.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-greylisting"></a>6. Adding Greylisting Support</h2></div></div></div><p>
      There are several alternate greylisting implementations
      available for Exim.  Here we will cover a couple of these.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-greylistd"></a>6.1. greylistd</h3></div></div></div><p>
        This is a Python implementation developed by <span class="emphasis"><em>yours
        truly</em></span>.  (So naturally, this is the implementation
        I will include in the <a class="xref" href="#exim-final" title="14. Final ACLs">Final ACLs</a> to
        follow).  It operates as a stand-alone daemon, and thus does
        not depend on any external database.  Greylist data is
        stored as simple 32-bit hashes for efficiency.
      </p><p>
        You can find it at <a class="ulink" href="http://packages.debian.org/unstable/mail/greylistd" target="_top">http://packages.debian.org/unstable/mail/greylistd</a>.
        Debian users can get it via APT:

        </p><pre class="screen"># apt-get install greylistd</pre><p>
      </p><p>
        To consult <code class="option">greylistd</code>, we insert two
        statements in <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a> ACL that we
        previously declared, right before the final
        <code class="option">accept</code> statement:
      </p><p>
</p><pre class="screen">
  # Consult "greylistd" to obtain greylisting status for this particular
  # peer/sender/recipient triplet.
  #
  # We do not greylist messages with a NULL sender, because sender 
  # callout verification would break (and we might not be able to
  # send mail to a host that performs callouts).
  #
  defer
    message     = $sender_host_address is not yet authorized to deliver mail \
                  from &lt;$sender_address&gt; to &lt;$local_part@$domain&gt;. \
                  Please try later.
    log_message = greylisted.
    domains     = +local_domains : +relay_to_domains
    !senders    = : postmaster@*
    set acl_m9  = $sender_host_address $sender_address $local_part@$domain
    set acl_m9  = ${readsocket{/var/run/greylistd/socket}{$acl_m9}{5s}{}{}}
    condition   = ${if eq {$acl_m9}{grey}{true}{false}} 
</pre><p>
      </p><p>
        Unless you incorporate <a class="link" href="#exim-sign" title="11. Adding Envelope Sender Signatures">envelope
        sender signatures</a> to block bogus <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s, you may want to add a similar statement in
        your <a class="xref" href="#acl_data_final" title="14.5. acl_data">acl_data</a> to also greylist messages
        with a NULL sender.
      </p><p>
        The data we use for greylisting purposes here will be a little
        different than above.  In addition to
        <code class="option">$sender_address</code> being emtpy, neither
        <code class="option">$local_part</code> nor <code class="option">$domain</code> is
        defined at this point.  Instead, the variable
        <code class="option">$recipients</code> contains a comma-separated list
        of all recipient addresses.  For a legitimate DSN, there
        should be only one address.

</p><pre class="screen">
  # Perform greylisting on messages with no envelope sender here.
  # We did not subject these to greylisting after RCPT TO: because
  # that would interfere with remote hosts doing sender callouts.
  #
  defer
    message     = $sender_host_address is not yet authorized to send \
                  delivery status reports to &lt;$recipients&gt;. \
                  Please try later.
    log_message = greylisted.
    senders     = : postmaster@*
    set acl_m9  = $sender_host_address $recipients
    set acl_m9  = ${readsocket{/var/run/greylistd/socket}{$acl_m9}{5s}{}{}}
    condition   = ${if eq {$acl_m9}{grey}{true}{false}}
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-greylist-mysql"></a>6.2. MySQL implementation</h3></div></div></div><p>
        The following inline implementation was contributed by
        Johannes Berg <code class="email">&lt;<a class="email" href="mailto:johannes%20(at)%20sipsolutions.net">johannes (at) sipsolutions.net</a>&gt;</code>,
        based in part on:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            work by Rick Stewart <code class="email">&lt;<a class="email" href="mailto:rick.stewart%20(at)%0A%20%20%20%20%20%20%20%20%20%20%20%20theinternetco.net">rick.stewart (at)
            theinternetco.net</a>&gt;</code>, published at <a class="ulink" href="http://theinternetco.net/projects/exim/greylist" target="_top">http://theinternetco.net/projects/exim/greylist</a>,
            in turn based on
          </p></li><li class="listitem"><p>
            a Postgres implementation created by Tollef Fog Heen
            <code class="email">&lt;<a class="email" href="mailto:tfheen%20(at)%20raw.no">tfheen (at) raw.no</a>&gt;</code>, available at
            <a class="ulink" href="http://raw.no/personal/blog/tech/Debian/2004-03-14-15-55_greylisting" target="_top">http://raw.no/personal/blog/tech/Debian/2004-03-14-15-55_greylisting</a>
          </p></li></ul></div><p>
        It requires no external programs - the entire implementation
        is based on these configuration snippets along with a MySQL
        database.
      </p><p>
        An archive containing up-to-date configuration snippets as
        well as a <code class="option">README</code> file is available at:
        <a class="ulink" href="http://johannes.sipsolutions.net/wiki/Projects/exim-greylist" target="_top">http://johannes.sipsolutions.net/wiki/Projects/exim-greylist</a>.
      </p><p>
        MySQL needs to be installed on your system.  At a MySQL
        prompt, create an <code class="option">exim4</code> database with two
        tables named <code class="option">exim_greylist</code> and
        <code class="option">exim_greylist_log</code>, as follows:
        
</p><pre class="screen">
CREATE DATABASE exim4;
use exim4;

CREATE TABLE exim_greylist (
   id bigint(20) NOT NULL auto_increment,
   relay_ip varchar(80) default NULL,
   sender varchar(255) default NULL,
   recipient varchar(255) default NULL,
   block_expires datetime NOT NULL default '0000-00-00 00:00:00',
   record_expires datetime NOT NULL default '9999-12-31 23:59:59',
   create_time datetime NOT NULL default '0000-00-00 00:00:00',
   type enum('AUTO','MANUAL') NOT NULL default 'MANUAL',
   passcount bigint(20) NOT NULL default '0',
   blockcount bigint(20) NOT NULL default '0',
   PRIMARY KEY  (id)
);

CREATE TABLE exim_greylist_log (
   id bigint(20) NOT NULL auto_increment,
   listid bigint(20) NOT NULL,
   timestamp datetime NOT NULL default '0000-00-00 00:00:00',
   kind enum('deferred', 'accepted') NOT NULL,
   PRIMARY KEY (id)
);
</pre><p>
      </p><p>
        In the <span class="emphasis"><em>main</em></span> section of your Exim
        configuration file, declare the following macros:

</p><pre class="screen">
# if you don't have another database defined, then define it here
hide mysql_servers = localhost/exim4/<em class="parameter"><code>user</code></em>/<em class="parameter"><code>password</code></em>

# options
# these need to be valid as xxx in mysql's DATE_ADD(..,INTERVAL xxx)
# not valid, for example, are plurals: "2 HOUR" instead of "2 HOURS"
GREYLIST_INITIAL_DELAY = 1 HOUR
GREYLIST_INITIAL_LIFETIME = 4 HOUR
GREYLIST_WHITE_LIFETIME = 36 DAY
GREYLIST_BOUNCE_LIFETIME = 0 HOUR

# you can change the table names
GREYLIST_TABLE=exim_greylist
GREYLIST_LOG_TABLE=exim_greylist_log

# comment out to the following line to disable greylisting (temporarily)
GREYLIST_ENABLED=

# uncomment the following to enable logging
#GREYLIST_LOG_ENABLED=

# below here, nothing should normally be edited

.ifdef GREYLIST_ENABLED
# database macros
GREYLIST_TEST = SELECT CASE \
   WHEN now() &gt; block_expires THEN "accepted" \
   ELSE "deferred" \
 END AS result, id \
 FROM GREYLIST_TABLE \
 WHERE (now() &lt; record_expires) \
   AND (sender      = '${quote_mysql:$sender_address}' \
        OR (type='MANUAL' \
            AND (    sender IS NULL \
                  OR sender = '${quote_mysql:@$sender_address_domain}' \
                ) \
           ) \
       ) \
   AND (recipient   = '${quote_mysql:$local_part@$domain}' \
        OR (type = 'MANUAL' \
            AND (    recipient IS NULL \
                  OR recipient = '${quote_mysql:$local_part@}' \
                  OR recipient = '${quote_mysql:@$domain}' \
                ) \
           ) \
       ) \
   AND (relay_ip    = '${quote_mysql:$sender_host_address}' \
        OR (type='MANUAL' \
            AND (    relay_ip IS NULL \
                  OR relay_ip = substring('${quote_mysql:$sender_host_address}',1,length(relay_ip)) \
                ) \
           ) \
       ) \
 ORDER BY result DESC LIMIT 1

GREYLIST_ADD = INSERT INTO GREYLIST_TABLE \
  (relay_ip, sender, recipient, block_expires, \
   record_expires, create_time, type) \
 VALUES ( '${quote_mysql:$sender_host_address}', \
  '${quote_mysql:$sender_address}', \
  '${quote_mysql:$local_part@$domain}', \
  DATE_ADD(now(), INTERVAL GREYLIST_INITIAL_DELAY), \
  DATE_ADD(now(), INTERVAL GREYLIST_INITIAL_LIFETIME), \
  now(), \
  'AUTO' \
) 

GREYLIST_DEFER_HIT = UPDATE GREYLIST_TABLE \
                     SET blockcount=blockcount+1 \
                     WHERE id = $acl_m9

GREYLIST_OK_COUNT = UPDATE GREYLIST_TABLE \
                    SET passcount=passcount+1 \
                    WHERE id = $acl_m9

GREYLIST_OK_NEWTIME = UPDATE GREYLIST_TABLE \
                      SET record_expires = DATE_ADD(now(), INTERVAL GREYLIST_WHITE_LIFETIME) \
                      WHERE id = $acl_m9 AND type='AUTO'

GREYLIST_OK_BOUNCE = UPDATE GREYLIST_TABLE \
                     SET record_expires = DATE_ADD(now(), INTERVAL GREYLIST_BOUNCE_LIFETIME) \
                     WHERE id = $acl_m9 AND type='AUTO'

GREYLIST_LOG = INSERT INTO GREYLIST_LOG_TABLE \
               (listid, timestamp, kind) \
               VALUES ($acl_m9, now(), '$acl_m8')
.endif
</pre><p>
      </p><p>
        Now, in the ACL section (after <code class="option">begin acl</code>),
        declare a new ACL named <span class="quote">&#8220;<span class="quote">greylist_acl</span>&#8221;</span>:

</p><pre class="screen">
.ifdef GREYLIST_ENABLED
# this acl returns either deny or accept
# since we use it inside a defer with acl = greylist_acl,
# accepting here makes the condition TRUE thus deferring,
# denying here makes the condition FALSE thus not deferring
greylist_acl:
  # For regular deliveries, check greylist.

  # check greylist tuple, returning "accepted", "deferred" or "unknown"
  # in acl_m8, and the record id in acl_m9

  warn set acl_m8 = ${lookup mysql{GREYLIST_TEST}{$value}{result=unknown}}
       # here acl_m8 = "result=x id=y"

       set acl_m9 = ${extract{id}{$acl_m8}{$value}{-1}}
       # now acl_m9 contains the record id (or -1)

       set acl_m8 = ${extract{result}{$acl_m8}{$value}{unknown}}
       # now acl_m8 contains unknown/deferred/accepted

  # check if we know a certain triple, add and defer message if not
  accept
       # if above check returned unknown (no record yet)
       condition = ${if eq{$acl_m8}{unknown}{1}}
       # then also add a record
       condition = ${lookup mysql{GREYLIST_ADD}{yes}{no}}

  # now log, no matter what the result was
  # if the triple was unknown, we don't need a log entry
  # (and don't get one) because that is implicit through
  # the creation time above.
  .ifdef GREYLIST_LOG_ENABLED
  warn condition = ${lookup mysql{GREYLIST_LOG}}
  .endif

  # check if the triple is still blocked
  accept 
       # if above check returned deferred then defer
       condition = ${if eq{$acl_m8}{deferred}{1}}
       # and note it down
       condition = ${lookup mysql{GREYLIST_DEFER_HIT}{yes}{yes}}

  # use a warn verb to count records that were hit
  warn condition = ${lookup mysql{GREYLIST_OK_COUNT}}

  # use a warn verb to set a new expire time on automatic records,
  # but only if the mail was not a bounce, otherwise set to now().
  warn !senders = : postmaster@*
       condition = ${lookup mysql{GREYLIST_OK_NEWTIME}}
  warn senders = : postmaster@*
       condition = ${lookup mysql{GREYLIST_OK_BOUNCE}}

  deny
.endif
</pre><p>
      </p><p>
        Incorporate this ACL into your <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>
        to greylist triplets where the sender address is non-empty.
        This is to allow for sender callout verifications:

</p><pre class="screen">
.ifdef GREYLIST_ENABLED
  defer !senders = : postmaster@*
        acl      = greylist_acl
        message  = greylisted - try again later
.endif
</pre><p>
      </p><p>
        Also incorporate it into your <a class="xref" href="#acl_data_1" title="4.5. acl_data">acl_data</a>
        block, but this time only if the sender address is empty.
        This is to prevent spammers from getting around greylisting by
        setting the sender address to NULL.

</p><pre class="screen">
.ifdef GREYLIST_ENABLED
  defer senders  = : postmaster@*
        acl      = greylist_acl
        message  = greylisted - try again later
.endif
</pre><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-spf"></a>7. Adding SPF Checks</h2></div></div></div><p>
      Here we cover two different ways to check <a class="xref" href="#spf" title="5.1. Sender Policy Framework (SPF)">Sender Policy Framework</a>
      records using Exim.  In addition to these explicit mechanisms,
      the SpamAssassin suite will in the near future (around version
      2.70) incorporate more sophisticated SPF checks, by assigning
      weighted scores to the various SPF results.
    </p><p>
      Although we <span class="emphasis"><em>could</em></span> perform this check as
      early as in the <a class="xref" href="#acl_mail_from_final" title="14.3. acl_mail_from">acl_mail_from</a> ACL, there
      is an issue that will affect this decision: SPF is incompatible
      with traditional e-mail forwarding.  Unless the forwarding host
      implements <a class="ulink" href="http://spf.pobox.com/srs.html" target="_top">SRS</a>, you may end up
      rejecting forwarded mail because you receive it from a host that
      is not authorized to do so per the SPF policy of the domain in
      the <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address.
    </p><p>
      To avoid doing this, we need to consult a user-specific list of
      hosts from which forwarded mails should be accepted (as
      described in <a class="xref" href="#exim-forward" title="13. Exempting Forwarded Mail">Exempting Forwarded Mail</a>, to follow).
      This is only possible after the <span class="command"><strong>RCPT TO:</strong></span>,
      when we know the username of the recipient.
    </p><p>
      As such, we will add this check prior to any greylisting
      checks and/or the final <code class="option">accept</code> statement in
      <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-spf-exiscan"></a>7.1. SPF checks via Exiscan-ACL</h3></div></div></div><p>
        Recent versions of Tom Kistner's <code class="option">Exiscan-ACL</code>
        patch (see <a class="xref" href="#exim-prereq" title="1. Prerequisites">Prerequisites</a>) have native support
	for SPF.
        <a href="#ftn.idm1692" class="footnote" name="idm1692"><sup class="footnote">[16]</sup></a>
        Usage is very simple.  An <code class="option">spf</code> ACL condition
        is added, and can be compared against any of the keywords
        <code class="option">pass</code>, <code class="option">fail</code>,
        <code class="option">softfail</code>, <code class="option">none</code>,
        <code class="option">neutral</code>, <code class="option">err_perm</code> or
        <code class="option">err_temp</code>.
      </p><p>
        Prior to any greylisting checks and/or the final
        <code class="option">accept</code> statement in <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>, insert the following snippet:

</p><pre class="screen">
  # Query the SPF information for the sender address domain, if any,
  # to see if the sending host is authorized to deliver its mail.
  # If not, reject the mail.
  #
  deny
    message     = [SPF] $sender_host_address is not allowed to send mail \
                  from $sender_address_domain
    log_message = SPF check failed.
    spf         = fail


  # Add a SPF-Received: header to the message
  warn
    message     = $spf_received
</pre><p>
      </p><p>
        This statement will reject the mail if the owner of the domain
        in the sender address has disallowed deliveries from the
        calling host.  Some people find that this gives the domain
        owner a little bit too much control, even to the point of
        shooting themselves in the foot.  A suggested alternative is
        to combine the SPF check with other checks, such as Sender
        Callout Verification (but note that as before, there is no
        point in doing this if you are sending your outgoing mail
        through a smarthost):

</p><pre class="screen">
  # Reject the mail if we cannot verify the sender address via callouts,
  # and if SPF information for the sending domain does not grant explicit
  # authority to the sending host.
  #
  deny
    message     = The sender address does not seem to be valid, and SPF \
                  information does not grant $sender_host_address explicit \
                  authority to send mail from $sender_address_domain
    log_message = SPF check failed.
    !verify     = sender/callout,random,postmaster
    !spf        = pass


  # Add a SPF-Received: header to the message
  warn
    message     = $spf_received
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-spf-query-perl"></a>7.2. SPF checks via Mail::SPF::Query</h3></div></div></div><p>
        <code class="option">Mail::SPF::Query</code> is a the official SPF test
        suite, available from <a class="ulink" href="http://spf.pobox.com/downloads.html" target="_top">http://spf.pobox.com/downloads.html</a>.  Debian users,
        install <code class="option">libmail-spf-query-perl</code>.
      </p><p>
        The <code class="option">Mail::SPF::Query</code> package comes with a
        daemon (<span class="command"><strong>spfd</strong></span>) that listens for requests on
        a UNIX domain socket.  Unfortunately, it does not come with an
        <span class="quote">&#8220;<span class="quote">init</span>&#8221;</span> script to start this daemon automatically.
        Therefore, in the following example, we will use the
        standalone <span class="command"><strong>spfquery</strong></span> utility to make our SPF
        requests.
      </p><p>
        As above, insert the following prior to any greylisting checks
        and/or the final <code class="option">accept</code> statement in <a class="xref" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">acl_rcpt_to</a>:

</p><pre class="screen">
  # Use "spfquery" to obtain SPF status for this particular sender/host.
  # If the return code of that command is 1, this is an unauthorized sender.
  #
  deny
    message     = [SPF] $sender_host_address is not allowed to send mail \
                  from $sender_address_domain.
    log_message = SPF check failed.
    set acl_m9  = -ipv4=$sender_host_address \
                  -sender=$sender_address \
                  -helo=$sender_helo_name
    set acl_m9  = ${run{/usr/bin/spfquery $acl_m9}}
    condition   = ${if eq {$runrc}{1}{true}{false}}
</pre><p>
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-mime"></a>8. Adding MIME and Filetype Checks</h2></div></div></div><p>
      These checks depend on features found in Tom Kistner's
      <code class="option">Exiscan-ACL</code> patch - see <a class="xref" href="#exim-prereq" title="1. Prerequisites">Prerequisites</a> for details.
    </p><p>
      Exiscan-ACL includes support for MIME decoding, and file name
      suffix checks (or to use a misnomer from the Windows world,
      <span class="quote">&#8220;<span class="quote">file extension</span>&#8221;</span> checks).  This check alone will
      block most Windows virii - but not those that are transmitted in
      <code class="option">.ZIP</code> archives or those that exploit
      Outlook/MSIE HTML rendering vulnerabilities - see the discussion
      on <a class="xref" href="#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>.
    </p><p>
      These checks should go into <a class="xref" href="#acl_data_1" title="4.5. acl_data">acl_data</a>,
      before the final <code class="option">accept</code> statement:
</p><pre class="screen">
  # Reject messages that have serious MIME errors.
  #
  deny
    message     = Serious MIME defect detected ($demime_reason)
    demime      = *
    condition   = ${if &gt;{$demime_errorlevel}{2}{1}{0}}


  # Unpack MIME containers and reject file extensions used by worms.
  # This calls the demime condition again, but it will return cached results.
  # Note that the extension list may be incomplete.
  #
  deny
    message     = We do not accept ".$found_extension" attachments here.
    demime      = bat:btm:cmd:com:cpl:dll:exe:lnk:msi:pif:prf:reg:scr:vbs:url
</pre><p>
    </p><p>
      You will note that the <code class="option">demime</code> condition is
      invoked twice in the example above.  However, the results are
      cached, so the message is not actually processed twice.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-av"></a>9. Adding Anti-Virus Software</h2></div></div></div><p>
      Exiscan-ACL plugs into a number of different virus scanners
      directly, or any other scanner that can be run from the
      command line via its <code class="option">cmdline</code> backend.
    </p><p>
      To use this feature, the <a class="link" href="#exim-options" title="3. Options and Settings">main
      section</a> of your Exim configuration file must specify
      which virus scanner to use, along with any options you wish to
      pass to that scanner.  The basic syntax is:

</p><pre class="screen">
av_scanner = <em class="parameter"><code>scanner-type</code></em>:<em class="parameter"><code>option1</code></em>:<em class="parameter"><code>option</code></em>:...
</pre><p>

</p><p>
   For instance:

</p><pre class="screen">
av_scanner = sophie:/var/run/sophie
av_scanner = kavdaemon:/opt/AVP/AvpCtl
av_scanner = clamd:127.0.0.1 1234
av_scanner = clamd:/opt/clamd/socket
av_scanner = cmdline:/path/to/sweep -all -rec -archive %s:found:'(.+)'
...

</pre><p>
    </p><p>
      In the DATA ACL, you then want to use the
      <code class="option">malware</code> condition to perform the actual
      scanning:

</p><pre class="screen">
  deny
    message  = This message contains a virus ($malware_name)
    demime   = *
    malware  = */defer_ok
</pre><p>
    </p><p>
      The included file <code class="option">exiscan-acl-spec.txt</code>
      contains full usage information.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-sa"></a>10. Adding SpamAssassin</h2></div></div></div><p>
      Invoking SpamAssassin at SMTP-time is commonly done in either
      of two ways in Exim:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Via the <code class="option">spam</code> condition offered by
          <code class="option">Exiscan-ACL</code>.  This is the mechanism we
          will cover here.
        </p></li><li class="listitem"><p>
          Via <code class="option">SA-Exim</code>, another utility written by
          Marc Merlins (<code class="email">&lt;<a class="email" href="mailto:marc%20(at)%20merlins.org">marc (at) merlins.org</a>&gt;</code>),
          specifically for running SpamAssassin at SMTP time in Exim.
          This program operates through Exim's
          <code class="option">local_scan()</code> interface, either patched
          directly into the Exim source code, or via Marc's own
          <code class="option">dlopen()</code> plugin (which, by the way, is
          included in Debian's <code class="option">exim4-daemon-light</code>
          and <code class="option">exim4-daemon-heavy</code> packages).
        </p><p>
          <code class="option">SA-Exim</code> offers some other features as
          well, namely <span class="emphasis"><em>greylisting</em></span> and
          <span class="emphasis"><em>teergrubing</em></span>.  However, because the
          scan happens after the message data has been received,
          neither of these two features may be as useful as they
          would be earlier in the SMTP transaction.
        </p><p>
          <code class="option">SA-Exim</code> can be found at:
          <a class="ulink" href="http://marc.merlins.org/linux/exim/sa.html" target="_top">http://marc.merlins.org/linux/exim/sa.html</a>.
        </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sa-exiscan"></a>10.1. Invoke SpamAssassin via Exiscan</h3></div></div></div><p>
        <code class="option">Exiscan-ACL</code>'s
        <span class="quote">&#8220;<span class="quote"><code class="option">spam</code></span>&#8221;</span> condition passes the
        message through either SpamAssassin or Brightmail, and
        triggers if these indicate that the message is junk.  By
        default, it connects to a SpamAssassin daemon
        (<code class="option">spamd</code>) running on
        <code class="option">localhost</code>.  The host address and port can be
        changed by adding a <code class="option">spamd_address</code> setting in
        the <span class="emphasis"><em>main</em></span> section of the Exim
        configuration file.  For more information, see the
        <code class="option">exiscan-acl-spect.txt</code> file included with the
        patch.
      </p><p>
        In our implementation, we are going to reject messages
        classified as spam.  However, we would like to keep a copy of
        such messages in a separate mail folder, at least for the time
        being.  This is so that the user can periodically scan for
        <a class="xref" href="#falsepos" title="False Positive">False Positive</a>s.
      </p><p>
        Exim offers <span class="emphasis"><em>controls</em></span> that can be applied
        to a message that is accepted, such as
        <code class="option">freeze</code>.  The Exiscan-ACL patch adds one more
        of these controls, namely <code class="option">fakereject</code>.
        This causes the following SMTP response:

</p><pre class="screen">
550-FAKEREJECT id=<em class="parameter"><code>message-id</code></em>
550-Your message has been rejected but is being kept for evaluation.
550 If it was a legit message, it may still be delivered to the target recipient(s).
</pre><p>
      </p><p>
        We can incorporate this feature into our implementation, by
        inserting the following snippet in <a class="xref" href="#acl_data_1" title="4.5. acl_data">acl_data</a>, prior to the final
        <code class="option">accept</code> statement:

</p><pre class="screen">
  # Invoke SpamAssassin to obtain $spam_score and $spam_report.
  # Depending on the classification, $acl_m9 is set to "ham" or "spam".
  #
  # If the message is classified as spam, pretend to reject it. 
  #
  warn
    set acl_m9  = ham
    spam        = mail
    set acl_m9  = spam
    control     = fakereject
    logwrite    = :reject: Rejected spam (score $spam_score): $spam_report

  # Add an appropriate X-Spam-Status: header to the message.
  #
  warn
    message     = X-Spam-Status: \
                  ${if eq {$acl_m9}{spam}{Yes}{No}} (score $spam_score)\
                  ${if def:spam_report {: $spam_report}}
    logwrite    = :main: Classified as $acl_m9 (score $spam_score)

</pre><p>
      </p><p>
        In this example, <code class="varname">$acl_m9</code> is initially set to
        <span class="quote">&#8220;<span class="quote">ham</span>&#8221;</span>.  Then SpamAssassin is invoked as the user
        <code class="option">mail</code>. If the message is classified as spam,
        then <code class="varname">$acl_m9</code> is set to <span class="quote">&#8220;<span class="quote">spam</span>&#8221;</span>,
        and the <code class="option">FAKEREJECT</code> response above is issued.
        Finally, an <code class="option">X-Spam-Status:</code> header is added to
        the message.  The idea is that the <a class="xref" href="#mda" title="Mail Delivery Agent">Mail Delivery Agent</a> or
        the recipient's <a class="xref" href="#mua" title="Mail User Agent">Mail User Agent</a> can use this header to
        filter junk mail into a separate folder.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sa-config"></a>10.2. Configure SpamAssassin</h3></div></div></div><p>
        By default, SpamAssassin presents its report in a verbose,
        table-like format, mainly suitable for inclusion in or
        attachment to the message body.  In our case, we want a terse
        report, suitable for the <code class="option">X-Spam-Status:</code>
        header in the example above.  To do this, we add the following
        snippet in its site specific configuration file
        (<code class="option">/etc/spamassassin/local.cf</code>,
        <code class="option">/etc/mail/spamassassin/local.cf</code>, or similar):

</p><pre class="screen">
### Report template
clear_report_template
report "_TESTSSCORES(, )_"
</pre><p>
      </p><p>
        Also, a <a class="link" href="#bayesian" title="Bayesian Filters">Bayesian</a> scoring
        feature is built in, and is turned on by default.  We normally
        want to turn this off, because it requires training that will
        be specific to each user, and thus is not suitable for
        system-wide SMTP time filtering:

</p><pre class="screen">
### Disable Bayesian scoring
use_bayes 0
</pre><p>
      </p><p>
        For these changes to take effect, you have to restart the
        SpamAssassin daemon (<span class="command"><strong>spamd</strong></span>).
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-per-user"></a>10.3. User Settings and Data</h3></div></div></div><p>
        Say you have a number of users that want to specify their
        individual SpamAssassin preferences, such as the spam
        threshold, acceptable languages and character sets,
        white/blacklisted senders, and so on.  Or perhaps they really
        want to be able to make use of SpamAssassin's native Bayesian
        scoring (though I don't see why<a href="#ftn.idm1828" class="footnote" name="idm1828"><sup class="footnote">[17]</sup></a>).
      </p><p>
        As discussed in the <a class="xref" href="#usersettings" title="4. User Settings and Data">User Settings and Data</a> section
        earlier in the document, there is a way for this to happen.
        We need to limit the number of recipients we accept per
        incoming mail delivery to one.  We accept the first
        <span class="command"><strong>RCPT TO:</strong></span> command issued by the caller, then
        defer subsequent ones using a <span class="command"><strong>451</strong></span> SMTP
        response.  As with <a class="link" href="#exim-greylisting" title="6. Adding Greylisting Support">greylisting</a>, if the caller
        is a well-behaved MTA it will know how to interpret this
        response, and retry later.
      </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="exim-limit-one-user"></a>10.3.1. Tell Exim to accept only one recipient per delivery</h4></div></div></div><p>
          In the <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>, we insert the
          following statement after validating the recipient address,
          but before any <code class="option">accept</code> statements pertaining
          to unauthenticated deliveries from remote hosts to local
          users (i.e. before any greylist checks, envelope signature
          checks, etc):

</p><pre class="screen">
  # Limit the number of recipients in each incoming message to one
  # to support per-user settings and data (e.g. for SpamAssassin).
  #
  # NOTE: Every mail sent to several users at your site will be
  #       delayed for 30 minutes or more per recipient.  This
  #       significantly slow down the pace of discussion threads
  #       involving several internal and external parties.
  #
  defer
    message      = We only accept one recipient at a time - please try later.
    condition    = $recipients_count

</pre><p>
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="exim-sa-as-user"></a>10.3.2. Pass the recipient username to SpamAssassin</h4></div></div></div><p>
          In <a class="xref" href="#acl_data_final" title="14.5. acl_data">acl_data</a>, we modify the
          <code class="option">spam</code> condition given in the previous
          section, so that it passes on to SpamAssassin the username
          specified in the local part of the recipient address.

</p><pre class="screen">
  # Invoke SpamAssassin to obtain $spam_score and $spam_report.
  # Depending on the classification, $acl_m9 is set to "ham" or "spam".
  #
  # We pass on the username specified in the recipient address,
  # i.e. the portion before any '=' or '@' character, converted
  # to lowercase.  Multiple recipients should not occur, since
  # we previously limited delivery to one recipient at a time.
  #
  # If the message is classified as spam, pretend to reject it. 
  #
  warn
    set acl_m9  = ham
    spam        = ${lc:${extract{1}{=@}{$recipients}{$value}{mail}}}
    set acl_m9  = spam
    control     = fakereject
    logwrite    = :reject: Rejected spam (score $spam_score): $spam_report

</pre><p>
        </p><p>
          Note that instead of using Exim's
          <code class="option">${local_part:...}</code> function to get the
          username, we manually extracted the portion before any
          <span class="quote">&#8220;<span class="quote">@</span>&#8221;</span> or <span class="quote">&#8220;<span class="quote">=</span>&#8221;</span> character.  This is
          because we will use the latter character in our <a class="link" href="#exim-sign" title="11. Adding Envelope Sender Signatures">envelope signature</a> scheme, to
          follow.
        </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="exim-per-user-sa"></a>10.3.3. Enable per-user settings in SpamAssassin</h4></div></div></div><p>
          Let us now again look at SpamAssassin.  First of all, you
          may choose to remove the <code class="option">use_bayes 0</code>
          setting that we previously added in its site-wide
          configuration file.  In any case, each user will now have
          the ability to decide whether to override this setting for
          themselves.
        </p><p>
          If mailboxes on your system map directly to local UNIX
          accounts with home directories, you are done.  By default,
          the SpamAssassin daemon (<span class="command"><strong>spamd</strong></span>) performs
          a <code class="option">setuid()</code> to the username we pass to it,
          and stores user data and settings in that user's home
          directory.
        </p><p>
          If this is not the case (for instance, if your mail accounts
          are managed by Cyrus SASL or by another server), you need to
          tell SpamAssassin where to find each user's preferences and
          data files.  Also, <span class="command"><strong>spamd</strong></span> needs to keep
          running as a specific local user instead of attempting to
          <code class="option">setuid()</code> to a non-existing user.
        </p><p>
          We do these things by specifying the options passed to
          <span class="command"><strong>spamd</strong></span> at startup:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              On a Debian system, edit the <code class="option">OPTIONS=</code>
              setting in <code class="option">/etc/default/spamassassin</code>.
            </p></li><li class="listitem"><p>
              On a RedHat system, edit the
              <code class="option">SPAMDOPTIONS=</code> setting in
              <code class="option">/etc/sysconfig/spamassassin</code>.
            </p></li><li class="listitem"><p>
              Others, figure it out.
            </p></li></ul></div><p>
          The options you need are:
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
              <code class="option">-u</code> <em class="parameter"><code>username</code></em> -
              specify the user under which <span class="command"><strong>spamd</strong></span>
              will run (e.g. <code class="option">mail</code>)
            </p></li><li class="listitem"><p>
              <code class="option">-x</code> - disable configuration files in
              user's home directory.
            </p></li><li class="listitem"><p>
              <code class="option">--virtual-config-dir=/var/lib/spamassassin/%u</code>
              - specify where per-user settings and data are stored.
              <span class="quote">&#8220;<span class="quote">%u</span>&#8221;</span> is replaced with the calling username.
              <span class="command"><strong>spamd</strong></span> must be able to create or
              modify this directory:
</p><pre class="screen">
# mkdir /var/lib/spamassassin
# chown -R mail:mail /var/lib/spamassassin
</pre><p>
            </p></li></ul></div><p>
          Needless to say, after making these changes, you need to
          restart <span class="command"><strong>spamd</strong></span>.
        </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-sign"></a>11. Adding Envelope Sender Signatures</h2></div></div></div><p>
      Here we implement <a class="xref" href="#signedsender" title="7.3. Enveloper Sender Signature">Envelope Sender Signature</a> in our outgoing
      mail, and check for these signatures before accepting incoming
      <span class="quote">&#8220;<span class="quote">bounces</span>&#8221;</span> (i.e. mail with no envelope sender).
    </p><p>
      The envelope sender address of outgoing mails from your host
      will be modified as follows:

      </p><pre class="screen"><em class="parameter"><code>sender</code></em>=<em class="parameter"><code>recipient</code></em>=<em class="parameter"><code>recipient.domain</code></em>=<em class="parameter"><code>hash</code></em>@<em class="parameter"><code>sender.domain</code></em></pre><p>
    </p><p>
      However, because this scheme may produce unintended consequences
      (e.g. in the case of mailing list servers), we make it optional
      for your users.  We sign the envelope sender address of outgoing
      mail only if we find a file named
      <span class="quote">&#8220;<span class="quote">.return-path-sign</span>&#8221;</span> in the sender's home directory,
      and only if the domain we are sending to is matched in that
      file.   If the file exists, but is empty, all domains match.
    </p><p>
      Similarly, we only require the recipient address to be signed in
      incoming <span class="quote">&#8220;<span class="quote">bounce</span>&#8221;</span> messages (i.e. messages with no
      envelope sender) if the same file exists in recipient's home
      directory.  Users can exempt specific hosts from this check via
      their user specific whitelist, as described in
      <a class="xref" href="#exim-forward" title="13. Exempting Forwarded Mail">Exempting Forwarded Mail</a>.
    </p><p>
      Also, because this scheme involves tweaking with routers and
      transports in addition to ACLs, we do not include it in the
      <a class="xref" href="#exim-final" title="14. Final ACLs">Final ACLs</a> to follow.  If you are able to
      follow the instructions pertaining to those sections, you should
      also be able to add the ACL section as described here.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sign-transport"></a>11.1. Create a Transport to Sign the Sender Address</h3></div></div></div><p>
        First we create an Exim <span class="emphasis"><em>transport</em></span> that
        will be used to sign the envelope sender for remote
        deliveries:

</p><pre class="screen">
remote_smtp_signed:
  debug_print    = "T: remote_smtp_signed for $local_part@$domain"
  driver         = smtp
  max_rcpt       = 1
  return_path    = $sender_address_local_part=$local_part=$domain=\
                   ${hash_8:${hmac{md5}{SECRET}{${lc:\
                     $sender_address_local_part=$local_part=$domain}}}}\
                   @$sender_address_domain
</pre><p>
      </p><p>
        The <span class="quote">&#8220;<span class="quote">local part</span>&#8221;</span> of the sender address now
        consists of the following components, separated by equal
        signs (<span class="quote">&#8220;<span class="quote">=</span>&#8221;</span>):
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            the sender's username, i.e. the original local part,
          </p></li><li class="listitem"><p>
            the local part of the recipient address,
          </p></li><li class="listitem"><p>
            the domain part of the recipient address,
          </p></li><li class="listitem"><p>
            a string unique to this sender/recipient
            combination, generated by:
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
                encrypting the three prior components of the rewritten
                sender address, using Exim's
                <code class="option">${hmac{md5}...}</code> function along with
                the <code class="option">SECRET</code> we declared in the
                <code class="option">main</code> section,
                <a href="#ftn.idm1936" class="footnote" name="idm1936"><sup class="footnote">[18]</sup></a>
              </p></li><li class="listitem"><p>
                hashing the result into 8 lowercase letters, using
                Exim's <code class="option">${hash...}</code> function.
              </p></li></ul></div></li></ul></div><p>
        If you need authentication for deliveries to
        <span class="quote">&#8220;<span class="quote">smarthosts</span>&#8221;</span>, add an appropriate
        <code class="option">hosts_try_auth</code> line here as well.
        (Take it from your existing smarthost transport).
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sign-router-remote"></a>11.2. Create a New Router for Remote Deliveries</h3></div></div></div><p>
        Add a new router prior to the existing router(s) that
        currently handles your outgoing mail.  This router will use
        the transport above for remote deliveries, but only if the
        file <span class="quote">&#8220;<span class="quote">.return-path-sign</span>&#8221;</span> exists in the sender's
        home directory, and if the recipient's domain is matched in
        that file.  For instance, if you send mail directly over the
        internet to the final destination:

</p><pre class="screen">
# Sign the envelope sender address (return path) for deliveries to
# remote domains if the sender's home directory contains the file
# ".return-path-sign", and if the remote domain is matched in that
# file. If the file exists, but is empty, the envelope sender
# address is always signed.  
#
dnslookup_signed:
  debug_print   = "R: dnslookup_signed for $local_part@$domain"
  driver        = dnslookup
  transport     = remote_smtp_signed
  senders       = ! : *
  domains       = ! +local_domains : !+relay_to_domains : \
             ${if exists {/home/$sender_address_local_part/.return-path-sign}\
                         {/home/$sender_address_local_part/.return-path-sign}\
                         {!*}}
  no_more
</pre><p>
      </p><p>
        Or if you use a smarthost:

</p><pre class="screen">
# Sign the envelope sender address (return path) for deliveries to
# remote domains if the sender's home directory contains the file
# ".return-path-sign", and if the remote domain is matched in that
# file. If the file exists, but is empty, the envelope sender
# address is always signed.
#
smarthost_signed:
  debug_print   = "R: smarthost_signed for $local_part@$domain"
  driver        = manualroute
  transport     = remote_smtp_signed
  senders       = ! : *
  route_list    = * <em class="parameter"><code>smarthost.address</code></em>
  host_find_failed = defer
  domains       = ! +local_domains : !+relay_to_domains : \
             ${if exists {/home/$sender_address_local_part/.return-path-sign}\
                         {/home/$sender_address_local_part/.return-path-sign}\
                         {!*}}
  no_more  
</pre><p>
      </p><p>
        Add other options as you see fit
        (e.g. <code class="option">same_domain_copy_routing = yes</code>),
        perhaps modelled after your existing routers.
      </p><p>
        Note that we do not use this router for mails with no envelope
        sender address - we wouldn't want to tamper with those!
        <a href="#ftn.idm1959" class="footnote" name="idm1959"><sup class="footnote">[19]</sup></a>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sign-router-redirect"></a>11.3. Create New Redirect Router for Local Deliveries</h3></div></div></div><p>
        Next, you need to tell Exim that incoming recipient
        addresses that match the format above should be delivered to
        the mailbox identified by the portion before the first equal
        (<span class="quote">&#8220;<span class="quote">=</span>&#8221;</span>) sign.  For this purpose, you want to
        insert a <code class="option">redirect</code> router early in the
        <code class="option">routers</code> section of your configuration file
        - before any other routers pertaining to local deliveries
        (such as a <span class="emphasis"><em>system alias</em></span> router):
</p><pre class="screen">
hashed_local:
  debug_print       = "R: hashed_local for $local_part@$domain"
  driver            = redirect
  domains           = +local_domains
  local_part_suffix = =*
  data              = $local_part@$domain
</pre><p>
      </p><p>
        Recipient addresses that contain a equal sign are rewritten
        such that the portion of the local part that follows the
        equal sign are stripped off.  Then all routers are
        processed again.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-sign-acl"></a>11.4. ACL Signature Check</h3></div></div></div><p>
        The final part of this scheme is to tell Exim that mails
        delivered to valid recipient addresses with this signature
        should <span class="emphasis"><em>always</em></span> be accepted, and that 
        other messages with a NULL envelope sender should be
        rejected if the recipient has opted in to this scheme.
        No greylisting should be done in either case.
      </p><p>
        The following snippet should be placed in <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>, prior to any SPF checks,
        greylisting, and/or the final <code class="option">accept</code>
        statement:

</p><pre class="screen">
  # Accept the recipient addresss if it contains our own signature.
  # This means this is a response (DSN, sender callout verification...)
  # to a message that was previously sent from here.
  #
  accept
    domains     = +local_domains
    condition   = ${if and {{match{${lc:$local_part}}{^(.*)=(.*)}}\
                            {eq{${hash_8:${hmac{md5}{SECRET}{$1}}}}{$2}}}\
                           {true}{false}}

  # Otherwise, if this message claims to be a bounce (i.e. if there
  # is no envelope sender), but if the receiver has elected to use
  # and check against envelope sender signatures, reject it.
  #
  deny
    message     = This address does not match a valid, signed \
                  return path from here.\n\
                  You are responding to a forged sender address.
    log_message = bogus bounce.
    senders     = : postmaster@*
    domains     = +local_domains
    set acl_m9  = /home/${extract{1}{=}{${lc:$local_part}}}/.return-path-sign
    condition   = ${if exists {$acl_m9}{true}}

</pre><p>
      </p><p>
        You will have an issue when sending mail to hosts that
        perform callout verification on addresses in the message
        <span class="emphasis"><em>header</em></span>, such as the one provided in the
        <code class="option">From:</code> field of your outgoing mail.  The
        <code class="option">deny</code> statement here will effectively give a
        negative response to such a verification attempt.
      </p><p>
        For that reason, you may want to convert the last
        <code class="option">deny</code> statement into a <code class="option">warn</code>
        statement, store the rejection message in
        <code class="varname">$acl_m0</code>, and perform the actual rejection
        after the <span class="command"><strong>DATA</strong></span> command, in a fashion
        similar to previously described:

</p><pre class="screen">
  # Otherwise, if this message claims to be a bounce (i.e. if there
  # is no envelope sender), but if the receiver has elected to use
  # and check against envelope sender signatures, store a reject
  # message in $acl_m0, and a log message in $acl_m1.  We will later
  # use these to reject the mail.  In the mean time, their presence 
  # indicate that we should keep stalling the sender.
  #
  warn
    senders     = : postmaster@*
    domains     = +local_domains
    set acl_m9  = /home/${extract{1}{=}{${lc:$local_part}}}/.return-path-sign
    condition   = ${if exists {$acl_m9}{true}}
    set acl_m0  = The recipient address &lt;$local_part@$domain&gt; does not \
                  match a valid, signed return path from here.\n\
                  You are responding to a forged sender address.
    set acl_m1  = bogus bounce for &lt;$local_part@$domain&gt;.
</pre><p>
      </p><p>
        Also, even if the recipient has chosen to use envelope sender
        signatures in their outgoing mail, they may want to exempt
        specific hosts from having to provide this signature in
        incoming mail, even if the mail has no envelope sender
        address.  This may be required for specific mailing list
        servers, see the discussion on <a class="xref" href="#signedsender" title="7.3. Enveloper Sender Signature">Envelope Sender Signature</a>
        for details.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-bounces"></a>12. Accept Bounces Only for Real Users</h2></div></div></div><p>
      As discussed in <a class="xref" href="#dsnrealuser" title="7.4. Accept Bounces Only for Real Users">Accept Bounces Only for Real Users</a>, there is now a
      loophole that prevents us from catching bogus <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> sent to system users and aliases, such as
      <code class="option">postmaster</code>.  Here we cover two alternate ways
      to ensure that bounces are only accepted for users that actually
      send outgoing mail.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-dsn-mailbox"></a>12.1. Check for Recipient Mailbox</h3></div></div></div><p>
        The first method is performed in the <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a> ACL.  Here, we check that the
        recipient address corresponds to a local mailbox:

</p><pre class="screen">
  # Deny mail for users that do not have a mailbox (i.e. postmaster,
  # webmaster...) if no sender address is provided.  These users do
  # not send outgoing mail, so they should not receive returned mail.
  #
  deny
    message     = This address never sends outgoing mail. \
                  You are responding to a forged sender address.
    log_message = bogus bounce for system user &lt;$local_part@$domain&gt;
    senders     = : postmaster@*
    domains     = +local_domains
    !<em class="parameter"><code>mailbox check</code></em>
</pre><p>
      </p><p>
        Unfortunately, how we perform the <em class="parameter"><code>mailbox
        check</code></em> will depend on how you deliver your mail (as
        before, we extract the portion before the first <span class="quote">&#8220;<span class="quote">=</span>&#8221;</span>
        sign of the recipient address, to accomodate for <a class="link" href="#exim-sign" title="11. Adding Envelope Sender Signatures">Envelope Sender Signatures</a>):
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            If mailboxes map to local user accounts on your server, we
            can check that the recipient name maps to a user ID that
            corresponds to <span class="quote">&#8220;<span class="quote">regular</span>&#8221;</span> users on your
            system, e.g. in the range 500 - 60000:

</p><pre class="screen">
  set acl_m9 = ${extract{1}{=}{${lc:$local_part}}}
  set acl_m9 = ${extract{2}{:}{${lookup passwd {$acl_m9}{$value}}}{0}}
  condition  = ${if and {{&gt;={$acl_m9}{500}} {&lt;${acl_m9}{60000}}} {true}}

</pre><p>
          </p></li><li class="listitem"><p>
            If you deliver mail to the <a class="ulink" href="http://asg.web.cmu.edu/cyrus/" target="_top">Cyrus</a> IMAP
            suite, you can use the provided <span class="command"><strong>mbpath</strong></span>
            command-line utility to check that the mailbox exists.
            You will want to make sure that the Exim user has
            permission to check for mailboxes (for instance, you may
            add it to the <code class="option">cyrus</code> group:
            <span class="command"><strong># adduser exim4 cyrus</strong></span>).

</p><pre class="screen">
  set acl_m9 = ${extract{1}{=}{${lc:$local_part}}}
  condition  = ${run {/usr/sbin/mbpath -q -s user.$acl_m9} {true}}
  
</pre><p>
          </p></li><li class="listitem"><p>
            If you forward all mail to a remote machine for delivery,
            you may need to perform a <a class="xref" href="#callforward" title="3.3.2.1. Recipient Callout Verification">Recipient Callout Verification</a>
            and let that machine decide whether to accept the mail.
            You need to keep the original envelope sender intact in
            the callout:

</p><pre class="screen">
  verify = recipient/callout=use_sender

</pre><p>
          </p></li></ul></div><p>
        Since in the case of locally delivered mail, this mailbox
        check duplicates some of the logic that is performed in the
        routers, and since it is specific to the mail delivery
        mechanism on our site, it is perhaps a bit kludgy for the
        perfectionists among us.  So we will now provide an alternate
        way.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="exim-dsn-noalias"></a>12.2. Check for Empty Sender in Aliases Router</h3></div></div></div><p>
        You probably have a router named
        <code class="option">system_aliases</code> or similar, to redirect mail
        for users such as <code class="option">postmaster</code> and
        <code class="option">mailer-demon</code>.  Typically, these aliases are
        not used in the sender address of outgoing mail.  As such, you
        can ensure that incoming <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s are not routed
        through it by adding the following condition to the router:

        </p><pre class="screen">!senders = : postmaster@*</pre><p>
      </p><p>
        A sample aliases router may now look like this:
</p><pre class="screen">
system_aliases:
  driver         = redirect
  domains        = +local_domains
  !senders       = : postmaster@*
  allow_fail
  allow_defer
  data           = ${lookup{$local_part}lsearch{/etc/aliases}}
  user           = mail
  group          = mail
  file_transport = address_file
  pipe_transport = address_pipe
</pre><p>
      </p><p>
        Although we now block bounces to <span class="emphasis"><em>some</em></span>
        system aliases, other aliases were merely shadowing existing
        system users (such as <span class="quote">&#8220;<span class="quote">root</span>&#8221;</span>,
        <span class="quote">&#8220;<span class="quote">daemon</span>&#8221;</span>, etc).  If you deliver local mail
        through the <code class="option">accept</code> driver, and use
        <code class="option">check_local_user</code> to validate the recipient
        address, you may now find yourself routing mail directly to
        these system accounts.
      </p><p>
        To fix this problem, we now want to add an additional
        condition in the router that handles your local mail
        (e.g. <span class="emphasis"><em>local_user</em></span>) to ensure that the
        recipient not only exists, but is a <span class="quote">&#8220;<span class="quote">regular</span>&#8221;</span>
        user.  For instance, as above, we can check that the user ID
        is in the range 500 - 60000:

</p><pre class="screen">
  condition  = ${if and {{&gt;={$local_user_uid}{500}}\
                         {&lt;{$local_user_uid}{60000}}}\
                    {true}}
</pre><p>
      </p><p>
        A sample router for local delivery may now look like this:
</p><pre class="screen">
local_user:
  driver           = accept
  domains          = +local_domains
  check_local_user
  condition        = ${if and {{&gt;={$local_user_uid}{500}}\
                               {&lt;{$local_user_uid}{60000}}}\
                              {true}}
  transport        = <em class="parameter"><code>transport</code></em>
</pre><p>
      </p><p>
        Beware that if you implement this method, the reject response
        from your server in response to bogus bounce mail for system
        users will be the same as for unknown recipients (<span class="command"><strong>550
        Unknown User</strong></span> in our case).
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-forward"></a>13. Exempting Forwarded Mail</h2></div></div></div><p>
      After adding all these checks in the SMTP transaction, we may
      find ourselves indirectly creating collateral spam as a result
      of rejecting mails forwarded from trusted sources, such as
      mailing lists and mail accounts on other sites (see the
      discussion on <a class="xref" href="#forwardedmail" title="3. Forwarded Mail">Forwarded Mail</a> for details).  We
      now need to whitelist these hosts in order to exempt them from
      SMTP rejections -- at least those rejections that are caused by
      our spam and/or virus filtering.
    </p><p>
      In this example, we will consult two files in response to each
      <span class="command"><strong>RCPT TO:</strong></span> command:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          A global whitelist in
          <code class="option">/etc/mail/whitelist-hosts</code>, containing
          backup MX hosts and other whitelisted senders
          <a href="#ftn.noretrysenders" class="footnoteref"><sup class="footnoteref">[9]</sup></a>, and
        </p></li><li class="listitem"><p>
          A user-specific list in
          <code class="option">/home/<em class="parameter"><code>user</code></em>/.forwarders</code>,
          specifying hosts from which that particuar user will receive
          forwarded mail (e.g. mailing list servers, outgoing mail
          servers for accounts elsewhere...)
        </p></li></ul></div><p>
      If your mail users do not have local user accounts and home
      directories, you may want to modify the file paths and/or lookup
      mechanisms to something more suitable for your system
      (e.g. database lookups or LDAP queries).
    </p><p>
      If the sender host is found in one of these whitelists, we save
      the word <span class="quote">&#8220;<span class="quote">accept</span>&#8221;</span> in <code class="varname">$acl_m0</code>, and
      clear the contents of <code class="varname">$acl_m1</code>, as described in
      the previous section on <a class="xref" href="#exim-smtpdelays-selective" title="5.2. Selective Delays">Selective Delays</a>.  This will indicate that
      we should not reject the mail in subsequent statements.
    </p><p>
      In the <a class="xref" href="#acl_rcpt_to_final" title="14.4. acl_rcpt_to">acl_rcpt_to</a>, we insert the
      following statement after validating the recipient address, but
      before any <code class="option">accept</code> statements pertaining to
      unauthenticated deliveries from remote hosts to local users
      (i.e. before any greylist checks, envelope signature checks,
      etc):

</p><pre class="screen">
  # Accept the mail if the sending host is matched in the global
  # whitelist file.  Temporarily set $acl_m9 to point to this  file. 
  # If the host is found, set a flag in $acl_m0 and clear $acl_m1 to 
  # indicate that we should not reject this mail later.
  # 
  accept
    set acl_m9  = /etc/mail/whitelist-hosts
    hosts       = ${if exists {$acl_m9}{$acl_m9}}
    set acl_m0  = accept
    set acl_m1  = 


  # Accept the mail if the sending host is matched in the ".forwarders" 
  # file in the recipient's home directory.  Temporarily set $acl_m9 to
  # point to this file.  If the host is found, set a flag in $acl_m0 and
  # clear $acl_m1 to indicate that we should not reject this mail later.
  #
  accept
    domains     = +local_domains
    set acl_m9  = /home/${extract{1}{=}{${lc:$local_part}}}/.forwarders
    hosts       = ${if exists {$acl_m9}{$acl_m9}} 
    set acl_m0  = accept
    set acl_m1  = 
</pre><p>
    </p><p>
      In various statements in the <a class="xref" href="#acl_data_final" title="14.5. acl_data">acl_data</a>
      ACL, we check the contents of <code class="varname">$acl_m0</code> to avoid
      rejecting the mail if this is set as per above.  For instance,
      to avoid rejecting mail from whitelisted hosts due to a missing
      RFC2822 header:

</p><pre class="screen">
  deny
    message     = Your message does not conform to RFC2822 standard
    log_message = missing header lines
    !hosts      = +relay_from_hosts
    !senders    = : postmaster@*
    condition   = ${if !eq {$acl_m0}{accept}{true}}
    condition   = ${if or {{!def:h_Message-ID:}\
                           {!def:h_Date:}\
                           {!def:h_Subject:}} {true}{false}}
</pre><p>
    </p><p>
      The appropriate checks are embedded in the <a class="xref" href="#exim-final" title="14. Final ACLs">Final ACLs</a>, next.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="exim-final"></a>14. Final ACLs</h2></div></div></div><p>
      OK, time to wake up!  This has been very long reading - but
      congratulations on making it this far!
    </p><p>
      The following ACLs incorporate all of the checks we have
      described so in this implementation.  However, some have been
      commented out, for the following reasons:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <a class="link" href="#exim-greylisting" title="6. Adding Greylisting Support">Greylisting</a>.  This
          either requires additional software to be installed, or
          fairly complex inline configuration by way of additional
          ACLs and definitions in the Exim configuration file.
          I highly recommend it, though.
        </p></li><li class="listitem"><p>
          <a class="link" href="#exim-av" title="9. Adding Anti-Virus Software">Virus scanning</a>.
          There is no <span class="emphasis"><em>ubiquitous</em></span> scanner that
          nearly everyone uses, similar to SpamAssassin for spam
          identification.  On the other hand, the documentation that
          comes with <code class="option">Exiscan-ACL</code> should be easy to
          follow.
        </p></li><li class="listitem"><p>
          <a class="link" href="#exim-per-user" title="10.3. User Settings and Data">Per-user settings for
          SpamAssassin</a>.  This is a trade-off that for many is
          unacceptable, as it involves deferring mail to all but the
          first recipient of a message.
        </p></li><li class="listitem"><p>
          <a class="link" href="#exim-sign" title="11. Adding Envelope Sender Signatures">Envelope Sender Signatures</a>.
          There are consequences, e.g. for roaming users.  Also, it
          involves configuring routers and transports as well as
          ACLs.  See that section for details.
        </p></li><li class="listitem"><p>
          <a class="link" href="#exim-bounces" title="12. Accept Bounces Only for Real Users">Accepting Bounces Only for Real
          Users</a>.  There are several ways of doing this, and
          determining which users are real is specific to how mail is
          delivered.
        </p></li></ul></div><p>
      Without further ado, here comes the final result we have all
      been waiting for.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_connect_final"></a>14.1. acl_connect</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used at the start of an incoming
# connection.  The tests are run in order until the connection is
# either accepted or denied.

acl_connect:
  # Record the current timestamp, in order to calculate elapsed time
  # for subsequent delays
  warn
    set acl_m2  = $tod_epoch


  # Accept mail received over local SMTP (i.e. not over TCP/IP).  We do
  # this by testing for an empty sending host field.
  # Also accept mails received over a local interface, and from hosts
  # for which we relay mail.
  accept
    hosts       = : +relay_from_hosts


  # If the connecting host is in one of several DNSbl's, then prepare
  # a warning message in $acl_c1.  We will later add this message to
  # the mail header.  In the mean time, its presence indicates that
  # we should keep stalling the sender.
  #

  warn
    !hosts      = ${if exists {/etc/mail/whitelist-hosts} \
                              {/etc/mail/whitelist-hosts}}
    dnslists    = list.dsbl.org : \
                  dnsbl.sorbs.net : \
                  dnsbl.njabl.org : \
                  bl.spamcop.net : \
                  dsn.rfc-ignorant.org : \
                  sbl-xbl.spamhaus.org : \
                  l1.spews.dnsbl.sorbs.net
    set acl_c1  = X-DNSbl-Warning: \
                  $sender_host_address is listed in $dnslist_domain\
                  ${if def:dnslist_text { ($dnslist_text)}}


  # Likewise, if reverse DNS lookup of the sender's host fails (i.e.
  # there is no rDNS entry, or a forward lookup of the resulting name
  # does not match the original IP address), then generate a warning
  # message in $acl_c1.  We will later add this message to the mail
  # header.
  warn
    condition   = ${if !def:acl_c1 {true}{false}}
    !verify     = reverse_host_lookup
    set acl_m9  = Reverse DNS lookup failed for host $sender_host_address
    set acl_c1  = X-DNS-Warning: $acl_m9


  # Accept the connection, but if we previously generated a message in
  # $acl_c1, stall the sender until 20 seconds has elapsed.
  accept
    set acl_m2  = ${if def:acl_c1 {${eval:20 + $acl_m2 - $tod_epoch}}{0}}
    delay       = ${if &gt;{$acl_m2}{0}{$acl_m2}{0}}s
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_helo_final"></a>14.2. acl_helo</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for the HELO or EHLO command in 
# an incoming SMTP transaction. The tests are run in order until the
# greeting is either accepted or denied.

acl_helo:
  # Record the current timestamp, in order to calculate elapsed time
  # for subsequent delays
  warn
    set acl_m2  = $tod_epoch


  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  accept
    hosts       = : +relay_from_hosts


  # If the remote host greets with an IP address, then prepare a reject
  # message in $acl_c0, and a log message in $acl_c1.  We will later use
  # these in a "deny" statement.  In the mean time, their presence indicate
  # that we should keep stalling the sender.
  # 
  warn
    condition   = ${if isip {$sender_helo_name}{true}{false}}
    set acl_c0  = Message was delivered by ratware
    set acl_c1  = remote host used IP address in HELO/EHLO greeting


  # Likewise if the peer greets with one of our own names
  # 
  warn
    condition   = ${if match_domain{$sender_helo_name}\
                       {$primary_hostname:+local_domains:+relay_to_domains}\
                       {true}{false}}
    set acl_c0  = Message was delivered by ratware
    set acl_c1  = remote host used our name in HELO/EHLO greeting.


  # If HELO verification fails, we prepare a warning message in acl_c1.
  # We will later add this message to the mail header.  In the mean time,
  # its presence indicates that we should keep stalling the sender.
  # 
  warn
    condition   = ${if !def:acl_c1 {true}{false}}
    !verify     = helo
    set acl_c1  = X-HELO-Warning: Remote host $sender_host_address \
                  ${if def:sender_host_name {($sender_host_name) }}\
                  incorrectly presented itself as $sender_helo_name
    log_message = remote host presented unverifiable HELO/EHLO greeting.


  # Accept the greeting, but if we previously generated a message in
  # $acl_c1, stall the sender until 20 seconds has elapsed.
  accept
    set acl_m2  = ${if def:acl_c1 {${eval:20 + $acl_m2 - $tod_epoch}}{0}}
    delay       = ${if &gt;{$acl_m2}{0}{$acl_m2}{0}}s

</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_mail_from_final"></a>14.3. acl_mail_from</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for the MAIL FROM: command in an
# incoming SMTP transaction.  The tests are run in order until the
# sender address is either accepted or denied.
#

acl_mail_from:
  # Record the current timestamp, in order to calculate elapsed time
  # for subsequent delays
  warn
    set acl_m2  = $tod_epoch


  # Accept mail received over local SMTP (i.e. not over TCP/IP). 
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  # Sender verification is omitted here, because in many cases
  # the clients are dumb MUAs that don't cope well with SMTP
  # error responses.
  #
  accept
    hosts     = : +relay_from_hosts


  # Accept if the message arrived over an authenticated connection,
  # from any host. Again, these messages are usually from MUAs.
  #
  accept
    authenticated = *


  # If present, the ACL variables $acl_c0 and $acl_c1 contain rejection
  # and/or warning messages to be applied to every delivery attempt in
  # in this SMTP transaction.  Assign these to the corresponding 
  # $acl_m{0,1} message-specific variables, and add any warning message
  # from $acl_m1 to the message header.  (In the case of a rejection,
  # $acl_m1 actually contains a log message instead, but this does not
  # matter, as we will discard the header along with the message).
  #
  warn
    set acl_m0  = $acl_c0
    set acl_m1  = $acl_c1
    message     = $acl_c1


  # If sender did not provide a HELO/EHLO greeting, then prepare a reject
  # message in $acl_m0, and a log message in $acl_m1.  We will later use
  # these in a "deny" statement.  In the mean time, their presence indicate
  # that we should keep stalling the sender.
  #
  warn
    condition   = ${if def:sender_helo_name {0}{1}}
    set acl_m0  = Message was delivered by ratware
    set acl_m1  = remote host did not present HELO/EHLO greeting.


  # If we could not verify the sender address, create a warning message
  # in $acl_m1 and add it to the mail header.  The presence of this
  # message indicates that we should keep stalling the sender.
  #
  # You may choose to omit the "callout" option.  In particular, if
  # you are sending outgoing mail through a smarthost, it will not
  # give any useful information.
  #
  warn
    condition   = ${if !def:acl_m1 {true}{false}}
    !verify     = sender/callout
    set acl_m1  = Invalid sender &lt;$sender_address&gt;
    message     = X-Sender-Verify-Failed: $acl_m1
    log_message = $acl_m1


  # Accept the sender, but if we previously generated a message in
  # $acl_c1, stall the sender until 20 seconds has elapsed.
  accept
    set acl_m2  = ${if def:acl_c1 {${eval:20 + $acl_m2 - $tod_epoch}}{0}}
    delay       = ${if &gt;{$acl_m2}{0}{$acl_m2}{0}}s

</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_rcpt_to_final"></a>14.4. acl_rcpt_to</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for every RCPT command in an
# incoming SMTP message.  The tests are run in order until the 
# recipient address is either accepted or denied.

acl_rcpt_to:

  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  # Recipient verification is omitted here, because in many
  # cases the clients are dumb MUAs that don't cope well with 
  # SMTP error responses.
  #
  accept
    hosts       = : +relay_from_hosts


  # Accept if the message arrived over an authenticated connection,
  # from any host. Again, these messages are usually from MUAs, so
  # recipient verification is omitted.
  #
  accept
    authenticated = *


  # Deny if the local part contains @ or % or / or | or !. These are
  # rarely found in genuine local parts, but are often tried by people
  # looking to circumvent relaying restrictions.
  #
  # Also deny if the local part starts with a dot. Empty components
  # aren't strictly legal in RFC 2822, but Exim allows them because
  # this is common.  However, actually starting with a dot may cause
  # trouble if the local part is used as a file name (e.g. for a
  # mailing list).
  #
  deny
    local_parts = ^.*[@%!/|] : ^\\.


  # Deny if we have previously given a reason for doing so in $acl_m0.
  # Also stall the sender for another 20s first.
  #
  deny
    message     = $acl_m0
    log_message = $acl_m1
    condition   = ${if and {{def:acl_m0}{def:acl_m1}} {true}}
    delay       = 20s


  # If the recipient address is not in a domain for which we are handling
  # mail, stall the sender and reject.
  #
  deny
    message     = relay not permitted
    !domains    = +local_domains : +relay_to_domains
    delay       = 20s


  # If the address is in a local domain or in a domain for which are
  # relaying, but is invalid, stall and reject.
  #
  deny
    message     = unknown user
    !verify     = recipient/callout=20s,defer_ok,use_sender
    delay       = ${if def:sender_address {1m}{0s}}



  # Drop the connection if the envelope sender is empty, but there is
  # more than one recipient address.  Legitimate DSNs are never sent
  # to more than one address.
  #
  drop
    message      = Legitimate bounces are never sent to more than one \
                   recipient.
    senders      = : postmaster@*
    condition    = $recipients_count
    delay        = 5m


  # --------------------------------------------------------------------
  # Limit the number of recipients in each incoming message to one
  # to support per-user settings and data (e.g. for SpamAssassin).
  #
  # NOTE: Every mail sent to several users at your site will be
  #       delayed for 30 minutes or more per recipient.  This
  #       significantly slow down the pace of discussion threads
  #       involving several internal and external parties.
  #       Thus, it is commented out by default.
  #
  #defer
  #  message      = We only accept one recipient at a time - please try later.
  #  condition    = $recipients_count
  # --------------------------------------------------------------------


  # Accept the mail if the sending host is matched in the ".forwarders" 
  # file in the recipient's home directory.  Temporarily set $acl_m9 to
  # point to this file.  If the host is found, set a flag in $acl_m0 and
  # clear $acl_m1 to indicate that we should not reject this mail later.
  #
  accept
    domains     = +local_domains
    set acl_m9  = /home/${extract{1}{=}{${lc:$local_part}}}/.forwarders
    hosts       = ${if exists {$acl_m9}{$acl_m9}} 
    set acl_m0  = accept
    set acl_m1  = 


  # Accept the mail if the sending host is matched in the global
  # whitelist file.  Temporarily set $acl_m9 to point to this  file. 
  # If the host is found, set a flag in $acl_m0 and clear $acl_m1 to 
  # indicate that we should not reject this mail later.
  # 
  accept
    set acl_m9  = /etc/mail/whitelist-hosts
    hosts       = ${if exists {$acl_m9}{$acl_m9}}
    set acl_m0  = accept
    set acl_m1  = 


  # --------------------------------------------------------------------
  # Envelope Sender Signature Check.
  # This is commented out by default, because it requires additional
  # configuration in the 'transports' and 'routers' sections.
  #
  # Accept the recipient addresss if it contains our own signature.
  # This means this is a response (DSN, sender callout verification...)
  # to a message that was previously sent from here.
  #
  #accept
  #  domains     = +local_domains
  #  condition   = ${if and {{match{${lc:$local_part}}{^(.*)=(.*)}}\
  #                          {eq{${hash_8:${hmac{md5}{SECRET}{$1}}}}{$2}}}\
  #                         {true}{false}}
  #
  # Otherwise, if this message claims to be a bounce (i.e. if there
  # is no envelope sender), but if the receiver has elected to use
  # and check against envelope sender signatures, reject it.
  #
  #deny
  #  message     = This address does not match a valid, signed \
  #                return path from here.\n\
  #                You are responding to a forged sender address.
  #  log_message = bogus bounce.
  #  senders     = : postmaster@*
  #  domains     = +local_domains
  #  set acl_m9  = /home/${extract{1}{=}{${lc:$local_part}}}/.return-path-sign
  #  condition   = ${if exists {$acl_m9}{true}}
  # --------------------------------------------------------------------


  # --------------------------------------------------------------------
  # Deny mail for local users that do not have a mailbox (i.e. postmaster,
  # webmaster...) if no sender address is provided.  These users do
  # not send outgoing mail, so they should not receive returned mail.
  #
  # NOTE: This is commented out by default, because the condition is
  #       specific to how local mail is delivered.  If you want to
  #       enable this check, uncomment one and only one of the
  #       conditions below.
  #
  #deny
  #  message     = This address never sends outgoing mail. \
  #                You are responding to a forged sender address.
  #  log_message = bogus bounce for system user &lt;$local_part@$domain&gt;
  #  senders     = : postmaster@*
  #  domains     = +local_domains
  #  set acl_m9  = ${extract{1}{=}{${lc:$local_part}}}
  #
  # --- Uncomment the following 2 lines if recipients have local accounts:
  #  set acl_m9  = ${extract{2}{:}{${lookup passwd {$acl_m9}{$value}}}{0}}
  #  !condition  = ${if and {{&gt;={$acl_m9}{500}} {&lt;${acl_m9}{60000}}} {true}}
  # 
  # --- Uncomment the following line if you deliver mail to Cyrus:
  #  condition  = ${run {/usr/sbin/mbpath -q -s user.$acl_m9} {true}}
  # --------------------------------------------------------------------



  # Query the SPF information for the sender address domain, if any,
  # to see if the sending host is authorized to deliver its mail.
  # If not, reject the mail.
  #
  deny
    message     = [SPF] $sender_host_address is not allowed to send mail \
                  from $sender_address_domain
    log_message = SPF check failed.
    spf         = fail


  # Add a SPF-Received: line to the message header
  warn
    message     = $spf_received


  # --------------------------------------------------------------------
  # Check greylisting status for this particular peer/sender/recipient.
  # Before uncommenting this statement, you need to install "greylistd".
  # See:  http://packages.debian.org/unstable/main/greylistd
  #
  # Note that we do not greylist messages with NULL sender, because
  # sender callout verification would break (and we might not be able
  # to send mail to a host that performs callouts).
  #
  #defer
  #  message     = $sender_host_address is not yet authorized to deliver mail \
  #                from &lt;$sender_address&gt; to &lt;$local_part@$domain&gt;. \
  #                Please try later.
  #  log_message = greylisted.
  #  domains     = +local_domains : +relay_to_domains
  #  !senders    = : postmaster@*
  #  set acl_m9  = $sender_host_address $sender_address $local_part@$domain
  #  set acl_m9  = ${readsocket{/var/run/greylistd/socket}{$acl_m9}{5s}{}{}}
  #  condition   = ${if eq {$acl_m9}{grey}{true}{false}}
  #  delay       = 20s
  # --------------------------------------------------------------------

  # Accept the recipient.
  accept
</pre><p>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="acl_data_final"></a>14.5. acl_data</h3></div></div></div><p>
</p><pre class="screen">
# This access control list is used for message data received via 
# SMTP.  The tests are run in order until the recipient address 
# is either accepted or denied.

acl_data:
  # Log some header lines
  warn
    logwrite    = Subject: $h_Subject:


  # Add Message-ID if missing in messages received from our own hosts.
  warn
    condition   = ${if !def:h_Message-ID: {1}}
    hosts       = +relay_from_hosts
    message     = Message-ID: &lt;E$message_id@$primary_hostname&gt;


  # Accept mail received over local SMTP (i.e. not over TCP/IP).  
  # We do this by testing for an empty sending host field.
  # Also accept mails received from hosts for which we relay mail.
  #
  accept
    hosts       = : +relay_from_hosts

  # Accept if the message arrived over an authenticated connection, from
  # any host.
  #
  accept
    authenticated = *


  # Deny if we have previously given a reason for doing so in $acl_m0.
  # Also stall the sender for another 20s first.
  #
  deny
    message     = $acl_m0
    log_message = $acl_m1
    condition   = ${if and {{def:acl_m0}{def:acl_m1}} {true}{false}}
    delay       = 20s


  # enforce a message-size limit
  #
  deny
    message     = Message size $message_size is larger than limit of \
                  MESSAGE_SIZE_LIMIT
    condition   = ${if &gt;{$message_size}{MESSAGE_SIZE_LIMIT}{yes}{no}}


  # Deny unless the addresses in the header is syntactically correct.
  #
  deny
    message     = Your message does not conform to RFC2822 standard
    log_message = message header fail syntax check
    !verify     = header_syntax


  # Uncomment the following to deny non-local messages without
  # a Message-ID:, Date:, or Subject: header.
  #
  # Note that some specialized MTAs, such as certain mailing list 
  # servers, do not automatically generate a Message-ID for bounces.
  # Thus, we add the check for a non-empty sender.
  #
  #deny
  #  message     = Your message does not conform to RFC2822 standard
  #  log_message = missing header lines
  #  !hosts      = +relay_from_hosts
  #  !senders    = : postmaster@*
  #  condition   = ${if !eq {$acl_m0}{accept}{true}}
  #  condition   = ${if or {{!def:h_Message-ID:}\
  #                         {!def:h_Date:}\
  #                         {!def:h_Subject:}} {true}{false}}


  # Warn unless there is a verifiable sender address in at least
  # one of the "Sender:", "Reply-To:", or "From:" header lines.
  #
  warn
    message     = X-Sender-Verify-Failed: No valid sender in message header
    log_message = No valid sender in message header
    !verify     = header_sender



  # --------------------------------------------------------------------
  # Perform greylisting on messages with no envelope sender here.
  # We did not subject these to greylisting after RCPT TO: because
  # that would interfere with remote hosts doing sender callouts.
  # Note that the sender address is empty, so we don't bother using it.
  #
  # Before uncommenting this statement, you need to install "greylistd".
  # See:  http://packages.debian.org/unstable/main/greylistd
  #
  #defer
  #  message     = $sender_host_address is not yet authorized to send \
  #                delivery status reports to &lt;$recipients&gt;. \
  #                Please try later.
  #  log_message = greylisted.
  #  senders     = : postmaster@*
  #  condition   = ${if !eq {$acl_m0}{accept}{true}}
  #  set acl_m9  = $sender_host_address $recipients
  #  set acl_m9  = ${readsocket{/var/run/greylistd/socket}{$acl_m9}{5s}{}{}}
  #  condition   = ${if eq {$acl_m9}{grey}{true}{false}}
  #  delay       = 20s
  # --------------------------------------------------------------------



  # --- BEGIN EXISCAN configuration ---

  # Reject messages that have serious MIME errors.
  #
  deny
    message     = Serious MIME defect detected ($demime_reason)
    demime      = *
    condition   = ${if &gt;{$demime_errorlevel}{2}{1}{0}}


  # Unpack MIME containers and reject file extensions used by worms.
  # This calls the demime condition again, but it will return cached results.
  # Note that the extension list may be incomplete.
  #
  deny
    message     = We do not accept ".$found_extension" attachments here.
    demime      = bat:btm:cmd:com:cpl:dll:exe:lnk:msi:pif:prf:reg:scr:vbs:url


  # Messages larger than MESSAGE_SIZE_SPAM_MAX are accepted without
  # spam or virus scanning
  accept
    condition   = ${if &gt;{$message_size}{MESSAGE_SIZE_SPAM_MAX} {true}}
    logwrite    = :main: Not classified \
                  (message size larger than MESSAGE_SIZE_SPAM_MAX)


  # --------------------------------------------------------------------
  # Anti-Virus scanning
  # This requires an 'av_scanner' setting in the main section.
  #
  #deny
  #  message  = This message contains a virus ($malware_name)
  #  demime   = *
  #  malware  = */defer_ok
  # --------------------------------------------------------------------



  # Invoke SpamAssassin to obtain $spam_score and $spam_report.
  # Depending on the classification, $acl_m9 is set to "ham" or "spam".
  #
  # If the message is classified as spam, and we have not previously
  # set $acl_m0 to indicate that we want to accept it anyway, pretend
  # reject it.
  #
  warn
    set acl_m9  = ham
    # ------------------------------------------------------------------
    # If you want to allow per-user settings for SpamAssassin,
    # uncomment the following line, and comment out "spam = mail".
    # We pass on the username specified in the recipient address,
    # i.e. the portion before any '=' or '@' character, converted
    # to lowercase.  Multiple recipients should not occur, since
    # we previously limited delivery to one recipient at a time.
    #
    # spam        = ${lc:${extract{1}{=@}{$recipients}{$value}{mail}}}
    # ------------------------------------------------------------------
    spam        = mail
    set acl_m9  = spam
    condition   = ${if !eq {$acl_m0}{accept}{true}}
    control     = fakereject
    logwrite    = :reject: Rejected spam (score $spam_score): $spam_report



  # Add an appropriate X-Spam-Status: header to the message.
  #
  warn
    message     = X-Spam-Status: \
                  ${if eq {$acl_m9}{spam}{Yes}{No}} (score $spam_score)\
                  ${if def:spam_report {: $spam_report}}
    logwrite    = :main: Classified as $acl_m9 (score $spam_score)


  # --- END EXISCAN configuration ---


  # Accept the message. 
  #
  accept
</pre><p>
      </p></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm1361" class="footnote"><p><a href="#idm1361" class="para"><sup class="para">[14] </sup></a>
        In particular, Exim is perhaps most popular among users of
        <a class="ulink" href="http://www.debian.org/" target="_top">Debian GNU/Linux</a>,
        as it is the default MTA in that distribution.  If you use
        Debian (<span class="quote">&#8220;<span class="quote">Sarge</span>&#8221;</span> or later), you can obtain
        Exim+Exiscan-ACL by installing the
        <code class="option">exim4-daemon-heavy</code> package:

        </p><pre class="screen"># apt-get install exim4-daemon-heavy</pre><p>
      </p></div><div id="ftn.idm1380" class="footnote"><p><a href="#idm1380" class="para"><sup class="para">[15] </sup></a>
        <span class="emphasis"><em>Debian users:</em></span> The
        <code class="option">exim4-config</code> package gives you a choice
        between splitting the Exim configuration into several small
        chunks distributed within subdirectories below
        <code class="option">/etc/exim4/conf.d</code>, or to keep the entire
        configuration in a single file.
      </p><p>
        If you chose the former option (I recommend this!), you can
        keep your customization well separated from the stock
        configuration provided with the <code class="option">exim4-config</code>
        package by creating new files within these subdirectories,
        rather than modifying the existing ones.  For instance, you
        may create a file named
        <code class="option">/etc/exim4/conf.d/acl/80_local-config_rcpt_to</code>
        to declare your own ACL for the <span class="command"><strong>RCPT TO:</strong></span>
        command (see <a class="link" href="#acl_rcpt_to_1" title="4.4. acl_rcpt_to">below</a>).
      </p><p>
        The Exim <span class="quote">&#8220;<span class="quote">init</span>&#8221;</span> script
        (<code class="option">/etc/init.d/exim4</code>) will automatically
        consolidate all these files into a single large run-time
        configuration file next time you (re)start.
      </p></div><div id="ftn.idm1692" class="footnote"><p><a href="#idm1692" class="para"><sup class="para">[16] </sup></a>
            Debian users: As of July 14th, 2004, the version of
            Exiscan-ACL that is included in the
            <code class="option">exim4-daemon-heavy</code> package does not yet
            have support for SPF.  In the mean time, you may choose
            the other SPF implementation; install
            <code class="option">libmail-spf-query-perl</code>.
          </p></div><div id="ftn.idm1828" class="footnote"><p><a href="#idm1828" class="para"><sup class="para">[17] </sup></a>
          Although it is true that Bayesian training is specific to
          each user, it should be noted that SpamAssassin's
          Bayesian classifier is, IMHO, not that stellar in any case.
          Especially I find this to be the case since spammers have
          learned to defeat such systems by seeding random dictionary
          words or stories in their mail (e.g.  in the metadata of
          HTML messages).
        </p></div><div id="ftn.idm1936" class="footnote"><p><a href="#idm1936" class="para"><sup class="para">[18] </sup></a>
                    If you think this is an overkill, would I tend to
                    agree on the surface.  In previous versions of
                    this document, I simply used
                    <code class="option">${hash_8:SECRET=....}</code> to generate
                    the last component of the signature.  However,
                    with this it would be technically possible, with a
                    bit of insight into Exim's
                    <code class="option">${hash...}</code> function and some
                    samples of your outgoing mail sent to different
                    recipients, to forge the signature.  Matthew
                    Byng-Maddic <code class="email">&lt;<a class="email" href="mailto:mbm%20(at)%20colondot.net">mbm (at) colondot.net</a>&gt;</code>
                    notes:
                    <span class="emphasis"><em>
                      What you're writing is a document that you
                      expect many people to just copy.  Given that,
                      kerchoff's principle starts applying, and all of
                      your secrecy should be in the key.  If the key
                      can be reversed out, as seems likely with a few
                      return paths, then the spammer kan once again
                      start emitting valid return-paths from that
                      domain, and you're back to where you
                      started. [...] Better, IMO, to have it being
                      strong from the start.
                    </em></span>
                  </p></div><div id="ftn.idm1959" class="footnote"><p><a href="#idm1959" class="para"><sup class="para">[19] </sup></a>
            In the examples above, the <code class="option">senders</code>
            condition is actually redundant, since the file
            <code class="option">/home//.return-path-sign</code> is not likely to
            exist.  However, we make the condition explicit for
            clarity.
          </p></div></div></div><div class="glossary"><div class="titlepage"><div><div><h1 class="title"><a name="glossary"></a>Glossary</h1></div></div></div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
      These are definitions for some of the words and terms that are
      used throughout this document.
    </p></div><div class="glossdiv"><h3 class="title">B</h3><dl><dt><a name="bayesian"></a><span class="glossterm">Bayesian Filters</span></dt><dd class="glossdef"><p>
	  A filter that assigns a probability of spam based on the
	  recurrence of words (or, more recently, word
	  constellations/phrases) between messages.
	</p><p>
	  You initially train the filter by feeding it known junk mail
	  (spam) and known legitimate mail (ham).  A bayesian score
	  is then be assigned to each word (or phrase) in each
	  message, indicating whether this particular word or phrase
	  occurs most commonly in ham or in spam.  The word, along
	  with its score, is stored in a <span class="emphasis"><em>bayesian
	  index</em></span>.
	</p><p>
	  Such filters may catch indicators that may be missed by
	  human programmers trying to manually create keyword-based
	  filters.  At the very least, they automate this task.
	</p><p>
	  Bayesian word indexes are most certainly specific to the
	  language in which they received training.  Moreover, they are
	  specific to individual users.  Thus, they are perhaps more
	  suitable for individual content filters (e.g. in <a class="xref" href="#mua" title="Mail User Agent">Mail User Agent</a>s) than they are for system-wide, SMTP-time
	  filtering.
	</p><p>
	  Moreover, spammers have developed techniques to defeat
	  simple bayesian filters, by including random dictionary
	  words and/or short stories in their messages.  This
	  decreases the spam probability assigned by a baynesian
	  filter, and in the long run, degrades the quality of the
	  bayesian index.
	</p><p>
	  See also:
	  <a class="ulink" href="http://www.everything2.com/index.pl?node=Bayesian" target="_top">http://www.everything2.com/index.pl?node=Bayesian</a>.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">C</h3><dl><dt><a name="coldamage"></a><span class="glossterm">Collateral Damage</span></dt><dd class="glossdef"><p>
	  Blocking of a legitimate sender host due to an entry in a
	  DNS blocklist.
	</p><p>
	  Some blocklists (like SPEWS) routinely list the entire IP
	  address space of an ISP if they feel the ISP is not
	  responsive to abuse complaints, thereby affecting
	  <span class="emphasis"><em>all</em></span> its customers.
	</p><p>
	  See also: <a class="xref" href="#falsepos" title="False Positive">False Positive</a>
	</p></dd><dt><a name="colspam"></a><span class="glossterm">Collateral Spam</span></dt><dd class="glossdef"><p>
	  Automated messages sent in response to an original message
	  (mostly spam or malware) where the sender address is forged.
	  Typical examples of collateral spam include virus scan
	  reports (<span class="quote">&#8220;<span class="quote">You have a virus</span>&#8221;</span>) or other <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s).
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">D</h3><dl><dt><a name="dns"></a><span class="glossterm">Domain Name System</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: DNS</em></span>) The de-facto standard for
	  obtaining information about internet domain names.  Examples
	  of such information include IP addresses of its servers
	  (so-called <span class="emphasis"><em>A records</em></span>), the dedication
	  of incoming mail exchangers (MX records), generic server
	  information (SRV records), and miscellaneous text
	  information (TXT records).
	</p><p>
	  DNS is a hierarctical, distributed system; each domain name
	  is associated with a set of one or more DNS servers that
	  provide information about that domain - including delegation
	  of name service for its subdomains.
	</p><p>
	  For instance, the top-level domain <span class="quote">&#8220;<span class="quote">org</span>&#8221;</span> is
	  operated by The Public Interest Registry; its DNS servers
	  delegate queries for the domain name <span class="quote">&#8220;<span class="quote">tldp.org</span>&#8221;</span>
	  to specific name servers for The Linux Documentation
	  Project.  In turn, TLDPs name server (actually operated by
	  UNC) may or may not delegate queries for third-level names,
	  such as <span class="quote">&#8220;<span class="quote">www.tldp.org</span>&#8221;</span>.
	</p><p>
	  DNS lookups are usually performed by forwarding name
	  servers, such as those provided by an Internet Service
	  Provider (e.g. via DHCP).
	</p></dd><dt><a name="dsn"></a><span class="glossterm">Delivery Status Notification</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: DSN</em></span>) A message automatically
	  created by an MTA or MDA, to inform the sender of an
	  original messsage (usually included in the DSN) about its
	  status.  For instance, DSNs may inform the sender of the
	  original message that it could not be delivered due to a
	  temporary or permanent problem, and/or whether or not and
	  for how long delivery attempts will continue.
	</p><p>
	  Delivery Status Notifications are sent with an empty <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> address.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">E</h3><dl><dt><a name="envfrom"></a><span class="glossterm">Envelope Sender</span></dt><dd class="glossdef"><p>
	  The e-mail address given as sender of a message during the
	  SMTP transaction, using the <span class="command"><strong>MAIL FROM:</strong></span>
	  command.  This may be different from the address provided in
	  the <span class="quote">&#8220;<span class="quote">From:</span>&#8221;</span> header of the message itself.
	</p><p>
	  One special case is <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> (bounced message,
	  return receipt, vacation message..).  For such mails, the
	  <a class="xref" href="#envfrom" title="Envelope Sender">Envelope Sender</a> is empty.  This is to prevent
	  <a class="xref" href="#loop" title="Mail Loop">Mail Loop</a>s, and generally to be able to
	  distinguish these from <span class="quote">&#8220;<span class="quote">regular</span>&#8221;</span> mails.
	</p><p>
	  See also: <a class="xref" href="#smtpintro" title="3. The SMTP Transaction">The SMTP Transaction</a>
	</p></dd><dt><a name="envto"></a><span class="glossterm">Envelope Recipient</span></dt><dd class="glossdef"><p>
	  The e-mail address(es) to which the message is sent.  These
	  are provided during the SMTP transaction, using the
	  <span class="command"><strong>RCPT TO</strong></span> command.  These may be different
	  from the addresses provided in the <span class="quote">&#8220;<span class="quote">To:</span>&#8221;</span> and
	  <span class="quote">&#8220;<span class="quote">Cc:</span>&#8221;</span> headers of the message itself.
	</p><p>
	  See also: <a class="xref" href="#smtpintro" title="3. The SMTP Transaction">The SMTP Transaction</a>
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">F</h3><dl><dt><a name="falseneg"></a><span class="glossterm">False Negative</span></dt><dd class="glossdef"><p>
	  Junk mail (spam, virus, malware) that is misclassified as
	  legitimate mail (and consequently, not filtered out).
	</p></dd><dt><a name="falsepos"></a><span class="glossterm">False Positive</span></dt><dd class="glossdef"><p>
	  Legitimate mail that is misclassified as junk (and
	  consequently, blocked).
	</p><p>
	  See also: <a class="xref" href="#coldamage" title="Collateral Damage">Collateral Damage</a>.
	</p></dd><dt><a name="fqdn"></a><span class="glossterm">Fully Qualified Domain Name</span></dt><dd class="glossdef"><p>
	  (a.k.a. <span class="quote">&#8220;<span class="quote">FQDN</span>&#8221;</span>).  A full, globally unique,
	  internet name, including DNS domain.  For instance:
	  <span class="quote">&#8220;<span class="quote">www.yahoo.com</span>&#8221;</span>.
	</p><p>
	  A <span class="emphasis"><em>FQDN</em></span> does not always point to a single
	  host.  For instance, common service names such as
	  <span class="quote">&#8220;<span class="quote">www</span>&#8221;</span> often point to many IP addresses, in
	  order to provide some load balancing on the servers.
	  However, the <span class="emphasis"><em>primary</em></span> host name of a
	  given machine should always be unique to that machine; for
	  instance: <span class="quote">&#8220;<span class="quote">p16.www.scd.yahoo.com</span>&#8221;</span>.
	</p><p>
	  A <span class="emphasis"><em>FQDN</em></span> always contains a period (".").
	  The part before the first period is the
	  <span class="emphasis"><em>unqualified name</em></span>, and is not globally
	  unique.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">J</h3><dl><dt><a name="joejob"></a><span class="glossterm">Joe Job</span></dt><dd class="glossdef"><p>
	  A spam designed to look like it came from someone else's
	  valid address, often in a malicous attempt at generating
	  complaints from third parties and/or cause other damage to
	  the owner of that address.
	</p><p>
	  See also:
	  <a class="ulink" href="http://www.everything2.com/index.pl?node=Joe%20Job" target="_top">http://www.everything2.com/index.pl?node=Joe%20Job</a>
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">M</h3><dl><dt><a name="mda"></a><span class="glossterm">Mail Delivery Agent</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: MDA</em></span>) Software that runs on the
	  machine where a users' mailbox is located, to deliver mail
	  into that mailbox.  Often, that delivery is performed
	  directly by the MTA <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a>, which then
	  serves a secondary role as an MDA.  Examples of separate
	  Mail Delivery Agents include: Deliver, Procmail, Cyrmaster
	  and/or Cyrdeliver (from the Cyrus IMAP suite).
	</p></dd><dt><a name="loop"></a><span class="glossterm">Mail Loop</span></dt><dd class="glossdef"><p>
	  A situation where one automated message triggers another,
	  which directly or indirectly triggers the first message
	  over again, and so on.
	</p><p>
	  Imagine a mailing list where one of the subscribers is the
	  address of the list itself.  This situation is often dealt
	  with by the list server adding an <span class="quote">&#8220;<span class="quote">X-Loop:</span>&#8221;</span>
	  line in the message header, and not processing mails that
	  already have one.
	</p><p>
	  Another equivalent term is <span class="emphasis"><em>Ringing</em></span>.
	</p></dd><dt><a name="mta"></a><span class="glossterm">Mail Transport Agent</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: MTA</em></span>) Software that runs on a
	  mail server, such as the mail exchanger(s) of a internet
	  domain, to send mail to and receive mail from other hosts.
	  Popular MTAs include: Sendmail, Postfix, Exim, Smail.
	</p></dd><dt><a name="mua"></a><span class="glossterm">Mail User Agent</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: MUA</em></span>; a.k.a. <span class="emphasis"><em>Mail
	  Reader</em></span>) User software to access, download, read,
	  and send mail.  Examples include Microsoft Outlook/Outlook
	  Express, Apple Mail.app, Mozilla Thunderbird, Ximian
	  Evolution.
	</p></dd><dt><a name="mx"></a><span class="glossterm">Mail Exchanger</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: MX</em></span>) A machine dedicated to
	  (sending and/or) receiving mail for an internet domain.
	</p><p>
	  The DNS zone information for a internet domain normally
	  contains a list of <a class="xref" href="#fqdn" title="Fully Qualified Domain Name">Fully Qualified Domain Name</a>s that act as
	  incoming mail exchangers for that domain.  Each such listing
	  is called an <span class="quote">&#8220;<span class="quote">MX record</span>&#8221;</span>, and it also contains
	  a number indicating its <span class="quote">&#8220;<span class="quote">priority</span>&#8221;</span> among
	  several <span class="quote">&#8220;<span class="quote">MX records</span>&#8221;</span>.  The listing with the
	  lowest number has the first priority, and is considered the
	  <span class="quote">&#8220;<span class="quote">primary mail exchanger</span>&#8221;</span> for that domain.
	</p></dd><dt><a name="micropay"></a><span class="glossterm">Micropayment Schemes</span></dt><dd class="glossdef"><p>
	  (a.k.a. <span class="emphasis"><em>sender pay</em></span> schemes).  The
	  sender of a message expends some machine resources to create
	  a virtual <span class="emphasis"><em>postage stamp</em></span> for each
	  recipient of a message - usually by solving a mathematical
	  challenge that requires a large number of memory read/write
	  operations, but is relatively CPU speed insensitive.  This
	  stamp is then added to the headers of the message, and the
	  recipient would validate the stamp through a much simpler
	  decoding operation.
	</p><p>
	  The idea is that because the message requires a postage
	  stamp for every recipient address, spamming hundreds or
	  thousands of users at once would be prohibitively
	  "expensive".
	</p><p>
	  Two such systems are:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      <a class="ulink" href="http://www.camram.org/" target="_top">Camram</a>
	    </p></li><li class="listitem"><p>
	      <a class="ulink" href="http://research.microsoft.com/research/sv/PennyBlack/" target="_top">Microsoft's
	      Penny Black Project</a>
	    </p></li></ul></div></dd></dl></div><div class="glossdiv"><h3 class="title">O</h3><dl><dt><a name="openproxy"></a><span class="glossterm">Open Proxy</span></dt><dd class="glossdef"><p>
	  A <a class="xref" href="#proxy" title="proxy">proxy</a> which openly accepts TCP/IP
	  connections from anywhere, and forwards them anywhere.
	</p><p>
	  These are typically exploited by spammers and virii, who
	  use them to conceal their own IP address, and/or to more
	  effectively distribute transmission loads across several
	  hosts and networks.
	</p><p>
	  See also: <a class="xref" href="#zombie" title="Zombie Host">Zombie Host</a>
	</p></dd><dt><a name="openrelay"></a><span class="glossterm">Open Relay</span></dt><dd class="glossdef"><p>
	  A <a class="xref" href="#relay" title="Relay">Relay</a> which openly accepts mail from
	  anywhere, and forwards them to anywhere.
	</p><p>
	  In the 1980s, virtually every public SMTP server was an
	  <a class="xref" href="#openrelay" title="Open Relay">Open Relay</a>.  Messages would often travel
	  between multiple third-party machines before it reached the
	  intended recipient.  Now, legitimate mail are almost
	  exclusively sent directly from an outgoing <a class="xref" href="#mta" title="Mail Transport Agent">Mail Transport Agent</a> on the sender's end to the incoming <a class="xref" href="#mx" title="Mail Exchanger">Mail Exchanger</a>(s) for the recipient's domain.
	</p><p>
	  Conversely, <a class="xref" href="#openrelay" title="Open Relay">Open Relay</a> servers that still
	  exist on the internet are almost exclusively exploited by
	  spammers to hide their own identity, and to perform some
	  load balancing on the task of sending out millions of
	  messages, presumably before DNS blocklists have a chance to
	  get all of these machines listed.
	</p><p>
	  See also the discussion on <a class="xref" href="#relayprevent" title="3.3.1. Open Relay Prevention">Open Relay Prevention</a>.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">P</h3><dl><dt><a name="proxy"></a><span class="glossterm">proxy</span></dt><dd class="glossdef"><p>
	  A machine that acts on behalf of someone else.  It may
	  forward e.g. HTTP requests or TCP/IP connections, usually to
	  or from the internet.  For instance, companies - or
	  sometimes entire countries - often use <span class="quote">&#8220;<span class="quote">Web Proxy
	  Servers</span>&#8221;</span> to filter outgoing HTTP requests from their
	  internal network.  This may or may not be transparent to the
	  end user.
	</p><p>
	  See also: <a class="xref" href="#openproxy" title="Open Proxy">Open Proxy</a>, <a class="xref" href="#relay" title="Relay">Relay</a>.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">R</h3><dl><dt><a name="ratware"></a><span class="glossterm">Ratware</span></dt><dd class="glossdef"><p>
	  Mass-mailing virii and e-mail software used by spammers,
	  specifically designed to deliver large amounts of mail in a
	  very short time.
	</p><p>
	  Most ratware implementations incorporate only as much SMTP
	  client code as strictly neccessary to deliver mail in the
	  best-case scenario.  They provide false or inaccurate
	  information in the SMTP dialogue with the receiving host.
	  They do not wait for responses from the receiver before
	  issuing commands, and disconnect if no response has been
	  received in a few seconds.  They do not follow normal retry
	  mechanisms in case of temporary failures.
	</p></dd><dt><a name="relay"></a><span class="glossterm">Relay</span></dt><dd class="glossdef"><p>
	  A machine that forwards e-mail, usually to or from the
	  internet.  One example of a relay is the
	  <span class="quote">&#8220;<span class="quote">smarthost</span>&#8221;</span> that an ISP provides to its
	  customers for sending outgoing mail.
	</p><p>
	  See also: <a class="xref" href="#openrelay" title="Open Relay">Open Relay</a>, <a class="xref" href="#proxy" title="proxy">proxy</a>
	</p></dd><dt><a name="rfc"></a><span class="glossterm">Request for Comments</span></dt><dd class="glossdef"><p>
	  (<span class="emphasis"><em>abbrev: RFC</em></span>) From

	  <a class="ulink" href="http://www.rfc-editor.org/" target="_top">http://www.rfc-editor.org/</a>:
	  <span class="quote">&#8220;<span class="quote">
	    The Request for Comments (RFC) document series is a set of
	    technical and organizational notes about the internet
	    [...].  Memos in the RFC series discuss many aspects of
	    computer networking, incluing protocols, procedures,
	    programs, and concepts, as well as meeting notes,
	    opinions, and sometimes humor.
	  </span>&#8221;</span>
	</p><p>
	  These documents make up the <span class="quote">&#8220;<span class="quote">rules</span>&#8221;</span> internet
	  conduct, including descriptions of protocols and data
	  formats.  Of particular interest for mail deliveries are:
	  
	  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
		<a class="ulink" href="http://www.ietf.org/rfc/rfc2821" target="_top">RFC
		  2821</a>, "Simple Mail transfer Protocol", and
	      </p></li><li class="listitem"><p>
		<a class="ulink" href="http://www.ietf.org/rfc/rfc2821" target="_top">RFC
		  2822</a>, "Internet Message Format".
	      </p></li></ul></div><p>
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">S</h3><dl><dt><a name="spamtrap"></a><span class="glossterm">Spam Trap</span></dt><dd class="glossdef"><p>
	  An e-mail address that is <span class="emphasis"><em>seeded</em></span> to
	  address-harvesting robots via public locations, then used to
	  feed collaborative tools such as <a class="xref" href="#dnsbl" title="2.1. DNS Blacklists">DNS Blacklists</a> and
	  <a class="xref" href="#jmsr" title="6.2. Junk Mail Signature Repositories">Junk Mail Signature Repository</a>.
	</p><p>
	  Mails sent to these addresses are normally spam or malware.
	  However, some of it will be <span class="emphasis"><em>collateral</em></span>,
	  spam - i.e. <a class="xref" href="#dsn" title="Delivery Status Notification">Delivery Status Notification</a> to faked sender addresses.
	  Thus, unless the spam trap has safeguards in place to
	  disregard such messages, the resulting tool may not be
	  completely reliable.
	</p></dd></dl></div><div class="glossdiv"><h3 class="title">Z</h3><dl><dt><a name="zombie"></a><span class="glossterm">Zombie Host</span></dt><dd class="glossdef"><p>
	  A machine with an internet connection that is infected by a
	  mass-mailing virus or worm.  Such machines invariably run a
	  flavor of the Microsoft® Windows® operating system,
	  and are almost always in <span class="quote">&#8220;<span class="quote">residential</span>&#8221;</span> IP
	  address blocks.  Their owners either do not know or do not
	  care that the machines are infected, and often, their ISP
	  will not take any actions to shut them down.
	</p><p>
	  Fortunately, there are various DNS blocklists, such as
	  <span class="quote">&#8220;<span class="quote">dul.dnsbl.sorbs.net</span>&#8221;</span>, that incorporate such
	  "residential" address blocks.  You should be able to use
	  these blocklists to reject incoming mail.  Legitimate mail
	  from residential users should normally go through their
	  ISP's <span class="quote">&#8220;<span class="quote">smarthost</span>&#8221;</span>.
	</p></dd></dl></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="gpl"></a>Appendix B. GNU General Public License</h1></div><div><p class="releaseinfo">      Version 2, June 1991</p></div><div><p class="copyright">Copyright © 1989, 1991 Free Software Foundation, Inc.</p></div><div><div class="legalnotice"><a name="idm2383"></a><p>	
	</p><div class="address"><p>Free Software Foundation, Inc. <br>
	  <span class="street">59 Temple Place, Suite 330</span>, <br>
	  <span class="city">Boston</span>, <br>
	  <span class="state">MA</span> <br>
	  <span class="postcode">02111-1307</span><br>
	  <span class="country">USA</span><br>
	</p></div><p>.
      </p><p>	Everyone is permitted to copy and distribute verbatim copies of this license document, but changing it is not allowed.
      </p></div></div><div><p class="pubdate">Version 2, June 1991</p></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="#gpl-1">1. Preamble</a></span></dt><dt><span class="sect1"><a href="#gpl-2">2. TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION</a></span></dt><dd><dl><dt><span class="sect2"><a href="#gpl-2-0">2.1. Section 0</a></span></dt><dt><span class="sect2"><a href="#gpl-2-1">2.2. Section 1</a></span></dt><dt><span class="sect2"><a href="#gpl-2-2">2.3. Section 2</a></span></dt><dt><span class="sect2"><a href="#gpl-2-3">2.4. Section 3
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-4">2.5. Section 4
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-5">2.6. Section 5
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-6">2.7. Section 6
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-7">2.8. Section 7
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-8">2.9. Section 8
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-9">2.10. Section 9
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-10">2.11. Section 10
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-11">2.12. NO WARRANTY Section 11
      </a></span></dt><dt><span class="sect2"><a href="#gpl-2-12">2.13. Section 12
      </a></span></dt></dl></dd><dt><span class="sect1"><a href="#gpl-3">3. How to Apply These Terms to Your New Programs
    </a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gpl-1"></a>1. Preamble</h2></div></div></div><p>      The licenses for most software are designed to take away your 
      freedom to share and change it. By contrast, the GNU General Public License is 
      intended to guarantee your freedom to share and change 
      free software - to make sure the software is free for all its users. 
      This General Public License applies to most of the Free Software 
      Foundation's software and to any other program whose authors commit 
      to using it. (Some other Free Software Foundation software is covered 
      by the GNU Library General Public License instead.) You can apply it 
      to your programs, too.
    </p><p>      When we speak of free software, we are referring to freedom, not price. 
      Our General Public Licenses are designed to make sure that you have the 
      freedom to distribute copies of free software (and charge for this 
      service if you wish), that you receive source code or can get it if you 
      want it, that you can change the software or use pieces of it in new free 
      programs; and that you know you can do these things.
    </p><p>      To protect your rights, we need to make restrictions that forbid anyone 
      to deny you these rights or to ask you to surrender the rights. These 
      restrictions translate to certain responsibilities for you if you distribute 
      copies of the software, or if you modify it.
    </p><p>      For example, if you distribute copies of such a program, whether gratis or 
      for a fee, you must give the recipients all the rights that you have. You 
      must make sure that they, too, receive or can get the source code. And you 
      must show them these terms so they know their rights.
    </p><p>      We protect your rights with two steps:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>	    copyright the software, and
	  </p></li><li class="listitem"><p>	    offer you this license which gives you legal permission to copy, 
	    distribute and/or modify the software.
	  </p></li></ol></div><p>
    </p><p>      Also, for each author's protection and ours, we want to make certain that 
      everyone understands that there is no warranty for this free software. If 
      the software is modified by someone else and passed on, we want its 
      recipients to know that what they have is not the original, so that any 
      problems introduced by others will not reflect on the original authors' 
      reputations.
    </p><p>      Finally, any free program is threatened constantly by software patents. 
      We wish to avoid the danger that redistributors of a free program will 
      individually obtain patent licenses, in effect making the program 
      proprietary. To prevent this, we have made it clear that any patent must be 
      licensed for everyone's free use or not licensed at all.
    </p><p>      The precise terms and conditions for copying, distribution and modification 
      follow.
    </p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gpl-2"></a>2. TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION</h2></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-0"></a>2.1. Section 0</h3></div></div></div><p>	This License applies to any program or other work which contains a notice 
	placed by the copyright holder saying it may be distributed under the terms 
	of this General Public License. The "Program", below, refers to any such 
	program or work, and a 
	<span class="quote">&#8220;<span class="quote">work based on the Program
	</span>&#8221;</span> means either 
	the Program or any derivative work under copyright law: that is to say, a 
	work containing the Program or a portion of it, either verbatim or with 
	modifications and/or translated into another language. (Hereinafter, translation 
	is included without limitation in the term 
	<span class="quote">&#8220;<span class="quote">modification
	</span>&#8221;</span>.) Each licensee is addressed as <span class="quote">&#8220;<span class="quote">you</span>&#8221;</span>.
      </p><p>	Activities other than copying, distribution and modification are not covered by 
	this License; they are outside its scope. The act of running the Program is not 
	restricted, and the output from the Program is covered only if its contents 
	constitute a work based on the Program (independent of having been made by running 
	the Program). Whether that is true depends on what the Program does.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-1"></a>2.2. Section 1</h3></div></div></div><p>	You may copy and distribute verbatim copies of the Program's source code as you 
	receive it, in any medium, provided that you conspicuously and appropriately 
	publish on each copy an appropriate copyright notice and disclaimer of warranty; 
	keep intact all the notices that refer to this License and to the absence of any 
	warranty; and give any other recipients of the Program a copy of this License 
	along with the Program.
      </p><p>	You may charge a fee for the physical act of transferring a copy, and you may at 
	your option offer warranty protection in exchange for a fee.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-2"></a>2.3. Section 2</h3></div></div></div><p>	You may modify your copy or copies of the Program or any portion of it, thus 
	forming a work based on the Program, and copy and distribute such modifications 
	or work under the terms of 
	<a class="link" href="#gpl-2-1" title="2.2. Section 1">Section 1
	</a> above, provided 
	that you also meet all of these conditions:
	</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>	      You must cause the modified files to carry prominent notices stating that 
	      you changed the files and the date of any change.
	    </p></li><li class="listitem"><p>	      You must cause any work that you distribute or publish, that in whole or 
	      in part contains or is derived from the Program or any part thereof, to be 
	      licensed as a whole at no charge to all third parties under the terms of 
	      this License.
	    </p></li><li class="listitem"><p>	      If the modified program normally reads commands interactively when run, you 
	      must cause it, when started running for such interactive use in the most 
	      ordinary way, to print or display an announcement including an appropriate 
	      copyright notice and a notice that there is no warranty (or else, saying 
	      that you provide a warranty) and that users may redistribute the program 
	      under these conditions, and telling the user how to view a copy of this 
	      License. 
	      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Exception:
		</h3><p>		  If the Program itself is interactive but does not normally print such an 
		  announcement, your work based on the Program is not required to print an 
		  announcement.) 
		</p></div><p>
	    </p></li></ol></div><p>
      </p><p>	These requirements apply to the modified work as a whole. If identifiable sections 
	of that work are not derived from the Program, and can be reasonably considered 
	independent and separate works in themselves, then this License, and its terms, 
	do not apply to those sections when you distribute them as separate works. But when 
	you distribute the same sections as part of a whole which is a work based on the 
	Program, the distribution of the whole must be on the terms of this License, whose 
	permissions for other licensees extend to the entire whole, and thus to each and 
	every part regardless of who wrote it.
      </p><p>	Thus, it is not the intent of this section to claim rights or contest your rights 
	to work written entirely by you; rather, the intent is to exercise the right to control 
	the distribution of derivative or collective works based on the Program.
      </p><p>	In addition, mere aggregation of another work not based on the Program with the Program 
	(or with a work based on the Program) on a volume of a storage or distribution medium 
	does not bring the other work under the scope of this License.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-3"></a>2.4. Section 3
      </h3></div></div></div><p>	You may copy and distribute the Program (or a work based on it, under 
	<a class="link" href="#gpl-2-2" title="2.3. Section 2">Section 2
	</a> in object code or executable form under the terms of 
	<a class="link" href="#gpl-2-1" title="2.2. Section 1">Sections 1
	</a> and 
	<a class="link" href="#gpl-2-2" title="2.3. Section 2">2
	</a> above provided that you also do one of the following:
	</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>	Accompany it with the complete corresponding machine-readable source code, which 
	      must be distributed under the terms of Sections 1 and 2 above on a medium 
	      customarily used for software interchange; or,
	    </p></li><li class="listitem"><p>	      Accompany it with a written offer, valid for at least three years, to give any 
	      third party, for a charge no more than your cost of physically performing source 
	      distribution, a complete machine-readable copy of the corresponding source code, 
	      to be distributed under the terms of Sections 1 and 2 above on a medium customarily 
	      used for software interchange; or,
	    </p></li><li class="listitem"><p>	      Accompany it with the information you received as to the offer to distribute 
	      corresponding source code. (This alternative is allowed only for noncommercial 
	      distribution and only if you received the program in object code or executable form 
	      with such an offer, in accord with Subsection b above.)
	    </p></li></ol></div><p>
      </p><p>	The source code for a work means the preferred form of the work for making modifications 
	to it. For an executable work, complete source code means all the source code for all modules 
	it contains, plus any associated interface definition files, plus the scripts used to control 
	compilation and installation of the executable. However, as a special exception, the source 
	code distributed need not include anything that is normally distributed (in either source or 
	binary form) with the major components (compiler, kernel, and so on) of the operating system 
	on which the executable runs, unless that component itself accompanies the executable.
      </p><p>	If distribution of executable or object code is made by offering access to copy from a 
	designated place, then offering equivalent access to copy the source code from the same place 
	counts as distribution of the source code, even though third parties are not compelled to 
	copy the source along with the object code.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-4"></a>2.5. Section 4
      </h3></div></div></div><p>	You may not copy, modify, sublicense, or distribute the Program except as expressly provided 
	under this License. Any attempt otherwise to copy, modify, sublicense or distribute the 
	Program is void, and will automatically terminate your rights under this License. However, 
	parties who have received copies, or rights, from you under this License will not have their 
	licenses terminated so long as such parties remain in full compliance.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-5"></a>2.6. Section 5
      </h3></div></div></div><p>	You are not required to accept this License, since you have not signed it. However, nothing 
	else grants you permission to modify or distribute the Program or its derivative works. 
	These actions are prohibited by law if you do not accept this License. Therefore, by modifying 
	or distributing the Program (or any work based on the Program), you indicate your acceptance 
	of this License to do so, and all its terms and conditions for copying, distributing or 
	modifying the Program or works based on it.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-6"></a>2.7. Section 6
      </h3></div></div></div><p>	Each time you redistribute the Program (or any work based on the Program), the recipient 
	automatically receives a license from the original licensor to copy, distribute or modify 
	the Program subject to these terms and conditions. You may not impose any further restrictions 
	on the recipients' exercise of the rights granted herein. You are not responsible for enforcing 
	compliance by third parties to this License.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-7"></a>2.8. Section 7
      </h3></div></div></div><p>	If, as a consequence of a court judgment or allegation of patent infringement or for any other 
	reason (not limited to patent issues), conditions are imposed on you (whether by court order, 
	agreement or otherwise) that contradict the conditions of this License, they do not excuse you 
	from the conditions of this License. If you cannot distribute so as to satisfy simultaneously 
	your obligations under this License and any other pertinent obligations, then as a consequence 
	you may not distribute the Program at all. For example, if a patent license would not permit 
	royalty-free redistribution of the Program by all those who receive copies directly or 
	indirectly through you, then the only way you could satisfy both it and this License would be 
	to refrain entirely from distribution of the Program.
      </p><p>	If any portion of this section is held invalid or unenforceable under any particular circumstance, 
	the balance of the section is intended to apply and the section as a whole is intended to apply 
	in other circumstances.
      </p><p>	It is not the purpose of this section to induce you to infringe any patents or other property 
	right claims or to contest validity of any such claims; this section has the sole purpose of 
	protecting the integrity of the free software distribution system, which is implemented by public 
	license practices. Many people have made generous contributions to the wide range of software 
	distributed through that system in reliance on consistent application of that system; it is up 
	to the author/donor to decide if he or she is willing to distribute software through any other 
	system and a licensee cannot impose that choice.
      </p><p>	This section is intended to make thoroughly clear what is believed to be a consequence of the 
	rest of this License.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-8"></a>2.9. Section 8
      </h3></div></div></div><p>	If the distribution and/or use of the Program is restricted in certain countries either by patents 
	or by copyrighted interfaces, the original copyright holder who places the Program under this License 
	may add an explicit geographical distribution limitation excluding those countries, so that 
	distribution is permitted only in or among countries not thus excluded. In such case, this License 
	incorporates the limitation as if written in the body of this License.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-9"></a>2.10. Section 9
      </h3></div></div></div><p>	The Free Software Foundation may publish revised and/or new versions of the General Public License 
	from time to time. Such new versions will be similar in spirit to the present version, but may differ 
	in detail to address new problems or concerns.
      </p><p>	Each version is given a distinguishing version number. If the Program specifies a version number of 
	this License which applies to it and "any later version", you have the option of following the terms 
	and conditions either of that version or of any later version published by the Free Software 
	Foundation. If the Program does not specify a version number of this License, you may choose any 
	version ever published by the Free Software Foundation.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-10"></a>2.11. Section 10
      </h3></div></div></div><p>	If you wish to incorporate parts of the Program into other free programs whose distribution 
	conditions are different, write to the author to ask for permission. For software which is copyrighted 
	by the Free Software Foundation, write to the Free Software Foundation; we sometimes make exceptions 
	for this. Our decision will be guided by the two goals of preserving the free status of all 
	derivatives of our free software and of promoting the sharing and reuse of software generally.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-11"></a>2.12. NO WARRANTY Section 11
      </h3></div></div></div><p>	BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT 
	PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR 
	OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, 
	INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR 
	PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE 
	PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
      </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="gpl-2-12"></a>2.13. Section 12
      </h3></div></div></div><p>	IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR 
	ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU 
	FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE 
	USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED 
	INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH 
	ANY OTHER PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH 
	DAMAGES.
      </p><p>END OF TERMS AND CONDITIONS
      </p></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gpl-3"></a>3. How to Apply These Terms to Your New Programs
    </h2></div></div></div><p>
      If you develop a new program, and you want it to be of the greatest
      possible use to the public, the best way to achieve this is to make it
      free software which everyone can redistribute and change under these terms.
    </p><p>
      To do so, attach the following notices to the program.  It is safest
      to attach them to the start of each source file to most effectively
      convey the exclusion of warranty; and each file should have at least
      the "copyright" line and a pointer to where the full notice is found.
    </p><p>
      &lt;one line to give the program's name and a brief idea of what it does.&gt;
      Copyright (C) &lt;year&gt;    &lt;name of author&gt;
    </p><p>
      This program is free software; you can redistribute it and/or modify
      it under the terms of the GNU General Public License as published by
      the Free Software Foundation; either version 2 of the License, or
      (at your option) any later version.
    </p><p>
      This program is distributed in the hope that it will be useful,
      but WITHOUT ANY WARRANTY; without even the implied warranty of
      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
      GNU General Public License for more details.
    </p><p>
      You should have received a copy of the GNU General Public License
      along with this program; if not, write to the Free Software
      Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
    </p><p>
      Also add information on how to contact you by electronic and paper mail.
    </p><p>
      If the program is interactive, make it output a short notice like this
      when it starts in an interactive mode:
    </p><p>
      Gnomovision version 69, Copyright (C) year name of author
      Gnomovision comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
      This is free software, and you are welcome to redistribute it
      under certain conditions; type `show c' for details.
    </p><p>
      The hypothetical commands `show w' and `show c' should show the appropriate
      parts of the General Public License.  Of course, the commands you use may
      be called something other than `show w' and `show c'; they could even be
      mouse-clicks or menu items--whatever suits your program.
    </p><p>
      You should also get your employer (if you work as a programmer) or your
      school, if any, to sign a "copyright disclaimer" for the program, if
      necessary.  Here is a sample; alter the names:
    </p><p>
      Yoyodyne, Inc., hereby disclaims all copyright interest in the program
      `Gnomovision' (which makes passes at compilers) written by James Hacker.
    </p><p>
      &lt;signature of Ty Coon&gt;, 1 April 1989
      Ty Coon, President of Vice
    </p><p>
      This General Public License does not permit incorporating your program into
      proprietary programs.  If your program is a subroutine library, you may
      consider it more useful to permit linking proprietary applications with the
      library.  If this is what you want to do, use the GNU Library General
      Public License instead of this License.
    </p></div></div></div></body></html>
