<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>6. Message data checks</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><meta name="keywords" content="anti-spam, anti-virus, bogus virus warnings, collateral spam, delivery status notification, dsn, exim, exim4, exiscan, exiscan-acl, greylisting, junk mail, sa-exim, smtp, spam, spamassassin, teergrubing, transaction delay"><link rel="home" href="index.html" title="Spam Filtering for Mail Exchangers"><link rel="up" href="techniques.html" title="Chapter 2. Techniques"><link rel="prev" href="senderauth.html" title="5. Sender Authorization Schemes"><link rel="next" href="collateral.html" title="7. Blocking Collateral Spam"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Message data checks</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="senderauth.html">Prev</a> </td><th width="60%" align="center">Chapter 2. Techniques</th><td width="20%" align="right"> <a accesskey="n" href="collateral.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="datachecks"></a>6. Message data checks</h2></div></div></div><p>
      Time has come to look at the content of the message itself.
      This is what conventional spam and virus scanners do, as they
      normally operate on the message after it has been accepted.
      However, in our case, we perform these checks
      <span class="emphasis"><em>before</em></span> issuing the final
      <span class="command"><strong>250</strong></span> response, so that we have a chance to
      reject the mail on the spot rather than later generating <a class="xref" href="gloss.html#colspam" title="Collateral Spam">Collateral Spam</a>.
    </p><p>
      If your incoming mail exchangers are very busy (i.e. large site,
      few machines), you may find that performing some or all of these
      checks directly in the mail exchanger is too costly.  In
      particular, running <a class="xref" href="datachecks.html#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a> and <a class="xref" href="datachecks.html#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a> do take up a fair amount of CPU
      bandwidth and time.
    </p><p>
      If so, you will want to set up dedicated machines for these
      scanning operations.  Most server-side anti-spam and anti-virus
      software can be invoked over the network, i.e. from your mail
      exchanger.  More on this in the following chapters, where we
      discuss implementation for the various MTAs.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="headerchecks"></a>6.1. Header checks</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headersmissing"></a>6.1.1. Missing Header Lines</h4></div></div></div><p>
	  <a class="ulink" href="http://www.ietf.org/rfc/rfc2822.txt" target="_top">RFC
	  2822</a> mandates that a message
	  <span class="emphasis"><em>should</em></span> contain at least the following
	  header lines:

</p><pre class="screen">
From: ...
To: ...
Subject: ...
Message-ID: ...
Date: ...
</pre><p>
	</p><p>
	  The absence of any of these lines means that the message
	  is not generated by a mainstream <a class="xref" href="gloss.html#mua" title="Mail User Agent">Mail User Agent</a>, and
	  that it is probably junk
	  <a href="#ftn.idm1045" class="footnote" name="idm1045"><sup class="footnote">[11]</sup></a>.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headersyntax"></a>6.1.2. Header Address Syntax Check</h4></div></div></div><p>
	  Addresses presented in the message header (i.e. the
	  <span class="command"><strong>To:</strong></span>, <span class="command"><strong>Cc:</strong></span>,
	  <span class="command"><strong>From:</strong></span> ... fields) should be syntactically
	  valid.  Enough said.
	</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headeraddress"></a>6.1.3. Simple Header Address Validation</h4></div></div></div><p>
	  For each address in the message header:
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	      If the address is local, is the <span class="emphasis"><em>local
	      part</em></span> (before the @ sign) a valid mailbox?
	    </p></li><li class="listitem"><p>
	      If the address is remote, does the <span class="emphasis"><em>domain
	      part</em></span> (after the @ sign) exist?
	    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="headercallout"></a>6.1.4. Header Address Callout Verification</h4></div></div></div><p>
	  This works similar to <a class="xref" href="smtpchecks.html#callback" title="3.2.4. Sender Callout Verification">Sender Callout Verification</a> and <a class="xref" href="smtpchecks.html#callforward" title="3.3.2.1. Recipient Callout Verification">Recipient Callout Verification</a>.  Each remote header address is
	  verified by calling the primary MX for the corresponding
	  domain to determine if a <a class="xref" href="gloss.html#dsn" title="Delivery Status Notification">Delivery Status Notification</a> would be
	  accepted.
	</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmsr"></a>6.2. Junk Mail Signature Repositories</h3></div></div></div><p>
	One trait of junk mail is that it is sent to a large number of
	addresses.  If 50 other recipients have already flagged a
	particular message as spam, why couldn't you use this fact to
	decide whether or not to accept the message when it is
	delivered to you?  Better yet, why not set up <a class="xref" href="gloss.html#spamtrap" title="Spam Trap">Spam Trap</a>s that feed a public pool of known spam?
      </p><p>
	I am glad you asked.  As it turns out, such pools do exist:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    <a class="ulink" href="http://razor.sf.net/" target="_top">Razor</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://pyzor.sf.net/" target="_top">Pyzor</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://rhyolite.com/anti-spam/dcc/" target="_top">Distributed
	    Checksum Clearinghouse (DCC)</a>
	  </p></li></ul></div><p>
	These tools have progressed beyond simple signature checks
	that only trigger if you receive an identical copy of a
	message that is known to be junk mail.  Rather, they evaluate
	common patterns, to account for slight variations in the
	message header and body.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="garbagechars"></a>6.3. Binary garbage checks</h3></div></div></div><p>
	Messages containing non-printable characters are rare.  When
	they do show up, the message is nearly always a virus, or in 
	some cases spam written in a non-western language, without the
	appropriate MIME encoding.
      </p><p>
	One particular case is where the message contains NUL
	characters (ordinal zero).  Even if you decide that figuring
	out what a <span class="emphasis"><em>non-printable</em></span> character means
	is more complex than beneficial, you might consider checking
	for this character.  That is because some <a class="xref" href="gloss.html#mda" title="Mail Delivery Agent">Mail Delivery Agent</a>s, such as the <a class="ulink" href="http://asg.web.cmu.edu/cyrus/" target="_top">Cyrus Mail Suite</a>,
	will ultimately reject mails that contain it.
	<a href="#ftn.idm1096" class="footnote" name="idm1096"><sup class="footnote">[12]</sup></a>.

	If you use such software, you should definitely consider
	getting rid of NUL characters.
      </p><p>
	On the other hand, the (now obsolete) RFC 822 specification
	did not explicitly prohibit NUL characters in the message.
	For this reason, as an alternative to rejecting mails
	containing it, you may choose to strip these characters from
	the message before delivering it to Cyrus.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mimeerrors"></a>6.4. MIME checks</h3></div></div></div><p>
	Similarly, it might be worthwhile to validate the MIME
	structure of incoming message.  MIME decoding errors or
	inconsistencies do not happen very often; but when they do,
	the message is definitely junk.  Moreover, such errors may
	indicate potential problems in subsequent checks, such as
	<a class="xref" href="datachecks.html#fileext" title="6.5. File Attachment Check">File Attachment Check</a>s, <a class="xref" href="datachecks.html#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>,
	or <a class="xref" href="datachecks.html#spamscanners" title="6.7. Spam Scanners">Spam Scanners</a>.
      </p><p>
	In other words, if the MIME encoding is illegal, reject the
	message.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fileext"></a>6.5. File Attachment Check</h3></div></div></div><p>
	When was the last time someone sent you a Windows screensaver
	(<span class="quote">&#8220;<span class="quote">.scr</span>&#8221;</span> file) or Windows Program Information File
	(<span class="quote">&#8220;<span class="quote">.pif</span>&#8221;</span>) that you actually wanted?
      </p><p>
	Consider blocking messages with <span class="quote">&#8220;<span class="quote">Windows
	executable</span>&#8221;</span> file attachment(s) - i.e. file names that
	end with a period followed by any of a number of three-letter
	combinations such as the above.  This check consumes
	significantly less resources on your server than <a class="xref" href="datachecks.html#virusscanners" title="6.6. Virus Scanners">Virus Scanners</a>, and may also catch new virii for
	which a signature does not yet exist in your anti-virus
	scanner.
      </p><p>
	For a more-or-less comprehensive list of such <span class="quote">&#8220;<span class="quote">file name
	extensions</span>&#8221;</span>, please visit: <a class="ulink" href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;290497" target="_top">http://support.microsoft.com/default.aspx?scid=kb;EN-US;290497</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="virusscanners"></a>6.6. Virus Scanners</h3></div></div></div><p>
	A number of different server-side virus scanners are
	available.  To name a few:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
	    <a class="ulink" href="http://www.vanja.com/tools/sophie/" target="_top">Sophie</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://www.kapersky.com/" target="_top">KAVDaemon</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://clamav.elektrapro.com/" target="_top">ClamAV</a>
	  </p></li><li class="listitem"><p>
	    <a class="ulink" href="http://www.sald.com/" target="_top">DrWeb</a>
	  </p></li></ul></div><p>
	In situations where you are not willing to block all
	potentially dangerous files based on their file names alone
	(consider <span class="quote">&#8220;<span class="quote">.zip</span>&#8221;</span> files), such scanners are
	helpful.  Also, they will be able to catch virii that are
	not transmitted as file attachments, such as the
	<span class="quote">&#8220;<span class="quote">Bagle.R</span>&#8221;</span> virus that arrived in March, 2004.
      </p><p>
	In most cases, the machine performing the virus scan does not
	need to be your mail exchanger.  Most of these anti-virus
	scanners can be invoked on a different host over a network
	connection.
      </p><p>
	Anti-virus software mainly detect virii based on a set of
	signatures for known virii, or <span class="emphasis"><em>virus
	definitions</em></span>.  These need to be updated regularly,
	as new virii are developed.  Also, the software itself
	should at any time be up to date for maximum accuracy.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spamscanners"></a>6.7. Spam Scanners</h3></div></div></div><p>
	Similarly, anti-spam software can be used to classify messages
	based on a large set of heuristics, including their content,
	standards compliance, and various network checks such as <a class="xref" href="dnschecks.html#dnsbl" title="2.1. DNS Blacklists">DNS Blacklists</a> and <a class="xref" href="datachecks.html#jmsr" title="6.2. Junk Mail Signature Repositories">Junk Mail Signature Repository</a>.  In the end,
	such software typically assigns a composite
	<span class="quote">&#8220;<span class="quote">score</span>&#8221;</span> to each message, indicating the
	likelihood that the message is spam, and if the score is above
	a certain threshold, would classify it as such.
      </p><p>
	Two of the most popular server-side heuristic anti-spam
	filters are:

	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a name="spamassassin"></a>
	      <a class="ulink" href="http://www.spamassassin.org/" target="_top">SpamAssassin</a>
	    </p></li><li class="listitem"><p><a name="brightmail"></a>
	      <a class="ulink" href="http://www.brightmail.com/" target="_top">BrightMail</a>
	    </p></li></ul></div><p>
      </p><p>
	These tools undergo a constant evolution as spammers find ways
	to circumvent their various checks.  For instance, consider
	<span class="quote">&#8220;<span class="quote">creative</span>&#8221;</span> spelling, such as <span class="quote">&#8220;<span class="quote">GR0W lO
	1NCH35</span>&#8221;</span>.  So, just like anti-virus software, if you use
	anti-spam software, you should update it frequently for the
	highest level of accuracy.
      </p><p>
	I use SpamAssassin, although to minimize impact on machine
	resources, it is no longer my first line of defense.  Out of
	approximately 500 junk mail delivery attempts to my personal
	address per day, about 50 reach the point where they are being
	checked by SpamAssassin (mainly because they are forwarded
	from one of my other accounts, so the checks described above
	are not effective).  Out of these 50 messages, one message
	ends up in my inbox approximately every 2 or 3 days.
      </p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.idm1045" class="footnote"><p><a href="#idm1045" class="para"><sup class="para">[11] </sup></a>
	      Some specialized MTAs, such as certain mailing list
	      servers, do not automatically generate a
	      <code class="option">Message-ID:</code> header for
	      <span class="quote">&#8220;<span class="quote">bounced</span>&#8221;</span> messages (<a class="xref" href="gloss.html#dsn" title="Delivery Status Notification">Delivery Status Notification</a>s).  These messages are identified by an
	      empty <a class="xref" href="gloss.html#envfrom" title="Envelope Sender">Envelope Sender</a>.
	    </p></div><div id="ftn.idm1096" class="footnote"><p><a href="#idm1096" class="para"><sup class="para">[12] </sup></a>
	    The IMAP protocol does not allow for NUL characters to be
	    transmitted to the mail user agent, so the Cyrus
	    developers decided that the easiest way to deal with mails
	    containing it was to reject them.
	  </p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="senderauth.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="techniques.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="collateral.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5. Sender Authorization Schemes </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7. Blocking Collateral Spam</td></tr></table></div></body></html>
