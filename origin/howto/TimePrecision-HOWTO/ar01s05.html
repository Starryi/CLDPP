<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>5. Accurate Global Time Synchronization</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Managing Accurate Date and Time"><link rel="up" href="index.html" title="Managing Accurate Date and Time"><link rel="prev" href="ar01s04.html" title="4. The Correct Settings for Your Linux Box"><link rel="next" href="ar01s06.html" title="6. Precise Time with the chrony Program"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5. Accurate Global Time Synchronization</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s04.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s06.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ntp"></a>5. Accurate Global Time Synchronization</h2></div></div></div><p>To have accurate time in all your systems is as important as having a solid network security strategy (achieved by much more than simple firewall boxes). It is one of the primary components of a system administration based on good practices, which leads to organization and security. Specially when administering distributed applications, web-services, or even a distributed security monitoring tool, accurate time is a must.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ntp.ntp"></a>5.1. <acronym class="acronym">NTP</acronym>: The Network Time Protocol</h3></div></div></div><p>We won't discuss here the protocol, but how this wonderful invention, added to the pervasivenes of the Internet, can be useful for us. You can find more about it at <a class="ulink" href="http://www.ntp.org/" target="_top">www.ntp.org</a>.</p><p>Once your system is properly setup, <acronym class="acronym">NTP</acronym> will manage to keep its time accurate, making very small adjustments to not impact the running applications.</p><p>People can get exact time using hardware based on atom's electrons frequency. There is also a method based on <acronym class="acronym">GPS</acronym> (Global Positioning System). The first is more accurate, but the second is pretty good also. Atomic clocks require very special and expensive equipment, but their maintainers (usually universities and research labs) connect them to computers, that run an <acronym class="acronym">NTP</acronym> daemon, and some of them are connected to the Internet, that finally let us access them for free. And this is how we'll synchronize our systems.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ntp.arch"></a>5.2. Building a Simple Time Synchronization Architecture</h3></div></div></div><p>You will need:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>A direct or indirect (through a firewall) connection to the Internet.</p></li><li class="listitem"><p>Choose some <acronym class="acronym">NTP</acronym> servers. You can use the public server <a class="ulink" href="http://www.fortytwo.ch/time/" target="_top">pool.ntp.org</a>, or choose some from the <a class="ulink" href="http://www.eecis.udel.edu/~mills/ntp/clock2a.html" target="_top">stratum 2 public time servers</a> on <acronym class="acronym">NTP</acronym> website. If you don't have an Internet access, your <acronym class="acronym">WAN</acronym> administrator (must be a clever guy) can provide you some internal addresses.</p></li><li class="listitem"><p>Have the <acronym class="acronym">NTP</acronym> package installed in all systems you want to synchronize. You can find RPMs in your favorite Linux distribution CD, or <a class="ulink" href="http://rpmfind.net/linux/rpm2html/search.php?query=ntp" target="_top">make a search</a> on <a class="ulink" href="http://rpmfind.net/" target="_top">rpmfind.net</a>.</p></li></ol></div><p>Here is an example of good architecture:</p><div class="figure"><a name="idm412"></a><p class="title"><b>Figure 1. Local Relay Servers for NTP</b></p><div class="figure-contents"><div align="center"><img src="ntp.png" align="middle" alt="Local Relay Servers for NTP"></div></div></div><br class="figure-break"><p>If you have several machines to synchronize, <span class="emphasis"><em>do not</em></span> make them all access the remote <acronym class="acronym">NTP</acronym> servers you chose. Only 2 of your server farm's machines must access remote <acronym class="acronym">NTP</acronym> servers, and the other machines will sync with these 2. We will call them the <span class="emphasis"><em>Relay Servers</em></span>.</p><p>Your Relay Servers can be any machine already available in your network. <acronym class="acronym">NTP</acronym> consumes low memory and CPU. You don't need a dedicated machine for it.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>It is a good idea to create hostname aliases for your local Relay Servers like ntp1.my.com and ntp2.my.com, and use only these names when configuring the client machines. This way you can move the <acronym class="acronym">NTP</acronym> functionality to a new Relay Server (with a different IP and hostname), without having to reconfigure the clients. Ask your <acronym class="acronym">DNS</acronym> administrator to create such aliases.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ntp.configs"></a>5.3. <acronym class="acronym">NTP</acronym> Configurations</h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>For Your Relay Servers</em></span></span></dt><dd><p>Edit <code class="filename">/etc/ntp.conf</code> and add the remote servers you chose:</p><div class="example"><a name="idm436"></a><p class="title"><b>Example 5. Relay machines' <code class="filename">/etc/ntp.conf</code></b></p><div class="example-contents"><pre class="programlisting">
.
.
server  otherntp.server.org	# A stratum 1 server at server.org
server  ntp.research.gov	# A stratum 2 server at research.gov
.
.</pre></div></div><br class="example-break"><p>Again, you can use the public server <a class="ulink" href="http://www.fortytwo.ch/time/" target="_top">pool.ntp.org</a>, or get a list of <a class="ulink" href="http://www.eecis.udel.edu/~mills/ntp/clock2a.html" target="_top">public stratum 2 time servers</a> from <acronym class="acronym">NTP</acronym> website.</p></dd><dt><span class="term"><span class="emphasis"><em>For Your Clients</em></span></span></dt><dd><p>Edit <code class="filename">/etc/ntp.conf</code> and add your Relay Servers with a standard name:</p><div class="example"><a name="idm450"></a><p class="title"><b>Example 6. Client machines' <code class="filename">/etc/ntp.conf</code></b></p><div class="example-contents"><pre class="programlisting">
.
.
server  ntp1.my.com		# My first local relay
server  ntp2.my.com		# My second local relay
.
.</pre></div></div><br class="example-break"></dd></dl></div><p>If your machine has a UTC time difference bigger than some minutes comparing to the <acronym class="acronym">NTP</acronym> servers, <acronym class="acronym">NTP</acronym> will not work. So you must do a first full sync, and I recommend you to do it in a non-production hour. You need to do it only when you are making the initial <acronym class="acronym">NTP</acronym> setup. Never more:</p><div class="example"><a name="idm458"></a><p class="title"><b>Example 7. First sync</b></p><div class="example-contents"><pre class="screen"><code class="prompt">bash# </code><span class="command"><strong>ntpdate otherntp.research.gov</strong></span>	<a name="sync1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
24 Mar 18:16:36 ntpdate[10254]: step time server 200.100.20.10 offset -15.266188 sec
<code class="prompt">bash# </code><span class="command"><strong>ntpdate otherntp.research.gov</strong></span>	<a name="sync2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
24 Mar 18:16:43 ntpdate[10255]: adjust time server 200.100.20.10 offset -0.000267 sec</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#sync1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>First full sync. We were 15 seconds late.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#sync2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Second full sync, just to be sure. Now we are virtually 0 seconds late, which is good.</p></td></tr></table></div></div></div><br class="example-break"><p>The last step is to start or restart the <acronym class="acronym">NTP</acronym> daemons in each machine:</p><pre class="screen">
<code class="prompt">bash# </code><span class="command"><strong>service ntpd restart</strong></span>
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ntp.watch"></a>5.4. Watching Your Box Synchronizing</h3></div></div></div><p>Now you have everything setup. <acronym class="acronym">NTP</acronym> will softly keep your machine time synchronized. You can watch this process using the NTP Query (<span class="command"><strong>ntpq</strong></span> command):</p><div class="example"><a name="idm482"></a><p class="title"><b>Example 8. A time synchronization status</b></p><div class="example-contents"><pre class="screen"><code class="prompt">bash# </code><span class="command"><strong>ntpq -p</strong></span>
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
-jj.cs.umb.edu   gandalf.sigmaso  3 u   95 1024  377   31.681  -18.549   1.572
 milo.mcs.anl.go ntp0.mcs.anl.go  2 u  818 1024  125   41.993  -15.264   1.392
-mailer1.psc.edu ntp1.usno.navy.  2 u  972 1024  377   38.206   19.589  28.028
-dr-zaius.cs.wis ben.cs.wisc.edu  2 u  502 1024  357   55.098    3.979   0.333
+taylor.cs.wisc. ben.cs.wisc.edu  2 u  454 1024  347   54.127    3.379   0.047
-ntp0.cis.strath harris.cc.strat  3 u  507 1024  377  115.274   -5.025   1.642
*clock.via.net   .GPS.            1 u  426 1024  377  107.424   -3.018   2.534
 ntp1.conectiv.c 0.0.0.0         16 u    - 1024    0    0.000    0.000 4000.00
+bonehed.lcs.mit .GPS.            1 u  984 1024  377   25.126    0.131  30.939
-world.std.com   204.34.198.40    2 u  119 1024  377   24.229   -6.884   0.421</pre></div></div><br class="example-break"><div class="variablelist"><p class="title"><b>The meaning of each column</b></p><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>remote</em></span></span></dt><dd><p>Is the name of the remote <acronym class="acronym">NTP</acronym> server. If you use the <code class="option">-n</code> switch, you will see the IP addresses of these servers instead of their hostnames.</p></dd><dt><span class="term"><span class="emphasis"><em>refid</em></span></span></dt><dd><p>Indicates where each server is getting its time right now. It can be a server hostname or something like <acronym class="acronym">.GPS.</acronym>, indicating a Global Positioning System source.</p></dd><dt><span class="term"><span class="emphasis"><em>st</em></span></span></dt><dd><p><span class="emphasis"><em>Stratum</em></span> is a number from 1 to 16, to indicate the remote server precision. 1 is the most accurate, 16 means 'server unreachable'. Your Stratum will be equal to the accurate remote server plus 1. Never connect to a Stratum 1 server, use Stratum 2 servers! Stratum 2 servers are also good for our purposes, and this policy is good for reducing the traffic to the Stratum 1 servers.</p></dd><dt><span class="term"><span class="emphasis"><em>poll</em></span></span></dt><dd><p>The polling interval (in seconds) between time requests. The value will range between the minimum and maximum allowed polling values. Initially the value will be smaller to allow synchronization to occur quickly. After the clocks are 'in sync' the polling value will increase to reduce network traffic and load on popular time servers.</p></dd><dt><span class="term"><span class="emphasis"><em>reach</em></span></span></dt><dd><p>This is an octal representation of an array of 8 bits, representing the last 8 times the local machine tried to reach the server. The bit is set if the remote server was reached.</p></dd><dt><span class="term"><span class="emphasis"><em>delay</em></span></span></dt><dd><p>The amount of time (seconds) needed to receive a response for a "what time is it" request.</p></dd><dt><span class="term"><span class="emphasis"><em>offset</em></span></span></dt><dd><p>The most important value. The difference of time between the local and remote server. In the course of synchronization, the offset time lowers down, indicating that the local machine time is getting more accurate.</p></dd><dt><span class="term"><span class="emphasis"><em>jitter</em></span></span></dt><dd><p>Dispersion, also called Jitter, is a measure of the statistical variance of the offset across several successive request/response pairs. Lower dispersion values are preferred over higher dispersion values. Lower dispersions allow more accurate time synchronization.</p></dd></dl></div><div class="variablelist"><p class="title"><b>The meaning of the signs before server hostname</b></p><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>-</em></span></span></dt><dd><p>Means the local NTP service doesn't like this server very much</p></dd><dt><span class="term"><span class="emphasis"><em>+</em></span></span></dt><dd><p>Means the local NTP service likes this server</p></dd><dt><span class="term"><span class="emphasis"><em>x</em></span></span></dt><dd><p>Marks a bad host</p></dd><dt><span class="term"><span class="emphasis"><em>*</em></span></span></dt><dd><p>Indicates the current favorite</p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ntp.boot"></a>5.5. Configure to Automatically Run <acronym class="acronym">NTP</acronym> at Boot</h3></div></div></div><p>You may want to have <acronym class="acronym">NTP</acronym> running all the time even if you reboot your machine. On each machine, do the following:</p><pre class="screen">
<code class="prompt">bash# </code><span class="command"><strong>chkconfig --level 2345 ntpd on</strong></span>
			</pre><p>This will ensure autostart.</p><p>If your machine is up and running for a long time (months, years) without rebooting, you'll find a big discrepancy between the inaccurate hardware clock and the (now very accurate) system time. Modern Linux distributions copy OS time to the HC everytime the system is shutdown, using a <a class="link" href="ar01s04.html#set.hwclock" title="4.2. Setting the Hardware Clock">mechanism similar to the <span class="command"><strong>setclock</strong></span> command</a>. This way, in the next OS boot, you'll get date and time almost as accurate as it was when you shutdown the machine.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s04.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s06.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">4. The Correct Settings for Your Linux Box </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 6. Precise Time with the <span class="command"><strong>chrony</strong></span> Program</td></tr></table></div></body></html>
